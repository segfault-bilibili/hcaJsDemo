<!DOCTYPE html>
<html>
<head></head>
<body>
    <h1>HCA decoder demo</h1>
    <i>Standalone version - you may right-click & save this page for offline use.</i><br>
    <a href="https://github.com/y2361547758/hca.js">GitHub repo</a>
    <hr>
    <button disabled id="startworkerbtn">start background worker</button><br>
    <button disabled id="shutdownbtn">shutdown background worker</button><br>
    <hr>
    <h3>Choose a HCA file</h3>
    Drag & drop a file here,<br>
    <form id="localfileform">
        Or pick a local file: <input type="file" id="localfile" accept=".hca,application/octet-stream"><br>
        <input type="checkbox" id="hcaonly" checked>
        <label for="hcaonly">pick HCA file only (uncheck if unable to pick)</label><br>
    </form>
    <b><u>Don't forget to</u></b> <button disabled id="loadfilebtn">load picked file</button><br>
    Or download from URL: <input type="text" spellcheck="false" id="urlinput" value="bgm22_battle01_hca.hca"><br>
    <button id="downloadbtn">download</button><br>
    <hr>
    <h3>Set keys for decryption/encryption</h3>
    key1=<input type="text" spellcheck="false" id="key1input" value="0x01395C51"><br>
    key2=<input type="text" spellcheck="false" id="key2input" value="0x00000000"><br>
    <i>Note: output waveform will be nothing but unpleasant meaningless noise if incorrect keys are given!</i><br>
    <hr>
    <h3>Streaming (<a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioWorklet">AudioWorklet API</a>)</h3>
    <input type="checkbox" checked id="awautoplayondrop">
    <label for="awautoplyondrop">Automatically play drag & dropped HCA file</label><br>
    <b><u>Some browsers like Safari (Apple WebKit) may lock AudioContext initially, which blocks auto-play.<br>
        To unlock AudioContext (so that auto-play will no longer be blocked),<br>
        please click anywhere on this page after drag & drop.</u></b><br>
    Load a HCA file for playing, which has been fully loaded/downloaded above:<br>
    <button id="awloadwholehcabtn">Load</button><br>
    Load directly from the URL above, without fully downloading the whole file:<br>
    <button id="awloadfromurlbtn">Load</button><br>
    Progress control:<br>
    <button id="awresumebtn">Play/Resume</button><br>
    <button id="awpausebtn">Pause</button><br>
    <button id="awstopbtn">Stop</button><br>
    <hr>
    <h3>Decode the whole file</h3>
    Note:<br>
    (1) Setting decoding mode to <b>zero means 32-bit float mode</b>, or <b>8/16/24/32-bit integer mode</b> otherwise.<br>
    (2) Loop count is <b>ignored if HCA header doesn't have loop section</b><br>
    (3) Loop count doesn't count the existing part which is originally supposed to be looped.<br>
    &nbsp;&nbsp;&nbsp;&nbsp;<b>In other words, actual loop count will be: the number set here plus one.</b><br>
    (4) When <b>decoding the whole file</b>, setting loop count to <b>zero</b> means: <b>disabling loop</b>.</b><br>
    <fieldset>
        <legend>HCA info</legend>
        <button disabled id="infobtn">get HCA info</button><br>
        <style>
            table {
                border-top: 1px solid #000;
                border-left: 1px solid #000;
                border-spacing: 0;
            }
            tbody td {
                border-bottom: 1px solid #000;
                border-right: 1px solid #000;
                min-width: 8ch;
            }
            thead tr th, tfoot tr th {
                background-color: #fff;
                color: #000;
                border-bottom: 1px solid #000;
                border-right: 1px solid #000;
            }
        </style>
        <table id="hcaInfoTable">
            <thead>
                <tr>
                    <th colspan="3">HCA info</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>(Not loaded)</td>
                </tr>
            </tbody>
        </table>
    </fieldset>
    <fieldset>
        <legend>Checksum</legend>
        <button disabled id="fixcsumbtn">fix checksum</button><br>
    </fieldset>
    <fieldset>
        <legend>Cipher</legend>
        <button disabled id="encryptbtn">encrypt</button><br>
        <button disabled id="decryptbtn">decrypt</button><br>
    </fieldset>
    <fieldset>
        <legend>Decoding parameters</legend>
        Decoding mode: <input type="number" step="8" min="0" max="32" placeholder="0-99" id="decodingmodeinput" value="16"><br>
        Loop count: <input type="number" step="1" min="0" max="99" placeholder="0-99" id="loopcountinput" value="0"><br>
        Volume: <input type="range" step="1" min="0" max="100" placeholder="0-100" id="volumeslider" value="100">
        <input type="number" step="1" min="0" max="100" placeholder="0-100" id="volumeinput" value="100"><br>
    </fieldset>
    <fieldset>
        <legend>Decode to HTML5 Audio</legend>
        <button disabled id="decodetoh5btn">decode</button><br>
        <audio id="audioElement" controls></audio><br>
    </fieldset>
    <fieldset>
        <legend>Decode to WebAudio AudioBufferSourceNode</legend>
        <button disabled id="decodetowabtn">decode</button><br>
        <button disabled id="webaudioplaybtn">Play</button><br>
        <button disabled id="webaudiopausebtn">Pause</button><br>
        <button disabled id="webaudiostopbtn">Stop</button><br>
    </fieldset>
    <!-- <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.8.3/dist/ffmpeg.min.js"></script> -->
    <script type="module">
        const hcaJsUrl = new URL("data:text/javascript;base64,dmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7CiAgICBmdW5jdGlvbiBhZG9wdCh2YWx1ZSkgeyByZXR1cm4gdmFsdWUgaW5zdGFuY2VvZiBQID8gdmFsdWUgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHZhbHVlKTsgfSk7IH0KICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH0KICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvclsidGhyb3ciXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9CiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBhZG9wdChyZXN1bHQudmFsdWUpLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH0KICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7CiAgICB9KTsKfTsKdmFyIF9hLCBfYjsKZXhwb3J0IGNsYXNzIEhDQUluZm8gewogICAgc3RhdGljIGdldFNpZ24ocmF3LCBvZmZzZXQgPSAwLCBjaGFuZ2VNYXNrLCBlbmNyeXB0KSB7CiAgICAgICAgbGV0IG1hZ2ljID0gcmF3LmdldFVpbnQzMihvZmZzZXQsIHRydWUpOwogICAgICAgIGxldCBzdHJMZW4gPSA0OwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgaSsrKSB7CiAgICAgICAgICAgIGlmIChyYXcuZ2V0VWludDgob2Zmc2V0ICsgaSkgPT0gMCkgewogICAgICAgICAgICAgICAgc3RyTGVuID0gaTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChzdHJMZW4gPiAwKSB7CiAgICAgICAgICAgIGxldCBtYXNrID0gMHg4MDgwODA4MCA+Pj4gOCAqICg0IC0gc3RyTGVuKTsKICAgICAgICAgICAgbWFnaWMgJj0gMHg3ZjdmN2Y3ZjsKICAgICAgICAgICAgaWYgKGNoYW5nZU1hc2spCiAgICAgICAgICAgICAgICByYXcuc2V0VWludDMyKG9mZnNldCwgZW5jcnlwdCA/IG1hZ2ljIHwgbWFzayA6IG1hZ2ljLCB0cnVlKTsKICAgICAgICB9CiAgICAgICAgbGV0IGhleCA9IFttYWdpYyAmIDB4ZmYsIG1hZ2ljID4+IDggJiAweGZmLCBtYWdpYyA+PiAxNiAmIDB4ZmYsIG1hZ2ljID4+IDI0ICYgMHhmZl07CiAgICAgICAgaGV4ID0gaGV4LnNsaWNlKDAsIHN0ckxlbik7CiAgICAgICAgcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUuYXBwbHkoU3RyaW5nLCBoZXgpOwogICAgfQogICAgY2xvbmUoKSB7CiAgICAgICAgcmV0dXJuIG5ldyBIQ0FJbmZvKHRoaXMucmF3SGVhZGVyKTsKICAgIH0KICAgIHBhcnNlSGVhZGVyKGhjYSwgY2hhbmdlTWFzaywgZW5jcnlwdCwgbW9kTGlzdCkgewogICAgICAgIGxldCBwID0gbmV3IERhdGFWaWV3KGhjYS5idWZmZXIsIGhjYS5ieXRlT2Zmc2V0LCA4KTsKICAgICAgICBsZXQgaGVhZCA9IEhDQUluZm8uZ2V0U2lnbihwLCAwLCBmYWxzZSwgZW5jcnlwdCk7IC8vIGRvIG5vdCBvdmVyd3JpdGUgZm9yIG5vdywgdW50aWwgY2hlY2tzdW0gdmVyaWZpZWQKICAgICAgICBpZiAoaGVhZCAhPT0gIkhDQSIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJOb3QgYSBIQ0EgZmlsZSIpOwogICAgICAgIH0KICAgICAgICBjb25zdCB2ZXJzaW9uID0gewogICAgICAgICAgICBtYWluOiBwLmdldFVpbnQ4KDQpLAogICAgICAgICAgICBzdWI6IHAuZ2V0VWludDgoNSkKICAgICAgICB9OwogICAgICAgIHRoaXMudmVyc2lvbiA9IHZlcnNpb24ubWFpbiArICcuJyArIHZlcnNpb24uc3ViOwogICAgICAgIHRoaXMuZGF0YU9mZnNldCA9IHAuZ2V0VWludDE2KDYpOwogICAgICAgIC8vIHZlcmlmeSBjaGVja3N1bQogICAgICAgIEhDQUNyYzE2LnZlcmlmeShoY2EsIHRoaXMuZGF0YU9mZnNldCAtIDIpOwogICAgICAgIGxldCBoYXNNb2REb25lID0gZmFsc2U7CiAgICAgICAgLy8gY2hlY2tzdW0gdmVyaWZpZWQsIG5vdyB3ZSBjYW4gb3ZlcndyaXRlIGl0CiAgICAgICAgaWYgKGNoYW5nZU1hc2spCiAgICAgICAgICAgIEhDQUluZm8uZ2V0U2lnbihwLCAwLCBjaGFuZ2VNYXNrLCBlbmNyeXB0KTsKICAgICAgICAvLyBwYXJzZSB0aGUgaGVhZGVyCiAgICAgICAgcCA9IG5ldyBEYXRhVmlldyhoY2EuYnVmZmVyLCBoY2EuYnl0ZU9mZnNldCwgdGhpcy5kYXRhT2Zmc2V0KTsKICAgICAgICBsZXQgZnRlbGwgPSA4OwogICAgICAgIHdoaWxlIChmdGVsbCA8IHRoaXMuZGF0YU9mZnNldCAtIDIpIHsKICAgICAgICAgICAgbGV0IGxhc3RGdGVsbCA9IGZ0ZWxsOwogICAgICAgICAgICAvLyBnZXQgdGhlIHNpZwogICAgICAgICAgICBsZXQgc2lnbiA9IEhDQUluZm8uZ2V0U2lnbihwLCBmdGVsbCwgY2hhbmdlTWFzaywgZW5jcnlwdCk7CiAgICAgICAgICAgIC8vIHJlY29yZCBoYXNIZWFkZXIKICAgICAgICAgICAgdGhpcy5oYXNIZWFkZXJbc2lnbl0gPSB0cnVlOwogICAgICAgICAgICAvLyBwYWRkaW5nIHNob3VsZCBiZSB0aGUgbGFzdCBvbmUKICAgICAgICAgICAgaWYgKHNpZ24gPT0gInBhZCIpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGVhZGVyT2Zmc2V0W3NpZ25dID0gW2Z0ZWxsLCB0aGlzLmRhdGFPZmZzZXQgLSAyXTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIHBhcnNlIGRhdGEgYWNjb3JkaW5nbHkKICAgICAgICAgICAgc3dpdGNoIChzaWduKSB7CiAgICAgICAgICAgICAgICBjYXNlICJmbXQiOgogICAgICAgICAgICAgICAgICAgIHRoaXMuZm9ybWF0LmNoYW5uZWxDb3VudCA9IHAuZ2V0VWludDgoZnRlbGwgKyA0KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZvcm1hdC5zYW1wbGluZ1JhdGUgPSBwLmdldFVpbnQzMihmdGVsbCArIDQpICYgMHgwMGZmZmZmZjsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZvcm1hdC5ibG9ja0NvdW50ID0gcC5nZXRVaW50MzIoZnRlbGwgKyA4KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZvcm1hdC5kcm9wcGVkSGVhZGVyID0gcC5nZXRVaW50MTYoZnRlbGwgKyAxMik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5mb3JtYXQuZHJvcHBlZEZvb3RlciA9IHAuZ2V0VWludDE2KGZ0ZWxsICsgMTQpOwogICAgICAgICAgICAgICAgICAgIGZ0ZWxsICs9IDE2OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAiY29tcCI6CiAgICAgICAgICAgICAgICAgICAgdGhpcy5ibG9ja1NpemUgPSBwLmdldFVpbnQxNihmdGVsbCArIDQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMua2JwcyA9IHRoaXMuZm9ybWF0LnNhbXBsaW5nUmF0ZSAqIHRoaXMuYmxvY2tTaXplIC8gMTI4MDAwLjA7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLk1pblJlc29sdXRpb24gPSBwLmdldFVpbnQ4KGZ0ZWxsICsgNik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLk1heFJlc29sdXRpb24gPSBwLmdldFVpbnQ4KGZ0ZWxsICsgNyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLlRyYWNrQ291bnQgPSBwLmdldFVpbnQ4KGZ0ZWxsICsgOCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLkNoYW5uZWxDb25maWcgPSBwLmdldFVpbnQ4KGZ0ZWxsICsgOSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLlRvdGFsQmFuZENvdW50ID0gcC5nZXRVaW50OChmdGVsbCArIDEwKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuQmFzZUJhbmRDb3VudCA9IHAuZ2V0VWludDgoZnRlbGwgKyAxMSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLlN0ZXJlb0JhbmRDb3VudCA9IHAuZ2V0VWludDgoZnRlbGwgKyAxMik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLkJhbmRzUGVySGZyR3JvdXAgPSBwLmdldFVpbnQ4KGZ0ZWxsICsgMTMpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29tcERlYy5SZXNlcnZlZDEgPSBwLmdldFVpbnQ4KGZ0ZWxsICsgMTQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29tcERlYy5SZXNlcnZlZDIgPSBwLmdldFVpbnQ4KGZ0ZWxsICsgMTUpOwogICAgICAgICAgICAgICAgICAgIGZ0ZWxsICs9IDE2OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAiZGVjIjoKICAgICAgICAgICAgICAgICAgICB0aGlzLmJsb2NrU2l6ZSA9IHAuZ2V0VWludDE2KGZ0ZWxsICsgNCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5rYnBzID0gdGhpcy5mb3JtYXQuc2FtcGxpbmdSYXRlICogdGhpcy5ibG9ja1NpemUgLyAxMjgwMDAuMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuTWluUmVzb2x1dGlvbiA9IHAuZ2V0VWludDgoZnRlbGwgKyA2KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuTWF4UmVzb2x1dGlvbiA9IHAuZ2V0VWludDgoZnRlbGwgKyA3KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuVG90YWxCYW5kQ291bnQgPSBwLmdldFVpbnQ4KGZ0ZWxsICsgOCk7CiAgICAgICAgICAgICAgICAgICAgKzE7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLkJhc2VCYW5kQ291bnQgPSBwLmdldFVpbnQ4KGZ0ZWxsICsgOSk7CiAgICAgICAgICAgICAgICAgICAgKzE7CiAgICAgICAgICAgICAgICAgICAgbGV0IGEgPSBwLmdldFVpbnQ4KGZ0ZWxsICsgMTApOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29tcERlYy5UcmFja0NvdW50ID0gSENBVXRpbEZ1bmMuR2V0SGlnaE5pYmJsZShhKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuQ2hhbm5lbENvbmZpZyA9IEhDQVV0aWxGdW5jLkdldExvd05pYmJsZShhKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRlYy5EZWNTdGVyZW9UeXBlID0gcC5nZXRVaW50OChmdGVsbCArIDExKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kZWMuRGVjU3RlcmVvVHlwZSA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY29tcERlYy5CYXNlQmFuZENvdW50ID0gdGhpcy5jb21wRGVjLlRvdGFsQmFuZENvdW50OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLlN0ZXJlb0JhbmRDb3VudCA9IHRoaXMuY29tcERlYy5Ub3RhbEJhbmRDb3VudCAtIHRoaXMuY29tcERlYy5CYXNlQmFuZENvdW50OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBmdGVsbCArPSAxMjsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgInZiciI6CiAgICAgICAgICAgICAgICAgICAgZnRlbGwgKz0gODsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgImF0aCI6CiAgICAgICAgICAgICAgICAgICAgdGhpcy5Vc2VBdGhDdXJ2ZSA9IHAuZ2V0VWludDE2KGZ0ZWxsICsgNCkgPT0gMTsKICAgICAgICAgICAgICAgICAgICBmdGVsbCArPSA2OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAibG9vcCI6CiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb29wLnN0YXJ0ID0gcC5nZXRVaW50MzIoZnRlbGwgKyA0KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmxvb3AuZW5kID0gcC5nZXRVaW50MzIoZnRlbGwgKyA4KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmxvb3AuZHJvcHBlZEhlYWRlciA9IHAuZ2V0VWludDE2KGZ0ZWxsICsgMTIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubG9vcC5kcm9wcGVkRm9vdGVyID0gcC5nZXRVaW50MTYoZnRlbGwgKyAxNCk7CiAgICAgICAgICAgICAgICAgICAgZnRlbGwgKz0gMTY7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJjaXBoIjoKICAgICAgICAgICAgICAgICAgICB0aGlzLmNpcGhlciA9IHAuZ2V0VWludDE2KGZ0ZWxsICsgNCk7CiAgICAgICAgICAgICAgICAgICAgZnRlbGwgKz0gNjsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgInJ2YSI6CiAgICAgICAgICAgICAgICAgICAgdGhpcy5ydmEgPSBwLmdldEZsb2F0MzIoZnRlbGwgKyA0KTsKICAgICAgICAgICAgICAgICAgICBmdGVsbCArPSA4OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAidmJyIjoKICAgICAgICAgICAgICAgICAgICB0aGlzLnZici5NYXhCbG9ja1NpemUgPSBwLmdldFVpbnQxNihmdGVsbCArIDQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudmJyLk5vaXNlTGV2ZWwgPSBwLmdldEludDE2KGZ0ZWxsICsgNik7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJjb21tIjoKICAgICAgICAgICAgICAgICAgICBsZXQgbGVuID0gcC5nZXRVaW50OChmdGVsbCArIDQpOwogICAgICAgICAgICAgICAgICAgIGxldCBqaXNkZWNvZGVyID0gbmV3IFRleHREZWNvZGVyKCdzaGlmdC1qaXMnKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbW1lbnQgPSBqaXNkZWNvZGVyLmRlY29kZShoY2Euc2xpY2UoZnRlbGwgKyA1LCBmdGVsbCArIDUgKyBsZW4pKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6IHRocm93IG5ldyBFcnJvcigidW5rbm93biBoZWFkZXIgc2lnIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gcmVjb3JkIGhlYWRlck9mZnNldAogICAgICAgICAgICB0aGlzLmhlYWRlck9mZnNldFtzaWduXSA9IFtsYXN0RnRlbGwsIGZ0ZWxsXTsKICAgICAgICAgICAgLy8gZG8gbW9kaWZpY2F0aW9uIGlmIG5lZWRlZAogICAgICAgICAgICBsZXQgc2VjdGlvbkRhdGFMZW4gPSBmdGVsbCAtIGxhc3RGdGVsbCAtIDQ7CiAgICAgICAgICAgIGxldCBuZXdEYXRhID0gbW9kTGlzdFtzaWduXTsKICAgICAgICAgICAgaWYgKG5ld0RhdGEgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKG5ld0RhdGEuYnl0ZUxlbmd0aCA+IHNlY3Rpb25EYXRhTGVuKQogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgICAgICAgICAgaGNhLnNldChuZXdEYXRhLCBsYXN0RnRlbGwgKyA0KTsKICAgICAgICAgICAgICAgIGhhc01vZERvbmUgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8qCiAgICAgICAgLy8gKHBvcnRlZCBmcm9tKSBOeWFnYW1vbidzIG9yaWdpbmFsIGNvZGUsIHNob3VsZCBiZSAoYWxtb3N0KSBlcXVpdmFsZW50IHRvIENhbGN1bGF0ZUhmclZhbHVlcwogICAgICAgIHRoaXMuY29tcFBhcmFtWzJdID0gdGhpcy5jb21wUGFyYW1bMl0gfHwgMTsKICAgICAgICBsZXQgX2EgPSB0aGlzLmNvbXBQYXJhbVs0XSAtIHRoaXMuY29tcFBhcmFtWzVdIC0gdGhpcy5jb21wUGFyYW1bNl07CiAgICAgICAgbGV0IF9iID0gdGhpcy5jb21wUGFyYW1bN107CiAgICAgICAgdGhpcy5jb21wRGVjLlJlc2VydmVkMSA9IF9iID4gMCA/IF9hIC8gX2IgKyAoX2EgJSBfYiA/IDEgOiAwKSA6IDA7CiAgICAgICAgLy8gVHJhbnNsYXRpbmcgdGhlIGFib3ZlIGNvZGUgd2l0aCBtZWFuaW5nZnVsIHZhcmlhYmxlIG5hbWVzOgogICAgICAgIHRoaXMuY29tcERlYy5UcmFja0NvdW50ID0gdGhpcy5jb21wRGVjLlRyYWNrQ291bnQgfHwgMTsKICAgICAgICB0aGlzLmNvbXBEZWMuSGZyQmFuZENvdW50ID0gdGhpcy5jb21wRGVjLlRvdGFsQmFuZENvdW50IC0gdGhpcy5jb21wRGVjLkJhc2VCYW5kQ291bnQgLSB0aGlzLmNvbXBEZWMuU3RlcmVvQmFuZENvdW50OwogICAgICAgIHRoaXMuSGZyR3JvdXBDb3VudCA9IHRoaXMuY29tcERlYy5CYW5kc1Blckhmckdyb3VwOwogICAgICAgIHRoaXMuY29tcERlYy5SZXNlcnZlZDEgPSB0aGlzLkhmckdyb3VwQ291bnQgPiAwID8gdGhpcy5jb21wRGVjLkhmckJhbmRDb3VudCAvIHRoaXMuSGZyR3JvdXBDb3VudCArICh0aGlzLmNvbXBEZWMuSGZyQmFuZENvdW50ICUgdGhpcy5IZnJHcm91cENvdW50ID8gMSA6IDApIDogMDsKICAgICAgICAqLwogICAgICAgIC8vIENhbGN1bGF0ZUhmclZhbHVlcywgcG9ydGVkIGZyb20gVkdBdWRpbwogICAgICAgIGlmICh0aGlzLmNvbXBEZWMuQmFuZHNQZXJIZnJHcm91cCA+IDApIHsKICAgICAgICAgICAgdGhpcy5jb21wRGVjLkhmckJhbmRDb3VudCA9IHRoaXMuY29tcERlYy5Ub3RhbEJhbmRDb3VudCAtIHRoaXMuY29tcERlYy5CYXNlQmFuZENvdW50IC0gdGhpcy5jb21wRGVjLlN0ZXJlb0JhbmRDb3VudDsKICAgICAgICAgICAgdGhpcy5IZnJHcm91cENvdW50ID0gSENBVXRpbEZ1bmMuRGl2aWRlQnlSb3VuZFVwKHRoaXMuY29tcERlYy5IZnJCYW5kQ291bnQsIHRoaXMuY29tcERlYy5CYW5kc1Blckhmckdyb3VwKTsKICAgICAgICB9CiAgICAgICAgLy8gY2FsY3VsYXRlIHNhbXBsZSBjb3VudC9vZmZzZXRzCiAgICAgICAgdGhpcy5mdWxsU2FtcGxlQ291bnQgPSB0aGlzLmZvcm1hdC5ibG9ja0NvdW50ICogSENBRnJhbWUuU2FtcGxlc1BlckZyYW1lOwogICAgICAgIHRoaXMuc3RhcnRBdFNhbXBsZSA9IHRoaXMuZm9ybWF0LmRyb3BwZWRIZWFkZXI7CiAgICAgICAgdGhpcy5mdWxsRW5kQXRTYW1wbGUgPSB0aGlzLmZ1bGxTYW1wbGVDb3VudCAtIHRoaXMuZm9ybWF0LmRyb3BwZWRGb290ZXI7CiAgICAgICAgaWYgKHRoaXMuaGFzSGVhZGVyWyJsb29wIl0pIHsKICAgICAgICAgICAgdGhpcy5sb29wU3RhcnRBdFNhbXBsZSA9IHRoaXMubG9vcC5zdGFydCAqIEhDQUZyYW1lLlNhbXBsZXNQZXJGcmFtZSArIHRoaXMubG9vcC5kcm9wcGVkSGVhZGVyOwogICAgICAgICAgICB0aGlzLmxvb3BFbmRBdFNhbXBsZSA9ICh0aGlzLmxvb3AuZW5kICsgMSkgKiBIQ0FGcmFtZS5TYW1wbGVzUGVyRnJhbWUgLSB0aGlzLmxvb3AuZHJvcHBlZEZvb3RlcjsKICAgICAgICAgICAgdGhpcy5sb29wU2FtcGxlQ291bnQgPSB0aGlzLmxvb3BFbmRBdFNhbXBsZSAtIHRoaXMubG9vcFN0YXJ0QXRTYW1wbGU7CiAgICAgICAgICAgIHRoaXMubG9vcFN0YXJ0VGltZSA9ICh0aGlzLmxvb3BTdGFydEF0U2FtcGxlIC0gdGhpcy5zdGFydEF0U2FtcGxlKSAvIHRoaXMuZm9ybWF0LnNhbXBsaW5nUmF0ZTsKICAgICAgICAgICAgdGhpcy5sb29wRHVyYXRpb24gPSB0aGlzLmxvb3BTYW1wbGVDb3VudCAvIHRoaXMuZm9ybWF0LnNhbXBsaW5nUmF0ZTsKICAgICAgICAgICAgdGhpcy5sb29wRW5kVGltZSA9IHRoaXMubG9vcFN0YXJ0VGltZSArIHRoaXMubG9vcER1cmF0aW9uOwogICAgICAgIH0KICAgICAgICB0aGlzLmVuZEF0U2FtcGxlID0gdGhpcy5oYXNIZWFkZXJbImxvb3AiXSA/IHRoaXMubG9vcEVuZEF0U2FtcGxlIDogdGhpcy5mdWxsRW5kQXRTYW1wbGU7CiAgICAgICAgdGhpcy5zYW1wbGVDb3VudCA9IHRoaXMuZW5kQXRTYW1wbGUgLSB0aGlzLnN0YXJ0QXRTYW1wbGU7CiAgICAgICAgdGhpcy5kdXJhdGlvbiA9IHRoaXMuc2FtcGxlQ291bnQgLyB0aGlzLmZvcm1hdC5zYW1wbGluZ1JhdGU7CiAgICAgICAgLy8gY2FsY3VsYXRlIGZpbGUvZGF0YSBzaXplCiAgICAgICAgdGhpcy5kYXRhU2l6ZSA9IHRoaXMuYmxvY2tTaXplICogdGhpcy5mb3JtYXQuYmxvY2tDb3VudDsKICAgICAgICB0aGlzLmZ1bGxTaXplID0gdGhpcy5kYXRhT2Zmc2V0ICsgdGhpcy5kYXRhU2l6ZTsKICAgICAgICBpZiAoY2hhbmdlTWFzayB8fCBoYXNNb2REb25lKSB7CiAgICAgICAgICAgIC8vIGZpeCBjaGVja3N1bSBpZiByZXF1ZXN0ZWQKICAgICAgICAgICAgSENBQ3JjMTYuZml4KGhjYSwgdGhpcy5kYXRhT2Zmc2V0IC0gMik7CiAgICAgICAgfQogICAgICAgIGxldCByYXdIZWFkZXIgPSBoY2Euc2xpY2UoMCwgdGhpcy5kYXRhT2Zmc2V0KTsKICAgICAgICAvLyBjaGVjayB2YWxpZGl0eSBvZiBwYXJzZWQgdmFsdWVzCiAgICAgICAgdGhpcy5jaGVja1ZhbGlkaXR5KCk7CiAgICAgICAgcmV0dXJuIHJhd0hlYWRlcjsKICAgIH0KICAgIGNoZWNrVmFsaWRpdHkoKSB7CiAgICAgICAgY29uc3QgcmVzdWx0cyA9IFsKICAgICAgICAgICAgdGhpcy5ibG9ja1NpemUgPiAwLAogICAgICAgICAgICAwIDwgdGhpcy5mb3JtYXQuYmxvY2tDb3VudCwKICAgICAgICAgICAgMCA8PSB0aGlzLnN0YXJ0QXRTYW1wbGUsCiAgICAgICAgICAgIHRoaXMuc3RhcnRBdFNhbXBsZSA8IHRoaXMuZnVsbEVuZEF0U2FtcGxlLAogICAgICAgICAgICB0aGlzLmZ1bGxFbmRBdFNhbXBsZSA8PSB0aGlzLmZ1bGxTYW1wbGVDb3VudCwKICAgICAgICAgICAgdGhpcy5kdXJhdGlvbiA+IDAsCiAgICAgICAgXTsKICAgICAgICByZXN1bHRzLmZpbmQoKHJlc3VsdCwgaW5kZXgpID0+IHsKICAgICAgICAgICAgaWYgKCFyZXN1bHQpIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgZGlkIG5vdCBwYXNzIG5vcm1hbCBjaGVjayBvbiBydWxlICR7aW5kZXh9YCk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICBpZiAodGhpcy5oYXNIZWFkZXJbImxvb3AiXSkgewogICAgICAgICAgICBjb25zdCBsb29wQ2hlY2tzID0gWwogICAgICAgICAgICAgICAgdGhpcy5zdGFydEF0U2FtcGxlIDw9IHRoaXMubG9vcFN0YXJ0QXRTYW1wbGUsCiAgICAgICAgICAgICAgICB0aGlzLmxvb3BTdGFydEF0U2FtcGxlIDwgdGhpcy5sb29wRW5kQXRTYW1wbGUsCiAgICAgICAgICAgICAgICB0aGlzLmxvb3BFbmRBdFNhbXBsZSA8PSB0aGlzLmZ1bGxFbmRBdFNhbXBsZSwKICAgICAgICAgICAgICAgIDAgPD0gdGhpcy5sb29wU3RhcnRUaW1lLAogICAgICAgICAgICAgICAgdGhpcy5sb29wU3RhcnRUaW1lIDwgdGhpcy5sb29wRW5kVGltZSwKICAgICAgICAgICAgICAgIHRoaXMubG9vcEVuZFRpbWUgPD0gdGhpcy5kdXJhdGlvbiArIDEuMCAvIHRoaXMuZm9ybWF0LnNhbXBsaW5nUmF0ZSwKICAgICAgICAgICAgXTsKICAgICAgICAgICAgbG9vcENoZWNrcy5maW5kKChyZXN1bHQsIGluZGV4KSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoIXJlc3VsdCkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgZGlkIG5vdCBwYXNzIGxvb3AgY2hlY2sgb24gcnVsZSAke2luZGV4fWApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CiAgICBnZXRSYXdIZWFkZXIoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucmF3SGVhZGVyLnNsaWNlKDApOwogICAgfQogICAgaXNIZWFkZXJDaGFuZ2VkKGhjYSkgewogICAgICAgIGlmIChoY2EubGVuZ3RoID49IHRoaXMucmF3SGVhZGVyLmxlbmd0aCkgewogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucmF3SGVhZGVyLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoaGNhW2ldICE9IHRoaXMucmF3SGVhZGVyW2ldKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICBtb2RpZnkoaGNhLCBzaWcsIG5ld0RhdGEpIHsKICAgICAgICAvLyByZXBhcnNlIGhlYWRlciBpZiBuZWVkZWQKICAgICAgICBpZiAodGhpcy5pc0hlYWRlckNoYW5nZWQoaGNhKSkgewogICAgICAgICAgICB0aGlzLnBhcnNlSGVhZGVyKGhjYSwgZmFsc2UsIGZhbHNlLCB7fSk7CiAgICAgICAgfQogICAgICAgIC8vIHByZXBhcmUgdG8gbW9kaWZ5IGRhdGEgaW4tcGxhY2UKICAgICAgICBsZXQgbW9kTGlzdCA9IHt9OwogICAgICAgIG1vZExpc3Rbc2lnXSA9IG5ld0RhdGE7CiAgICAgICAgbGV0IGVuY3J5cHQgPSB0aGlzLmNpcGhlciAhPSAwOwogICAgICAgIGlmIChzaWcgPT09ICJjaXBoIikgewogICAgICAgICAgICBlbmNyeXB0ID0gbmV3IERhdGFWaWV3KG5ld0RhdGEuYnVmZmVyLCBuZXdEYXRhLmJ5dGVPZmZzZXQsIG5ld0RhdGEuYnl0ZUxlbmd0aCkuZ2V0VWludDE2KDApICE9IDA7CiAgICAgICAgfQogICAgICAgIC8vIGRvIGFjdHVhbCBtb2RpZmljYXRpb24gJiBjaGVjayB2YWxpZGl0eQogICAgICAgIHRoaXMucmF3SGVhZGVyID0gdGhpcy5wYXJzZUhlYWRlcihoY2EsIHRydWUsIGVuY3J5cHQsIG1vZExpc3QpOwogICAgfQogICAgc3RhdGljIGFkZEhlYWRlcihoY2EsIHNpZywgbmV3RGF0YSkgewogICAgICAgIC8vIHNpZyBtdXN0IGNvbnNpc3Qgb2YgMS00IEFTQ0lJIGNoYXJhY3RlcnMKICAgICAgICBpZiAoc2lnLmxlbmd0aCA8IDEgfHwgc2lnLmxlbmd0aCA+IDQpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgIGxldCBuZXdTaWcgPSBuZXcgVWludDhBcnJheSg0KTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDQ7IGkrKykgewogICAgICAgICAgICBsZXQgYyA9IHNpZy5jaGFyQ29kZUF0KGkpOwogICAgICAgICAgICBpZiAoYyA+PSAweDgwKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgICAgIG5ld1NpZ1tpXSA9IGM7CiAgICAgICAgfQogICAgICAgIC8vIHBhcnNlIGhlYWRlciAmIGNoZWNrIHZhbGlkdHkKICAgICAgICBsZXQgaW5mbyA9IG5ldyBIQ0FJbmZvKGhjYSk7CiAgICAgICAgLy8gY2hlY2sgd2hldGhlciBzcGVjaWZpZWQgaGVhZGVyIHNlY3Rpb24gYWxyZWFkeSBleGlzdHMKICAgICAgICBpZiAoaW5mby5oYXNIZWFkZXJbc2lnXSkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBoZWFkZXIgc2VjdGlvbiAke3NpZ30gYWxyZWFkeSBleGlzdHNgKTsKICAgICAgICAvLyBwcmVwYXJlIGEgbmV3bHkgYWxsb2NhdGVkIGJ1ZmZlcgogICAgICAgIGxldCBuZXdIY2EgPSBuZXcgVWludDhBcnJheShoY2EuYnl0ZUxlbmd0aCArIG5ld1NpZy5ieXRlTGVuZ3RoICsgbmV3RGF0YS5ieXRlTGVuZ3RoKTsKICAgICAgICBsZXQgaW5zZXJ0T2Zmc2V0ID0gaW5mby5oZWFkZXJPZmZzZXRbInBhZCJdWzBdOwogICAgICAgIC8vIGNvcHkgZXhpc3RpbmcgaGVhZGVycyAoZXhjZXB0IHBhZGRpbmcpCiAgICAgICAgbmV3SGNhLnNldChoY2Euc3ViYXJyYXkoMCwgaW5zZXJ0T2Zmc2V0KSwgMCk7CiAgICAgICAgLy8gY29weSBpbnNlcnRlZCBoZWFkZXIKICAgICAgICBuZXdIY2Euc2V0KG5ld1NpZywgaW5zZXJ0T2Zmc2V0KTsKICAgICAgICBuZXdIY2Euc2V0KG5ld0RhdGEsIGluc2VydE9mZnNldCArIG5ld1NpZy5ieXRlTGVuZ3RoKTsKICAgICAgICAvLyBjb3B5IHJlbWFpbmluZyBkYXRhIChwYWRkaW5nIGFuZCBibG9ja3MpCiAgICAgICAgbmV3SGNhLnNldChoY2Euc3ViYXJyYXkoaW5zZXJ0T2Zmc2V0LCBoY2EuYnl0ZUxlbmd0aCksIGluc2VydE9mZnNldCArIG5ld1NpZy5ieXRlTGVuZ3RoICsgbmV3RGF0YS5ieXRlTGVuZ3RoKTsKICAgICAgICAvLyB1cGRhdGUgZGF0YU9mZnNldAogICAgICAgIGluZm8uZGF0YU9mZnNldCArPSBuZXdTaWcuYnl0ZUxlbmd0aCArIG5ld0RhdGEuYnl0ZUxlbmd0aDsKICAgICAgICBsZXQgcCA9IG5ldyBEYXRhVmlldyhuZXdIY2EuYnVmZmVyLCBuZXdIY2EuYnl0ZU9mZnNldCwgbmV3SGNhLmJ5dGVMZW5ndGgpOwogICAgICAgIHAuc2V0SW50MTYoNiwgaW5mby5kYXRhT2Zmc2V0KTsKICAgICAgICAvLyBmaXggY2hlY2tzdW0KICAgICAgICBIQ0FDcmMxNi5maXgobmV3SGNhLCBpbmZvLmRhdGFPZmZzZXQgLSAyKTsKICAgICAgICAvLyByZXBhcnNlIGhlYWRlciAmIHJlY2hlY2sgdmFsaWR0eQogICAgICAgIGluZm8gPSBuZXcgSENBSW5mbyhuZXdIY2EpOwogICAgICAgIHJldHVybiBuZXdIY2E7CiAgICB9CiAgICBzdGF0aWMgYWRkQ2lwaGVySGVhZGVyKGhjYSwgY2lwaGVyVHlwZSkgewogICAgICAgIGxldCBuZXdEYXRhID0gbmV3IFVpbnQ4QXJyYXkoMik7CiAgICAgICAgaWYgKGNpcGhlclR5cGUgIT0gbnVsbCkKICAgICAgICAgICAgbmV3IERhdGFWaWV3KG5ld0RhdGEuYnVmZmVyKS5zZXRVaW50MTYoMCwgY2lwaGVyVHlwZSk7CiAgICAgICAgcmV0dXJuIHRoaXMuYWRkSGVhZGVyKGhjYSwgImNpcGgiLCBuZXdEYXRhKTsKICAgIH0KICAgIHN0YXRpYyBmaXhIZWFkZXJDaGVja3N1bShoY2EpIHsKICAgICAgICBsZXQgcCA9IG5ldyBEYXRhVmlldyhoY2EuYnVmZmVyLCBoY2EuYnl0ZU9mZnNldCwgOCk7CiAgICAgICAgbGV0IGhlYWQgPSB0aGlzLmdldFNpZ24ocCwgMCwgZmFsc2UsIGZhbHNlKTsKICAgICAgICBpZiAoaGVhZCAhPT0gIkhDQSIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJOb3QgYSBIQ0EgZmlsZSIpOwogICAgICAgIH0KICAgICAgICBsZXQgZGF0YU9mZnNldCA9IHAuZ2V0VWludDE2KDYpOwogICAgICAgIEhDQUNyYzE2LmZpeChoY2EsIGRhdGFPZmZzZXQgLSAyKTsKICAgICAgICByZXR1cm4gaGNhOwogICAgfQogICAgY2FsY0luV2F2U2l6ZShtb2RlID0gMzIpIHsKICAgICAgICBzd2l0Y2ggKG1vZGUpIHsKICAgICAgICAgICAgY2FzZSAwOiAvLyBmbG9hdAogICAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgIGNhc2UgMTY6CiAgICAgICAgICAgIGNhc2UgMjQ6CiAgICAgICAgICAgIGNhc2UgMzI6IC8vIGludGVnZXIKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgbW9kZSA9IDMyOwogICAgICAgIH0KICAgICAgICBsZXQgYml0c1BlclNhbXBsZSA9IG1vZGUgPT0gMCA/IDMyIDogbW9kZTsKICAgICAgICBsZXQgc2FtcGxlU2l6ZUluV2F2ID0gdGhpcy5mb3JtYXQuY2hhbm5lbENvdW50ICogYml0c1BlclNhbXBsZSAvIDg7CiAgICAgICAgcmV0dXJuIHRoaXMuaW5XYXZTaXplID0gewogICAgICAgICAgICBiaXRzUGVyU2FtcGxlOiBiaXRzUGVyU2FtcGxlLAogICAgICAgICAgICBzYW1wbGU6IHNhbXBsZVNpemVJbldhdiwKICAgICAgICAgICAgYmxvY2s6IEhDQUZyYW1lLlNhbXBsZXNQZXJGcmFtZSAqIHNhbXBsZVNpemVJbldhdiwKICAgICAgICAgICAgZHJvcHBlZDogewogICAgICAgICAgICAgICAgaGVhZGVyOiB0aGlzLmZvcm1hdC5kcm9wcGVkSGVhZGVyICogc2FtcGxlU2l6ZUluV2F2LAogICAgICAgICAgICAgICAgZm9vdGVyOiB0aGlzLmZvcm1hdC5kcm9wcGVkRm9vdGVyICogc2FtcGxlU2l6ZUluV2F2LAogICAgICAgICAgICB9LAogICAgICAgICAgICBsb29wOiB0aGlzLmhhc0hlYWRlclsibG9vcCJdID8gewogICAgICAgICAgICAgICAgbG9vcFBhcnQ6ICh0aGlzLmxvb3BFbmRBdFNhbXBsZSAtIHRoaXMubG9vcFN0YXJ0QXRTYW1wbGUpICogc2FtcGxlU2l6ZUluV2F2LAogICAgICAgICAgICAgICAgZHJvcHBlZDogewogICAgICAgICAgICAgICAgICAgIGhlYWRlcjogdGhpcy5sb29wLmRyb3BwZWRIZWFkZXIgKiBzYW1wbGVTaXplSW5XYXYsCiAgICAgICAgICAgICAgICAgICAgZm9vdGVyOiB0aGlzLmxvb3AuZHJvcHBlZEZvb3RlciAqIHNhbXBsZVNpemVJbldhdiwKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSA6IHVuZGVmaW5lZCwKICAgICAgICB9OwogICAgfQogICAgY29uc3RydWN0b3IoaGNhLCBjaGFuZ2VNYXNrID0gZmFsc2UsIGVuY3J5cHQgPSBmYWxzZSkgewogICAgICAgIHRoaXMudmVyc2lvbiA9ICIiOwogICAgICAgIHRoaXMuZGF0YU9mZnNldCA9IDA7CiAgICAgICAgdGhpcy5mb3JtYXQgPSB7CiAgICAgICAgICAgIGNoYW5uZWxDb3VudDogMCwKICAgICAgICAgICAgc2FtcGxpbmdSYXRlOiAwLAogICAgICAgICAgICBibG9ja0NvdW50OiAwLAogICAgICAgICAgICBkcm9wcGVkSGVhZGVyOiAwLAogICAgICAgICAgICBkcm9wcGVkRm9vdGVyOiAwCiAgICAgICAgfTsKICAgICAgICB0aGlzLmJsb2NrU2l6ZSA9IDA7CiAgICAgICAgdGhpcy5oYXNIZWFkZXIgPSB7fTsKICAgICAgICB0aGlzLmhlYWRlck9mZnNldCA9IHt9OyAvLyBbc3RhcnQgKGluY2x1c2l2ZSksIGVuZCAoZXhjbHVzaXZlKV0KICAgICAgICB0aGlzLmticHMgPSAwOwogICAgICAgIHRoaXMuY29tcERlYyA9IHsKICAgICAgICAgICAgTWluUmVzb2x1dGlvbjogMCwKICAgICAgICAgICAgTWF4UmVzb2x1dGlvbjogMCwKICAgICAgICAgICAgVHJhY2tDb3VudDogMCwKICAgICAgICAgICAgQ2hhbm5lbENvbmZpZzogMCwKICAgICAgICAgICAgVG90YWxCYW5kQ291bnQ6IDAsCiAgICAgICAgICAgIEJhc2VCYW5kQ291bnQ6IDAsCiAgICAgICAgICAgIFN0ZXJlb0JhbmRDb3VudDogMCwKICAgICAgICAgICAgSGZyQmFuZENvdW50OiAwLAogICAgICAgICAgICBCYW5kc1Blckhmckdyb3VwOiAwLAogICAgICAgICAgICBSZXNlcnZlZDE6IDAsCiAgICAgICAgICAgIFJlc2VydmVkMjogMCwKICAgICAgICB9OwogICAgICAgIHRoaXMuZGVjID0gewogICAgICAgICAgICBEZWNTdGVyZW9UeXBlOiAwLAogICAgICAgIH07CiAgICAgICAgdGhpcy5sb29wID0gewogICAgICAgICAgICBzdGFydDogMCwKICAgICAgICAgICAgZW5kOiAwLAogICAgICAgICAgICAvLyBjb3VudDogMCwgLy8gTnlhZ2Ftb24ncyBpbnRlcnByZXRhdGlvbgogICAgICAgICAgICAvLyByMDE6IDAsCiAgICAgICAgICAgIGRyb3BwZWRIZWFkZXI6IDAsCiAgICAgICAgICAgIGRyb3BwZWRGb290ZXI6IDAsCiAgICAgICAgfTsKICAgICAgICB0aGlzLnZiciA9IHsKICAgICAgICAgICAgTWF4QmxvY2tTaXplOiAwLAogICAgICAgICAgICBOb2lzZUxldmVsOiAwLAogICAgICAgIH07CiAgICAgICAgdGhpcy5Vc2VBdGhDdXJ2ZSA9IGZhbHNlOwogICAgICAgIHRoaXMuY2lwaGVyID0gMDsKICAgICAgICB0aGlzLnJ2YSA9IDAuMDsKICAgICAgICB0aGlzLmNvbW1lbnQgPSAiIjsKICAgICAgICAvLyBjb21wdXRlZCBzYW1wbGUgY291bnQvb2Zmc2V0cwogICAgICAgIHRoaXMuSGZyR3JvdXBDb3VudCA9IDA7CiAgICAgICAgdGhpcy5mdWxsU2FtcGxlQ291bnQgPSAwOwogICAgICAgIHRoaXMuc3RhcnRBdFNhbXBsZSA9IDA7CiAgICAgICAgdGhpcy5mdWxsRW5kQXRTYW1wbGUgPSAwOwogICAgICAgIHRoaXMubG9vcFN0YXJ0QXRTYW1wbGUgPSAwOwogICAgICAgIHRoaXMubG9vcEVuZEF0U2FtcGxlID0gMDsKICAgICAgICB0aGlzLmxvb3BTYW1wbGVDb3VudCA9IDA7CiAgICAgICAgdGhpcy5sb29wU3RhcnRUaW1lID0gMDsgLy8gaW4gc2Vjb25kcwogICAgICAgIHRoaXMubG9vcEVuZFRpbWUgPSAwOyAvLyBpbiBzZWNvbmRzCiAgICAgICAgdGhpcy5sb29wRHVyYXRpb24gPSAwOyAvLyBpbiBzZWNvbmRzCiAgICAgICAgdGhpcy5lbmRBdFNhbXBsZSA9IDA7CiAgICAgICAgdGhpcy5zYW1wbGVDb3VudCA9IDA7CiAgICAgICAgdGhpcy5kdXJhdGlvbiA9IDA7IC8vIGluIHNlY29uZHMKICAgICAgICAvLyBmdWxsIGZpbGUgc2l6ZSAvIGRhdGEgcGFydCAoZXhjbHVkaW5nIGhlYWRlciwganVzdCBibG9ja3MvZnJhbWVzKSBzaXplCiAgICAgICAgdGhpcy5mdWxsU2l6ZSA9IDA7CiAgICAgICAgdGhpcy5kYXRhU2l6ZSA9IDA7CiAgICAgICAgLy8gaWYgY2hhbmdlTWFzayA9PSB0cnVlLCAodW4pbWFzayB0aGUgaGVhZGVyIHNpZ3MgaW4tcGxhY2UKICAgICAgICB0aGlzLnJhd0hlYWRlciA9IHRoaXMucGFyc2VIZWFkZXIoaGNhLCBjaGFuZ2VNYXNrLCBlbmNyeXB0LCB7fSk7CiAgICB9Cn0KY2xhc3MgSENBVXRpbEZ1bmMgewogICAgc3RhdGljIERpdmlkZUJ5Um91bmRVcCh2YWx1ZSwgZGl2aXNvcikgewogICAgICAgIHJldHVybiBNYXRoLmNlaWwodmFsdWUgLyBkaXZpc29yKTsKICAgIH0KICAgIHN0YXRpYyBHZXRIaWdoTmliYmxlKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlID4gMHhmZikKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgaWYgKHZhbHVlIDwgLTB4ODApCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgIHJldHVybiAodmFsdWUgPj4+IDQpICYgMHhGOwogICAgfQogICAgc3RhdGljIEdldExvd05pYmJsZSh2YWx1ZSkgewogICAgICAgIGlmICh2YWx1ZSA+IDB4ZmYpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgIGlmICh2YWx1ZSA8IC0weDgwKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICByZXR1cm4gdmFsdWUgJiAweEY7CiAgICB9CiAgICBzdGF0aWMgR2V0SGlnaE5pYmJsZVNpZ25lZCh2YWx1ZSkgewogICAgICAgIGlmICh2YWx1ZSA+IDB4ZmYpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgIGlmICh2YWx1ZSA8IC0weDgwKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICByZXR1cm4gdGhpcy5TaWduZWROaWJibGVzWyh2YWx1ZSA+Pj4gNCkgJiAweEZdOwogICAgfQogICAgc3RhdGljIEdldExvd05pYmJsZVNpZ25lZCh2YWx1ZSkgewogICAgICAgIGlmICh2YWx1ZSA+IDB4ZmYpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgIGlmICh2YWx1ZSA8IC0weDgwKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICByZXR1cm4gdGhpcy5TaWduZWROaWJibGVzW3ZhbHVlICYgMHhGXTsKICAgIH0KICAgIHN0YXRpYyBDb21iaW5lTmliYmxlcyhoaWdoLCBsb3cpIHsKICAgICAgICByZXR1cm4gKChoaWdoIDw8IDQpIHwgKGxvdyAmIDB4RikpICYgMHhGRjsKICAgIH0KICAgIHN0YXRpYyBHZXROZXh0TXVsdGlwbGUodmFsdWUsIG11bHRpcGxlKSB7CiAgICAgICAgaWYgKG11bHRpcGxlIDw9IDApCiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICBpZiAodmFsdWUgJSBtdWx0aXBsZSA9PSAwKQogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgcmV0dXJuIHZhbHVlICsgbXVsdGlwbGUgLSB2YWx1ZSAlIG11bHRpcGxlOwogICAgfQogICAgc3RhdGljIFNpZ25lZEJpdFJldmVyc2UzMih2YWx1ZSkgewogICAgICAgIGlmICh2YWx1ZSA+IDB4ZmZmZmZmZmYpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgIGlmICh2YWx1ZSA8IC0weDgwMDAwMDAwKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICB2YWx1ZSA9ICgodmFsdWUgJiAweGFhYWFhYWFhKSA+Pj4gMSkgfCAoKHZhbHVlICYgMHg1NTU1NTU1NSkgPDwgMSk7CiAgICAgICAgdmFsdWUgPSAoKHZhbHVlICYgMHhjY2NjY2NjYykgPj4+IDIpIHwgKCh2YWx1ZSAmIDB4MzMzMzMzMzMpIDw8IDIpOwogICAgICAgIHZhbHVlID0gKCh2YWx1ZSAmIDB4ZjBmMGYwZjApID4+PiA0KSB8ICgodmFsdWUgJiAweDBmMGYwZjBmKSA8PCA0KTsKICAgICAgICB2YWx1ZSA9ICgodmFsdWUgJiAweGZmMDBmZjAwKSA+Pj4gOCkgfCAoKHZhbHVlICYgMHgwMGZmMDBmZikgPDwgOCk7CiAgICAgICAgcmV0dXJuICgodmFsdWUgJiAweGZmZmYwMDAwKSA+Pj4gMTYpIHwgKCh2YWx1ZSAmIDB4MDAwMGZmZmYpIDw8IDE2KTsKICAgIH0KICAgIHN0YXRpYyBVbnNpZ25lZEJpdFJldmVyc2UzMih2YWx1ZSkgewogICAgICAgIHJldHVybiB0aGlzLlNpZ25lZEJpdFJldmVyc2UzMih2YWx1ZSkgPj4+IDA7CiAgICB9CiAgICBzdGF0aWMgVW5zaWduZWRCaXRSZXZlcnNlMzJUcnVuYyh2YWx1ZSwgYml0Q291bnQpIHsKICAgICAgICByZXR1cm4gdGhpcy5VbnNpZ25lZEJpdFJldmVyc2UzMih2YWx1ZSkgPj4+ICgzMiAtIGJpdENvdW50KTsKICAgIH0KICAgIHN0YXRpYyBTaWduZWRCaXRSZXZlcnNlMzJUcnVuYyh2YWx1ZSwgYml0Q291bnQpIHsKICAgICAgICByZXR1cm4gdGhpcy5VbnNpZ25lZEJpdFJldmVyc2UzMlRydW5jKHZhbHVlID4+PiAwLCBiaXRDb3VudCk7CiAgICB9CiAgICBzdGF0aWMgQml0UmV2ZXJzZTgodmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgPiAweGZmKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICBpZiAodmFsdWUgPCAtMHg4MCkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgdmFsdWUgPj4+PSAwOwogICAgICAgIHZhbHVlID0gKCh2YWx1ZSAmIDB4YWEpID4+PiAxKSB8ICgodmFsdWUgJiAweDU1KSA8PCAxKTsKICAgICAgICB2YWx1ZSA9ICgodmFsdWUgJiAweGNjKSA+Pj4gMikgfCAoKHZhbHVlICYgMHgzMykgPDwgMik7CiAgICAgICAgcmV0dXJuICgoKHZhbHVlICYgMHhmMCkgPj4+IDQpIHwgKCh2YWx1ZSAmIDB4MGYpIDw8IDQpKSA+Pj4gMDsKICAgIH0KICAgIHN0YXRpYyBDbGFtcCh2YWx1ZSwgbWluLCBtYXgpIHsKICAgICAgICBpZiAodmFsdWUgPCBtaW4pCiAgICAgICAgICAgIHJldHVybiBtaW47CiAgICAgICAgaWYgKHZhbHVlID4gbWF4KQogICAgICAgICAgICByZXR1cm4gbWF4OwogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICAgIHN0YXRpYyBEZWJ1Z0Fzc2VydChjb25kaXRpb24pIHsKICAgICAgICBpZiAoIWNvbmRpdGlvbikKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJEZWJ1Z0Fzc2VydCBmYWlsZWQiKTsKICAgIH0KfQpIQ0FVdGlsRnVuYy5TaWduZWROaWJibGVzID0gWzAsIDEsIDIsIDMsIDQsIDUsIDYsIDcsIC04LCAtNywgLTYsIC01LCAtNCwgLTMsIC0yLCAtMV07CmV4cG9ydCBjbGFzcyBIQ0EgewogICAgY29uc3RydWN0b3IoKSB7CiAgICB9CiAgICBzdGF0aWMgZGVjcnlwdChoY2EsIGtleTEsIGtleTIpIHsKICAgICAgICByZXR1cm4gdGhpcy5kZWNyeXB0T3JFbmNyeXB0KGhjYSwgZmFsc2UsIGtleTEsIGtleTIpOwogICAgfQogICAgc3RhdGljIGVuY3J5cHQoaGNhLCBrZXkxLCBrZXkyKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZGVjcnlwdE9yRW5jcnlwdChoY2EsIHRydWUsIGtleTEsIGtleTIpOwogICAgfQogICAgc3RhdGljIGRlY3J5cHRPckVuY3J5cHQoaGNhLCBlbmNyeXB0LCBrZXkxLCBrZXkyKSB7CiAgICAgICAgLy8gaW4tcGxhY2UgZGVjcnlwdGlvbi9lbmNyeXB0aW9uCiAgICAgICAgLy8gcGFyc2UgaGVhZGVyCiAgICAgICAgbGV0IGluZm8gPSBuZXcgSENBSW5mbyhoY2EpOyAvLyB0aHJvd3MgIk5vdCBhIEhDQSBmaWxlIiBpZiBtaXNtYXRjaAogICAgICAgIGlmICghZW5jcnlwdCAmJiAhaW5mby5oYXNIZWFkZXJbImNpcGgiXSkgewogICAgICAgICAgICByZXR1cm4gaGNhOyAvLyBub3QgZW5jcnlwdGVkCiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGVuY3J5cHQgJiYgIWluZm8uaGFzSGVhZGVyWyJjaXBoIl0pIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnB1dCBoY2EgbGFja3MgXCJjaXBoXCIgaGVhZGVyIHNlY3Rpb24uIFBsZWFzZSBjYWxsIEhDQUluZm8uYWRkQ2lwaGVySGVhZGVyKGhjYSkgZmlyc3QuIik7CiAgICAgICAgfQogICAgICAgIGxldCBjaXBoZXI7CiAgICAgICAgc3dpdGNoIChpbmZvLmNpcGhlcikgewogICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAvLyBub3QgZW5jcnlwdGVkCiAgICAgICAgICAgICAgICBpZiAoZW5jcnlwdCkKICAgICAgICAgICAgICAgICAgICBjaXBoZXIgPSBuZXcgSENBQ2lwaGVyKGtleTEsIGtleTIpLmludmVydFRhYmxlKCk7CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhjYTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICAvLyBlbmNyeXB0ZWQgd2l0aCAibm8ga2V5IgogICAgICAgICAgICAgICAgaWYgKGVuY3J5cHQpCiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJhbHJlYWR5IGVuY3J5cHRlZCB3aXRoIFwibm8ga2V5XCIsIHBsZWFzZSBkZWNyeXB0IGZpcnN0Iik7CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgY2lwaGVyID0gbmV3IEhDQUNpcGhlcigibm9uZSIpOyAvLyBpZ25vcmUgZ2l2ZW4ga2V5cwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgMHgzODoKICAgICAgICAgICAgICAgIC8vIGVuY3J5cHRlZCB3aXRoIGtleXMgLSB3aWxsIHlpZWxkIGluY29ycmVjdCB3YXZlZm9ybSBpZiBpbmNvcnJlY3Qga2V5cyBhcmUgZ2l2ZW4hCiAgICAgICAgICAgICAgICBpZiAoZW5jcnlwdCkKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImFscmVhZHkgZW5jcnlwdGVkIHdpdGggc3BlY2lmaWMga2V5cywgcGxlYXNlIGRlY3J5cHQgd2l0aCBjb3JyZWN0IGtleXMgZmlyc3QiKTsKICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICBjaXBoZXIgPSBuZXcgSENBQ2lwaGVyKGtleTEsIGtleTIpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInVua25vd24gY2lwaC50eXBlIik7CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5mby5mb3JtYXQuYmxvY2tDb3VudDsgKytpKSB7CiAgICAgICAgICAgIGxldCBmdGVsbCA9IGluZm8uZGF0YU9mZnNldCArIGluZm8uYmxvY2tTaXplICogaTsKICAgICAgICAgICAgbGV0IGJsb2NrID0gaGNhLnN1YmFycmF5KGZ0ZWxsLCBmdGVsbCArIGluZm8uYmxvY2tTaXplKTsKICAgICAgICAgICAgLy8gdmVyaWZ5IGJsb2NrIGNoZWNrc3VtCiAgICAgICAgICAgIEhDQUNyYzE2LnZlcmlmeShibG9jaywgaW5mby5ibG9ja1NpemUgLSAyKTsKICAgICAgICAgICAgLy8gZGVjcnlwdC9lbmNyeXB0IGJsb2NrCiAgICAgICAgICAgIGNpcGhlci5tYXNrKGJsb2NrLCAwLCBpbmZvLmJsb2NrU2l6ZSAtIDIpOwogICAgICAgICAgICAvLyBmaXggY2hlY2tzdW0KICAgICAgICAgICAgSENBQ3JjMTYuZml4KGJsb2NrLCBpbmZvLmJsb2NrU2l6ZSAtIDIpOwogICAgICAgIH0KICAgICAgICAvLyByZS0odW4pbWFzayBoZWFkZXJzLCBhbmQgc2V0IGNpcGggaGVhZGVyIHRvIG5ldyB2YWx1ZQogICAgICAgIGxldCBuZXdDaXBoZXJEYXRhID0gbmV3IFVpbnQ4QXJyYXkoMik7CiAgICAgICAgbGV0IG5ld0NpcGhlclR5cGUgPSBlbmNyeXB0ID8gY2lwaGVyLmdldFR5cGUoKSA6IDA7CiAgICAgICAgbmV3IERhdGFWaWV3KG5ld0NpcGhlckRhdGEuYnVmZmVyKS5zZXRVaW50MTYoMCwgbmV3Q2lwaGVyVHlwZSk7CiAgICAgICAgaW5mby5tb2RpZnkoaGNhLCAiY2lwaCIsIG5ld0NpcGhlckRhdGEpOwogICAgICAgIHJldHVybiBoY2E7CiAgICB9CiAgICBzdGF0aWMgZGVjb2RlKGhjYSwgbW9kZSA9IDMyLCBsb29wID0gMCwgdm9sdW1lID0gMS4wKSB7CiAgICAgICAgc3dpdGNoIChtb2RlKSB7CiAgICAgICAgICAgIGNhc2UgMDogLy8gZmxvYXQKICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICBjYXNlIDE2OgogICAgICAgICAgICBjYXNlIDI0OgogICAgICAgICAgICBjYXNlIDMyOiAvLyBpbnRlZ2VyCiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIG1vZGUgPSAzMjsKICAgICAgICB9CiAgICAgICAgaWYgKHZvbHVtZSA+IDEpCiAgICAgICAgICAgIHZvbHVtZSA9IDE7CiAgICAgICAgZWxzZSBpZiAodm9sdW1lIDwgMCkKICAgICAgICAgICAgdm9sdW1lID0gMDsKICAgICAgICBsZXQgaW5mbyA9IG5ldyBIQ0FJbmZvKGhjYSk7IC8vIHRocm93cyAiTm90IGEgSENBIGZpbGUiIGlmIG1pc21hdGNoCiAgICAgICAgbGV0IGZyYW1lID0gbmV3IEhDQUZyYW1lKGluZm8pOwogICAgICAgIGlmIChpbmZvLmhhc0hlYWRlclsiY2lwaCJdICYmIGluZm8uY2lwaGVyICE9IDApIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJIQ0EgaXMgZW5jcnlwdGVkLCBwbGVhc2UgZGVjcnlwdCBpdCBmaXJzdCBiZWZvcmUgZGVjb2RpbmciKTsKICAgICAgICB9CiAgICAgICAgLy8gcHJlcGFyZSBvdXRwdXQgV0FWIGZpbGUKICAgICAgICBjb25zdCBvdXRwdXRXYXYgPSBuZXcgSENBV2F2KGluZm8sIG1vZGUsIGxvb3ApOwogICAgICAgIGNvbnN0IGZpbGVCdWYgPSBvdXRwdXRXYXYuZmlsZUJ1ZjsKICAgICAgICBjb25zdCBkYXRhUGFydCA9IG91dHB1dFdhdi5kYXRhUGFydDsKICAgICAgICAvLyBjYWxjdWxhdGUgaW4tV0FWIHNpemUKICAgICAgICBsZXQgaW5XYXZTaXplID0gaW5mby5jYWxjSW5XYXZTaXplKG1vZGUpOwogICAgICAgIC8vIGRlY29kZSBibG9ja3MgKGZyYW1lcykKICAgICAgICBsZXQgZmFpbGVkQmxvY2tzID0gW10sIGxhc3RFcnJvciA9IHVuZGVmaW5lZDsKICAgICAgICBmb3IgKGxldCBpID0gMCwgb2Zmc2V0ID0gMDsgaSA8IGluZm8uZm9ybWF0LmJsb2NrQ291bnQ7IGkrKykgewogICAgICAgICAgICBsZXQgbGFzdERlY29kZWRTYW1wbGVzID0gaSAqIEhDQUZyYW1lLlNhbXBsZXNQZXJGcmFtZTsKICAgICAgICAgICAgbGV0IGN1cnJlbnREZWNvZGVkU2FtcGxlcyA9IGxhc3REZWNvZGVkU2FtcGxlcyArIEhDQUZyYW1lLlNhbXBsZXNQZXJGcmFtZTsKICAgICAgICAgICAgaWYgKGN1cnJlbnREZWNvZGVkU2FtcGxlcyA8PSBpbmZvLnN0YXJ0QXRTYW1wbGUgfHwgbGFzdERlY29kZWRTYW1wbGVzID49IGluZm8uZW5kQXRTYW1wbGUpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxldCBzdGFydE9mZnNldCA9IGluZm8uZGF0YU9mZnNldCArIGluZm8uYmxvY2tTaXplICogaTsKICAgICAgICAgICAgbGV0IGJsb2NrID0gaGNhLnN1YmFycmF5KHN0YXJ0T2Zmc2V0LCBzdGFydE9mZnNldCArIGluZm8uYmxvY2tTaXplKTsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHRoaXMuZGVjb2RlQmxvY2soZnJhbWUsIGJsb2NrKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgZmFpbGVkQmxvY2tzLnB1c2goaSk7CiAgICAgICAgICAgICAgICBsYXN0RXJyb3IgPSBlOwogICAgICAgICAgICAgICAgZnJhbWUgPSBuZXcgSENBRnJhbWUoaW5mbyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGV0IHdhdmVidWZmOwogICAgICAgICAgICBpZiAobGFzdERlY29kZWRTYW1wbGVzIDwgaW5mby5zdGFydEF0U2FtcGxlIHx8IGN1cnJlbnREZWNvZGVkU2FtcGxlcyA+IGluZm8uZW5kQXRTYW1wbGUpIHsKICAgICAgICAgICAgICAgIC8vIGNyb3NzaW5nIHN0YXJ0QXRTYW1wbGUvZW5kQXRTYW1wbGUsIHNraXAvZHJvcCBzcGVjaWZpZWQgYnl0ZXMKICAgICAgICAgICAgICAgIHdhdmVidWZmID0gdGhpcy53cml0ZVRvUENNKGZyYW1lLCBtb2RlLCB2b2x1bWUpOwogICAgICAgICAgICAgICAgaWYgKGxhc3REZWNvZGVkU2FtcGxlcyA8IGluZm8uc3RhcnRBdFNhbXBsZSkgewogICAgICAgICAgICAgICAgICAgIGxldCBza2lwcGVkU2l6ZSA9IChpbmZvLnN0YXJ0QXRTYW1wbGUgLSBsYXN0RGVjb2RlZFNhbXBsZXMpICogaW5XYXZTaXplLnNhbXBsZTsKICAgICAgICAgICAgICAgICAgICB3YXZlYnVmZiA9IHdhdmVidWZmLnN1YmFycmF5KHNraXBwZWRTaXplLCBpbldhdlNpemUuYmxvY2spOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAoY3VycmVudERlY29kZWRTYW1wbGVzID4gaW5mby5lbmRBdFNhbXBsZSkgewogICAgICAgICAgICAgICAgICAgIGxldCB3cml0ZVNpemUgPSAoaW5mby5lbmRBdFNhbXBsZSAtIGxhc3REZWNvZGVkU2FtcGxlcykgKiBpbldhdlNpemUuc2FtcGxlOwogICAgICAgICAgICAgICAgICAgIHdhdmVidWZmID0gd2F2ZWJ1ZmYuc3ViYXJyYXkoMCwgd3JpdGVTaXplKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcigic2hvdWxkIG5ldmVyIGdvIGhlcmUiKTsKICAgICAgICAgICAgICAgIGRhdGFQYXJ0LnNldCh3YXZlYnVmZiwgb2Zmc2V0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHdhdmVidWZmID0gdGhpcy53cml0ZVRvUENNKGZyYW1lLCBtb2RlLCB2b2x1bWUsIGRhdGFQYXJ0LCBvZmZzZXQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG9mZnNldCArPSB3YXZlYnVmZi5ieXRlTGVuZ3RoOwogICAgICAgIH0KICAgICAgICBpZiAoZmFpbGVkQmxvY2tzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgZXJyb3IgZGVjb2RpbmcgZm9sbG93aW5nIGJsb2NrcywgZmlsbGVkIHplcm9gLCBmYWlsZWRCbG9ja3MsIGxhc3RFcnJvcik7CiAgICAgICAgfQogICAgICAgIC8vIGRlY29kaW5nIGRvbmUsIHRoZW4ganVzdCBjb3B5IGxvb3BpbmcgcGFydAogICAgICAgIGlmIChpbmZvLmhhc0hlYWRlclsibG9vcCJdICYmIGxvb3ApIHsKICAgICAgICAgICAgLy8gInRhaWwiIGJleW9uZCBsb29wIGVuZCBpcyBkcm9wcGVkCiAgICAgICAgICAgIC8vIGNvcHkgbG9vcGluZyBhdWRpbyBjbGlwcwogICAgICAgICAgICBpZiAoaW5XYXZTaXplLmxvb3AgPT0gbnVsbCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgICAgICBsZXQgcHJlTG9vcFNpemVJbldhdiA9IGluV2F2U2l6ZS5zYW1wbGUgKiAoaW5mby5sb29wU3RhcnRBdFNhbXBsZSAtIGluZm8uc3RhcnRBdFNhbXBsZSk7CiAgICAgICAgICAgIGxldCBzcmMgPSBkYXRhUGFydC5zdWJhcnJheShwcmVMb29wU2l6ZUluV2F2LCBwcmVMb29wU2l6ZUluV2F2ICsgaW5XYXZTaXplLmxvb3AubG9vcFBhcnQpOwogICAgICAgICAgICBmb3IgKGxldCBpID0gMCwgc3RhcnQgPSBwcmVMb29wU2l6ZUluV2F2ICsgaW5XYXZTaXplLmxvb3AubG9vcFBhcnQ7IGkgPCBsb29wOyBpKyspIHsKICAgICAgICAgICAgICAgIGxldCBkc3QgPSBkYXRhUGFydC5zdWJhcnJheShzdGFydCwgc3RhcnQgKyBpbldhdlNpemUubG9vcC5sb29wUGFydCk7CiAgICAgICAgICAgICAgICBkc3Quc2V0KHNyYyk7CiAgICAgICAgICAgICAgICBzdGFydCArPSBpbldhdlNpemUubG9vcC5sb29wUGFydDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmlsZUJ1ZjsKICAgIH0KICAgIHN0YXRpYyBkZWNvZGVCbG9jayhmcmFtZSwgYmxvY2spIHsKICAgICAgICBsZXQgaW5mbyA9IGZyYW1lLkhjYTsKICAgICAgICBpZiAoYmxvY2suYnl0ZUxlbmd0aCAhPSBpbmZvLmJsb2NrU2l6ZSkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgLy8gdmVyaWZ5IGNoZWNrc3VtCiAgICAgICAgSENBQ3JjMTYudmVyaWZ5KGJsb2NrLCBpbmZvLmJsb2NrU2l6ZSAtIDIpOwogICAgICAgIC8vIGRlY29kZQogICAgICAgIEhDQURlY29kZXIuRGVjb2RlRnJhbWUoYmxvY2ssIGZyYW1lKTsKICAgIH0KICAgIHN0YXRpYyB3cml0ZVRvUENNKGZyYW1lLCBtb2RlID0gMzIsIHZvbHVtZSA9IDEuMCwgd3JpdGVyLCBmdGVsbCkgewogICAgICAgIHN3aXRjaCAobW9kZSkgewogICAgICAgICAgICBjYXNlIDA6IC8vIGZsb2F0CiAgICAgICAgICAgIGNhc2UgODoKICAgICAgICAgICAgY2FzZSAxNjoKICAgICAgICAgICAgY2FzZSAyNDoKICAgICAgICAgICAgY2FzZSAzMjogLy8gaW50ZWdlcgogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBtb2RlID0gMzI7CiAgICAgICAgfQogICAgICAgIGlmICh2b2x1bWUgPiAxKQogICAgICAgICAgICB2b2x1bWUgPSAxOwogICAgICAgIGVsc2UgaWYgKHZvbHVtZSA8IDApCiAgICAgICAgICAgIHZvbHVtZSA9IDA7CiAgICAgICAgLy8gY3JlYXRlIG5ldyB3cml0ZXIgaWYgbm90IHNwZWNpZmllZAogICAgICAgIGxldCBpbmZvID0gZnJhbWUuSGNhOwogICAgICAgIGlmICh3cml0ZXIgPT0gbnVsbCkgewogICAgICAgICAgICB3cml0ZXIgPSBuZXcgVWludDhBcnJheShIQ0FGcmFtZS5TYW1wbGVzUGVyRnJhbWUgKiBpbmZvLmZvcm1hdC5jaGFubmVsQ291bnQgKiAobW9kZSA9PSAwID8gMzIgOiBtb2RlKSAvIDgpOwogICAgICAgICAgICBpZiAoZnRlbGwgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgZnRlbGwgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICBpZiAoZnRlbGwgPT0gbnVsbCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgIH0KICAgICAgICAvLyB3cml0ZSBkZWNvZGVkIGRhdGEgaW50byB3cml0ZXIKICAgICAgICBsZXQgcCA9IG5ldyBEYXRhVmlldyh3cml0ZXIuYnVmZmVyLCB3cml0ZXIuYnl0ZU9mZnNldCwgd3JpdGVyLmJ5dGVMZW5ndGgpOwogICAgICAgIGxldCBmdGVsbEJlZ2luID0gZnRlbGw7CiAgICAgICAgZm9yIChsZXQgc2YgPSAwOyBzZiA8IEhDQUZyYW1lLlN1YmZyYW1lc1BlckZyYW1lOyBzZisrKSB7CiAgICAgICAgICAgIGZvciAobGV0IHMgPSAwOyBzIDwgSENBRnJhbWUuU2FtcGxlc1BlclN1YkZyYW1lOyBzKyspIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGMgPSAwOyBjIDwgZnJhbWUuQ2hhbm5lbHMubGVuZ3RoOyBjKyspIHsKICAgICAgICAgICAgICAgICAgICBsZXQgZiA9IGZyYW1lLkNoYW5uZWxzW2NdLlBjbUZsb2F0W3NmXVtzXSAqIHZvbHVtZTsKICAgICAgICAgICAgICAgICAgICBpZiAoZiA+IDEpCiAgICAgICAgICAgICAgICAgICAgICAgIGYgPSAxOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGYgPCAtMSkKICAgICAgICAgICAgICAgICAgICAgICAgZiA9IC0xOwogICAgICAgICAgICAgICAgICAgIHN3aXRjaCAobW9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBtdXN0IGJlIHVuc2lnbmVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLnNldFVpbnQ4KGZ0ZWxsLCBmICogMHg3RiArIDB4ODApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnRlbGwgKz0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDE2OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZm9yIGFib3ZlIDgtYml0IGludGVnZXIsIGxpdHRsZS1lbmRpYW4gc2lnbmVkIGludGVnZXIgaXMgdXNlZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gKHNldFVpbnQxNi9zZXRJbnQxNiBhY3R1YWxseSBkb2Vzbid0IHNlZW0gdG8gbWFrZSBhbnkgZGlmZmVyZW5jZSBoZXJlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5zZXRJbnQxNihmdGVsbCwgZiAqIDB4N0ZGRiwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdGVsbCArPSAyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMjQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGVyZSdzIG5vIHNldEludDI0LCB3cml0ZSAzIGJ5dGVzIHdpdGggc2V0VWludDggcmVzcGVjdGl2ZWx5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmICo9IDB4N0ZGRkZGOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5zZXRVaW50OChmdGVsbCwgZiAmIDB4RkYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5zZXRVaW50OChmdGVsbCArIDEsIGYgPj4gOCAmIDB4RkYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5zZXRVaW50OChmdGVsbCArIDIsIGYgPj4gMTYgJiAweEZGKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ0ZWxsICs9IDM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAzMjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAuc2V0SW50MzIoZnRlbGwsIGYgKiAweDdGRkZGRkZGLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ0ZWxsICs9IDQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZmxvYXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAuc2V0RmxvYXQzMihmdGVsbCwgZiwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdGVsbCArPSA0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInVua25vd24gbW9kZSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gd3JpdGVyLnN1YmFycmF5KGZ0ZWxsQmVnaW4sIGZ0ZWxsKTsKICAgIH0KICAgIHN0YXRpYyBmaXhDaGVja3N1bShoY2EpIHsKICAgICAgICBIQ0FJbmZvLmZpeEhlYWRlckNoZWNrc3VtKGhjYSk7CiAgICAgICAgbGV0IGluZm8gPSBuZXcgSENBSW5mbyhoY2EpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5mby5mb3JtYXQuYmxvY2tDb3VudDsgaSsrKSB7CiAgICAgICAgICAgIGxldCBmdGVsbCA9IGluZm8uZGF0YU9mZnNldCArIGkgKiBpbmZvLmJsb2NrU2l6ZTsKICAgICAgICAgICAgbGV0IGJsb2NrID0gaGNhLnN1YmFycmF5KGZ0ZWxsLCBmdGVsbCArIGluZm8uYmxvY2tTaXplKTsKICAgICAgICAgICAgSENBQ3JjMTYuZml4KGJsb2NrLCBpbmZvLmJsb2NrU2l6ZSAtIDIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gaGNhOwogICAgfQp9CmNsYXNzIEhDQVdhdiB7CiAgICBjb25zdHJ1Y3RvcihpbmZvLCBtb2RlID0gMzIsIGxvb3AgPSAwKSB7CiAgICAgICAgc3dpdGNoIChtb2RlKSB7CiAgICAgICAgICAgIGNhc2UgMDogLy8gZmxvYXQKICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICBjYXNlIDE2OgogICAgICAgICAgICBjYXNlIDI0OgogICAgICAgICAgICBjYXNlIDMyOiAvLyBpbnRlZ2VyCiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIG1vZGUgPSAzMjsKICAgICAgICB9CiAgICAgICAgaWYgKGlzTmFOKGxvb3ApKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImxvb3AgaXMgbm90IG51bWJlciIpOwogICAgICAgIGxvb3AgPSBNYXRoLmZsb29yKGxvb3ApOwogICAgICAgIGlmIChsb29wIDwgMCkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgbGV0IGluV2F2U2l6ZSA9IGluZm8uY2FsY0luV2F2U2l6ZShtb2RlKTsKICAgICAgICBsZXQgZGF0YVNpemUgPSBpbldhdlNpemUuc2FtcGxlICogaW5mby5zYW1wbGVDb3VudDsKICAgICAgICBpZiAobG9vcCA+IDApIHsKICAgICAgICAgICAgaWYgKGluV2F2U2l6ZS5sb29wID09IG51bGwpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICAgICAgZGF0YVNpemUgKz0gaW5XYXZTaXplLmxvb3AubG9vcFBhcnQgKiBsb29wOwogICAgICAgIH0KICAgICAgICAvLyBwcmVwYXJlIG1ldGFkYXRhIGNodW5rcyBhbmQgZGF0YSBjaHVuayBoZWFkZXIKICAgICAgICB0aGlzLmZtdCA9IG5ldyBIQ0FXYXZGbXRDaHVuayhpbmZvLCBtb2RlKTsKICAgICAgICBpZiAoaW5mby5oYXNIZWFkZXJbImNvbW0iXSkKICAgICAgICAgICAgdGhpcy5ub3RlID0gbmV3IEhDQVdhdkNvbW1lbnRDaHVuayhpbmZvKTsKICAgICAgICBpZiAoaW5mby5oYXNIZWFkZXJbImxvb3AiXSkKICAgICAgICAgICAgdGhpcy5zbXBsID0gbmV3IEhDQVdhdmVTbXBsQ2h1bmsoaW5mbyk7CiAgICAgICAgdGhpcy53YXZlUmlmZiA9IG5ldyBIQ0FXYXZXYXZlUmlmZkhlYWRlcig4ICsgdGhpcy5mbXQuc2l6ZQogICAgICAgICAgICArICh0aGlzLm5vdGUgPT0gbnVsbCA/IDAgOiA4ICsgdGhpcy5ub3RlLnNpemUpCiAgICAgICAgICAgICsgOCArIGRhdGFTaXplCiAgICAgICAgICAgICsgKHRoaXMuc21wbCA9PSBudWxsID8gMCA6IDggKyB0aGlzLnNtcGwuc2l6ZSkpOwogICAgICAgIC8vIGdldCBieXRlcyBvZiBwcmVwYXJlZCBjaHVua3MKICAgICAgICBsZXQgd2F2ZVJpZmZIZWFkZXIgPSB0aGlzLndhdmVSaWZmLmdldCgpOwogICAgICAgIGxldCBmbXRDaHVuayA9IHRoaXMuZm10LmdldCgpOwogICAgICAgIGxldCBub3RlQ2h1bmsgPSB0aGlzLm5vdGUgIT0gbnVsbCA/IHRoaXMubm90ZS5nZXQoKSA6IG5ldyBVaW50OEFycmF5KDApOwogICAgICAgIGxldCBkYXRhQ2h1bmtIZWFkZXIgPSBuZXcgVWludDhBcnJheSg4KTsKICAgICAgICBkYXRhQ2h1bmtIZWFkZXIuc2V0KG5ldyBUZXh0RW5jb2RlcigpLmVuY29kZSgiZGF0YSIpKTsKICAgICAgICBuZXcgRGF0YVZpZXcoZGF0YUNodW5rSGVhZGVyLmJ1ZmZlcikuc2V0VWludDMyKDQsIGRhdGFTaXplLCB0cnVlKTsKICAgICAgICBsZXQgc21wbENodW5rID0gdGhpcy5zbXBsICE9IG51bGwgPyB0aGlzLnNtcGwuZ2V0KCkgOiBuZXcgVWludDhBcnJheSgwKTsKICAgICAgICAvLyBjcmVhdGUgd2hvbGUtZmlsZSBidWZmZXIKICAgICAgICB0aGlzLmZpbGVCdWYgPSBuZXcgVWludDhBcnJheSg4ICsgdGhpcy53YXZlUmlmZi5zaXplKTsKICAgICAgICAvLyBjb3B5IHByZXBhcmVkIG1ldGFkYXRhIGNodW5rcyBhbmQgZGF0YSBjaHVuayBoZWFkZXIgdG8gd2hvbGUtZmlsZSBidWZmZXIKICAgICAgICBsZXQgd3JpdHRlbkxlbmd0aCA9IDA7CiAgICAgICAgW3dhdmVSaWZmSGVhZGVyLCBmbXRDaHVuaywgbm90ZUNodW5rLCBkYXRhQ2h1bmtIZWFkZXJdLmZvckVhY2goKGNodW5rKSA9PiB7CiAgICAgICAgICAgIHRoaXMuZmlsZUJ1Zi5zZXQoY2h1bmssIHdyaXR0ZW5MZW5ndGgpOwogICAgICAgICAgICB3cml0dGVuTGVuZ3RoICs9IGNodW5rLmJ5dGVMZW5ndGg7CiAgICAgICAgfSk7CiAgICAgICAgLy8gc2tpcCBkYXRhUGFydCBzaW5jZSBpdCdzIGVtcHR5CiAgICAgICAgdGhpcy5kYXRhUGFydCA9IHRoaXMuZmlsZUJ1Zi5zdWJhcnJheSh3cml0dGVuTGVuZ3RoLCB3cml0dGVuTGVuZ3RoICsgZGF0YVNpemUpOwogICAgICAgIHdyaXR0ZW5MZW5ndGggKz0gZGF0YVNpemU7CiAgICAgICAgLy8gY29weSB0aGUgbGFzdCBwcmVwYXJlZCBjaHVuayB0byB3aG9sZS1maWxlIGJ1ZmZlcgogICAgICAgIHRoaXMuZmlsZUJ1Zi5zZXQoc21wbENodW5rLCB3cml0dGVuTGVuZ3RoKTsKICAgICAgICB3cml0dGVuTGVuZ3RoICs9IHNtcGxDaHVuay5ieXRlTGVuZ3RoOwogICAgICAgIGlmICh3cml0dGVuTGVuZ3RoICE9IHRoaXMuZmlsZUJ1Zi5ieXRlTGVuZ3RoKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgIH0KfQpjbGFzcyBIQ0FXYXZXYXZlUmlmZkhlYWRlciB7CiAgICBjb25zdHJ1Y3RvcihzaXplKSB7CiAgICAgICAgaWYgKGlzTmFOKHNpemUpKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInNpemUgbXVzdCBiZSBudW1iZXIiKTsKICAgICAgICBzaXplID0gTWF0aC5mbG9vcihzaXplKTsKICAgICAgICBpZiAoc2l6ZSA8PSAwKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICB0aGlzLnNpemUgPSA0ICsgc2l6ZTsgLy8gIldBVkUiICsgcmVtYWluaW5nIHBhcnQKICAgIH0KICAgIGdldCgpIHsKICAgICAgICBsZXQgYnVmID0gbmV3IEFycmF5QnVmZmVyKDEyKTsKICAgICAgICBsZXQgcmV0ID0gbmV3IFVpbnQ4QXJyYXkoYnVmKTsKICAgICAgICBsZXQgcCA9IG5ldyBEYXRhVmlldyhidWYpOwogICAgICAgIGxldCB0ZSA9IG5ldyBUZXh0RW5jb2RlcigpOwogICAgICAgIHJldC5zZXQodGUuZW5jb2RlKCJSSUZGIiksIDApOwogICAgICAgIHAuc2V0VWludDMyKDQsIHRoaXMuc2l6ZSwgdHJ1ZSk7CiAgICAgICAgcmV0LnNldCh0ZS5lbmNvZGUoIldBVkUiKSwgOCk7CiAgICAgICAgcmV0dXJuIHJldDsKICAgIH0KfQpjbGFzcyBIQ0FXYXZGbXRDaHVuayB7CiAgICBjb25zdHJ1Y3RvcihpbmZvLCBtb2RlID0gMzIpIHsKICAgICAgICB0aGlzLnNpemUgPSAxNjsKICAgICAgICBzd2l0Y2ggKG1vZGUpIHsKICAgICAgICAgICAgY2FzZSAwOiAvLyBmbG9hdAogICAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgIGNhc2UgMTY6CiAgICAgICAgICAgIGNhc2UgMjQ6CiAgICAgICAgICAgIGNhc2UgMzI6IC8vIGludGVnZXIKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgbW9kZSA9IDMyOwogICAgICAgIH0KICAgICAgICBsZXQgaW5XYXZTaXplID0gaW5mby5jYWxjSW5XYXZTaXplKG1vZGUpOwogICAgICAgIHRoaXMuZm9ybWF0VGFnID0gbW9kZSA+IDAgPyAxIDogMzsKICAgICAgICB0aGlzLmNoYW5uZWxDb3VudCA9IGluZm8uZm9ybWF0LmNoYW5uZWxDb3VudDsKICAgICAgICB0aGlzLnNhbXBsZXNQZXJTZWMgPSBpbmZvLmZvcm1hdC5zYW1wbGluZ1JhdGU7CiAgICAgICAgdGhpcy5ieXRlc1BlclNlYyA9IGluV2F2U2l6ZS5zYW1wbGUgKiBpbmZvLmZvcm1hdC5zYW1wbGluZ1JhdGU7CiAgICAgICAgdGhpcy5ibG9ja0FsaWduID0gaW5XYXZTaXplLnNhbXBsZTsKICAgICAgICB0aGlzLmJpdHNQZXJTYW1wbGUgPSBpbldhdlNpemUuYml0c1BlclNhbXBsZTsKICAgIH0KICAgIGdldCgpIHsKICAgICAgICBsZXQgYnVmID0gbmV3IEFycmF5QnVmZmVyKDggKyB0aGlzLnNpemUpOwogICAgICAgIGxldCByZXQgPSBuZXcgVWludDhBcnJheShidWYpOwogICAgICAgIGxldCBwID0gbmV3IERhdGFWaWV3KGJ1Zik7CiAgICAgICAgbGV0IHRlID0gbmV3IFRleHRFbmNvZGVyKCk7CiAgICAgICAgcmV0LnNldCh0ZS5lbmNvZGUoImZtdCAiKSwgMCk7CiAgICAgICAgcC5zZXRVaW50MzIoNCwgdGhpcy5zaXplLCB0cnVlKTsKICAgICAgICBwLnNldFVpbnQxNig4LCB0aGlzLmZvcm1hdFRhZywgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MTYoMTAsIHRoaXMuY2hhbm5lbENvdW50LCB0cnVlKTsKICAgICAgICBwLnNldFVpbnQzMigxMiwgdGhpcy5zYW1wbGVzUGVyU2VjLCB0cnVlKTsKICAgICAgICBwLnNldFVpbnQzMigxNiwgdGhpcy5ieXRlc1BlclNlYywgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MTYoMjAsIHRoaXMuYmxvY2tBbGlnbiwgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MTYoMjIsIHRoaXMuYml0c1BlclNhbXBsZSwgdHJ1ZSk7CiAgICAgICAgcmV0dXJuIHJldDsKICAgIH0KfQpjbGFzcyBIQ0FXYXZDb21tZW50Q2h1bmsgewogICAgY29uc3RydWN0b3IoaW5mbykgewogICAgICAgIHRoaXMuY29tbWVudEJ1ZiA9IG5ldyBUZXh0RW5jb2RlcigpLmVuY29kZShpbmZvLmNvbW1lbnQpOwogICAgICAgIGxldCBzaXplID0gdGhpcy5jb21tZW50QnVmLmJ5dGVMZW5ndGg7CiAgICAgICAgc2l6ZSArPSA0OwogICAgICAgIGlmIChzaXplICUgNCkKICAgICAgICAgICAgc2l6ZSArPSA0IC0gc2l6ZSAlIDQ7CiAgICAgICAgdGhpcy5zaXplID0gc2l6ZTsKICAgIH0KICAgIGdldCgpIHsKICAgICAgICBsZXQgYnVmID0gbmV3IEFycmF5QnVmZmVyKDggKyB0aGlzLnNpemUpOwogICAgICAgIGxldCByZXQgPSBuZXcgVWludDhBcnJheShidWYpOwogICAgICAgIGxldCBwID0gbmV3IERhdGFWaWV3KGJ1Zik7CiAgICAgICAgbGV0IHRlID0gbmV3IFRleHRFbmNvZGVyKCk7CiAgICAgICAgcmV0LnNldCh0ZS5lbmNvZGUoIm5vdGUiKSwgMCk7CiAgICAgICAgcC5zZXRVaW50MzIoNCwgdGhpcy5zaXplLCB0cnVlKTsKICAgICAgICByZXQuc2V0KHRoaXMuY29tbWVudEJ1ZiwgOCk7CiAgICAgICAgcmV0dXJuIHJldDsKICAgIH0KfQpjbGFzcyBIQ0FXYXZlU21wbENodW5rIHsKICAgIGNvbnN0cnVjdG9yKGluZm8pIHsKICAgICAgICB0aGlzLnNpemUgPSA2MDsKICAgICAgICB0aGlzLm1hbnVmYWN0dXJlciA9IDA7CiAgICAgICAgdGhpcy5wcm9kdWN0ID0gMDsKICAgICAgICB0aGlzLk1JRElVbml0eU5vdGUgPSAweDNjOwogICAgICAgIHRoaXMuTUlESVBpdGNoRnJhY3Rpb24gPSAwOwogICAgICAgIHRoaXMuU01QVEVGb3JtYXQgPSAwOwogICAgICAgIHRoaXMuc2FtcGxlTG9vcHMgPSAxOwogICAgICAgIHRoaXMuc2FtcGxlckRhdGEgPSAweDE4OwogICAgICAgIHRoaXMubG9vcF9JZGVudGlmaWVyID0gMDsKICAgICAgICB0aGlzLmxvb3BfVHlwZSA9IDA7CiAgICAgICAgdGhpcy5sb29wX0ZyYWN0aW9uID0gMDsKICAgICAgICB0aGlzLmxvb3BfUGxheUNvdW50ID0gMDsKICAgICAgICBpZiAoIWluZm8uaGFzSGVhZGVyWyJsb29wIl0pCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigibWlzc2luZyBcImxvb3BcIiBoZWFkZXIiKTsKICAgICAgICB0aGlzLnNhbXBsZVBlcmlvZCA9ICgxIC8gaW5mby5mb3JtYXQuc2FtcGxpbmdSYXRlICogMTAwMDAwMDAwMCk7CiAgICAgICAgdGhpcy5sb29wX1N0YXJ0ID0gaW5mby5sb29wU3RhcnRBdFNhbXBsZSAtIGluZm8uc3RhcnRBdFNhbXBsZTsKICAgICAgICB0aGlzLmxvb3BfRW5kID0gaW5mby5sb29wRW5kQXRTYW1wbGUgLSBpbmZvLnN0YXJ0QXRTYW1wbGU7CiAgICAgICAgdGhpcy5TTVBURU9mZnNldCA9IDE7CiAgICB9CiAgICBnZXQoKSB7CiAgICAgICAgbGV0IGJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcig4ICsgdGhpcy5zaXplKTsKICAgICAgICBsZXQgcmV0ID0gbmV3IFVpbnQ4QXJyYXkoYnVmKTsKICAgICAgICBsZXQgcCA9IG5ldyBEYXRhVmlldyhidWYpOwogICAgICAgIGxldCB0ZSA9IG5ldyBUZXh0RW5jb2RlcigpOwogICAgICAgIHJldC5zZXQodGUuZW5jb2RlKCJzbXBsIiksIDApOwogICAgICAgIHAuc2V0VWludDMyKDQsIHRoaXMuc2l6ZSwgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MzIoOCwgdGhpcy5tYW51ZmFjdHVyZXIsIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDEyLCB0aGlzLnByb2R1Y3QsIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDE2LCB0aGlzLnNhbXBsZVBlcmlvZCwgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MzIoMjAsIHRoaXMuTUlESVVuaXR5Tm90ZSwgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MzIoMjQsIHRoaXMuTUlESVBpdGNoRnJhY3Rpb24sIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDI4LCB0aGlzLlNNUFRFRm9ybWF0LCB0cnVlKTsKICAgICAgICBwLnNldFVpbnQzMigzMiwgdGhpcy5TTVBURU9mZnNldCwgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MzIoMzYsIHRoaXMuc2FtcGxlTG9vcHMsIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDQwLCB0aGlzLnNhbXBsZXJEYXRhLCB0cnVlKTsKICAgICAgICBwLnNldFVpbnQzMig0NCwgdGhpcy5sb29wX0lkZW50aWZpZXIsIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDQ4LCB0aGlzLmxvb3BfVHlwZSwgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MzIoNTIsIHRoaXMubG9vcF9TdGFydCwgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MzIoNTYsIHRoaXMubG9vcF9FbmQsIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDYwLCB0aGlzLmxvb3BfRnJhY3Rpb24sIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDY0LCB0aGlzLmxvb3BfUGxheUNvdW50LCB0cnVlKTsKICAgICAgICByZXR1cm4gcmV0OwogICAgfQp9CmNsYXNzIEhDQUJpdFJlYWRlciB7CiAgICBnZXQgUmVtYWluaW5nKCkgewogICAgICAgIHJldHVybiB0aGlzLkxlbmd0aEJpdHMgLSB0aGlzLlBvc2l0aW9uOwogICAgfQogICAgY29uc3RydWN0b3IoYnVmZmVyKSB7CiAgICAgICAgdGhpcy5CdWZmZXIgPSBidWZmZXI7CiAgICAgICAgdGhpcy5kdiA9IG5ldyBEYXRhVmlldyhidWZmZXIuYnVmZmVyLCBidWZmZXIuYnl0ZU9mZnNldCwgYnVmZmVyLmJ5dGVMZW5ndGgpOwogICAgICAgIHRoaXMuTGVuZ3RoQml0cyA9IGJ1ZmZlci5sZW5ndGggKiA4OwogICAgICAgIHRoaXMuUG9zaXRpb24gPSAwOwogICAgfQogICAgUmVhZEludChiaXRDb3VudCkgewogICAgICAgIGxldCB2YWx1ZSA9IHRoaXMuUGVla0ludChiaXRDb3VudCk7CiAgICAgICAgdGhpcy5Qb3NpdGlvbiArPSBiaXRDb3VudDsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgICBSZWFkQm9vbCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5SZWFkSW50KDEpID09IDE7CiAgICB9CiAgICBSZWFkT2Zmc2V0QmluYXJ5KGJpdENvdW50LCBiaWFzKSB7CiAgICAgICAgbGV0IG9mZnNldCA9ICgxIDw8IChiaXRDb3VudCAtIDEpKSAtIGJpYXM7CiAgICAgICAgbGV0IHZhbHVlID0gdGhpcy5QZWVrSW50KGJpdENvdW50KSAtIG9mZnNldDsKICAgICAgICB0aGlzLlBvc2l0aW9uICs9IGJpdENvdW50OwogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICAgIEFsaWduUG9zaXRpb24obXVsdGlwbGUpIHsKICAgICAgICB0aGlzLlBvc2l0aW9uID0gSENBVXRpbEZ1bmMuR2V0TmV4dE11bHRpcGxlKHRoaXMuUG9zaXRpb24sIG11bHRpcGxlKTsKICAgIH0KICAgIFBlZWtJbnQoYml0Q291bnQpIHsKICAgICAgICBIQ0FVdGlsRnVuYy5EZWJ1Z0Fzc2VydChiaXRDb3VudCA+PSAwICYmIGJpdENvdW50IDw9IDMyKTsKICAgICAgICBpZiAoYml0Q291bnQgPiB0aGlzLlJlbWFpbmluZykgewogICAgICAgICAgICBpZiAodGhpcy5Qb3NpdGlvbiA+PSB0aGlzLkxlbmd0aEJpdHMpCiAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgbGV0IGV4dHJhQml0cyA9IGJpdENvdW50IC0gdGhpcy5SZW1haW5pbmc7CiAgICAgICAgICAgIHJldHVybiB0aGlzLlBlZWtJbnRGYWxsYmFjayh0aGlzLlJlbWFpbmluZykgPDwgZXh0cmFCaXRzOwogICAgICAgIH0KICAgICAgICBsZXQgYnl0ZUluZGV4ID0gdGhpcy5Qb3NpdGlvbiAvIDg7CiAgICAgICAgbGV0IGJpdEluZGV4ID0gdGhpcy5Qb3NpdGlvbiAlIDg7CiAgICAgICAgaWYgKGJpdENvdW50IDw9IDkgJiYgdGhpcy5SZW1haW5pbmcgPj0gMTYpIHsKICAgICAgICAgICAgbGV0IHZhbHVlID0gdGhpcy5kdi5nZXRVaW50MTYoYnl0ZUluZGV4KTsKICAgICAgICAgICAgdmFsdWUgJj0gMHhGRkZGID4+IGJpdEluZGV4OwogICAgICAgICAgICB2YWx1ZSA+Pj0gMTYgLSBiaXRDb3VudCAtIGJpdEluZGV4OwogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgICAgIGlmIChiaXRDb3VudCA8PSAxNyAmJiB0aGlzLlJlbWFpbmluZyA+PSAyNCkgewogICAgICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLmR2LmdldFVpbnQxNihieXRlSW5kZXgpIDw8IDggfCB0aGlzLmR2LmdldFVpbnQ4KGJ5dGVJbmRleCArIDIpOwogICAgICAgICAgICB2YWx1ZSAmPSAweEZGRkZGRiA+PiBiaXRJbmRleDsKICAgICAgICAgICAgdmFsdWUgPj49IDI0IC0gYml0Q291bnQgLSBiaXRJbmRleDsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgICBpZiAoYml0Q291bnQgPD0gMjUgJiYgdGhpcy5SZW1haW5pbmcgPj0gMzIpIHsKICAgICAgICAgICAgbGV0IHZhbHVlID0gdGhpcy5kdi5nZXRVaW50MzIoYnl0ZUluZGV4KTsKICAgICAgICAgICAgdmFsdWUgJj0gMHhGRkZGRkZGRiA+Pj4gYml0SW5kZXg7CiAgICAgICAgICAgIHZhbHVlID4+PSAzMiAtIGJpdENvdW50IC0gYml0SW5kZXg7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuUGVla0ludEZhbGxiYWNrKGJpdENvdW50KTsKICAgIH0KICAgIFBlZWtJbnRGYWxsYmFjayhiaXRDb3VudCkgewogICAgICAgIGxldCB2YWx1ZSA9IDA7CiAgICAgICAgbGV0IGJ5dGVJbmRleCA9IHRoaXMuUG9zaXRpb24gLyA4OwogICAgICAgIGxldCBiaXRJbmRleCA9IHRoaXMuUG9zaXRpb24gJSA4OwogICAgICAgIHdoaWxlIChiaXRDb3VudCA+IDApIHsKICAgICAgICAgICAgaWYgKGJpdEluZGV4ID49IDgpIHsKICAgICAgICAgICAgICAgIGJpdEluZGV4ID0gMDsKICAgICAgICAgICAgICAgIGJ5dGVJbmRleCsrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxldCBiaXRzVG9SZWFkID0gTWF0aC5taW4oYml0Q291bnQsIDggLSBiaXRJbmRleCk7CiAgICAgICAgICAgIGxldCBtYXNrID0gMHhGRiA+PiBiaXRJbmRleDsKICAgICAgICAgICAgbGV0IGN1cnJlbnRCeXRlID0gKG1hc2sgJiB0aGlzLmR2LmdldFVpbnQ4KGJ5dGVJbmRleCkpID4+ICg4IC0gYml0SW5kZXggLSBiaXRzVG9SZWFkKTsKICAgICAgICAgICAgdmFsdWUgPSAodmFsdWUgPDwgYml0c1RvUmVhZCkgfCBjdXJyZW50Qnl0ZTsKICAgICAgICAgICAgYml0SW5kZXggKz0gYml0c1RvUmVhZDsKICAgICAgICAgICAgYml0Q291bnQgLT0gYml0c1RvUmVhZDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQp9CnZhciBIQ0FPZmZzZXRCaWFzOwooZnVuY3Rpb24gKEhDQU9mZnNldEJpYXMpIHsKICAgIC8vLyA8c3VtbWFyeT4KICAgIC8vLyBTcGVjaWZpZXMgdGhlIGJpYXMgb2YgYW4gb2Zmc2V0IGJpbmFyeSB2YWx1ZS4gQSBwb3NpdGl2ZSBiaWFzIGNhbiByZXByZXNlbnQgb25lIG1vcmUKICAgIC8vLyBwb3NpdGl2ZSB2YWx1ZSB0aGFuIG5lZ2F0aXZlIHZhbHVlLCBhbmQgYSBuZWdhdGl2ZSBiaWFzIGNhbiByZXByZXNlbnQgb25lIG1vcmUKICAgIC8vLyBuZWdhdGl2ZSB2YWx1ZSB0aGFuIHBvc2l0aXZlIHZhbHVlLgogICAgLy8vIDwvc3VtbWFyeT4KICAgIC8vLyA8cmVtYXJrcz5FeGFtcGxlOgogICAgLy8vIEEgNC1iaXQgb2Zmc2V0IGJpbmFyeSB2YWx1ZSB3aXRoIGEgcG9zaXRpdmUgYmlhcyBjYW4gc3RvcmUKICAgIC8vLyB0aGUgdmFsdWVzIDggdGhyb3VnaCAtNyBpbmNsdXNpdmUuCiAgICAvLy8gQSA0LWJpdCBvZmZzZXQgYmluYXJ5IHZhbHVlIHdpdGggYSBuZWdhdGl2ZSBiaWFzIGNhbiBzdG9yZQogICAgLy8vIHRoZSB2YWx1ZXMgNyB0aHJvdWdoIC04IGluY2x1c2l2ZS48L3JlbWFya3M+CiAgICBIQ0FPZmZzZXRCaWFzW0hDQU9mZnNldEJpYXNbIlBvc2l0aXZlIl0gPSAxXSA9ICJQb3NpdGl2ZSI7CiAgICBIQ0FPZmZzZXRCaWFzW0hDQU9mZnNldEJpYXNbIk5lZ2F0aXZlIl0gPSAwXSA9ICJOZWdhdGl2ZSI7Cn0pKEhDQU9mZnNldEJpYXMgfHwgKEhDQU9mZnNldEJpYXMgPSB7fSkpOwpjbGFzcyBIQ0FCaXRXcml0ZXIgewogICAgZ2V0IFJlbWFpbmluZygpIHsgcmV0dXJuIHRoaXMuTGVuZ3RoQml0cyAtIHRoaXMuUG9zaXRpb247IH0KICAgIGNvbnN0cnVjdG9yKGJ1ZmZlcikgewogICAgICAgIHRoaXMuUG9zaXRpb24gPSAwOwogICAgICAgIHRoaXMuQnVmZmVyID0gYnVmZmVyOwogICAgICAgIHRoaXMuZHYgPSBuZXcgRGF0YVZpZXcoYnVmZmVyLmJ1ZmZlciwgYnVmZmVyLmJ5dGVPZmZzZXQsIGJ1ZmZlci5ieXRlTGVuZ3RoKTsKICAgICAgICB0aGlzLkxlbmd0aEJpdHMgPSBidWZmZXIubGVuZ3RoICogODsKICAgIH0KICAgIEFsaWduUG9zaXRpb24obXVsdGlwbGUpIHsKICAgICAgICBsZXQgbmV3UG9zaXRpb24gPSBIQ0FVdGlsRnVuYy5HZXROZXh0TXVsdGlwbGUodGhpcy5Qb3NpdGlvbiwgbXVsdGlwbGUpOwogICAgICAgIGxldCBiaXRzID0gbmV3UG9zaXRpb24gLSB0aGlzLlBvc2l0aW9uOwogICAgICAgIHRoaXMuV3JpdGUoMCwgYml0cyk7CiAgICB9CiAgICBXcml0ZSh2YWx1ZSwgYml0Q291bnQpIHsKICAgICAgICBIQ0FVdGlsRnVuYy5EZWJ1Z0Fzc2VydChiaXRDb3VudCA+PSAwICYmIGJpdENvdW50IDw9IDMyKTsKICAgICAgICBpZiAoYml0Q291bnQgPiB0aGlzLlJlbWFpbmluZykgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk5vdCBlbm91Z2ggYml0cyBsZWZ0IGluIG91dHB1dCBidWZmZXIiKTsKICAgICAgICB9CiAgICAgICAgbGV0IGJ5dGVJbmRleCA9IHRoaXMuUG9zaXRpb24gLyA4OwogICAgICAgIGxldCBiaXRJbmRleCA9IHRoaXMuUG9zaXRpb24gJSA4OwogICAgICAgIGlmIChiaXRDb3VudCA8PSA5ICYmIHRoaXMuUmVtYWluaW5nID49IDE2KSB7CiAgICAgICAgICAgIGxldCBvdXRWYWx1ZSA9ICgodmFsdWUgPDwgKDE2IC0gYml0Q291bnQpKSAmIDB4RkZGRikgPj4gYml0SW5kZXg7CiAgICAgICAgICAgIG91dFZhbHVlIHw9IHRoaXMuZHYuZ2V0VWludDE2KGJ5dGVJbmRleCk7CiAgICAgICAgICAgIHRoaXMuZHYuc2V0VWludDE2KGJ5dGVJbmRleCwgb3V0VmFsdWUpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChiaXRDb3VudCA8PSAxNyAmJiB0aGlzLlJlbWFpbmluZyA+PSAyNCkgewogICAgICAgICAgICBsZXQgb3V0VmFsdWUgPSAoKHZhbHVlIDw8ICgyNCAtIGJpdENvdW50KSkgJiAweEZGRkZGRikgPj4gYml0SW5kZXg7CiAgICAgICAgICAgIG91dFZhbHVlIHw9IHRoaXMuZHYuZ2V0VWludDE2KGJ5dGVJbmRleCkgPDwgOCB8IHRoaXMuZHYuZ2V0VWludDgoYnl0ZUluZGV4ICsgMik7CiAgICAgICAgICAgIHRoaXMuZHYuc2V0VWludDE2KGJ5dGVJbmRleCwgb3V0VmFsdWUgPj4+IDgpOwogICAgICAgICAgICB0aGlzLmR2LnNldFVpbnQ4KGJ5dGVJbmRleCArIDIsIG91dFZhbHVlICYgMHhGRik7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGJpdENvdW50IDw9IDI1ICYmIHRoaXMuUmVtYWluaW5nID49IDMyKSB7CiAgICAgICAgICAgIGxldCBvdXRWYWx1ZSA9ICgoKHZhbHVlIDw8ICgzMiAtIGJpdENvdW50KSkgJiAweEZGRkZGRkZGKSA+Pj4gYml0SW5kZXgpOwogICAgICAgICAgICBvdXRWYWx1ZSB8PSB0aGlzLmR2LmdldFVpbnQzMihieXRlSW5kZXgpOwogICAgICAgICAgICB0aGlzLmR2LnNldFVpbnQzMihieXRlSW5kZXgsIG91dFZhbHVlKTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHRoaXMuV3JpdGVGYWxsYmFjayh2YWx1ZSwgYml0Q291bnQpOwogICAgICAgIH0KICAgICAgICB0aGlzLlBvc2l0aW9uICs9IGJpdENvdW50OwogICAgfQogICAgV3JpdGVGYWxsYmFjayh2YWx1ZSwgYml0Q291bnQpIHsKICAgICAgICBsZXQgYnl0ZUluZGV4ID0gdGhpcy5Qb3NpdGlvbiAvIDg7CiAgICAgICAgbGV0IGJpdEluZGV4ID0gdGhpcy5Qb3NpdGlvbiAlIDg7CiAgICAgICAgd2hpbGUgKGJpdENvdW50ID4gMCkgewogICAgICAgICAgICBpZiAoYml0SW5kZXggPj0gOCkgewogICAgICAgICAgICAgICAgYml0SW5kZXggPSAwOwogICAgICAgICAgICAgICAgYnl0ZUluZGV4Kys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGV0IHRvU2hpZnQgPSA4IC0gYml0SW5kZXggLSBiaXRDb3VudDsKICAgICAgICAgICAgbGV0IHNoaWZ0ZWQgPSB0b1NoaWZ0IDwgMCA/IHZhbHVlID4+PiAtdG9TaGlmdCA6IHZhbHVlIDw8IHRvU2hpZnQ7CiAgICAgICAgICAgIGxldCBiaXRzVG9Xcml0ZSA9IE1hdGgubWluKGJpdENvdW50LCA4IC0gYml0SW5kZXgpOwogICAgICAgICAgICBsZXQgbWFzayA9ICgoMSA8PCBiaXRzVG9Xcml0ZSkgLSAxKSA8PCA4IC0gYml0SW5kZXggLSBiaXRzVG9Xcml0ZTsKICAgICAgICAgICAgbGV0IG91dEJ5dGUgPSB0aGlzLmR2LmdldFVpbnQ4KGJ5dGVJbmRleCkgJiB+bWFzazsKICAgICAgICAgICAgb3V0Qnl0ZSB8PSBzaGlmdGVkICYgbWFzazsKICAgICAgICAgICAgdGhpcy5kdi5zZXRVaW50OChieXRlSW5kZXgsIG91dEJ5dGUpOwogICAgICAgICAgICBiaXRJbmRleCArPSBiaXRzVG9Xcml0ZTsKICAgICAgICAgICAgYml0Q291bnQgLT0gYml0c1RvV3JpdGU7CiAgICAgICAgfQogICAgfQp9CmNsYXNzIEhDQUZyYW1lIHsKICAgIGNvbnN0cnVjdG9yKGhjYSkgewogICAgICAgIHRoaXMuQWNjZXB0YWJsZU5vaXNlTGV2ZWwgPSAwOwogICAgICAgIHRoaXMuRXZhbHVhdGlvbkJvdW5kYXJ5ID0gMDsKICAgICAgICB0aGlzLkhjYSA9IGhjYTsKICAgICAgICBsZXQgY2hhbm5lbFR5cGVzID0gSENBRnJhbWUuR2V0Q2hhbm5lbFR5cGVzKGhjYSk7CiAgICAgICAgdGhpcy5DaGFubmVscyA9IFtdOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaGNhLmZvcm1hdC5jaGFubmVsQ291bnQ7IGkrKykgewogICAgICAgICAgICB0aGlzLkNoYW5uZWxzLnB1c2gobmV3IEhDQUNoYW5uZWwoewogICAgICAgICAgICAgICAgVHlwZTogY2hhbm5lbFR5cGVzW2ldLAogICAgICAgICAgICAgICAgQ29kZWRTY2FsZUZhY3RvckNvdW50OiBjaGFubmVsVHlwZXNbaV0gPT0gSENBQ2hhbm5lbFR5cGUuU3RlcmVvU2Vjb25kYXJ5CiAgICAgICAgICAgICAgICAgICAgPyBoY2EuY29tcERlYy5CYXNlQmFuZENvdW50CiAgICAgICAgICAgICAgICAgICAgOiBoY2EuY29tcERlYy5CYXNlQmFuZENvdW50ICsgaGNhLmNvbXBEZWMuU3RlcmVvQmFuZENvdW50CiAgICAgICAgICAgIH0pKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5BdGhDdXJ2ZSA9IGhjYS5Vc2VBdGhDdXJ2ZSA/IEhDQUZyYW1lLlNjYWxlQXRoQ3VydmUoaGNhLmZvcm1hdC5zYW1wbGluZ1JhdGUpIDogbmV3IFVpbnQ4QXJyYXkoSENBRnJhbWUuU2FtcGxlc1BlclN1YkZyYW1lKTsKICAgIH0KICAgIHN0YXRpYyBHZXRDaGFubmVsVHlwZXMoaGNhKSB7CiAgICAgICAgbGV0IGNoYW5uZWxzUGVyVHJhY2sgPSBoY2EuZm9ybWF0LmNoYW5uZWxDb3VudCAvIGhjYS5jb21wRGVjLlRyYWNrQ291bnQ7CiAgICAgICAgaWYgKGhjYS5jb21wRGVjLlN0ZXJlb0JhbmRDb3VudCA9PSAwIHx8IGNoYW5uZWxzUGVyVHJhY2sgPT0gMSkgewogICAgICAgICAgICByZXR1cm4gbmV3IEFycmF5KDgpLmZpbGwoSENBQ2hhbm5lbFR5cGUpOwogICAgICAgIH0KICAgICAgICBjb25zdCBEaXNjcmV0ZSA9IEhDQUNoYW5uZWxUeXBlLkRpc2NyZXRlOwogICAgICAgIGNvbnN0IFN0ZXJlb1ByaW1hcnkgPSBIQ0FDaGFubmVsVHlwZS5TdGVyZW9QcmltYXJ5OwogICAgICAgIGNvbnN0IFN0ZXJlb1NlY29uZGFyeSA9IEhDQUNoYW5uZWxUeXBlLlN0ZXJlb1NlY29uZGFyeTsKICAgICAgICBzd2l0Y2ggKGNoYW5uZWxzUGVyVHJhY2spIHsKICAgICAgICAgICAgY2FzZSAyOiByZXR1cm4gW1N0ZXJlb1ByaW1hcnksIFN0ZXJlb1NlY29uZGFyeV07CiAgICAgICAgICAgIGNhc2UgMzogcmV0dXJuIFtTdGVyZW9QcmltYXJ5LCBTdGVyZW9TZWNvbmRhcnksIERpc2NyZXRlXTsKICAgICAgICAgICAgY2FzZSA0OiBpZiAoaGNhLmNvbXBEZWMuQ2hhbm5lbENvbmZpZyAhPSAwKQogICAgICAgICAgICAgICAgcmV0dXJuIFtTdGVyZW9QcmltYXJ5LCBTdGVyZW9TZWNvbmRhcnksIERpc2NyZXRlLCBEaXNjcmV0ZV07CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHJldHVybiBbU3RlcmVvUHJpbWFyeSwgU3RlcmVvU2Vjb25kYXJ5LCBTdGVyZW9QcmltYXJ5LCBTdGVyZW9TZWNvbmRhcnldOwogICAgICAgICAgICBjYXNlIDU6IGlmIChoY2EuY29tcERlYy5DaGFubmVsQ29uZmlnID4gMikKICAgICAgICAgICAgICAgIHJldHVybiBbU3RlcmVvUHJpbWFyeSwgU3RlcmVvU2Vjb25kYXJ5LCBEaXNjcmV0ZSwgRGlzY3JldGUsIERpc2NyZXRlXTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgcmV0dXJuIFtTdGVyZW9QcmltYXJ5LCBTdGVyZW9TZWNvbmRhcnksIERpc2NyZXRlLCBTdGVyZW9QcmltYXJ5LCBTdGVyZW9TZWNvbmRhcnldOwogICAgICAgICAgICBjYXNlIDY6IHJldHVybiBbU3RlcmVvUHJpbWFyeSwgU3RlcmVvU2Vjb25kYXJ5LCBEaXNjcmV0ZSwgRGlzY3JldGUsIFN0ZXJlb1ByaW1hcnksIFN0ZXJlb1NlY29uZGFyeV07CiAgICAgICAgICAgIGNhc2UgNzogcmV0dXJuIFtTdGVyZW9QcmltYXJ5LCBTdGVyZW9TZWNvbmRhcnksIERpc2NyZXRlLCBEaXNjcmV0ZSwgU3RlcmVvUHJpbWFyeSwgU3RlcmVvU2Vjb25kYXJ5LCBEaXNjcmV0ZV07CiAgICAgICAgICAgIGNhc2UgODogcmV0dXJuIFtTdGVyZW9QcmltYXJ5LCBTdGVyZW9TZWNvbmRhcnksIERpc2NyZXRlLCBEaXNjcmV0ZSwgU3RlcmVvUHJpbWFyeSwgU3RlcmVvU2Vjb25kYXJ5LCBTdGVyZW9QcmltYXJ5LCBTdGVyZW9TZWNvbmRhcnldOwogICAgICAgICAgICBkZWZhdWx0OiByZXR1cm4gbmV3IEFycmF5KGNoYW5uZWxzUGVyVHJhY2spLmZpbGwoSENBQ2hhbm5lbFR5cGUpOwogICAgICAgIH0KICAgIH0KICAgIC8vLyA8c3VtbWFyeT4KICAgIC8vLyBTY2FsZXMgYW4gQVRIIGN1cnZlIHRvIHRoZSBzcGVjaWZpZWQgZnJlcXVlbmN5LgogICAgLy8vIDwvc3VtbWFyeT4KICAgIC8vLyA8cGFyYW0gbmFtZT0iZnJlcXVlbmN5Ij5UaGUgZnJlcXVlbmN5IHRvIHNjYWxlIHRoZSBjdXJ2ZSB0by48L3BhcmFtPgogICAgLy8vIDxyZXR1cm5zPlRoZSBzY2FsZWQgQVRIIGN1cnZlPC9yZXR1cm5zPgogICAgLy8vIDxyZW1hcmtzPlRoZSBvcmlnaW5hbCBBVEggY3VydmUgaXMgZm9yIGEgZnJlcXVlbmN5IG9mIDQxODU2IEh6LjwvcmVtYXJrcz4KICAgIHN0YXRpYyBTY2FsZUF0aEN1cnZlKGZyZXF1ZW5jeSkgewogICAgICAgIHZhciBhdGggPSBuZXcgVWludDhBcnJheShIQ0FGcmFtZS5TYW1wbGVzUGVyU3ViRnJhbWUpOwogICAgICAgIGxldCBhY2MgPSAwOwogICAgICAgIGxldCBpOwogICAgICAgIGZvciAoaSA9IDA7IGkgPCBhdGgubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgYWNjICs9IGZyZXF1ZW5jeTsKICAgICAgICAgICAgbGV0IGluZGV4ID0gYWNjID4+IDEzOwogICAgICAgICAgICBpZiAoaW5kZXggPj0gSENBVGFibGVzLkF0aEN1cnZlLmxlbmd0aCkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYXRoW2ldID0gSENBVGFibGVzLkF0aEN1cnZlW2luZGV4XTsKICAgICAgICB9CiAgICAgICAgZm9yICg7IGkgPCBhdGgubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgYXRoW2ldID0gMHhmZjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGF0aDsKICAgIH0KfQpfYSA9IEhDQUZyYW1lOwpIQ0FGcmFtZS5TdWJmcmFtZXNQZXJGcmFtZSA9IDg7CkhDQUZyYW1lLlN1YkZyYW1lU2FtcGxlc0JpdHMgPSA3OwpIQ0FGcmFtZS5TYW1wbGVzUGVyU3ViRnJhbWUgPSAxIDw8IF9hLlN1YkZyYW1lU2FtcGxlc0JpdHM7CkhDQUZyYW1lLlNhbXBsZXNQZXJGcmFtZSA9IF9hLlN1YmZyYW1lc1BlckZyYW1lICogX2EuU2FtcGxlc1BlclN1YkZyYW1lOwpjbGFzcyBIQ0FDaGFubmVsIHsKICAgIGNvbnN0cnVjdG9yKHZhbHVlcykgewogICAgICAgIHRoaXMuVHlwZSA9IDA7CiAgICAgICAgdGhpcy5Db2RlZFNjYWxlRmFjdG9yQ291bnQgPSAwOwogICAgICAgIHRoaXMuUGNtRmxvYXQgPSBBcnJheS5mcm9tKHsgbGVuZ3RoOiBIQ0FGcmFtZS5TdWJmcmFtZXNQZXJGcmFtZSB9LCAoKSA9PiBuZXcgRmxvYXQ2NEFycmF5KEhDQUZyYW1lLlNhbXBsZXNQZXJTdWJGcmFtZSkpOwogICAgICAgIHRoaXMuU3BlY3RyYSA9IEFycmF5LmZyb20oeyBsZW5ndGg6IEhDQUZyYW1lLlN1YmZyYW1lc1BlckZyYW1lIH0sICgpID0+IG5ldyBGbG9hdDY0QXJyYXkoSENBRnJhbWUuU2FtcGxlc1BlclN1YkZyYW1lKSk7CiAgICAgICAgdGhpcy5TY2FsZWRTcGVjdHJhID0gQXJyYXkuZnJvbSh7IGxlbmd0aDogSENBRnJhbWUuU2FtcGxlc1BlclN1YkZyYW1lIH0sICgpID0+IG5ldyBGbG9hdDY0QXJyYXkoSENBRnJhbWUuU3ViZnJhbWVzUGVyRnJhbWUpKTsKICAgICAgICB0aGlzLlF1YW50aXplZFNwZWN0cmEgPSBBcnJheS5mcm9tKHsgbGVuZ3RoOiBIQ0FGcmFtZS5TdWJmcmFtZXNQZXJGcmFtZSB9LCAoKSA9PiBuZXcgSW50MzJBcnJheShIQ0FGcmFtZS5TYW1wbGVzUGVyU3ViRnJhbWUpKTsKICAgICAgICB0aGlzLkdhaW4gPSBuZXcgRmxvYXQ2NEFycmF5KEhDQUZyYW1lLlNhbXBsZXNQZXJTdWJGcmFtZSk7CiAgICAgICAgdGhpcy5JbnRlbnNpdHkgPSBuZXcgSW50MzJBcnJheShIQ0FGcmFtZS5TdWJmcmFtZXNQZXJGcmFtZSk7CiAgICAgICAgdGhpcy5IZnJTY2FsZXMgPSBuZXcgSW50MzJBcnJheSg4KTsKICAgICAgICB0aGlzLkhmckdyb3VwQXZlcmFnZVNwZWN0cmEgPSBuZXcgRmxvYXQ2NEFycmF5KDgpOwogICAgICAgIHRoaXMuTWRjdCA9IG5ldyBIQ0FNZGN0KEhDQUZyYW1lLlN1YkZyYW1lU2FtcGxlc0JpdHMsIEhDQVRhYmxlcy5NZGN0V2luZG93LCBNYXRoLnNxcnQoMi4wIC8gSENBRnJhbWUuU2FtcGxlc1BlclN1YkZyYW1lKSk7CiAgICAgICAgdGhpcy5TY2FsZUZhY3RvcnMgPSBuZXcgSW50MzJBcnJheShIQ0FGcmFtZS5TYW1wbGVzUGVyU3ViRnJhbWUpOwogICAgICAgIHRoaXMuUmVzb2x1dGlvbiA9IG5ldyBJbnQzMkFycmF5KEhDQUZyYW1lLlNhbXBsZXNQZXJTdWJGcmFtZSk7CiAgICAgICAgdGhpcy5IZWFkZXJMZW5ndGhCaXRzID0gMDsKICAgICAgICB0aGlzLlNjYWxlRmFjdG9yRGVsdGFCaXRzID0gMDsKICAgICAgICBsZXQgdCA9IHRoaXM7CiAgICAgICAgZm9yIChsZXQga2V5IGluIHZhbHVlcykgewogICAgICAgICAgICB0W2tleV0gPSB2YWx1ZXNba2V5XTsKICAgICAgICB9CiAgICB9Cn0KdmFyIEhDQUNoYW5uZWxUeXBlOwooZnVuY3Rpb24gKEhDQUNoYW5uZWxUeXBlKSB7CiAgICBIQ0FDaGFubmVsVHlwZVtIQ0FDaGFubmVsVHlwZVsiRGlzY3JldGUiXSA9IDBdID0gIkRpc2NyZXRlIjsKICAgIEhDQUNoYW5uZWxUeXBlW0hDQUNoYW5uZWxUeXBlWyJTdGVyZW9QcmltYXJ5Il0gPSAxXSA9ICJTdGVyZW9QcmltYXJ5IjsKICAgIEhDQUNoYW5uZWxUeXBlW0hDQUNoYW5uZWxUeXBlWyJTdGVyZW9TZWNvbmRhcnkiXSA9IDJdID0gIlN0ZXJlb1NlY29uZGFyeSI7Cn0pKEhDQUNoYW5uZWxUeXBlIHx8IChIQ0FDaGFubmVsVHlwZSA9IHt9KSk7CmNsYXNzIEhDQURlY29kZXIgewogICAgc3RhdGljIERlY29kZUZyYW1lKGF1ZGlvLCBmcmFtZSkgewogICAgICAgIGxldCByZWFkZXIgPSBuZXcgSENBQml0UmVhZGVyKGF1ZGlvKTsKICAgICAgICBIQ0FQYWNraW5nLlVucGFja0ZyYW1lKGZyYW1lLCByZWFkZXIpOwogICAgICAgIHRoaXMuRGVxdWFudGl6ZUZyYW1lKGZyYW1lKTsKICAgICAgICB0aGlzLlJlc3RvcmVNaXNzaW5nQmFuZHMoZnJhbWUpOwogICAgICAgIHRoaXMuUnVuSW1kY3QoZnJhbWUpOwogICAgfQogICAgc3RhdGljIERlcXVhbnRpemVGcmFtZShmcmFtZSkgewogICAgICAgIGZvciAobGV0IGNoYW5uZWwgb2YgZnJhbWUuQ2hhbm5lbHMpIHsKICAgICAgICAgICAgdGhpcy5DYWxjdWxhdGVHYWluKGNoYW5uZWwpOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBzZiA9IDA7IHNmIDwgSENBRnJhbWUuU3ViZnJhbWVzUGVyRnJhbWU7IHNmKyspIHsKICAgICAgICAgICAgZm9yIChsZXQgY2hhbm5lbCBvZiBmcmFtZS5DaGFubmVscykgewogICAgICAgICAgICAgICAgZm9yIChsZXQgcyA9IDA7IHMgPCBjaGFubmVsLkNvZGVkU2NhbGVGYWN0b3JDb3VudDsgcysrKSB7CiAgICAgICAgICAgICAgICAgICAgY2hhbm5lbC5TcGVjdHJhW3NmXVtzXSA9IGNoYW5uZWwuUXVhbnRpemVkU3BlY3RyYVtzZl1bc10gKiBjaGFubmVsLkdhaW5bc107CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBzdGF0aWMgUmVzdG9yZU1pc3NpbmdCYW5kcyhmcmFtZSkgewogICAgICAgIHRoaXMuUmVjb25zdHJ1Y3RIaWdoRnJlcXVlbmN5KGZyYW1lKTsKICAgICAgICB0aGlzLkFwcGx5SW50ZW5zaXR5U3RlcmVvKGZyYW1lKTsKICAgIH0KICAgIHN0YXRpYyBDYWxjdWxhdGVHYWluKGNoYW5uZWwpIHsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoYW5uZWwuQ29kZWRTY2FsZUZhY3RvckNvdW50OyBpKyspIHsKICAgICAgICAgICAgY2hhbm5lbC5HYWluW2ldID0gSENBVGFibGVzLkRlcXVhbnRpemVyU2NhbGluZ1RhYmxlW2NoYW5uZWwuU2NhbGVGYWN0b3JzW2ldXSAqIEhDQVRhYmxlcy5RdWFudGl6ZXJTdGVwU2l6ZVtjaGFubmVsLlJlc29sdXRpb25baV1dOwogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBSZWNvbnN0cnVjdEhpZ2hGcmVxdWVuY3koZnJhbWUpIHsKICAgICAgICBsZXQgaGNhID0gZnJhbWUuSGNhOwogICAgICAgIGlmIChoY2EuSGZyR3JvdXBDb3VudCA9PSAwKQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgLy8gVGhlIGxhc3Qgc3BlY3RyYWwgY29lZmZpY2llbnQgc2hvdWxkIGFsd2F5cyBiZSAwOwogICAgICAgIGxldCB0b3RhbEJhbmRDb3VudCA9IE1hdGgubWluKGhjYS5jb21wRGVjLlRvdGFsQmFuZENvdW50LCAxMjcpOwogICAgICAgIGxldCBoZnJTdGFydEJhbmQgPSBoY2EuY29tcERlYy5CYXNlQmFuZENvdW50ICsgaGNhLmNvbXBEZWMuU3RlcmVvQmFuZENvdW50OwogICAgICAgIGxldCBoZnJCYW5kQ291bnQgPSBNYXRoLm1pbihoY2EuY29tcERlYy5IZnJCYW5kQ291bnQsIHRvdGFsQmFuZENvdW50IC0gaGNhLmNvbXBEZWMuSGZyQmFuZENvdW50KTsKICAgICAgICBmb3IgKGxldCBjaGFubmVsIG9mIGZyYW1lLkNoYW5uZWxzKSB7CiAgICAgICAgICAgIGlmIChjaGFubmVsLlR5cGUgPT0gSENBQ2hhbm5lbFR5cGUuU3RlcmVvU2Vjb25kYXJ5KQogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIGZvciAobGV0IGdyb3VwID0gMCwgYmFuZCA9IDA7IGdyb3VwIDwgaGNhLkhmckdyb3VwQ291bnQ7IGdyb3VwKyspIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaGNhLmNvbXBEZWMuQmFuZHNQZXJIZnJHcm91cCAmJiBiYW5kIDwgaGZyQmFuZENvdW50OyBiYW5kKyssIGkrKykgewogICAgICAgICAgICAgICAgICAgIGxldCBoaWdoQmFuZCA9IGhmclN0YXJ0QmFuZCArIGJhbmQ7CiAgICAgICAgICAgICAgICAgICAgbGV0IGxvd0JhbmQgPSBoZnJTdGFydEJhbmQgLSBiYW5kIC0gMTsKICAgICAgICAgICAgICAgICAgICBsZXQgaW5kZXggPSBjaGFubmVsLkhmclNjYWxlc1tncm91cF0gLSBjaGFubmVsLlNjYWxlRmFjdG9yc1tsb3dCYW5kXSArIDY0OwogICAgICAgICAgICAgICAgICAgIGZvciAobGV0IHNmID0gMDsgc2YgPCBIQ0FGcmFtZS5TdWJmcmFtZXNQZXJGcmFtZTsgc2YrKykgewogICAgICAgICAgICAgICAgICAgICAgICBjaGFubmVsLlNwZWN0cmFbc2ZdW2hpZ2hCYW5kXSA9IEhDQVRhYmxlcy5TY2FsZUNvbnZlcnNpb25UYWJsZVtpbmRleF0gKiBjaGFubmVsLlNwZWN0cmFbc2ZdW2xvd0JhbmRdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBBcHBseUludGVuc2l0eVN0ZXJlbyhmcmFtZSkgewogICAgICAgIGlmIChmcmFtZS5IY2EuY29tcERlYy5TdGVyZW9CYW5kQ291bnQgPD0gMCkKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIGZvciAobGV0IGMgPSAwOyBjIDwgZnJhbWUuQ2hhbm5lbHMubGVuZ3RoOyBjKyspIHsKICAgICAgICAgICAgaWYgKGZyYW1lLkNoYW5uZWxzW2NdLlR5cGUgIT0gSENBQ2hhbm5lbFR5cGUuU3RlcmVvUHJpbWFyeSkKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICBmb3IgKGxldCBzZiA9IDA7IHNmIDwgSENBRnJhbWUuU3ViZnJhbWVzUGVyRnJhbWU7IHNmKyspIHsKICAgICAgICAgICAgICAgIGxldCBsID0gZnJhbWUuQ2hhbm5lbHNbY10uU3BlY3RyYVtzZl07CiAgICAgICAgICAgICAgICBsZXQgciA9IGZyYW1lLkNoYW5uZWxzW2MgKyAxXS5TcGVjdHJhW3NmXTsKICAgICAgICAgICAgICAgIGxldCByYXRpb0wgPSBIQ0FUYWJsZXMuSW50ZW5zaXR5UmF0aW9UYWJsZVtmcmFtZS5DaGFubmVsc1tjICsgMV0uSW50ZW5zaXR5W3NmXV07CiAgICAgICAgICAgICAgICBsZXQgcmF0aW9SID0gcmF0aW9MIC0gMi4wOwogICAgICAgICAgICAgICAgZm9yIChsZXQgYiA9IGZyYW1lLkhjYS5jb21wRGVjLkJhc2VCYW5kQ291bnQ7IGIgPCBmcmFtZS5IY2EuY29tcERlYy5Ub3RhbEJhbmRDb3VudDsgYisrKSB7CiAgICAgICAgICAgICAgICAgICAgcltiXSA9IGxbYl0gKiByYXRpb1I7CiAgICAgICAgICAgICAgICAgICAgbFtiXSAqPSByYXRpb0w7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBzdGF0aWMgUnVuSW1kY3QoZnJhbWUpIHsKICAgICAgICBmb3IgKGxldCBzZiA9IDA7IHNmIDwgSENBRnJhbWUuU3ViZnJhbWVzUGVyRnJhbWU7IHNmKyspIHsKICAgICAgICAgICAgZm9yIChsZXQgY2hhbm5lbCBvZiBmcmFtZS5DaGFubmVscykgewogICAgICAgICAgICAgICAgY2hhbm5lbC5NZGN0LlJ1bkltZGN0KGNoYW5uZWwuU3BlY3RyYVtzZl0sIGNoYW5uZWwuUGNtRmxvYXRbc2ZdKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQpjbGFzcyBIQ0FQYWNraW5nIHsKICAgIHN0YXRpYyBVbnBhY2tGcmFtZShmcmFtZSwgcmVhZGVyKSB7CiAgICAgICAgaWYgKCF0aGlzLlVucGFja0ZyYW1lSGVhZGVyKGZyYW1lLCByZWFkZXIpKQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgdGhpcy5SZWFkU3BlY3RyYWxDb2VmZmljaWVudHMoZnJhbWUsIHJlYWRlcik7CiAgICAgICAgcmV0dXJuIHRoaXMuVW5wYWNraW5nV2FzU3VjY2Vzc2Z1bChmcmFtZSwgcmVhZGVyKTsKICAgIH0KICAgIHN0YXRpYyBQYWNrRnJhbWUoZnJhbWUsIG91dEJ1ZmZlcikgewogICAgICAgIHZhciB3cml0ZXIgPSBuZXcgSENBQml0V3JpdGVyKG91dEJ1ZmZlcik7CiAgICAgICAgd3JpdGVyLldyaXRlKDB4ZmZmZiwgMTYpOwogICAgICAgIHdyaXRlci5Xcml0ZShmcmFtZS5BY2NlcHRhYmxlTm9pc2VMZXZlbCwgOSk7CiAgICAgICAgd3JpdGVyLldyaXRlKGZyYW1lLkV2YWx1YXRpb25Cb3VuZGFyeSwgNyk7CiAgICAgICAgZm9yIChsZXQgY2hhbm5lbCBvZiBmcmFtZS5DaGFubmVscykgewogICAgICAgICAgICB0aGlzLldyaXRlU2NhbGVGYWN0b3JzKHdyaXRlciwgY2hhbm5lbCk7CiAgICAgICAgICAgIGlmIChjaGFubmVsLlR5cGUgPT0gSENBQ2hhbm5lbFR5cGUuU3RlcmVvU2Vjb25kYXJ5KSB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IEhDQUZyYW1lLlN1YmZyYW1lc1BlckZyYW1lOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB3cml0ZXIuV3JpdGUoY2hhbm5lbC5JbnRlbnNpdHlbaV0sIDQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKGZyYW1lLkhjYS5IZnJHcm91cENvdW50ID4gMCkgewogICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmcmFtZS5IY2EuSGZyR3JvdXBDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgd3JpdGVyLldyaXRlKGNoYW5uZWwuSGZyU2NhbGVzW2ldLCA2KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBzZiA9IDA7IHNmIDwgSENBRnJhbWUuU3ViZnJhbWVzUGVyRnJhbWU7IHNmKyspIHsKICAgICAgICAgICAgZm9yIChsZXQgY2hhbm5lbCBvZiBmcmFtZS5DaGFubmVscykgewogICAgICAgICAgICAgICAgdGhpcy5Xcml0ZVNwZWN0cmEod3JpdGVyLCBjaGFubmVsLCBzZik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgd3JpdGVyLkFsaWduUG9zaXRpb24oOCk7CiAgICAgICAgZm9yIChsZXQgaSA9IHdyaXRlci5Qb3NpdGlvbiAvIDg7IGkgPCBmcmFtZS5IY2EuYmxvY2tTaXplIC0gMjsgaSsrKSB7CiAgICAgICAgICAgIHdyaXRlci5kdi5zZXRVaW50OChpLCAwKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5Xcml0ZUNoZWNrc3VtKHdyaXRlciwgb3V0QnVmZmVyKTsKICAgIH0KICAgIHN0YXRpYyBDYWxjdWxhdGVSZXNvbHV0aW9uKHNjYWxlRmFjdG9yLCBub2lzZUxldmVsKSB7CiAgICAgICAgaWYgKHNjYWxlRmFjdG9yID09IDApIHsKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQogICAgICAgIGxldCBjdXJ2ZVBvc2l0aW9uID0gbm9pc2VMZXZlbCAtICg1ICogc2NhbGVGYWN0b3IgPj4gMSkgKyAyOwogICAgICAgIGN1cnZlUG9zaXRpb24gPSBIQ0FVdGlsRnVuYy5DbGFtcChjdXJ2ZVBvc2l0aW9uLCAwLCA1OCk7CiAgICAgICAgcmV0dXJuIEhDQVRhYmxlcy5TY2FsZVRvUmVzb2x1dGlvbkN1cnZlW2N1cnZlUG9zaXRpb25dOwogICAgfQogICAgc3RhdGljIFVucGFja0ZyYW1lSGVhZGVyKGZyYW1lLCByZWFkZXIpIHsKICAgICAgICBsZXQgc3luY1dvcmQgPSByZWFkZXIuUmVhZEludCgxNik7CiAgICAgICAgaWYgKHN5bmNXb3JkICE9IDB4ZmZmZikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgZnJhbWUgaGVhZGVyIik7CiAgICAgICAgfQogICAgICAgIGxldCBhdGhDdXJ2ZSA9IGZyYW1lLkF0aEN1cnZlOwogICAgICAgIGZyYW1lLkFjY2VwdGFibGVOb2lzZUxldmVsID0gcmVhZGVyLlJlYWRJbnQoOSk7CiAgICAgICAgZnJhbWUuRXZhbHVhdGlvbkJvdW5kYXJ5ID0gcmVhZGVyLlJlYWRJbnQoNyk7CiAgICAgICAgZm9yIChsZXQgY2hhbm5lbCBvZiBmcmFtZS5DaGFubmVscykgewogICAgICAgICAgICBpZiAoIXRoaXMuUmVhZFNjYWxlRmFjdG9ycyhjaGFubmVsLCByZWFkZXIpKQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZyYW1lLkV2YWx1YXRpb25Cb3VuZGFyeTsgaSsrKSB7CiAgICAgICAgICAgICAgICBjaGFubmVsLlJlc29sdXRpb25baV0gPSB0aGlzLkNhbGN1bGF0ZVJlc29sdXRpb24oY2hhbm5lbC5TY2FsZUZhY3RvcnNbaV0sIGF0aEN1cnZlW2ldICsgZnJhbWUuQWNjZXB0YWJsZU5vaXNlTGV2ZWwgLSAxKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKGxldCBpID0gZnJhbWUuRXZhbHVhdGlvbkJvdW5kYXJ5OyBpIDwgY2hhbm5lbC5Db2RlZFNjYWxlRmFjdG9yQ291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgY2hhbm5lbC5SZXNvbHV0aW9uW2ldID0gdGhpcy5DYWxjdWxhdGVSZXNvbHV0aW9uKGNoYW5uZWwuU2NhbGVGYWN0b3JzW2ldLCBhdGhDdXJ2ZVtpXSArIGZyYW1lLkFjY2VwdGFibGVOb2lzZUxldmVsKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoY2hhbm5lbC5UeXBlID09IEhDQUNoYW5uZWxUeXBlLlN0ZXJlb1NlY29uZGFyeSkgewogICAgICAgICAgICAgICAgdGhpcy5SZWFkSW50ZW5zaXR5KHJlYWRlciwgY2hhbm5lbC5JbnRlbnNpdHkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKGZyYW1lLkhjYS5IZnJHcm91cENvdW50ID4gMCkgewogICAgICAgICAgICAgICAgdGhpcy5SZWFkSGZyU2NhbGVGYWN0b3JzKHJlYWRlciwgZnJhbWUuSGNhLkhmckdyb3VwQ291bnQsIGNoYW5uZWwuSGZyU2NhbGVzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHN0YXRpYyBSZWFkU2NhbGVGYWN0b3JzKGNoYW5uZWwsIHJlYWRlcikgewogICAgICAgIGNoYW5uZWwuU2NhbGVGYWN0b3JEZWx0YUJpdHMgPSByZWFkZXIuUmVhZEludCgzKTsKICAgICAgICBpZiAoY2hhbm5lbC5TY2FsZUZhY3RvckRlbHRhQml0cyA9PSAwKSB7CiAgICAgICAgICAgIGNoYW5uZWwuU2NhbGVGYWN0b3JzLmZpbGwoMCwgMCwgY2hhbm5lbC5TY2FsZUZhY3RvcnMubGVuZ3RoKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGlmIChjaGFubmVsLlNjYWxlRmFjdG9yRGVsdGFCaXRzID49IDYpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGFubmVsLkNvZGVkU2NhbGVGYWN0b3JDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjaGFubmVsLlNjYWxlRmFjdG9yc1tpXSA9IHJlYWRlci5SZWFkSW50KDYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5EZWx0YURlY29kZShyZWFkZXIsIGNoYW5uZWwuU2NhbGVGYWN0b3JEZWx0YUJpdHMsIDYsIGNoYW5uZWwuQ29kZWRTY2FsZUZhY3RvckNvdW50LCBjaGFubmVsLlNjYWxlRmFjdG9ycyk7CiAgICB9CiAgICBzdGF0aWMgUmVhZEludGVuc2l0eShyZWFkZXIsIGludGVuc2l0eSkgewogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgSENBRnJhbWUuU3ViZnJhbWVzUGVyRnJhbWU7IGkrKykgewogICAgICAgICAgICBpbnRlbnNpdHlbaV0gPSByZWFkZXIuUmVhZEludCg0KTsKICAgICAgICB9CiAgICB9CiAgICBzdGF0aWMgUmVhZEhmclNjYWxlRmFjdG9ycyhyZWFkZXIsIGdyb3VwQ291bnQsIGhmclNjYWxlKSB7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBncm91cENvdW50OyBpKyspIHsKICAgICAgICAgICAgaGZyU2NhbGVbaV0gPSByZWFkZXIuUmVhZEludCg2KTsKICAgICAgICB9CiAgICB9CiAgICBzdGF0aWMgUmVhZFNwZWN0cmFsQ29lZmZpY2llbnRzKGZyYW1lLCByZWFkZXIpIHsKICAgICAgICBmb3IgKGxldCBzZiA9IDA7IHNmIDwgSENBRnJhbWUuU3ViZnJhbWVzUGVyRnJhbWU7IHNmKyspIHsKICAgICAgICAgICAgZm9yIChsZXQgY2hhbm5lbCBvZiBmcmFtZS5DaGFubmVscykgewogICAgICAgICAgICAgICAgZm9yIChsZXQgcyA9IDA7IHMgPCBjaGFubmVsLkNvZGVkU2NhbGVGYWN0b3JDb3VudDsgcysrKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IHJlc29sdXRpb24gPSBjaGFubmVsLlJlc29sdXRpb25bc107CiAgICAgICAgICAgICAgICAgICAgbGV0IGJpdHMgPSBIQ0FUYWJsZXMuUXVhbnRpemVkU3BlY3RydW1NYXhCaXRzW3Jlc29sdXRpb25dOwogICAgICAgICAgICAgICAgICAgIGxldCBjb2RlID0gcmVhZGVyLlBlZWtJbnQoYml0cyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc29sdXRpb24gPCA4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJpdHMgPSBIQ0FUYWJsZXMuUXVhbnRpemVkU3BlY3RydW1CaXRzW3Jlc29sdXRpb25dW2NvZGVdOwogICAgICAgICAgICAgICAgICAgICAgICBjaGFubmVsLlF1YW50aXplZFNwZWN0cmFbc2ZdW3NdID0gSENBVGFibGVzLlF1YW50aXplZFNwZWN0cnVtVmFsdWVbcmVzb2x1dGlvbl1bY29kZV07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBSZWFkIHRoZSBzaWduLW1hZ25pdHVkZSB2YWx1ZS4gVGhlIGxvdyBiaXQgaXMgdGhlIHNpZ24KICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHF1YW50aXplZENvZWZmaWNpZW50ID0gKGNvZGUgPj4gMSkgKiAoMSAtIChjb2RlICUgMiAqIDIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHF1YW50aXplZENvZWZmaWNpZW50ID09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpdHMtLTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBjaGFubmVsLlF1YW50aXplZFNwZWN0cmFbc2ZdW3NdID0gcXVhbnRpemVkQ29lZmZpY2llbnQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJlYWRlci5Qb3NpdGlvbiArPSBiaXRzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2hhbm5lbC5TcGVjdHJhW3NmXS5maWxsKDAsIGNoYW5uZWwuQ29kZWRTY2FsZUZhY3RvckNvdW50LCBjaGFubmVsLkNvZGVkU2NhbGVGYWN0b3JDb3VudCArIDB4ODAgLSBjaGFubmVsLkNvZGVkU2NhbGVGYWN0b3JDb3VudCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBzdGF0aWMgRGVsdGFEZWNvZGUocmVhZGVyLCBkZWx0YUJpdHMsIGRhdGFCaXRzLCBjb3VudCwgb3V0cHV0KSB7CiAgICAgICAgb3V0cHV0WzBdID0gcmVhZGVyLlJlYWRJbnQoZGF0YUJpdHMpOwogICAgICAgIGxldCBtYXhEZWx0YSA9IDEgPDwgKGRlbHRhQml0cyAtIDEpOwogICAgICAgIGxldCBtYXhWYWx1ZSA9ICgxIDw8IGRhdGFCaXRzKSAtIDE7CiAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgICAgIGxldCBkZWx0YSA9IHJlYWRlci5SZWFkT2Zmc2V0QmluYXJ5KGRlbHRhQml0cywgSENBT2Zmc2V0Qmlhcy5Qb3NpdGl2ZSk7CiAgICAgICAgICAgIGlmIChkZWx0YSA8IG1heERlbHRhKSB7CiAgICAgICAgICAgICAgICBsZXQgdmFsdWUgPSBvdXRwdXRbaSAtIDFdICsgZGVsdGE7CiAgICAgICAgICAgICAgICBpZiAodmFsdWUgPCAwIHx8IHZhbHVlID4gbWF4VmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBvdXRwdXRbaV0gPSB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIG91dHB1dFtpXSA9IHJlYWRlci5SZWFkSW50KGRhdGFCaXRzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHN0YXRpYyBVbnBhY2tpbmdXYXNTdWNjZXNzZnVsKGZyYW1lLCByZWFkZXIpIHsKICAgICAgICAvLyAxMjggbGVmdG92ZXIgYml0cyBhZnRlciB1bnBhY2tpbmcgc2hvdWxkIGJlIGhpZ2ggZW5vdWdoIHRvIGdldCByaWQgb2YgZmFsc2UgbmVnYXRpdmVzLAogICAgICAgIC8vIGFuZCBsb3cgZW5vdWdoIHRoYXQgZmFsc2UgcG9zaXRpdmVzIHdpbGwgYmUgdW5jb21tb24uCiAgICAgICAgcmV0dXJuIHJlYWRlci5SZW1haW5pbmcgPj0gMTYgJiYgcmVhZGVyLlJlbWFpbmluZyA8PSAxMjgKICAgICAgICAgICAgfHwgdGhpcy5GcmFtZUVtcHR5KGZyYW1lKQogICAgICAgICAgICB8fCBmcmFtZS5BY2NlcHRhYmxlTm9pc2VMZXZlbCA9PSAwICYmIHJlYWRlci5SZW1haW5pbmcgPj0gMTY7CiAgICB9CiAgICBzdGF0aWMgRnJhbWVFbXB0eShmcmFtZSkgewogICAgICAgIGlmIChmcmFtZS5BY2NlcHRhYmxlTm9pc2VMZXZlbCA+IDApCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAvLyBJZiBhbGwgdGhlIHNjYWxlIGZhY3RvcnMgYXJlIDAsIHRoZSBmcmFtZSBpcyBlbXB0eQogICAgICAgIGZvciAobGV0IGNoYW5uZWwgb2YgZnJhbWUuQ2hhbm5lbHMpIHsKICAgICAgICAgICAgaWYgKGNoYW5uZWwuU2NhbGVGYWN0b3JEZWx0YUJpdHMgPiAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBzdGF0aWMgV3JpdGVDaGVja3N1bSh3cml0ZXIsIGhjYUJ1ZmZlcikgewogICAgICAgIHdyaXRlci5Qb3NpdGlvbiA9IHdyaXRlci5MZW5ndGhCaXRzIC0gMTY7CiAgICAgICAgbGV0IGNyYzE2ID0gSENBQ3JjMTYuY2FsYyhoY2FCdWZmZXIsIGhjYUJ1ZmZlci5sZW5ndGggLSAyKTsKICAgICAgICB3cml0ZXIuV3JpdGUoY3JjMTYsIDE2KTsKICAgIH0KICAgIHN0YXRpYyBXcml0ZVNwZWN0cmEod3JpdGVyLCBjaGFubmVsLCBzdWJGcmFtZSkgewogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hhbm5lbC5Db2RlZFNjYWxlRmFjdG9yQ291bnQ7IGkrKykgewogICAgICAgICAgICBsZXQgcmVzb2x1dGlvbiA9IGNoYW5uZWwuUmVzb2x1dGlvbltpXTsKICAgICAgICAgICAgbGV0IHF1YW50aXplZFNwZWN0cmEgPSBjaGFubmVsLlF1YW50aXplZFNwZWN0cmFbc3ViRnJhbWVdW2ldOwogICAgICAgICAgICBpZiAocmVzb2x1dGlvbiA9PSAwKQogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIGlmIChyZXNvbHV0aW9uIDwgOCkgewogICAgICAgICAgICAgICAgbGV0IGJpdHMgPSBIQ0FUYWJsZXMuUXVhbnRpemVTcGVjdHJ1bUJpdHNbcmVzb2x1dGlvbl1bcXVhbnRpemVkU3BlY3RyYSArIDhdOwogICAgICAgICAgICAgICAgd3JpdGVyLldyaXRlKEhDQVRhYmxlcy5RdWFudGl6ZVNwZWN0cnVtVmFsdWVbcmVzb2x1dGlvbl1bcXVhbnRpemVkU3BlY3RyYSArIDhdLCBiaXRzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChyZXNvbHV0aW9uIDwgMTYpIHsKICAgICAgICAgICAgICAgIGxldCBiaXRzID0gSENBVGFibGVzLlF1YW50aXplZFNwZWN0cnVtTWF4Qml0c1tyZXNvbHV0aW9uXSAtIDE7CiAgICAgICAgICAgICAgICB3cml0ZXIuV3JpdGUoTWF0aC5hYnMocXVhbnRpemVkU3BlY3RyYSksIGJpdHMpOwogICAgICAgICAgICAgICAgaWYgKHF1YW50aXplZFNwZWN0cmEgIT0gMCkgewogICAgICAgICAgICAgICAgICAgIHdyaXRlci5Xcml0ZShxdWFudGl6ZWRTcGVjdHJhID4gMCA/IDAgOiAxLCAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBXcml0ZVNjYWxlRmFjdG9ycyh3cml0ZXIsIGNoYW5uZWwpIHsKICAgICAgICBsZXQgZGVsdGFCaXRzID0gY2hhbm5lbC5TY2FsZUZhY3RvckRlbHRhQml0czsKICAgICAgICBsZXQgc2NhbGVzID0gY2hhbm5lbC5TY2FsZUZhY3RvcnM7CiAgICAgICAgd3JpdGVyLldyaXRlKGRlbHRhQml0cywgMyk7CiAgICAgICAgaWYgKGRlbHRhQml0cyA9PSAwKQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgaWYgKGRlbHRhQml0cyA9PSA2KSB7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hhbm5lbC5Db2RlZFNjYWxlRmFjdG9yQ291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgd3JpdGVyLldyaXRlKHNjYWxlc1tpXSwgNik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB3cml0ZXIuV3JpdGUoc2NhbGVzWzBdLCA2KTsKICAgICAgICBsZXQgbWF4RGVsdGEgPSAoMSA8PCAoZGVsdGFCaXRzIC0gMSkpIC0gMTsKICAgICAgICBsZXQgZXNjYXBlVmFsdWUgPSAoMSA8PCBkZWx0YUJpdHMpIC0gMTsKICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IGNoYW5uZWwuQ29kZWRTY2FsZUZhY3RvckNvdW50OyBpKyspIHsKICAgICAgICAgICAgbGV0IGRlbHRhID0gc2NhbGVzW2ldIC0gc2NhbGVzW2kgLSAxXTsKICAgICAgICAgICAgaWYgKE1hdGguYWJzKGRlbHRhKSA+IG1heERlbHRhKSB7CiAgICAgICAgICAgICAgICB3cml0ZXIuV3JpdGUoZXNjYXBlVmFsdWUsIGRlbHRhQml0cyk7CiAgICAgICAgICAgICAgICB3cml0ZXIuV3JpdGUoc2NhbGVzW2ldLCA2KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHdyaXRlci5Xcml0ZShtYXhEZWx0YSArIGRlbHRhLCBkZWx0YUJpdHMpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CmNsYXNzIEhDQU1kY3QgewogICAgY29uc3RydWN0b3IobWRjdEJpdHMsIHdpbmRvdywgc2NhbGUgPSAxKSB7CiAgICAgICAgSENBTWRjdC5TZXRUYWJsZXMobWRjdEJpdHMpOwogICAgICAgIHRoaXMuTWRjdEJpdHMgPSBtZGN0Qml0czsKICAgICAgICB0aGlzLk1kY3RTaXplID0gMSA8PCBtZGN0Qml0czsKICAgICAgICB0aGlzLlNjYWxlID0gc2NhbGU7CiAgICAgICAgaWYgKHdpbmRvdy5sZW5ndGggPCB0aGlzLk1kY3RTaXplKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiV2luZG93IG11c3QgYmUgYXMgbG9uZyBhcyB0aGUgTURDVCBzaXplLiIpOwogICAgICAgIH0KICAgICAgICB0aGlzLl9tZGN0UHJldmlvdXMgPSBuZXcgRmxvYXQ2NEFycmF5KHRoaXMuTWRjdFNpemUpOwogICAgICAgIHRoaXMuX2ltZGN0UHJldmlvdXMgPSBuZXcgRmxvYXQ2NEFycmF5KHRoaXMuTWRjdFNpemUpOwogICAgICAgIHRoaXMuX3NjcmF0Y2hNZGN0ID0gbmV3IEZsb2F0NjRBcnJheSh0aGlzLk1kY3RTaXplKTsKICAgICAgICB0aGlzLl9zY3JhdGNoRGN0ID0gbmV3IEZsb2F0NjRBcnJheSh0aGlzLk1kY3RTaXplKTsKICAgICAgICB0aGlzLl9pbWRjdFdpbmRvdyA9IHdpbmRvdzsKICAgIH0KICAgIHN0YXRpYyBTZXRUYWJsZXMobWF4Qml0cykgewogICAgICAgIGlmIChtYXhCaXRzID4gdGhpcy5fdGFibGVCaXRzKSB7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLl90YWJsZUJpdHMgKyAxOyBpIDw9IG1heEJpdHM7IGkrKykgewogICAgICAgICAgICAgICAgbGV0IG91dCA9IHRoaXMuR2VuZXJhdGVUcmlnVGFibGVzKGkpOwogICAgICAgICAgICAgICAgdGhpcy5TaW5UYWJsZXMucHVzaChvdXQuc2luKTsKICAgICAgICAgICAgICAgIHRoaXMuQ29zVGFibGVzLnB1c2gob3V0LmNvcyk7CiAgICAgICAgICAgICAgICB0aGlzLlNodWZmbGVUYWJsZXMucHVzaCh0aGlzLkdlbmVyYXRlU2h1ZmZsZVRhYmxlKGkpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl90YWJsZUJpdHMgPSBtYXhCaXRzOwogICAgICAgIH0KICAgIH0KICAgIFJ1bk1kY3QoaW5wdXQsIG91dHB1dCkgewogICAgICAgIGlmIChpbnB1dC5sZW5ndGggPCB0aGlzLk1kY3RTaXplKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiSW5wdXQgbXVzdCBiZSBhcyBsb25nIGFzIHRoZSBNRENUIHNpemUuIik7CiAgICAgICAgfQogICAgICAgIGlmIChvdXRwdXQubGVuZ3RoIDwgdGhpcy5NZGN0U2l6ZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk91dHB1dCBtdXN0IGJlIGFzIGxvbmcgYXMgdGhlIE1EQ1Qgc2l6ZS4iKTsKICAgICAgICB9CiAgICAgICAgbGV0IHNpemUgPSB0aGlzLk1kY3RTaXplOwogICAgICAgIGxldCBoYWxmID0gKHNpemUgPj4gMSk7CiAgICAgICAgbGV0IGRjdEluID0gdGhpcy5fc2NyYXRjaE1kY3Q7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBoYWxmOyBpKyspIHsKICAgICAgICAgICAgbGV0IGEgPSB0aGlzLl9pbWRjdFdpbmRvd1toYWxmIC0gaSAtIDFdICogLWlucHV0W2hhbGYgKyBpXTsKICAgICAgICAgICAgbGV0IGIgPSB0aGlzLl9pbWRjdFdpbmRvd1toYWxmICsgaV0gKiBpbnB1dFtoYWxmIC0gaSAtIDFdOwogICAgICAgICAgICBsZXQgYyA9IHRoaXMuX2ltZGN0V2luZG93W2ldICogdGhpcy5fbWRjdFByZXZpb3VzW2ldOwogICAgICAgICAgICBsZXQgZCA9IHRoaXMuX2ltZGN0V2luZG93W3NpemUgLSBpIC0gMV0gKiB0aGlzLl9tZGN0UHJldmlvdXNbc2l6ZSAtIGkgLSAxXTsKICAgICAgICAgICAgZGN0SW5baV0gPSBhIC0gYjsKICAgICAgICAgICAgZGN0SW5baGFsZiArIGldID0gYyAtIGQ7CiAgICAgICAgfQogICAgICAgIHRoaXMuRGN0NChkY3RJbiwgb3V0cHV0KTsKICAgICAgICB0aGlzLl9tZGN0UHJldmlvdXMuc2V0KGlucHV0LCBpbnB1dC5sZW5ndGgpOwogICAgfQogICAgUnVuSW1kY3QoaW5wdXQsIG91dHB1dCkgewogICAgICAgIGlmIChpbnB1dC5sZW5ndGggPCB0aGlzLk1kY3RTaXplKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiSW5wdXQgbXVzdCBiZSBhcyBsb25nIGFzIHRoZSBNRENUIHNpemUuIik7CiAgICAgICAgfQogICAgICAgIGlmIChvdXRwdXQubGVuZ3RoIDwgdGhpcy5NZGN0U2l6ZSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk91dHB1dCBtdXN0IGJlIGFzIGxvbmcgYXMgdGhlIE1EQ1Qgc2l6ZS4iKTsKICAgICAgICB9CiAgICAgICAgbGV0IHNpemUgPSB0aGlzLk1kY3RTaXplOwogICAgICAgIGxldCBoYWxmID0gKHNpemUgPj4gMSk7CiAgICAgICAgbGV0IGRjdE91dCA9IHRoaXMuX3NjcmF0Y2hNZGN0OwogICAgICAgIHRoaXMuRGN0NChpbnB1dCwgZGN0T3V0KTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGhhbGY7IGkrKykgewogICAgICAgICAgICBvdXRwdXRbaV0gPSB0aGlzLl9pbWRjdFdpbmRvd1tpXSAqIGRjdE91dFtpICsgaGFsZl0gKyB0aGlzLl9pbWRjdFByZXZpb3VzW2ldOwogICAgICAgICAgICBvdXRwdXRbaSArIGhhbGZdID0gdGhpcy5faW1kY3RXaW5kb3dbaSArIGhhbGZdICogLWRjdE91dFtzaXplIC0gMSAtIGldIC0gdGhpcy5faW1kY3RQcmV2aW91c1tpICsgaGFsZl07CiAgICAgICAgICAgIHRoaXMuX2ltZGN0UHJldmlvdXNbaV0gPSB0aGlzLl9pbWRjdFdpbmRvd1tzaXplIC0gMSAtIGldICogLWRjdE91dFtoYWxmIC0gaSAtIDFdOwogICAgICAgICAgICB0aGlzLl9pbWRjdFByZXZpb3VzW2kgKyBoYWxmXSA9IHRoaXMuX2ltZGN0V2luZG93W2hhbGYgLSBpIC0gMV0gKiBkY3RPdXRbaV07CiAgICAgICAgfQogICAgfQogICAgLy8vIDxzdW1tYXJ5PgogICAgLy8vIERvZXMgYSBUeXBlLTQgRENULgogICAgLy8vIDwvc3VtbWFyeT4KICAgIC8vLyA8cGFyYW0gbmFtZT0iaW5wdXQiPlRoZSBpbnB1dCBhcnJheSBjb250YWluaW5nIHRoZSB0aW1lIG9yIGZyZXF1ZW5jeS1kb21haW4gc2FtcGxlczwvcGFyYW0+CiAgICAvLy8gPHBhcmFtIG5hbWU9Im91dHB1dCI+VGhlIG91dHB1dCBhcnJheSB0aGF0IHdpbGwgY29udGFpbiB0aGUgdHJhbnNmb3JtZWQgdGltZSBvciBmcmVxdWVuY3ktZG9tYWluIHNhbXBsZXM8L3BhcmFtPgogICAgRGN0NChpbnB1dCwgb3V0cHV0KSB7CiAgICAgICAgbGV0IHNodWZmbGVUYWJsZSA9IEhDQU1kY3QuU2h1ZmZsZVRhYmxlc1t0aGlzLk1kY3RCaXRzXTsKICAgICAgICBsZXQgc2luVGFibGUgPSBIQ0FNZGN0LlNpblRhYmxlc1t0aGlzLk1kY3RCaXRzXTsKICAgICAgICBsZXQgY29zVGFibGUgPSBIQ0FNZGN0LkNvc1RhYmxlc1t0aGlzLk1kY3RCaXRzXTsKICAgICAgICBsZXQgZGN0VGVtcCA9IHRoaXMuX3NjcmF0Y2hEY3Q7CiAgICAgICAgbGV0IHNpemUgPSB0aGlzLk1kY3RTaXplOwogICAgICAgIGxldCBsYXN0SW5kZXggPSBzaXplIC0gMTsKICAgICAgICBsZXQgaGFsZlNpemUgPSAoc2l6ZSA+PiAxKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGhhbGZTaXplOyBpKyspIHsKICAgICAgICAgICAgbGV0IGkyID0gaSAqIDI7CiAgICAgICAgICAgIGxldCBhID0gaW5wdXRbaTJdOwogICAgICAgICAgICBsZXQgYiA9IGlucHV0W2xhc3RJbmRleCAtIGkyXTsKICAgICAgICAgICAgbGV0IHNpbiA9IHNpblRhYmxlW2ldOwogICAgICAgICAgICBsZXQgY29zID0gY29zVGFibGVbaV07CiAgICAgICAgICAgIGRjdFRlbXBbaTJdID0gYSAqIGNvcyArIGIgKiBzaW47CiAgICAgICAgICAgIGRjdFRlbXBbaTIgKyAxXSA9IGEgKiBzaW4gLSBiICogY29zOwogICAgICAgIH0KICAgICAgICBsZXQgc3RhZ2VDb3VudCA9IHRoaXMuTWRjdEJpdHMgLSAxOwogICAgICAgIGZvciAobGV0IHN0YWdlID0gMDsgc3RhZ2UgPCBzdGFnZUNvdW50OyBzdGFnZSsrKSB7CiAgICAgICAgICAgIGxldCBibG9ja0NvdW50ID0gMSA8PCBzdGFnZTsKICAgICAgICAgICAgbGV0IGJsb2NrU2l6ZUJpdHMgPSBzdGFnZUNvdW50IC0gc3RhZ2U7CiAgICAgICAgICAgIGxldCBibG9ja0hhbGZTaXplQml0cyA9IGJsb2NrU2l6ZUJpdHMgLSAxOwogICAgICAgICAgICBsZXQgYmxvY2tTaXplID0gMSA8PCBibG9ja1NpemVCaXRzOwogICAgICAgICAgICBsZXQgYmxvY2tIYWxmU2l6ZSA9IDEgPDwgYmxvY2tIYWxmU2l6ZUJpdHM7CiAgICAgICAgICAgIHNpblRhYmxlID0gSENBTWRjdC5TaW5UYWJsZXNbYmxvY2tIYWxmU2l6ZUJpdHNdOwogICAgICAgICAgICBjb3NUYWJsZSA9IEhDQU1kY3QuQ29zVGFibGVzW2Jsb2NrSGFsZlNpemVCaXRzXTsKICAgICAgICAgICAgZm9yIChsZXQgYmxvY2sgPSAwOyBibG9jayA8IGJsb2NrQ291bnQ7IGJsb2NrKyspIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYmxvY2tIYWxmU2l6ZTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IGZyb250UG9zID0gKGJsb2NrICogYmxvY2tTaXplICsgaSkgKiAyOwogICAgICAgICAgICAgICAgICAgIGxldCBiYWNrUG9zID0gZnJvbnRQb3MgKyBibG9ja1NpemU7CiAgICAgICAgICAgICAgICAgICAgbGV0IGEgPSBkY3RUZW1wW2Zyb250UG9zXSAtIGRjdFRlbXBbYmFja1Bvc107CiAgICAgICAgICAgICAgICAgICAgbGV0IGIgPSBkY3RUZW1wW2Zyb250UG9zICsgMV0gLSBkY3RUZW1wW2JhY2tQb3MgKyAxXTsKICAgICAgICAgICAgICAgICAgICBsZXQgc2luID0gc2luVGFibGVbaV07CiAgICAgICAgICAgICAgICAgICAgbGV0IGNvcyA9IGNvc1RhYmxlW2ldOwogICAgICAgICAgICAgICAgICAgIGRjdFRlbXBbZnJvbnRQb3NdICs9IGRjdFRlbXBbYmFja1Bvc107CiAgICAgICAgICAgICAgICAgICAgZGN0VGVtcFtmcm9udFBvcyArIDFdICs9IGRjdFRlbXBbYmFja1BvcyArIDFdOwogICAgICAgICAgICAgICAgICAgIGRjdFRlbXBbYmFja1Bvc10gPSBhICogY29zICsgYiAqIHNpbjsKICAgICAgICAgICAgICAgICAgICBkY3RUZW1wW2JhY2tQb3MgKyAxXSA9IGEgKiBzaW4gLSBiICogY29zOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5NZGN0U2l6ZTsgaSsrKSB7CiAgICAgICAgICAgIG91dHB1dFtpXSA9IGRjdFRlbXBbc2h1ZmZsZVRhYmxlW2ldXSAqIHRoaXMuU2NhbGU7CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIEdlbmVyYXRlVHJpZ1RhYmxlcyhzaXplQml0cykgewogICAgICAgIGxldCBzaXplID0gMSA8PCBzaXplQml0czsKICAgICAgICBsZXQgb3V0ID0gewogICAgICAgICAgICBzaW46IG5ldyBGbG9hdDY0QXJyYXkoc2l6ZSksCiAgICAgICAgICAgIGNvczogbmV3IEZsb2F0NjRBcnJheShzaXplKQogICAgICAgIH07CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaXplOyBpKyspIHsKICAgICAgICAgICAgbGV0IHZhbHVlID0gTWF0aC5QSSAqICg0ICogaSArIDEpIC8gKDQgKiBzaXplKTsKICAgICAgICAgICAgb3V0LnNpbltpXSA9IE1hdGguc2luKHZhbHVlKTsKICAgICAgICAgICAgb3V0LmNvc1tpXSA9IE1hdGguY29zKHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG91dDsKICAgIH0KICAgIHN0YXRpYyBHZW5lcmF0ZVNodWZmbGVUYWJsZShzaXplQml0cykgewogICAgICAgIGxldCBzaXplID0gMSA8PCBzaXplQml0czsKICAgICAgICB2YXIgdGFibGUgPSBuZXcgSW50MzJBcnJheShzaXplKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNpemU7IGkrKykgewogICAgICAgICAgICB0YWJsZVtpXSA9IEhDQVV0aWxGdW5jLlNpZ25lZEJpdFJldmVyc2UzMlRydW5jKGkgXiAoaSA+PiAxKSwgc2l6ZUJpdHMpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGFibGU7CiAgICB9CiAgICAvLyBSZVNoYXJwZXIgZGlzYWJsZSBvbmNlIFVudXNlZE1lbWJlci5Mb2NhbAogICAgLy8vIDxzdW1tYXJ5PgogICAgLy8vIERvZXMgYSBUeXBlLTQgRENULiBJbnRlbmRlZCBmb3IgcmVmZXJlbmNlLgogICAgLy8vIDwvc3VtbWFyeT4KICAgIC8vLyA8cGFyYW0gbmFtZT0iaW5wdXQiPlRoZSBpbnB1dCBhcnJheSBjb250YWluaW5nIHRoZSB0aW1lIG9yIGZyZXF1ZW5jeS1kb21haW4gc2FtcGxlczwvcGFyYW0+CiAgICAvLy8gPHBhcmFtIG5hbWU9Im91dHB1dCI+VGhlIG91dHB1dCBhcnJheSB0aGF0IHdpbGwgY29udGFpbiB0aGUgdHJhbnNmb3JtZWQgdGltZSBvciBmcmVxdWVuY3ktZG9tYWluIHNhbXBsZXM8L3BhcmFtPgogICAgRGN0NFNsb3coaW5wdXQsIG91dHB1dCkgewogICAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgdGhpcy5NZGN0U2l6ZTsgaysrKSB7CiAgICAgICAgICAgIGxldCBzYW1wbGUgPSAwOwogICAgICAgICAgICBmb3IgKGxldCBuID0gMDsgbiA8IHRoaXMuTWRjdFNpemU7IG4rKykgewogICAgICAgICAgICAgICAgbGV0IGFuZ2xlID0gTWF0aC5QSSAvIHRoaXMuTWRjdFNpemUgKiAoayArIDAuNSkgKiAobiArIDAuNSk7CiAgICAgICAgICAgICAgICBzYW1wbGUgKz0gTWF0aC5jb3MoYW5nbGUpICogaW5wdXRbbl07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgb3V0cHV0W2tdID0gc2FtcGxlICogdGhpcy5TY2FsZTsKICAgICAgICB9CiAgICB9Cn0KSENBTWRjdC5fdGFibGVCaXRzID0gLTE7CkhDQU1kY3QuU2luVGFibGVzID0gW107CkhDQU1kY3QuQ29zVGFibGVzID0gW107CkhDQU1kY3QuU2h1ZmZsZVRhYmxlcyA9IFtdOwpjbGFzcyBIQ0FUYWJsZXMgewogICAgc3RhdGljIGlzTGl0dGxlRW5kaWFuKCkgewogICAgICAgIGxldCB0ZXN0ID0gbmV3IEZsb2F0NjRBcnJheShbMS4wXSk7CiAgICAgICAgbGV0IGR2ID0gbmV3IERhdGFWaWV3KHRlc3QuYnVmZmVyKTsKICAgICAgICBpZiAoZHYuZ2V0VWludDMyKDApICE9IDApCiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHN0YXRpYyBhZGFwdEVuZGlhbm5lc3M2NDMyKGEpIHsKICAgICAgICBpZiAoYS5ieXRlTGVuZ3RoICUgOCAhPSAwKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICBpZiAoIXRoaXMuaXNMaXR0bGVFbmRpYW4oKSkgewogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGEubGVuZ3RoOyBpICs9IDIpIHsKICAgICAgICAgICAgICAgIGxldCB0ZW1wID0gYVtpXTsKICAgICAgICAgICAgICAgIGFbaV0gPSBhW2kgKyAxXTsKICAgICAgICAgICAgICAgIGFbaSArIDFdID0gdGVtcDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gYTsKICAgIH0KfQpfYiA9IEhDQVRhYmxlczsKSENBVGFibGVzLlF1YW50aXplU3BlY3RydW1CaXRzID0gWwogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDIsIDB4MDEsIDB4MDIsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDMsIDB4MDIsIDB4MDIsIDB4MDIsIDB4MDMsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDIsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDQsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDQsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDMsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQKICAgIF0pLApdOwpIQ0FUYWJsZXMuUXVhbnRpemVTcGVjdHJ1bVZhbHVlID0gWwogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDMsIDB4MDAsIDB4MDIsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDcsIDB4MDIsIDB4MDAsIDB4MDEsIDB4MDYsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDcsIDB4MDUsIDB4MDMsIDB4MDAsIDB4MDIsIDB4MDQsIDB4MDYsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MEYsIDB4MDYsIDB4MDQsIDB4MDIsIDB4MDAsIDB4MDEsIDB4MDMsIDB4MDUsIDB4MEUsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MEYsIDB4MEQsIDB4MEIsIDB4MDQsIDB4MDIsIDB4MDAsIDB4MDEsIDB4MDMsIDB4MEEsIDB4MEMsIDB4MEUsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MEYsIDB4MEQsIDB4MEIsIDB4MDksIDB4MDcsIDB4MDIsIDB4MDAsIDB4MDEsIDB4MDYsIDB4MDgsIDB4MEEsIDB4MEMsIDB4MEUsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MEYsIDB4MEQsIDB4MEIsIDB4MDksIDB4MDcsIDB4MDUsIDB4MDMsIDB4MDAsIDB4MDIsIDB4MDQsIDB4MDYsIDB4MDgsIDB4MEEsIDB4MEMsIDB4MEUKICAgIF0pLApdOwpIQ0FUYWJsZXMuUXVhbnRpemVkU3BlY3RydW1CaXRzID0gWwogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDEsIDB4MDEsIDB4MDIsIDB4MDIsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDIsIDB4MDIsIDB4MDIsIDB4MDIsIDB4MDIsIDB4MDIsIDB4MDMsIDB4MDMsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDIsIDB4MDIsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDQsIDB4MDQKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQKICAgIF0pLAogICAgbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgIDB4MDMsIDB4MDMsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDQKICAgIF0pLApdOwpIQ0FUYWJsZXMuUXVhbnRpemVkU3BlY3RydW1NYXhCaXRzID0gbmV3IFVpbnQ4QXJyYXkoWwogICAgMHgwMCwgMHgwMiwgMHgwMywgMHgwMywgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNSwgMHgwNiwgMHgwNywgMHgwOCwgMHgwOSwgMHgwQSwgMHgwQiwgMHgwQwpdKTsKSENBVGFibGVzLlF1YW50aXplZFNwZWN0cnVtVmFsdWUgPSBbCiAgICBuZXcgSW50OEFycmF5KFsKICAgICAgICAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwCiAgICBdKSwKICAgIG5ldyBJbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDEsIDB4RkYsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IEludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMSwgMHgwMSwgMHhGRiwgMHhGRiwgMHgwMiwgMHhGRSwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgSW50OEFycmF5KFsKICAgICAgICAweDAwLCAweDAwLCAweDAxLCAweEZGLCAweDAyLCAweEZFLCAweDAzLCAweEZELCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwCiAgICBdKSwKICAgIG5ldyBJbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDEsIDB4MDEsIDB4RkYsIDB4RkYsIDB4MDIsIDB4MDIsIDB4RkUsIDB4RkUsIDB4MDMsIDB4MDMsIDB4RkQsIDB4RkQsIDB4MDQsIDB4RkMKICAgIF0pLAogICAgbmV3IEludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMSwgMHgwMSwgMHhGRiwgMHhGRiwgMHgwMiwgMHgwMiwgMHhGRSwgMHhGRSwgMHgwMywgMHhGRCwgMHgwNCwgMHhGQywgMHgwNSwgMHhGQgogICAgXSksCiAgICBuZXcgSW50OEFycmF5KFsKICAgICAgICAweDAwLCAweDAwLCAweDAxLCAweDAxLCAweEZGLCAweEZGLCAweDAyLCAweEZFLCAweDAzLCAweEZELCAweDA0LCAweEZDLCAweDA1LCAweEZCLCAweDA2LCAweEZBCiAgICBdKSwKICAgIG5ldyBJbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDEsIDB4RkYsIDB4MDIsIDB4RkUsIDB4MDMsIDB4RkQsIDB4MDQsIDB4RkMsIDB4MDUsIDB4RkIsIDB4MDYsIDB4RkEsIDB4MDcsIDB4RjkKICAgIF0pLApdOwpIQ0FUYWJsZXMuU2NhbGVUb1Jlc29sdXRpb25DdXJ2ZSA9IG5ldyBVaW50OEFycmF5KFsKICAgIDB4MEYsIDB4MEUsIDB4MEUsIDB4MEUsIDB4MEUsIDB4MEUsIDB4MEUsIDB4MEQsIDB4MEQsIDB4MEQsIDB4MEQsIDB4MEQsIDB4MEQsIDB4MEMsIDB4MEMsIDB4MEMsCiAgICAweDBDLCAweDBDLCAweDBDLCAweDBCLCAweDBCLCAweDBCLCAweDBCLCAweDBCLCAweDBCLCAweDBBLCAweDBBLCAweDBBLCAweDBBLCAweDBBLCAweDBBLCAweDBBLAogICAgMHgwOSwgMHgwOSwgMHgwOSwgMHgwOSwgMHgwOSwgMHgwOSwgMHgwOCwgMHgwOCwgMHgwOCwgMHgwOCwgMHgwOCwgMHgwOCwgMHgwNywgMHgwNiwgMHgwNiwgMHgwNSwKICAgIDB4MDQsIDB4MDQsIDB4MDQsIDB4MDMsIDB4MDMsIDB4MDMsIDB4MDIsIDB4MDIsIDB4MDIsIDB4MDIsIDB4MDEKXSk7CkhDQVRhYmxlcy5BdGhDdXJ2ZSA9IG5ldyBVaW50OEFycmF5KFsKICAgIDB4NzgsIDB4NUYsIDB4NTYsIDB4NTEsIDB4NEUsIDB4NEMsIDB4NEIsIDB4NDksIDB4NDgsIDB4NDgsIDB4NDcsIDB4NDYsIDB4NDYsIDB4NDUsIDB4NDUsIDB4NDUsCiAgICAweDQ0LCAweDQ0LCAweDQ0LCAweDQ0LCAweDQzLCAweDQzLCAweDQzLCAweDQzLCAweDQzLCAweDQzLCAweDQyLCAweDQyLCAweDQyLCAweDQyLCAweDQyLCAweDQyLAogICAgMHg0MiwgMHg0MiwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwKICAgIDB4NDAsIDB4NDAsIDB4NDAsIDB4NDAsIDB4NDAsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsCiAgICAweDNGLCAweDNGLCAweDNGLCAweDNFLCAweDNFLCAweDNFLCAweDNFLCAweDNFLCAweDNFLCAweDNELCAweDNELCAweDNELCAweDNELCAweDNELCAweDNELCAweDNELAogICAgMHgzQywgMHgzQywgMHgzQywgMHgzQywgMHgzQywgMHgzQywgMHgzQywgMHgzQywgMHgzQiwgMHgzQiwgMHgzQiwgMHgzQiwgMHgzQiwgMHgzQiwgMHgzQiwgMHgzQiwKICAgIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsCiAgICAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNDLCAweDNDLCAweDNDLCAweDNDLCAweDNDLCAweDNDLCAweDNDLCAweDNDLAogICAgMHgzRCwgMHgzRCwgMHgzRCwgMHgzRCwgMHgzRCwgMHgzRCwgMHgzRCwgMHgzRCwgMHgzRSwgMHgzRSwgMHgzRSwgMHgzRSwgMHgzRSwgMHgzRSwgMHgzRSwgMHgzRiwKICAgIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsCiAgICAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDQwLCAweDQwLCAweDQwLCAweDQwLCAweDQwLCAweDQwLCAweDQwLCAweDQwLCAweDQwLCAweDQwLCAweDQwLCAweDQwLAogICAgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwKICAgIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsCiAgICAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQyLCAweDQyLCAweDQyLCAweDQyLCAweDQyLCAweDQyLCAweDQyLCAweDQyLCAweDQyLAogICAgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MywgMHg0MywgMHg0MywKICAgIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDQsIDB4NDQsCiAgICAweDQ0LCAweDQ0LCAweDQ0LCAweDQ0LCAweDQ0LCAweDQ0LCAweDQ0LCAweDQ0LCAweDQ0LCAweDQ0LCAweDQ0LCAweDQ0LCAweDQ1LCAweDQ1LCAweDQ1LCAweDQ1LAogICAgMHg0NSwgMHg0NSwgMHg0NSwgMHg0NSwgMHg0NSwgMHg0NSwgMHg0NSwgMHg0NSwgMHg0NiwgMHg0NiwgMHg0NiwgMHg0NiwgMHg0NiwgMHg0NiwgMHg0NiwgMHg0NiwKICAgIDB4NDYsIDB4NDYsIDB4NDcsIDB4NDcsIDB4NDcsIDB4NDcsIDB4NDcsIDB4NDcsIDB4NDcsIDB4NDcsIDB4NDcsIDB4NDcsIDB4NDgsIDB4NDgsIDB4NDgsIDB4NDgsCiAgICAweDQ4LCAweDQ4LCAweDQ4LCAweDQ4LCAweDQ5LCAweDQ5LCAweDQ5LCAweDQ5LCAweDQ5LCAweDQ5LCAweDQ5LCAweDQ5LCAweDRBLCAweDRBLCAweDRBLCAweDRBLAogICAgMHg0QSwgMHg0QSwgMHg0QSwgMHg0QSwgMHg0QiwgMHg0QiwgMHg0QiwgMHg0QiwgMHg0QiwgMHg0QiwgMHg0QiwgMHg0QywgMHg0QywgMHg0QywgMHg0QywgMHg0QywKICAgIDB4NEMsIDB4NEQsIDB4NEQsIDB4NEQsIDB4NEQsIDB4NEQsIDB4NEQsIDB4NEUsIDB4NEUsIDB4NEUsIDB4NEUsIDB4NEUsIDB4NEUsIDB4NEYsIDB4NEYsIDB4NEYsCiAgICAweDRGLCAweDRGLCAweDRGLCAweDUwLCAweDUwLCAweDUwLCAweDUwLCAweDUwLCAweDUxLCAweDUxLCAweDUxLCAweDUxLCAweDUxLCAweDUyLCAweDUyLCAweDUyLAogICAgMHg1MiwgMHg1MiwgMHg1MywgMHg1MywgMHg1MywgMHg1MywgMHg1NCwgMHg1NCwgMHg1NCwgMHg1NCwgMHg1NCwgMHg1NSwgMHg1NSwgMHg1NSwgMHg1NSwgMHg1NiwKICAgIDB4NTYsIDB4NTYsIDB4NTYsIDB4NTcsIDB4NTcsIDB4NTcsIDB4NTcsIDB4NTcsIDB4NTgsIDB4NTgsIDB4NTgsIDB4NTksIDB4NTksIDB4NTksIDB4NTksIDB4NUEsCiAgICAweDVBLCAweDVBLCAweDVBLCAweDVCLCAweDVCLCAweDVCLCAweDVCLCAweDVDLCAweDVDLCAweDVDLCAweDVELCAweDVELCAweDVELCAweDVELCAweDVFLCAweDVFLAogICAgMHg1RSwgMHg1RiwgMHg1RiwgMHg1RiwgMHg2MCwgMHg2MCwgMHg2MCwgMHg2MSwgMHg2MSwgMHg2MSwgMHg2MSwgMHg2MiwgMHg2MiwgMHg2MiwgMHg2MywgMHg2MywKICAgIDB4NjMsIDB4NjQsIDB4NjQsIDB4NjQsIDB4NjUsIDB4NjUsIDB4NjYsIDB4NjYsIDB4NjYsIDB4NjcsIDB4NjcsIDB4NjcsIDB4NjgsIDB4NjgsIDB4NjgsIDB4NjksCiAgICAweDY5LCAweDZBLCAweDZBLCAweDZBLCAweDZCLCAweDZCLCAweDZCLCAweDZDLCAweDZDLCAweDZELCAweDZELCAweDZELCAweDZFLCAweDZFLCAweDZGLCAweDZGLAogICAgMHg3MCwgMHg3MCwgMHg3MCwgMHg3MSwgMHg3MSwgMHg3MiwgMHg3MiwgMHg3MywgMHg3MywgMHg3MywgMHg3NCwgMHg3NCwgMHg3NSwgMHg3NSwgMHg3NiwgMHg3NiwKICAgIDB4NzcsIDB4NzcsIDB4NzgsIDB4NzgsIDB4NzgsIDB4NzksIDB4NzksIDB4N0EsIDB4N0EsIDB4N0IsIDB4N0IsIDB4N0MsIDB4N0MsIDB4N0QsIDB4N0QsIDB4N0UsCiAgICAweDdFLCAweDdGLCAweDdGLCAweDgwLCAweDgwLCAweDgxLCAweDgxLCAweDgyLCAweDgzLCAweDgzLCAweDg0LCAweDg0LCAweDg1LCAweDg1LCAweDg2LCAweDg2LAogICAgMHg4NywgMHg4OCwgMHg4OCwgMHg4OSwgMHg4OSwgMHg4QSwgMHg4QSwgMHg4QiwgMHg4QywgMHg4QywgMHg4RCwgMHg4RCwgMHg4RSwgMHg4RiwgMHg4RiwgMHg5MCwKICAgIDB4OTAsIDB4OTEsIDB4OTIsIDB4OTIsIDB4OTMsIDB4OTQsIDB4OTQsIDB4OTUsIDB4OTUsIDB4OTYsIDB4OTcsIDB4OTcsIDB4OTgsIDB4OTksIDB4OTksIDB4OUEsCiAgICAweDlCLCAweDlCLCAweDlDLCAweDlELCAweDlELCAweDlFLCAweDlGLCAweEEwLCAweEEwLCAweEExLCAweEEyLCAweEEyLCAweEEzLCAweEE0LCAweEE1LCAweEE1LAogICAgMHhBNiwgMHhBNywgMHhBNywgMHhBOCwgMHhBOSwgMHhBQSwgMHhBQSwgMHhBQiwgMHhBQywgMHhBRCwgMHhBRSwgMHhBRSwgMHhBRiwgMHhCMCwgMHhCMSwgMHhCMSwKICAgIDB4QjIsIDB4QjMsIDB4QjQsIDB4QjUsIDB4QjYsIDB4QjYsIDB4QjcsIDB4QjgsIDB4QjksIDB4QkEsIDB4QkEsIDB4QkIsIDB4QkMsIDB4QkQsIDB4QkUsIDB4QkYsCiAgICAweEMwLCAweEMxLCAweEMxLCAweEMyLCAweEMzLCAweEM0LCAweEM1LCAweEM2LCAweEM3LCAweEM4LCAweEM5LCAweEM5LCAweENBLCAweENCLCAweENDLCAweENELAogICAgMHhDRSwgMHhDRiwgMHhEMCwgMHhEMSwgMHhEMiwgMHhEMywgMHhENCwgMHhENSwgMHhENiwgMHhENywgMHhEOCwgMHhEOSwgMHhEQSwgMHhEQiwgMHhEQywgMHhERCwKICAgIDB4REUsIDB4REYsIDB4RTAsIDB4RTEsIDB4RTIsIDB4RTMsIDB4RTQsIDB4RTUsIDB4RTYsIDB4RTcsIDB4RTgsIDB4RTksIDB4RUEsIDB4RUIsIDB4RUQsIDB4RUUsCiAgICAweEVGLCAweEYwLCAweEYxLCAweEYyLCAweEYzLCAweEY0LCAweEY1LCAweEY3LCAweEY4LCAweEY5LCAweEZBLCAweEZCLCAweEZDLCAweEZECl0pOwpIQ0FUYWJsZXMuTWRjdFdpbmRvdyA9IG5ldyBGbG9hdDY0QXJyYXkoX2IuYWRhcHRFbmRpYW5uZXNzNjQzMihuZXcgVWludDMyQXJyYXkoWwogICAgMHgwMDAwMDAwMCwgMHgzRjQ2QTA5RSwgMHgwMDAwMDAwMCwgMHgzRjYwMzA3NywgMHgwMDAwMDAwMCwgMHgzRjZFMThBNywgMHgwMDAwMDAwMCwgMHgzRjc3NzI0RCwKICAgIDB4MjAwMDAwMDAsIDB4M0Y4MDk1MDEsIDB4MDAwMDAwMDAsIDB4M0Y4NjEwNDAsIDB4ODAwMDAwMDAsIDB4M0Y4QzI1MDksIDB4RTAwMDAwMDAsIDB4M0Y5MTY3RTIsCiAgICAweDQwMDAwMDAwLCAweDNGOTUwNzMyLCAweEEwMDAwMDAwLCAweDNGOThFRkY3LCAweDAwMDAwMDAwLCAweDNGOUQyMjIyLCAweEEwMDAwMDAwLCAweDNGQTBDRUY5LAogICAgMHg4MDAwMDAwMCwgMHgzRkEzMzFGOCwgMHg4MDAwMDAwMCwgMHgzRkE1QkE2QiwgMHg2MDAwMDAwMCwgMHgzRkE4NjhDOCwgMHgyMDAwMDAwMCwgMHgzRkFCM0Q5OCwKICAgIDB4MDAwMDAwMDAsIDB4M0ZBRTM5NzUsIDB4QzAwMDAwMDAsIDB4M0ZCMEFFODMsIDB4NjAwMDAwMDAsIDB4M0ZCMjU0ODIsIDB4ODAwMDAwMDAsIDB4M0ZCNDBGMTYsCiAgICAweDQwMDAwMDAwLCAweDNGQjVERUE0LCAweEMwMDAwMDAwLCAweDNGQjdDMzkzLCAweDYwMDAwMDAwLCAweDNGQjlCRTRGLCAweEEwMDAwMDAwLCAweDNGQkJDRjQzLAogICAgMHhBMDAwMDAwMCwgMHgzRkJERjZERCwgMHg2MDAwMDAwMCwgMHgzRkMwMUFDNSwgMHg0MDAwMDAwMCwgMHgzRkMxNDVEQiwgMHg0MDAwMDAwMCwgMHgzRkMyN0NFNSwKICAgIDB4MjAwMDAwMDAsIDB4M0ZDM0MwMTYsIDB4NDAwMDAwMDAsIDB4M0ZDNTBGOUUsIDB4QTAwMDAwMDAsIDB4M0ZDNjZCQUEsIDB4MjAwMDAwMDAsIDB4M0ZDN0Q0NjQsCiAgICAweEEwMDAwMDAwLCAweDNGQzk0OUVFLCAweEUwMDAwMDAwLCAweDNGQ0FDQzY3LCAweEUwMDAwMDAwLCAweDNGQ0M1QkU2LCAweDIwMDAwMDAwLCAweDNGQ0RGODdBLAogICAgMHgwMDAwMDAwMCwgMHgzRkNGQTIyNywgMHg0MDAwMDAwMCwgMHgzRkQwQUM3NCwgMHhFMDAwMDAwMCwgMHgzRkQxOEU1NiwgMHgyMDAwMDAwMCwgMHgzRkQyNzZBQywKICAgIDB4RTAwMDAwMDAsIDB4M0ZEMzY1NUQsIDB4RTAwMDAwMDAsIDB4M0ZENDVBNEQsIDB4NjAwMDAwMDAsIDB4M0ZENTU1NTUsIDB4NDAwMDAwMDAsIDB4M0ZENjU2NDQsCiAgICAweEMwMDAwMDAwLCAweDNGRDc1Q0UwLCAweEUwMDAwMDAwLCAweDNGRDg2OEU2LCAweEEwMDAwMDAwLCAweDNGRDk3QTA3LCAweEMwMDAwMDAwLCAweDNGREE4RkU4LAogICAgMHgwMDAwMDAwMCwgMHgzRkRCQUEyNSwgMHg4MDAwMDAwMCwgMHgzRkRDQzg0QiwgMHhFMDAwMDAwMCwgMHgzRkRERTlERiwgMHhFMDAwMDAwMCwgMHgzRkRGMEU1QSwKICAgIDB4MjAwMDAwMDAsIDB4M0ZFMDFBOTUsIDB4NDAwMDAwMDAsIDB4M0ZFMEFFRDksIDB4NjAwMDAwMDAsIDB4M0ZFMTQzQTcsIDB4MDAwMDAwMDAsIDB4M0ZFMUQ4QTksCiAgICAweEEwMDAwMDAwLCAweDNGRTI2RDg0LCAweDQwMDAwMDAwLCAweDNGRTMwMURFLCAweDQwMDAwMDAwLCAweDNGRTM5NTU4LCAweDQwMDAwMDAwLCAweDNGRTQyNzk0LAogICAgMHhBMDAwMDAwMCwgMHgzRkU0QjgzNCwgMHhFMDAwMDAwMCwgMHgzRkU1NDZEQywgMHgwMDAwMDAwMCwgMHgzRkU1RDMzMywgMHhBMDAwMDAwMCwgMHgzRkU2NUNFMCwKICAgIDB4QzAwMDAwMDAsIDB4M0ZFNkUzOTMsIDB4QzAwMDAwMDAsIDB4M0ZFNzY2RkYsIDB4NDAwMDAwMDAsIDB4M0ZFN0U2REUsIDB4MDAwMDAwMDAsIDB4M0ZFODYyRjAsCiAgICAweEMwMDAwMDAwLCAweDNGRThEQUZDLCAweDgwMDAwMDAwLCAweDNGRTk0RUQ0LCAweDgwMDAwMDAwLCAweDNGRTlCRTRGLCAweEUwMDAwMDAwLCAweDNGRUEyOTRELAogICAgMHhBMDAwMDAwMCwgMHgzRkVBOEZCOCwgMHg2MDAwMDAwMCwgMHgzRkVBRjE4MCwgMHhDMDAwMDAwMCwgMHgzRkVCNEU5RCwgMHhFMDAwMDAwMCwgMHgzRkVCQTcxMCwKICAgIDB4RTAwMDAwMDAsIDB4M0ZFQkZBRTAsIDB4NDAwMDAwMDAsIDB4M0ZFQzRBMUIsIDB4MjAwMDAwMDAsIDB4M0ZFQzk0RDMsIDB4MDAwMDAwMDAsIDB4M0ZFQ0RCMjEsCiAgICAweEMwMDAwMDAwLCAweDNGRUQxRDIxLCAweDIwMDAwMDAwLCAweDNGRUQ1QUY2LCAweDIwMDAwMDAwLCAweDNGRUQ5NEMyLCAweDQwMDAwMDAwLCAweDNGRURDQUFDLAogICAgMHhFMDAwMDAwMCwgMHgzRkVERkNEQywgMHhFMDAwMDAwMCwgMHgzRkVFMkI3RCwgMHgyMDAwMDAwMCwgMHgzRkVFNTZCQSwgMHhDMDAwMDAwMCwgMHgzRkVFN0VCQywKICAgIDB4MjAwMDAwMDAsIDB4M0ZFRUEzQjEsIDB4NjAwMDAwMDAsIDB4M0ZFRUM1QzIsIDB4RTAwMDAwMDAsIDB4M0ZFRUU1MUEsIDB4MDAwMDAwMDAsIDB4M0ZFRjAxRTQsCiAgICAweDgwMDAwMDAwLCAweDNGRUYxQzQ2LCAweDgwMDAwMDAwLCAweDNGRUYzNDY5LCAweEUwMDAwMDAwLCAweDNGRUY0QTcyLCAweDIwMDAwMDAwLCAweDNGRUY1RTg3LAogICAgMHgwMDAwMDAwMCwgMHgzRkVGNzBDOSwgMHhDMDAwMDAwMCwgMHgzRkVGODE1OSwgMHgwMDAwMDAwMCwgMHgzRkVGOTA1OSwgMHhDMDAwMDAwMCwgMHgzRkVGOURFNCwKICAgIDB4NjAwMDAwMDAsIDB4M0ZFRkFBMTksIDB4QzAwMDAwMDAsIDB4M0ZFRkI1MTEsIDB4RTAwMDAwMDAsIDB4M0ZFRkJFRTYsIDB4QzAwMDAwMDAsIDB4M0ZFRkM3QjAsCiAgICAweDQwMDAwMDAwLCAweDNGRUZDRjg1LCAweDgwMDAwMDAwLCAweDNGRUZENjc5LCAweEUwMDAwMDAwLCAweDNGRUZEQ0EwLCAweDgwMDAwMDAwLCAweDNGRUZFMjBELAogICAgMHg2MDAwMDAwMCwgMHgzRkVGRTZEMCwgMHg0MDAwMDAwMCwgMHgzRkVGRUFGOSwgMHhDMDAwMDAwMCwgMHgzRkVGRUU5NiwgMHhDMDAwMDAwMCwgMHgzRkVGRjFCNiwKICAgIDB4QzAwMDAwMDAsIDB4M0ZFRkY0NjUsIDB4NjAwMDAwMDAsIDB4M0ZFRkY2QUYsIDB4QzAwMDAwMDAsIDB4M0ZFRkY4OUUsIDB4QTAwMDAwMDAsIDB4M0ZFRkZBM0QsCiAgICAweEEwMDAwMDAwLCAweDNGRUZGQjk1LCAweDIwMDAwMDAwLCAweDNGRUZGQ0FGLCAweDAwMDAwMDAwLCAweDNGRUZGRDkyLCAweEMwMDAwMDAwLCAweDNGRUZGRTQ1LAogICAgMHgwMDAwMDAwMCwgMHgzRkVGRkVEMSwgMHgwMDAwMDAwMCwgMHgzRkVGRkYzQSwgMHg0MDAwMDAwMCwgMHgzRkVGRkY4NiwgMHg0MDAwMDAwMCwgMHgzRkVGRkZCQiwKICAgIDB4QTAwMDAwMDAsIDB4M0ZFRkZGREQsIDB4RTAwMDAwMDAsIDB4M0ZFRkZGRjEsIDB4RTAwMDAwMDAsIDB4M0ZFRkZGRkIsIDB4ODAwMDAwMDAsIDB4M0ZFRkZGRkYKXSkpLmJ1ZmZlcik7CkhDQVRhYmxlcy5EZWZhdWx0Q2hhbm5lbE1hcHBpbmcgPSBuZXcgVWludDhBcnJheShbCiAgICAweDAwLCAweDAxLCAweDAwLCAweDA0LCAweDAwLCAweDAxLCAweDAzLCAweDA3LCAweDAzCl0pOwpIQ0FUYWJsZXMuVmFsaWRDaGFubmVsTWFwcGluZ3MgPSBbCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMSwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMSwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMSwgMHgwMSwgMHgwMCwgMHgwMSwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMSwgMHgwMCwgMHgwMCwgMHgwMSwgMHgwMCwgMHgwMSwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMSwgMHgwMSwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMQogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMSwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMQogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMSwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCl07CkhDQVRhYmxlcy5EZXF1YW50aXplclNjYWxpbmdUYWJsZSA9IG5ldyBGbG9hdDY0QXJyYXkoX2IuYWRhcHRFbmRpYW5uZXNzNjQzMihuZXcgVWludDMyQXJyYXkoWwogICAgMHhDQTVEOTIwMSwgMHgzRTg1NTFBNCwgMHgyRTU3RDEzOSwgMHgzRThDNjdGMSwgMHhBOTNFMkY0QSwgMHgzRTkyRUNBRiwgMHhCMENEQzVENSwgMHgzRTk5MzczNywKICAgIDB4MkI3MjQ3RUQsIDB4M0VBMENDOTIsIDB4ODI1NTIyMTcsIDB4M0VBNjYyMzgsIDB4RjMwMUI0NEYsIDB4M0VBREQzMjEsIDB4NEMxMjM0MTYsIDB4M0VCM0RFQTYsCiAgICAweDEzMzBCMzQ5LCAweDNFQkE3OTlFLCAweEVCNkZDQjZDLCAweDNFQzFBMzVCLCAweDRGREU1RDMzLCAweDNFQzc4MDY5LCAweDVCNkU0NTJGLCAweDNFQ0Y1MDc2LAogICAgMHg5OUZEREQwMywgMHgzRUQ0RENCMiwgMHg5MDRCQzFDMywgMHgzRURCQ0MxRSwgMHhFMUY1NjM3OCwgMHgzRUUyODRERiwgMHg0MjJBQTBDRiwgMHgzRUU4QUNFNSwKICAgIDB4MjlEREY2RDYsIDB4M0VGMDcwNkIsIDB4MTVBRDIxM0UsIDB4M0VGNUU3NkYsIDB4MDgwRDg5RTMsIDB4M0VGRDJGODcsIDB4MzczQUE5QzIsIDB4M0YwMzcxQTcsCiAgICAweDE5RTMyMzE4LCAweDNGMDlFODYzLCAweEFFQTkyREQ4LCAweDNGMTE0MjlBLCAweEY5NTE5NDdCLCAweDNGMTZGRjdELCAweEEyQTQ5MENELCAweDNGMUVBNEFGLAogICAgMHhFRDFEMDA1MCwgMHgzRjI0NkE0MSwgMHhCODRGMTVGMCwgMHgzRjJCMzNBMiwgMHg5MTdEREM5MCwgMHgzRjMyMUY0OSwgMHg5OTRDQ0UwQSwgMHgzRjM4MjU4OSwKICAgIDB4QTlGQjMzMkYsIDB4M0Y0MDE2M0QsIDB4MzZCNTI3RDMsIDB4M0Y0NTZGNDcsIDB4OTQwNkU3QUMsIDB4M0Y0QzhGNkQsIDB4MEEzMUI3MEYsIDB4M0Y1MzA2RkUsCiAgICAweENCQzg1MjA3LCAweDNGNTk1QTQ0LCAweDMyRDNEMTlELCAweDNGNjBFM0VDLCAweEQ0NENBOTZDLCAweDNGNjY4MTU1LCAweDMzN0I5QjU2LCAweDNGNkRGQzk3LAogICAgMHgwNEFDODAxNiwgMHgzRjczRkE0NSwgMHg1NTc5RkRCOCwgMHgzRjdBOUU2QiwgMHg4NDA0NUNDRiwgMHgzRjgxQkJFMCwgMHg3M0VCMDE4MSwgMHgzRjg3QTExNCwKICAgIDB4QUQ5Q0JFMEMsIDB4M0Y4RjdCRkQsIDB4NzY5RDJDQTIsIDB4M0Y5NEY5QjIsIDB4NUJENzFFMDMsIDB4M0Y5QkYyQzIsIDB4RjUxRkRFREUsIDB4M0ZBMjlFOUQsCiAgICAweDE2QjU0NDg3LCAweDNGQThDRjMyLCAweDE4NzU5QkM1LCAweDNGQjA4NzQ1LCAweEI5NzZEQzA1LCAweDNGQjYwNUUxLCAweERDRkJBNDgzLCAweDNGQkQ1ODE4LAogICAgMHg2RDA1RDg2MywgMHgzRkMzOENBRSwgMHg3QjVERTU2MSwgMHgzRkNBMEM2NiwgMHhDOEE1OEU0RiwgMHgzRkQxNUE5OCwgMHhFOEVDNUY3MSwgMHgzRkQ3MUY3NSwKICAgIDB4MkQ4RTY3RUQsIDB4M0ZERUNGNDgsIDB4QjVDMTNDQ0UsIDB4M0ZFNDg2QTIsIDB4OERFNTU5MzgsIDB4M0ZFQjU5NzIsIDB4NkU3NTYyMzcsIDB4M0ZGMjM4N0EsCiAgICAweDQ2MjNDN0FDLCAweDNGRjg0NzFBLCAweDNFNzc4MDYwLCAweDQwMDAyQzlBLCAweEQ0OTdDN0ZELCAweDQwMDU4RDEyLCAweERDRUY5MDY4LCAweDQwMENCNzIwLAogICAgMHhGQzRDRDgzMSwgMHg0MDEzMjE3MCwgMHg5RkRFNEU1MCwgMHg0MDE5N0Q4MiwgMHhBRkZFRDMxQiwgMHg0MDIwRkI2NiwgMHg2NjdGM0JDRCwgMHg0MDI2QTA5RQpdKSkuYnVmZmVyKTsKSENBVGFibGVzLlF1YW50aXplclN0ZXBTaXplID0gbmV3IEZsb2F0NjRBcnJheShfYi5hZGFwdEVuZGlhbm5lc3M2NDMyKG5ldyBVaW50MzJBcnJheShbCiAgICAweDAwMDAwMDAwLCAweDAwMDAwMDAwLCAweDU1NTU1NTU1LCAweDNGRTU1NTU1LCAweDk5OTk5OTlBLCAweDNGRDk5OTk5LCAweDkyNDkyNDkyLCAweDNGRDI0OTI0LAogICAgMHgxQzcxQzcxQywgMHgzRkNDNzFDNywgMHg3NDVEMTc0NiwgMHgzRkM3NDVEMSwgMHgxM0IxM0IxNCwgMHgzRkMzQjEzQiwgMHgxMTExMTExMSwgMHgzRkMxMTExMSwKICAgIDB4MDg0MjEwODQsIDB4M0ZCMDg0MjEsIDB4MTA0MTA0MTAsIDB4M0ZBMDQxMDQsIDB4ODEwMjA0MDgsIDB4M0Y5MDIwNDAsIDB4MTAxMDEwMTAsIDB4M0Y4MDEwMTAsCiAgICAweDAyMDEwMDgwLCAweDNGNzAwODA0LCAweDAwNDAxMDA0LCAweDNGNjAwNDAxLCAweDQwMDgwMTAwLCAweDNGNTAwMjAwLCAweDEwMDEwMDEwLCAweDNGNDAwMTAwCl0pKS5idWZmZXIpOwpIQ0FUYWJsZXMuUXVhbnRpemVyRGVhZFpvbmUgPSBuZXcgRmxvYXQ2NEFycmF5KF9iLmFkYXB0RW5kaWFubmVzczY0MzIobmV3IFVpbnQzMkFycmF5KFsKICAgIDB4RkZGRkZGRkYsIDB4RkZGRkZGRkYsIDB4NTU1NTU1NTMsIDB4M0ZENTU1NTUsIDB4OTk5OTk5OTcsIDB4M0ZDOTk5OTksIDB4OTI0OTI0OEUsIDB4M0ZDMjQ5MjQsCiAgICAweDFDNzFDNzE3LCAweDNGQkM3MUM3LCAweDc0NUQxNzQwLCAweDNGQjc0NUQxLCAweDEzQjEzQjBELCAweDNGQjNCMTNCLCAweDExMTExMTA5LCAweDNGQjExMTExLAogICAgMHgwODQyMTA3NCwgMHgzRkEwODQyMSwgMHgxMDQxMDNGMCwgMHgzRjkwNDEwNCwgMHg4MTAyMDNDOCwgMHgzRjgwMjA0MCwgMHgxMDEwMEY5MCwgMHgzRjcwMTAxMCwKICAgIDB4MDIwMEZGODAsIDB4M0Y2MDA4MDQsIDB4MDA0MDBFMDQsIDB4M0Y1MDA0MDEsIDB4NDAwN0ZEMDAsIDB4M0Y0MDAyMDAsIDB4MTAwMEY4MTAsIDB4M0YzMDAxMDAKXSkpLmJ1ZmZlcik7CkhDQVRhYmxlcy5RdWFudGl6ZXJTY2FsaW5nVGFibGUgPSBuZXcgRmxvYXQ2NEFycmF5KF9iLmFkYXB0RW5kaWFubmVzczY0MzIobmV3IFVpbnQzMkFycmF5KFsKICAgIDB4NTQzRTFBMjEsIDB4NDE1ODA0MjcsIDB4ODg2MjhDRTIsIDB4NDE1MjA2M0IsIDB4Mjk4REI2NzcsIDB4NDE0QjBFMDcsIDB4NjA2MTg5M0EsIDB4NDE0NDRFMDgsCiAgICAweEZCQzc0Qzk2LCAweDQxM0U3QTUxLCAweDNDNjUxQTNELCAweDQxMzZERkIyLCAweEMwNkMzMUQ2LCAweDQxMzEyQUJELCAweDgyQTNGMEEwLCAweDQxMjlDNDkxLAogICAgMHg1RjkyOUZGQywgMHg0MTIzNTZDNSwgMHg0QTA3ODk4QiwgMHg0MTFEMDcyRCwgMHg4QTU5NDZDMiwgMHg0MTE1QzkyNiwgMHhEMzE1ODU3RCwgMHg0MTEwNTlCMCwKICAgIDB4RDk4QTY2QTYsIDB4NDEwODhBQzcsIDB4NjVFMjdDRTcsIDB4NDEwMjZCNDUsIDB4MzBBMTA2NTYsIDB4NDBGQkE1QjAsIDB4RDUzNjJBMzIsIDB4NDBGNEJGREEsCiAgICAweDM3NkJCQUE2LCAweDQwRUYyNTJCLCAweDU2NDI2N0Q0LCAweDQwRTc1RkVCLCAweDM4OEM4REYyLCAweDQwRTE4QUY5LCAweEIyM0UyNTY4LCAweDQwREE1NTAzLAogICAgMHhDMzEzQThFRCwgMHg0MEQzQzMyRCwgMHgwM0RCMzI5MywgMHg0MENEQTlFNiwgMHgzNENDQzMyOCwgMHg0MEM2NDM0NiwgMHg2Q0Y5ODkxNiwgMHg0MEMwQjU1OCwKICAgIDB4MEI5MUZGQ0YsIDB4NDBCOTE0NUIsIDB4QTZFNDAzMTMsIDB4NDBCMkQyODUsIDB4NUZGRkQwODQsIDB4NDBBQzQwQUIsIDB4NTY5RDRGODksIDB4NDBBNTM0MkIsCiAgICAweDJCOEY3MUZFLCAweDQwOUZEM0MyLCAweDM2Q0Y0RTZBLCAweDQwOTdFMkYzLCAweDIyRkNEOTIyLCAweDQwOTFFRDUwLCAweDk5NUFEM0I2LCAweDQwOEFFODlGLAogICAgMHhEOTUwQTg5RCwgMHg0MDg0MzFGNSwgMHhFNzhCM0ZGRiwgMHg0MDdFNTAyRSwgMHg3NTBCREFDNiwgMHg0MDc2QzAxMiwgMHhEMDEyNUI1NiwgMHg0MDcxMTMwMSwKICAgIDB4NzBDQTA3QzEsIDB4NDA2OUEwRjEsIDB4QjI2NDE3MDUsIDB4NDA2MzNDMDgsIDB4NTU1REM0MDEsIDB4NDA1Q0RGMEIsIDB4REQ0ODU0MkYsIDB4NDA1NUFCMDcsCiAgICAweEU4NkU3Rjg5LCAweDQwNTA0MzE1LCAweDlCNDQ5MkYyLCAweDQwNDg2OEQ5LCAweDRGQjJBNjQzLCAweDQwNDI1MUNFLCAweEYyRkI1RTRDLCAweDQwM0I3Rjc2LAogICAgMHhGMEQ3RDNFMywgMHg0MDM0QTMyQSwgMHhFRTYxNUEyRCwgMHg0MDJFRkExQiwgMHg0OEE1ODE3OCwgMHg0MDI3M0Y5QSwgMHgzQzdENTE3RCwgMHg0MDIxNzJCOCwKICAgIDB4RUM0QTJEMzcsIDB4NDAxQTMwOUIsIDB4MzRFNTlGRkEsIDB4NDAxM0E3REIsIDB4MTZDOTgzOUIsIDB4NDAwRDgwRTMsIDB4QjAzQTU1ODcsIDB4NDAwNjI0N0UsCiAgICAweENBQzZGMzg1LCAweDQwMDA5RTNFLCAweDk5MTU3NzM5LCAweDNGRjhGMUFFLCAweEQwREFEOTkxLCAweDNGRjJCODdGLCAweEREODU1MjlFLCAweDNGRUMxOTlCLAogICAgMHhBMkNGNjY0MiwgMHgzRkU1MTZEQSwgMHg4MTlFOTBEQSwgMHgzRkRGQTdDMSwgMHgwMTMwQzEzMywgMHgzRkQ3QzFFRCwgMHgzMTY4QjlBQiwgMHgzRkQxRDQ4NywKICAgIDB4QkZEM0YzN0EsIDB4M0ZDQUMzNkIsIDB4MjFGNzJFMkEsIDB4M0ZDNDE2MEEsIDB4MTRGNUExMjksIDB4M0ZCRTI2NDYsIDB4NjY3RjNCQ0MsIDB4M0ZCNkEwOUUKXSkpLmJ1ZmZlcik7CkhDQVRhYmxlcy5RdWFudGl6ZXJJbnZlcnNlU3RlcFNpemUgPSBuZXcgRmxvYXQ2NEFycmF5KF9iLmFkYXB0RW5kaWFubmVzczY0MzIobmV3IFVpbnQzMkFycmF5KFsKICAgIDB4MDAwMDAwMDAsIDB4M0ZFMDAwMDAsIDB4MDAwMDAwMDAsIDB4M0ZGODAwMDAsIDB4MDAwMDAwMDAsIDB4NDAwNDAwMDAsIDB4MDAwMDAwMDAsIDB4NDAwQzAwMDAsCiAgICAweDAwMDAwMDAwLCAweDQwMTIwMDAwLCAweDAwMDAwMDAwLCAweDQwMTYwMDAwLCAweDAwMDAwMDAwLCAweDQwMUEwMDAwLCAweDAwMDAwMDAwLCAweDQwMUUwMDAwLAogICAgMHgwMDAwMDAwMCwgMHg0MDJGMDAwMCwgMHgwMDAwMDAwMCwgMHg0MDNGODAwMCwgMHgwMDAwMDAwMCwgMHg0MDRGQzAwMCwgMHgwMDAwMDAwMCwgMHg0MDVGRTAwMCwKICAgIDB4MDAwMDAwMDAsIDB4NDA2RkYwMDAsIDB4MDAwMDAwMDAsIDB4NDA3RkY4MDAsIDB4MDAwMDAwMDAsIDB4NDA4RkZDMDAsIDB4MDAwMDAwMDAsIDB4NDA5RkZFMDAKXSkpLmJ1ZmZlcik7CkhDQVRhYmxlcy5SZXNvbHV0aW9uTWF4VmFsdWVzID0gbmV3IEludDMyQXJyYXkoWwogICAgMHgwMDAwMDAwMCwgMHgwMDAwMDAwMSwgMHgwMDAwMDAwMiwgMHgwMDAwMDAwMywgMHgwMDAwMDAwNCwgMHgwMDAwMDAwNSwgMHgwMDAwMDAwNiwgMHgwMDAwMDAwNywKICAgIDB4MDAwMDAwMEYsIDB4MDAwMDAwMUYsIDB4MDAwMDAwM0YsIDB4MDAwMDAwN0YsIDB4MDAwMDAwRkYsIDB4MDAwMDAxRkYsIDB4MDAwMDAzRkYsIDB4MDAwMDA3RkYKXSk7CkhDQVRhYmxlcy5JbnRlbnNpdHlSYXRpb1RhYmxlID0gbmV3IEZsb2F0NjRBcnJheShfYi5hZGFwdEVuZGlhbm5lc3M2NDMyKG5ldyBVaW50MzJBcnJheShbCiAgICAweDAwMDAwMDAwLCAweDQwMDAwMDAwLCAweDZEQjZEQjZFLCAweDNGRkRCNkRCLCAweERCNkRCNkRCLCAweDNGRkI2REI2LCAweDQ5MjQ5MjQ5LCAweDNGRjkyNDkyLAogICAgMHhCNkRCNkRCNywgMHgzRkY2REI2RCwgMHgyNDkyNDkyNSwgMHgzRkY0OTI0OSwgMHg5MjQ5MjQ5MiwgMHgzRkYyNDkyNCwgMHgwMDAwMDAwMCwgMHgzRkYwMDAwMCwKICAgIDB4REI2REI2REIsIDB4M0ZFQjZEQjYsIDB4QjZEQjZEQjcsIDB4M0ZFNkRCNkQsIDB4OTI0OTI0OTIsIDB4M0ZFMjQ5MjQsIDB4REI2REI2REIsIDB4M0ZEQjZEQjYsCiAgICAweDkyNDkyNDkyLCAweDNGRDI0OTI0LCAweDkyNDkyNDkyLCAweDNGQzI0OTI0LCAweDAwMDAwMDAwLCAweDAwMDAwMDAwCl0pKS5idWZmZXIpOwpIQ0FUYWJsZXMuSW50ZW5zaXR5UmF0aW9Cb3VuZHNUYWJsZSA9IG5ldyBGbG9hdDY0QXJyYXkoX2IuYWRhcHRFbmRpYW5uZXNzNjQzMihuZXcgVWludDMyQXJyYXkoWwogICAgMHhCNkRCNkRCNywgMHgzRkZFREI2RCwgMHgyNDkyNDkyNSwgMHgzRkZDOTI0OSwgMHg5MjQ5MjQ5MiwgMHgzRkZBNDkyNCwgMHgwMDAwMDAwMCwgMHgzRkY4MDAwMCwKICAgIDB4NkRCNkRCNkUsIDB4M0ZGNUI2REIsIDB4REI2REI2REIsIDB4M0ZGMzZEQjYsIDB4NDkyNDkyNDksIDB4M0ZGMTI0OTIsIDB4NkRCNkRCNkUsIDB4M0ZFREI2REIsCiAgICAweDQ5MjQ5MjQ5LCAweDNGRTkyNDkyLCAweDI0OTI0OTI1LCAweDNGRTQ5MjQ5LCAweDAwMDAwMDAwLCAweDNGRTAwMDAwLCAweEI2REI2REI3LCAweDNGRDZEQjZELAogICAgMHhEQjZEQjZEQiwgMHgzRkNCNkRCNiwgMHg5MjQ5MjQ5MiwgMHgzRkIyNDkyNApdKSkuYnVmZmVyKTsKSENBVGFibGVzLlNjYWxlQ29udmVyc2lvblRhYmxlID0gbmV3IEZsb2F0NjRBcnJheShfYi5hZGFwdEVuZGlhbm5lc3M2NDMyKG5ldyBVaW50MzJBcnJheShbCiAgICAweDAwMDAwMDAwLCAweDAwMDAwMDAwLCAweDAwMDAwMDAwLCAweDAwMDAwMDAwLCAweDIxRjcyRTFELCAweDNFNTQxNjBBLCAweEJGRDNGMzY4LCAweDNFNUFDMzZCLAogICAgMHgzMTY4Qjk5RiwgMHgzRTYxRDQ4NywgMHgwMTMwQzEyMywgMHgzRTY3QzFFRCwgMHg4MTlFOTBDNCwgMHgzRTZGQTdDMSwgMHhBMkNGNjYzNSwgMHgzRTc1MTZEQSwKICAgIDB4REQ4NTUyOEIsIDB4M0U3QzE5OUIsIDB4RDBEQUQ5ODUsIDB4M0U4MkI4N0YsIDB4OTkxNTc3MjgsIDB4M0U4OEYxQUUsIDB4Q0FDNkYzN0EsIDB4M0U5MDlFM0UsCiAgICAweEIwM0E1NTc4LCAweDNFOTYyNDdFLCAweDE2Qzk4Mzg4LCAweDNFOUQ4MEUzLCAweDM0RTU5RkVDLCAweDNFQTNBN0RCLCAweEVDNEEyRDI2LCAweDNFQUEzMDlCLAogICAgMHgzQzdENTE3MiwgMHgzRUIxNzJCOCwgMHg0OEE1ODE2OCwgMHgzRUI3M0Y5QSwgMHhFRTYxNUExOCwgMHgzRUJFRkExQiwgMHhGMEQ3RDNENCwgMHgzRUM0QTMyQSwKICAgIDB4RjJGQjVFM0EsIDB4M0VDQjdGNzYsIDB4NEZCMkE2MzcsIDB4M0VEMjUxQ0UsIDB4OUI0NDkyRTEsIDB4M0VEODY4RDksIDB4RTg2RTdGN0UsIDB4M0VFMDQzMTUsCiAgICAweERENDg1NDIwLCAweDNFRTVBQjA3LCAweDU1NURDM0VFLCAweDNFRUNERjBCLCAweEIyNjQxNkY3LCAweDNFRjMzQzA4LCAweDcwQ0EwN0IwLCAweDNFRjlBMEYxLAogICAgMHhEMDEyNUI0QSwgMHgzRjAxMTMwMSwgMHg3NTBCREFCNiwgMHgzRjA2QzAxMiwgMHhFNzhCM0ZFQiwgMHgzRjBFNTAyRSwgMHhEOTUwQTg5MCwgMHgzRjE0MzFGNSwKICAgIDB4OTk1QUQzQTQsIDB4M0YxQUU4OUYsIDB4MjJGQ0Q5MTcsIDB4M0YyMUVENTAsIDB4MzZDRjRFNUEsIDB4M0YyN0UyRjMsIDB4MkI4RjcxRTcsIDB4M0YyRkQzQzIsCiAgICAweDU2OUQ0RjdCLCAweDNGMzUzNDJCLCAweDVGRkZEMDcyLCAweDNGM0M0MEFCLCAweEE2RTQwMzA2LCAweDNGNDJEMjg1LCAweDBCOTFGRkJGLCAweDNGNDkxNDVCLAogICAgMHg2Q0Y5ODkwQiwgMHgzRjUwQjU1OCwgMHgzNENDQzMxQSwgMHgzRjU2NDM0NiwgMHgwM0RCMzI3RSwgMHgzRjVEQTlFNiwgMHhDMzEzQThFMCwgMHgzRjYzQzMyRCwKICAgIDB4QjIzRTI1NTcsIDB4M0Y2QTU1MDMsIDB4Mzg4QzhERTYsIDB4M0Y3MThBRjksIDB4NTY0MjY3QzQsIDB4M0Y3NzVGRUIsIDB4Mzc2QkJBOTIsIDB4M0Y3RjI1MkIsCiAgICAweEQ1MzYyQTI0LCAweDNGODRCRkRBLCAweDMwQTEwNjQ1LCAweDNGOEJBNUIwLCAweDY1RTI3Q0RBLCAweDNGOTI2QjQ1LCAweEQ5OEE2Njk2LCAweDNGOTg4QUM3LAogICAgMHhEMzE1ODU3MiwgMHgzRkEwNTlCMCwgMHg4QTU5NDZCNCwgMHgzRkE1QzkyNiwgMHg0QTA3ODk3OCwgMHgzRkFEMDcyRCwgMHg1RjkyOUZFRiwgMHgzRkIzNTZDNSwKICAgIDB4ODJBM0YwOEUsIDB4M0ZCOUM0OTEsIDB4QzA2QzMxQ0IsIDB4M0ZDMTJBQkQsIDB4M0M2NTFBMkQsIDB4M0ZDNkRGQjIsIDB4RkJDNzRDODIsIDB4M0ZDRTdBNTEsCiAgICAweDYwNjE4OTJDLCAweDNGRDQ0RTA4LCAweDI5OERCNjY1LCAweDNGREIwRTA3LCAweDg4NjI4Q0Q2LCAweDNGRTIwNjNCLCAweDU0M0UxQTExLCAweDNGRTgwNDI3LAogICAgMHgwMDAwMDAwMCwgMHgzRkYwMDAwMCwgMHhDQTVEOTIwRiwgMHgzRkY1NTFBNCwgMHgyRTU3RDE0QywgMHgzRkZDNjdGMSwgMHhBOTNFMkY1NywgMHg0MDAyRUNBRiwKICAgIDB4QjBDREM1RTYsIDB4NDAwOTM3MzcsIDB4MkI3MjQ3RjgsIDB4NDAxMENDOTIsIDB4ODI1NTIyMjYsIDB4NDAxNjYyMzgsIDB4RjMwMUI0NjMsIDB4NDAxREQzMjEsCiAgICAweDRDMTIzNDI0LCAweDQwMjNERUE2LCAweDEzMzBCMzVCLCAweDQwMkE3OTlFLCAweEVCNkZDQjc3LCAweDQwMzFBMzVCLCAweDRGREU1RDQyLCAweDQwMzc4MDY5LAogICAgMHg1QjZFNDU0NCwgMHg0MDNGNTA3NiwgMHg5OUZEREQxMCwgMHg0MDQ0RENCMiwgMHg5MDRCQzFENiwgMHg0MDRCQ0MxRSwgMHhFMUY1NjM4NCwgMHg0MDUyODRERiwKICAgIDB4NDIyQUEwRTAsIDB4NDA1OEFDRTUsIDB4MjlEREY2RTEsIDB4NDA2MDcwNkIsIDB4MTVBRDIxNEQsIDB4NDA2NUU3NkYsIDB4MDgwRDg5RjgsIDB4NDA2RDJGODcsCiAgICAweDM3M0FBOUNGLCAweDQwNzM3MUE3LCAweDE5RTMyMzI5LCAweDQwNzlFODYzLCAweEFFQTkyREU0LCAweDQwODE0MjlBLCAweEY5NTE5NDhBLCAweDQwODZGRjdELAogICAgMHhBMkE0OTBFMSwgMHg0MDhFQTRBRiwgMHhFRDFEMDA1RCwgMHg0MDk0NkE0MSwgMHhCODRGMTYwMywgMHg0MDlCMzNBMiwgMHg5MTdEREM5QiwgMHg0MEEyMUY0OSwKICAgIDB4OTk0Q0NFMUEsIDB4NDBBODI1ODksIDB4QTlGQjMzM0EsIDB4NDBCMDE2M0QsIDB4MzZCNTI3RTEsIDB4NDBCNTZGNDcsIDB4OTQwNkU3QkYsIDB4NDBCQzhGNkQsCiAgICAweDBBMzFCNzFDLCAweDQwQzMwNkZFLCAweENCQzg1MjE4LCAweDQwQzk1QTQ0LCAweDMyRDNEMUE4LCAweDQwRDBFM0VDLCAweEQ0NENBOTdDLCAweDQwRDY4MTU1LAogICAgMHgzMzdCOUI2QSwgMHg0MERERkM5NywgMHgwNEFDODAyNCwgMHg0MEUzRkE0NSwgMHg1NTc5RkRDQSwgMHg0MEVBOUU2QiwgMHg4NDA0NUNEQiwgMHg0MEYxQkJFMCwKICAgIDB4NzNFQjAxOTEsIDB4NDBGN0ExMTQsIDB4QUQ5Q0JFMjEsIDB4NDBGRjdCRkQsIDB4NzY5RDJDQjAsIDB4NDEwNEY5QjIsIDB4NUJENzFFMTUsIDB4NDEwQkYyQzIsCiAgICAweEY1MUZERUVBLCAweDQxMTI5RTlELCAweDE2QjU0NDk4LCAweDQxMThDRjMyLCAweDE4NzU5QkQwLCAweDQxMjA4NzQ1LCAweEI5NzZEQzE0LCAweDQxMjYwNUUxLAogICAgMHhEQ0ZCQTQ5NiwgMHg0MTJENTgxOCwgMHg2RDA1RDg3MCwgMHg0MTMzOENBRSwgMHg3QjVERTU3MywgMHg0MTNBMEM2NiwgMHhDOEE1OEU1QiwgMHg0MTQxNUE5OCwKICAgIDB4RThFQzVGODEsIDB4NDE0NzFGNzUsIDB4MkQ4RTY4MDIsIDB4NDE0RUNGNDgsIDB4QjVDMTNDREMsIDB4NDE1NDg2QTIsIDB4OERFNTU5NEEsIDB4NDE1QjU5NzIsCiAgICAweDZFNzU2MjQzLCAweDQxNjIzODdBLCAweDQ2MjNDN0JDLCAweDQxNjg0NzFBLCAweDNFNzc4MDZCLCAweDQxNzAyQzlBLCAweEQ0OTdDODBCLCAweDQxNzU4RDEyLAogICAgMHhEQ0VGOTA3QywgMHg0MTdDQjcyMCwgMHhGQzRDRDgzRSwgMHg0MTgzMjE3MCwgMHg5RkRFNEU2MSwgMHg0MTg5N0Q4MiwgMHgwMDAwMDAwMCwgMHgwMDAwMDAwMApdKSkuYnVmZmVyKTsKY2xhc3MgSENBQ3JjMTYgewogICAgc3RhdGljIGNhbGMoZGF0YSwgc2l6ZSkgewogICAgICAgIGlmIChzaXplID4gZGF0YS5ieXRlTGVuZ3RoKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICBpZiAoc2l6ZSA8IDApCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgIGxldCBzdW0gPSAwOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2l6ZTsgaSsrKQogICAgICAgICAgICBzdW0gPSAoKHN1bSA8PCA4KSBeIHRoaXMuX3ZbKHN1bSA+PiA4KSBeIGRhdGFbaV1dKSAmIDB4MDAwMGZmZmY7CiAgICAgICAgcmV0dXJuIHN1bSAmIDB4MDAwMGZmZmY7CiAgICB9CiAgICBzdGF0aWMgdmVyaWZ5KGRhdGEsIHNpemUsIGV4cGVjdGVkLCBkb05vdFRocm93ID0gZmFsc2UpIHsKICAgICAgICBpZiAoZXhwZWN0ZWQgPT0gbnVsbCkgewogICAgICAgICAgICBleHBlY3RlZCA9IG5ldyBEYXRhVmlldyhkYXRhLmJ1ZmZlciwgZGF0YS5ieXRlT2Zmc2V0LCBkYXRhLmJ5dGVMZW5ndGgpLmdldFVpbnQxNihzaXplKTsKICAgICAgICB9CiAgICAgICAgbGV0IGFjdHVhbCA9IHRoaXMuY2FsYyhkYXRhLCBzaXplKTsKICAgICAgICBsZXQgcmVzdWx0ID0gZXhwZWN0ZWQgPT0gYWN0dWFsOwogICAgICAgIGlmICghcmVzdWx0KSB7CiAgICAgICAgICAgIGZ1bmN0aW9uIHRvSGV4KG51bSkgewogICAgICAgICAgICAgICAgY29uc3QgcGFkZGluZyA9ICIwMDAwIjsKICAgICAgICAgICAgICAgIGxldCBoZXggPSBwYWRkaW5nICsgbnVtLnRvU3RyaW5nKHBhZGRpbmcubGVuZ3RoICogNCkudG9VcHBlckNhc2UoKTsKICAgICAgICAgICAgICAgIHJldHVybiAiMHgiICsgaGV4LnN1YnN0cmluZyhoZXgubGVuZ3RoIC0gcGFkZGluZy5sZW5ndGgsIGhleC5sZW5ndGgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxldCBtc2cgPSBgY2hlY2tzdW0gbWlzbWF0Y2ggKGV4cGVjdGVkPSR7dG9IZXgoZXhwZWN0ZWQpfSBhY3R1YWw9JHt0b0hleChhY3R1YWwpfSlgOwogICAgICAgICAgICBpZiAoZG9Ob3RUaHJvdykKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IobXNnKTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKG1zZyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBzdGF0aWMgZml4KGRhdGEsIHNpemUpIHsKICAgICAgICBsZXQgbmV3Q3JjMTYgPSB0aGlzLmNhbGMoZGF0YSwgc2l6ZSk7CiAgICAgICAgbmV3IERhdGFWaWV3KGRhdGEuYnVmZmVyLCBkYXRhLmJ5dGVPZmZzZXQsIGRhdGEuYnl0ZUxlbmd0aCkuc2V0VWludDE2KHNpemUsIG5ld0NyYzE2KTsKICAgICAgICByZXR1cm4gZGF0YTsKICAgIH0KfQpIQ0FDcmMxNi5fdiA9IG5ldyBVaW50MTZBcnJheShbCiAgICAweDAwMDAsIDB4ODAwNSwgMHg4MDBGLCAweDAwMEEsIDB4ODAxQiwgMHgwMDFFLCAweDAwMTQsIDB4ODAxMSwgMHg4MDMzLCAweDAwMzYsIDB4MDAzQywgMHg4MDM5LCAweDAwMjgsIDB4ODAyRCwgMHg4MDI3LCAweDAwMjIsCiAgICAweDgwNjMsIDB4MDA2NiwgMHgwMDZDLCAweDgwNjksIDB4MDA3OCwgMHg4MDdELCAweDgwNzcsIDB4MDA3MiwgMHgwMDUwLCAweDgwNTUsIDB4ODA1RiwgMHgwMDVBLCAweDgwNEIsIDB4MDA0RSwgMHgwMDQ0LCAweDgwNDEsCiAgICAweDgwQzMsIDB4MDBDNiwgMHgwMENDLCAweDgwQzksIDB4MDBEOCwgMHg4MERELCAweDgwRDcsIDB4MDBEMiwgMHgwMEYwLCAweDgwRjUsIDB4ODBGRiwgMHgwMEZBLCAweDgwRUIsIDB4MDBFRSwgMHgwMEU0LCAweDgwRTEsCiAgICAweDAwQTAsIDB4ODBBNSwgMHg4MEFGLCAweDAwQUEsIDB4ODBCQiwgMHgwMEJFLCAweDAwQjQsIDB4ODBCMSwgMHg4MDkzLCAweDAwOTYsIDB4MDA5QywgMHg4MDk5LCAweDAwODgsIDB4ODA4RCwgMHg4MDg3LCAweDAwODIsCiAgICAweDgxODMsIDB4MDE4NiwgMHgwMThDLCAweDgxODksIDB4MDE5OCwgMHg4MTlELCAweDgxOTcsIDB4MDE5MiwgMHgwMUIwLCAweDgxQjUsIDB4ODFCRiwgMHgwMUJBLCAweDgxQUIsIDB4MDFBRSwgMHgwMUE0LCAweDgxQTEsCiAgICAweDAxRTAsIDB4ODFFNSwgMHg4MUVGLCAweDAxRUEsIDB4ODFGQiwgMHgwMUZFLCAweDAxRjQsIDB4ODFGMSwgMHg4MUQzLCAweDAxRDYsIDB4MDFEQywgMHg4MUQ5LCAweDAxQzgsIDB4ODFDRCwgMHg4MUM3LCAweDAxQzIsCiAgICAweDAxNDAsIDB4ODE0NSwgMHg4MTRGLCAweDAxNEEsIDB4ODE1QiwgMHgwMTVFLCAweDAxNTQsIDB4ODE1MSwgMHg4MTczLCAweDAxNzYsIDB4MDE3QywgMHg4MTc5LCAweDAxNjgsIDB4ODE2RCwgMHg4MTY3LCAweDAxNjIsCiAgICAweDgxMjMsIDB4MDEyNiwgMHgwMTJDLCAweDgxMjksIDB4MDEzOCwgMHg4MTNELCAweDgxMzcsIDB4MDEzMiwgMHgwMTEwLCAweDgxMTUsIDB4ODExRiwgMHgwMTFBLCAweDgxMEIsIDB4MDEwRSwgMHgwMTA0LCAweDgxMDEsCiAgICAweDgzMDMsIDB4MDMwNiwgMHgwMzBDLCAweDgzMDksIDB4MDMxOCwgMHg4MzFELCAweDgzMTcsIDB4MDMxMiwgMHgwMzMwLCAweDgzMzUsIDB4ODMzRiwgMHgwMzNBLCAweDgzMkIsIDB4MDMyRSwgMHgwMzI0LCAweDgzMjEsCiAgICAweDAzNjAsIDB4ODM2NSwgMHg4MzZGLCAweDAzNkEsIDB4ODM3QiwgMHgwMzdFLCAweDAzNzQsIDB4ODM3MSwgMHg4MzUzLCAweDAzNTYsIDB4MDM1QywgMHg4MzU5LCAweDAzNDgsIDB4ODM0RCwgMHg4MzQ3LCAweDAzNDIsCiAgICAweDAzQzAsIDB4ODNDNSwgMHg4M0NGLCAweDAzQ0EsIDB4ODNEQiwgMHgwM0RFLCAweDAzRDQsIDB4ODNEMSwgMHg4M0YzLCAweDAzRjYsIDB4MDNGQywgMHg4M0Y5LCAweDAzRTgsIDB4ODNFRCwgMHg4M0U3LCAweDAzRTIsCiAgICAweDgzQTMsIDB4MDNBNiwgMHgwM0FDLCAweDgzQTksIDB4MDNCOCwgMHg4M0JELCAweDgzQjcsIDB4MDNCMiwgMHgwMzkwLCAweDgzOTUsIDB4ODM5RiwgMHgwMzlBLCAweDgzOEIsIDB4MDM4RSwgMHgwMzg0LCAweDgzODEsCiAgICAweDAyODAsIDB4ODI4NSwgMHg4MjhGLCAweDAyOEEsIDB4ODI5QiwgMHgwMjlFLCAweDAyOTQsIDB4ODI5MSwgMHg4MkIzLCAweDAyQjYsIDB4MDJCQywgMHg4MkI5LCAweDAyQTgsIDB4ODJBRCwgMHg4MkE3LCAweDAyQTIsCiAgICAweDgyRTMsIDB4MDJFNiwgMHgwMkVDLCAweDgyRTksIDB4MDJGOCwgMHg4MkZELCAweDgyRjcsIDB4MDJGMiwgMHgwMkQwLCAweDgyRDUsIDB4ODJERiwgMHgwMkRBLCAweDgyQ0IsIDB4MDJDRSwgMHgwMkM0LCAweDgyQzEsCiAgICAweDgyNDMsIDB4MDI0NiwgMHgwMjRDLCAweDgyNDksIDB4MDI1OCwgMHg4MjVELCAweDgyNTcsIDB4MDI1MiwgMHgwMjcwLCAweDgyNzUsIDB4ODI3RiwgMHgwMjdBLCAweDgyNkIsIDB4MDI2RSwgMHgwMjY0LCAweDgyNjEsCiAgICAweDAyMjAsIDB4ODIyNSwgMHg4MjJGLCAweDAyMkEsIDB4ODIzQiwgMHgwMjNFLCAweDAyMzQsIDB4ODIzMSwgMHg4MjEzLCAweDAyMTYsIDB4MDIxQywgMHg4MjE5LCAweDAyMDgsIDB4ODIwRCwgMHg4MjA3LCAweDAyMDIKXSk7CmNsYXNzIEhDQUNpcGhlciB7CiAgICBpbml0MSgpIHsKICAgICAgICBmb3IgKGxldCBpID0gMSwgdiA9IDA7IGkgPCAweEZGOyBpKyspIHsKICAgICAgICAgICAgdiA9ICh2ICogMTMgKyAxMSkgJiAweEZGOwogICAgICAgICAgICBpZiAodiA9PSAwIHx8IHYgPT0gMHhGRikKICAgICAgICAgICAgICAgIHYgPSAodiAqIDEzICsgMTEpICYgMHhGRjsKICAgICAgICAgICAgdGhpcy5fdGFibGVbaV0gPSB2OwogICAgICAgIH0KICAgICAgICB0aGlzLl90YWJsZVswXSA9IDA7CiAgICAgICAgdGhpcy5fdGFibGVbMHhGRl0gPSAweEZGOwogICAgfQogICAgaW5pdDU2KCkgewogICAgICAgIGxldCBrZXkxID0gdGhpcy5nZXRLZXkxKCk7CiAgICAgICAgbGV0IGtleTIgPSB0aGlzLmdldEtleTIoKTsKICAgICAgICBpZiAoIWtleTEpCiAgICAgICAgICAgIGtleTItLTsKICAgICAgICBrZXkxLS07CiAgICAgICAgdGhpcy5kdjEuc2V0VWludDMyKDAsIGtleTEsIHRydWUpOwogICAgICAgIHRoaXMuZHYyLnNldFVpbnQzMigwLCBrZXkyLCB0cnVlKTsKICAgICAgICBsZXQgdDEgPSB0aGlzLmdldEJ5dGVzT2ZUd29LZXlzKCk7CiAgICAgICAgbGV0IHQyID0gbmV3IFVpbnQ4QXJyYXkoWwogICAgICAgICAgICB0MVsxXSwgdDFbMV0gXiB0MVs2XSwgdDFbMl0gXiB0MVszXSwKICAgICAgICAgICAgdDFbMl0sIHQxWzJdIF4gdDFbMV0sIHQxWzNdIF4gdDFbNF0sCiAgICAgICAgICAgIHQxWzNdLCB0MVszXSBeIHQxWzJdLCB0MVs0XSBeIHQxWzVdLAogICAgICAgICAgICB0MVs0XSwgdDFbNF0gXiB0MVszXSwgdDFbNV0gXiB0MVs2XSwKICAgICAgICAgICAgdDFbNV0sIHQxWzVdIF4gdDFbNF0sIHQxWzZdIF4gdDFbMV0sCiAgICAgICAgICAgIHQxWzZdCiAgICAgICAgXSk7CiAgICAgICAgbGV0IHQzID0gbmV3IFVpbnQ4QXJyYXkoMHgxMDApOwogICAgICAgIGxldCB0MzEgPSBuZXcgVWludDhBcnJheSgweDEwKTsKICAgICAgICBsZXQgdDMyID0gbmV3IFVpbnQ4QXJyYXkoMHgxMCk7CiAgICAgICAgdGhpcy5jcmVhdGVUYWJsZSh0MzEsIHQxWzBdKTsKICAgICAgICBmb3IgKGxldCBpID0gMCwgdCA9IDA7IGkgPCAweDEwOyBpKyspIHsKICAgICAgICAgICAgdGhpcy5jcmVhdGVUYWJsZSh0MzIsIHQyW2ldKTsKICAgICAgICAgICAgbGV0IHYgPSB0MzFbaV0gPDwgNDsKICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCAweDEwOyBqKyspIHsKICAgICAgICAgICAgICAgIHQzW3QrK10gPSB2IHwgdDMyW2pdOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZvciAobGV0IGkgPSAwLCB2ID0gMCwgdCA9IDE7IGkgPCAweDEwMDsgaSsrKSB7CiAgICAgICAgICAgIHYgPSAodiArIDB4MTEpICYgMHhGRjsKICAgICAgICAgICAgbGV0IGEgPSB0M1t2XTsKICAgICAgICAgICAgaWYgKGEgIT0gMCAmJiBhICE9IDB4RkYpCiAgICAgICAgICAgICAgICB0aGlzLl90YWJsZVt0KytdID0gYTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fdGFibGVbMF0gPSAwOwogICAgICAgIHRoaXMuX3RhYmxlWzB4RkZdID0gMHhGRjsKICAgIH0KICAgIGNyZWF0ZVRhYmxlKHIsIGtleSkgewogICAgICAgIGxldCBtdWwgPSAoKGtleSAmIDEpIDw8IDMpIHwgNTsKICAgICAgICBsZXQgYWRkID0gKGtleSAmIDB4RSkgfCAxOwogICAgICAgIGxldCB0ID0gMDsKICAgICAgICBrZXkgPj49IDQ7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAweDEwOyBpKyspIHsKICAgICAgICAgICAga2V5ID0gKGtleSAqIG11bCArIGFkZCkgJiAweEY7CiAgICAgICAgICAgIHJbdCsrXSA9IGtleTsKICAgICAgICB9CiAgICB9CiAgICBpbnZlcnRUYWJsZSgpIHsKICAgICAgICAvLyBhY3R1YWxseSwgdGhpcyBtZXRob2Qgc3dpdGNoIHRoZSBtb2RlIGJldHdlZW4gZW5jcnlwdC9kZWNyeXB0CiAgICAgICAgdGhpcy5lbmNyeXB0ID0gIXRoaXMuZW5jcnlwdDsKICAgICAgICBsZXQgX29sZF90YWJsZSA9IHRoaXMuX3RhYmxlLnNsaWNlKDApOwogICAgICAgIGxldCBiaXRNYXAgPSBuZXcgVWludDE2QXJyYXkoMTYpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMjU2OyBpKyspIHsKICAgICAgICAgICAgLy8gaW52ZXJ0IGtleSBhbmQgdmFsdWUKICAgICAgICAgICAgbGV0IGtleSA9IF9vbGRfdGFibGVbaV07CiAgICAgICAgICAgIGxldCB2YWwgPSBpOwogICAgICAgICAgICAvLyBjaGVjayBmb3IgaW5jb25zaXN0ZW5jeQogICAgICAgICAgICBsZXQgaGlnaGVyNCA9IGtleSA+PiA0ICYgMHgwRjsKICAgICAgICAgICAgbGV0IGxvd2VyNCA9IGtleSAmIDB4MEY7CiAgICAgICAgICAgIGxldCBmbGFnID0gMHgwMSA8PCBsb3dlcjQ7CiAgICAgICAgICAgIGlmIChiaXRNYXBbaGlnaGVyNF0gJiBmbGFnKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJfdGFibGUgaXMgbm90IGJpamVjdGl2ZSIpOwogICAgICAgICAgICAvLyB1cGRhdGUgdGFibGUKICAgICAgICAgICAgdGhpcy5fdGFibGVba2V5XSA9IHZhbDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBnZXRUeXBlKCkgewogICAgICAgIHJldHVybiB0aGlzLmNpcGhlclR5cGU7CiAgICB9CiAgICBnZXRFbmNyeXB0KCkgewogICAgICAgIHJldHVybiB0aGlzLmVuY3J5cHQ7CiAgICB9CiAgICBnZXRLZXkxKCkgewogICAgICAgIHJldHVybiB0aGlzLmR2MS5nZXRVaW50MzIoMCwgdHJ1ZSk7CiAgICB9CiAgICBnZXRLZXkyKCkgewogICAgICAgIHJldHVybiB0aGlzLmR2Mi5nZXRVaW50MzIoMCwgdHJ1ZSk7CiAgICB9CiAgICBnZXRCeXRlc09mVHdvS2V5cygpIHsKICAgICAgICBsZXQgYnVmID0gbmV3IFVpbnQ4QXJyYXkoOCk7CiAgICAgICAgYnVmLnNldChuZXcgVWludDhBcnJheSh0aGlzLmtleTFidWYpLCAwKTsKICAgICAgICBidWYuc2V0KG5ldyBVaW50OEFycmF5KHRoaXMua2V5MmJ1ZiksIDQpOwogICAgICAgIHJldHVybiBidWY7CiAgICB9CiAgICBzZXRLZXkxKGtleSkgewogICAgICAgIHRoaXMuZHYxLnNldFVpbnQzMigwLCBrZXksIHRydWUpOwogICAgICAgIHRoaXMuaW5pdDU2KCk7CiAgICAgICAgdGhpcy5jaXBoZXJUeXBlID0gMHgzODsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIHNldEtleTIoa2V5KSB7CiAgICAgICAgdGhpcy5kdjIuc2V0VWludDMyKDAsIGtleSwgdHJ1ZSk7CiAgICAgICAgdGhpcy5pbml0NTYoKTsKICAgICAgICB0aGlzLmNpcGhlclR5cGUgPSAweDM4OwogICAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgc2V0S2V5cyhrZXkxLCBrZXkyKSB7CiAgICAgICAgdGhpcy5kdjEuc2V0VWludDMyKDAsIGtleTEsIHRydWUpOwogICAgICAgIHRoaXMuZHYyLnNldFVpbnQzMigwLCBrZXkyLCB0cnVlKTsKICAgICAgICB0aGlzLmluaXQ1NigpOwogICAgICAgIHRoaXMuY2lwaGVyVHlwZSA9IDB4Mzg7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBzZXRUb0RlZktleXMoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc2V0S2V5cyhIQ0FDaXBoZXIuZGVmS2V5MSwgSENBQ2lwaGVyLmRlZktleTIpOwogICAgfQogICAgc2V0VG9Ob0tleSgpIHsKICAgICAgICB0aGlzLmluaXQxKCk7CiAgICAgICAgdGhpcy5jaXBoZXJUeXBlID0gMHgwMTsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIG1hc2soYmxvY2ssIG9mZnNldCwgc2l6ZSkgewogICAgICAgIC8vIGVuY3J5cHQgb3IgZGVjcnlwdCBibG9jayBkYXRhCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaXplOyBpKyspCiAgICAgICAgICAgIGJsb2NrW29mZnNldCArIGldID0gdGhpcy5fdGFibGVbYmxvY2tbb2Zmc2V0ICsgaV1dOwogICAgfQogICAgc3RhdGljIGlzSENBSGVhZGVyTWFza2VkKGhjYSkgewogICAgICAgIC8vIGZhc3QgJiBkaXJ0eSB3YXkgdG8gZGV0ZXJtaW5lIHdoZXRoZXIgZW5jcnlwdGVkLCBub3QgcmVjb21tZW5kZWQKICAgICAgICBpZiAoaGNhWzBdICYgMHg4MCB8fCBoY2FbMV0gJiAweDgwIHx8IGhjYVsyXSAmIDB4ODApCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIGVsc2UKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgc3RhdGljIHBhcnNlS2V5KGtleSkgewogICAgICAgIHN3aXRjaCAodHlwZW9mIGtleSkgewogICAgICAgICAgICBjYXNlICJudW1iZXIiOgogICAgICAgICAgICAgICAgcmV0dXJuIGtleTsKICAgICAgICAgICAgY2FzZSAic3RyaW5nIjoKICAgICAgICAgICAgICAgIC8vIGF2b2lkIGFtYmlndWl0eTogYWx3YXlzIHRyZWF0IGFzIGhleAogICAgICAgICAgICAgICAgaWYgKCFrZXkubWF0Y2goL14weC8pKQogICAgICAgICAgICAgICAgICAgIGtleSA9ICIweCIgKyBrZXk7CiAgICAgICAgICAgICAgICBrZXkgPSBwYXJzZUludChrZXkpOwogICAgICAgICAgICAgICAgaWYgKGlzTmFOKGtleSkpCiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJjYW5ub3QgcGFyc2UgYXMgaW50ZWdlciIpOwogICAgICAgICAgICAgICAgcmV0dXJuIGtleTsKICAgICAgICAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgICAgICAgICAgIC8vIGF2b2lkIGVuZGlhbm5lc3MgYW1iaWd1aXR5OiBvbmx5IGFjY2VwdGluZyBVaW50OEFycmF5LCB0aGVuIHJlYWQgYXMgbGl0dGxlIGVuZGlhbgogICAgICAgICAgICAgICAgaWYgKGtleSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkgJiYga2V5LmJ5dGVMZW5ndGggPT0gNCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgRGF0YVZpZXcoa2V5LmJ1ZmZlciwga2V5LmJ5dGVPZmZzZXQsIGtleS5ieXRlTGVuZ3RoKS5nZXRVaW50MzIoMCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImNhbiBvbmx5IGFjY2VwdCBudW1iZXIvaGV4IHN0cmluZy9VaW50OEFycmF5WzRdIik7CiAgICAgICAgfQogICAgfQogICAgY29uc3RydWN0b3Ioa2V5MSwga2V5MikgewogICAgICAgIHRoaXMuY2lwaGVyVHlwZSA9IDA7CiAgICAgICAgdGhpcy5lbmNyeXB0ID0gZmFsc2U7CiAgICAgICAgdGhpcy5rZXkxYnVmID0gbmV3IEFycmF5QnVmZmVyKDQpOwogICAgICAgIHRoaXMua2V5MmJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcig0KTsKICAgICAgICB0aGlzLl90YWJsZSA9IG5ldyBVaW50OEFycmF5KDI1Nik7CiAgICAgICAgdGhpcy5kdjEgPSBuZXcgRGF0YVZpZXcodGhpcy5rZXkxYnVmKTsKICAgICAgICB0aGlzLmR2MiA9IG5ldyBEYXRhVmlldyh0aGlzLmtleTJidWYpOwogICAgICAgIGlmIChrZXkxID09IG51bGwpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigibm8ga2V5cyBnaXZlbi4gdXNlIFwiZGVmYXVsdGtleVwiIGlmIHlvdSB3YW50IHRvIHVzZSB0aGUgZGVmYXVsdCBrZXkiKTsKICAgICAgICBzd2l0Y2ggKGtleTEpIHsKICAgICAgICAgICAgY2FzZSAibm9uZSI6CiAgICAgICAgICAgIGNhc2UgIm5va2V5IjoKICAgICAgICAgICAgY2FzZSAibm9LZXkiOgogICAgICAgICAgICBjYXNlICJubyBrZXkiOgogICAgICAgICAgICBjYXNlICJub19LZXkiOgogICAgICAgICAgICAgICAgdGhpcy5zZXRUb05vS2V5KCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZGVmYXVsdGtleSI6CiAgICAgICAgICAgIGNhc2UgImRlZmF1bHRLZXkiOgogICAgICAgICAgICBjYXNlICJkZWZhdWx0IGtleSI6CiAgICAgICAgICAgIGNhc2UgImRlZmF1bHRfa2V5IjoKICAgICAgICAgICAgICAgIHRoaXMuc2V0VG9EZWZLZXlzKCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIGtleTEgPSBIQ0FDaXBoZXIucGFyc2VLZXkoa2V5MSk7CiAgICAgICAgICAgICAgICBpZiAoa2V5MiA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAga2V5MiA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBrZXkyID0gSENBQ2lwaGVyLnBhcnNlS2V5KGtleTIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5zZXRLZXlzKGtleTEsIGtleTIpOwogICAgICAgIH0KICAgIH0KfQpIQ0FDaXBoZXIuZGVmS2V5MSA9IDB4MDEzOTVDNTE7CkhDQUNpcGhlci5kZWZLZXkyID0gMHgwMDAwMDAwMDsKY29uc3Qgc3VzcGVuZEF1ZGlvQ3R4SWZVbmxvY2tlZCA9IChhdWRpb0N0eCkgPT4gX19hd2FpdGVyKHZvaWQgMCwgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAvLyBzdXNwZW5kIGF1ZGlvIGNvbnRleHQgZm9yIG5vdwogICAgLy8gaW4gYXBwbGUgd2Via2l0IGl0J3MgYWxyZWFkeSBzdXNwZW5kZWQgJiBjYWxsaW5nIHN1c3BlbmQgeWV0IGFnYWluIHdpbGwgYmxvY2sKICAgIHN3aXRjaCAoYXVkaW9DdHguc3RhdGUpIHsKICAgICAgICBjYXNlICJydW5uaW5nIjoKICAgICAgICAgICAgeWllbGQgYXVkaW9DdHguc3VzcGVuZCgpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICBjYXNlICJzdXNwZW5kZWQiOgogICAgICAgICAgICBjb25zb2xlLndhcm4oYGF1ZGlvIGNvbnRleHQgZm9yIHNhbXBsZVJhdGU9JHthdWRpb0N0eC5zYW1wbGVSYXRlfSBpcyBzdXNwZW5kZWQvbG9ja2VkLGAKICAgICAgICAgICAgICAgICsgYCB3aGljaCBjYW4gb25seSBiZSByZXN1bWVkL3VubG9ja2VkIGJ5IFVJIGV2ZW50LmApOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBhdWRpbyBjb250ZXh0IGlzIG5laXRoZXIgcnVubmluZyBub3Igc3VzcGVuZGVkYCk7CiAgICB9Cn0pOwovLyBXZWJBdWRpby1iYXNlZCBsb29wIHBsYXllcgpleHBvcnQgY2xhc3MgSENBV2ViQXVkaW9Mb29wUGxheWVyIHsKICAgIGdldCB1bmxvY2tlZCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fdW5sb2NrZWQ7CiAgICB9CiAgICBnZXQgdm9sdW1lKCkgewogICAgICAgIHJldHVybiB0aGlzLmdhaW5Ob2RlLmdhaW4udmFsdWU7CiAgICB9CiAgICBzZXQgdm9sdW1lKHZhbCkgewogICAgICAgIGlmIChpc05hTih2YWwpKQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgaWYgKHZhbCA+IDEuMCkKICAgICAgICAgICAgdmFsID0gMS4wOwogICAgICAgIGlmICh2YWwgPCAwKQogICAgICAgICAgICB2YWwgPSAwOwogICAgICAgIHRoaXMuZ2Fpbk5vZGUuZ2Fpbi52YWx1ZSA9IHZhbDsKICAgIH0KICAgIGNvbnN0cnVjdG9yKGluZm8sIGJ1ZlNyYywgYXVkaW9DdHgsIHVubG9ja2VkLCBnYWluTm9kZSwgdm9sdW1lKSB7CiAgICAgICAgdGhpcy5zdGFydGVkID0gZmFsc2U7CiAgICAgICAgdGhpcy5jbG9zZWQgPSBmYWxzZTsKICAgICAgICB0aGlzLmluZm8gPSBpbmZvOwogICAgICAgIHRoaXMuYnVmU3JjID0gYnVmU3JjOwogICAgICAgIHRoaXMuYXVkaW9DdHggPSBhdWRpb0N0eDsKICAgICAgICB0aGlzLl91bmxvY2tlZCA9IHVubG9ja2VkOwogICAgICAgIHRoaXMuZ2Fpbk5vZGUgPSBnYWluTm9kZTsKICAgICAgICB0aGlzLnZvbHVtZSA9IHZvbHVtZTsKICAgIH0KICAgIHN0YXRpYyBjcmVhdGUoZGVjcnlwdGVkLCB3b3JrZXIsIHZvbHVtZSA9IDEwMCkgewogICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAgIGNvbnN0IGluZm8gPSBuZXcgSENBSW5mbyhkZWNyeXB0ZWQpOwogICAgICAgICAgICBpZiAoaW5mby5jaXBoZXIgIT0gMCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigib25seSBkZWNyeXB0ZWQgaGNhIGlzIGFjY2VwdGVkIik7CiAgICAgICAgICAgIGNvbnN0IGF1ZGlvQ3R4ID0gbmV3IEF1ZGlvQ29udGV4dCh7CiAgICAgICAgICAgICAgICBzYW1wbGVSYXRlOiBpbmZvLmZvcm1hdC5zYW1wbGluZ1JhdGUsCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCB3YXYgPSB5aWVsZCB3b3JrZXIuZGVjb2RlKGRlY3J5cHRlZCwgMTYpOyAvLyBmaXJzdAogICAgICAgICAgICBjb25zdCB1bmxvY2tlZCA9IHlpZWxkIHN1c3BlbmRBdWRpb0N0eElmVW5sb2NrZWQoYXVkaW9DdHgpOwogICAgICAgICAgICBjb25zdCBidWZmZXIgPSB5aWVsZCBhdWRpb0N0eC5kZWNvZGVBdWRpb0RhdGEod2F2LmJ1ZmZlcik7CiAgICAgICAgICAgIGNvbnN0IGJ1ZlNyYyA9IGF1ZGlvQ3R4LmNyZWF0ZUJ1ZmZlclNvdXJjZSgpOwogICAgICAgICAgICBidWZTcmMuYnVmZmVyID0gYnVmZmVyOwogICAgICAgICAgICBpZiAoaW5mby5sb29wICE9IG51bGwgJiYgaW5mby5sb29wLmVuZCA+IGluZm8ubG9vcC5zdGFydCkgewogICAgICAgICAgICAgICAgYnVmU3JjLmxvb3BTdGFydCA9IGluZm8ubG9vcFN0YXJ0VGltZTsKICAgICAgICAgICAgICAgIGJ1ZlNyYy5sb29wRW5kID0gaW5mby5sb29wRW5kVGltZTsKICAgICAgICAgICAgICAgIGJ1ZlNyYy5sb29wID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCBnYWluTm9kZSA9IGF1ZGlvQ3R4LmNyZWF0ZUdhaW4oKTsKICAgICAgICAgICAgYnVmU3JjLmNvbm5lY3QoZ2Fpbk5vZGUpOwogICAgICAgICAgICBnYWluTm9kZS5jb25uZWN0KGF1ZGlvQ3R4LmRlc3RpbmF0aW9uKTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBIQ0FXZWJBdWRpb0xvb3BQbGF5ZXIoaW5mbywgYnVmU3JjLCBhdWRpb0N0eCwgdW5sb2NrZWQsIGdhaW5Ob2RlLCB2b2x1bWUpOwogICAgICAgIH0pOwogICAgfQogICAgcGxheSgpIHsKICAgICAgICB0aGlzLmF1ZGlvQ3R4LnJlc3VtZSgpOwogICAgICAgIGlmICghdGhpcy5zdGFydGVkKSB7CiAgICAgICAgICAgIHRoaXMuYnVmU3JjLnN0YXJ0KCk7CiAgICAgICAgICAgIHRoaXMuc3RhcnRlZCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIC8vIG1hcmsgYXMgdW5sb2NrZWQKICAgICAgICBpZiAoIXRoaXMuX3VubG9ja2VkKSB7CiAgICAgICAgICAgIHRoaXMuX3VubG9ja2VkID0gdHJ1ZTsKICAgICAgICAgICAgY29uc29sZS53YXJuKGBhdWRpbyBjb250ZXh0IGZvciBzYW1wbGVSYXRlPSR7dGhpcy5hdWRpb0N0eC5zYW1wbGVSYXRlfSBpcyBub3cgcmVzdW1lZC91bmxvY2tlZGApOwogICAgICAgIH0KICAgIH0KICAgIHBhdXNlKCkgewogICAgICAgIGlmICh0aGlzLmF1ZGlvQ3R4LnN0YXRlICE9PSAicnVubmluZyIpCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB0aGlzLmF1ZGlvQ3R4LnN1c3BlbmQoKTsKICAgIH0KICAgIHN0b3AoKSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLl91bmxvY2tlZCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiYXVkaW8gY29udGV4dCBpcyBub3QgdW5sb2NrZWQsIGNhbm5vdCBzdG9wIGFuZCBkZXN0cm95Iik7CiAgICAgICAgICAgIGlmICh0aGlzLmNsb3NlZCkKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgdGhpcy5idWZTcmMuZGlzY29ubmVjdCgpOwogICAgICAgICAgICB5aWVsZCB0aGlzLmF1ZGlvQ3R4LmNsb3NlKCk7CiAgICAgICAgICAgIHRoaXMuY2xvc2VkID0gdHJ1ZTsKICAgICAgICB9KTsKICAgIH0KfQovLyBjb252ZXJ0IG5vbi10cmFuc2ZlcmFibGUgdHlwZWQgYXJyYXkgdG8gdHJhbnNmZXJhYmxlIGFycmF5IGJ1ZmZlcgpjbGFzcyBIQ0FUcmFuc1R5cGVkQXJyYXkgewogICAgc3RhdGljIGNvbnZlcnQoYXJnLCB0cmFuc2Zlckxpc3QpIHsKICAgICAgICBpZiAodGhpcy5nZXRUeXBlKGFyZykgIT0gbnVsbCkKICAgICAgICAgICAgcmV0dXJuIG5ldyBIQ0FUcmFuc1R5cGVkQXJyYXkoYXJnLCB0cmFuc2Zlckxpc3QpOwogICAgICAgIGVsc2UKICAgICAgICAgICAgcmV0dXJuIGFyZzsKICAgIH0KICAgIHN0YXRpYyByZXN0b3JlKGFyZykgewogICAgICAgIGNvbnN0IHR5cGUgPSB0aGlzLmdldFR5cGUoYXJnKTsKICAgICAgICBpZiAodHlwZSAhPSBudWxsICYmIHR5cGUuY29udmVydGVkKQogICAgICAgICAgICByZXR1cm4gYXJnLmFycmF5OwogICAgICAgIGVsc2UKICAgICAgICAgICAgcmV0dXJuIGFyZzsKICAgIH0KICAgIHN0YXRpYyBnZXRUeXBlKGFyZykgewogICAgICAgIGlmIChhcmcgPT0gbnVsbCB8fCB0eXBlb2YgYXJnICE9PSAib2JqZWN0IikKICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICBlbHNlIGlmIChhcmcgaW5zdGFuY2VvZiBJbnQ4QXJyYXkpCiAgICAgICAgICAgIHJldHVybiB7IGNvbnZlcnRlZDogZmFsc2UsIHR5cGU6ICJJbnQ4IiB9OwogICAgICAgIGVsc2UgaWYgKGFyZyBpbnN0YW5jZW9mIEludDE2QXJyYXkpCiAgICAgICAgICAgIHJldHVybiB7IGNvbnZlcnRlZDogZmFsc2UsIHR5cGU6ICJJbnQxNiIgfTsKICAgICAgICBlbHNlIGlmIChhcmcgaW5zdGFuY2VvZiBJbnQzMkFycmF5KQogICAgICAgICAgICByZXR1cm4geyBjb252ZXJ0ZWQ6IGZhbHNlLCB0eXBlOiAiSW50MzIiIH07CiAgICAgICAgZWxzZSBpZiAoYXJnIGluc3RhbmNlb2YgVWludDhBcnJheSkKICAgICAgICAgICAgcmV0dXJuIHsgY29udmVydGVkOiBmYWxzZSwgdHlwZTogIlVpbnQ4IiB9OwogICAgICAgIGVsc2UgaWYgKGFyZyBpbnN0YW5jZW9mIFVpbnQxNkFycmF5KQogICAgICAgICAgICByZXR1cm4geyBjb252ZXJ0ZWQ6IGZhbHNlLCB0eXBlOiAiVWludDE2IiB9OwogICAgICAgIGVsc2UgaWYgKGFyZyBpbnN0YW5jZW9mIFVpbnQzMkFycmF5KQogICAgICAgICAgICByZXR1cm4geyBjb252ZXJ0ZWQ6IGZhbHNlLCB0eXBlOiAiVWludDMyIiB9OwogICAgICAgIGVsc2UgaWYgKGFyZyBpbnN0YW5jZW9mIEZsb2F0MzJBcnJheSkKICAgICAgICAgICAgcmV0dXJuIHsgY29udmVydGVkOiBmYWxzZSwgdHlwZTogIkZsb2F0MzIiIH07CiAgICAgICAgZWxzZSBpZiAoYXJnIGluc3RhbmNlb2YgRmxvYXQ2NEFycmF5KQogICAgICAgICAgICByZXR1cm4geyBjb252ZXJ0ZWQ6IGZhbHNlLCB0eXBlOiAiRmxvYXQ2NCIgfTsKICAgICAgICBlbHNlIGlmIChhcmcuYnVmZmVyIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIgJiYgdHlwZW9mIGFyZy50eXBlID09PSAic3RyaW5nIikKICAgICAgICAgICAgcmV0dXJuIHsgY29udmVydGVkOiB0cnVlLCB0eXBlOiBhcmcudHlwZSB9OwogICAgICAgIGVsc2UKICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH0KICAgIGNvbnN0cnVjdG9yKHRhLCB0cmFuc2Zlckxpc3QpIHsKICAgICAgICBjb25zdCB0eXBlID0gSENBVHJhbnNUeXBlZEFycmF5LmdldFR5cGUodGEpOwogICAgICAgIGlmICh0eXBlICE9IG51bGwpCiAgICAgICAgICAgIHRoaXMudHlwZSA9IHR5cGUudHlwZTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidW5leHBlY3RlZCB0eXBlIik7CiAgICAgICAgdGhpcy5idWZmZXIgPSB0YS5idWZmZXI7CiAgICAgICAgdGhpcy5ieXRlT2Zmc2V0ID0gdGEuYnl0ZU9mZnNldDsKICAgICAgICB0aGlzLmxlbmd0aCA9IHRhLmxlbmd0aDsKICAgICAgICBpZiAoIXRyYW5zZmVyTGlzdC5maW5kKCh2YWwpID0+IHZhbCA9PT0gdGhpcy5idWZmZXIpKQogICAgICAgICAgICB0cmFuc2Zlckxpc3QucHVzaCh0aGlzLmJ1ZmZlcik7CiAgICB9CiAgICBnZXQgYXJyYXkoKSB7CiAgICAgICAgc3dpdGNoICh0aGlzLnR5cGUpIHsKICAgICAgICAgICAgY2FzZSAiSW50OCI6IHJldHVybiBuZXcgSW50OEFycmF5KHRoaXMuYnVmZmVyLCB0aGlzLmJ5dGVPZmZzZXQsIHRoaXMubGVuZ3RoKTsKICAgICAgICAgICAgY2FzZSAiSW50MTYiOiByZXR1cm4gbmV3IEludDE2QXJyYXkodGhpcy5idWZmZXIsIHRoaXMuYnl0ZU9mZnNldCwgdGhpcy5sZW5ndGgpOwogICAgICAgICAgICBjYXNlICJJbnQzMiI6IHJldHVybiBuZXcgSW50MzJBcnJheSh0aGlzLmJ1ZmZlciwgdGhpcy5ieXRlT2Zmc2V0LCB0aGlzLmxlbmd0aCk7CiAgICAgICAgICAgIGNhc2UgIlVpbnQ4IjogcmV0dXJuIG5ldyBVaW50OEFycmF5KHRoaXMuYnVmZmVyLCB0aGlzLmJ5dGVPZmZzZXQsIHRoaXMubGVuZ3RoKTsKICAgICAgICAgICAgY2FzZSAiVWludDE2IjogcmV0dXJuIG5ldyBVaW50MTZBcnJheSh0aGlzLmJ1ZmZlciwgdGhpcy5ieXRlT2Zmc2V0LCB0aGlzLmxlbmd0aCk7CiAgICAgICAgICAgIGNhc2UgIlVpbnQzMiI6IHJldHVybiBuZXcgVWludDMyQXJyYXkodGhpcy5idWZmZXIsIHRoaXMuYnl0ZU9mZnNldCwgdGhpcy5sZW5ndGgpOwogICAgICAgICAgICBjYXNlICJGbG9hdDMyIjogcmV0dXJuIG5ldyBGbG9hdDMyQXJyYXkodGhpcy5idWZmZXIsIHRoaXMuYnl0ZU9mZnNldCwgdGhpcy5sZW5ndGgpOwogICAgICAgICAgICBjYXNlICJGbG9hdDY0IjogcmV0dXJuIG5ldyBGbG9hdDY0QXJyYXkodGhpcy5idWZmZXIsIHRoaXMuYnl0ZU9mZnNldCwgdGhpcy5sZW5ndGgpOwogICAgICAgIH0KICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInVuZXhwZWN0ZWQgdHlwZSIpOwogICAgfQp9CmNsYXNzIEhDQVRhc2sgewogICAgZ2V0IGFyZ3MoKSB7CiAgICAgICAgdmFyIF9jOwogICAgICAgIHJldHVybiAoX2MgPSB0aGlzLl9hcmdzKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MubWFwKChhcmcpID0+IEhDQVRyYW5zVHlwZWRBcnJheS5yZXN0b3JlKGFyZykpOwogICAgfQogICAgZ2V0IGhhc1Jlc3VsdCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5faGFzUmVzdWx0OwogICAgfQogICAgZ2V0IHJlc3VsdCgpIHsKICAgICAgICBpZiAoIXRoaXMuX2hhc1Jlc3VsdCkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJubyByZXN1bHQiKTsKICAgICAgICByZXR1cm4gSENBVHJhbnNUeXBlZEFycmF5LnJlc3RvcmUodGhpcy5fcmVzdWx0KTsKICAgIH0KICAgIHNldCByZXN1bHQocmVzdWx0KSB7CiAgICAgICAgaWYgKHRoaXMuaGFzRXJyKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImFscmVhZHkgaGFzIGVycm9yLCBjYW5ub3Qgc2V0IHJlc3VsdCIpOwogICAgICAgIGlmICh0aGlzLl9oYXNSZXN1bHQpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiY2Fubm90IHNldCByZXN1bHQgYWdhaW4iKTsKICAgICAgICB0aGlzLl9yZXN1bHQgPSBIQ0FUcmFuc1R5cGVkQXJyYXkuY29udmVydChyZXN1bHQsIHRoaXMudHJhbnNmZXJMaXN0KTsKICAgICAgICB0aGlzLl9oYXNSZXN1bHQgPSB0cnVlOwogICAgICAgIGlmICghdGhpcy5fcmVwbHlBcmdzKQogICAgICAgICAgICBkZWxldGUgdGhpcy5fYXJnczsKICAgIH0KICAgIGdldCBoYXNFcnIoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2Vyck1zZyAhPSBudWxsOwogICAgfQogICAgZ2V0IGVyck1zZygpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZXJyTXNnOwogICAgfQogICAgc2V0IGVyck1zZyhtc2cpIHsKICAgICAgICAvLyBjaGFuZ2luZyBlcnJNc2cgaXMgYWxsb3dlZCwgYnV0IGNsZWFyaW5nIGVyck1zZyBpcyBkaXNhbGxvd2VkCiAgICAgICAgaWYgKHR5cGVvZiBtc2cgIT09ICJzdHJpbmciKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImVycm9yIG1lc3NhZ2UgbXVzdCBiZSBhIHN0cmluZyIpOwogICAgICAgIGRlbGV0ZSB0aGlzLl9hcmdzOwogICAgICAgIGlmICh0aGlzLl9oYXNSZXN1bHQpIHsKICAgICAgICAgICAgLy8gY2xlYXIgcmVzdWx0IG9uIGVycm9yCiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9yZXN1bHQ7CiAgICAgICAgICAgIHRoaXMuX2hhc1Jlc3VsdCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnRyYW5zZmVyTGlzdCA9IFtdOwogICAgICAgICAgICB0aGlzLmFyZ3MuZm9yRWFjaCgoYXJnKSA9PiBIQ0FUcmFuc1R5cGVkQXJyYXkuY29udmVydChhcmcsIHRoaXMudHJhbnNmZXJMaXN0KSk7CiAgICAgICAgfQogICAgICAgIHRoaXMuX2Vyck1zZyA9IG1zZzsKICAgIH0KICAgIGNvbnN0cnVjdG9yKG9yaWdpbiwgdGFza0lELCBjbWQsIGFyZ3MsIHJlcGx5QXJncywgaXNEdW1teSkgewogICAgICAgIHRoaXMudHJhbnNmZXJMaXN0ID0gW107CiAgICAgICAgdGhpcy5faGFzUmVzdWx0ID0gZmFsc2U7CiAgICAgICAgdGhpcy5vcmlnaW4gPSBvcmlnaW47CiAgICAgICAgdGhpcy50YXNrSUQgPSB0YXNrSUQ7CiAgICAgICAgdGhpcy5jbWQgPSBjbWQ7CiAgICAgICAgdGhpcy5fYXJncyA9IGFyZ3MgPT09IG51bGwgfHwgYXJncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXJncy5tYXAoKGFyZykgPT4gSENBVHJhbnNUeXBlZEFycmF5LmNvbnZlcnQoYXJnLCB0aGlzLnRyYW5zZmVyTGlzdCkpOwogICAgICAgIHRoaXMuX3JlcGx5QXJncyA9IHJlcGx5QXJnczsKICAgICAgICBpZiAoaXNEdW1teSAhPSBudWxsICYmIGlzRHVtbXkpCiAgICAgICAgICAgIHRoaXMuaXNEdW1teSA9IHRydWU7CiAgICB9CiAgICBzdGF0aWMgcmVjcmVhdGUodGFzaykgewogICAgICAgIGNvbnN0IHJlY3JlYXRlZCA9IG5ldyBIQ0FUYXNrKHRhc2sub3JpZ2luLCB0YXNrLnRhc2tJRCwgdGFzay5jbWQsIHRhc2suX2FyZ3MsIHRhc2suX3JlcGx5QXJncyk7CiAgICAgICAgaWYgKHRhc2suX2Vyck1zZyAhPSBudWxsKQogICAgICAgICAgICByZWNyZWF0ZWQuZXJyTXNnID0gdGFzay5fZXJyTXNnOwogICAgICAgIGVsc2UgaWYgKHRhc2suX2hhc1Jlc3VsdCkKICAgICAgICAgICAgcmVjcmVhdGVkLnJlc3VsdCA9IHRhc2suX3Jlc3VsdDsKICAgICAgICByZXR1cm4gcmVjcmVhdGVkOwogICAgfQp9CmNsYXNzIEhDQVRhc2tRdWV1ZSB7CiAgICBnZXROZXh0VGFza0lEKCkgewogICAgICAgIGNvbnN0IG1heCA9IEhDQVRhc2tRdWV1ZS5tYXhUYXNrSUQgLSAxOwogICAgICAgIGlmICh0aGlzLl9sYXN0VGFza0lEIDwgMCB8fCB0aGlzLl9sYXN0VGFza0lEID4gbWF4KQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImxhc3RUYXNrSUQgb3V0IG9mIHJhbmdlIik7CiAgICAgICAgY29uc3Qgc3RhcnQgPSB0aGlzLl9sYXN0VGFza0lEICsgMTsKICAgICAgICBmb3IgKGxldCBpID0gc3RhcnQ7IGkgPD0gc3RhcnQgKyBtYXg7IGkrKykgewogICAgICAgICAgICBjb25zdCB0YXNrSUQgPSBpICUgKG1heCArIDEpOwogICAgICAgICAgICBpZiAodGhpcy5jYWxsYmFja3NbdGFza0lEXSA9PSBudWxsKQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2xhc3RUYXNrSUQgPSB0YXNrSUQ7CiAgICAgICAgfQogICAgICAgIHRocm93IG5ldyBFcnJvcigiY2Fubm90IGZpbmQgbmV4dCB0YXNrSUQiKTsKICAgIH0KICAgIHNlbmRUYXNrKHRhc2spIHsKICAgICAgICBpZiAodGFzay5vcmlnaW4gIT09IHRoaXMub3JpZ2luKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInRoZSB0YXNrIHRvIGJlIHNlbnQgbXVzdCBoYXZlIHRoZSBzYW1lIG9yaWdpbiBhcyB0aGUgdGFzayBxdWV1ZSIpOwogICAgICAgIHRoaXMucG9zdE1lc3NhZ2UodGFzaywgdGhpcy50cmFuc2ZlckFyZ3MgPyB0YXNrLnRyYW5zZmVyTGlzdCA6IFtdKTsKICAgIH0KICAgIHNlbmRSZXBseSh0YXNrKSB7CiAgICAgICAgaWYgKHRhc2sub3JpZ2luID09PSB0aGlzLm9yaWdpbikKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJ0aGUgcmVwbHkgdG8gYmUgc2VudCBtdXN0IG5vdCBoYXZlIHRoZSBzYW1lIG9yaWdpbiBhcyB0aGUgdGFzayBxdWV1ZSIpOwogICAgICAgIHRoaXMucG9zdE1lc3NhZ2UodGFzaywgdGFzay50cmFuc2Zlckxpc3QpOyAvLyBhbHdheXMgdXNlIHRyYW5zZmVycmluZyB0byBzZW5kIGJhY2sgYXJndW1lbnRzCiAgICB9CiAgICBzZW5kTmV4dFRhc2soKSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgbGV0IHRhc2sgPSB0aGlzLnF1ZXVlLnNoaWZ0KCk7CiAgICAgICAgICAgIGlmICh0YXNrID09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNJZGxlID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNJZGxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAvLyBhcHBseSBob29rIGZpcnN0CiAgICAgICAgICAgICAgICBjb25zdCByZWdpc3RlcmVkID0gdGhpcy5jYWxsYmFja3NbdGFzay50YXNrSURdOwogICAgICAgICAgICAgICAgY29uc3QgdGFza0hvb2sgPSByZWdpc3RlcmVkICE9IG51bGwgJiYgcmVnaXN0ZXJlZC5ob29rICE9IG51bGwgJiYgcmVnaXN0ZXJlZC5ob29rLnRhc2sgIT0gbnVsbAogICAgICAgICAgICAgICAgICAgID8gcmVnaXN0ZXJlZC5ob29rLnRhc2sKICAgICAgICAgICAgICAgICAgICA6IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIGlmICh0YXNrSG9vayAhPSBudWxsKQogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhc2sgPSB5aWVsZCB0YXNrSG9vayh0YXNrKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFzay5lcnJNc2cgPSBgWyR7dGhpcy5vcmlnaW59XSBlcnJvciB3aGVuIGFwcGx5aW5nIGhvb2sgYAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKyBgYmVmb3JlIGV4ZWN1dGluZyBjbWQgJHt0YXNrLmNtZH0gZnJvbSAke3Rhc2sub3JpZ2lufWA7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZSA9PT0gInN0cmluZyIgfHwgZSBpbnN0YW5jZW9mIEVycm9yKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFzay5lcnJNc2cgKz0gIlxuIiArIGUudG9TdHJpbmcoKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGFzay5pc0R1bW15ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBzZW5kIHRhc2sKICAgICAgICAgICAgICAgIGlmICh0YXNrLmlzRHVtbXkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRhc2suaGFzRXJyICYmICF0YXNrLmhhc1Jlc3VsdCkKICAgICAgICAgICAgICAgICAgICAgICAgdGFzay5yZXN1bHQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGV2ID0gbmV3IE1lc3NhZ2VFdmVudCgibWVzc2FnZSIsIHsgZGF0YTogdGFzayB9KTsgLy8gbm90IGFjdHVhbGx5IHNlbmRpbmcsIHVzZSBhIGZha2UgcmVwbHkKICAgICAgICAgICAgICAgICAgICB0aGlzLm1zZ0hhbmRsZXIoZXYpOyAvLyB3b24ndCBhd2FpdAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZW5kVGFzayh0YXNrKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfQogICAgY29uc3RydWN0b3Iob3JpZ2luLCBwb3N0TWVzc2FnZSwgdGFza0hhbmRsZXIsIGRlc3Ryb3kpIHsKICAgICAgICB0aGlzLl9pc0FsaXZlID0gdHJ1ZTsKICAgICAgICB0aGlzLmlzSWRsZSA9IHRydWU7CiAgICAgICAgLy8gY29tcGFyaW5nIHRvIHN0cnVjdHVyZWQgY29weSAoYnkgZGVmYXVsdCksIGlmIGRhdGEgc2l6ZSBpcyBiaWcgKGJlY2F1c2Ugb2YgemVyby1jb3B5KSwKICAgICAgICAvLyB0cmFuc2ZlcnJpbmcgaXMgZ2VuZXJhbGx5IG11Y2ggZmFzdGVyLiBob3dldmVyIGl0IG9idmlvdXNseSBoYXMgYSBkcmF3YmFjaywKICAgICAgICAvLyB0aGF0IHRyYW5zZmVycmVkIGFyZ3VtZW50cyBhcmUgbm8gbG9uZ2VyIGFjY2Vzc2libGUgaW4gdGhlIHNlbmRlciB0aHJlYWQKICAgICAgICB0aGlzLnRyYW5zZmVyQXJncyA9IGZhbHNlOwogICAgICAgIC8vIHRoZSByZWNlaXZlci9jYWxsZWUgd2lsbCBhbHdheXMgdXNlIHRyYW5zZmVycmluZyB0byBzZW5kIGJhY2sgYXJndW1lbnRzLAogICAgICAgIC8vIG5vdCBzZW5kaW5nIHRoZSBhcmd1bWVudHMgYmFjayBpcyBzdXBwb3NlZCB0byBzYXZlIGEgbGl0dGxlIHRpbWUvb3ZlcmhlYWQKICAgICAgICB0aGlzLnJlcGx5QXJncyA9IGZhbHNlOwogICAgICAgIHRoaXMucXVldWUgPSBbXTsKICAgICAgICB0aGlzLl9sYXN0VGFza0lEID0gMDsKICAgICAgICB0aGlzLmNhbGxiYWNrcyA9IHt9OwogICAgICAgIHRoaXMub3JpZ2luID0gb3JpZ2luOwogICAgICAgIHRoaXMucG9zdE1lc3NhZ2UgPSBwb3N0TWVzc2FnZTsKICAgICAgICB0aGlzLnRhc2tIYW5kbGVyID0gdGFza0hhbmRsZXI7CiAgICAgICAgdGhpcy5kZXN0cm95ID0gZGVzdHJveTsKICAgIH0KICAgIGdldCBpc0FsaXZlKCkgewogICAgICAgIHJldHVybiB0aGlzLl9pc0FsaXZlOwogICAgfQogICAgLy8gdGhlc2UgZm9sbG93aW5nIHR3byBtZXRob2RzL2Z1bmN0aW9ucyBhcmUgc3VwcG9zZWQgdG8gYmUgY2FsbGJhY2tzCiAgICBtc2dIYW5kbGVyKGV2KSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbnN0IHRhc2sgPSBIQ0FUYXNrLnJlY3JlYXRlKGV2LmRhdGEpOwogICAgICAgICAgICAgICAgaWYgKHRhc2sub3JpZ2luICE9PSB0aGlzLm9yaWdpbikgewogICAgICAgICAgICAgICAgICAgIC8vIGluY29taW5nIGNtZCB0byBleGVjdXRlCiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFzay5yZXN1bHQgPSB5aWVsZCB0aGlzLnRhc2tIYW5kbGVyKHRhc2spOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBpdCdzIG9ic2VydmVkIHRoYXQgRmlyZWZveCByZWZ1c2VzIHRvIHBvc3RNZXNzYWdlIGFuIEVycm9yIG9iamVjdDoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gIkRhdGFDbG9uZUVycm9yOiBUaGUgb2JqZWN0IGNvdWxkIG5vdCBiZSBjbG9uZWQuIgogICAgICAgICAgICAgICAgICAgICAgICAvLyAob2JzZXJ2ZWQgaW4gRmlyZWZveCA5Nywgbm90IGNsZWFyIGFib3V0IG90aGVyIHZlcnNpb25zKQogICAgICAgICAgICAgICAgICAgICAgICAvLyBDaHJvbWUgZG9lc24ndCBzZWVtIHRvIGhhdmUgdGhpcyBwcm9ibGVtLAogICAgICAgICAgICAgICAgICAgICAgICAvLyBob3dldmVyLCBpbiBvcmRlciB0byBrZWVwIGNvbXBhdGlibGUgd2l0aCBGaXJlZm94LAogICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBzdGlsbCBoYXZlIHRvIGF2b2lkIHBvc3RpbmcgYW4gRXJyb3Igb2JqZWN0CiAgICAgICAgICAgICAgICAgICAgICAgIHRhc2suZXJyTXNnID0gYFske3RoaXMub3JpZ2lufV0gZXJyb3Igd2hlbiBleGVjdXRpbmcgY21kICR7dGFzay5jbWR9IGZyb20gJHt0YXNrLm9yaWdpbn1gOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGUgPT09ICJzdHJpbmciIHx8IGUgaW5zdGFuY2VvZiBFcnJvcikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhc2suZXJyTXNnICs9ICJcbiIgKyBlLnRvU3RyaW5nKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICh0YXNrLnRhc2tJRCAhPSBIQ0FUYXNrUXVldWUuZGlzY2FyZFJlcGx5VGFza0lEKQogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZW5kUmVwbHkodGFzayk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RoaXMub3JpZ2lufV0gc2VuZFJlcGx5IGZhaWxlZC5gLCBlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhc2suZXJyTXNnID0gKHRhc2suZXJyTXNnID09IG51bGwgPyAiIiA6IHRhc2suZXJyTXNnICsgIlxuXG4iKSArICJwb3N0TWVzc2FnZSBmcm9tIFdvcmtlciBmYWlsZWQiOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBlID09PSAic3RyaW5nIiB8fCBlIGluc3RhbmNlb2YgRXJyb3IpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFzay5lcnJNc2cgKz0gIlxuIiArIGUudG9TdHJpbmcoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRyeSBhZ2FpbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZW5kUmVwbHkodGFzayk7IC8vIGlmIGl0IHRocm93cywganVzdCBsZXQgaXQgdGhyb3cKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gcmVjZWl2aW5nIGNtZCByZXN1bHQKICAgICAgICAgICAgICAgICAgICAvLyBmaW5kICYgdW5yZWdpc3RlciBjYWxsYmFjawogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlZ2lzdGVyZWQgPSB0aGlzLmNhbGxiYWNrc1t0YXNrLnRhc2tJRF07CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuY2FsbGJhY2tzW3Rhc2sudGFza0lEXTsKICAgICAgICAgICAgICAgICAgICAvLyBhcHBseSBob29rCiAgICAgICAgICAgICAgICAgICAgbGV0IHJlc3VsdCA9IHRhc2suaGFzUmVzdWx0ID8gdGFzay5yZXN1bHQgOiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaG9vayA9IHJlZ2lzdGVyZWQuaG9vazsKICAgICAgICAgICAgICAgICAgICBpZiAoaG9vayAhPSBudWxsKQogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhc2suaGFzRXJyICYmIGhvb2suZXJyb3IgIT0gbnVsbCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB5aWVsZCBob29rLmVycm9yKHRhc2suZXJyTXNnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRhc2suaGFzUmVzdWx0ICYmIGhvb2sucmVzdWx0ICE9IG51bGwpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0geWllbGQgaG9vay5yZXN1bHQodGFzay5yZXN1bHQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRhc2suaGFzRXJyKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhc2suZXJyTXNnID0gIiI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXNrLmVyck1zZyArPSBgWyR7dGhpcy5vcmlnaW59XSBlcnJvciB3aGVuIGFwcGx5aW5nIGhvb2sgYAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICsgYGFmdGVyIGV4ZWN1dGluZyBjbWQgJHt0YXNrLmNtZH0gZnJvbSAke3Rhc2sub3JpZ2lufWA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGUgPT09ICJzdHJpbmciIHx8IGUgaW5zdGFuY2VvZiBFcnJvcikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXNrLmVyck1zZyArPSAiXG4iICsgZS50b1N0cmluZygpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy8gc2V0dGxlIHByb21pc2UKICAgICAgICAgICAgICAgICAgICBpZiAodGFzay5oYXNFcnIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVnaXN0ZXJlZC5yZWplY3QodGFzay5lcnJNc2cpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0YXNrLmhhc1Jlc3VsdCkgewogICAgICAgICAgICAgICAgICAgICAgICByZWdpc3RlcmVkLnJlc29sdmUocmVzdWx0KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHRhc2sgKG9yaWdpbj0ke3Rhc2sub3JpZ2lufSB0YXNrSUQ9JHt0YXNrLnRhc2tJRH0gY21kPSR7dGFzay5jbWR9KSBgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICArIGBoYXMgbmVpdGhlciBlcnJvciBub3IgcmVzdWx0YCk7IC8vIHNob3VsZCBuZXZlciBoYXBwZW4KICAgICAgICAgICAgICAgICAgICAvLyBzdGFydCBuZXh0IHRhc2sKICAgICAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLnNlbmROZXh0VGFzaygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAvLyBpcnJlY292ZXJhYmxlIGVycm9yCiAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLmVyckhhbmRsZXIoZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KICAgIGVyckhhbmRsZXIoZGF0YSkgewogICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAgIC8vIGlycmVjb3ZlcmFibGUgZXJyb3IKICAgICAgICAgICAgaWYgKHRoaXMuX2lzQWxpdmUpIHsKICAgICAgICAgICAgICAgIC8vIHByaW50IGVycm9yIG1lc3NhZ2UKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RoaXMub3JpZ2lufV0gZGVzdHJveWluZyBiYWNrZ3JvdW5kIHdvcmtlciBvbiBpcnJlY292ZXJhYmxlIGVycm9yYCwgZGF0YSk7CiAgICAgICAgICAgICAgICAvLyBkZXN0cm95IGJhY2tncm91bmQgd29ya2VyCiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHlpZWxkIHRoaXMuZGVzdHJveSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0aGlzLm9yaWdpbn1dIGVycm9yIHdoZW4gdHJ5aW5nIHRvIGRlc3Ryb3koKWAsIGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gYWZ0ZXIgZGVzdHJveSwgbWFyayBpc0FsaXZlIGFzIGZhbHNlIChvdGhlcndpc2Ugc2VuZENtZCB3aWxsIGZhaWwpCiAgICAgICAgICAgICAgICB0aGlzLl9pc0FsaXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAvLyByZWplY3QgYWxsIHBlbmRpbmcgcHJvbWlzZXMKICAgICAgICAgICAgICAgIGZvciAobGV0IHRhc2tJRCBpbiB0aGlzLmNhbGxiYWNrcykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlamVjdCA9IHRoaXMuY2FsbGJhY2tzW3Rhc2tJRF0ucmVqZWN0OwogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmNhbGxiYWNrc1t0YXNrSURdOwogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0aGlzLm9yaWdpbn1dIGVycm9yIHJlamVjdGluZyB0YXNrSUQ9JHt0YXNrSUR9YCwgZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CiAgICBnZXRUcmFuc2ZlckNvbmZpZygpIHsKICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuX2lzQWxpdmUpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImRlYWQiKTsKICAgICAgICAgICAgcmV0dXJuIHlpZWxkIHRoaXMuZXhlY0NtZCgibm9wIiwgW10sIHsKICAgICAgICAgICAgICAgIHJlc3VsdDogKCkgPT4gKHsKICAgICAgICAgICAgICAgICAgICB0cmFuc2ZlckFyZ3M6IHRoaXMudHJhbnNmZXJBcmdzLAogICAgICAgICAgICAgICAgICAgIHJlcGx5QXJnczogdGhpcy5yZXBseUFyZ3MKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgfQogICAgY29uZmlnVHJhbnNmZXIodHJhbnNmZXJBcmdzLCByZXBseUFyZ3MpIHsKICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuX2lzQWxpdmUpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImRlYWQiKTsKICAgICAgICAgICAgcmV0dXJuIHlpZWxkIHRoaXMuZXhlY0NtZCgibm9wIiwgW10sIHsKICAgICAgICAgICAgICAgIHJlc3VsdDogKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRoaXMudHJhbnNmZXJBcmdzID0gdHJhbnNmZXJBcmdzID8gdHJ1ZSA6IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMucmVwbHlBcmdzID0gcmVwbHlBcmdzID8gdHJ1ZSA6IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgIH0KICAgIGV4ZWNDbWQoY21kLCBhcmdzLCBob29rKSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgLy8gY2FuIGJlIG1vZGlmaWVkIHRvIHNpbXBseSB3cmFwIGV4ZWNNdWx0aUNtZCBidXQgSSBqdXN0IHdhbnQgdG8gbGV0IGl0IGFsb25lIGZvciBubyBzcGVjaWFsIHJlYXNvbgogICAgICAgICAgICBpZiAoIXRoaXMuX2lzQWxpdmUpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImRlYWQiKTsKICAgICAgICAgICAgLy8gYXNzaWduIG5ldyB0YXNrSUQKICAgICAgICAgICAgY29uc3QgdGFza0lEID0gdGhpcy5nZXROZXh0VGFza0lEKCk7CiAgICAgICAgICAgIGNvbnN0IHRhc2sgPSBuZXcgSENBVGFzayh0aGlzLm9yaWdpbiwgdGFza0lELCBjbWQsIGFyZ3MsIHRoaXMucmVwbHlBcmdzKTsKICAgICAgICAgICAgLy8gcmVnaXN0ZXIgY2FsbGJhY2sKICAgICAgICAgICAgaWYgKHRoaXMuY2FsbGJhY2tzW3Rhc2tJRF0gIT0gbnVsbCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgdGFza0lEPSR7dGFza0lEfSBpcyBhbHJlYWR5IG9jY3VwaWVkYCk7CiAgICAgICAgICAgIGNvbnN0IHJlc3VsdFByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB0aGlzLmNhbGxiYWNrc1t0YXNrSURdID0gewogICAgICAgICAgICAgICAgcmVzb2x2ZTogcmVzb2x2ZSwgcmVqZWN0OiByZWplY3QsCiAgICAgICAgICAgICAgICBob29rOiBob29rCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAvLyBhcHBlbmQgdG8gY29tbWFuZCBxdWV1ZQogICAgICAgICAgICB0aGlzLnF1ZXVlLnB1c2godGFzayk7CiAgICAgICAgICAgIC8vIHN0YXJ0IGV4ZWN1dGluZyB0YXNrcwogICAgICAgICAgICBpZiAodGhpcy5pc0lkbGUpCiAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLnNlbmROZXh0VGFzaygpOwogICAgICAgICAgICAvLyByZXR1cm4gcmVzdWx0CiAgICAgICAgICAgIHJldHVybiB5aWVsZCByZXN1bHRQcm9taXNlOwogICAgICAgIH0pOwogICAgfQogICAgZXhlY011bHRpQ21kKGNtZExpc3QpIHsKICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgICAvLyB0aGUgcG9pbnQgaXMgdG8gZW5zdXJlICJhdG9taWNpdHkiIGJldHdlZW4gY21kcwogICAgICAgICAgICBpZiAoIXRoaXMuX2lzQWxpdmUpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImRlYWQiKTsKICAgICAgICAgICAgbGV0IHJlc3VsdFByb21pc2VzID0gW107CiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY21kTGlzdC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgLy8gYXNzaWduIG5ldyB0YXNrSUQKICAgICAgICAgICAgICAgIGNvbnN0IHRhc2tJRCA9IHRoaXMuZ2V0TmV4dFRhc2tJRCgpOwogICAgICAgICAgICAgICAgY29uc3QgbGlzdEl0ZW0gPSBjbWRMaXN0W2ldOwogICAgICAgICAgICAgICAgY29uc3QgdGFzayA9IG5ldyBIQ0FUYXNrKHRoaXMub3JpZ2luLCB0YXNrSUQsIGxpc3RJdGVtLmNtZCwgbGlzdEl0ZW0uYXJncywgdGhpcy5yZXBseUFyZ3MpOwogICAgICAgICAgICAgICAgLy8gcmVnaXN0ZXIgY2FsbGJhY2sKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbGxiYWNrc1t0YXNrSURdICE9IG51bGwpCiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGB0YXNrSUQ9JHt0YXNrSUR9IGlzIGFscmVhZHkgb2NjdXBpZWRgKTsKICAgICAgICAgICAgICAgIHJlc3VsdFByb21pc2VzLnB1c2gobmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gdGhpcy5jYWxsYmFja3NbdGFza0lEXSA9IHsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlOiByZXNvbHZlLCByZWplY3Q6IHJlamVjdCwKICAgICAgICAgICAgICAgICAgICBob29rOiBsaXN0SXRlbS5ob29rCiAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgICAgICAvLyBhcHBlbmQgdG8gY29tbWFuZCBxdWV1ZQogICAgICAgICAgICAgICAgdGhpcy5xdWV1ZS5wdXNoKHRhc2spOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIHN0YXJ0IGV4ZWN1dGluZyB0YXNrcwogICAgICAgICAgICBpZiAodGhpcy5pc0lkbGUpCiAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLnNlbmROZXh0VGFzaygpOwogICAgICAgICAgICAvLyByZXR1cm4gcmVzdWx0cwogICAgICAgICAgICByZXR1cm4geWllbGQgUHJvbWlzZS5hbGwocmVzdWx0UHJvbWlzZXMpOwogICAgICAgIH0pOwogICAgfQogICAgc2VuZENtZChjbWQsIGFyZ3MpIHsKICAgICAgICAvLyBzZW5kIGNtZCB3aXRob3V0IHJlZ2lzdGVyaW5nIGNhbGxiYWNrCiAgICAgICAgLy8gZ2VuZXJhbGx5IG5vdCByZWNvbW1lbmRlZAogICAgICAgIGlmICghdGhpcy5faXNBbGl2ZSkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJkZWFkIik7CiAgICAgICAgY29uc3QgdGFzayA9IG5ldyBIQ0FUYXNrKHRoaXMub3JpZ2luLCBIQ0FUYXNrUXVldWUuZGlzY2FyZFJlcGx5VGFza0lELCBjbWQsIGFyZ3MsIGZhbHNlKTsKICAgICAgICB0aGlzLnNlbmRUYXNrKHRhc2spOwogICAgfQogICAgc2h1dGRvd24oZm9yY2libHkgPSBmYWxzZSkgewogICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLl9pc0FsaXZlKSB7CiAgICAgICAgICAgICAgICBpZiAoZm9yY2libHkpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGhpcy5vcmlnaW59XSBlcnJvciB3aGVuIHRyeWluZyB0byBmb3JjaWJseSBzaHV0ZG93bi5gLCBlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faXNBbGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIHlpZWxkIHRoaXMuZXhlY0NtZCgibm9wIiwgW10sIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0OiAoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2lzQWxpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfQp9CkhDQVRhc2tRdWV1ZS5tYXhUYXNrSUQgPSAyNTY7IC8vIHRoZXJlJ3MgcmVjdXJzaW9uIGluIHNlbmROZXh0VGFzayB3aGVuIG1ha2luZyBmYWtlIHJlcGx5CkhDQVRhc2tRdWV1ZS5kaXNjYXJkUmVwbHlUYXNrSUQgPSAtMTsKaWYgKHR5cGVvZiBkb2N1bWVudCA9PT0gInVuZGVmaW5lZCIpIHsKICAgIGlmICh0eXBlb2Ygb25tZXNzYWdlID09PSAidW5kZWZpbmVkIikgewogICAgICAgIC8vIEF1ZGlvV29ya2xldAogICAgICAgIGNsYXNzIEhDQUZyYW1lUGxheWVyQ29udGV4dCB7CiAgICAgICAgICAgIGdldCBpc1N0YWxsaW5nKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2lzU3RhbGxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2V0IGlzU3RhbGxpbmcodmFsKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9pc1N0YWxsaW5nID0gdmFsOwogICAgICAgICAgICAgICAgaWYgKHZhbCkKICAgICAgICAgICAgICAgICAgICB0aGlzLm9uY2VTdGFsbGVkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdHJ1Y3Rvcihwcm9jT3B0cykgewogICAgICAgICAgICAgICAgdGhpcy5pc1BsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuZGVmYXVsdFB1bGxCbG9ja0NvdW50ID0gMTI4OwogICAgICAgICAgICAgICAgdGhpcy5mYWlsZWRCbG9ja3MgPSBbXTsKICAgICAgICAgICAgICAgIHRoaXMucHJpbnRFcnJvckNvdW50RG93bkZyb20gPSAyNTY7CiAgICAgICAgICAgICAgICB0aGlzLnByaW50RXJyb3JDb3VudERvd24gPSB0aGlzLnByaW50RXJyb3JDb3VudERvd25Gcm9tOwogICAgICAgICAgICAgICAgdGhpcy50b3RhbFB1bGxlZEJsb2NrQ291bnQgPSAwOwogICAgICAgICAgICAgICAgdGhpcy5pc1B1bGxpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuX2lzU3RhbGxpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMub25jZVN0YWxsZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuc2FtcGxlT2Zmc2V0ID0gMDsKICAgICAgICAgICAgICAgIHRoaXMubGFzdERlY29kZWRCbG9ja0luZGV4ID0gLTE7CiAgICAgICAgICAgICAgICB0aGlzLmZyYW1lID0gbmV3IEhDQUZyYW1lKG5ldyBIQ0FJbmZvKHByb2NPcHRzLnJhd0hlYWRlcikpOwogICAgICAgICAgICAgICAgY29uc3QgaW5mbyA9IHRoaXMuZnJhbWUuSGNhOwogICAgICAgICAgICAgICAgY29uc3QgaGFzTG9vcCA9IGluZm8uaGFzSGVhZGVyWyJsb29wIl0gPyB0cnVlIDogZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHByb2NPcHRzLnB1bGxCbG9ja0NvdW50ID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgICAgIGlmIChpc05hTihwcm9jT3B0cy5wdWxsQmxvY2tDb3VudCkpCiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgICAgICAgICAgICAgIGxldCBwdWxsQmxvY2tDb3VudCA9IE1hdGguZmxvb3IocHJvY09wdHMucHVsbEJsb2NrQ291bnQpOwogICAgICAgICAgICAgICAgICAgIGlmIChwdWxsQmxvY2tDb3VudCA8IDIpCiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgICAgICAgICAgICAgIHRoaXMucHVsbEJsb2NrQ291bnQgPSBwdWxsQmxvY2tDb3VudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICB0aGlzLnB1bGxCbG9ja0NvdW50ID0gdGhpcy5kZWZhdWx0UHVsbEJsb2NrQ291bnQ7CiAgICAgICAgICAgICAgICBjb25zdCBidWZmZXJlZEJsb2NrQ291bnQgPSBoYXNMb29wID8gKGluZm8ubG9vcC5lbmQgKyAxKSA6IHRoaXMucHVsbEJsb2NrQ291bnQgKiAyOwogICAgICAgICAgICAgICAgdGhpcy5lbmNvZGVkID0gbmV3IFVpbnQ4QXJyYXkoaW5mby5ibG9ja1NpemUgKiBidWZmZXJlZEJsb2NrQ291bnQpOwogICAgICAgICAgICAgICAgdGhpcy5kZWNvZGVkID0gQXJyYXkuZnJvbSh7IGxlbmd0aDogaW5mby5mb3JtYXQuY2hhbm5lbENvdW50IH0sICgpID0+IG5ldyBGbG9hdDMyQXJyYXkoSENBRnJhbWUuU2FtcGxlc1BlckZyYW1lICogMikpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNsYXNzIEhDQUZyYW1lUGxheWVyIGV4dGVuZHMgQXVkaW9Xb3JrbGV0UHJvY2Vzc29yIHsKICAgICAgICAgICAgY29uc3RydWN0b3Iob3B0aW9ucykgewogICAgICAgICAgICAgICAgc3VwZXIoKTsKICAgICAgICAgICAgICAgIHRoaXMudW5zZXR0bGVkID0gW107CiAgICAgICAgICAgICAgICB0aGlzLndhaXRDb3VudERvd25Gcm9tID0gMzI7CiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucyA9PSBudWxsIHx8IG9wdGlvbnMucHJvY2Vzc29yT3B0aW9ucyA9PSBudWxsKQogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgICAgICAgICAgdGhpcy5jdHggPSBuZXcgSENBRnJhbWVQbGF5ZXJDb250ZXh0KG9wdGlvbnMucHJvY2Vzc29yT3B0aW9ucyk7CiAgICAgICAgICAgICAgICB0aGlzLnRhc2tRdWV1ZSA9IG5ldyBIQ0FUYXNrUXVldWUoIkJhY2tncm91bmQtSENBRnJhbWVQbGF5ZXIiLCAobXNnLCB0cmFucykgPT4gdGhpcy5wb3J0LnBvc3RNZXNzYWdlKG1zZywgdHJhbnMpLCAodGFzaykgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgICAgICAgICAgIHN3aXRjaCAodGFzay5jbWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAibm9wIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiaW5pdGlhbGl6ZSI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmN0eCA9IG5ldyBIQ0FGcmFtZVBsYXllckNvbnRleHQodGFzay5hcmdzWzBdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJyZXNldCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB5aWVsZCBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmN0eDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVuc2V0dGxlZC5wdXNoKHsgcmVzb2x2ZTogcmVzb2x2ZSwgY291bnRlcjogdGhpcy53YWl0Q291bnREb3duRnJvbSB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInBhdXNlIjoKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAicmVzdW1lIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmN0eCA9PSBudWxsKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgbm90IGluaXRpYWxpemVkYCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmN0eC5pc1BsYXlpbmcgPSB0YXNrLmNtZCA9PT0gInJlc3VtZSI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuY3R4LmlzUGxheWluZykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB5aWVsZCBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVuc2V0dGxlZC5wdXNoKHsgcmVzb2x2ZTogcmVzb2x2ZSwgY291bnRlcjogdGhpcy53YWl0Q291bnREb3duRnJvbSB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGB1bmtub3duIGNtZCAke3Rhc2suY21kfWApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pLCAoKSA9PiB7IHRoaXMudGFza1F1ZXVlLnNlbmRDbWQoInNlbGYtZGVzdHJ1Y3QiLCBbXSk7IH0pOwogICAgICAgICAgICAgICAgdGhpcy50YXNrUXVldWUuY29uZmlnVHJhbnNmZXIodHJ1ZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgdGhpcy5wb3J0Lm9ubWVzc2FnZSA9IChldikgPT4gdGhpcy50YXNrUXVldWUubXNnSGFuZGxlcihldik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaGFuZGxlTmV3QmxvY2tzKGN0eCwgbmV3QmxvY2tzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBpbmZvID0gY3R4LmZyYW1lLkhjYTsKICAgICAgICAgICAgICAgIGNvbnN0IGhhc0xvb3AgPSBpbmZvLmhhc0hlYWRlclsibG9vcCJdID8gdHJ1ZSA6IGZhbHNlOwogICAgICAgICAgICAgICAgY29uc3QgcHVsbEJsb2NrQ291bnQgPSBjdHgucHVsbEJsb2NrQ291bnQ7CiAgICAgICAgICAgICAgICBjb25zdCBlbmNvZGVkID0gY3R4LmVuY29kZWQ7CiAgICAgICAgICAgICAgICBpZiAobmV3QmxvY2tzLmxlbmd0aCAlIGluZm8uYmxvY2tTaXplICE9IDApIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYG5ld0Jsb2Nrcy5sZW5ndGg9JHtuZXdCbG9ja3MubGVuZ3RofSBzaG91bGQgYmUgbXVsdGlwbGUgb2YgYmxvY2tTaXplYCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zdCBuZXdCbG9ja0NvdW50ID0gbmV3QmxvY2tzLmxlbmd0aCAvIGluZm8uYmxvY2tTaXplOwogICAgICAgICAgICAgICAgY29uc3QgZXhwZWN0ZWQgPSBpbmZvLmJsb2NrU2l6ZSAqIHB1bGxCbG9ja0NvdW50OwogICAgICAgICAgICAgICAgaWYgKGhhc0xvb3ApIHsKICAgICAgICAgICAgICAgICAgICBsZXQgZW5jb2RlZE9mZnNldCA9IGluZm8uYmxvY2tTaXplICogY3R4LnRvdGFsUHVsbGVkQmxvY2tDb3VudDsKICAgICAgICAgICAgICAgICAgICBpZiAoZW5jb2RlZE9mZnNldCArIG5ld0Jsb2Nrcy5sZW5ndGggPiBlbmNvZGVkLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGhhcyBsb29wIGhlYWRlciwgYnVmZmVyIHdpbGwgb3ZlcmZsb3dgKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZW5jb2RlZC5zZXQobmV3QmxvY2tzLCBlbmNvZGVkT2Zmc2V0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmIChuZXdCbG9ja3MubGVuZ3RoICE9IGV4cGVjdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgbm8gbG9vcCBoZWFkZXIsIG5ld0Jsb2Nrcy5sZW5ndGggKCR7bmV3QmxvY2tzLmxlbmd0aH0pICE9IGV4cGVjdGVkICgke2V4cGVjdGVkfSlgKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChjdHgudG90YWxQdWxsZWRCbG9ja0NvdW50ICUgKHB1bGxCbG9ja0NvdW50ICogMikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5jb2RlZC5zZXQobmV3QmxvY2tzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBjYXNlIHB1bGxCbG9ja0NvdW50OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5jb2RlZC5zZXQobmV3QmxvY2tzLCBleHBlY3RlZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN0eC50b3RhbFB1bGxlZEJsb2NrQ291bnQgKz0gbmV3QmxvY2tDb3VudDsKICAgICAgICAgICAgICAgIGN0eC5pc1B1bGxpbmcgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwdWxsTmV3QmxvY2tzKGN0eCkgewogICAgICAgICAgICAgICAgLy8gaWYgY3R4IHBhc3NlZCBpbiBoYWQgYmVlbiBhY3R1YWxseSBkZWxldGVkLCBpdCB3b24ndCBhZmZlY3QgdGhlIGN1cnJlbnQgdXNpbmcgY3R4CiAgICAgICAgICAgICAgICBpZiAoY3R4LmlzUHVsbGluZykKICAgICAgICAgICAgICAgICAgICByZXR1cm47IC8vIGFscmVhZHkgcHVsbGluZy4gd2lsbCBiZSBjYWxsZWQgYWdhaW4gaWYgc3RpbGwgbm90IGVub3VnaAogICAgICAgICAgICAgICAgY3R4LmlzUHVsbGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAvLyByZXF1ZXN0IHRvIHB1bGwgJiBjb250aW51ZSBkZWNvZGluZwogICAgICAgICAgICAgICAgdGhpcy50YXNrUXVldWUuZXhlY0NtZCgicHVsbCIsIFtdLCB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0OiAobmV3QmxvY2tzKSA9PiB0aGlzLmhhbmRsZU5ld0Jsb2NrcyhjdHgsIG5ld0Jsb2NrcyksCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICgpID0+IHsgY3R4LmlzUHVsbGluZyA9IGZhbHNlOyB9LAogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAuY2F0Y2goKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oYHB1bGxOZXdCbG9ja3MgZmFpbGVkLmAsIGUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd3JpdGVUb0RlY29kZWRCdWZmZXIoZnJhbWUsIGRlY29kZWQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGhhbGZTaXplID0gSENBRnJhbWUuU2FtcGxlc1BlckZyYW1lOwogICAgICAgICAgICAgICAgZm9yIChsZXQgYyA9IDA7IGMgPCBmcmFtZS5DaGFubmVscy5sZW5ndGg7IGMrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpcnN0SGFsZiA9IGRlY29kZWRbY10uc3ViYXJyYXkoMCwgaGFsZlNpemUpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGxhc3RIYWxmID0gZGVjb2RlZFtjXS5zdWJhcnJheShoYWxmU2l6ZSwgaGFsZlNpemUgKiAyKTsKICAgICAgICAgICAgICAgICAgICBmaXJzdEhhbGYuc2V0KGxhc3RIYWxmKTsKICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBzZiA9IDAsIG9mZnNldCA9IDA7IHNmIDwgSENBRnJhbWUuU3ViZnJhbWVzUGVyRnJhbWU7IHNmKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEhhbGYuc2V0KGZyYW1lLkNoYW5uZWxzW2NdLlBjbUZsb2F0W3NmXSwgb2Zmc2V0KTsKICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0ICs9IEhDQUZyYW1lLlNhbXBsZXNQZXJTdWJGcmFtZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsYXN0SGFsZi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobGFzdEhhbGZbaV0gPiAxKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEhhbGZbaV0gPSAxOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChsYXN0SGFsZltpXSA8IC0xKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEhhbGZbaV0gPSAtMTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbWFwVG9Vbkxvb3BlZChpbmZvLCBzYW1wbGVPZmZzZXQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGhhc0xvb3AgPSBpbmZvLmhhc0hlYWRlclsibG9vcCJdID8gdHJ1ZSA6IGZhbHNlOwogICAgICAgICAgICAgICAgaWYgKHNhbXBsZU9mZnNldCA8PSBpbmZvLmVuZEF0U2FtcGxlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNhbXBsZU9mZnNldDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmIChoYXNMb29wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBvZmZzZXQgPSAoc2FtcGxlT2Zmc2V0IC0gaW5mby5sb29wU3RhcnRBdFNhbXBsZSkgJSBpbmZvLmxvb3BTYW1wbGVDb3VudDsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGluZm8ubG9vcFN0YXJ0QXRTYW1wbGUgKyBvZmZzZXQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaW5mby5lbmRBdFNhbXBsZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHJvY2VzcyhpbnB1dHMsIG91dHB1dHMsIHBhcmFtZXRlcnMpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmN0eCA9PSBudWxsIHx8ICF0aGlzLmN0eC5pc1BsYXlpbmcpIHsKICAgICAgICAgICAgICAgICAgICAvLyB3b3JrYXJvdW5kIHRoZSAicmVzaWR1ZSIgYnVyc3Qgbm9pc2UgaXNzdWUgaW4gQ2hyb21lCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdW5zZXR0bGVkID0gdGhpcy51bnNldHRsZWQuc2hpZnQoKTsKICAgICAgICAgICAgICAgICAgICBpZiAodW5zZXR0bGVkICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKC0tdW5zZXR0bGVkLmNvdW50ZXIgPiAwKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy51bnNldHRsZWQudW5zaGlmdCh1bnNldHRsZWQpOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVuc2V0dGxlZC5yZXNvbHZlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYGVycm9yIHdoZW4gc2V0dGxpbmcgcHJvbWlzZSBvZiAicmVzZXQiIG9yICJzZXRQbGF5aW5nIiBjbWRgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7IC8vIHdhaXQgZm9yIG5ldyBzb3VyY2Ugb3IgcmVzdW1lCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy5jdHguZmFpbGVkQmxvY2tzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jdHguZmFpbGVkQmxvY2tzLmxlbmd0aCA+PSA2NCB8fCAtLXRoaXMuY3R4LnByaW50RXJyb3JDb3VudERvd24gPD0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBlcnJvciBkZWNvZGluZyBmb2xsb3dpbmcgYmxvY2tzYCwgdGhpcy5jdHguZmFpbGVkQmxvY2tzLCB0aGlzLmN0eC5sYXN0RXJyb3IpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmN0eC5mYWlsZWRCbG9ja3MgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jdHgubGFzdEVycm9yID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmN0eC5wcmludEVycm9yQ291bnREb3duID0gdGhpcy5jdHgucHJpbnRFcnJvckNvdW50RG93bkZyb207CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc3Qgb3V0cHV0ID0gb3V0cHV0c1swXTsKICAgICAgICAgICAgICAgIGNvbnN0IHJlbmRlclF1YW50dW1TaXplID0gb3V0cHV0WzBdLmxlbmd0aDsKICAgICAgICAgICAgICAgIGNvbnN0IHNhbXBsZXNQZXJCbG9jayA9IEhDQUZyYW1lLlNhbXBsZXNQZXJGcmFtZTsKICAgICAgICAgICAgICAgIC8vIG5vIG1vcmUgdGhhbiBvbmUgYmxvY2sgd2lsbCBiZSBkZWNvZGVkIGVhY2ggdGltZSB0aGlzIGZ1bmN0aW9uIGJlaW5nIGNhbGxlZCwKICAgICAgICAgICAgICAgIC8vIHRoZXJlZm9yZSBvbmUgYmxvY2sgbXVzdCBjb3ZlciB0aGUgd2hvbGUgcmVuZGVyUXVhbnR1bVNpemUKICAgICAgICAgICAgICAgIGlmIChzYW1wbGVzUGVyQmxvY2sgPCByZW5kZXJRdWFudHVtU2l6ZSkKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInJlbmRlciBxdWFudHVtIHJlcXVpcmVzIG1vcmUgc2FtcGxlIHRoYW4gYSBmdWxsIGJsb2NrIik7CiAgICAgICAgICAgICAgICBjb25zdCBpbmZvID0gdGhpcy5jdHguZnJhbWUuSGNhOwogICAgICAgICAgICAgICAgY29uc3QgaGFzTG9vcCA9IGluZm8uaGFzSGVhZGVyWyJsb29wIl0gPyB0cnVlIDogZmFsc2U7CiAgICAgICAgICAgICAgICBjb25zdCBlbmNvZGVkID0gdGhpcy5jdHguZW5jb2RlZDsKICAgICAgICAgICAgICAgIGNvbnN0IGRlY29kZWQgPSB0aGlzLmN0eC5kZWNvZGVkOwogICAgICAgICAgICAgICAgLy8gc2tpcCBkcm9wcGVkSGVhZGVyCiAgICAgICAgICAgICAgICBpZiAodGhpcy5jdHguc2FtcGxlT2Zmc2V0IDwgaW5mby5mb3JtYXQuZHJvcHBlZEhlYWRlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY3R4LnNhbXBsZU9mZnNldCA9IGluZm8uZm9ybWF0LmRyb3BwZWRIZWFkZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy5jdHguc2FtcGxlT2Zmc2V0ID49IGluZm8uZW5kQXRTYW1wbGUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaGFzTG9vcCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyByZXdpbmQgYmFjayBpZiBiZXlvbmQgbG9vcCBlbmQKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jdHguc2FtcGxlT2Zmc2V0ID0gdGhpcy5tYXBUb1VuTG9vcGVkKGluZm8sIHRoaXMuY3R4LnNhbXBsZU9mZnNldCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBub3RoaW5nIG1vcmUgdG8gcGxheQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRhc2tRdWV1ZS5zZW5kQ21kKCJlbmQiLCBbXSk7IC8vIG5vdCB3YWl0aW5nIGZvciByZXN1bHQKICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuY3R4OyAvLyBhdm9pZCBzZW5kaW5nICJlbmQiIGNtZCBmb3IgbW9yZSB0aGFuIG9uZSB0aW1lCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIGRlY29kZSBibG9jayAmIHB1bGwgbmV3IGJsb2NrIChpZiBuZWVkZWQpCiAgICAgICAgICAgICAgICBjb25zdCBtYXBwZWRTdGFydE9mZnNldCA9IHRoaXMubWFwVG9Vbkxvb3BlZChpbmZvLCB0aGlzLmN0eC5zYW1wbGVPZmZzZXQpOwogICAgICAgICAgICAgICAgY29uc3QgbWFwcGVkRW5kT2Zmc2V0ID0gdGhpcy5tYXBUb1VuTG9vcGVkKGluZm8sIHRoaXMuY3R4LnNhbXBsZU9mZnNldCArIHJlbmRlclF1YW50dW1TaXplKTsKICAgICAgICAgICAgICAgIGNvbnN0IGluQmxvY2tTdGFydE9mZnNldCA9IG1hcHBlZFN0YXJ0T2Zmc2V0ICUgc2FtcGxlc1BlckJsb2NrOwogICAgICAgICAgICAgICAgY29uc3QgaW5CbG9ja0VuZE9mZnNldCA9IG1hcHBlZEVuZE9mZnNldCAlIHNhbXBsZXNQZXJCbG9jazsKICAgICAgICAgICAgICAgIGNvbnN0IHN0YXJ0QmxvY2tJbmRleCA9IChtYXBwZWRTdGFydE9mZnNldCAtIGluQmxvY2tTdGFydE9mZnNldCkgLyBzYW1wbGVzUGVyQmxvY2s7CiAgICAgICAgICAgICAgICBjb25zdCBlbmRCbG9ja0luZGV4ID0gKG1hcHBlZEVuZE9mZnNldCAtIGluQmxvY2tFbmRPZmZzZXQpIC8gc2FtcGxlc1BlckJsb2NrOwogICAgICAgICAgICAgICAgaWYgKGVuZEJsb2NrSW5kZXggIT0gdGhpcy5jdHgubGFzdERlY29kZWRCbG9ja0luZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVuZEJsb2NrSW5kZXggPCB0aGlzLmN0eC50b3RhbFB1bGxlZEJsb2NrQ291bnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYmxvY2sgaXMgYXZhaWxhYmxlIGZvciBkZWNvZGluZwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmN0eC5pc1N0YWxsaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzdGFydCA9IGluZm8uYmxvY2tTaXplICogKGhhc0xvb3AKICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gZW5kQmxvY2tJbmRleAogICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBlbmRCbG9ja0luZGV4ICUgKHRoaXMuY3R4LnB1bGxCbG9ja0NvdW50ICogMikpOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgZW5kID0gc3RhcnQgKyBpbmZvLmJsb2NrU2l6ZTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVuZCA+IGVuY29kZWQubGVuZ3RoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJibG9jayBlbmQgb2Zmc2V0IGV4Y2VlZHMgYnVmZmVyIHNpemUiKTsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEhDQS5kZWNvZGVCbG9jayh0aGlzLmN0eC5mcmFtZSwgZW5jb2RlZC5zdWJhcnJheShzdGFydCwgZW5kKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY3R4LmZhaWxlZEJsb2Nrcy5wdXNoKGVuZEJsb2NrSW5kZXgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jdHgubGFzdEVycm9yID0gZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY3R4LmZyYW1lLkNoYW5uZWxzLmZvckVhY2goKGMpID0+IHsgYy5QY21GbG9hdC5mb3JFYWNoKChzZikgPT4gc2YuZmlsbCgwKSk7IH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMud3JpdGVUb0RlY29kZWRCdWZmZXIodGhpcy5jdHguZnJhbWUsIHRoaXMuY3R4LmRlY29kZWQpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmN0eC5sYXN0RGVjb2RlZEJsb2NrSW5kZXggPSBlbmRCbG9ja0luZGV4OwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jdHgudG90YWxQdWxsZWRCbG9ja0NvdW50IDwgKGhhc0xvb3AgPyBpbmZvLmxvb3AuZW5kIDogaW5mby5mb3JtYXQuYmxvY2tDb3VudCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHB1bGwgYmxvY2tzIGluIGFkdmFuY2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhdmFpbGFibGVCbG9ja0NvdW50ID0gaGFzTG9vcCAmJiB0aGlzLmN0eC50b3RhbFB1bGxlZEJsb2NrQ291bnQgPj0gaW5mby5sb29wLmVuZCArIDEKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/ICJhbGxfcHVsbGVkIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogdGhpcy5jdHgudG90YWxQdWxsZWRCbG9ja0NvdW50IC0gKHRoaXMuY3R4Lmxhc3REZWNvZGVkQmxvY2tJbmRleCArIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBhdmFpbGFibGVCbG9ja0NvdW50ID09PSAnbnVtYmVyJyAmJiBhdmFpbGFibGVCbG9ja0NvdW50IDwgdGhpcy5jdHgucHVsbEJsb2NrQ291bnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnB1bGxOZXdCbG9ja3ModGhpcy5jdHgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBibG9jayBpcyB1bmF2YWlsYWJsZQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuY3R4LmlzU3RhbGxpbmcgJiYgdGhpcy5jdHgub25jZVN0YWxsZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHByaW50IGVycm9yIGFib3V0IHN0YWxsaW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oYFtIQ0FGcmFtZVBsYXllcl0gd2FpdGluZyB1bnRpbCBibG9jayAke2VuZEJsb2NrSW5kZXh9IGJlY29tZSBhdmFpbGFibGUuLi5gKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmN0eC5pc1N0YWxsaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wdWxsTmV3QmxvY2tzKHRoaXMuY3R4KTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gY29weSBkZWNvZGVkIGRhdGEKICAgICAgICAgICAgICAgIGlmIChvdXRwdXQubGVuZ3RoICE9IGluZm8uZm9ybWF0LmNoYW5uZWxDb3VudCkKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImNoYW5uZWwgY291bnQgbWlzbWF0Y2giKTsKICAgICAgICAgICAgICAgIGNvbnN0IGluQnVmZmVyU3RhcnRPZmZzZXQgPSAoZW5kQmxvY2tJbmRleCAhPSBzdGFydEJsb2NrSW5kZXggPyAwIDogc2FtcGxlc1BlckJsb2NrKSArIGluQmxvY2tTdGFydE9mZnNldDsKICAgICAgICAgICAgICAgIGNvbnN0IGluQnVmZmVyRW5kT2Zmc2V0ID0gc2FtcGxlc1BlckJsb2NrICsgaW5CbG9ja0VuZE9mZnNldDsKICAgICAgICAgICAgICAgIGNvbnN0IGluQnVmZmVyU3JjU2l6ZSA9IGluQnVmZmVyRW5kT2Zmc2V0IC0gaW5CdWZmZXJTdGFydE9mZnNldDsKICAgICAgICAgICAgICAgIGlmIChpbkJ1ZmZlclNyY1NpemUgPD0gMCkKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInNpemUgaW4gZGVjb2RlZCBidWZmZXIgc2hvdWxkIGJlIHBvc2l0aXZlIik7CiAgICAgICAgICAgICAgICBjb25zdCBjb3B5U2l6ZSA9IE1hdGgubWluKGluQnVmZmVyU3JjU2l6ZSwgcmVuZGVyUXVhbnR1bVNpemUpOwogICAgICAgICAgICAgICAgZm9yIChsZXQgY2hhbm5lbCA9IDA7IGNoYW5uZWwgPCBvdXRwdXQubGVuZ3RoOyBjaGFubmVsKyspIHsKICAgICAgICAgICAgICAgICAgICBsZXQgc3JjID0gZGVjb2RlZFtjaGFubmVsXS5zdWJhcnJheShpbkJ1ZmZlclN0YXJ0T2Zmc2V0LCBpbkJ1ZmZlclN0YXJ0T2Zmc2V0ICsgY29weVNpemUpOwogICAgICAgICAgICAgICAgICAgIG91dHB1dFtjaGFubmVsXS5zZXQoc3JjKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuY3R4LnNhbXBsZU9mZnNldCArPSBjb3B5U2l6ZTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJlZ2lzdGVyUHJvY2Vzc29yKCJoY2EtZnJhbWUtcGxheWVyIiwgSENBRnJhbWVQbGF5ZXIpOwogICAgfQogICAgZWxzZSB7CiAgICAgICAgLy8gV2ViIFdvcmtlcgogICAgICAgIGNvbnN0IHRhc2tRdWV1ZSA9IG5ldyBIQ0FUYXNrUXVldWUoIkJhY2tncm91bmQtSENBV29ya2VyIiwgKG1zZywgdHJhbnMpID0+IHBvc3RNZXNzYWdlKG1zZywgdHJhbnMpLCAodGFzaykgPT4gewogICAgICAgICAgICBzd2l0Y2ggKHRhc2suY21kKSB7CiAgICAgICAgICAgICAgICBjYXNlICJub3AiOgogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIGNhc2UgImZpeEhlYWRlckNoZWNrc3VtIjoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gSENBSW5mby5maXhIZWFkZXJDaGVja3N1bS5hcHBseShIQ0FJbmZvLCB0YXNrLmFyZ3MpOwogICAgICAgICAgICAgICAgY2FzZSAiZml4Q2hlY2tzdW0iOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBIQ0EuZml4Q2hlY2tzdW0uYXBwbHkoSENBLCB0YXNrLmFyZ3MpOwogICAgICAgICAgICAgICAgY2FzZSAiZGVjcnlwdCI6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEhDQS5kZWNyeXB0LmFwcGx5KEhDQSwgdGFzay5hcmdzKTsKICAgICAgICAgICAgICAgIGNhc2UgImVuY3J5cHQiOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBIQ0EuZW5jcnlwdC5hcHBseShIQ0EsIHRhc2suYXJncyk7CiAgICAgICAgICAgICAgICBjYXNlICJhZGRDaXBoZXJIZWFkZXIiOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBIQ0FJbmZvLmFkZENpcGhlckhlYWRlci5hcHBseShIQ0FJbmZvLCB0YXNrLmFyZ3MpOwogICAgICAgICAgICAgICAgY2FzZSAiZGVjb2RlIjoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gSENBLmRlY29kZS5hcHBseShIQ0EsIHRhc2suYXJncyk7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgdW5rbm93biBjbWQgJHt0YXNrLmNtZH1gKTsKICAgICAgICAgICAgfQogICAgICAgIH0sICgpID0+IHsgdGFza1F1ZXVlLnNlbmRDbWQoInNlbGYtZGVzdHJ1Y3QiLCBbXSk7IH0pOwogICAgICAgIG9ubWVzc2FnZSA9IChldikgPT4gdGFza1F1ZXVlLm1zZ0hhbmRsZXIoZXYpOwogICAgfQp9Ci8vIGNyZWF0ZSAmIGNvbnRyb2wgYXVkaW8gd29ya2xldApjbGFzcyBIQ0FBdWRpb1dvcmtsZXRIQ0FQbGF5ZXIgewogICAgZ2V0IGlzQWxpdmUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudGFza1F1ZXVlLmlzQWxpdmU7CiAgICB9CiAgICBnZXQgaW5pdGlhbGl6ZWQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2luaXRpYWxpemVkOwogICAgfQogICAgZ2V0IHVubG9ja2VkKCkgewogICAgICAgIHJldHVybiB0aGlzLl91bmxvY2tlZDsKICAgIH0KICAgIGdldCBibG9ja0NoZWNrc3VtVmVyaWZpY2F0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnZlcmlmeUNzdW07CiAgICB9CiAgICBzZXQgYmxvY2tDaGVja3N1bVZlcmlmaWNhdGlvbih2YWwpIHsKICAgICAgICBpZiAodHlwZW9mIHZhbCAhPT0gImJvb2xlYW4iKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICB0aGlzLnZlcmlmeUNzdW0gPSB2YWw7CiAgICB9CiAgICBnZXQgZmVlZFNpemUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaW5mby5ibG9ja1NpemUgKiB0aGlzLmZlZWRCbG9ja0NvdW50OwogICAgfQogICAgZ2V0IHJlbWFpbmluZ0Jsb2NrQ291bnQoKSB7CiAgICAgICAgbGV0IHRvdGFsID0gdGhpcy5oYXNMb29wID8gdGhpcy5pbmZvLmxvb3AuZW5kICsgMSA6IHRoaXMuaW5mby5mb3JtYXQuYmxvY2tDb3VudDsKICAgICAgICBsZXQgcmVtYWluaW5nID0gdG90YWwgLSB0aGlzLnRvdGFsRmVkQmxvY2tDb3VudDsKICAgICAgICBpZiAocmVtYWluaW5nIDw9IDApCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgIHJldHVybiByZW1haW5pbmc7CiAgICB9CiAgICBnZXQgZG93bmxvYWRCdWZmZXJTaXplKCkgewogICAgICAgIGNvbnN0IGJ5dGVzUGVyU2VjID0gdGhpcy5pbmZvLmticHMgKiAxMDAwIC8gODsKICAgICAgICByZXR1cm4gYnl0ZXNQZXJTZWMgKiA0OwogICAgfQogICAgdGFza0hhbmRsZXIodGFzaykgewogICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAgIHN3aXRjaCAodGFzay5jbWQpIHsKICAgICAgICAgICAgICAgIGNhc2UgIm5vcCI6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgY2FzZSAic2VsZi1kZXN0cnVjdCI6IC8vIGRvZXNuJ3Qgc2VlbSB0byBoYXZlIGEgY2hhbmNlIHRvIGJlIGNhbGxlZAogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEhDQUZyYW1lUGxheWVyIHJlcXVlc3RlZCB0byBzZWxmLWRlc3RydWN0YCk7CiAgICAgICAgICAgICAgICAgICAgeWllbGQgdGhpcy50YXNrUXVldWUuc2h1dGRvd24odHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgY2FzZSAiZW5kIjoKICAgICAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47IC8vIGFjdHVhbGx5IG5vdCBzZW5kaW5nIGJhY2sgcmVwbHkKICAgICAgICAgICAgICAgIGNhc2UgInB1bGwiOgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnNvdXJjZSA9PSBudWxsKQogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYG5vdGhpbmcgdG8gZmVlZGApOyAvLyBzaG91bGQgbmV2ZXIgaGFwcGVuCiAgICAgICAgICAgICAgICAgICAgbGV0IGJsb2NrQ291bnQgPSBNYXRoLm1pbih0aGlzLmZlZWRCbG9ja0NvdW50LCB0aGlzLnJlbWFpbmluZ0Jsb2NrQ291bnQpOwogICAgICAgICAgICAgICAgICAgIGxldCBzaXplID0gdGhpcy5pbmZvLmJsb2NrU2l6ZSAqIGJsb2NrQ291bnQ7CiAgICAgICAgICAgICAgICAgICAgbGV0IG5ld0Jsb2NrczsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zb3VyY2UgaW5zdGFuY2VvZiBVaW50OEFycmF5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdob2xlIEhDQSBtb2RlCiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzdGFydCA9IHRoaXMuaW5mby5kYXRhT2Zmc2V0ICsgdGhpcy5pbmZvLmJsb2NrU2l6ZSAqIHRoaXMudG90YWxGZWRCbG9ja0NvdW50OwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgZW5kID0gc3RhcnQgKyBzaXplOwogICAgICAgICAgICAgICAgICAgICAgICBuZXdCbG9ja3MgPSB0aGlzLnNvdXJjZS5zdWJhcnJheShzdGFydCwgZW5kKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy99IGVsc2UgaWYgKHRoaXMuc291cmNlIGluc3RhbmNlb2YgUmVhZGFibGVTdHJlYW1EZWZhdWx0UmVhZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbW1lbnRlZCBvdXQgYmVjYXVzZSBGaXJlZm94IHRocm93cyAiUmVmZXJlbmNlRXJyb3I6IFJlYWRhYmxlU3RyZWFtRGVmYXVsdFJlYWRlciBpcyBub3QgZGVmaW5lZCIKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFVSTCBtb2RlCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnNyY0J1ZiA9PSBudWxsKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJzcmNCdWYgaXMgdW5kZWZpbmVkIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBtYXhEb3dubGFvZFNpemUgPSB0aGlzLmluZm8uYmxvY2tTaXplICogdGhpcy5yZW1haW5pbmdCbG9ja0NvdW50OwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgZG93bmxvYWRTaXplID0gTWF0aC5tYXgodGhpcy5kb3dubG9hZEJ1ZmZlclNpemUsIHNpemUpOwogICAgICAgICAgICAgICAgICAgICAgICBkb3dubG9hZFNpemUgPSBNYXRoLm1pbihkb3dubG9hZFNpemUsIG1heERvd25sYW9kU2l6ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCByZW1haW5pbmcgPSBkb3dubG9hZFNpemUgLSB0aGlzLnNyY0J1Zi5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZW1haW5pbmcgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBGSVhNRSBjb25uZWN0aW9uIGxvc3MgaXMgbm90IGhhbmRsZWQvcmVjb3ZlcmVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNyY0J1ZiA9IHlpZWxkIEhDQUF1ZGlvV29ya2xldEhDQVBsYXllci5yZWFkQW5kQXBwZW5kKHRoaXMuc291cmNlLCB0aGlzLnNyY0J1ZiwgcmVtYWluaW5nKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zcmNCdWYubGVuZ3RoIDwgc2l6ZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigic3JjQnVmIHN0aWxsIHNtYWxsZXIgdGhhbiBleHBlY3RlZCIpOwogICAgICAgICAgICAgICAgICAgICAgICBuZXdCbG9ja3MgPSB0aGlzLnNyY0J1Zi5zdWJhcnJheSgwLCBzaXplKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zcmNCdWYgPSB0aGlzLnNyY0J1Zi5zbGljZShzaXplKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDAsIHN0YXJ0ID0gMDsgaSA8IGJsb2NrQ291bnQ7IGkrKywgc3RhcnQgKz0gdGhpcy5pbmZvLmJsb2NrU2l6ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBsZXQgYmxvY2sgPSBuZXdCbG9ja3Muc3ViYXJyYXkoc3RhcnQsIHN0YXJ0ICsgdGhpcy5pbmZvLmJsb2NrU2l6ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHZlcmlmeSBjaGVja3N1bSAoaWYgZW5hYmxlZCkKICAgICAgICAgICAgICAgICAgICAgICAgLy8gd2lsbCB0aHJvdyAmIHN0b3AgcGxheWluZyBvbiBtaXNtYXRjaCEKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMudmVyaWZ5Q3N1bSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEhDQUNyYzE2LnZlcmlmeShibG9jaywgdGhpcy5pbmZvLmJsb2NrU2l6ZSAtIDIpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBkZWNyeXB0IChpZiBlbmNyeXB0ZWQpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNpcGhlciAhPSBudWxsKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaXBoZXIubWFzayhibG9jaywgMCwgdGhpcy5pbmZvLmJsb2NrU2l6ZSAtIDIpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBmaXggY2hlY2tzdW0KICAgICAgICAgICAgICAgICAgICAgICAgSENBQ3JjMTYuZml4KGJsb2NrLCB0aGlzLmluZm8uYmxvY2tTaXplIC0gMik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmhhc0xvb3ApIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8ganVzdCBjb3B5LCBubyBuZWVkIHRvIGVubGFyZ2UKICAgICAgICAgICAgICAgICAgICAgICAgbmV3QmxvY2tzID0gbmV3QmxvY2tzLnNsaWNlKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBlbmxhcmdlICYgY29weQogICAgICAgICAgICAgICAgICAgICAgICBsZXQgZGF0YSA9IG5ld0Jsb2NrczsKICAgICAgICAgICAgICAgICAgICAgICAgbmV3QmxvY2tzID0gbmV3IFVpbnQ4QXJyYXkodGhpcy5mZWVkU2l6ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIG5ld0Jsb2Nrcy5zZXQoZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRoaXMudG90YWxGZWRCbG9ja0NvdW50ICs9IGJsb2NrQ291bnQ7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ld0Jsb2NrczsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGB1bmtub3duIGNtZCAiJHt0YXNrLmNtZH0iYCk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KICAgIHN0YXRpYyBjcmVhdGUoc2VsZlVybCwgc291cmNlLCBrZXkxLCBrZXkyKSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgaWYgKCEoc2VsZlVybCBpbnN0YW5jZW9mIFVSTCkpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICAgICAgaWYgKCEoc291cmNlIGluc3RhbmNlb2YgVWludDhBcnJheSB8fCBzb3VyY2UgaW5zdGFuY2VvZiBVUkwpKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgICAgIGxldCBhY3R1YWxTb3VyY2U7CiAgICAgICAgICAgIGxldCBpbmZvOwogICAgICAgICAgICBsZXQgc3JjQnVmID0gdW5kZWZpbmVkOwogICAgICAgICAgICBpZiAoc291cmNlIGluc3RhbmNlb2YgVWludDhBcnJheSkgewogICAgICAgICAgICAgICAgYWN0dWFsU291cmNlID0gc291cmNlLnNsaWNlKDApOwogICAgICAgICAgICAgICAgaW5mbyA9IG5ldyBIQ0FJbmZvKGFjdHVhbFNvdXJjZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoc291cmNlIGluc3RhbmNlb2YgVVJMKSB7CiAgICAgICAgICAgICAgICBjb25zdCBmZXRjaGVkID0geWllbGQgdGhpcy5nZXRIQ0FJbmZvRnJvbVVSTChzb3VyY2UpOwogICAgICAgICAgICAgICAgYWN0dWFsU291cmNlID0gZmV0Y2hlZC5yZWFkZXI7CiAgICAgICAgICAgICAgICBpbmZvID0gZmV0Y2hlZC5pbmZvOwogICAgICAgICAgICAgICAgc3JjQnVmID0gZmV0Y2hlZC5idWZmZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgbGV0IGZlZWRCeXRlTWF4ID0gTWF0aC5mbG9vcih0aGlzLmZlZWRCeXRlTWF4KTsKICAgICAgICAgICAgaWYgKGZlZWRCeXRlTWF4IDwgaW5mby5ibG9ja1NpemUpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICAgICAgZmVlZEJ5dGVNYXggLT0gZmVlZEJ5dGVNYXggJSBpbmZvLmJsb2NrU2l6ZTsKICAgICAgICAgICAgY29uc3QgZmVlZEJsb2NrQ291bnQgPSBmZWVkQnl0ZU1heCAvIGluZm8uYmxvY2tTaXplOwogICAgICAgICAgICAvLyBpbml0aWFsaXplIGNpcGhlcgogICAgICAgICAgICBjb25zdCBjaXBoZXIgPSB0aGlzLmdldENpcGhlcihpbmZvLCBrZXkxLCBrZXkyKTsKICAgICAgICAgICAgLy8gY3JlYXRlIGF1ZGlvIGNvbnRleHQKICAgICAgICAgICAgY29uc3QgYXVkaW9DdHggPSBuZXcgQXVkaW9Db250ZXh0KHsKICAgICAgICAgICAgICAgIC8vbGF0ZW5jeUhpbnQ6ICJwbGF5YmFjayIsIC8vIEZJWE1FICJwbGF5YmFjayIgc2VlbXMgdG8gZ2xpdGNoIGlmIHN3aXRjaGVkIHRvIGJhY2tncm91bmQgaW4gQW5kcm9pZAogICAgICAgICAgICAgICAgc2FtcGxlUmF0ZTogaW5mby5mb3JtYXQuc2FtcGxpbmdSYXRlLAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgLy8gY3JlYXRlIGF1ZGlvIHdvcmtsZXQgbm9kZSAobm90IHlldCBjb25uZWN0ZWQpCiAgICAgICAgICAgIHlpZWxkIGF1ZGlvQ3R4LmF1ZGlvV29ya2xldC5hZGRNb2R1bGUoc2VsZlVybCk7CiAgICAgICAgICAgIGNvbnN0IG9wdGlvbnMgPSB7CiAgICAgICAgICAgICAgICBudW1iZXJPZklucHV0czogMCwKICAgICAgICAgICAgICAgIG51bWJlck9mT3V0cHV0czogMSwKICAgICAgICAgICAgICAgIG91dHB1dENoYW5uZWxDb3VudDogW2luZm8uZm9ybWF0LmNoYW5uZWxDb3VudF0sCiAgICAgICAgICAgICAgICBwcm9jZXNzb3JPcHRpb25zOiB7CiAgICAgICAgICAgICAgICAgICAgcmF3SGVhZGVyOiBpbmZvLmdldFJhd0hlYWRlcigpLAogICAgICAgICAgICAgICAgICAgIHB1bGxCbG9ja0NvdW50OiBmZWVkQmxvY2tDb3VudCwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGNvbnN0IGhjYVBsYXllck5vZGUgPSBuZXcgQXVkaW9Xb3JrbGV0Tm9kZShhdWRpb0N0eCwgImhjYS1mcmFtZS1wbGF5ZXIiLCBvcHRpb25zKTsKICAgICAgICAgICAgLy8gY3JlYXRlIGdhaW4gbm9kZQogICAgICAgICAgICBjb25zdCBnYWluTm9kZSA9IGF1ZGlvQ3R4LmNyZWF0ZUdhaW4oKTsKICAgICAgICAgICAgY29uc3QgdW5sb2NrZWQgPSB5aWVsZCBzdXNwZW5kQXVkaW9DdHhJZlVubG9ja2VkKGF1ZGlvQ3R4KTsKICAgICAgICAgICAgLy8gY3JlYXRlIGNvbnRyb2xsZXIgb2JqZWN0CiAgICAgICAgICAgIHJldHVybiBuZXcgSENBQXVkaW9Xb3JrbGV0SENBUGxheWVyKHNlbGZVcmwsIGF1ZGlvQ3R4LCB1bmxvY2tlZCwgaGNhUGxheWVyTm9kZSwgZ2Fpbk5vZGUsIGZlZWRCbG9ja0NvdW50LCBpbmZvLCBhY3R1YWxTb3VyY2UsIHNyY0J1ZiwgY2lwaGVyKTsKICAgICAgICB9KTsKICAgIH0KICAgIF90ZXJtaW5hdGUoKSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgLy8gSSBkaWRuJ3QgZmluZCB0ZXJtaW5hdGUoKSBmb3IgQXVkaW9Xb3JrbGV0IHNvIEkgbWFkZSBvbmUKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHRoaXMuaGNhUGxheWVyTm9kZS5wb3J0LmNsb3NlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYGVycm9yIHRyeWluZyB0byBjbG9zZSBtZXNzYWdlIHBvcnRgLCBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhpcy5oY2FQbGF5ZXJOb2RlLmRpc2Nvbm5lY3QoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgZXJyb3IgdHJ5aW5nIHRvIGRpc2Nvbm5lY3QgaGNhUGxheWVyTm9kZWAsIGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB0aGlzLmdhaW5Ob2RlLmRpc2Nvbm5lY3QoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgZXJyb3IgdHJ5aW5nIHRvIGRpc2Nvbm5lY3QgZ2Fpbk5vZGVgLCBlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgeWllbGQgdGhpcy5hdWRpb0N0eC5jbG9zZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBlcnJvciB0cnlpbmcgdG8gY2xvc2UgYXVkaW8gY29udGV4dGAsIGUpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CiAgICBjb25zdHJ1Y3RvcihzZWxmVXJsLCBhdWRpb0N0eCwgdW5sb2NrZWQsIGhjYVBsYXllck5vZGUsIGdhaW5Ob2RlLCBmZWVkQmxvY2tDb3VudCwgaW5mbywgc291cmNlLCBzcmNCdWYsIGNpcGhlcikgewogICAgICAgIHRoaXMuX2luaXRpYWxpemVkID0gdHJ1ZTsgLy8gaW5pdGlhbGx5IHRoZXJlIG11c3QgYmUgc29tZXRoaW5nIHRvIHBsYXkKICAgICAgICB0aGlzLmlzUGxheWluZyA9IGZhbHNlOwogICAgICAgIHRoaXMudmVyaWZ5Q3N1bSA9IGZhbHNlOwogICAgICAgIHRoaXMudG90YWxGZWRCbG9ja0NvdW50ID0gMDsKICAgICAgICB0aGlzLnN0b3BDbWRJdGVtID0gewogICAgICAgICAgICAvLyBleGVjICJyZXNldCIgY21kIGZpcnN0LCBpbiBvcmRlciB0byBhdm9pZCAicmVzaWR1ZSIgYnVyc3Qgbm9pc2UgdG8gYmUgcGxheWVkIGluIHRoZSBmdXR1cmUgKG9ic2VydmVkIGluIENocm9tZSkKICAgICAgICAgICAgY21kOiAicmVzZXQiLCBhcmdzOiBbXSwgaG9vazogewogICAgICAgICAgICAgICAgdGFzazogKHRhc2spID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNBbGl2ZSkKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJkZWFkIik7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzUGxheWluZykKICAgICAgICAgICAgICAgICAgICAgICAgeWllbGQgdGhpcy5fcmVzdW1lKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRhc2s7CiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIHJlc3VsdDogKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgICAgICAgICAgIHlpZWxkIHRoaXMuX3N1c3BlbmQoKTsgLy8gY2FuIG5vdyBzdXNwZW5kCiAgICAgICAgICAgICAgICAgICAgdGhpcy5faW5pdGlhbGl6ZWQgPSBmYWxzZTsgLy8gbm93IHdlIGhhdmUgbm90aGluZyB0byBwbGF5IHVudGlsIG5leHQgc2V0U291cmNlCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc291cmNlICE9IG51bGwgJiYgISh0aGlzLnNvdXJjZSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHlpZWxkIHRoaXMuc291cmNlLmNhbmNlbCgpOwogICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5zb3VyY2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHRoaXMuc2VsZlVybCA9IHNlbGZVcmw7CiAgICAgICAgdGhpcy5hdWRpb0N0eCA9IGF1ZGlvQ3R4OwogICAgICAgIHRoaXMuX3VubG9ja2VkID0gdW5sb2NrZWQ7CiAgICAgICAgdGhpcy50YXNrUXVldWUgPSBuZXcgSENBVGFza1F1ZXVlKCJNYWluLUhDQUF1ZGlvV29ya2xldEhDQVBsYXllciIsIChtc2csIHRyYW5zKSA9PiBoY2FQbGF5ZXJOb2RlLnBvcnQucG9zdE1lc3NhZ2UobXNnLCB0cmFucyksICh0YXNrKSA9PiB0aGlzLnRhc2tIYW5kbGVyKHRhc2spLCAoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7IHJldHVybiB5aWVsZCB0aGlzLl90ZXJtaW5hdGUoKTsgfSkpOwogICAgICAgIGhjYVBsYXllck5vZGUucG9ydC5vbm1lc3NhZ2UgPSAoZXYpID0+IHRoaXMudGFza1F1ZXVlLm1zZ0hhbmRsZXIoZXYpOwogICAgICAgIGhjYVBsYXllck5vZGUucG9ydC5vbm1lc3NhZ2VlcnJvciA9IChldikgPT4gdGhpcy50YXNrUXVldWUuZXJySGFuZGxlcihldik7CiAgICAgICAgaGNhUGxheWVyTm9kZS5vbnByb2Nlc3NvcmVycm9yID0gKGV2KSA9PiB0aGlzLnRhc2tRdWV1ZS5lcnJIYW5kbGVyKGV2KTsKICAgICAgICB0aGlzLmhjYVBsYXllck5vZGUgPSBoY2FQbGF5ZXJOb2RlOwogICAgICAgIHRoaXMuZ2Fpbk5vZGUgPSBnYWluTm9kZTsKICAgICAgICB0aGlzLmZlZWRCbG9ja0NvdW50ID0gZmVlZEJsb2NrQ291bnQ7CiAgICAgICAgdGhpcy5pbmZvID0gaW5mbzsKICAgICAgICB0aGlzLnNvdXJjZSA9IHNvdXJjZTsKICAgICAgICB0aGlzLmNpcGhlciA9IGNpcGhlcjsKICAgICAgICB0aGlzLnNyY0J1ZiA9IHNyY0J1ZjsKICAgICAgICB0aGlzLnNhbXBsZVJhdGUgPSBpbmZvLmZvcm1hdC5zYW1wbGluZ1JhdGU7CiAgICAgICAgdGhpcy5jaGFubmVsQ291bnQgPSBpbmZvLmZvcm1hdC5jaGFubmVsQ291bnQ7CiAgICAgICAgdGhpcy5oYXNMb29wID0gaW5mby5oYXNIZWFkZXJbImxvb3AiXSA/IHRydWUgOiBmYWxzZTsKICAgIH0KICAgIHN0YXRpYyBnZXRDaXBoZXIoaW5mbywga2V5MSwga2V5MikgewogICAgICAgIHN3aXRjaCAoaW5mby5jaXBoZXIpIHsKICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgLy8gbm90IGVuY3J5cHRlZAogICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgICAgLy8gZW5jcnlwdGVkIHdpdGggIm5vIGtleSIKICAgICAgICAgICAgICAgIHJldHVybiBuZXcgSENBQ2lwaGVyKCJub25lIik7IC8vIGlnbm9yZSBnaXZlbiBrZXlzCiAgICAgICAgICAgIGNhc2UgMHgzODoKICAgICAgICAgICAgICAgIC8vIGVuY3J5cHRlZCB3aXRoIGtleXMgLSB3aWxsIHlpZWxkIGluY29ycmVjdCB3YXZlZm9ybSBpZiBpbmNvcnJlY3Qga2V5cyBhcmUgZ2l2ZW4hCiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEhDQUNpcGhlcihrZXkxLCBrZXkyKTsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidW5rbm93biBjaXBoLnR5cGUiKTsKICAgICAgICB9CiAgICB9CiAgICBzdGF0aWMgcmVhZEFuZEFwcGVuZChyZWFkZXIsIGRhdGEsIG1pbkNvdW50KSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgaWYgKG1pbkNvdW50IDwgMCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgICAgICBjb25zdCBkZXNpcmVkID0gZGF0YS5sZW5ndGggKyBtaW5Db3VudDsKICAgICAgICAgICAgbGV0IG5ld0RhdGEgPSBuZXcgVWludDhBcnJheShkZXNpcmVkKTsKICAgICAgICAgICAgbmV3RGF0YS5zZXQoZGF0YSk7CiAgICAgICAgICAgIGZvciAobGV0IG9mZnNldCA9IGRhdGEubGVuZ3RoOyBvZmZzZXQgPCBkZXNpcmVkOykgewogICAgICAgICAgICAgICAgY29uc3QgcmVzID0geWllbGQgcmVhZGVyLnJlYWQoKTsKICAgICAgICAgICAgICAgIGlmIChyZXMuZG9uZSkKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHVuZXhwZWN0ZWQgc3RyZWFtIGVuZC4gYAogICAgICAgICAgICAgICAgICAgICAgICArIGBpdCBpcyBwb3NzaWJsZSB0aGF0IHRoZSBkb3dubG9hZCBoYXMgYmVlbiBjYW5jZWxlZCAoYnkgbGF0ZXIgc2V0U291cmNlKSwgb3IgdGhlIGZpbGUgZGF0YSBpcyBpbmNvbXBsZXRlYCk7CiAgICAgICAgICAgICAgICBjb25zdCBieXRlcyA9IHJlcy52YWx1ZTsKICAgICAgICAgICAgICAgIGlmIChieXRlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVxdWlyZWQgPSBvZmZzZXQgKyBieXRlcy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlcXVpcmVkID4gbmV3RGF0YS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZXhpc3RpbmcgPSBuZXdEYXRhOwogICAgICAgICAgICAgICAgICAgICAgICBuZXdEYXRhID0gbmV3IFVpbnQ4QXJyYXkocmVxdWlyZWQpOwogICAgICAgICAgICAgICAgICAgICAgICBuZXdEYXRhLnNldChleGlzdGluZyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIG5ld0RhdGEuc2V0KGJ5dGVzLCBvZmZzZXQpOwogICAgICAgICAgICAgICAgICAgIG9mZnNldCArPSBieXRlcy5sZW5ndGg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIG5ld0RhdGE7CiAgICAgICAgfSk7CiAgICB9CiAgICBzdGF0aWMgZ2V0SENBSW5mb0Zyb21VUkwodXJsKSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgLy8gRklYTUUgc2VuZCBIVFRQIFJhbmdlIHJlcXVlc3QgdG8gYXZvaWQgYmxvY2tpbmcgbGF0ZXIgcmVxdWVzdHMgKGVzcGVjaWFsbHkgaW4gRmlyZWZveCkKICAgICAgICAgICAgY29uc3QgcmVzcCA9IHlpZWxkIGZldGNoKHVybC5ocmVmKTsKICAgICAgICAgICAgaWYgKHJlc3Auc3RhdHVzICE9IDIwMCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgc3RhdHVzICR7cmVzcC5zdGF0dXN9YCk7CiAgICAgICAgICAgIGlmIChyZXNwLmJvZHkgPT0gbnVsbCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigicmVzcG9uc2UgaGFzIG5vIGJvZHkiKTsKICAgICAgICAgICAgY29uc3QgcmVhZGVyID0gcmVzcC5ib2R5LmdldFJlYWRlcigpOwogICAgICAgICAgICBsZXQgYnVmZmVyID0geWllbGQgdGhpcy5yZWFkQW5kQXBwZW5kKHJlYWRlciwgbmV3IFVpbnQ4QXJyYXkoMCksIDgpOwogICAgICAgICAgICBjb25zdCBkYXRhT2Zmc2V0ID0gbmV3IERhdGFWaWV3KGJ1ZmZlci5idWZmZXIsIGJ1ZmZlci5ieXRlT2Zmc2V0LCBidWZmZXIuYnl0ZUxlbmd0aCkuZ2V0VWludDE2KDYpOwogICAgICAgICAgICBjb25zdCByZW1haW5pbmcgPSBkYXRhT2Zmc2V0IC0gYnVmZmVyLmxlbmd0aDsKICAgICAgICAgICAgaWYgKHJlbWFpbmluZyA+IDApIHsKICAgICAgICAgICAgICAgIGJ1ZmZlciA9IHlpZWxkIHRoaXMucmVhZEFuZEFwcGVuZChyZWFkZXIsIGJ1ZmZlciwgcmVtYWluaW5nKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgcmVhZGVyOiByZWFkZXIsCiAgICAgICAgICAgICAgICBpbmZvOiBuZXcgSENBSW5mbyhidWZmZXIpLAogICAgICAgICAgICAgICAgYnVmZmVyOiBidWZmZXIuc2xpY2UoZGF0YU9mZnNldCksCiAgICAgICAgICAgIH07CiAgICAgICAgfSk7CiAgICB9CiAgICBzZXRTb3VyY2Uoc291cmNlLCBrZXkxLCBrZXkyKSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgbGV0IG5ld0luZm87CiAgICAgICAgICAgIGxldCBuZXdTb3VyY2U7CiAgICAgICAgICAgIGxldCBuZXdCdWZmZXIgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIGNvbnN0IGluaXRpYWxpemVDbWRJdGVtID0gewogICAgICAgICAgICAgICAgY21kOiAiaW5pdGlhbGl6ZSIsIGFyZ3M6IFtudWxsXSwgaG9vazogewogICAgICAgICAgICAgICAgICAgIHRhc2s6ICh0YXNrKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc0FsaXZlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJkZWFkIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG9sZFNvdXJjZSA9IHRoaXMuc291cmNlOwogICAgICAgICAgICAgICAgICAgICAgICAvL2lmIChvbGRTb3VyY2UgaW5zdGFuY2VvZiBSZWFkYWJsZVN0cmVhbURlZmF1bHRSZWFkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9sZFNvdXJjZSAhPSBudWxsICYmICEob2xkU291cmNlIGluc3RhbmNlb2YgVWludDhBcnJheSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeWllbGQgb2xkU291cmNlLmNhbmNlbCgpOyAvLyBzdG9wIGRvd25sb2FkaW5nIGZyb20gcHJldmlvdXMgVVJMCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRklYTUUgRmlyZWZveCBkb2Vzbid0IHNlZW0gdG8gYWJvcnQgcHJldmlvdXMgZG93bmxvYWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgZXJyb3Igd2hlbiBjYW5jZWxsaW5nIHByZXZpb3VzIGRvd25sb2FkLmAsIGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzb3VyY2UgaW5zdGFuY2VvZiBVaW50OEFycmF5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdTb3VyY2UgPSBzb3VyY2Uuc2xpY2UoMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdJbmZvID0gbmV3IEhDQUluZm8obmV3U291cmNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChzb3VyY2UgaW5zdGFuY2VvZiBVUkwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHlpZWxkIEhDQUF1ZGlvV29ya2xldEhDQVBsYXllci5nZXRIQ0FJbmZvRnJvbVVSTChzb3VyY2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U291cmNlID0gcmVzdWx0LnJlYWRlcjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0luZm8gPSByZXN1bHQuaW5mbzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0J1ZmZlciA9IHJlc3VsdC5idWZmZXI7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJpbnZhbGlkIHNvdXJjZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBzYW1wbGUgcmF0ZSBhbmQgY2hhbm5lbCBjb3VudCBpcyBpbW11dGFibGUsCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZXJlZm9yZSwgdGhlIG9ubHkgd2F5IHRvIGNoYW5nZSB0aGVtIGlzIHRvIHJlY3JlYXRlIGEgbmV3IGluc3RhbmNlLgogICAgICAgICAgICAgICAgICAgICAgICAvLyBob3dldmVyLCB0aGVyZSBpcyBhIG1lbWxlYWsgYnVnIGluIENocm9taXVtLCB0aGF0OgogICAgICAgICAgICAgICAgICAgICAgICAvLyAobm8tbG9uZ2VyLXVzZWQpIGF1ZGlvIHdvcmtsZXQgbm9kZShzKSB3b24ndCBiZSByZWN5Y2xlZDoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaHR0cHM6Ly9idWdzLmNocm9taXVtLm9yZy9wL2Nocm9taXVtL2lzc3Vlcy9kZXRhaWw/aWQ9MTI5ODk1NQogICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV3SW5mby5mb3JtYXQuc2FtcGxpbmdSYXRlICE9IHRoaXMuc2FtcGxlUmF0ZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigic2FtcGxlIHJhdGUgbWlzbWF0Y2giKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5ld0luZm8uZm9ybWF0LmNoYW5uZWxDb3VudCAhPSB0aGlzLmNoYW5uZWxDb3VudCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiY2hhbm5lbCBjb3VudCBtaXNtYXRjaCIpOwogICAgICAgICAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLl9yZXN1bWUoKTsgLy8gcmVzdW1lIGl0LCBzbyB0aGF0IGNtZCBjYW4gdGhlbiBiZSBleGVjdXRlZAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXdQcm9jT3B0cyA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhd0hlYWRlcjogbmV3SW5mby5nZXRSYXdIZWFkZXIoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB1bGxCbG9ja0NvdW50OiB0aGlzLmZlZWRCbG9ja0NvdW50LAogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEhDQVRhc2sodGFzay5vcmlnaW4sIHRhc2sudGFza0lELCB0YXNrLmNtZCwgW25ld1Byb2NPcHRzXSwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIH0pLCByZXN1bHQ6ICgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgeWllbGQgdGhpcy5fc3VzcGVuZCgpOyAvLyBpbml0aWFsaXplZCwgYnV0IGl0J3MgcGF1c2VkLCB1bnRpbCBiZWluZyByZXF1ZXN0ZWQgdG8gc3RhcnQvcGxheSAocmVzdW1lKQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRvdGFsRmVkQmxvY2tDb3VudCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2lwaGVyID0gSENBQXVkaW9Xb3JrbGV0SENBUGxheWVyLmdldENpcGhlcihuZXdJbmZvLCBrZXkxLCBrZXkyKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbmZvID0gbmV3SW5mbzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zb3VyY2UgPSBuZXdTb3VyY2U7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3JjQnVmID0gbmV3QnVmZmVyOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmhhc0xvb3AgPSBuZXdJbmZvLmhhc0hlYWRlclsibG9vcCJdID8gdHJ1ZSA6IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9pbml0aWFsaXplZCA9IHRydWU7IC8vIGFnYWluIHdlIG5vdyBoYXZlIHNvbWV0aGluZyB0byBwbGF5CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgeWllbGQgdGhpcy50YXNrUXVldWUuZXhlY011bHRpQ21kKFt0aGlzLnN0b3BDbWRJdGVtLCBpbml0aWFsaXplQ21kSXRlbV0pOyAvLyBlbnN1cmUgYXRvbWljaXR5CiAgICAgICAgfSk7CiAgICB9CiAgICAvLyBub3Qgc3VwcG9zZWQgdG8gYmUgdXNlZCBkaXJlY3RseQogICAgX3Jlc3VtZSgpIHsKICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuaXNBbGl2ZSkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiZGVhZCIpOwogICAgICAgICAgICBpZiAodGhpcy5pc1BsYXlpbmcpCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIHlpZWxkIHRoaXMuYXVkaW9DdHgucmVzdW1lKCk7CiAgICAgICAgICAgIHRoaXMuaGNhUGxheWVyTm9kZS5jb25uZWN0KHRoaXMuZ2Fpbk5vZGUpOwogICAgICAgICAgICB0aGlzLmdhaW5Ob2RlLmNvbm5lY3QodGhpcy5hdWRpb0N0eC5kZXN0aW5hdGlvbik7CiAgICAgICAgICAgIHRoaXMuaXNQbGF5aW5nID0gdHJ1ZTsKICAgICAgICAgICAgLy8gbWFyayBhcyB1bmxvY2tlZAogICAgICAgICAgICBpZiAoIXRoaXMuX3VubG9ja2VkKSB7CiAgICAgICAgICAgICAgICB0aGlzLl91bmxvY2tlZCA9IHRydWU7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oYGF1ZGlvIGNvbnRleHQgZm9yIHNhbXBsZVJhdGU9JHt0aGlzLmF1ZGlvQ3R4LnNhbXBsZVJhdGV9IGlzIG5vdyByZXN1bWVkL3VubG9ja2VkYCk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KICAgIF9zdXNwZW5kKCkgewogICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5pc0FsaXZlKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJkZWFkIik7CiAgICAgICAgICAgIGlmICghdGhpcy5pc1BsYXlpbmcpCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIHRoaXMuaGNhUGxheWVyTm9kZS5kaXNjb25uZWN0KCk7CiAgICAgICAgICAgIHRoaXMuZ2Fpbk5vZGUuZGlzY29ubmVjdCgpOwogICAgICAgICAgICB5aWVsZCB0aGlzLmF1ZGlvQ3R4LnN1c3BlbmQoKTsKICAgICAgICAgICAgdGhpcy5pc1BsYXlpbmcgPSBmYWxzZTsKICAgICAgICB9KTsKICAgIH0KICAgIC8vIHdyYXBlZCB0byBlbnN1cmUgYXRvbWljaXR5CiAgICBzZXRQbGF5aW5nKHRvUGxheSkgewogICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAgIC8vIHNpbWxpbGFyIHRvIHN0b3BDbWRJdGVtIGFib3ZlLCBzZW5kICJwYXVzZSIgY21kIHRvIGF2b2lkICJyZXNpZHVlIiBidXJzdCBub2lzZQogICAgICAgICAgICB5aWVsZCB0aGlzLnRhc2tRdWV1ZS5leGVjQ21kKHRvUGxheSA/ICJyZXN1bWUiIDogInBhdXNlIiwgW10sIHsKICAgICAgICAgICAgICAgIHRhc2s6ICh0YXNrKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzQWxpdmUpCiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiZGVhZCIpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzUGxheWluZykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodG9QbGF5KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFzay5pc0R1bW15ID0gdHJ1ZTsgLy8gYWxyZWFkeSByZXN1bWVkLCBub3Qgc2VuZGluZyBjbWQKICAgICAgICAgICAgICAgICAgICAgICAgLy8gZWxzZSBzaG91bGQgc3RpbGwga2VlcCBwbGF5aW5nIHVudGlsICJwYXVzZSIgY21kIHJldHVybnMKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0b1BsYXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5faW5pdGlhbGl6ZWQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBub3QgaW5pdGlhbGl6ZWQgYnV0IHN0aWxsIGF0dGVtcHQgdG8gcmVzdW1lYCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLl9yZXN1bWUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXNrLmlzRHVtbXkgPSB0cnVlOyAvLyBhbHJlYWR5IHBhdXNlZCwgbm90IHNlbmRpbmcgY21kCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiB0YXNrOwogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICByZXN1bHQ6ICgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodG9QbGF5KQogICAgICAgICAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLl9yZXN1bWUoKTsKICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIHlpZWxkIHRoaXMuX3N1c3BlbmQoKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgfQogICAgcGF1c2UoKSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgeWllbGQgdGhpcy5zZXRQbGF5aW5nKGZhbHNlKTsKICAgICAgICB9KTsKICAgIH0KICAgIHBsYXkoKSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgLy8gaW4gYXBwbGUgd2Via2l0LCBhdWRpbyBjb250ZXh0IGlzIHN1c3BlbmRlZC9sb2NrZWQgaW5pdGlhbGx5LAogICAgICAgICAgICAvLyAob3RoZXIgYnJvd3NlcnMgbGlrZSBGaXJlZm94IG1heSBoYXZlIHNpbWlsYXIgYnV0IGxlc3Mgc3RyaWN0IHJlc3RyaWN0aW9ucykKICAgICAgICAgICAgLy8gdG8gcmVzdW1lL3VubG9jayBpdCwgZmlyc3QgcmVzdW1lKCkgY2FsbCBtdXN0IGJlIHRyaWdnZXJlZCBieSBmcm9tIFVJIGV2ZW50LAogICAgICAgICAgICAvLyB3aGljaCBtdXN0IG5vdCBiZSBhZnRlciBhd2FpdAogICAgICAgICAgICB5aWVsZCB0aGlzLnNldFBsYXlpbmcodHJ1ZSk7CiAgICAgICAgfSk7CiAgICB9CiAgICBzdG9wKCkgewogICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAgIC8vIGNhbiB1bmxvY2sgdGhlIGxvY2tlZCBhdWRpbyBjb250ZXh0IGFzIHdlbGwgYmVjYXVzZSBpdCdzIHJlc3VtZWQgZmlyc3RseSBiZWZvcmUgZmluYWxseSBzdXNwZW5kZWQKICAgICAgICAgICAgY29uc3QgaXRlbSA9IHRoaXMuc3RvcENtZEl0ZW07CiAgICAgICAgICAgIHlpZWxkIHRoaXMudGFza1F1ZXVlLmV4ZWNDbWQoaXRlbS5jbWQsIGl0ZW0uYXJncywgaXRlbS5ob29rKTsKICAgICAgICB9KTsKICAgIH0KICAgIHNodXRkb3duKGZvcmNpYmx5ID0gZmFsc2UpIHsKICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuaXNBbGl2ZSkgewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgYWxyZWFkeSBzaHV0ZG93bmApOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHlpZWxkIHRoaXMudGFza1F1ZXVlLnNodXRkb3duKGZvcmNpYmx5KTsKICAgICAgICB9KTsKICAgIH0KfQpIQ0FBdWRpb1dvcmtsZXRIQ0FQbGF5ZXIuZmVlZEJ5dGVNYXggPSAzMjc2ODsKLy8gY3JlYXRlICYgY29udHJvbCB3b3JrZXIKZXhwb3J0IGNsYXNzIEhDQVdvcmtlciB7CiAgICBnZXQgaXNBbGl2ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy50YXNrUXVldWUuaXNBbGl2ZTsKICAgIH0KICAgIHNodXRkb3duKGZvcmNpYmx5ID0gZmFsc2UpIHsKICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgICBpZiAodGhpcy50YXNrUXVldWUuaXNBbGl2ZSkKICAgICAgICAgICAgICAgIHlpZWxkIHRoaXMudGFza1F1ZXVlLnNodXRkb3duKGZvcmNpYmx5KTsKICAgICAgICAgICAgaWYgKHRoaXMuYXdIY2FQbGF5ZXIgIT0gbnVsbCAmJiB0aGlzLmF3SGNhUGxheWVyLmlzQWxpdmUpCiAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLmF3SGNhUGxheWVyLnNodXRkb3duKGZvcmNpYmx5KTsKICAgICAgICB9KTsKICAgIH0KICAgIHRpY2soKSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgeWllbGQgdGhpcy50YXNrUXVldWUuZXhlY0NtZCgibm9wIiwgW10pOwogICAgICAgICAgICB0aGlzLmxhc3RUaWNrID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICAgICAgfSk7CiAgICB9CiAgICB0b2NrKHRleHQgPSAiIikgewogICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAgIHlpZWxkIHRoaXMudGFza1F1ZXVlLmV4ZWNDbWQoIm5vcCIsIFtdKTsKICAgICAgICAgICAgY29uc3QgZHVyYXRpb24gPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHRoaXMubGFzdFRpY2s7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke3RleHR9IHRvb2sgJHtkdXJhdGlvbn0gbXNgKTsKICAgICAgICAgICAgcmV0dXJuIGR1cmF0aW9uOwogICAgICAgIH0pOwogICAgfQogICAgc3RhdGljIGNyZWF0ZShzZWxmVXJsKSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBzZWxmVXJsID09PSAic3RyaW5nIikKICAgICAgICAgICAgICAgIHNlbGZVcmwgPSBuZXcgVVJMKHNlbGZVcmwsIGRvY3VtZW50LmJhc2VVUkkpOwogICAgICAgICAgICBlbHNlIGlmICghKHNlbGZVcmwgaW5zdGFuY2VvZiBVUkwpKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJzZWxmVXJsIG11c3QgYmUgZWl0aGVyIHN0cmluZyBvciBVUkwiKTsKICAgICAgICAgICAgLy8gZmV0Y2ggJiBzYXZlIGhjYS5qcyBhcyBibG9iIGluIGFkdmFuY2UsIHRvIGF2b2lkIGNyZWF0aW5nIHdvcmtlciBiZWluZyBibG9ja2VkIGxhdGVyLCBsaWtlOgogICAgICAgICAgICAvLyAoSSBvYnNlcnZlZCB0aGlzIHByb2JsZW0gaW4gRmlyZWZveCkKICAgICAgICAgICAgLy8gY3JlYXRpbmcgSENBQXVkaW9Xb3JrbGV0SENBUGxheWVyIHJlcXVpcmVzIGluZm9ybWF0aW9uIGZyb20gSENBLCB3aGljaCBpcyBzYW1wbGUgcmF0ZSBhbmQgY2hhbm5lbCBjb3VudDsKICAgICAgICAgICAgLy8gaG93ZXZlciwgZmV0Y2hpbmcgSENBIChvcmlnaW5hbGx5IHN1cHBvc2VkIHRvIGJlIHByb2dyZXNzaXZlL3N0cmVhbWVkKSBibG9ja3MgbGF0ZXIgcmVxdWVzdCB0byBmZXRjaCBoY2EuanMsCiAgICAgICAgICAgIC8vIHNvIHRoYXQgSENBQXVkaW9Xb3JrbGV0SENBUGxheWVyIGNhbiBvbmx5IGJlIGNyZWF0ZWQgYWZ0ZXIgZmluaXNoaW5nIGRvd25sb2FkaW5nIHRoZSB3aG9sZSBIQ0EsCiAgICAgICAgICAgIC8vIHdoaWNoIG9idmlvdXNseSBkZWZlYXRzIHRoZSBwdXJwb3NlIG9mIHN0cmVhbWluZyBIQ0EKICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSB5aWVsZCBmZXRjaChzZWxmVXJsLmhyZWYpOwogICAgICAgICAgICAvLyBGaXJlZm94IGN1cnJlbnRseSBkb2VzIG5vdCBzdXBwb3J0IEVDTUFTY3JpcHQgbW9kdWxlcyBpbiBXb3JrZXIsCiAgICAgICAgICAgIC8vIHRoZXJlZm9yZSB3ZSBtdXN0IHN0cmlwIGFsbCBleHBvcnQgZGVjbGFyYXRpb25zCiAgICAgICAgICAgIGNvbnN0IG9yaWdUZXh0ID0geWllbGQgcmVzcG9uc2UudGV4dCgpOwogICAgICAgICAgICBjb25zdCBjb252ZXJ0ZWRUZXh0ID0gKCJcbiIgKyBvcmlnVGV4dCkucmVwbGFjZSgvKChcbnw7KVsgXHRdKikoKGV4cG9ydFsgXHRdK1x7Lio/XH1bIFx0XSo7ezAsMX0pK3woZXhwb3J0WyBcdF0rKSkvZywgIiQxIikuc2xpY2UoMSk7CiAgICAgICAgICAgIGNvbnN0IGJsb2IgPSBuZXcgQmxvYihbY29udmVydGVkVGV4dF0sIHsgdHlwZTogInRleHQvamF2YXNjcmlwdCIgfSk7CiAgICAgICAgICAgIGNvbnN0IHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7CiAgICAgICAgICAgIHJlYWRlci5yZWFkQXNEYXRhVVJMKGJsb2IpOwogICAgICAgICAgICBjb25zdCBkYXRhVVJJID0geWllbGQgbmV3IFByb21pc2UoKHJlcykgPT4gewogICAgICAgICAgICAgICAgcmVhZGVyLm9ubG9hZGVuZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXMocmVhZGVyLnJlc3VsdCk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgc2VsZlVybCA9IG5ldyBVUkwoZGF0YVVSSSwgZG9jdW1lbnQuYmFzZVVSSSk7CiAgICAgICAgICAgIHJldHVybiBuZXcgSENBV29ya2VyKHNlbGZVcmwsIGJsb2IpOwogICAgICAgIH0pOwogICAgfQogICAgY29uc3RydWN0b3Ioc2VsZlVybCwgc2VsZkJsb2IpIHsKICAgICAgICB0aGlzLmxhc3RUaWNrID0gMDsKICAgICAgICB0cnkgewogICAgICAgICAgICB0aGlzLmhjYVdvcmtlciA9IG5ldyBXb3JrZXIoc2VsZlVybCwgeyB0eXBlOiAibW9kdWxlIiB9KTsgLy8gc2V0dGluZyB0eXBlIHRvICJtb2R1bGUiIGlzIGN1cnJlbnRseSBib2d1cyBpbiBGaXJlZm94CiAgICAgICAgfQogICAgICAgIGNhdGNoIChlKSB7CiAgICAgICAgICAgIC8vIHdvcmthcm91bmQgZm9yIGxlZ2FjeSBpT1MgU2FmYXJpCiAgICAgICAgICAgIGlmIChzZWxmQmxvYiA9PSBudWxsIHx8ICEoc2VsZkJsb2IgaW5zdGFuY2VvZiBCbG9iKSkKICAgICAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICAgIGNvbnN0IG9ialVybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwoc2VsZkJsb2IpOwogICAgICAgICAgICB0aGlzLmhjYVdvcmtlciA9IG5ldyBXb3JrZXIob2JqVXJsLCB7IHR5cGU6ICJtb2R1bGUiIH0pOwogICAgICAgICAgICBVUkwucmV2b2tlT2JqZWN0VVJMKG9ialVybCk7CiAgICAgICAgfQogICAgICAgIHRoaXMuc2VsZlVybCA9IHNlbGZVcmw7CiAgICAgICAgdGhpcy50YXNrUXVldWUgPSBuZXcgSENBVGFza1F1ZXVlKCJNYWluLUhDQVdvcmtlciIsIChtc2csIHRyYW5zKSA9PiB0aGlzLmhjYVdvcmtlci5wb3N0TWVzc2FnZShtc2csIHRyYW5zKSwgKHRhc2spID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgc3dpdGNoICh0YXNrLmNtZCkgewogICAgICAgICAgICAgICAgY2FzZSAic2VsZi1kZXN0cnVjdCI6IC8vIGRvZXNuJ3Qgc2VlbSB0byBoYXZlIGEgY2hhbmNlIHRvIGJlIGNhbGxlZAogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYGhjYVdvcmtlciByZXF1ZXN0ZWQgdG8gc2VsZi1kZXN0cnVjdGApOwogICAgICAgICAgICAgICAgICAgIHlpZWxkIHRoaXMudGFza1F1ZXVlLnNodXRkb3duKHRydWUpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfSksICgpID0+IHRoaXMuaGNhV29ya2VyLnRlcm1pbmF0ZSgpKTsKICAgICAgICB0aGlzLmhjYVdvcmtlci5vbm1lc3NhZ2UgPSAobXNnKSA9PiB0aGlzLnRhc2tRdWV1ZS5tc2dIYW5kbGVyKG1zZyk7CiAgICAgICAgdGhpcy5oY2FXb3JrZXIub25lcnJvciA9IChtc2cpID0+IHRoaXMudGFza1F1ZXVlLmVyckhhbmRsZXIobXNnKTsKICAgICAgICB0aGlzLmhjYVdvcmtlci5vbm1lc3NhZ2VlcnJvciA9IChtc2cpID0+IHRoaXMudGFza1F1ZXVlLmVyckhhbmRsZXIobXNnKTsKICAgIH0KICAgIC8vIGNvbW1hbmRzCiAgICBnZXRUcmFuc2ZlckNvbmZpZygpIHsKICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgICByZXR1cm4geWllbGQgdGhpcy50YXNrUXVldWUuZ2V0VHJhbnNmZXJDb25maWcoKTsKICAgICAgICB9KTsKICAgIH0KICAgIGNvbmZpZ1RyYW5zZmVyKHRyYW5zZmVyQXJncywgcmVwbHlBcmdzKSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgcmV0dXJuIHlpZWxkIHRoaXMudGFza1F1ZXVlLmNvbmZpZ1RyYW5zZmVyKHRyYW5zZmVyQXJncywgcmVwbHlBcmdzKTsKICAgICAgICB9KTsKICAgIH0KICAgIGZpeEhlYWRlckNoZWNrc3VtKGhjYSkgewogICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAgIHJldHVybiB5aWVsZCB0aGlzLnRhc2tRdWV1ZS5leGVjQ21kKCJmaXhIZWFkZXJDaGVja3N1bSIsIFtoY2FdKTsKICAgICAgICB9KTsKICAgIH0KICAgIGZpeENoZWNrc3VtKGhjYSkgewogICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAgIHJldHVybiB5aWVsZCB0aGlzLnRhc2tRdWV1ZS5leGVjQ21kKCJmaXhDaGVja3N1bSIsIFtoY2FdKTsKICAgICAgICB9KTsKICAgIH0KICAgIGRlY3J5cHQoaGNhLCBrZXkxLCBrZXkyKSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgcmV0dXJuIHlpZWxkIHRoaXMudGFza1F1ZXVlLmV4ZWNDbWQoImRlY3J5cHQiLCBbaGNhLCBrZXkxLCBrZXkyXSk7CiAgICAgICAgfSk7CiAgICB9CiAgICBlbmNyeXB0KGhjYSwga2V5MSwga2V5MikgewogICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAgIHJldHVybiB5aWVsZCB0aGlzLnRhc2tRdWV1ZS5leGVjQ21kKCJlbmNyeXB0IiwgW2hjYSwga2V5MSwga2V5Ml0pOwogICAgICAgIH0pOwogICAgfQogICAgYWRkSGVhZGVyKGhjYSwgc2lnLCBuZXdEYXRhKSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgcmV0dXJuIHlpZWxkIHRoaXMudGFza1F1ZXVlLmV4ZWNDbWQoImFkZEhlYWRlciIsIFtoY2EsIHNpZywgbmV3RGF0YV0pOwogICAgICAgIH0pOwogICAgfQogICAgYWRkQ2lwaGVySGVhZGVyKGhjYSwgY2lwaGVyVHlwZSkgewogICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAgIHJldHVybiB5aWVsZCB0aGlzLnRhc2tRdWV1ZS5leGVjQ21kKCJhZGRDaXBoZXJIZWFkZXIiLCBbaGNhLCBjaXBoZXJUeXBlXSk7CiAgICAgICAgfSk7CiAgICB9CiAgICBkZWNvZGUoaGNhLCBtb2RlID0gMzIsIGxvb3AgPSAwLCB2b2x1bWUgPSAxLjApIHsKICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgICByZXR1cm4geWllbGQgdGhpcy50YXNrUXVldWUuZXhlY0NtZCgiZGVjb2RlIiwgW2hjYSwgbW9kZSwgbG9vcCwgdm9sdW1lXSk7CiAgICAgICAgfSk7CiAgICB9CiAgICBsb2FkSENBRm9yUGxheWluZyhoY2EsIGtleTEsIGtleTIpIHsKICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgICBpZiAodHlwZW9mIGhjYSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIGlmIChoY2EgPT09ICIiKQogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiZW1wdHkgVVJMIik7CiAgICAgICAgICAgICAgICBoY2EgPSBuZXcgVVJMKGhjYSwgZG9jdW1lbnQuYmFzZVVSSSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoIShoY2EgaW5zdGFuY2VvZiBVUkwpICYmICEoaGNhIGluc3RhbmNlb2YgVWludDhBcnJheSkpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImhjYSBtdXN0IGJlIGVpdGhlciBVUkwgb3IgVWludDhBcnJheSIpOwogICAgICAgICAgICBpZiAodGhpcy5hd0hjYVBsYXllciA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF3SGNhUGxheWVyID0geWllbGQgSENBQXVkaW9Xb3JrbGV0SENBUGxheWVyLmNyZWF0ZSh0aGlzLnNlbGZVcmwsIGhjYSwga2V5MSwga2V5Mik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLmF3SGNhUGxheWVyLnNldFNvdXJjZShoY2EsIGtleTEsIGtleTIpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CiAgICBwYXVzZVBsYXlpbmcoKSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuYXdIY2FQbGF5ZXIgPT0gbnVsbCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgICAgICB5aWVsZCB0aGlzLmF3SGNhUGxheWVyLnBhdXNlKCk7CiAgICAgICAgfSk7CiAgICB9CiAgICByZXN1bWVQbGF5aW5nKCkgewogICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmF3SGNhUGxheWVyID09IG51bGwpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICAgICAgeWllbGQgdGhpcy5hd0hjYVBsYXllci5wbGF5KCk7CiAgICAgICAgfSk7CiAgICB9CiAgICBzdG9wUGxheWluZygpIHsKICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgICBpZiAodGhpcy5hd0hjYVBsYXllciA9PSBudWxsKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgICAgIHlpZWxkIHRoaXMuYXdIY2FQbGF5ZXIuc3RvcCgpOwogICAgICAgIH0pOwogICAgfQp9Cg==", document.baseURI);
        var hcaJsModule, hcaJsObjUrl, HCAInfo, HCAWorker, HCAWebAudioLoopPlayer;

        // mime types
        const defMimeType = "application/octet-stream";
        const mimeTypeMap = {
            wav: "audio/x-wav",
            hca: defMimeType,
        }

        // HCAWorker instance
        var worker = null;

        // HCAWebAudioLoopPlayer instance
        var webAudioLoopPlayer = null;

        // dragged file
        var draggedFile = null;

        // local file picker
        const localfile = document.getElementById("localfile");
        const localfileform = document.getElementById("localfileform");
        // onchange does not work on iOS Safari
        localfile.addEventListener("change", function (ev) {buttons.loadfilebtn = this.files.length > 0;});
        // reset state on refresh
        // https://bugzilla.mozilla.org/show_bug.cgi?id=685657
        localfileform.reset();
        // workaround for iOS Safari file picker
        document.getElementById("hcaonly").addEventListener("change", function(ev) {
            localfile.accept = ev.target.checked ? ".hca,application/octet-stream" : "";
        });

        // input HCA URL
        const urlinput = document.getElementById("urlinput");

        // file name
        var fileName = null;

        // HCA info table
        const hcaInfoTable = {
            el: document.getElementById("hcaInfoTable"),
            body: {
                el: document.getElementById("hcaInfoTable")
                    .getElementsByTagName('tbody')[0],
                defText: document.getElementById("hcaInfoTable")
                    .getElementsByTagName('tbody')[0]
                    .getElementsByTagName("td")[0]
                    .textContent,
                data: {},
            },
        }
        Object.defineProperty(hcaInfoTable.body, "data", {
            get: function () {return this.value},
            set: function (val) {
                // clear existing content
                for (let i = hcaInfoTable.body.el.getElementsByTagName("tr").length - 1; i >= 0; i--) {
                    hcaInfoTable.body.el.deleteRow(i);
                }
                function appendRow(cells, rowspan) {
                    let newRow = hcaInfoTable.body.el.insertRow(-1);
                    cells.forEach((val, idx) => {
                        let newCell = newRow.insertCell(idx);
                        if (rowspan != null && idx == 0)
                            newCell.setAttribute("rowspan", rowspan);
                        if (cells.length < 3 && idx == cells.length - 1)
                            newCell.setAttribute("colspan", cells.length - idx + 1);
                        let newText = val != null
                            ? document.createTextNode("" + val)
                            : (() => {
                                let italic = document.createElement("i");
                                italic.innerHTML = "(not defined)";
                                return italic;
                            })();
                        newCell.appendChild(newText);
                    });
                }
                function toHex(num) {
                    const padding = "0000";
                    let hex = padding + num.toString(padding.length * 4).toUpperCase();
                    return "0x" + hex.substring(hex.length - padding.length, hex.length)
                }
                if (val == null || !val instanceof HCAInfo) {
                    appendRow([hcaInfoTable.body.defText]);
                    return; // nothing to add
                }
                // add given content
                let info = val;
                const hcaInfoTextArray = [
                    ["Version", info.version],
                    ["Header size", info.dataOffset],
                    ["Format", !info.hasHeader["fmt"] ? null : [
                        ["Channels", info.format.channelCount],
                        ["Sampling Rate", info.format.samplingRate],
                        ["Blocks", info.format.blockCount],
                        ["Dropped smpl. (head)", info.format.droppedHeader],
                        ["Dropped smpl. (tail)", info.format.droppedFooter],
                        ["Duration (calc)", `${info.duration.toFixed(3)}s`],
                    ]],
                    ["Block size", !info.hasHeader["comp"] && !info.hasHeader["dec"] ? null : info.blockSize],
                    ["Bitrate (kbps)", !info.hasHeader["comp"] && !info.hasHeader["dec"] ? null : info.kbps],
                    ["VBR", info.hasHeader["vbr"] ? "yes" : "no"],
                    ["ATH", !info.hasHeader["ath"] ? null : toHex(info.ath)],
                    ["Loop", !info.hasHeader["loop"] ? null : [
                        ["Start", info.loop.start],
                        ["End", info.loop.end],
                        ["Dropped smpl. (head)", info.loop.droppedHeader],
                        ["Dropped smpl. (tail)", info.loop.droppedFooter],
                        ["StartTime (calc)", `${info.loopStartTime.toFixed(3)}s`],
                        ["EndTime (calc)", `${info.loopEndTime.toFixed(3)}s`],
                        ["Duration (calc)", `${info.loopDuration.toFixed(3)}s`],
                    ]],
                    ["Cipher", !info.hasHeader["ciph"] ? null : toHex(info.cipher)],
                    ["RVA (volume)", !info.hasHeader["rva"] ? null : info.rva],
                    ["Comment", !info.hasHeader["comm"] ? null : info.comment],
                ];
                for (let item of hcaInfoTextArray) {
                    let key = item[0];
                    let val = item[1];
                    if (Array.isArray(val)) {
                        let textList = val[0].slice(0);
                        textList.unshift(key);
                        appendRow(textList, val.length);
                        val.shift();
                        val.forEach((item) => appendRow(item))
                    } else {
                        appendRow([key, val]);
                    }
                }
                // update value
                this.value = val;
            },
        });

        // keys
        const keys = {key1: undefined, key2: undefined};
        for (let key in keys) {
            Object.defineProperty(keys, key, {
                get: function () {return document.getElementById(key + "input").value},
                set: function (val) {document.getElementById(key + "input").value = val},
            });
        }

        // mode/loop/volume
        const decodingParam = {
            mode: {
                el: document.getElementById("decodingmodeinput"),
                defVal: 16,
            },
            loop: {
                el: document.getElementById("loopcountinput"),
                defVal: 0,
            },
            volumePerCent: {
                el: document.getElementById("volumeinput"),
                defVal: 100,
            },
        }

        function setVolume(val) {
            val = Number(val) / 100;
            if (webAudioLoopPlayer != null) {
                webAudioLoopPlayer.volume = val;
            }
        }
        document.getElementById("volumeslider").addEventListener("input", (ev) => {
            const val = ev.target.value;
            document.getElementById("volumeinput").value = val;
            setVolume(val);
        });
        document.getElementById("volumeinput").addEventListener("input", (ev) => {
            const val = ev.target.value;
            const slider = document.getElementById("volumeslider");
            if (slider.value != val) {
                slider.value = val;
            }
            setVolume(val);
        });

        for (let paramName in decodingParam) {
            let el = decodingParam[paramName].el;
            let defVal = decodingParam[paramName].defVal;
            let attr = {};
            ["min", "max", "step"].forEach((attrName) => attr[attrName] = el.getAttribute(attrName));
            let clampVal = function (val) {
                if (val == null || val === "")
                    return defVal;
                val = parseInt(val);
                if (isNaN(val))
                    return defVal;
                if (val % attr.step != 0)
                    val = Math.floor(val / attr.step);
                else if (val < attr.min)
                    val = attr.min;
                else if (val > attr.max)
                    val = attr.max;
                return val;
            }
            Object.defineProperty(decodingParam, paramName, {
                get: function () {
                    let clamped = clampVal(el.value);
                    el.value = "" + clamped;
                    return clamped;
                },
                set: function (val) {
                    el.value = "" + clampVal(val);
                }
            });
        }

        // HCA file data
        const hcaFileData = {
            // original HCA file content
            original: {
                btnID: "downloadbtn",
                data: {},
            },
            // after fixing checksum
            fixed_checksum: {
                btnID: "fixcsumbtn",
                data: {},
            },
            // after decryption
            decrypted: {
                btnID: "decryptbtn",
                data: {},
            },
            // after encryption
            encrypted: {
                btnID: "encryptbtn",
                data: {},
            },
            // after decoding
            decoded: {
                btnID: "decodetoh5btn",
                data: {},
            },
        }
        for (let suffix in hcaFileData) {
            Object.defineProperty(hcaFileData[suffix], "data", {
                get: function () {return this.value},
                set: function (val) {
                    this.value = null; // clear existing data
                    const fileExtRegEx = /\.([^\.]+)$/;
                    let newFileName = fileName.replace(fileExtRegEx, "_" + suffix + ".$1");
                    if (suffix === "decoded")
                        newFileName = newFileName.replace(fileExtRegEx, ".wav");
                    let id = suffix + "-download-link";
                    let el = document.getElementById(id);
                    if (el != null) {
                        // remove existing download link
                        URL.revokeObjectURL(el.getAttribute("href"));
                        el.nextSibling.remove();
                        el.remove();
                    }
                    if (val == null) {
                        console.log(`hcaFileData ${suffix} cleared`);
                        return; // nothing to create
                    }
                    console.log(`hcaFileData ${suffix} byteLength=${val.byteLength}`);
                    // create new download link
                    el = document.createElement("a");
                    el.setAttribute("id", id);
                    el.setAttribute("download", newFileName);
                    let extName = newFileName.match(fileExtRegEx)[0];
                    let mimeType = mimeTypeMap[extName];
                    if (mimeType == null) mimeType = defMimeType;
                    el.setAttribute("href", URL.createObjectURL(new Blob([val], {type: mimeType})));
                    el.innerHTML = newFileName;
                    let refNode = document.getElementById(hcaFileData[suffix].btnID).nextSibling;
                    refNode.parentElement.insertBefore(document.createElement("br"), refNode);
                    refNode.parentElement.insertBefore(el, refNode);
                    // update value
                    this.value = val;
                },
            });
        }
        function clearAllData() {
            localfileform.reset();
            for (let suffix in hcaFileData) {
                hcaFileData[suffix].data = null;
            }
            hcaInfoTable.body.data = null;
            audioElement.src = null;
            console.log(`cleared all data`);
        }

        // Audio element
        const audioElement = {
            el: document.getElementById("audioElement"),
            src: ""
        };
        Object.defineProperty(audioElement, "src", {
            get: function () {return this.value},
            set: function (val) {
                if (this.value != null && this.value != "")
                    URL.revokeObjectURL(this.value);
                if (val == null || val === "") {
                    this.value = audioElement.el.src = "";
                    return;
                }
                let newUrl;
                if (val instanceof ArrayBuffer || val.buffer instanceof ArrayBuffer) {
                    newUrl = URL.createObjectURL(new Blob([val], {type: mimeTypeMap.wav}));
                } else {
                    newUrl = val;
                }
                this.value = audioElement.el.src = newUrl;
            }
        });

        // buttons
        const buttons = {
            startworkerbtn: async (self) => {
                if (worker == null) {
                    if (hcaJsObjUrl == null) {
                        const response = await fetch(hcaJsUrl.href);
                        const blob = new Blob([await response.arrayBuffer()], {type: "text/javascript"});
                        hcaJsObjUrl = URL.createObjectURL(blob);
                    }
                    if (hcaJsModule == null) {
                        hcaJsModule = await import(hcaJsObjUrl);
                    }
                    if (HCAInfo == null) HCAInfo = hcaJsModule.HCAInfo;
                    if (HCAWorker == null) HCAWorker = hcaJsModule.HCAWorker;
                    if (HCAWebAudioLoopPlayer == null) HCAWebAudioLoopPlayer = hcaJsModule.HCAWebAudioLoopPlayer;
                    worker = await HCAWorker.create(hcaJsObjUrl);
                    console.log("started background worker");
                }
                self.disabled = true; // added because button won't grey out if there's any await above
                buttons.shutdownbtn = true;
            },
            shutdownbtn: async (self) => {
                if (worker != null) {
                    await worker.shutdown();
                    worker = null;
                    console.log("background worker is now shut down");
                }
                self.disabled = true; // added together with above startworkerbtn
                buttons.startworkerbtn = true;
            },
            loadfilebtn: async (self) => {
                let file = null;
                if (draggedFile != null) {
                    self.textContent = "loading dragged file...";
                    file = draggedFile;
                    draggedFile = null;
                } else {
                    self.textContent = "loading picked file...";
                    file = localfile.files[0];
                }
                let newFileName = file.name;
                // update fileName
                fileName = newFileName;
                // clear all existing data
                clearAllData();
                resetButtonsExcept(self.id);
                // update data
                let ab;
                if (file.arrayBuffer == null) {
                    let objUrl = URL.createObjectURL(file);
                    let resp = await fetch(objUrl);
                    URL.revokeObjectURL(objUrl);
                    ab = await resp.arrayBuffer();
                } else {
                    ab = await file.arrayBuffer();
                }
                hcaFileData.original.data = new Uint8Array(ab);
                self.textContent = "load picked file (successful)";
                // no need to let the button bounce
                // next step
                buttons.awloadwholehcabtn = true;
                buttons.infobtn = true;
                buttons.fixcsumbtn = true;
            },
            downloadbtn: async (self) => {
                self.textContent = "downloading...";
                let requestUrl = urlinput.value;
                if (requestUrl === "") {
                    self.textContent = "download (empty URL)";
                    self.disabled = false;
                    return;
                }
                let response = null;
                try {
                    response = await fetch(requestUrl);
                } catch (e) {
                    console.error(e);
                    self.textContent = "download (network error)";
                    self.disabled = false;
                    return;
                }
                if (response.status != 200) {
                    console.error("download failed,", response);
                    self.textContent = `download (failed, ${response.status} ${response.statusText})`;
                    self.disabled = false;
                    return;
                }
                // get filename from Content-Disposition
                let cd = response.headers.get("Content-Disposition");
                let newFileName = null;
                if (cd != null) {
                    let splitted = cd.split(";");
                    let cdFileName = splitted.find((substr) => substr.startsWith("filename="));
                    if (cdFileName != null) {
                        newFileName = cdFileName.substring("filename=".length)
                            .replaceAll(" ", "")
                            .replaceAll("\"", "");
                    }
                }
                // failed to get filename from Content-Disposition, try URL
                const fileNameRegEx = /[^\/^\\]+$/;
                if (newFileName == null || newFileName === "") {
                    let urlFilename = [response.url, requestUrl].find((url) => url != null && url.match(fileNameRegEx));
                    if (urlFilename != null)
                        newFileName = urlFilename.match(fileNameRegEx)[0];
                }
                // failed to get filename, use default filename
                if (newFileName == null || newFileName === "") {
                    newFileName = "downloaded.hca";
                }
                // strip query string
                let stripped = newFileName.match(/^[^\?]+/);
                if (stripped != null)
                    newFileName = stripped[0];
                // update fileName
                fileName = newFileName;
                // clear all existing data
                clearAllData();
                resetButtonsExcept(self.id);
                // update data
                let ab = await response.arrayBuffer();
                hcaFileData.original.data = new Uint8Array(ab);
                self.textContent = "download (successful)";
                // let the button bounce
                self.disabled = false;
                // next step
                buttons.awloadwholehcabtn = true;
                buttons.infobtn = true;
                buttons.fixcsumbtn = true;
            },
            awloadwholehcabtn: async (self) => {
                try {
                    await worker.loadHCAForPlaying(hcaFileData.original.data, keys.key1, keys.key2);
                    self.textContent = "Load (successful)";
                } catch (e) {
                    self.textContent = "Load (failed)";
                    console.error(e);
                }
                // let the button bounce
                self.disabled = false;
                // next step
                buttons.awpausebtn = false;
                buttons.awresumebtn = true;
                buttons.awstopbtn = true;
                // TODO pause/rewind/fast-forward etc
            },
            awloadfromurlbtn: async (self) => {
                try {
                    await worker.loadHCAForPlaying(urlinput.value, keys.key1, keys.key2);
                    self.textContent = "Load (successful)";
                } catch (e) {
                    self.textContent = "Load (failed)";
                    console.error(e);
                }
                // let the button bounce
                self.disabled = false;
                // next step
                buttons.awpausebtn = false;
                buttons.awresumebtn = true;
                buttons.awstopbtn = true;
                // TODO rewind/fast-forward etc
            },
            awpausebtn: async (self) => {
                try {
                    await worker.pausePlaying();
                    self.textContent = "Paused";
                } catch (e) {
                    self.textContent = "Pause (Error)";
                    console.log(e);
                    // let the button bounce
                    self.disabled = false;
                }
                // next step
                buttons.awresumebtn = true;
            },
            awresumebtn: async (self) => {
                try {
                    await worker.resumePlaying();
                    self.textContent = "Playing/Resumed";
                } catch (e) {
                    self.textContent = "Play/Resume (Error)";
                    console.log(e);
                    // let the button bounce
                    self.disabled = false;
                }
                // next step
                buttons.awpausebtn = true;
            },
            awstopbtn: async (self) => {
                try {
                    await worker.stopPlaying();
                    self.textContent = "Stopped";
                } catch (e) {
                    self.textContent = "Stop (Error)";
                    console.log(e);
                    // let the button bounce
                    self.disabled = false;
                }
                // next step
                buttons.awpausebtn = false;
                buttons.awresumebtn = false;
            },
            infobtn: async (self) => {
                let hca = hcaFileData[
                    ["fixed_checksum", "original"].find((suffix) => {
                        if (hcaFileData[suffix].data != null) {
                            console.log(`get HCA info from ${suffix} file data`);
                            return true;
                        }
                    })
                ].data;
                try {
                    let info = new HCAInfo(hca);
                    self.textContent = "get HCA info (successful)";
                    // update table content
                    hcaInfoTable.body.data = info;
                    // next step
                    let isEncrypted = info.hasHeader["ciph"] && info.cipher !=0;
                    buttons.encryptbtn = !isEncrypted;
                    buttons.decryptbtn = isEncrypted;
                    buttons.decodetoh5btn = !isEncrypted;
                    buttons.decodetowabtn = !isEncrypted;
                } catch (e) {
                    console.error(e);
                    self.textContent = "get HCA info (failed)";
                }
                // let the button bounce
                self.disabled = false;
            },
            fixcsumbtn: async (self) => {
                try {
                    worker.tick();
                    let newHcaPromise = worker.fixChecksum(hcaFileData.original.data);
                    worker.tock("fix checksum");
                    let newHca = await newHcaPromise;
                    // update data
                    hcaFileData.fixed_checksum.data = newHca;
                    self.textContent = "fix checksum (successful)";
                } catch (e) {
                    console.error(e);
                    self.textContent = "fix checksum (failed)";
                }
                // let the button bounce
                self.disabled = false;
            },
            encryptbtn: async (self) => {
                await encryptOrDecrypt(self, true);
                // let the button bounce
                self.disabled = false;
            },
            decryptbtn: async (self) => {
                await encryptOrDecrypt(self, false);
                // let the button bounce
                self.disabled = false;
            },
            decodetoh5btn: async (self) => {
                // prepare data
                let hca = hcaFileData[
                    ["decrypted", "fixed_checksum", "original"].find((suffix) => {
                        if (hcaFileData[suffix].data != null) {
                            console.log(`decoding ${suffix} data...`);
                            return true;
                        }
                    })
                ].data;
                // start decoding
                try {
                    worker.tick();
                    let decodedPromise = worker.decode(hca,
                        decodingParam.mode, decodingParam.loop, decodingParam.volumePerCent / 100);
                    worker.tock("decoding");
                    let decoded = await decodedPromise;
                    // update data
                    hcaFileData.decoded.data = decoded;
                    self.textContent = "decode (done)";
                    // next step (play)
                    audioElement.src = decoded;
                } catch (e) {
                    console.error(e);
                    self.textContent = "decode (failed)";
                }
                // let the button bounce
                self.disabled = false;
            },
            decodetowabtn: async (self) => {
                // prepare data
                let hca = hcaFileData[
                    ["decrypted", "fixed_checksum", "original"].find((suffix) => {
                        if (hcaFileData[suffix].data != null) {
                            console.log(`decoding ${suffix} data...`);
                            return true;
                        }
                    })
                ].data;
                // start decoding
                try {
                    worker.tick();
                    let decodedPromise = HCAWebAudioLoopPlayer.create(hca, worker, decodingParam.volumePerCent / 100);
                    worker.tock("decoding");
                    let newPlayer = await decodedPromise;
                    // update player instance
                    if (webAudioLoopPlayer != null) await webAudioLoopPlayer.stop();
                    webAudioLoopPlayer = newPlayer;
                    self.textContent = "decode (done)";
                    // next step (play)
                    buttons.webaudioplaybtn = true;
                } catch (e) {
                    console.error(e);
                    self.textContent = "decode (failed)";
                }
                // let the button bounce
                self.disabled = false;
            },
            webaudioplaybtn: async (self) => {
                try {
                    webAudioLoopPlayer.play();
                    self.textContent = "Playing/Resumed";
                } catch (e) {
                    self.textContent = "Play/Resume (Error)";
                    console.log(e);
                    // let the button bounce
                    self.disabled = false;
                }
                // next step
                buttons.webaudiopausebtn = true;
                buttons.webaudiostopbtn = true;
            },
            webaudiopausebtn: async (self) => {
                try {
                    webAudioLoopPlayer.pause();
                    self.textContent = "Paused";
                } catch (e) {
                    self.textContent = "Pause (Error)";
                    console.log(e);
                    // let the button bounce
                    self.disabled = false;
                }
                // next step
                buttons.webaudioplaybtn = true;
            },
            webaudiostopbtn: async (self) => {
                try {
                    await webAudioLoopPlayer.stop();
                    self.textContent = "Stopped";
                } catch (e) {
                    self.textContent = "Stop (Error)";
                    console.log(e);
                    // let the button bounce
                    self.disabled = false;
                }
                // next step
                buttons.webaudiopausebtn = false;
                buttons.webaudioplaybtn = false;
            },
        };
        const _buttons = {};
        for (let id in buttons) {
            let el = document.getElementById(id);
            let onclick = buttons[id];
            el.onclick = (ev) => {
                let self = ev.srcElement;
                self.disabled = true;
                onclick(self);
            }
            const initialText = el.textContent;
            Object.defineProperty(buttons, id, {
                get: function () {return !el.disabled},
                set: function (val) {
                    if (val === "click") {
                        el.disabled = true;
                        onclick(el);
                        return;
                    }
                    el.textContent = initialText;
                    el.disabled = !val;
                },
            });
            Object.defineProperty(_buttons, id, {
                get: function () {return onclick;},
            });
        }
        buttons.startworkerbtn = "click"; // start background worker
        function resetButtonsExcept(exceptBtnID) {
            for (let btnID in buttons) {
                if (btnID !== exceptBtnID) switch (btnID) {
                    case "startworkerbtn":
                        buttons[btnID] = worker == null || !worker.isAlive;
                        break;
                    case "shutdownbtn":
                        buttons[btnID] = worker != null && worker.isAlive;
                        break;
                    case "loadfilebtn":
                        buttons[btnID] = false;
                        break;
                    case "downloadbtn":
                        buttons[btnID] = true;
                        break;
                    case "awloadwholehcabtn":
                        buttons[btnID] = false;
                        break;
                    case "awloadfromurlbtn":
                        buttons[btnID] = true;
                        break;
                    case "awresumebtn":
                    case "awpausebtn":
                    case "awstopbtn":
                        // do not reset except on refresh
                        if (exceptBtnID == null) buttons[btnID] = false;
                        break;
                    default:
                        buttons[btnID] = false;
                }
            }
        }
        resetButtonsExcept(); // same to above, reset state on refresh
        async function encryptOrDecrypt(self, isEncrypting) {
            const action = isEncrypting ? "encrypt" : "decrypt";
            const opposite = isEncrypting ? "decrypt" : "encrypt";
            // disable both buttons
            self.disabled = true;
            buttons[opposite + "btn"] = false;
            self.textContent = action + "ing...";
            // disable decodetoh5btn and decodetowabtn if necessary
            if (!isEncrypting) {
                buttons.decodetoh5btn = false;
                buttons.decodetowabtn = false;
            }
            // prepare data
            let hca = hcaFileData[
                [opposite + "ed", "fixed_checksum", "original"].find((suffix) => {
                    if (hcaFileData[suffix].data != null) {
                        console.log(`${action}ing ${suffix} data...`);
                        return true;
                    }
                })
            ].data;
            if (isEncrypting && !hcaInfoTable.body.data.hasHeader["ciph"]) {
                // check for ciph header section
                console.log("input HCA lacks ciph header section, adding it");
                hca = await worker.addCipherHeader(hca);
            } else {
                hca = hca.slice(0); // just copy to new buffer
            }
            // start to encrypt/decrypt
            try {
                worker.tick();
                // although decryption/encryption is done in-place,
                // however since we are not using SharedArrayBuffer,
                // the background worker is still actually overwritting a newly allocated buffer
                let resultPromise = worker[action](hca, keys.key1, keys.key2);
                worker.tock(isEncrypting ? "encryption" : "decryption");
                let result = await resultPromise;
                self.textContent = action + " (done)";
                // update data
                hcaFileData[action + "ed"].data = result;
                // next steps
                buttons[opposite + "btn"] = true;
                if (!isEncrypting) {
                    buttons.decodetoh5btn = true;
                    buttons.decodetowabtn = true;
                }
            } catch (e) {
                console.error(e);
                self.textContent = "Error during " + (isEncrypting ? "encryption" : "decryption");
            }
        }
        window.addEventListener("dragover", function (ev) {
            // https://stackoverflow.com/questions/46668079/addeventlistener-drop-not-firing
            ev.preventDefault();
        });
        var tryingUnlock = false;
        function tryUnlock() {
            if (worker.awHcaPlayer && !worker.awHcaPlayer.unlocked) {
                // FIXME temporary workaround
                if (!tryingUnlock) {
                    tryingUnlock = true;
                    const id = "awresumebtn";
                    const el = document.getElementById(id);
                    el.disabled = true;
                    _buttons[id](el).then(() => {tryingUnlock = false;});
                }
            }
        }
        window.addEventListener("click", function (ev) {
            tryUnlock();
        });
        window.addEventListener("drop", function (ev) {
            ev.preventDefault();
            let file = null;
            const dtItems = ev.dataTransfer.items;
            const dtFiles = ev.dataTransfer.files;
            if (dtItems != null && dtItems.length == 1) {
                // Use DataTransferItemList interface to access the file(s)
                const item = dtItems[0];
                if (item.kind === "file") {
                    file = item.getAsFile();
                }
            } else if (dtFiles != null && dtFiles.length == 1) {
                // Use DataTransfer interface to access the file(s)
                file = dtFiles[0];
            }
            if (file != null) {
                draggedFile = file;
                let btnToClick = ["loadfilebtn", "infobtn"];
                const autoPlay = document.getElementById("awautoplayondrop").checked;
                if (autoPlay) {
                    btnToClick.push("awloadwholehcabtn", "awresumebtn");
                    //tryUnlock(); // did not seem to work
                }
                const iter = btnToClick.values();
                const clickNextBtn = function () {
                    let id = iter.next();
                    if (id.done) return;
                    id = id.value;
                    if (typeof id !== "string") throw new Error();
                    if (id === "awloadwholehcabtn" || id === "awresumebtn") {
                        if (worker.awHcaPlayer && !worker.awHcaPlayer.unlocked) {
                            // FIXME temporary workaround
                            console.warn("awHcaPlayer is still locked, give up before clicking " + id);
                            return;
                        }
                    }
                    const el = document.getElementById(id);
                    el.disabled = true;
                    _buttons[id](el).then(() => {clickNextBtn();});
                }
                clickNextBtn();
            }
        });
    </script>
</body>
</html>