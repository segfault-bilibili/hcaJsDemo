<!DOCTYPE html>
<html>

<head></head>

<body>
    <h1>HCA decoder demo</h1>
    <i>Standalone version - you may right-click & save this page for offline use.</i><br>
    <a href="https://github.com/y2361547758/hca.js">GitHub repo</a>
    <hr>
    <button disabled id="startworkerbtn">start background worker</button><br>
    <button disabled id="shutdownbtn">shutdown background worker</button><br>
    <hr>
    <h3>Choose a HCA or AWB file</h3>
    Drag & drop a file here,<br>
    <form id="localfileform">
        Or pick a local file: <input type="file" id="localfile" accept=".hca,application/octet-stream"><br>
        <input type="checkbox" id="hcaonly" checked>
        <label for="hcaonly">pick HCA file only (uncheck if unable to pick)</label><br>
    </form>
    <b><u>Don't forget to</u></b> <button disabled id="loadfilebtn">load picked file</button><br>
    Or download from URL: <input type="text" spellcheck="false" id="urlinput" value="bgm22_battle01_hca.hca"><br>
    <button id="downloadbtn">download</button><br>
    <div id="awbsubsongswitcher"></div>
    <hr>
    <h3>Set keys for decryption/encryption</h3>
    key1=<input type="text" spellcheck="false" id="key1input" value="0x01395C51"><br>
    key2=<input type="text" spellcheck="false" id="key2input" value="0x00000000"><br>
    <i>(optional) </i>subkey=<input type="text" spellcheck="false" id="subkeyinput" value="0x0"><br>
    <i>Note: output waveform will be (almostly all) silence if incorrect keys are given!</i><br>
    <hr>
    <h3>Streaming (<a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioWorklet">AudioWorklet API</a>)</h3>
    <input type="checkbox" checked id="awautoplayondrop">
    <label for="awautoplyondrop">Automatically play drag & dropped HCA file</label><br>
    <b><u>Some browsers like Safari (Apple WebKit) may lock AudioContext initially, which blocks auto-play.<br>
            To unlock AudioContext (so that auto-play will no longer be blocked),<br>
            please click anywhere on this page after drag & drop.</u></b><br>
    Load a HCA file for playing, which has been fully loaded/downloaded above:<br>
    <button id="awloadwholehcabtn">Load</button><br>
    Load directly from the URL above, without fully downloading the whole file:<br>
    <button id="awloadfromurlbtn">Load</button><br>
    Progress control:<br>
    <button id="awresumebtn">Play/Resume</button><br>
    <button id="awpausebtn">Pause</button><br>
    <button id="awstopbtn">Stop</button><br>
    <hr>
    <h3>Decode the whole file</h3>
    Note:<br>
    (1) <b>Please click "get HCA info" button first.</b><br>
    (2) Setting decoding mode to <b>zero means 32-bit float mode</b>, or <b>8/16/24/32-bit integer mode</b>
    otherwise.<br>
    (3) Loop count is <b>ignored if HCA header doesn't have loop section</b><br>
    (4) Loop count doesn't count the existing part which is originally supposed to be looped.<br>
    &nbsp;&nbsp;&nbsp;&nbsp;<b>In other words, actual loop count will be: the number set here plus one.</b><br>
    (5) When <b>decoding the whole file</b>, setting loop count to <b>zero</b> means: <b>disabling loop</b>.</b><br>
    <fieldset>
        <legend>HCA info</legend>
        <button disabled id="infobtn">get HCA info</button><br>
        <style>
            table {
                border-top: 1px solid #000;
                border-left: 1px solid #000;
                border-spacing: 0;
            }

            tbody td {
                border-bottom: 1px solid #000;
                border-right: 1px solid #000;
                min-width: 8ch;
            }

            thead tr th,
            tfoot tr th {
                background-color: #fff;
                color: #000;
                border-bottom: 1px solid #000;
                border-right: 1px solid #000;
            }
        </style>
        <table id="hcaInfoTable">
            <thead>
                <tr>
                    <th colspan="3">HCA info</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>(Not loaded)</td>
                </tr>
            </tbody>
        </table>
    </fieldset>
    <fieldset>
        <legend>Checksum</legend>
        <button disabled id="fixcsumbtn">fix checksum</button><br>
    </fieldset>
    <fieldset>
        <legend>Cipher</legend>
        <button disabled id="encryptbtn">encrypt</button><br>
        <button disabled id="decryptbtn">decrypt</button><br>
    </fieldset>
    <fieldset>
        <legend>Decoding parameters</legend>
        Decoding mode: <input type="number" step="8" min="0" max="32" placeholder="0-99" id="decodingmodeinput"
            value="16"><br>
        Loop count: <input type="number" step="1" min="0" max="99" placeholder="0-99" id="loopcountinput" value="0"><br>
        Volume: <input type="range" step="1" min="0" max="100" placeholder="0-100" id="volumeslider" value="100">
        <input type="number" step="1" min="0" max="100" placeholder="0-100" id="volumeinput" value="100"><br>
    </fieldset>
    <fieldset>
        <legend>Decode to HTML5 Audio</legend>
        <button disabled id="decodetoh5btn">decode</button><br>
        <audio id="audioElement" controls></audio><br>
    </fieldset>
    <fieldset>
        <legend>Decode to WebAudio AudioBufferSourceNode</legend>
        <b>Playing will seamlessly loop if HCA supports looping.</b><br>
        <button disabled id="decodetowabtn">decode</button><br>
        <button disabled id="webaudioplaybtn">Play</button><br>
        <button disabled id="webaudiopausebtn">Pause</button><br>
        <button disabled id="webaudiostopbtn">Stop</button><br>
    </fieldset>
    <!-- <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.8.3/dist/ffmpeg.min.js"></script> -->
    <script>
        var AWBSubsongSelect = null;
    </script>
    <script type="module">
        const hcaJsUrl = new URL("data:text/javascript;base64,dmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7CiAgICBmdW5jdGlvbiBhZG9wdCh2YWx1ZSkgeyByZXR1cm4gdmFsdWUgaW5zdGFuY2VvZiBQID8gdmFsdWUgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHZhbHVlKTsgfSk7IH0KICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgewogICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH0KICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvclsidGhyb3ciXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9CiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBhZG9wdChyZXN1bHQudmFsdWUpLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH0KICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7CiAgICB9KTsKfTsKdmFyIF9hLCBfYjsKZXhwb3J0IGNsYXNzIEhDQUluZm8gewogICAgc3RhdGljIGdldFNpZ24ocmF3LCBvZmZzZXQgPSAwLCBjaGFuZ2VNYXNrLCBlbmNyeXB0KSB7CiAgICAgICAgbGV0IG1hZ2ljID0gcmF3LmdldFVpbnQzMihvZmZzZXQsIHRydWUpOwogICAgICAgIGxldCBzdHJMZW4gPSA0OwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgaSsrKSB7CiAgICAgICAgICAgIGlmIChyYXcuZ2V0VWludDgob2Zmc2V0ICsgaSkgPT0gMCkgewogICAgICAgICAgICAgICAgc3RyTGVuID0gaTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChzdHJMZW4gPiAwKSB7CiAgICAgICAgICAgIGxldCBtYXNrID0gMHg4MDgwODA4MCA+Pj4gOCAqICg0IC0gc3RyTGVuKTsKICAgICAgICAgICAgbWFnaWMgJj0gMHg3ZjdmN2Y3ZjsKICAgICAgICAgICAgaWYgKGNoYW5nZU1hc2spCiAgICAgICAgICAgICAgICByYXcuc2V0VWludDMyKG9mZnNldCwgZW5jcnlwdCA/IG1hZ2ljIHwgbWFzayA6IG1hZ2ljLCB0cnVlKTsKICAgICAgICB9CiAgICAgICAgbGV0IGhleCA9IFttYWdpYyAmIDB4ZmYsIG1hZ2ljID4+IDggJiAweGZmLCBtYWdpYyA+PiAxNiAmIDB4ZmYsIG1hZ2ljID4+IDI0ICYgMHhmZl07CiAgICAgICAgaGV4ID0gaGV4LnNsaWNlKDAsIHN0ckxlbik7CiAgICAgICAgcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUuYXBwbHkoU3RyaW5nLCBoZXgpOwogICAgfQogICAgY2xvbmUoKSB7CiAgICAgICAgcmV0dXJuIG5ldyBIQ0FJbmZvKHRoaXMucmF3SGVhZGVyKTsKICAgIH0KICAgIHBhcnNlSGVhZGVyKGhjYSwgY2hhbmdlTWFzaywgZW5jcnlwdCwgbW9kTGlzdCkgewogICAgICAgIGxldCBwID0gbmV3IERhdGFWaWV3KGhjYS5idWZmZXIsIGhjYS5ieXRlT2Zmc2V0LCA4KTsKICAgICAgICBsZXQgaGVhZCA9IEhDQUluZm8uZ2V0U2lnbihwLCAwLCBmYWxzZSwgZW5jcnlwdCk7IC8vIGRvIG5vdCBvdmVyd3JpdGUgZm9yIG5vdywgdW50aWwgY2hlY2tzdW0gdmVyaWZpZWQKICAgICAgICBpZiAoaGVhZCAhPT0gIkhDQSIpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJOb3QgYSBIQ0EgZmlsZSIpOwogICAgICAgIH0KICAgICAgICBjb25zdCB2ZXJzaW9uID0gewogICAgICAgICAgICBtYWluOiBwLmdldFVpbnQ4KDQpLAogICAgICAgICAgICBzdWI6IHAuZ2V0VWludDgoNSkKICAgICAgICB9OwogICAgICAgIHRoaXMudmVyc2lvbiA9IHZlcnNpb24ubWFpbiArICcuJyArIHZlcnNpb24uc3ViOwogICAgICAgIHRoaXMudmVyc2lvbk1ham9yID0gdmVyc2lvbi5tYWluOwogICAgICAgIHRoaXMudmVyc2lvbk1pbm9yID0gdmVyc2lvbi5zdWI7CiAgICAgICAgdGhpcy5kYXRhT2Zmc2V0ID0gcC5nZXRVaW50MTYoNik7CiAgICAgICAgLy8gdmVyaWZ5IGNoZWNrc3VtCiAgICAgICAgSENBQ3JjMTYudmVyaWZ5KGhjYSwgdGhpcy5kYXRhT2Zmc2V0IC0gMik7CiAgICAgICAgbGV0IGhhc01vZERvbmUgPSBmYWxzZTsKICAgICAgICAvLyBjaGVja3N1bSB2ZXJpZmllZCwgbm93IHdlIGNhbiBvdmVyd3JpdGUgaXQKICAgICAgICBpZiAoY2hhbmdlTWFzaykKICAgICAgICAgICAgSENBSW5mby5nZXRTaWduKHAsIDAsIGNoYW5nZU1hc2ssIGVuY3J5cHQpOwogICAgICAgIC8vIHBhcnNlIHRoZSBoZWFkZXIKICAgICAgICBwID0gbmV3IERhdGFWaWV3KGhjYS5idWZmZXIsIGhjYS5ieXRlT2Zmc2V0LCB0aGlzLmRhdGFPZmZzZXQpOwogICAgICAgIGxldCBmdGVsbCA9IDg7CiAgICAgICAgd2hpbGUgKGZ0ZWxsIDwgdGhpcy5kYXRhT2Zmc2V0IC0gMikgewogICAgICAgICAgICBsZXQgbGFzdEZ0ZWxsID0gZnRlbGw7CiAgICAgICAgICAgIC8vIGdldCB0aGUgc2lnCiAgICAgICAgICAgIGxldCBzaWduID0gSENBSW5mby5nZXRTaWduKHAsIGZ0ZWxsLCBjaGFuZ2VNYXNrLCBlbmNyeXB0KTsKICAgICAgICAgICAgLy8gcmVjb3JkIGhhc0hlYWRlcgogICAgICAgICAgICB0aGlzLmhhc0hlYWRlcltzaWduXSA9IHRydWU7CiAgICAgICAgICAgIC8vIHBhZGRpbmcgc2hvdWxkIGJlIHRoZSBsYXN0IG9uZQogICAgICAgICAgICBpZiAoc2lnbiA9PSAicGFkIikgewogICAgICAgICAgICAgICAgdGhpcy5oZWFkZXJPZmZzZXRbc2lnbl0gPSBbZnRlbGwsIHRoaXMuZGF0YU9mZnNldCAtIDJdOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gcGFyc2UgZGF0YSBhY2NvcmRpbmdseQogICAgICAgICAgICBzd2l0Y2ggKHNpZ24pIHsKICAgICAgICAgICAgICAgIGNhc2UgImZtdCI6CiAgICAgICAgICAgICAgICAgICAgdGhpcy5mb3JtYXQuY2hhbm5lbENvdW50ID0gcC5nZXRVaW50OChmdGVsbCArIDQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZm9ybWF0LnNhbXBsaW5nUmF0ZSA9IHAuZ2V0VWludDMyKGZ0ZWxsICsgNCkgJiAweDAwZmZmZmZmOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZm9ybWF0LmJsb2NrQ291bnQgPSBwLmdldFVpbnQzMihmdGVsbCArIDgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZm9ybWF0LmRyb3BwZWRIZWFkZXIgPSBwLmdldFVpbnQxNihmdGVsbCArIDEyKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZvcm1hdC5kcm9wcGVkRm9vdGVyID0gcC5nZXRVaW50MTYoZnRlbGwgKyAxNCk7CiAgICAgICAgICAgICAgICAgICAgZnRlbGwgKz0gMTY7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJjb21wIjoKICAgICAgICAgICAgICAgICAgICB0aGlzLmJsb2NrU2l6ZSA9IHAuZ2V0VWludDE2KGZ0ZWxsICsgNCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5rYnBzID0gdGhpcy5mb3JtYXQuc2FtcGxpbmdSYXRlICogdGhpcy5ibG9ja1NpemUgLyAxMjgwMDAuMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuTWluUmVzb2x1dGlvbiA9IHAuZ2V0VWludDgoZnRlbGwgKyA2KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuTWF4UmVzb2x1dGlvbiA9IHAuZ2V0VWludDgoZnRlbGwgKyA3KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuVHJhY2tDb3VudCA9IHAuZ2V0VWludDgoZnRlbGwgKyA4KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuQ2hhbm5lbENvbmZpZyA9IHAuZ2V0VWludDgoZnRlbGwgKyA5KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuVG90YWxCYW5kQ291bnQgPSBwLmdldFVpbnQ4KGZ0ZWxsICsgMTApOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29tcERlYy5CYXNlQmFuZENvdW50ID0gcC5nZXRVaW50OChmdGVsbCArIDExKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuU3RlcmVvQmFuZENvdW50ID0gcC5nZXRVaW50OChmdGVsbCArIDEyKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuQmFuZHNQZXJIZnJHcm91cCA9IHAuZ2V0VWludDgoZnRlbGwgKyAxMyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLlJlc2VydmVkMSA9IHAuZ2V0VWludDgoZnRlbGwgKyAxNCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLlJlc2VydmVkMiA9IHAuZ2V0VWludDgoZnRlbGwgKyAxNSk7CiAgICAgICAgICAgICAgICAgICAgZnRlbGwgKz0gMTY7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJkZWMiOgogICAgICAgICAgICAgICAgICAgIHRoaXMuYmxvY2tTaXplID0gcC5nZXRVaW50MTYoZnRlbGwgKyA0KTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmticHMgPSB0aGlzLmZvcm1hdC5zYW1wbGluZ1JhdGUgKiB0aGlzLmJsb2NrU2l6ZSAvIDEyODAwMC4wOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29tcERlYy5NaW5SZXNvbHV0aW9uID0gcC5nZXRVaW50OChmdGVsbCArIDYpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29tcERlYy5NYXhSZXNvbHV0aW9uID0gcC5nZXRVaW50OChmdGVsbCArIDcpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29tcERlYy5Ub3RhbEJhbmRDb3VudCA9IHAuZ2V0VWludDgoZnRlbGwgKyA4KTsKICAgICAgICAgICAgICAgICAgICArMTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuQmFzZUJhbmRDb3VudCA9IHAuZ2V0VWludDgoZnRlbGwgKyA5KTsKICAgICAgICAgICAgICAgICAgICArMTsKICAgICAgICAgICAgICAgICAgICBsZXQgYSA9IHAuZ2V0VWludDgoZnRlbGwgKyAxMCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLlRyYWNrQ291bnQgPSBIQ0FVdGlsRnVuYy5HZXRIaWdoTmliYmxlKGEpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29tcERlYy5DaGFubmVsQ29uZmlnID0gSENBVXRpbEZ1bmMuR2V0TG93TmliYmxlKGEpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZGVjLkRlY1N0ZXJlb1R5cGUgPSBwLmdldFVpbnQ4KGZ0ZWxsICsgMTEpOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRlYy5EZWNTdGVyZW9UeXBlID09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wRGVjLkJhc2VCYW5kQ291bnQgPSB0aGlzLmNvbXBEZWMuVG90YWxCYW5kQ291bnQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbXBEZWMuU3RlcmVvQmFuZENvdW50ID0gdGhpcy5jb21wRGVjLlRvdGFsQmFuZENvdW50IC0gdGhpcy5jb21wRGVjLkJhc2VCYW5kQ291bnQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGZ0ZWxsICs9IDEyOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAidmJyIjoKICAgICAgICAgICAgICAgICAgICBmdGVsbCArPSA4OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAiYXRoIjoKICAgICAgICAgICAgICAgICAgICB0aGlzLlVzZUF0aEN1cnZlID0gcC5nZXRVaW50MTYoZnRlbGwgKyA0KSA9PSAxOwogICAgICAgICAgICAgICAgICAgIGZ0ZWxsICs9IDY7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJsb29wIjoKICAgICAgICAgICAgICAgICAgICB0aGlzLmxvb3Auc3RhcnQgPSBwLmdldFVpbnQzMihmdGVsbCArIDQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubG9vcC5lbmQgPSBwLmdldFVpbnQzMihmdGVsbCArIDgpOwogICAgICAgICAgICAgICAgICAgIHRoaXMubG9vcC5kcm9wcGVkSGVhZGVyID0gcC5nZXRVaW50MTYoZnRlbGwgKyAxMik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb29wLmRyb3BwZWRGb290ZXIgPSBwLmdldFVpbnQxNihmdGVsbCArIDE0KTsKICAgICAgICAgICAgICAgICAgICBmdGVsbCArPSAxNjsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgImNpcGgiOgogICAgICAgICAgICAgICAgICAgIHRoaXMuY2lwaGVyID0gcC5nZXRVaW50MTYoZnRlbGwgKyA0KTsKICAgICAgICAgICAgICAgICAgICBmdGVsbCArPSA2OwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAicnZhIjoKICAgICAgICAgICAgICAgICAgICB0aGlzLnJ2YSA9IHAuZ2V0RmxvYXQzMihmdGVsbCArIDQpOwogICAgICAgICAgICAgICAgICAgIGZ0ZWxsICs9IDg7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlICJ2YnIiOgogICAgICAgICAgICAgICAgICAgIHRoaXMudmJyLk1heEJsb2NrU2l6ZSA9IHAuZ2V0VWludDE2KGZ0ZWxsICsgNCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy52YnIuTm9pc2VMZXZlbCA9IHAuZ2V0SW50MTYoZnRlbGwgKyA2KTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgImNvbW0iOgogICAgICAgICAgICAgICAgICAgIGxldCBsZW4gPSBwLmdldFVpbnQ4KGZ0ZWxsICsgNCk7CiAgICAgICAgICAgICAgICAgICAgbGV0IGppc2RlY29kZXIgPSBuZXcgVGV4dERlY29kZXIoJ3NoaWZ0LWppcycpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY29tbWVudCA9IGppc2RlY29kZXIuZGVjb2RlKGhjYS5zbGljZShmdGVsbCArIDUsIGZ0ZWxsICsgNSArIGxlbikpOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDogdGhyb3cgbmV3IEVycm9yKCJ1bmtub3duIGhlYWRlciBzaWciKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyByZWNvcmQgaGVhZGVyT2Zmc2V0CiAgICAgICAgICAgIHRoaXMuaGVhZGVyT2Zmc2V0W3NpZ25dID0gW2xhc3RGdGVsbCwgZnRlbGxdOwogICAgICAgICAgICAvLyBkbyBtb2RpZmljYXRpb24gaWYgbmVlZGVkCiAgICAgICAgICAgIGxldCBzZWN0aW9uRGF0YUxlbiA9IGZ0ZWxsIC0gbGFzdEZ0ZWxsIC0gNDsKICAgICAgICAgICAgbGV0IG5ld0RhdGEgPSBtb2RMaXN0W3NpZ25dOwogICAgICAgICAgICBpZiAobmV3RGF0YSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAobmV3RGF0YS5ieXRlTGVuZ3RoID4gc2VjdGlvbkRhdGFMZW4pCiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgICAgICAgICBoY2Euc2V0KG5ld0RhdGEsIGxhc3RGdGVsbCArIDQpOwogICAgICAgICAgICAgICAgaGFzTW9kRG9uZSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgLyoKICAgICAgICAvLyAocG9ydGVkIGZyb20pIE55YWdhbW9uJ3Mgb3JpZ2luYWwgY29kZSwgc2hvdWxkIGJlIChhbG1vc3QpIGVxdWl2YWxlbnQgdG8gQ2FsY3VsYXRlSGZyVmFsdWVzCiAgICAgICAgdGhpcy5jb21wUGFyYW1bMl0gPSB0aGlzLmNvbXBQYXJhbVsyXSB8fCAxOwogICAgICAgIGxldCBfYSA9IHRoaXMuY29tcFBhcmFtWzRdIC0gdGhpcy5jb21wUGFyYW1bNV0gLSB0aGlzLmNvbXBQYXJhbVs2XTsKICAgICAgICBsZXQgX2IgPSB0aGlzLmNvbXBQYXJhbVs3XTsKICAgICAgICB0aGlzLmNvbXBEZWMuUmVzZXJ2ZWQxID0gX2IgPiAwID8gX2EgLyBfYiArIChfYSAlIF9iID8gMSA6IDApIDogMDsKICAgICAgICAvLyBUcmFuc2xhdGluZyB0aGUgYWJvdmUgY29kZSB3aXRoIG1lYW5pbmdmdWwgdmFyaWFibGUgbmFtZXM6CiAgICAgICAgdGhpcy5jb21wRGVjLlRyYWNrQ291bnQgPSB0aGlzLmNvbXBEZWMuVHJhY2tDb3VudCB8fCAxOwogICAgICAgIHRoaXMuY29tcERlYy5IZnJCYW5kQ291bnQgPSB0aGlzLmNvbXBEZWMuVG90YWxCYW5kQ291bnQgLSB0aGlzLmNvbXBEZWMuQmFzZUJhbmRDb3VudCAtIHRoaXMuY29tcERlYy5TdGVyZW9CYW5kQ291bnQ7CiAgICAgICAgdGhpcy5IZnJHcm91cENvdW50ID0gdGhpcy5jb21wRGVjLkJhbmRzUGVySGZyR3JvdXA7CiAgICAgICAgdGhpcy5jb21wRGVjLlJlc2VydmVkMSA9IHRoaXMuSGZyR3JvdXBDb3VudCA+IDAgPyB0aGlzLmNvbXBEZWMuSGZyQmFuZENvdW50IC8gdGhpcy5IZnJHcm91cENvdW50ICsgKHRoaXMuY29tcERlYy5IZnJCYW5kQ291bnQgJSB0aGlzLkhmckdyb3VwQ291bnQgPyAxIDogMCkgOiAwOwogICAgICAgICovCiAgICAgICAgLy8gQ2FsY3VsYXRlSGZyVmFsdWVzLCBwb3J0ZWQgZnJvbSBWR0F1ZGlvCiAgICAgICAgaWYgKHRoaXMuY29tcERlYy5CYW5kc1Blckhmckdyb3VwID4gMCkgewogICAgICAgICAgICB0aGlzLmNvbXBEZWMuSGZyQmFuZENvdW50ID0gdGhpcy5jb21wRGVjLlRvdGFsQmFuZENvdW50IC0gdGhpcy5jb21wRGVjLkJhc2VCYW5kQ291bnQgLSB0aGlzLmNvbXBEZWMuU3RlcmVvQmFuZENvdW50OwogICAgICAgICAgICB0aGlzLkhmckdyb3VwQ291bnQgPSBIQ0FVdGlsRnVuYy5EaXZpZGVCeVJvdW5kVXAodGhpcy5jb21wRGVjLkhmckJhbmRDb3VudCwgdGhpcy5jb21wRGVjLkJhbmRzUGVySGZyR3JvdXApOwogICAgICAgIH0KICAgICAgICAvLyBjYWxjdWxhdGUgc2FtcGxlIGNvdW50L29mZnNldHMKICAgICAgICB0aGlzLmZ1bGxTYW1wbGVDb3VudCA9IHRoaXMuZm9ybWF0LmJsb2NrQ291bnQgKiBIQ0FGcmFtZS5TYW1wbGVzUGVyRnJhbWU7CiAgICAgICAgdGhpcy5zdGFydEF0U2FtcGxlID0gdGhpcy5mb3JtYXQuZHJvcHBlZEhlYWRlcjsKICAgICAgICB0aGlzLmZ1bGxFbmRBdFNhbXBsZSA9IHRoaXMuZnVsbFNhbXBsZUNvdW50IC0gdGhpcy5mb3JtYXQuZHJvcHBlZEZvb3RlcjsKICAgICAgICBpZiAodGhpcy5oYXNIZWFkZXJbImxvb3AiXSkgewogICAgICAgICAgICB0aGlzLmxvb3BTdGFydEF0U2FtcGxlID0gdGhpcy5sb29wLnN0YXJ0ICogSENBRnJhbWUuU2FtcGxlc1BlckZyYW1lICsgdGhpcy5sb29wLmRyb3BwZWRIZWFkZXI7CiAgICAgICAgICAgIHRoaXMubG9vcEVuZEF0U2FtcGxlID0gKHRoaXMubG9vcC5lbmQgKyAxKSAqIEhDQUZyYW1lLlNhbXBsZXNQZXJGcmFtZSAtIHRoaXMubG9vcC5kcm9wcGVkRm9vdGVyOwogICAgICAgICAgICB0aGlzLmxvb3BTYW1wbGVDb3VudCA9IHRoaXMubG9vcEVuZEF0U2FtcGxlIC0gdGhpcy5sb29wU3RhcnRBdFNhbXBsZTsKICAgICAgICAgICAgdGhpcy5sb29wU3RhcnRUaW1lID0gKHRoaXMubG9vcFN0YXJ0QXRTYW1wbGUgLSB0aGlzLnN0YXJ0QXRTYW1wbGUpIC8gdGhpcy5mb3JtYXQuc2FtcGxpbmdSYXRlOwogICAgICAgICAgICB0aGlzLmxvb3BEdXJhdGlvbiA9IHRoaXMubG9vcFNhbXBsZUNvdW50IC8gdGhpcy5mb3JtYXQuc2FtcGxpbmdSYXRlOwogICAgICAgICAgICB0aGlzLmxvb3BFbmRUaW1lID0gdGhpcy5sb29wU3RhcnRUaW1lICsgdGhpcy5sb29wRHVyYXRpb247CiAgICAgICAgfQogICAgICAgIHRoaXMuZW5kQXRTYW1wbGUgPSB0aGlzLmhhc0hlYWRlclsibG9vcCJdID8gdGhpcy5sb29wRW5kQXRTYW1wbGUgOiB0aGlzLmZ1bGxFbmRBdFNhbXBsZTsKICAgICAgICB0aGlzLnNhbXBsZUNvdW50ID0gdGhpcy5lbmRBdFNhbXBsZSAtIHRoaXMuc3RhcnRBdFNhbXBsZTsKICAgICAgICB0aGlzLmR1cmF0aW9uID0gdGhpcy5zYW1wbGVDb3VudCAvIHRoaXMuZm9ybWF0LnNhbXBsaW5nUmF0ZTsKICAgICAgICAvLyBjYWxjdWxhdGUgZmlsZS9kYXRhIHNpemUKICAgICAgICB0aGlzLmRhdGFTaXplID0gdGhpcy5ibG9ja1NpemUgKiB0aGlzLmZvcm1hdC5ibG9ja0NvdW50OwogICAgICAgIHRoaXMuZnVsbFNpemUgPSB0aGlzLmRhdGFPZmZzZXQgKyB0aGlzLmRhdGFTaXplOwogICAgICAgIGlmIChjaGFuZ2VNYXNrIHx8IGhhc01vZERvbmUpIHsKICAgICAgICAgICAgLy8gZml4IGNoZWNrc3VtIGlmIHJlcXVlc3RlZAogICAgICAgICAgICBIQ0FDcmMxNi5maXgoaGNhLCB0aGlzLmRhdGFPZmZzZXQgLSAyKTsKICAgICAgICB9CiAgICAgICAgbGV0IHJhd0hlYWRlciA9IGhjYS5zbGljZSgwLCB0aGlzLmRhdGFPZmZzZXQpOwogICAgICAgIC8vIGNoZWNrIHZhbGlkaXR5IG9mIHBhcnNlZCB2YWx1ZXMKICAgICAgICB0aGlzLmNoZWNrVmFsaWRpdHkoKTsKICAgICAgICByZXR1cm4gcmF3SGVhZGVyOwogICAgfQogICAgY2hlY2tWYWxpZGl0eSgpIHsKICAgICAgICBjb25zdCByZXN1bHRzID0gWwogICAgICAgICAgICB0aGlzLmJsb2NrU2l6ZSA+IDAsCiAgICAgICAgICAgIDAgPCB0aGlzLmZvcm1hdC5ibG9ja0NvdW50LAogICAgICAgICAgICAwIDw9IHRoaXMuc3RhcnRBdFNhbXBsZSwKICAgICAgICAgICAgdGhpcy5zdGFydEF0U2FtcGxlIDwgdGhpcy5mdWxsRW5kQXRTYW1wbGUsCiAgICAgICAgICAgIHRoaXMuZnVsbEVuZEF0U2FtcGxlIDw9IHRoaXMuZnVsbFNhbXBsZUNvdW50LAogICAgICAgICAgICB0aGlzLmR1cmF0aW9uID4gMCwKICAgICAgICBdOwogICAgICAgIHJlc3VsdHMuZmluZCgocmVzdWx0LCBpbmRleCkgPT4gewogICAgICAgICAgICBpZiAoIXJlc3VsdCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBkaWQgbm90IHBhc3Mgbm9ybWFsIGNoZWNrIG9uIHJ1bGUgJHtpbmRleH1gKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIGlmICh0aGlzLmhhc0hlYWRlclsibG9vcCJdKSB7CiAgICAgICAgICAgIGNvbnN0IGxvb3BDaGVja3MgPSBbCiAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0QXRTYW1wbGUgPD0gdGhpcy5sb29wU3RhcnRBdFNhbXBsZSwKICAgICAgICAgICAgICAgIHRoaXMubG9vcFN0YXJ0QXRTYW1wbGUgPCB0aGlzLmxvb3BFbmRBdFNhbXBsZSwKICAgICAgICAgICAgICAgIHRoaXMubG9vcEVuZEF0U2FtcGxlIDw9IHRoaXMuZnVsbEVuZEF0U2FtcGxlLAogICAgICAgICAgICAgICAgMCA8PSB0aGlzLmxvb3BTdGFydFRpbWUsCiAgICAgICAgICAgICAgICB0aGlzLmxvb3BTdGFydFRpbWUgPCB0aGlzLmxvb3BFbmRUaW1lLAogICAgICAgICAgICAgICAgdGhpcy5sb29wRW5kVGltZSA8PSB0aGlzLmR1cmF0aW9uICsgMS4wIC8gdGhpcy5mb3JtYXQuc2FtcGxpbmdSYXRlLAogICAgICAgICAgICBdOwogICAgICAgICAgICBsb29wQ2hlY2tzLmZpbmQoKHJlc3VsdCwgaW5kZXgpID0+IHsKICAgICAgICAgICAgICAgIGlmICghcmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBkaWQgbm90IHBhc3MgbG9vcCBjaGVjayBvbiBydWxlICR7aW5kZXh9YCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KICAgIGdldFJhd0hlYWRlcigpIHsKICAgICAgICByZXR1cm4gdGhpcy5yYXdIZWFkZXIuc2xpY2UoMCk7CiAgICB9CiAgICBpc0hlYWRlckNoYW5nZWQoaGNhKSB7CiAgICAgICAgaWYgKGhjYS5sZW5ndGggPj0gdGhpcy5yYXdIZWFkZXIubGVuZ3RoKSB7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5yYXdIZWFkZXIubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChoY2FbaV0gIT0gdGhpcy5yYXdIZWFkZXJbaV0pIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIG1vZGlmeShoY2EsIHNpZywgbmV3RGF0YSkgewogICAgICAgIC8vIHJlcGFyc2UgaGVhZGVyIGlmIG5lZWRlZAogICAgICAgIGlmICh0aGlzLmlzSGVhZGVyQ2hhbmdlZChoY2EpKSB7CiAgICAgICAgICAgIHRoaXMucGFyc2VIZWFkZXIoaGNhLCBmYWxzZSwgZmFsc2UsIHt9KTsKICAgICAgICB9CiAgICAgICAgLy8gcHJlcGFyZSB0byBtb2RpZnkgZGF0YSBpbi1wbGFjZQogICAgICAgIGxldCBtb2RMaXN0ID0ge307CiAgICAgICAgbW9kTGlzdFtzaWddID0gbmV3RGF0YTsKICAgICAgICBsZXQgZW5jcnlwdCA9IHRoaXMuY2lwaGVyICE9IDA7CiAgICAgICAgaWYgKHNpZyA9PT0gImNpcGgiKSB7CiAgICAgICAgICAgIGVuY3J5cHQgPSBuZXcgRGF0YVZpZXcobmV3RGF0YS5idWZmZXIsIG5ld0RhdGEuYnl0ZU9mZnNldCwgbmV3RGF0YS5ieXRlTGVuZ3RoKS5nZXRVaW50MTYoMCkgIT0gMDsKICAgICAgICB9CiAgICAgICAgLy8gZG8gYWN0dWFsIG1vZGlmaWNhdGlvbiAmIGNoZWNrIHZhbGlkaXR5CiAgICAgICAgdGhpcy5yYXdIZWFkZXIgPSB0aGlzLnBhcnNlSGVhZGVyKGhjYSwgdHJ1ZSwgZW5jcnlwdCwgbW9kTGlzdCk7CiAgICB9CiAgICBzdGF0aWMgYWRkSGVhZGVyKGhjYSwgc2lnLCBuZXdEYXRhKSB7CiAgICAgICAgLy8gc2lnIG11c3QgY29uc2lzdCBvZiAxLTQgQVNDSUkgY2hhcmFjdGVycwogICAgICAgIGlmIChzaWcubGVuZ3RoIDwgMSB8fCBzaWcubGVuZ3RoID4gNCkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgbGV0IG5ld1NpZyA9IG5ldyBVaW50OEFycmF5KDQpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgaSsrKSB7CiAgICAgICAgICAgIGxldCBjID0gc2lnLmNoYXJDb2RlQXQoaSk7CiAgICAgICAgICAgIGlmIChjID49IDB4ODApCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICAgICAgbmV3U2lnW2ldID0gYzsKICAgICAgICB9CiAgICAgICAgLy8gcGFyc2UgaGVhZGVyICYgY2hlY2sgdmFsaWR0eQogICAgICAgIGxldCBpbmZvID0gbmV3IEhDQUluZm8oaGNhKTsKICAgICAgICAvLyBjaGVjayB3aGV0aGVyIHNwZWNpZmllZCBoZWFkZXIgc2VjdGlvbiBhbHJlYWR5IGV4aXN0cwogICAgICAgIGlmIChpbmZvLmhhc0hlYWRlcltzaWddKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGhlYWRlciBzZWN0aW9uICR7c2lnfSBhbHJlYWR5IGV4aXN0c2ApOwogICAgICAgIC8vIHByZXBhcmUgYSBuZXdseSBhbGxvY2F0ZWQgYnVmZmVyCiAgICAgICAgbGV0IG5ld0hjYSA9IG5ldyBVaW50OEFycmF5KGhjYS5ieXRlTGVuZ3RoICsgbmV3U2lnLmJ5dGVMZW5ndGggKyBuZXdEYXRhLmJ5dGVMZW5ndGgpOwogICAgICAgIGxldCBpbnNlcnRPZmZzZXQgPSBpbmZvLmhlYWRlck9mZnNldFsicGFkIl1bMF07CiAgICAgICAgLy8gY29weSBleGlzdGluZyBoZWFkZXJzIChleGNlcHQgcGFkZGluZykKICAgICAgICBuZXdIY2Euc2V0KGhjYS5zdWJhcnJheSgwLCBpbnNlcnRPZmZzZXQpLCAwKTsKICAgICAgICAvLyBjb3B5IGluc2VydGVkIGhlYWRlcgogICAgICAgIG5ld0hjYS5zZXQobmV3U2lnLCBpbnNlcnRPZmZzZXQpOwogICAgICAgIG5ld0hjYS5zZXQobmV3RGF0YSwgaW5zZXJ0T2Zmc2V0ICsgbmV3U2lnLmJ5dGVMZW5ndGgpOwogICAgICAgIC8vIGNvcHkgcmVtYWluaW5nIGRhdGEgKHBhZGRpbmcgYW5kIGJsb2NrcykKICAgICAgICBuZXdIY2Euc2V0KGhjYS5zdWJhcnJheShpbnNlcnRPZmZzZXQsIGhjYS5ieXRlTGVuZ3RoKSwgaW5zZXJ0T2Zmc2V0ICsgbmV3U2lnLmJ5dGVMZW5ndGggKyBuZXdEYXRhLmJ5dGVMZW5ndGgpOwogICAgICAgIC8vIHVwZGF0ZSBkYXRhT2Zmc2V0CiAgICAgICAgaW5mby5kYXRhT2Zmc2V0ICs9IG5ld1NpZy5ieXRlTGVuZ3RoICsgbmV3RGF0YS5ieXRlTGVuZ3RoOwogICAgICAgIGxldCBwID0gbmV3IERhdGFWaWV3KG5ld0hjYS5idWZmZXIsIG5ld0hjYS5ieXRlT2Zmc2V0LCBuZXdIY2EuYnl0ZUxlbmd0aCk7CiAgICAgICAgcC5zZXRJbnQxNig2LCBpbmZvLmRhdGFPZmZzZXQpOwogICAgICAgIC8vIGZpeCBjaGVja3N1bQogICAgICAgIEhDQUNyYzE2LmZpeChuZXdIY2EsIGluZm8uZGF0YU9mZnNldCAtIDIpOwogICAgICAgIC8vIHJlcGFyc2UgaGVhZGVyICYgcmVjaGVjayB2YWxpZHR5CiAgICAgICAgaW5mbyA9IG5ldyBIQ0FJbmZvKG5ld0hjYSk7CiAgICAgICAgcmV0dXJuIG5ld0hjYTsKICAgIH0KICAgIHN0YXRpYyBhZGRDaXBoZXJIZWFkZXIoaGNhLCBjaXBoZXJUeXBlKSB7CiAgICAgICAgbGV0IG5ld0RhdGEgPSBuZXcgVWludDhBcnJheSgyKTsKICAgICAgICBpZiAoY2lwaGVyVHlwZSAhPSBudWxsKQogICAgICAgICAgICBuZXcgRGF0YVZpZXcobmV3RGF0YS5idWZmZXIpLnNldFVpbnQxNigwLCBjaXBoZXJUeXBlKTsKICAgICAgICByZXR1cm4gdGhpcy5hZGRIZWFkZXIoaGNhLCAiY2lwaCIsIG5ld0RhdGEpOwogICAgfQogICAgc3RhdGljIGZpeEhlYWRlckNoZWNrc3VtKGhjYSkgewogICAgICAgIGxldCBwID0gbmV3IERhdGFWaWV3KGhjYS5idWZmZXIsIGhjYS5ieXRlT2Zmc2V0LCA4KTsKICAgICAgICBsZXQgaGVhZCA9IHRoaXMuZ2V0U2lnbihwLCAwLCBmYWxzZSwgZmFsc2UpOwogICAgICAgIGlmIChoZWFkICE9PSAiSENBIikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk5vdCBhIEhDQSBmaWxlIik7CiAgICAgICAgfQogICAgICAgIGxldCBkYXRhT2Zmc2V0ID0gcC5nZXRVaW50MTYoNik7CiAgICAgICAgSENBQ3JjMTYuZml4KGhjYSwgZGF0YU9mZnNldCAtIDIpOwogICAgICAgIHJldHVybiBoY2E7CiAgICB9CiAgICBjYWxjSW5XYXZTaXplKG1vZGUgPSAzMikgewogICAgICAgIHN3aXRjaCAobW9kZSkgewogICAgICAgICAgICBjYXNlIDA6IC8vIGZsb2F0CiAgICAgICAgICAgIGNhc2UgODoKICAgICAgICAgICAgY2FzZSAxNjoKICAgICAgICAgICAgY2FzZSAyNDoKICAgICAgICAgICAgY2FzZSAzMjogLy8gaW50ZWdlcgogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBtb2RlID0gMzI7CiAgICAgICAgfQogICAgICAgIGxldCBiaXRzUGVyU2FtcGxlID0gbW9kZSA9PSAwID8gMzIgOiBtb2RlOwogICAgICAgIGxldCBzYW1wbGVTaXplSW5XYXYgPSB0aGlzLmZvcm1hdC5jaGFubmVsQ291bnQgKiBiaXRzUGVyU2FtcGxlIC8gODsKICAgICAgICByZXR1cm4gdGhpcy5pbldhdlNpemUgPSB7CiAgICAgICAgICAgIGJpdHNQZXJTYW1wbGU6IGJpdHNQZXJTYW1wbGUsCiAgICAgICAgICAgIHNhbXBsZTogc2FtcGxlU2l6ZUluV2F2LAogICAgICAgICAgICBibG9jazogSENBRnJhbWUuU2FtcGxlc1BlckZyYW1lICogc2FtcGxlU2l6ZUluV2F2LAogICAgICAgICAgICBkcm9wcGVkOiB7CiAgICAgICAgICAgICAgICBoZWFkZXI6IHRoaXMuZm9ybWF0LmRyb3BwZWRIZWFkZXIgKiBzYW1wbGVTaXplSW5XYXYsCiAgICAgICAgICAgICAgICBmb290ZXI6IHRoaXMuZm9ybWF0LmRyb3BwZWRGb290ZXIgKiBzYW1wbGVTaXplSW5XYXYsCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGxvb3A6IHRoaXMuaGFzSGVhZGVyWyJsb29wIl0gPyB7CiAgICAgICAgICAgICAgICBsb29wUGFydDogKHRoaXMubG9vcEVuZEF0U2FtcGxlIC0gdGhpcy5sb29wU3RhcnRBdFNhbXBsZSkgKiBzYW1wbGVTaXplSW5XYXYsCiAgICAgICAgICAgICAgICBkcm9wcGVkOiB7CiAgICAgICAgICAgICAgICAgICAgaGVhZGVyOiB0aGlzLmxvb3AuZHJvcHBlZEhlYWRlciAqIHNhbXBsZVNpemVJbldhdiwKICAgICAgICAgICAgICAgICAgICBmb290ZXI6IHRoaXMubG9vcC5kcm9wcGVkRm9vdGVyICogc2FtcGxlU2l6ZUluV2F2LAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IDogdW5kZWZpbmVkLAogICAgICAgIH07CiAgICB9CiAgICBjb25zdHJ1Y3RvcihoY2EsIGNoYW5nZU1hc2sgPSBmYWxzZSwgZW5jcnlwdCA9IGZhbHNlKSB7CiAgICAgICAgdGhpcy52ZXJzaW9uID0gIiI7CiAgICAgICAgdGhpcy52ZXJzaW9uTWFqb3IgPSAyOwogICAgICAgIHRoaXMudmVyc2lvbk1pbm9yID0gMDsKICAgICAgICB0aGlzLmRhdGFPZmZzZXQgPSAwOwogICAgICAgIHRoaXMuZm9ybWF0ID0gewogICAgICAgICAgICBjaGFubmVsQ291bnQ6IDAsCiAgICAgICAgICAgIHNhbXBsaW5nUmF0ZTogMCwKICAgICAgICAgICAgYmxvY2tDb3VudDogMCwKICAgICAgICAgICAgZHJvcHBlZEhlYWRlcjogMCwKICAgICAgICAgICAgZHJvcHBlZEZvb3RlcjogMAogICAgICAgIH07CiAgICAgICAgdGhpcy5ibG9ja1NpemUgPSAwOwogICAgICAgIHRoaXMuaGFzSGVhZGVyID0ge307CiAgICAgICAgdGhpcy5oZWFkZXJPZmZzZXQgPSB7fTsgLy8gW3N0YXJ0IChpbmNsdXNpdmUpLCBlbmQgKGV4Y2x1c2l2ZSldCiAgICAgICAgdGhpcy5rYnBzID0gMDsKICAgICAgICB0aGlzLmNvbXBEZWMgPSB7CiAgICAgICAgICAgIE1pblJlc29sdXRpb246IDAsCiAgICAgICAgICAgIE1heFJlc29sdXRpb246IDAsCiAgICAgICAgICAgIFRyYWNrQ291bnQ6IDAsCiAgICAgICAgICAgIENoYW5uZWxDb25maWc6IDAsCiAgICAgICAgICAgIFRvdGFsQmFuZENvdW50OiAwLAogICAgICAgICAgICBCYXNlQmFuZENvdW50OiAwLAogICAgICAgICAgICBTdGVyZW9CYW5kQ291bnQ6IDAsCiAgICAgICAgICAgIEhmckJhbmRDb3VudDogMCwKICAgICAgICAgICAgQmFuZHNQZXJIZnJHcm91cDogMCwKICAgICAgICAgICAgUmVzZXJ2ZWQxOiAwLAogICAgICAgICAgICBSZXNlcnZlZDI6IDAsCiAgICAgICAgfTsKICAgICAgICB0aGlzLmRlYyA9IHsKICAgICAgICAgICAgRGVjU3RlcmVvVHlwZTogMCwKICAgICAgICB9OwogICAgICAgIHRoaXMubG9vcCA9IHsKICAgICAgICAgICAgc3RhcnQ6IDAsCiAgICAgICAgICAgIGVuZDogMCwKICAgICAgICAgICAgLy8gY291bnQ6IDAsIC8vIE55YWdhbW9uJ3MgaW50ZXJwcmV0YXRpb24KICAgICAgICAgICAgLy8gcjAxOiAwLAogICAgICAgICAgICBkcm9wcGVkSGVhZGVyOiAwLAogICAgICAgICAgICBkcm9wcGVkRm9vdGVyOiAwLAogICAgICAgIH07CiAgICAgICAgdGhpcy52YnIgPSB7CiAgICAgICAgICAgIE1heEJsb2NrU2l6ZTogMCwKICAgICAgICAgICAgTm9pc2VMZXZlbDogMCwKICAgICAgICB9OwogICAgICAgIHRoaXMuVXNlQXRoQ3VydmUgPSBmYWxzZTsKICAgICAgICB0aGlzLmNpcGhlciA9IDA7CiAgICAgICAgdGhpcy5ydmEgPSAwLjA7CiAgICAgICAgdGhpcy5jb21tZW50ID0gIiI7CiAgICAgICAgLy8gY29tcHV0ZWQgc2FtcGxlIGNvdW50L29mZnNldHMKICAgICAgICB0aGlzLkhmckdyb3VwQ291bnQgPSAwOwogICAgICAgIHRoaXMuZnVsbFNhbXBsZUNvdW50ID0gMDsKICAgICAgICB0aGlzLnN0YXJ0QXRTYW1wbGUgPSAwOwogICAgICAgIHRoaXMuZnVsbEVuZEF0U2FtcGxlID0gMDsKICAgICAgICB0aGlzLmxvb3BTdGFydEF0U2FtcGxlID0gMDsKICAgICAgICB0aGlzLmxvb3BFbmRBdFNhbXBsZSA9IDA7CiAgICAgICAgdGhpcy5sb29wU2FtcGxlQ291bnQgPSAwOwogICAgICAgIHRoaXMubG9vcFN0YXJ0VGltZSA9IDA7IC8vIGluIHNlY29uZHMKICAgICAgICB0aGlzLmxvb3BFbmRUaW1lID0gMDsgLy8gaW4gc2Vjb25kcwogICAgICAgIHRoaXMubG9vcER1cmF0aW9uID0gMDsgLy8gaW4gc2Vjb25kcwogICAgICAgIHRoaXMuZW5kQXRTYW1wbGUgPSAwOwogICAgICAgIHRoaXMuc2FtcGxlQ291bnQgPSAwOwogICAgICAgIHRoaXMuZHVyYXRpb24gPSAwOyAvLyBpbiBzZWNvbmRzCiAgICAgICAgLy8gZnVsbCBmaWxlIHNpemUgLyBkYXRhIHBhcnQgKGV4Y2x1ZGluZyBoZWFkZXIsIGp1c3QgYmxvY2tzL2ZyYW1lcykgc2l6ZQogICAgICAgIHRoaXMuZnVsbFNpemUgPSAwOwogICAgICAgIHRoaXMuZGF0YVNpemUgPSAwOwogICAgICAgIC8vIGlmIGNoYW5nZU1hc2sgPT0gdHJ1ZSwgKHVuKW1hc2sgdGhlIGhlYWRlciBzaWdzIGluLXBsYWNlCiAgICAgICAgdGhpcy5yYXdIZWFkZXIgPSB0aGlzLnBhcnNlSGVhZGVyKGhjYSwgY2hhbmdlTWFzaywgZW5jcnlwdCwge30pOwogICAgfQp9CmNsYXNzIEhDQVV0aWxGdW5jIHsKICAgIHN0YXRpYyBEaXZpZGVCeVJvdW5kVXAodmFsdWUsIGRpdmlzb3IpIHsKICAgICAgICByZXR1cm4gTWF0aC5jZWlsKHZhbHVlIC8gZGl2aXNvcik7CiAgICB9CiAgICBzdGF0aWMgR2V0SGlnaE5pYmJsZSh2YWx1ZSkgewogICAgICAgIGlmICh2YWx1ZSA+IDB4ZmYpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgIGlmICh2YWx1ZSA8IC0weDgwKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICByZXR1cm4gKHZhbHVlID4+PiA0KSAmIDB4RjsKICAgIH0KICAgIHN0YXRpYyBHZXRMb3dOaWJibGUodmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgPiAweGZmKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICBpZiAodmFsdWUgPCAtMHg4MCkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgcmV0dXJuIHZhbHVlICYgMHhGOwogICAgfQogICAgc3RhdGljIEdldEhpZ2hOaWJibGVTaWduZWQodmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgPiAweGZmKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICBpZiAodmFsdWUgPCAtMHg4MCkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgcmV0dXJuIHRoaXMuU2lnbmVkTmliYmxlc1sodmFsdWUgPj4+IDQpICYgMHhGXTsKICAgIH0KICAgIHN0YXRpYyBHZXRMb3dOaWJibGVTaWduZWQodmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgPiAweGZmKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICBpZiAodmFsdWUgPCAtMHg4MCkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgcmV0dXJuIHRoaXMuU2lnbmVkTmliYmxlc1t2YWx1ZSAmIDB4Rl07CiAgICB9CiAgICBzdGF0aWMgQ29tYmluZU5pYmJsZXMoaGlnaCwgbG93KSB7CiAgICAgICAgcmV0dXJuICgoaGlnaCA8PCA0KSB8IChsb3cgJiAweEYpKSAmIDB4RkY7CiAgICB9CiAgICBzdGF0aWMgR2V0TmV4dE11bHRpcGxlKHZhbHVlLCBtdWx0aXBsZSkgewogICAgICAgIGlmIChtdWx0aXBsZSA8PSAwKQogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgaWYgKHZhbHVlICUgbXVsdGlwbGUgPT0gMCkKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIHJldHVybiB2YWx1ZSArIG11bHRpcGxlIC0gdmFsdWUgJSBtdWx0aXBsZTsKICAgIH0KICAgIHN0YXRpYyBTaWduZWRCaXRSZXZlcnNlMzIodmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgPiAweGZmZmZmZmZmKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICBpZiAodmFsdWUgPCAtMHg4MDAwMDAwMCkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgdmFsdWUgPSAoKHZhbHVlICYgMHhhYWFhYWFhYSkgPj4+IDEpIHwgKCh2YWx1ZSAmIDB4NTU1NTU1NTUpIDw8IDEpOwogICAgICAgIHZhbHVlID0gKCh2YWx1ZSAmIDB4Y2NjY2NjY2MpID4+PiAyKSB8ICgodmFsdWUgJiAweDMzMzMzMzMzKSA8PCAyKTsKICAgICAgICB2YWx1ZSA9ICgodmFsdWUgJiAweGYwZjBmMGYwKSA+Pj4gNCkgfCAoKHZhbHVlICYgMHgwZjBmMGYwZikgPDwgNCk7CiAgICAgICAgdmFsdWUgPSAoKHZhbHVlICYgMHhmZjAwZmYwMCkgPj4+IDgpIHwgKCh2YWx1ZSAmIDB4MDBmZjAwZmYpIDw8IDgpOwogICAgICAgIHJldHVybiAoKHZhbHVlICYgMHhmZmZmMDAwMCkgPj4+IDE2KSB8ICgodmFsdWUgJiAweDAwMDBmZmZmKSA8PCAxNik7CiAgICB9CiAgICBzdGF0aWMgVW5zaWduZWRCaXRSZXZlcnNlMzIodmFsdWUpIHsKICAgICAgICByZXR1cm4gdGhpcy5TaWduZWRCaXRSZXZlcnNlMzIodmFsdWUpID4+PiAwOwogICAgfQogICAgc3RhdGljIFVuc2lnbmVkQml0UmV2ZXJzZTMyVHJ1bmModmFsdWUsIGJpdENvdW50KSB7CiAgICAgICAgcmV0dXJuIHRoaXMuVW5zaWduZWRCaXRSZXZlcnNlMzIodmFsdWUpID4+PiAoMzIgLSBiaXRDb3VudCk7CiAgICB9CiAgICBzdGF0aWMgU2lnbmVkQml0UmV2ZXJzZTMyVHJ1bmModmFsdWUsIGJpdENvdW50KSB7CiAgICAgICAgcmV0dXJuIHRoaXMuVW5zaWduZWRCaXRSZXZlcnNlMzJUcnVuYyh2YWx1ZSA+Pj4gMCwgYml0Q291bnQpOwogICAgfQogICAgc3RhdGljIEJpdFJldmVyc2U4KHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlID4gMHhmZikKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgaWYgKHZhbHVlIDwgLTB4ODApCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgIHZhbHVlID4+Pj0gMDsKICAgICAgICB2YWx1ZSA9ICgodmFsdWUgJiAweGFhKSA+Pj4gMSkgfCAoKHZhbHVlICYgMHg1NSkgPDwgMSk7CiAgICAgICAgdmFsdWUgPSAoKHZhbHVlICYgMHhjYykgPj4+IDIpIHwgKCh2YWx1ZSAmIDB4MzMpIDw8IDIpOwogICAgICAgIHJldHVybiAoKCh2YWx1ZSAmIDB4ZjApID4+PiA0KSB8ICgodmFsdWUgJiAweDBmKSA8PCA0KSkgPj4+IDA7CiAgICB9CiAgICBzdGF0aWMgQ2xhbXAodmFsdWUsIG1pbiwgbWF4KSB7CiAgICAgICAgaWYgKHZhbHVlIDwgbWluKQogICAgICAgICAgICByZXR1cm4gbWluOwogICAgICAgIGlmICh2YWx1ZSA+IG1heCkKICAgICAgICAgICAgcmV0dXJuIG1heDsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgICBzdGF0aWMgRGVidWdBc3NlcnQoY29uZGl0aW9uKSB7CiAgICAgICAgaWYgKCFjb25kaXRpb24pCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRGVidWdBc3NlcnQgZmFpbGVkIik7CiAgICB9Cn0KSENBVXRpbEZ1bmMuU2lnbmVkTmliYmxlcyA9IFswLCAxLCAyLCAzLCA0LCA1LCA2LCA3LCAtOCwgLTcsIC02LCAtNSwgLTQsIC0zLCAtMiwgLTFdOwpleHBvcnQgY2xhc3MgSENBIHsKICAgIGNvbnN0cnVjdG9yKCkgewogICAgfQogICAgc3RhdGljIGRlY3J5cHQoaGNhLCBrZXkxLCBrZXkyLCBzdWJrZXkpIHsKICAgICAgICByZXR1cm4gdGhpcy5kZWNyeXB0T3JFbmNyeXB0KGhjYSwgZmFsc2UsIGtleTEsIGtleTIsIHN1YmtleSk7CiAgICB9CiAgICBzdGF0aWMgZW5jcnlwdChoY2EsIGtleTEsIGtleTIsIHN1YmtleSkgewogICAgICAgIHJldHVybiB0aGlzLmRlY3J5cHRPckVuY3J5cHQoaGNhLCB0cnVlLCBrZXkxLCBrZXkyLCBzdWJrZXkpOwogICAgfQogICAgc3RhdGljIGRlY3J5cHRPckVuY3J5cHQoaGNhLCBlbmNyeXB0LCBrZXkxLCBrZXkyLCBzdWJrZXkpIHsKICAgICAgICAvLyBpbi1wbGFjZSBkZWNyeXB0aW9uL2VuY3J5cHRpb24KICAgICAgICAvLyBoYW5kbGUgc3Via2V5CiAgICAgICAgbGV0IG1peGVkID0gSENBQ2lwaGVyLm1peFdpdGhTdWJrZXkoa2V5MSwga2V5Miwgc3Via2V5KTsKICAgICAgICBrZXkxID0gbWl4ZWQua2V5MTsKICAgICAgICBrZXkyID0gbWl4ZWQua2V5MjsKICAgICAgICAvLyBwYXJzZSBoZWFkZXIKICAgICAgICBsZXQgaW5mbyA9IG5ldyBIQ0FJbmZvKGhjYSk7IC8vIHRocm93cyAiTm90IGEgSENBIGZpbGUiIGlmIG1pc21hdGNoCiAgICAgICAgaWYgKCFlbmNyeXB0ICYmICFpbmZvLmhhc0hlYWRlclsiY2lwaCJdKSB7CiAgICAgICAgICAgIHJldHVybiBoY2E7IC8vIG5vdCBlbmNyeXB0ZWQKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoZW5jcnlwdCAmJiAhaW5mby5oYXNIZWFkZXJbImNpcGgiXSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIklucHV0IGhjYSBsYWNrcyBcImNpcGhcIiBoZWFkZXIgc2VjdGlvbi4gUGxlYXNlIGNhbGwgSENBSW5mby5hZGRDaXBoZXJIZWFkZXIoaGNhKSBmaXJzdC4iKTsKICAgICAgICB9CiAgICAgICAgbGV0IGNpcGhlcjsKICAgICAgICBzd2l0Y2ggKGluZm8uY2lwaGVyKSB7CiAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIC8vIG5vdCBlbmNyeXB0ZWQKICAgICAgICAgICAgICAgIGlmIChlbmNyeXB0KQogICAgICAgICAgICAgICAgICAgIGNpcGhlciA9IG5ldyBIQ0FDaXBoZXIoa2V5MSwga2V5MikuaW52ZXJ0VGFibGUoKTsKICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGNhOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICAgIC8vIGVuY3J5cHRlZCB3aXRoICJubyBrZXkiCiAgICAgICAgICAgICAgICBpZiAoZW5jcnlwdCkKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImFscmVhZHkgZW5jcnlwdGVkIHdpdGggXCJubyBrZXlcIiwgcGxlYXNlIGRlY3J5cHQgZmlyc3QiKTsKICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICBjaXBoZXIgPSBuZXcgSENBQ2lwaGVyKCJub25lIik7IC8vIGlnbm9yZSBnaXZlbiBrZXlzCiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAweDM4OgogICAgICAgICAgICAgICAgLy8gZW5jcnlwdGVkIHdpdGgga2V5cyAtIHdpbGwgeWllbGQgaW5jb3JyZWN0IHdhdmVmb3JtIGlmIGluY29ycmVjdCBrZXlzIGFyZSBnaXZlbiEKICAgICAgICAgICAgICAgIGlmIChlbmNyeXB0KQogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiYWxyZWFkeSBlbmNyeXB0ZWQgd2l0aCBzcGVjaWZpYyBrZXlzLCBwbGVhc2UgZGVjcnlwdCB3aXRoIGNvcnJlY3Qga2V5cyBmaXJzdCIpOwogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIGNpcGhlciA9IG5ldyBIQ0FDaXBoZXIoa2V5MSwga2V5Mik7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidW5rbm93biBjaXBoLnR5cGUiKTsKICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbmZvLmZvcm1hdC5ibG9ja0NvdW50OyArK2kpIHsKICAgICAgICAgICAgbGV0IGZ0ZWxsID0gaW5mby5kYXRhT2Zmc2V0ICsgaW5mby5ibG9ja1NpemUgKiBpOwogICAgICAgICAgICBsZXQgYmxvY2sgPSBoY2Euc3ViYXJyYXkoZnRlbGwsIGZ0ZWxsICsgaW5mby5ibG9ja1NpemUpOwogICAgICAgICAgICAvLyB2ZXJpZnkgYmxvY2sgY2hlY2tzdW0KICAgICAgICAgICAgSENBQ3JjMTYudmVyaWZ5KGJsb2NrLCBpbmZvLmJsb2NrU2l6ZSAtIDIpOwogICAgICAgICAgICAvLyBkZWNyeXB0L2VuY3J5cHQgYmxvY2sKICAgICAgICAgICAgY2lwaGVyLm1hc2soYmxvY2ssIDAsIGluZm8uYmxvY2tTaXplIC0gMik7CiAgICAgICAgICAgIC8vIGZpeCBjaGVja3N1bQogICAgICAgICAgICBIQ0FDcmMxNi5maXgoYmxvY2ssIGluZm8uYmxvY2tTaXplIC0gMik7CiAgICAgICAgfQogICAgICAgIC8vIHJlLSh1biltYXNrIGhlYWRlcnMsIGFuZCBzZXQgY2lwaCBoZWFkZXIgdG8gbmV3IHZhbHVlCiAgICAgICAgbGV0IG5ld0NpcGhlckRhdGEgPSBuZXcgVWludDhBcnJheSgyKTsKICAgICAgICBsZXQgbmV3Q2lwaGVyVHlwZSA9IGVuY3J5cHQgPyBjaXBoZXIuZ2V0VHlwZSgpIDogMDsKICAgICAgICBuZXcgRGF0YVZpZXcobmV3Q2lwaGVyRGF0YS5idWZmZXIpLnNldFVpbnQxNigwLCBuZXdDaXBoZXJUeXBlKTsKICAgICAgICBpbmZvLm1vZGlmeShoY2EsICJjaXBoIiwgbmV3Q2lwaGVyRGF0YSk7CiAgICAgICAgcmV0dXJuIGhjYTsKICAgIH0KICAgIHN0YXRpYyBmaW5kS2V5KGhjYSwgZ2l2ZW5LZXlMaXN0LCBzdWJrZXksIHRocmVzaG9sZCA9IDAuNSwgZGVwdGggPSAxMDI0KSB7CiAgICAgICAgbGV0IGtleUxpc3QsIHVubWl4ZWRLZXlMaXN0OwogICAgICAgIGlmIChnaXZlbktleUxpc3QgPT0gbnVsbCkgewogICAgICAgICAgICBrZXlMaXN0ID0gSENBS25vd25LZXlzOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAga2V5TGlzdCA9IGdpdmVuS2V5TGlzdC5tYXAoKGtleXMpID0+IFtIQ0FDaXBoZXIucGFyc2VLZXkoa2V5c1swXSksIEhDQUNpcGhlci5wYXJzZUtleShrZXlzWzFdKV0pOwogICAgICAgICAgICBIQ0FLbm93bktleXMuZm9yRWFjaCgoa2V5cykgPT4ga2V5TGlzdCA9PT0gbnVsbCB8fCBrZXlMaXN0ID09PSB2b2lkIDAgPyB2b2lkIDAgOiBrZXlMaXN0LnB1c2goa2V5cykpOwogICAgICAgIH0KICAgICAgICB1bm1peGVkS2V5TGlzdCA9IGtleUxpc3Quc2xpY2UoKTsKICAgICAgICBpZiAoc3Via2V5ICE9IG51bGwpIHsKICAgICAgICAgICAgLy8gaGFuZGxlIHN1YmtleQogICAgICAgICAgICBrZXlMaXN0ID0ga2V5TGlzdC5tYXAoKGtleXMpID0+IHsKICAgICAgICAgICAgICAgIGxldCBtaXhlZCA9IEhDQUNpcGhlci5taXhXaXRoU3Via2V5KGtleXNbMF0sIGtleXNbMV0sIHN1YmtleSk7CiAgICAgICAgICAgICAgICByZXR1cm4gW21peGVkLmtleTEsIG1peGVkLmtleTJdOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgLy8gcGFyc2UgaGVhZGVyCiAgICAgICAgY29uc3QgaW5mbyA9IG5ldyBIQ0FJbmZvKGhjYSk7IC8vIHRocm93cyAiTm90IGEgSENBIGZpbGUiIGlmIG1pc21hdGNoCiAgICAgICAgY29uc3QgZnJhbWUgPSBuZXcgSENBRnJhbWUoaW5mbyk7CiAgICAgICAgY29uc3Qgc2NvcmVzID0ga2V5TGlzdC5tYXAoKCkgPT4gMCk7CiAgICAgICAgbGV0IGNpcGhlcjsKICAgICAgICBjb25zdCB0ZXN0S2V5ID0gKGJsb2NrLCBrZXlzKSA9PiB7CiAgICAgICAgICAgIGlmIChjaXBoZXIgPT0gbnVsbCkKICAgICAgICAgICAgICAgIGNpcGhlciA9IG5ldyBIQ0FDaXBoZXIoa2V5c1swXSwga2V5c1sxXSk7CiAgICAgICAgICAgIC8vIGRlY3J5cHQgYmxvY2sKICAgICAgICAgICAgYmxvY2sgPSBibG9jay5zbGljZSgpOwogICAgICAgICAgICBjaXBoZXIubWFzayhibG9jaywgMCwgaW5mby5ibG9ja1NpemUgLSAyKTsKICAgICAgICAgICAgLy8gdGVzdCBpZiB0aGUga2V5IGlzIGNvcnJlY3QKICAgICAgICAgICAgbGV0IHJlYWRlciA9IG5ldyBIQ0FCaXRSZWFkZXIoYmxvY2spOwogICAgICAgICAgICBsZXQgcmVzdWx0ID0gZmFsc2U7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXN1bHQgPSBIQ0FQYWNraW5nLlVucGFja0ZyYW1lKGZyYW1lLCByZWFkZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhdGNoIChlKSB7IH0KICAgICAgICAgICAgaWYgKCFyZXN1bHQpIHsKICAgICAgICAgICAgICAgIGNpcGhlciA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH07CiAgICAgICAgbGV0IHRlc3RlZEJsb2NrQ291bnQgPSAwOwogICAgICAgIGZvciAobGV0IGkgPSAwLCBsYXN0Rm91bmQgPSAtMTsgaSA8IGluZm8uZm9ybWF0LmJsb2NrQ291bnQgJiYgaSA8IGRlcHRoOyBpKyspIHsKICAgICAgICAgICAgbGV0IGZ0ZWxsID0gaW5mby5kYXRhT2Zmc2V0ICsgaW5mby5ibG9ja1NpemUgKiBpOwogICAgICAgICAgICBsZXQgYmxvY2sgPSBoY2Euc3ViYXJyYXkoZnRlbGwsIGZ0ZWxsICsgaW5mby5ibG9ja1NpemUpOwogICAgICAgICAgICBsZXQgZm91bmQgPSAtMTsKICAgICAgICAgICAgaWYgKGxhc3RGb3VuZCAhPSAtMSkgewogICAgICAgICAgICAgICAgLy8gdGVzdCBsYXN0IGZvdW5kIGtleQogICAgICAgICAgICAgICAgaWYgKHRlc3RLZXkoYmxvY2ssIGtleUxpc3RbbGFzdEZvdW5kXSkpCiAgICAgICAgICAgICAgICAgICAgZm91bmQgPSBsYXN0Rm91bmQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZvdW5kID09IC0xKSB7CiAgICAgICAgICAgICAgICAvLyBsYXN0IGZvdW5kIGtleSBkb2VzIG5vdCBtYXRjaCwgdGVzdCBvdGhlcnMKICAgICAgICAgICAgICAgIGZvdW5kID0ga2V5TGlzdC5maW5kSW5kZXgoKGtleXMsIGluZGV4KSA9PiBpbmRleCA9PSBsYXN0Rm91bmQgPyBmYWxzZSA6IHRlc3RLZXkoYmxvY2ssIGtleXMpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZm91bmQgIT0gLTEpIHsKICAgICAgICAgICAgICAgIGxhc3RGb3VuZCA9IGZvdW5kOwogICAgICAgICAgICAgICAgc2NvcmVzW2ZvdW5kXSsrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRlc3RlZEJsb2NrQ291bnQrKzsKICAgICAgICB9CiAgICAgICAgbGV0IGJlc3RTY29yZSA9IDAsIGJlc3RJbmRleCA9IC0xOwogICAgICAgIHNjb3Jlcy5mb3JFYWNoKChzLCBpKSA9PiBzID4gYmVzdFNjb3JlICYmIChiZXN0U2NvcmUgPSBzLCBiZXN0SW5kZXggPSBpKSk7CiAgICAgICAgaWYgKGJlc3RJbmRleCA9PSAtMSB8fCBiZXN0U2NvcmUgLyB0ZXN0ZWRCbG9ja0NvdW50IDwgdGhyZXNob2xkKQogICAgICAgICAgICByZXR1cm47IC8vIGNhbm5vdCBmb3VuZCB2YWxpZCBrZXkKICAgICAgICBlbHNlCiAgICAgICAgICAgIHJldHVybiB1bm1peGVkS2V5TGlzdFtiZXN0SW5kZXhdOwogICAgfQogICAgc3RhdGljIGRlY29kZShoY2EsIG1vZGUgPSAzMiwgbG9vcCA9IDAsIHZvbHVtZSA9IDEuMCkgewogICAgICAgIHN3aXRjaCAobW9kZSkgewogICAgICAgICAgICBjYXNlIDA6IC8vIGZsb2F0CiAgICAgICAgICAgIGNhc2UgODoKICAgICAgICAgICAgY2FzZSAxNjoKICAgICAgICAgICAgY2FzZSAyNDoKICAgICAgICAgICAgY2FzZSAzMjogLy8gaW50ZWdlcgogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBtb2RlID0gMzI7CiAgICAgICAgfQogICAgICAgIGlmICh2b2x1bWUgPiAxKQogICAgICAgICAgICB2b2x1bWUgPSAxOwogICAgICAgIGVsc2UgaWYgKHZvbHVtZSA8IDApCiAgICAgICAgICAgIHZvbHVtZSA9IDA7CiAgICAgICAgbGV0IGluZm8gPSBuZXcgSENBSW5mbyhoY2EpOyAvLyB0aHJvd3MgIk5vdCBhIEhDQSBmaWxlIiBpZiBtaXNtYXRjaAogICAgICAgIGxldCBmcmFtZSA9IG5ldyBIQ0FGcmFtZShpbmZvKTsKICAgICAgICBpZiAoaW5mby5oYXNIZWFkZXJbImNpcGgiXSAmJiBpbmZvLmNpcGhlciAhPSAwKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiSENBIGlzIGVuY3J5cHRlZCwgcGxlYXNlIGRlY3J5cHQgaXQgZmlyc3QgYmVmb3JlIGRlY29kaW5nIik7CiAgICAgICAgfQogICAgICAgIC8vIHByZXBhcmUgb3V0cHV0IFdBViBmaWxlCiAgICAgICAgY29uc3Qgb3V0cHV0V2F2ID0gbmV3IEhDQVdhdihpbmZvLCBtb2RlLCBsb29wKTsKICAgICAgICBjb25zdCBmaWxlQnVmID0gb3V0cHV0V2F2LmZpbGVCdWY7CiAgICAgICAgY29uc3QgZGF0YVBhcnQgPSBvdXRwdXRXYXYuZGF0YVBhcnQ7CiAgICAgICAgLy8gY2FsY3VsYXRlIGluLVdBViBzaXplCiAgICAgICAgbGV0IGluV2F2U2l6ZSA9IGluZm8uY2FsY0luV2F2U2l6ZShtb2RlKTsKICAgICAgICAvLyBkZWNvZGUgYmxvY2tzIChmcmFtZXMpCiAgICAgICAgbGV0IGZhaWxlZEJsb2NrcyA9IFtdLCBsYXN0RXJyb3IgPSB1bmRlZmluZWQ7CiAgICAgICAgZm9yIChsZXQgaSA9IDAsIG9mZnNldCA9IDA7IGkgPCBpbmZvLmZvcm1hdC5ibG9ja0NvdW50OyBpKyspIHsKICAgICAgICAgICAgbGV0IGxhc3REZWNvZGVkU2FtcGxlcyA9IGkgKiBIQ0FGcmFtZS5TYW1wbGVzUGVyRnJhbWU7CiAgICAgICAgICAgIGxldCBjdXJyZW50RGVjb2RlZFNhbXBsZXMgPSBsYXN0RGVjb2RlZFNhbXBsZXMgKyBIQ0FGcmFtZS5TYW1wbGVzUGVyRnJhbWU7CiAgICAgICAgICAgIGlmIChjdXJyZW50RGVjb2RlZFNhbXBsZXMgPD0gaW5mby5zdGFydEF0U2FtcGxlIHx8IGxhc3REZWNvZGVkU2FtcGxlcyA+PSBpbmZvLmVuZEF0U2FtcGxlKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsZXQgc3RhcnRPZmZzZXQgPSBpbmZvLmRhdGFPZmZzZXQgKyBpbmZvLmJsb2NrU2l6ZSAqIGk7CiAgICAgICAgICAgIGxldCBibG9jayA9IGhjYS5zdWJhcnJheShzdGFydE9mZnNldCwgc3RhcnRPZmZzZXQgKyBpbmZvLmJsb2NrU2l6ZSk7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB0aGlzLmRlY29kZUJsb2NrKGZyYW1lLCBibG9jayk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIGZhaWxlZEJsb2Nrcy5wdXNoKGkpOwogICAgICAgICAgICAgICAgbGFzdEVycm9yID0gZTsKICAgICAgICAgICAgICAgIGZyYW1lID0gbmV3IEhDQUZyYW1lKGluZm8pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxldCB3YXZlYnVmZjsKICAgICAgICAgICAgaWYgKGxhc3REZWNvZGVkU2FtcGxlcyA8IGluZm8uc3RhcnRBdFNhbXBsZSB8fCBjdXJyZW50RGVjb2RlZFNhbXBsZXMgPiBpbmZvLmVuZEF0U2FtcGxlKSB7CiAgICAgICAgICAgICAgICAvLyBjcm9zc2luZyBzdGFydEF0U2FtcGxlL2VuZEF0U2FtcGxlLCBza2lwL2Ryb3Agc3BlY2lmaWVkIGJ5dGVzCiAgICAgICAgICAgICAgICB3YXZlYnVmZiA9IHRoaXMud3JpdGVUb1BDTShmcmFtZSwgbW9kZSwgdm9sdW1lKTsKICAgICAgICAgICAgICAgIGlmIChsYXN0RGVjb2RlZFNhbXBsZXMgPCBpbmZvLnN0YXJ0QXRTYW1wbGUpIHsKICAgICAgICAgICAgICAgICAgICBsZXQgc2tpcHBlZFNpemUgPSAoaW5mby5zdGFydEF0U2FtcGxlIC0gbGFzdERlY29kZWRTYW1wbGVzKSAqIGluV2F2U2l6ZS5zYW1wbGU7CiAgICAgICAgICAgICAgICAgICAgd2F2ZWJ1ZmYgPSB3YXZlYnVmZi5zdWJhcnJheShza2lwcGVkU2l6ZSwgaW5XYXZTaXplLmJsb2NrKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKGN1cnJlbnREZWNvZGVkU2FtcGxlcyA+IGluZm8uZW5kQXRTYW1wbGUpIHsKICAgICAgICAgICAgICAgICAgICBsZXQgd3JpdGVTaXplID0gKGluZm8uZW5kQXRTYW1wbGUgLSBsYXN0RGVjb2RlZFNhbXBsZXMpICogaW5XYXZTaXplLnNhbXBsZTsKICAgICAgICAgICAgICAgICAgICB3YXZlYnVmZiA9IHdhdmVidWZmLnN1YmFycmF5KDAsIHdyaXRlU2l6ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoInNob3VsZCBuZXZlciBnbyBoZXJlIik7CiAgICAgICAgICAgICAgICBkYXRhUGFydC5zZXQod2F2ZWJ1ZmYsIG9mZnNldCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICB3YXZlYnVmZiA9IHRoaXMud3JpdGVUb1BDTShmcmFtZSwgbW9kZSwgdm9sdW1lLCBkYXRhUGFydCwgb2Zmc2V0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBvZmZzZXQgKz0gd2F2ZWJ1ZmYuYnl0ZUxlbmd0aDsKICAgICAgICB9CiAgICAgICAgaWYgKGZhaWxlZEJsb2Nrcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYGVycm9yIGRlY29kaW5nIGZvbGxvd2luZyBibG9ja3MsIGZpbGxlZCB6ZXJvYCwgZmFpbGVkQmxvY2tzLCBsYXN0RXJyb3IpOwogICAgICAgIH0KICAgICAgICAvLyBkZWNvZGluZyBkb25lLCB0aGVuIGp1c3QgY29weSBsb29waW5nIHBhcnQKICAgICAgICBpZiAoaW5mby5oYXNIZWFkZXJbImxvb3AiXSAmJiBsb29wKSB7CiAgICAgICAgICAgIC8vICJ0YWlsIiBiZXlvbmQgbG9vcCBlbmQgaXMgZHJvcHBlZAogICAgICAgICAgICAvLyBjb3B5IGxvb3BpbmcgYXVkaW8gY2xpcHMKICAgICAgICAgICAgaWYgKGluV2F2U2l6ZS5sb29wID09IG51bGwpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICAgICAgbGV0IHByZUxvb3BTaXplSW5XYXYgPSBpbldhdlNpemUuc2FtcGxlICogKGluZm8ubG9vcFN0YXJ0QXRTYW1wbGUgLSBpbmZvLnN0YXJ0QXRTYW1wbGUpOwogICAgICAgICAgICBsZXQgc3JjID0gZGF0YVBhcnQuc3ViYXJyYXkocHJlTG9vcFNpemVJbldhdiwgcHJlTG9vcFNpemVJbldhdiArIGluV2F2U2l6ZS5sb29wLmxvb3BQYXJ0KTsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDAsIHN0YXJ0ID0gcHJlTG9vcFNpemVJbldhdiArIGluV2F2U2l6ZS5sb29wLmxvb3BQYXJ0OyBpIDwgbG9vcDsgaSsrKSB7CiAgICAgICAgICAgICAgICBsZXQgZHN0ID0gZGF0YVBhcnQuc3ViYXJyYXkoc3RhcnQsIHN0YXJ0ICsgaW5XYXZTaXplLmxvb3AubG9vcFBhcnQpOwogICAgICAgICAgICAgICAgZHN0LnNldChzcmMpOwogICAgICAgICAgICAgICAgc3RhcnQgKz0gaW5XYXZTaXplLmxvb3AubG9vcFBhcnQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZpbGVCdWY7CiAgICB9CiAgICBzdGF0aWMgZGVjb2RlQmxvY2soZnJhbWUsIGJsb2NrKSB7CiAgICAgICAgbGV0IGluZm8gPSBmcmFtZS5IY2E7CiAgICAgICAgaWYgKGJsb2NrLmJ5dGVMZW5ndGggIT0gaW5mby5ibG9ja1NpemUpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgIC8vIHZlcmlmeSBjaGVja3N1bQogICAgICAgIEhDQUNyYzE2LnZlcmlmeShibG9jaywgaW5mby5ibG9ja1NpemUgLSAyKTsKICAgICAgICAvLyBkZWNvZGUKICAgICAgICBIQ0FEZWNvZGVyLkRlY29kZUZyYW1lKGJsb2NrLCBmcmFtZSk7CiAgICB9CiAgICBzdGF0aWMgd3JpdGVUb1BDTShmcmFtZSwgbW9kZSA9IDMyLCB2b2x1bWUgPSAxLjAsIHdyaXRlciwgZnRlbGwpIHsKICAgICAgICBzd2l0Y2ggKG1vZGUpIHsKICAgICAgICAgICAgY2FzZSAwOiAvLyBmbG9hdAogICAgICAgICAgICBjYXNlIDg6CiAgICAgICAgICAgIGNhc2UgMTY6CiAgICAgICAgICAgIGNhc2UgMjQ6CiAgICAgICAgICAgIGNhc2UgMzI6IC8vIGludGVnZXIKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgbW9kZSA9IDMyOwogICAgICAgIH0KICAgICAgICBpZiAodm9sdW1lID4gMSkKICAgICAgICAgICAgdm9sdW1lID0gMTsKICAgICAgICBlbHNlIGlmICh2b2x1bWUgPCAwKQogICAgICAgICAgICB2b2x1bWUgPSAwOwogICAgICAgIC8vIGNyZWF0ZSBuZXcgd3JpdGVyIGlmIG5vdCBzcGVjaWZpZWQKICAgICAgICBsZXQgaW5mbyA9IGZyYW1lLkhjYTsKICAgICAgICBpZiAod3JpdGVyID09IG51bGwpIHsKICAgICAgICAgICAgd3JpdGVyID0gbmV3IFVpbnQ4QXJyYXkoSENBRnJhbWUuU2FtcGxlc1BlckZyYW1lICogaW5mby5mb3JtYXQuY2hhbm5lbENvdW50ICogKG1vZGUgPT0gMCA/IDMyIDogbW9kZSkgLyA4KTsKICAgICAgICAgICAgaWYgKGZ0ZWxsID09IG51bGwpIHsKICAgICAgICAgICAgICAgIGZ0ZWxsID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgaWYgKGZ0ZWxsID09IG51bGwpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICB9CiAgICAgICAgLy8gd3JpdGUgZGVjb2RlZCBkYXRhIGludG8gd3JpdGVyCiAgICAgICAgbGV0IHAgPSBuZXcgRGF0YVZpZXcod3JpdGVyLmJ1ZmZlciwgd3JpdGVyLmJ5dGVPZmZzZXQsIHdyaXRlci5ieXRlTGVuZ3RoKTsKICAgICAgICBsZXQgZnRlbGxCZWdpbiA9IGZ0ZWxsOwogICAgICAgIGZvciAobGV0IHNmID0gMDsgc2YgPCBIQ0FGcmFtZS5TdWJmcmFtZXNQZXJGcmFtZTsgc2YrKykgewogICAgICAgICAgICBmb3IgKGxldCBzID0gMDsgcyA8IEhDQUZyYW1lLlNhbXBsZXNQZXJTdWJGcmFtZTsgcysrKSB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBjID0gMDsgYyA8IGZyYW1lLkNoYW5uZWxzLmxlbmd0aDsgYysrKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IGYgPSBmcmFtZS5DaGFubmVsc1tjXS5QY21GbG9hdFtzZl1bc10gKiB2b2x1bWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKGYgPiAxKQogICAgICAgICAgICAgICAgICAgICAgICBmID0gMTsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChmIDwgLTEpCiAgICAgICAgICAgICAgICAgICAgICAgIGYgPSAtMTsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKG1vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbXVzdCBiZSB1bnNpZ25lZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5zZXRVaW50OChmdGVsbCwgZiAqIDB4N0YgKyAweDgwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZ0ZWxsICs9IDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAxNjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZvciBhYm92ZSA4LWJpdCBpbnRlZ2VyLCBsaXR0bGUtZW5kaWFuIHNpZ25lZCBpbnRlZ2VyIGlzIHVzZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIChzZXRVaW50MTYvc2V0SW50MTYgYWN0dWFsbHkgZG9lc24ndCBzZWVtIHRvIG1ha2UgYW55IGRpZmZlcmVuY2UgaGVyZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAuc2V0SW50MTYoZnRlbGwsIGYgKiAweDdGRkYsIHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnRlbGwgKz0gMjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDI0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhlcmUncyBubyBzZXRJbnQyNCwgd3JpdGUgMyBieXRlcyB3aXRoIHNldFVpbnQ4IHJlc3BlY3RpdmVseQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZiAqPSAweDdGRkZGRjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAuc2V0VWludDgoZnRlbGwsIGYgJiAweEZGKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAuc2V0VWludDgoZnRlbGwgKyAxLCBmID4+IDggJiAweEZGKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAuc2V0VWludDgoZnRlbGwgKyAyLCBmID4+IDE2ICYgMHhGRik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdGVsbCArPSAzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMzI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLnNldEludDMyKGZ0ZWxsLCBmICogMHg3RkZGRkZGRiwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmdGVsbCArPSA0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGZsb2F0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLnNldEZsb2F0MzIoZnRlbGwsIGYsIHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZnRlbGwgKz0gNDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJ1bmtub3duIG1vZGUiKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHdyaXRlci5zdWJhcnJheShmdGVsbEJlZ2luLCBmdGVsbCk7CiAgICB9CiAgICBzdGF0aWMgZml4Q2hlY2tzdW0oaGNhKSB7CiAgICAgICAgSENBSW5mby5maXhIZWFkZXJDaGVja3N1bShoY2EpOwogICAgICAgIGxldCBpbmZvID0gbmV3IEhDQUluZm8oaGNhKTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGluZm8uZm9ybWF0LmJsb2NrQ291bnQ7IGkrKykgewogICAgICAgICAgICBsZXQgZnRlbGwgPSBpbmZvLmRhdGFPZmZzZXQgKyBpICogaW5mby5ibG9ja1NpemU7CiAgICAgICAgICAgIGxldCBibG9jayA9IGhjYS5zdWJhcnJheShmdGVsbCwgZnRlbGwgKyBpbmZvLmJsb2NrU2l6ZSk7CiAgICAgICAgICAgIEhDQUNyYzE2LmZpeChibG9jaywgaW5mby5ibG9ja1NpemUgLSAyKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGhjYTsKICAgIH0KfQpjbGFzcyBIQ0FXYXYgewogICAgY29uc3RydWN0b3IoaW5mbywgbW9kZSA9IDMyLCBsb29wID0gMCkgewogICAgICAgIHN3aXRjaCAobW9kZSkgewogICAgICAgICAgICBjYXNlIDA6IC8vIGZsb2F0CiAgICAgICAgICAgIGNhc2UgODoKICAgICAgICAgICAgY2FzZSAxNjoKICAgICAgICAgICAgY2FzZSAyNDoKICAgICAgICAgICAgY2FzZSAzMjogLy8gaW50ZWdlcgogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBtb2RlID0gMzI7CiAgICAgICAgfQogICAgICAgIGlmIChpc05hTihsb29wKSkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJsb29wIGlzIG5vdCBudW1iZXIiKTsKICAgICAgICBsb29wID0gTWF0aC5mbG9vcihsb29wKTsKICAgICAgICBpZiAobG9vcCA8IDApCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgIGxldCBpbldhdlNpemUgPSBpbmZvLmNhbGNJbldhdlNpemUobW9kZSk7CiAgICAgICAgbGV0IGRhdGFTaXplID0gaW5XYXZTaXplLnNhbXBsZSAqIGluZm8uc2FtcGxlQ291bnQ7CiAgICAgICAgaWYgKGxvb3AgPiAwKSB7CiAgICAgICAgICAgIGlmIChpbldhdlNpemUubG9vcCA9PSBudWxsKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgICAgIGRhdGFTaXplICs9IGluV2F2U2l6ZS5sb29wLmxvb3BQYXJ0ICogbG9vcDsKICAgICAgICB9CiAgICAgICAgLy8gcHJlcGFyZSBtZXRhZGF0YSBjaHVua3MgYW5kIGRhdGEgY2h1bmsgaGVhZGVyCiAgICAgICAgdGhpcy5mbXQgPSBuZXcgSENBV2F2Rm10Q2h1bmsoaW5mbywgbW9kZSk7CiAgICAgICAgaWYgKGluZm8uaGFzSGVhZGVyWyJjb21tIl0pCiAgICAgICAgICAgIHRoaXMubm90ZSA9IG5ldyBIQ0FXYXZDb21tZW50Q2h1bmsoaW5mbyk7CiAgICAgICAgaWYgKGluZm8uaGFzSGVhZGVyWyJsb29wIl0pCiAgICAgICAgICAgIHRoaXMuc21wbCA9IG5ldyBIQ0FXYXZlU21wbENodW5rKGluZm8pOwogICAgICAgIHRoaXMud2F2ZVJpZmYgPSBuZXcgSENBV2F2V2F2ZVJpZmZIZWFkZXIoOCArIHRoaXMuZm10LnNpemUKICAgICAgICAgICAgKyAodGhpcy5ub3RlID09IG51bGwgPyAwIDogOCArIHRoaXMubm90ZS5zaXplKQogICAgICAgICAgICArIDggKyBkYXRhU2l6ZQogICAgICAgICAgICArICh0aGlzLnNtcGwgPT0gbnVsbCA/IDAgOiA4ICsgdGhpcy5zbXBsLnNpemUpKTsKICAgICAgICAvLyBnZXQgYnl0ZXMgb2YgcHJlcGFyZWQgY2h1bmtzCiAgICAgICAgbGV0IHdhdmVSaWZmSGVhZGVyID0gdGhpcy53YXZlUmlmZi5nZXQoKTsKICAgICAgICBsZXQgZm10Q2h1bmsgPSB0aGlzLmZtdC5nZXQoKTsKICAgICAgICBsZXQgbm90ZUNodW5rID0gdGhpcy5ub3RlICE9IG51bGwgPyB0aGlzLm5vdGUuZ2V0KCkgOiBuZXcgVWludDhBcnJheSgwKTsKICAgICAgICBsZXQgZGF0YUNodW5rSGVhZGVyID0gbmV3IFVpbnQ4QXJyYXkoOCk7CiAgICAgICAgZGF0YUNodW5rSGVhZGVyLnNldChuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUoImRhdGEiKSk7CiAgICAgICAgbmV3IERhdGFWaWV3KGRhdGFDaHVua0hlYWRlci5idWZmZXIpLnNldFVpbnQzMig0LCBkYXRhU2l6ZSwgdHJ1ZSk7CiAgICAgICAgbGV0IHNtcGxDaHVuayA9IHRoaXMuc21wbCAhPSBudWxsID8gdGhpcy5zbXBsLmdldCgpIDogbmV3IFVpbnQ4QXJyYXkoMCk7CiAgICAgICAgLy8gY3JlYXRlIHdob2xlLWZpbGUgYnVmZmVyCiAgICAgICAgdGhpcy5maWxlQnVmID0gbmV3IFVpbnQ4QXJyYXkoOCArIHRoaXMud2F2ZVJpZmYuc2l6ZSk7CiAgICAgICAgLy8gY29weSBwcmVwYXJlZCBtZXRhZGF0YSBjaHVua3MgYW5kIGRhdGEgY2h1bmsgaGVhZGVyIHRvIHdob2xlLWZpbGUgYnVmZmVyCiAgICAgICAgbGV0IHdyaXR0ZW5MZW5ndGggPSAwOwogICAgICAgIFt3YXZlUmlmZkhlYWRlciwgZm10Q2h1bmssIG5vdGVDaHVuaywgZGF0YUNodW5rSGVhZGVyXS5mb3JFYWNoKChjaHVuaykgPT4gewogICAgICAgICAgICB0aGlzLmZpbGVCdWYuc2V0KGNodW5rLCB3cml0dGVuTGVuZ3RoKTsKICAgICAgICAgICAgd3JpdHRlbkxlbmd0aCArPSBjaHVuay5ieXRlTGVuZ3RoOwogICAgICAgIH0pOwogICAgICAgIC8vIHNraXAgZGF0YVBhcnQgc2luY2UgaXQncyBlbXB0eQogICAgICAgIHRoaXMuZGF0YVBhcnQgPSB0aGlzLmZpbGVCdWYuc3ViYXJyYXkod3JpdHRlbkxlbmd0aCwgd3JpdHRlbkxlbmd0aCArIGRhdGFTaXplKTsKICAgICAgICB3cml0dGVuTGVuZ3RoICs9IGRhdGFTaXplOwogICAgICAgIC8vIGNvcHkgdGhlIGxhc3QgcHJlcGFyZWQgY2h1bmsgdG8gd2hvbGUtZmlsZSBidWZmZXIKICAgICAgICB0aGlzLmZpbGVCdWYuc2V0KHNtcGxDaHVuaywgd3JpdHRlbkxlbmd0aCk7CiAgICAgICAgd3JpdHRlbkxlbmd0aCArPSBzbXBsQ2h1bmsuYnl0ZUxlbmd0aDsKICAgICAgICBpZiAod3JpdHRlbkxlbmd0aCAhPSB0aGlzLmZpbGVCdWYuYnl0ZUxlbmd0aCkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICB9Cn0KY2xhc3MgSENBV2F2V2F2ZVJpZmZIZWFkZXIgewogICAgY29uc3RydWN0b3Ioc2l6ZSkgewogICAgICAgIGlmIChpc05hTihzaXplKSkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJzaXplIG11c3QgYmUgbnVtYmVyIik7CiAgICAgICAgc2l6ZSA9IE1hdGguZmxvb3Ioc2l6ZSk7CiAgICAgICAgaWYgKHNpemUgPD0gMCkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgdGhpcy5zaXplID0gNCArIHNpemU7IC8vICJXQVZFIiArIHJlbWFpbmluZyBwYXJ0CiAgICB9CiAgICBnZXQoKSB7CiAgICAgICAgbGV0IGJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcigxMik7CiAgICAgICAgbGV0IHJldCA9IG5ldyBVaW50OEFycmF5KGJ1Zik7CiAgICAgICAgbGV0IHAgPSBuZXcgRGF0YVZpZXcoYnVmKTsKICAgICAgICBsZXQgdGUgPSBuZXcgVGV4dEVuY29kZXIoKTsKICAgICAgICByZXQuc2V0KHRlLmVuY29kZSgiUklGRiIpLCAwKTsKICAgICAgICBwLnNldFVpbnQzMig0LCB0aGlzLnNpemUsIHRydWUpOwogICAgICAgIHJldC5zZXQodGUuZW5jb2RlKCJXQVZFIiksIDgpOwogICAgICAgIHJldHVybiByZXQ7CiAgICB9Cn0KY2xhc3MgSENBV2F2Rm10Q2h1bmsgewogICAgY29uc3RydWN0b3IoaW5mbywgbW9kZSA9IDMyKSB7CiAgICAgICAgdGhpcy5zaXplID0gMTY7CiAgICAgICAgc3dpdGNoIChtb2RlKSB7CiAgICAgICAgICAgIGNhc2UgMDogLy8gZmxvYXQKICAgICAgICAgICAgY2FzZSA4OgogICAgICAgICAgICBjYXNlIDE2OgogICAgICAgICAgICBjYXNlIDI0OgogICAgICAgICAgICBjYXNlIDMyOiAvLyBpbnRlZ2VyCiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIG1vZGUgPSAzMjsKICAgICAgICB9CiAgICAgICAgbGV0IGluV2F2U2l6ZSA9IGluZm8uY2FsY0luV2F2U2l6ZShtb2RlKTsKICAgICAgICB0aGlzLmZvcm1hdFRhZyA9IG1vZGUgPiAwID8gMSA6IDM7CiAgICAgICAgdGhpcy5jaGFubmVsQ291bnQgPSBpbmZvLmZvcm1hdC5jaGFubmVsQ291bnQ7CiAgICAgICAgdGhpcy5zYW1wbGVzUGVyU2VjID0gaW5mby5mb3JtYXQuc2FtcGxpbmdSYXRlOwogICAgICAgIHRoaXMuYnl0ZXNQZXJTZWMgPSBpbldhdlNpemUuc2FtcGxlICogaW5mby5mb3JtYXQuc2FtcGxpbmdSYXRlOwogICAgICAgIHRoaXMuYmxvY2tBbGlnbiA9IGluV2F2U2l6ZS5zYW1wbGU7CiAgICAgICAgdGhpcy5iaXRzUGVyU2FtcGxlID0gaW5XYXZTaXplLmJpdHNQZXJTYW1wbGU7CiAgICB9CiAgICBnZXQoKSB7CiAgICAgICAgbGV0IGJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcig4ICsgdGhpcy5zaXplKTsKICAgICAgICBsZXQgcmV0ID0gbmV3IFVpbnQ4QXJyYXkoYnVmKTsKICAgICAgICBsZXQgcCA9IG5ldyBEYXRhVmlldyhidWYpOwogICAgICAgIGxldCB0ZSA9IG5ldyBUZXh0RW5jb2RlcigpOwogICAgICAgIHJldC5zZXQodGUuZW5jb2RlKCJmbXQgIiksIDApOwogICAgICAgIHAuc2V0VWludDMyKDQsIHRoaXMuc2l6ZSwgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MTYoOCwgdGhpcy5mb3JtYXRUYWcsIHRydWUpOwogICAgICAgIHAuc2V0VWludDE2KDEwLCB0aGlzLmNoYW5uZWxDb3VudCwgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MzIoMTIsIHRoaXMuc2FtcGxlc1BlclNlYywgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MzIoMTYsIHRoaXMuYnl0ZXNQZXJTZWMsIHRydWUpOwogICAgICAgIHAuc2V0VWludDE2KDIwLCB0aGlzLmJsb2NrQWxpZ24sIHRydWUpOwogICAgICAgIHAuc2V0VWludDE2KDIyLCB0aGlzLmJpdHNQZXJTYW1wbGUsIHRydWUpOwogICAgICAgIHJldHVybiByZXQ7CiAgICB9Cn0KY2xhc3MgSENBV2F2Q29tbWVudENodW5rIHsKICAgIGNvbnN0cnVjdG9yKGluZm8pIHsKICAgICAgICB0aGlzLmNvbW1lbnRCdWYgPSBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUoaW5mby5jb21tZW50KTsKICAgICAgICBsZXQgc2l6ZSA9IHRoaXMuY29tbWVudEJ1Zi5ieXRlTGVuZ3RoOwogICAgICAgIHNpemUgKz0gNDsKICAgICAgICBpZiAoc2l6ZSAlIDQpCiAgICAgICAgICAgIHNpemUgKz0gNCAtIHNpemUgJSA0OwogICAgICAgIHRoaXMuc2l6ZSA9IHNpemU7CiAgICB9CiAgICBnZXQoKSB7CiAgICAgICAgbGV0IGJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcig4ICsgdGhpcy5zaXplKTsKICAgICAgICBsZXQgcmV0ID0gbmV3IFVpbnQ4QXJyYXkoYnVmKTsKICAgICAgICBsZXQgcCA9IG5ldyBEYXRhVmlldyhidWYpOwogICAgICAgIGxldCB0ZSA9IG5ldyBUZXh0RW5jb2RlcigpOwogICAgICAgIHJldC5zZXQodGUuZW5jb2RlKCJub3RlIiksIDApOwogICAgICAgIHAuc2V0VWludDMyKDQsIHRoaXMuc2l6ZSwgdHJ1ZSk7CiAgICAgICAgcmV0LnNldCh0aGlzLmNvbW1lbnRCdWYsIDgpOwogICAgICAgIHJldHVybiByZXQ7CiAgICB9Cn0KY2xhc3MgSENBV2F2ZVNtcGxDaHVuayB7CiAgICBjb25zdHJ1Y3RvcihpbmZvKSB7CiAgICAgICAgdGhpcy5zaXplID0gNjA7CiAgICAgICAgdGhpcy5tYW51ZmFjdHVyZXIgPSAwOwogICAgICAgIHRoaXMucHJvZHVjdCA9IDA7CiAgICAgICAgdGhpcy5NSURJVW5pdHlOb3RlID0gMHgzYzsKICAgICAgICB0aGlzLk1JRElQaXRjaEZyYWN0aW9uID0gMDsKICAgICAgICB0aGlzLlNNUFRFRm9ybWF0ID0gMDsKICAgICAgICB0aGlzLnNhbXBsZUxvb3BzID0gMTsKICAgICAgICB0aGlzLnNhbXBsZXJEYXRhID0gMHgxODsKICAgICAgICB0aGlzLmxvb3BfSWRlbnRpZmllciA9IDA7CiAgICAgICAgdGhpcy5sb29wX1R5cGUgPSAwOwogICAgICAgIHRoaXMubG9vcF9GcmFjdGlvbiA9IDA7CiAgICAgICAgdGhpcy5sb29wX1BsYXlDb3VudCA9IDA7CiAgICAgICAgaWYgKCFpbmZvLmhhc0hlYWRlclsibG9vcCJdKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIm1pc3NpbmcgXCJsb29wXCIgaGVhZGVyIik7CiAgICAgICAgdGhpcy5zYW1wbGVQZXJpb2QgPSAoMSAvIGluZm8uZm9ybWF0LnNhbXBsaW5nUmF0ZSAqIDEwMDAwMDAwMDApOwogICAgICAgIHRoaXMubG9vcF9TdGFydCA9IGluZm8ubG9vcFN0YXJ0QXRTYW1wbGUgLSBpbmZvLnN0YXJ0QXRTYW1wbGU7CiAgICAgICAgdGhpcy5sb29wX0VuZCA9IGluZm8ubG9vcEVuZEF0U2FtcGxlIC0gaW5mby5zdGFydEF0U2FtcGxlOwogICAgICAgIHRoaXMuU01QVEVPZmZzZXQgPSAxOwogICAgfQogICAgZ2V0KCkgewogICAgICAgIGxldCBidWYgPSBuZXcgQXJyYXlCdWZmZXIoOCArIHRoaXMuc2l6ZSk7CiAgICAgICAgbGV0IHJldCA9IG5ldyBVaW50OEFycmF5KGJ1Zik7CiAgICAgICAgbGV0IHAgPSBuZXcgRGF0YVZpZXcoYnVmKTsKICAgICAgICBsZXQgdGUgPSBuZXcgVGV4dEVuY29kZXIoKTsKICAgICAgICByZXQuc2V0KHRlLmVuY29kZSgic21wbCIpLCAwKTsKICAgICAgICBwLnNldFVpbnQzMig0LCB0aGlzLnNpemUsIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDgsIHRoaXMubWFudWZhY3R1cmVyLCB0cnVlKTsKICAgICAgICBwLnNldFVpbnQzMigxMiwgdGhpcy5wcm9kdWN0LCB0cnVlKTsKICAgICAgICBwLnNldFVpbnQzMigxNiwgdGhpcy5zYW1wbGVQZXJpb2QsIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDIwLCB0aGlzLk1JRElVbml0eU5vdGUsIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDI0LCB0aGlzLk1JRElQaXRjaEZyYWN0aW9uLCB0cnVlKTsKICAgICAgICBwLnNldFVpbnQzMigyOCwgdGhpcy5TTVBURUZvcm1hdCwgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MzIoMzIsIHRoaXMuU01QVEVPZmZzZXQsIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDM2LCB0aGlzLnNhbXBsZUxvb3BzLCB0cnVlKTsKICAgICAgICBwLnNldFVpbnQzMig0MCwgdGhpcy5zYW1wbGVyRGF0YSwgdHJ1ZSk7CiAgICAgICAgcC5zZXRVaW50MzIoNDQsIHRoaXMubG9vcF9JZGVudGlmaWVyLCB0cnVlKTsKICAgICAgICBwLnNldFVpbnQzMig0OCwgdGhpcy5sb29wX1R5cGUsIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDUyLCB0aGlzLmxvb3BfU3RhcnQsIHRydWUpOwogICAgICAgIHAuc2V0VWludDMyKDU2LCB0aGlzLmxvb3BfRW5kLCB0cnVlKTsKICAgICAgICBwLnNldFVpbnQzMig2MCwgdGhpcy5sb29wX0ZyYWN0aW9uLCB0cnVlKTsKICAgICAgICBwLnNldFVpbnQzMig2NCwgdGhpcy5sb29wX1BsYXlDb3VudCwgdHJ1ZSk7CiAgICAgICAgcmV0dXJuIHJldDsKICAgIH0KfQpjbGFzcyBIQ0FCaXRSZWFkZXIgewogICAgZ2V0IFJlbWFpbmluZygpIHsKICAgICAgICByZXR1cm4gdGhpcy5MZW5ndGhCaXRzIC0gdGhpcy5Qb3NpdGlvbjsKICAgIH0KICAgIGNvbnN0cnVjdG9yKGJ1ZmZlcikgewogICAgICAgIHRoaXMuQnVmZmVyID0gYnVmZmVyOwogICAgICAgIHRoaXMuZHYgPSBuZXcgRGF0YVZpZXcoYnVmZmVyLmJ1ZmZlciwgYnVmZmVyLmJ5dGVPZmZzZXQsIGJ1ZmZlci5ieXRlTGVuZ3RoKTsKICAgICAgICB0aGlzLkxlbmd0aEJpdHMgPSBidWZmZXIubGVuZ3RoICogODsKICAgICAgICB0aGlzLlBvc2l0aW9uID0gMDsKICAgIH0KICAgIFJlYWRJbnQoYml0Q291bnQpIHsKICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLlBlZWtJbnQoYml0Q291bnQpOwogICAgICAgIHRoaXMuUG9zaXRpb24gKz0gYml0Q291bnQ7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQogICAgUmVhZEJvb2woKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuUmVhZEludCgxKSA9PSAxOwogICAgfQogICAgUmVhZE9mZnNldEJpbmFyeShiaXRDb3VudCwgYmlhcykgewogICAgICAgIGxldCBvZmZzZXQgPSAoMSA8PCAoYml0Q291bnQgLSAxKSkgLSBiaWFzOwogICAgICAgIGxldCB2YWx1ZSA9IHRoaXMuUGVla0ludChiaXRDb3VudCkgLSBvZmZzZXQ7CiAgICAgICAgdGhpcy5Qb3NpdGlvbiArPSBiaXRDb3VudDsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgICBBbGlnblBvc2l0aW9uKG11bHRpcGxlKSB7CiAgICAgICAgdGhpcy5Qb3NpdGlvbiA9IEhDQVV0aWxGdW5jLkdldE5leHRNdWx0aXBsZSh0aGlzLlBvc2l0aW9uLCBtdWx0aXBsZSk7CiAgICB9CiAgICBQZWVrSW50KGJpdENvdW50KSB7CiAgICAgICAgSENBVXRpbEZ1bmMuRGVidWdBc3NlcnQoYml0Q291bnQgPj0gMCAmJiBiaXRDb3VudCA8PSAzMik7CiAgICAgICAgaWYgKGJpdENvdW50ID4gdGhpcy5SZW1haW5pbmcpIHsKICAgICAgICAgICAgaWYgKHRoaXMuUG9zaXRpb24gPj0gdGhpcy5MZW5ndGhCaXRzKQogICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgIGxldCBleHRyYUJpdHMgPSBiaXRDb3VudCAtIHRoaXMuUmVtYWluaW5nOwogICAgICAgICAgICByZXR1cm4gdGhpcy5QZWVrSW50RmFsbGJhY2sodGhpcy5SZW1haW5pbmcpIDw8IGV4dHJhQml0czsKICAgICAgICB9CiAgICAgICAgbGV0IGJ5dGVJbmRleCA9IHRoaXMuUG9zaXRpb24gLyA4OwogICAgICAgIGxldCBiaXRJbmRleCA9IHRoaXMuUG9zaXRpb24gJSA4OwogICAgICAgIGlmIChiaXRDb3VudCA8PSA5ICYmIHRoaXMuUmVtYWluaW5nID49IDE2KSB7CiAgICAgICAgICAgIGxldCB2YWx1ZSA9IHRoaXMuZHYuZ2V0VWludDE2KGJ5dGVJbmRleCk7CiAgICAgICAgICAgIHZhbHVlICY9IDB4RkZGRiA+PiBiaXRJbmRleDsKICAgICAgICAgICAgdmFsdWUgPj49IDE2IC0gYml0Q291bnQgLSBiaXRJbmRleDsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgICBpZiAoYml0Q291bnQgPD0gMTcgJiYgdGhpcy5SZW1haW5pbmcgPj0gMjQpIHsKICAgICAgICAgICAgbGV0IHZhbHVlID0gdGhpcy5kdi5nZXRVaW50MTYoYnl0ZUluZGV4KSA8PCA4IHwgdGhpcy5kdi5nZXRVaW50OChieXRlSW5kZXggKyAyKTsKICAgICAgICAgICAgdmFsdWUgJj0gMHhGRkZGRkYgPj4gYml0SW5kZXg7CiAgICAgICAgICAgIHZhbHVlID4+PSAyNCAtIGJpdENvdW50IC0gYml0SW5kZXg7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKGJpdENvdW50IDw9IDI1ICYmIHRoaXMuUmVtYWluaW5nID49IDMyKSB7CiAgICAgICAgICAgIGxldCB2YWx1ZSA9IHRoaXMuZHYuZ2V0VWludDMyKGJ5dGVJbmRleCk7CiAgICAgICAgICAgIHZhbHVlICY9IDB4RkZGRkZGRkYgPj4+IGJpdEluZGV4OwogICAgICAgICAgICB2YWx1ZSA+Pj0gMzIgLSBiaXRDb3VudCAtIGJpdEluZGV4OwogICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLlBlZWtJbnRGYWxsYmFjayhiaXRDb3VudCk7CiAgICB9CiAgICBQZWVrSW50RmFsbGJhY2soYml0Q291bnQpIHsKICAgICAgICBsZXQgdmFsdWUgPSAwOwogICAgICAgIGxldCBieXRlSW5kZXggPSB0aGlzLlBvc2l0aW9uIC8gODsKICAgICAgICBsZXQgYml0SW5kZXggPSB0aGlzLlBvc2l0aW9uICUgODsKICAgICAgICB3aGlsZSAoYml0Q291bnQgPiAwKSB7CiAgICAgICAgICAgIGlmIChiaXRJbmRleCA+PSA4KSB7CiAgICAgICAgICAgICAgICBiaXRJbmRleCA9IDA7CiAgICAgICAgICAgICAgICBieXRlSW5kZXgrKzsKICAgICAgICAgICAgfQogICAgICAgICAgICBsZXQgYml0c1RvUmVhZCA9IE1hdGgubWluKGJpdENvdW50LCA4IC0gYml0SW5kZXgpOwogICAgICAgICAgICBsZXQgbWFzayA9IDB4RkYgPj4gYml0SW5kZXg7CiAgICAgICAgICAgIGxldCBjdXJyZW50Qnl0ZSA9IChtYXNrICYgdGhpcy5kdi5nZXRVaW50OChieXRlSW5kZXgpKSA+PiAoOCAtIGJpdEluZGV4IC0gYml0c1RvUmVhZCk7CiAgICAgICAgICAgIHZhbHVlID0gKHZhbHVlIDw8IGJpdHNUb1JlYWQpIHwgY3VycmVudEJ5dGU7CiAgICAgICAgICAgIGJpdEluZGV4ICs9IGJpdHNUb1JlYWQ7CiAgICAgICAgICAgIGJpdENvdW50IC09IGJpdHNUb1JlYWQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KfQp2YXIgSENBT2Zmc2V0QmlhczsKKGZ1bmN0aW9uIChIQ0FPZmZzZXRCaWFzKSB7CiAgICAvLy8gPHN1bW1hcnk+CiAgICAvLy8gU3BlY2lmaWVzIHRoZSBiaWFzIG9mIGFuIG9mZnNldCBiaW5hcnkgdmFsdWUuIEEgcG9zaXRpdmUgYmlhcyBjYW4gcmVwcmVzZW50IG9uZSBtb3JlCiAgICAvLy8gcG9zaXRpdmUgdmFsdWUgdGhhbiBuZWdhdGl2ZSB2YWx1ZSwgYW5kIGEgbmVnYXRpdmUgYmlhcyBjYW4gcmVwcmVzZW50IG9uZSBtb3JlCiAgICAvLy8gbmVnYXRpdmUgdmFsdWUgdGhhbiBwb3NpdGl2ZSB2YWx1ZS4KICAgIC8vLyA8L3N1bW1hcnk+CiAgICAvLy8gPHJlbWFya3M+RXhhbXBsZToKICAgIC8vLyBBIDQtYml0IG9mZnNldCBiaW5hcnkgdmFsdWUgd2l0aCBhIHBvc2l0aXZlIGJpYXMgY2FuIHN0b3JlCiAgICAvLy8gdGhlIHZhbHVlcyA4IHRocm91Z2ggLTcgaW5jbHVzaXZlLgogICAgLy8vIEEgNC1iaXQgb2Zmc2V0IGJpbmFyeSB2YWx1ZSB3aXRoIGEgbmVnYXRpdmUgYmlhcyBjYW4gc3RvcmUKICAgIC8vLyB0aGUgdmFsdWVzIDcgdGhyb3VnaCAtOCBpbmNsdXNpdmUuPC9yZW1hcmtzPgogICAgSENBT2Zmc2V0Qmlhc1tIQ0FPZmZzZXRCaWFzWyJQb3NpdGl2ZSJdID0gMV0gPSAiUG9zaXRpdmUiOwogICAgSENBT2Zmc2V0Qmlhc1tIQ0FPZmZzZXRCaWFzWyJOZWdhdGl2ZSJdID0gMF0gPSAiTmVnYXRpdmUiOwp9KShIQ0FPZmZzZXRCaWFzIHx8IChIQ0FPZmZzZXRCaWFzID0ge30pKTsKY2xhc3MgSENBQml0V3JpdGVyIHsKICAgIGdldCBSZW1haW5pbmcoKSB7IHJldHVybiB0aGlzLkxlbmd0aEJpdHMgLSB0aGlzLlBvc2l0aW9uOyB9CiAgICBjb25zdHJ1Y3RvcihidWZmZXIpIHsKICAgICAgICB0aGlzLlBvc2l0aW9uID0gMDsKICAgICAgICB0aGlzLkJ1ZmZlciA9IGJ1ZmZlcjsKICAgICAgICB0aGlzLmR2ID0gbmV3IERhdGFWaWV3KGJ1ZmZlci5idWZmZXIsIGJ1ZmZlci5ieXRlT2Zmc2V0LCBidWZmZXIuYnl0ZUxlbmd0aCk7CiAgICAgICAgdGhpcy5MZW5ndGhCaXRzID0gYnVmZmVyLmxlbmd0aCAqIDg7CiAgICB9CiAgICBBbGlnblBvc2l0aW9uKG11bHRpcGxlKSB7CiAgICAgICAgbGV0IG5ld1Bvc2l0aW9uID0gSENBVXRpbEZ1bmMuR2V0TmV4dE11bHRpcGxlKHRoaXMuUG9zaXRpb24sIG11bHRpcGxlKTsKICAgICAgICBsZXQgYml0cyA9IG5ld1Bvc2l0aW9uIC0gdGhpcy5Qb3NpdGlvbjsKICAgICAgICB0aGlzLldyaXRlKDAsIGJpdHMpOwogICAgfQogICAgV3JpdGUodmFsdWUsIGJpdENvdW50KSB7CiAgICAgICAgSENBVXRpbEZ1bmMuRGVidWdBc3NlcnQoYml0Q291bnQgPj0gMCAmJiBiaXRDb3VudCA8PSAzMik7CiAgICAgICAgaWYgKGJpdENvdW50ID4gdGhpcy5SZW1haW5pbmcpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJOb3QgZW5vdWdoIGJpdHMgbGVmdCBpbiBvdXRwdXQgYnVmZmVyIik7CiAgICAgICAgfQogICAgICAgIGxldCBieXRlSW5kZXggPSB0aGlzLlBvc2l0aW9uIC8gODsKICAgICAgICBsZXQgYml0SW5kZXggPSB0aGlzLlBvc2l0aW9uICUgODsKICAgICAgICBpZiAoYml0Q291bnQgPD0gOSAmJiB0aGlzLlJlbWFpbmluZyA+PSAxNikgewogICAgICAgICAgICBsZXQgb3V0VmFsdWUgPSAoKHZhbHVlIDw8ICgxNiAtIGJpdENvdW50KSkgJiAweEZGRkYpID4+IGJpdEluZGV4OwogICAgICAgICAgICBvdXRWYWx1ZSB8PSB0aGlzLmR2LmdldFVpbnQxNihieXRlSW5kZXgpOwogICAgICAgICAgICB0aGlzLmR2LnNldFVpbnQxNihieXRlSW5kZXgsIG91dFZhbHVlKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoYml0Q291bnQgPD0gMTcgJiYgdGhpcy5SZW1haW5pbmcgPj0gMjQpIHsKICAgICAgICAgICAgbGV0IG91dFZhbHVlID0gKCh2YWx1ZSA8PCAoMjQgLSBiaXRDb3VudCkpICYgMHhGRkZGRkYpID4+IGJpdEluZGV4OwogICAgICAgICAgICBvdXRWYWx1ZSB8PSB0aGlzLmR2LmdldFVpbnQxNihieXRlSW5kZXgpIDw8IDggfCB0aGlzLmR2LmdldFVpbnQ4KGJ5dGVJbmRleCArIDIpOwogICAgICAgICAgICB0aGlzLmR2LnNldFVpbnQxNihieXRlSW5kZXgsIG91dFZhbHVlID4+PiA4KTsKICAgICAgICAgICAgdGhpcy5kdi5zZXRVaW50OChieXRlSW5kZXggKyAyLCBvdXRWYWx1ZSAmIDB4RkYpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChiaXRDb3VudCA8PSAyNSAmJiB0aGlzLlJlbWFpbmluZyA+PSAzMikgewogICAgICAgICAgICBsZXQgb3V0VmFsdWUgPSAoKCh2YWx1ZSA8PCAoMzIgLSBiaXRDb3VudCkpICYgMHhGRkZGRkZGRikgPj4+IGJpdEluZGV4KTsKICAgICAgICAgICAgb3V0VmFsdWUgfD0gdGhpcy5kdi5nZXRVaW50MzIoYnl0ZUluZGV4KTsKICAgICAgICAgICAgdGhpcy5kdi5zZXRVaW50MzIoYnl0ZUluZGV4LCBvdXRWYWx1ZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICB0aGlzLldyaXRlRmFsbGJhY2sodmFsdWUsIGJpdENvdW50KTsKICAgICAgICB9CiAgICAgICAgdGhpcy5Qb3NpdGlvbiArPSBiaXRDb3VudDsKICAgIH0KICAgIFdyaXRlRmFsbGJhY2sodmFsdWUsIGJpdENvdW50KSB7CiAgICAgICAgbGV0IGJ5dGVJbmRleCA9IHRoaXMuUG9zaXRpb24gLyA4OwogICAgICAgIGxldCBiaXRJbmRleCA9IHRoaXMuUG9zaXRpb24gJSA4OwogICAgICAgIHdoaWxlIChiaXRDb3VudCA+IDApIHsKICAgICAgICAgICAgaWYgKGJpdEluZGV4ID49IDgpIHsKICAgICAgICAgICAgICAgIGJpdEluZGV4ID0gMDsKICAgICAgICAgICAgICAgIGJ5dGVJbmRleCsrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxldCB0b1NoaWZ0ID0gOCAtIGJpdEluZGV4IC0gYml0Q291bnQ7CiAgICAgICAgICAgIGxldCBzaGlmdGVkID0gdG9TaGlmdCA8IDAgPyB2YWx1ZSA+Pj4gLXRvU2hpZnQgOiB2YWx1ZSA8PCB0b1NoaWZ0OwogICAgICAgICAgICBsZXQgYml0c1RvV3JpdGUgPSBNYXRoLm1pbihiaXRDb3VudCwgOCAtIGJpdEluZGV4KTsKICAgICAgICAgICAgbGV0IG1hc2sgPSAoKDEgPDwgYml0c1RvV3JpdGUpIC0gMSkgPDwgOCAtIGJpdEluZGV4IC0gYml0c1RvV3JpdGU7CiAgICAgICAgICAgIGxldCBvdXRCeXRlID0gdGhpcy5kdi5nZXRVaW50OChieXRlSW5kZXgpICYgfm1hc2s7CiAgICAgICAgICAgIG91dEJ5dGUgfD0gc2hpZnRlZCAmIG1hc2s7CiAgICAgICAgICAgIHRoaXMuZHYuc2V0VWludDgoYnl0ZUluZGV4LCBvdXRCeXRlKTsKICAgICAgICAgICAgYml0SW5kZXggKz0gYml0c1RvV3JpdGU7CiAgICAgICAgICAgIGJpdENvdW50IC09IGJpdHNUb1dyaXRlOwogICAgICAgIH0KICAgIH0KfQpjbGFzcyBIQ0FGcmFtZSB7CiAgICBjb25zdHJ1Y3RvcihoY2EpIHsKICAgICAgICB0aGlzLkFjY2VwdGFibGVOb2lzZUxldmVsID0gMDsKICAgICAgICB0aGlzLkV2YWx1YXRpb25Cb3VuZGFyeSA9IDA7CiAgICAgICAgdGhpcy5IY2EgPSBoY2E7CiAgICAgICAgbGV0IGNoYW5uZWxUeXBlcyA9IEhDQUZyYW1lLkdldENoYW5uZWxUeXBlcyhoY2EpOwogICAgICAgIHRoaXMuQ2hhbm5lbHMgPSBbXTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGhjYS5mb3JtYXQuY2hhbm5lbENvdW50OyBpKyspIHsKICAgICAgICAgICAgdGhpcy5DaGFubmVscy5wdXNoKG5ldyBIQ0FDaGFubmVsKHsKICAgICAgICAgICAgICAgIFR5cGU6IGNoYW5uZWxUeXBlc1tpXSwKICAgICAgICAgICAgICAgIENvZGVkU2NhbGVGYWN0b3JDb3VudDogY2hhbm5lbFR5cGVzW2ldID09IEhDQUNoYW5uZWxUeXBlLlN0ZXJlb1NlY29uZGFyeQogICAgICAgICAgICAgICAgICAgID8gaGNhLmNvbXBEZWMuQmFzZUJhbmRDb3VudAogICAgICAgICAgICAgICAgICAgIDogaGNhLmNvbXBEZWMuQmFzZUJhbmRDb3VudCArIGhjYS5jb21wRGVjLlN0ZXJlb0JhbmRDb3VudAogICAgICAgICAgICB9KSk7CiAgICAgICAgfQogICAgICAgIHRoaXMuQXRoQ3VydmUgPSBoY2EuVXNlQXRoQ3VydmUgPyBIQ0FGcmFtZS5TY2FsZUF0aEN1cnZlKGhjYS5mb3JtYXQuc2FtcGxpbmdSYXRlKSA6IG5ldyBVaW50OEFycmF5KEhDQUZyYW1lLlNhbXBsZXNQZXJTdWJGcmFtZSk7CiAgICB9CiAgICBzdGF0aWMgR2V0Q2hhbm5lbFR5cGVzKGhjYSkgewogICAgICAgIGxldCBjaGFubmVsc1BlclRyYWNrID0gaGNhLmZvcm1hdC5jaGFubmVsQ291bnQgLyBoY2EuY29tcERlYy5UcmFja0NvdW50OwogICAgICAgIGlmIChoY2EuY29tcERlYy5TdGVyZW9CYW5kQ291bnQgPT0gMCB8fCBjaGFubmVsc1BlclRyYWNrID09IDEpIHsKICAgICAgICAgICAgcmV0dXJuIG5ldyBBcnJheSg4KS5maWxsKEhDQUNoYW5uZWxUeXBlKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgRGlzY3JldGUgPSBIQ0FDaGFubmVsVHlwZS5EaXNjcmV0ZTsKICAgICAgICBjb25zdCBTdGVyZW9QcmltYXJ5ID0gSENBQ2hhbm5lbFR5cGUuU3RlcmVvUHJpbWFyeTsKICAgICAgICBjb25zdCBTdGVyZW9TZWNvbmRhcnkgPSBIQ0FDaGFubmVsVHlwZS5TdGVyZW9TZWNvbmRhcnk7CiAgICAgICAgc3dpdGNoIChjaGFubmVsc1BlclRyYWNrKSB7CiAgICAgICAgICAgIGNhc2UgMjogcmV0dXJuIFtTdGVyZW9QcmltYXJ5LCBTdGVyZW9TZWNvbmRhcnldOwogICAgICAgICAgICBjYXNlIDM6IHJldHVybiBbU3RlcmVvUHJpbWFyeSwgU3RlcmVvU2Vjb25kYXJ5LCBEaXNjcmV0ZV07CiAgICAgICAgICAgIGNhc2UgNDogaWYgKGhjYS5jb21wRGVjLkNoYW5uZWxDb25maWcgIT0gMCkKICAgICAgICAgICAgICAgIHJldHVybiBbU3RlcmVvUHJpbWFyeSwgU3RlcmVvU2Vjb25kYXJ5LCBEaXNjcmV0ZSwgRGlzY3JldGVdOwogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICByZXR1cm4gW1N0ZXJlb1ByaW1hcnksIFN0ZXJlb1NlY29uZGFyeSwgU3RlcmVvUHJpbWFyeSwgU3RlcmVvU2Vjb25kYXJ5XTsKICAgICAgICAgICAgY2FzZSA1OiBpZiAoaGNhLmNvbXBEZWMuQ2hhbm5lbENvbmZpZyA+IDIpCiAgICAgICAgICAgICAgICByZXR1cm4gW1N0ZXJlb1ByaW1hcnksIFN0ZXJlb1NlY29uZGFyeSwgRGlzY3JldGUsIERpc2NyZXRlLCBEaXNjcmV0ZV07CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHJldHVybiBbU3RlcmVvUHJpbWFyeSwgU3RlcmVvU2Vjb25kYXJ5LCBEaXNjcmV0ZSwgU3RlcmVvUHJpbWFyeSwgU3RlcmVvU2Vjb25kYXJ5XTsKICAgICAgICAgICAgY2FzZSA2OiByZXR1cm4gW1N0ZXJlb1ByaW1hcnksIFN0ZXJlb1NlY29uZGFyeSwgRGlzY3JldGUsIERpc2NyZXRlLCBTdGVyZW9QcmltYXJ5LCBTdGVyZW9TZWNvbmRhcnldOwogICAgICAgICAgICBjYXNlIDc6IHJldHVybiBbU3RlcmVvUHJpbWFyeSwgU3RlcmVvU2Vjb25kYXJ5LCBEaXNjcmV0ZSwgRGlzY3JldGUsIFN0ZXJlb1ByaW1hcnksIFN0ZXJlb1NlY29uZGFyeSwgRGlzY3JldGVdOwogICAgICAgICAgICBjYXNlIDg6IHJldHVybiBbU3RlcmVvUHJpbWFyeSwgU3RlcmVvU2Vjb25kYXJ5LCBEaXNjcmV0ZSwgRGlzY3JldGUsIFN0ZXJlb1ByaW1hcnksIFN0ZXJlb1NlY29uZGFyeSwgU3RlcmVvUHJpbWFyeSwgU3RlcmVvU2Vjb25kYXJ5XTsKICAgICAgICAgICAgZGVmYXVsdDogcmV0dXJuIG5ldyBBcnJheShjaGFubmVsc1BlclRyYWNrKS5maWxsKEhDQUNoYW5uZWxUeXBlKTsKICAgICAgICB9CiAgICB9CiAgICAvLy8gPHN1bW1hcnk+CiAgICAvLy8gU2NhbGVzIGFuIEFUSCBjdXJ2ZSB0byB0aGUgc3BlY2lmaWVkIGZyZXF1ZW5jeS4KICAgIC8vLyA8L3N1bW1hcnk+CiAgICAvLy8gPHBhcmFtIG5hbWU9ImZyZXF1ZW5jeSI+VGhlIGZyZXF1ZW5jeSB0byBzY2FsZSB0aGUgY3VydmUgdG8uPC9wYXJhbT4KICAgIC8vLyA8cmV0dXJucz5UaGUgc2NhbGVkIEFUSCBjdXJ2ZTwvcmV0dXJucz4KICAgIC8vLyA8cmVtYXJrcz5UaGUgb3JpZ2luYWwgQVRIIGN1cnZlIGlzIGZvciBhIGZyZXF1ZW5jeSBvZiA0MTg1NiBIei48L3JlbWFya3M+CiAgICBzdGF0aWMgU2NhbGVBdGhDdXJ2ZShmcmVxdWVuY3kpIHsKICAgICAgICB2YXIgYXRoID0gbmV3IFVpbnQ4QXJyYXkoSENBRnJhbWUuU2FtcGxlc1BlclN1YkZyYW1lKTsKICAgICAgICBsZXQgYWNjID0gMDsKICAgICAgICBsZXQgaTsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgYXRoLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGFjYyArPSBmcmVxdWVuY3k7CiAgICAgICAgICAgIGxldCBpbmRleCA9IGFjYyA+PiAxMzsKICAgICAgICAgICAgaWYgKGluZGV4ID49IEhDQVRhYmxlcy5BdGhDdXJ2ZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGF0aFtpXSA9IEhDQVRhYmxlcy5BdGhDdXJ2ZVtpbmRleF07CiAgICAgICAgfQogICAgICAgIGZvciAoOyBpIDwgYXRoLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGF0aFtpXSA9IDB4ZmY7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhdGg7CiAgICB9Cn0KX2EgPSBIQ0FGcmFtZTsKSENBRnJhbWUuU3ViZnJhbWVzUGVyRnJhbWUgPSA4OwpIQ0FGcmFtZS5TdWJGcmFtZVNhbXBsZXNCaXRzID0gNzsKSENBRnJhbWUuU2FtcGxlc1BlclN1YkZyYW1lID0gMSA8PCBfYS5TdWJGcmFtZVNhbXBsZXNCaXRzOwpIQ0FGcmFtZS5TYW1wbGVzUGVyRnJhbWUgPSBfYS5TdWJmcmFtZXNQZXJGcmFtZSAqIF9hLlNhbXBsZXNQZXJTdWJGcmFtZTsKY2xhc3MgSENBQ2hhbm5lbCB7CiAgICBjb25zdHJ1Y3Rvcih2YWx1ZXMpIHsKICAgICAgICB0aGlzLlR5cGUgPSAwOwogICAgICAgIHRoaXMuQ29kZWRTY2FsZUZhY3RvckNvdW50ID0gMDsKICAgICAgICB0aGlzLlBjbUZsb2F0ID0gQXJyYXkuZnJvbSh7IGxlbmd0aDogSENBRnJhbWUuU3ViZnJhbWVzUGVyRnJhbWUgfSwgKCkgPT4gbmV3IEZsb2F0NjRBcnJheShIQ0FGcmFtZS5TYW1wbGVzUGVyU3ViRnJhbWUpKTsKICAgICAgICB0aGlzLlNwZWN0cmEgPSBBcnJheS5mcm9tKHsgbGVuZ3RoOiBIQ0FGcmFtZS5TdWJmcmFtZXNQZXJGcmFtZSB9LCAoKSA9PiBuZXcgRmxvYXQ2NEFycmF5KEhDQUZyYW1lLlNhbXBsZXNQZXJTdWJGcmFtZSkpOwogICAgICAgIHRoaXMuU2NhbGVkU3BlY3RyYSA9IEFycmF5LmZyb20oeyBsZW5ndGg6IEhDQUZyYW1lLlNhbXBsZXNQZXJTdWJGcmFtZSB9LCAoKSA9PiBuZXcgRmxvYXQ2NEFycmF5KEhDQUZyYW1lLlN1YmZyYW1lc1BlckZyYW1lKSk7CiAgICAgICAgdGhpcy5RdWFudGl6ZWRTcGVjdHJhID0gQXJyYXkuZnJvbSh7IGxlbmd0aDogSENBRnJhbWUuU3ViZnJhbWVzUGVyRnJhbWUgfSwgKCkgPT4gbmV3IEludDMyQXJyYXkoSENBRnJhbWUuU2FtcGxlc1BlclN1YkZyYW1lKSk7CiAgICAgICAgdGhpcy5HYWluID0gbmV3IEZsb2F0NjRBcnJheShIQ0FGcmFtZS5TYW1wbGVzUGVyU3ViRnJhbWUpOwogICAgICAgIHRoaXMuSW50ZW5zaXR5ID0gbmV3IEludDMyQXJyYXkoSENBRnJhbWUuU3ViZnJhbWVzUGVyRnJhbWUpOwogICAgICAgIHRoaXMuSGZyU2NhbGVzID0gbmV3IEludDMyQXJyYXkoOCk7CiAgICAgICAgdGhpcy5IZnJHcm91cEF2ZXJhZ2VTcGVjdHJhID0gbmV3IEZsb2F0NjRBcnJheSg4KTsKICAgICAgICB0aGlzLk1kY3QgPSBuZXcgSENBTWRjdChIQ0FGcmFtZS5TdWJGcmFtZVNhbXBsZXNCaXRzLCBIQ0FUYWJsZXMuTWRjdFdpbmRvdywgTWF0aC5zcXJ0KDIuMCAvIEhDQUZyYW1lLlNhbXBsZXNQZXJTdWJGcmFtZSkpOwogICAgICAgIHRoaXMuU2NhbGVGYWN0b3JzID0gbmV3IEludDMyQXJyYXkoSENBRnJhbWUuU2FtcGxlc1BlclN1YkZyYW1lKTsKICAgICAgICB0aGlzLlJlc29sdXRpb24gPSBuZXcgSW50MzJBcnJheShIQ0FGcmFtZS5TYW1wbGVzUGVyU3ViRnJhbWUpOwogICAgICAgIHRoaXMuSGVhZGVyTGVuZ3RoQml0cyA9IDA7CiAgICAgICAgdGhpcy5TY2FsZUZhY3RvckRlbHRhQml0cyA9IDA7CiAgICAgICAgbGV0IHQgPSB0aGlzOwogICAgICAgIGZvciAobGV0IGtleSBpbiB2YWx1ZXMpIHsKICAgICAgICAgICAgdFtrZXldID0gdmFsdWVzW2tleV07CiAgICAgICAgfQogICAgfQp9CnZhciBIQ0FDaGFubmVsVHlwZTsKKGZ1bmN0aW9uIChIQ0FDaGFubmVsVHlwZSkgewogICAgSENBQ2hhbm5lbFR5cGVbSENBQ2hhbm5lbFR5cGVbIkRpc2NyZXRlIl0gPSAwXSA9ICJEaXNjcmV0ZSI7CiAgICBIQ0FDaGFubmVsVHlwZVtIQ0FDaGFubmVsVHlwZVsiU3RlcmVvUHJpbWFyeSJdID0gMV0gPSAiU3RlcmVvUHJpbWFyeSI7CiAgICBIQ0FDaGFubmVsVHlwZVtIQ0FDaGFubmVsVHlwZVsiU3RlcmVvU2Vjb25kYXJ5Il0gPSAyXSA9ICJTdGVyZW9TZWNvbmRhcnkiOwp9KShIQ0FDaGFubmVsVHlwZSB8fCAoSENBQ2hhbm5lbFR5cGUgPSB7fSkpOwpjbGFzcyBIQ0FEZWNvZGVyIHsKICAgIHN0YXRpYyBEZWNvZGVGcmFtZShhdWRpbywgZnJhbWUpIHsKICAgICAgICBsZXQgcmVhZGVyID0gbmV3IEhDQUJpdFJlYWRlcihhdWRpbyk7CiAgICAgICAgaWYgKCFIQ0FQYWNraW5nLlVucGFja0ZyYW1lKGZyYW1lLCByZWFkZXIpKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVucGFja0ZyYW1lIGZhaWxlZGApOwogICAgICAgIHRoaXMuRGVxdWFudGl6ZUZyYW1lKGZyYW1lKTsKICAgICAgICB0aGlzLlJlc3RvcmVNaXNzaW5nQmFuZHMoZnJhbWUpOwogICAgICAgIHRoaXMuUnVuSW1kY3QoZnJhbWUpOwogICAgfQogICAgc3RhdGljIERlcXVhbnRpemVGcmFtZShmcmFtZSkgewogICAgICAgIGZvciAobGV0IGNoYW5uZWwgb2YgZnJhbWUuQ2hhbm5lbHMpIHsKICAgICAgICAgICAgdGhpcy5DYWxjdWxhdGVHYWluKGNoYW5uZWwpOwogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBzZiA9IDA7IHNmIDwgSENBRnJhbWUuU3ViZnJhbWVzUGVyRnJhbWU7IHNmKyspIHsKICAgICAgICAgICAgZm9yIChsZXQgY2hhbm5lbCBvZiBmcmFtZS5DaGFubmVscykgewogICAgICAgICAgICAgICAgZm9yIChsZXQgcyA9IDA7IHMgPCBjaGFubmVsLkNvZGVkU2NhbGVGYWN0b3JDb3VudDsgcysrKSB7CiAgICAgICAgICAgICAgICAgICAgY2hhbm5lbC5TcGVjdHJhW3NmXVtzXSA9IGNoYW5uZWwuUXVhbnRpemVkU3BlY3RyYVtzZl1bc10gKiBjaGFubmVsLkdhaW5bc107CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBzdGF0aWMgUmVzdG9yZU1pc3NpbmdCYW5kcyhmcmFtZSkgewogICAgICAgIHRoaXMuUmVjb25zdHJ1Y3RIaWdoRnJlcXVlbmN5KGZyYW1lKTsKICAgICAgICB0aGlzLkFwcGx5SW50ZW5zaXR5U3RlcmVvKGZyYW1lKTsKICAgIH0KICAgIHN0YXRpYyBDYWxjdWxhdGVHYWluKGNoYW5uZWwpIHsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoYW5uZWwuQ29kZWRTY2FsZUZhY3RvckNvdW50OyBpKyspIHsKICAgICAgICAgICAgY2hhbm5lbC5HYWluW2ldID0gSENBVGFibGVzLkRlcXVhbnRpemVyU2NhbGluZ1RhYmxlW2NoYW5uZWwuU2NhbGVGYWN0b3JzW2ldXSAqIEhDQVRhYmxlcy5RdWFudGl6ZXJTdGVwU2l6ZVtjaGFubmVsLlJlc29sdXRpb25baV1dOwogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBSZWNvbnN0cnVjdEhpZ2hGcmVxdWVuY3koZnJhbWUpIHsKICAgICAgICBsZXQgaGNhID0gZnJhbWUuSGNhOwogICAgICAgIGlmIChoY2EuSGZyR3JvdXBDb3VudCA9PSAwKQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgLy8gVGhlIGxhc3Qgc3BlY3RyYWwgY29lZmZpY2llbnQgc2hvdWxkIGFsd2F5cyBiZSAwOwogICAgICAgIGxldCB0b3RhbEJhbmRDb3VudCA9IE1hdGgubWluKGhjYS5jb21wRGVjLlRvdGFsQmFuZENvdW50LCAxMjcpOwogICAgICAgIGxldCBoZnJTdGFydEJhbmQgPSBoY2EuY29tcERlYy5CYXNlQmFuZENvdW50ICsgaGNhLmNvbXBEZWMuU3RlcmVvQmFuZENvdW50OwogICAgICAgIGxldCBoZnJCYW5kQ291bnQgPSBNYXRoLm1pbihoY2EuY29tcERlYy5IZnJCYW5kQ291bnQsIHRvdGFsQmFuZENvdW50IC0gaGNhLmNvbXBEZWMuSGZyQmFuZENvdW50KTsKICAgICAgICBmb3IgKGxldCBjaGFubmVsIG9mIGZyYW1lLkNoYW5uZWxzKSB7CiAgICAgICAgICAgIGlmIChjaGFubmVsLlR5cGUgPT0gSENBQ2hhbm5lbFR5cGUuU3RlcmVvU2Vjb25kYXJ5KQogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIGZvciAobGV0IGdyb3VwID0gMCwgYmFuZCA9IDA7IGdyb3VwIDwgaGNhLkhmckdyb3VwQ291bnQ7IGdyb3VwKyspIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaGNhLmNvbXBEZWMuQmFuZHNQZXJIZnJHcm91cCAmJiBiYW5kIDwgaGZyQmFuZENvdW50OyBiYW5kKyssIGkrKykgewogICAgICAgICAgICAgICAgICAgIGxldCBoaWdoQmFuZCA9IGhmclN0YXJ0QmFuZCArIGJhbmQ7CiAgICAgICAgICAgICAgICAgICAgbGV0IGxvd0JhbmQgPSBoZnJTdGFydEJhbmQgLSBiYW5kIC0gMTsKICAgICAgICAgICAgICAgICAgICBsZXQgaW5kZXggPSBjaGFubmVsLkhmclNjYWxlc1tncm91cF0gLSBjaGFubmVsLlNjYWxlRmFjdG9yc1tsb3dCYW5kXSArIDY0OwogICAgICAgICAgICAgICAgICAgIGZvciAobGV0IHNmID0gMDsgc2YgPCBIQ0FGcmFtZS5TdWJmcmFtZXNQZXJGcmFtZTsgc2YrKykgewogICAgICAgICAgICAgICAgICAgICAgICBjaGFubmVsLlNwZWN0cmFbc2ZdW2hpZ2hCYW5kXSA9IEhDQVRhYmxlcy5TY2FsZUNvbnZlcnNpb25UYWJsZVtpbmRleF0gKiBjaGFubmVsLlNwZWN0cmFbc2ZdW2xvd0JhbmRdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBBcHBseUludGVuc2l0eVN0ZXJlbyhmcmFtZSkgewogICAgICAgIGlmIChmcmFtZS5IY2EuY29tcERlYy5TdGVyZW9CYW5kQ291bnQgPD0gMCkKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIGZvciAobGV0IGMgPSAwOyBjIDwgZnJhbWUuQ2hhbm5lbHMubGVuZ3RoOyBjKyspIHsKICAgICAgICAgICAgaWYgKGZyYW1lLkNoYW5uZWxzW2NdLlR5cGUgIT0gSENBQ2hhbm5lbFR5cGUuU3RlcmVvUHJpbWFyeSkKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICBmb3IgKGxldCBzZiA9IDA7IHNmIDwgSENBRnJhbWUuU3ViZnJhbWVzUGVyRnJhbWU7IHNmKyspIHsKICAgICAgICAgICAgICAgIGxldCBsID0gZnJhbWUuQ2hhbm5lbHNbY10uU3BlY3RyYVtzZl07CiAgICAgICAgICAgICAgICBsZXQgciA9IGZyYW1lLkNoYW5uZWxzW2MgKyAxXS5TcGVjdHJhW3NmXTsKICAgICAgICAgICAgICAgIGxldCByYXRpb0wgPSBIQ0FUYWJsZXMuSW50ZW5zaXR5UmF0aW9UYWJsZVtmcmFtZS5DaGFubmVsc1tjICsgMV0uSW50ZW5zaXR5W3NmXV07CiAgICAgICAgICAgICAgICBsZXQgcmF0aW9SID0gcmF0aW9MIC0gMi4wOwogICAgICAgICAgICAgICAgZm9yIChsZXQgYiA9IGZyYW1lLkhjYS5jb21wRGVjLkJhc2VCYW5kQ291bnQ7IGIgPCBmcmFtZS5IY2EuY29tcERlYy5Ub3RhbEJhbmRDb3VudDsgYisrKSB7CiAgICAgICAgICAgICAgICAgICAgcltiXSA9IGxbYl0gKiByYXRpb1I7CiAgICAgICAgICAgICAgICAgICAgbFtiXSAqPSByYXRpb0w7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBzdGF0aWMgUnVuSW1kY3QoZnJhbWUpIHsKICAgICAgICBmb3IgKGxldCBzZiA9IDA7IHNmIDwgSENBRnJhbWUuU3ViZnJhbWVzUGVyRnJhbWU7IHNmKyspIHsKICAgICAgICAgICAgZm9yIChsZXQgY2hhbm5lbCBvZiBmcmFtZS5DaGFubmVscykgewogICAgICAgICAgICAgICAgY2hhbm5lbC5NZGN0LlJ1bkltZGN0KGNoYW5uZWwuU3BlY3RyYVtzZl0sIGNoYW5uZWwuUGNtRmxvYXRbc2ZdKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQpjbGFzcyBIQ0FQYWNraW5nIHsKICAgIHN0YXRpYyBVbnBhY2tGcmFtZShmcmFtZSwgcmVhZGVyKSB7CiAgICAgICAgaWYgKCF0aGlzLlVucGFja0ZyYW1lSGVhZGVyKGZyYW1lLCByZWFkZXIpKQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgdGhpcy5SZWFkU3BlY3RyYWxDb2VmZmljaWVudHMoZnJhbWUsIHJlYWRlcik7CiAgICAgICAgcmV0dXJuIHRoaXMuVW5wYWNraW5nV2FzU3VjY2Vzc2Z1bChmcmFtZSwgcmVhZGVyKTsKICAgIH0KICAgIHN0YXRpYyBQYWNrRnJhbWUoZnJhbWUsIG91dEJ1ZmZlcikgewogICAgICAgIHZhciB3cml0ZXIgPSBuZXcgSENBQml0V3JpdGVyKG91dEJ1ZmZlcik7CiAgICAgICAgd3JpdGVyLldyaXRlKDB4ZmZmZiwgMTYpOwogICAgICAgIHdyaXRlci5Xcml0ZShmcmFtZS5BY2NlcHRhYmxlTm9pc2VMZXZlbCwgOSk7CiAgICAgICAgd3JpdGVyLldyaXRlKGZyYW1lLkV2YWx1YXRpb25Cb3VuZGFyeSwgNyk7CiAgICAgICAgZm9yIChsZXQgY2hhbm5lbCBvZiBmcmFtZS5DaGFubmVscykgewogICAgICAgICAgICB0aGlzLldyaXRlU2NhbGVGYWN0b3JzKHdyaXRlciwgY2hhbm5lbCk7CiAgICAgICAgICAgIGlmIChjaGFubmVsLlR5cGUgPT0gSENBQ2hhbm5lbFR5cGUuU3RlcmVvU2Vjb25kYXJ5KSB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IEhDQUZyYW1lLlN1YmZyYW1lc1BlckZyYW1lOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB3cml0ZXIuV3JpdGUoY2hhbm5lbC5JbnRlbnNpdHlbaV0sIDQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKGZyYW1lLkhjYS5IZnJHcm91cENvdW50ID4gMCkgewogICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmcmFtZS5IY2EuSGZyR3JvdXBDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgd3JpdGVyLldyaXRlKGNoYW5uZWwuSGZyU2NhbGVzW2ldLCA2KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmb3IgKGxldCBzZiA9IDA7IHNmIDwgSENBRnJhbWUuU3ViZnJhbWVzUGVyRnJhbWU7IHNmKyspIHsKICAgICAgICAgICAgZm9yIChsZXQgY2hhbm5lbCBvZiBmcmFtZS5DaGFubmVscykgewogICAgICAgICAgICAgICAgdGhpcy5Xcml0ZVNwZWN0cmEod3JpdGVyLCBjaGFubmVsLCBzZik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgd3JpdGVyLkFsaWduUG9zaXRpb24oOCk7CiAgICAgICAgZm9yIChsZXQgaSA9IHdyaXRlci5Qb3NpdGlvbiAvIDg7IGkgPCBmcmFtZS5IY2EuYmxvY2tTaXplIC0gMjsgaSsrKSB7CiAgICAgICAgICAgIHdyaXRlci5kdi5zZXRVaW50OChpLCAwKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5Xcml0ZUNoZWNrc3VtKHdyaXRlciwgb3V0QnVmZmVyKTsKICAgIH0KICAgIHN0YXRpYyBDYWxjdWxhdGVSZXNvbHV0aW9uKHNjYWxlRmFjdG9yLCBub2lzZUxldmVsLCB2ZXJzaW9uTWFqb3IpIHsKICAgICAgICBpZiAoc2NhbGVGYWN0b3IgPT0gMCkgewogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CiAgICAgICAgbGV0IGN1cnZlUG9zaXRpb24gPSBub2lzZUxldmVsIC0gKDUgKiBzY2FsZUZhY3RvciA+PiAxKSArIDI7CiAgICAgICAgLy9odHRwczovL2dpdGh1Yi5jb20vdmdtc3RyZWFtL3ZnbXN0cmVhbS9ibG9iLzRlZWNkYWRhOWEwM2E3M2FmMGM3YzE3ZjVjZDZlMDg1MThmZDdlM2Yvc3JjL2NvZGluZy9oY2FfZGVjb2Rlcl9jbGhjYS5jI0wxNDUwCiAgICAgICAgLy9GSVhNRSBoY2EyLjAgZGVjb2RpbmcgYnJlYWtzIGlmIGNvbmRpdGlvbmFsICh0ZXJuYXJ5KSBvcGVyYXRvciBpcyByZW1vdmVkCiAgICAgICAgLy9jdXJ2ZVBvc2l0aW9uID0gSENBVXRpbEZ1bmMuQ2xhbXAoY3VydmVQb3NpdGlvbiwgMCwgNjcpOwogICAgICAgIGN1cnZlUG9zaXRpb24gPSBIQ0FVdGlsRnVuYy5DbGFtcChjdXJ2ZVBvc2l0aW9uLCAwLCB2ZXJzaW9uTWFqb3IgPD0gMiA/IDU4IDogNjcpOwogICAgICAgIHJldHVybiBIQ0FUYWJsZXMuU2NhbGVUb1Jlc29sdXRpb25DdXJ2ZVtjdXJ2ZVBvc2l0aW9uXTsKICAgIH0KICAgIHN0YXRpYyBVbnBhY2tGcmFtZUhlYWRlcihmcmFtZSwgcmVhZGVyKSB7CiAgICAgICAgbGV0IGhjYSA9IGZyYW1lLkhjYTsKICAgICAgICBsZXQgc3luY1dvcmQgPSByZWFkZXIuUmVhZEludCgxNik7CiAgICAgICAgaWYgKHN5bmNXb3JkICE9IDB4ZmZmZikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgZnJhbWUgaGVhZGVyIik7CiAgICAgICAgfQogICAgICAgIGxldCBhdGhDdXJ2ZSA9IGZyYW1lLkF0aEN1cnZlOwogICAgICAgIGZyYW1lLkFjY2VwdGFibGVOb2lzZUxldmVsID0gcmVhZGVyLlJlYWRJbnQoOSk7CiAgICAgICAgZnJhbWUuRXZhbHVhdGlvbkJvdW5kYXJ5ID0gcmVhZGVyLlJlYWRJbnQoNyk7CiAgICAgICAgZm9yIChsZXQgY2hhbm5lbCBvZiBmcmFtZS5DaGFubmVscykgewogICAgICAgICAgICBpZiAoIXRoaXMuUmVhZFNjYWxlRmFjdG9ycyhjaGFubmVsLCByZWFkZXIsIGhjYS5IZnJHcm91cENvdW50LCBoY2EudmVyc2lvbk1ham9yKSkKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgLy8gYWRkZWQgY2xhbXAKICAgICAgICAgICAgLy9odHRwczovL2dpdGh1Yi5jb20vdmdtc3RyZWFtL3ZnbXN0cmVhbS9ibG9iLzRlZWNkYWRhOWEwM2E3M2FmMGM3YzE3ZjVjZDZlMDg1MThmZDdlM2Yvc3JjL2NvZGluZy9oY2FfZGVjb2Rlcl9jbGhjYS5jI0wxNDYyCiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZnJhbWUuRXZhbHVhdGlvbkJvdW5kYXJ5OyBpKyspIHsKICAgICAgICAgICAgICAgIGxldCBuZXdSZXNvbHV0aW9uID0gdGhpcy5DYWxjdWxhdGVSZXNvbHV0aW9uKGNoYW5uZWwuU2NhbGVGYWN0b3JzW2ldLCBhdGhDdXJ2ZVtpXSArIGZyYW1lLkFjY2VwdGFibGVOb2lzZUxldmVsIC0gMSwgaGNhLnZlcnNpb25NYWpvcik7CiAgICAgICAgICAgICAgICBpZiAoaGNhLnZlcnNpb25NYWpvciA+IDIpCiAgICAgICAgICAgICAgICAgICAgbmV3UmVzb2x1dGlvbiA9IEhDQVV0aWxGdW5jLkNsYW1wKG5ld1Jlc29sdXRpb24sIGhjYS5jb21wRGVjLk1pblJlc29sdXRpb24sIGhjYS5jb21wRGVjLk1heFJlc29sdXRpb24pOwogICAgICAgICAgICAgICAgY2hhbm5lbC5SZXNvbHV0aW9uW2ldID0gbmV3UmVzb2x1dGlvbjsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKGxldCBpID0gZnJhbWUuRXZhbHVhdGlvbkJvdW5kYXJ5OyBpIDwgY2hhbm5lbC5Db2RlZFNjYWxlRmFjdG9yQ291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgbGV0IG5ld1Jlc29sdXRpb24gPSB0aGlzLkNhbGN1bGF0ZVJlc29sdXRpb24oY2hhbm5lbC5TY2FsZUZhY3RvcnNbaV0sIGF0aEN1cnZlW2ldICsgZnJhbWUuQWNjZXB0YWJsZU5vaXNlTGV2ZWwsIGhjYS52ZXJzaW9uTWFqb3IpOwogICAgICAgICAgICAgICAgaWYgKGhjYS52ZXJzaW9uTWFqb3IgPiAyKQogICAgICAgICAgICAgICAgICAgIG5ld1Jlc29sdXRpb24gPSBIQ0FVdGlsRnVuYy5DbGFtcChuZXdSZXNvbHV0aW9uLCBoY2EuY29tcERlYy5NaW5SZXNvbHV0aW9uLCBoY2EuY29tcERlYy5NYXhSZXNvbHV0aW9uKTsKICAgICAgICAgICAgICAgIGNoYW5uZWwuUmVzb2x1dGlvbltpXSA9IG5ld1Jlc29sdXRpb247CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGNoYW5uZWwuVHlwZSA9PSBIQ0FDaGFubmVsVHlwZS5TdGVyZW9TZWNvbmRhcnkpIHsKICAgICAgICAgICAgICAgIHRoaXMuUmVhZEludGVuc2l0eShyZWFkZXIsIGNoYW5uZWwuSW50ZW5zaXR5LCBoY2EudmVyc2lvbk1ham9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChmcmFtZS5IY2EuSGZyR3JvdXBDb3VudCA+IDApIHsKICAgICAgICAgICAgICAgIGlmIChoY2EudmVyc2lvbk1ham9yIDw9IDIpCiAgICAgICAgICAgICAgICAgICAgdGhpcy5SZWFkSGZyU2NhbGVGYWN0b3JzKHJlYWRlciwgZnJhbWUuSGNhLkhmckdyb3VwQ291bnQsIGNoYW5uZWwuSGZyU2NhbGVzKTsKICAgICAgICAgICAgICAgIC8vIHYzLjAgdXNlcyB2YWx1ZXMgZGVyaXZlZCBpbiBSZWFkU2NhbGVGYWN0b3JzCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBzdGF0aWMgUmVhZFNjYWxlRmFjdG9ycyhjaGFubmVsLCByZWFkZXIsIGhmckdyb3VwQ291bnQsIHZlcnNpb25NYWpvcikgewogICAgICAgIGNoYW5uZWwuU2NhbGVGYWN0b3JEZWx0YUJpdHMgPSByZWFkZXIuUmVhZEludCgzKTsKICAgICAgICBpZiAoY2hhbm5lbC5TY2FsZUZhY3RvckRlbHRhQml0cyA9PSAwKSB7CiAgICAgICAgICAgIGNoYW5uZWwuU2NhbGVGYWN0b3JzLmZpbGwoMCwgMCwgY2hhbm5lbC5TY2FsZUZhY3RvcnMubGVuZ3RoKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIC8vIGFkZGVkIGluIHYzLjAKICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vdmdtc3RyZWFtL3ZnbXN0cmVhbS9ibG9iLzRlZWNkYWRhOWEwM2E3M2FmMGM3YzE3ZjVjZDZlMDg1MThmZDdlM2Yvc3JjL2NvZGluZy9oY2FfZGVjb2Rlcl9jbGhjYS5jI0wxMjg3CiAgICAgICAgbGV0IGV4dHJhQ29kZWRTY2FsZUZhY3RvckNvdW50OwogICAgICAgIGxldCBjb2RlZFNjYWxlRmFjdG9yQ291bnQ7CiAgICAgICAgaWYgKGNoYW5uZWwuVHlwZSA9PSBIQ0FDaGFubmVsVHlwZS5TdGVyZW9TZWNvbmRhcnkgfHwgaGZyR3JvdXBDb3VudCA8PSAwIHx8IHZlcnNpb25NYWpvciA8PSAyKSB7CiAgICAgICAgICAgIGV4dHJhQ29kZWRTY2FsZUZhY3RvckNvdW50ID0gMDsKICAgICAgICAgICAgY29kZWRTY2FsZUZhY3RvckNvdW50ID0gY2hhbm5lbC5Db2RlZFNjYWxlRmFjdG9yQ291bnQ7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICBleHRyYUNvZGVkU2NhbGVGYWN0b3JDb3VudCA9IGhmckdyb3VwQ291bnQ7CiAgICAgICAgICAgIGNvZGVkU2NhbGVGYWN0b3JDb3VudCA9IGNoYW5uZWwuQ29kZWRTY2FsZUZhY3RvckNvdW50ICsgZXh0cmFDb2RlZFNjYWxlRmFjdG9yQ291bnQ7CiAgICAgICAgICAgIC8vIGp1c3QgaW4gY2FzZQogICAgICAgICAgICBpZiAoY29kZWRTY2FsZUZhY3RvckNvdW50ID4gSENBRnJhbWUuU2FtcGxlc1BlclN1YkZyYW1lKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBjb2RlZFNjYWxlRmFjdG9yQ291bnQgPiBIQ0FGcmFtZS5TYW1wbGVzUGVyU3ViRnJhbWVgKTsKICAgICAgICB9CiAgICAgICAgaWYgKGNoYW5uZWwuU2NhbGVGYWN0b3JEZWx0YUJpdHMgPj0gNikgewogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvZGVkU2NhbGVGYWN0b3JDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjaGFubmVsLlNjYWxlRmFjdG9yc1tpXSA9IHJlYWRlci5SZWFkSW50KDYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBsZXQgcmVzdWx0ID0gdGhpcy5EZWx0YURlY29kZShyZWFkZXIsIGNoYW5uZWwuU2NhbGVGYWN0b3JEZWx0YUJpdHMsIDYsIGNvZGVkU2NhbGVGYWN0b3JDb3VudCwgY2hhbm5lbC5TY2FsZUZhY3RvcnMpOwogICAgICAgIGlmICghcmVzdWx0KQogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIC8vIHNldCBkZXJpdmVkIEhGUiBzY2FsZXMgZm9yIHYzLjAKICAgICAgICAvL0ZJWE1FIFVOVEVTVEVECiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBleHRyYUNvZGVkU2NhbGVGYWN0b3JDb3VudDsgaSsrKSB7CiAgICAgICAgICAgIGNoYW5uZWwuSGZyU2NhbGVzW2NvZGVkU2NhbGVGYWN0b3JDb3VudCAtIDEgLSBpXSA9IGNoYW5uZWwuU2NhbGVGYWN0b3JzW2NvZGVkU2NhbGVGYWN0b3JDb3VudCAtIGldOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgc3RhdGljIFJlYWRJbnRlbnNpdHkocmVhZGVyLCBpbnRlbnNpdHksIHZlcnNpb25NYWpvcikgewogICAgICAgIGlmICh2ZXJzaW9uTWFqb3IgPD0gMikgewogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IEhDQUZyYW1lLlN1YmZyYW1lc1BlckZyYW1lOyBpKyspIHsKICAgICAgICAgICAgICAgIGludGVuc2l0eVtpXSA9IHJlYWRlci5SZWFkSW50KDQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICAvL2h0dHBzOi8vZ2l0aHViLmNvbS92Z21zdHJlYW0vdmdtc3RyZWFtL2Jsb2IvNGVlY2RhZGE5YTAzYTczYWYwYzdjMTdmNWNkNmUwODUxOGZkN2UzZi9zcmMvY29kaW5nL2hjYV9kZWNvZGVyX2NsaGNhLmMjTDEzNzQKICAgICAgICAgICAgbGV0IHZhbHVlID0gcmVhZGVyLlJlYWRJbnQoNCk7CiAgICAgICAgICAgIGxldCBkZWx0YV9iaXRzOwogICAgICAgICAgICBpZiAodmFsdWUgPCAxNSkgewogICAgICAgICAgICAgICAgZGVsdGFfYml0cyA9IHJlYWRlci5SZWFkSW50KDIpOyAvKiArMSAqLwogICAgICAgICAgICAgICAgaW50ZW5zaXR5WzBdID0gdmFsdWU7CiAgICAgICAgICAgICAgICBpZiAoZGVsdGFfYml0cyA9PSAzKSB7IC8qIDMrMSA9IDRiICovCiAgICAgICAgICAgICAgICAgICAgLyogZml4ZWQgaW50ZW5zaXRpZXMgKi8KICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IEhDQUZyYW1lLlN1YmZyYW1lc1BlckZyYW1lOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaW50ZW5zaXR5W2ldID0gcmVhZGVyLlJlYWRJbnQoNCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLyogZGVsdGEgaW50ZW5zaXRpZXMgKi8KICAgICAgICAgICAgICAgICAgICBsZXQgYm1heCA9ICgyIDw8IGRlbHRhX2JpdHMpIC0gMTsKICAgICAgICAgICAgICAgICAgICBsZXQgYml0cyA9IGRlbHRhX2JpdHMgKyAxOwogICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgSENBRnJhbWUuU3ViZnJhbWVzUGVyRnJhbWU7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBsZXQgZGVsdGEgPSByZWFkZXIuUmVhZEludChiaXRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRlbHRhID09IGJtYXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gcmVhZGVyLlJlYWRJbnQoNCk7IC8qIGVuY29kZWQgKi8KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUgLSAoYm1heCA+PiAxKSArIGRlbHRhOyAvKiBkaWZmZXJlbnRpYWwgKi8KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA+IDE1KSAvL3RvZG8gY2hlY2sKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHZhbHVlID4gMTVgKTsgLyogbm90IGRvbmUgaW4gbGliICovCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaW50ZW5zaXR5W2ldID0gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBIQ0FGcmFtZS5TdWJmcmFtZXNQZXJGcmFtZTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaW50ZW5zaXR5W2ldID0gNzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBSZWFkSGZyU2NhbGVGYWN0b3JzKHJlYWRlciwgZ3JvdXBDb3VudCwgaGZyU2NhbGUpIHsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGdyb3VwQ291bnQ7IGkrKykgewogICAgICAgICAgICBoZnJTY2FsZVtpXSA9IHJlYWRlci5SZWFkSW50KDYpOwogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBSZWFkU3BlY3RyYWxDb2VmZmljaWVudHMoZnJhbWUsIHJlYWRlcikgewogICAgICAgIGZvciAobGV0IHNmID0gMDsgc2YgPCBIQ0FGcmFtZS5TdWJmcmFtZXNQZXJGcmFtZTsgc2YrKykgewogICAgICAgICAgICBmb3IgKGxldCBjaGFubmVsIG9mIGZyYW1lLkNoYW5uZWxzKSB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBzID0gMDsgcyA8IGNoYW5uZWwuQ29kZWRTY2FsZUZhY3RvckNvdW50OyBzKyspIHsKICAgICAgICAgICAgICAgICAgICBsZXQgcmVzb2x1dGlvbiA9IGNoYW5uZWwuUmVzb2x1dGlvbltzXTsKICAgICAgICAgICAgICAgICAgICBsZXQgYml0cyA9IEhDQVRhYmxlcy5RdWFudGl6ZWRTcGVjdHJ1bU1heEJpdHNbcmVzb2x1dGlvbl07CiAgICAgICAgICAgICAgICAgICAgbGV0IGNvZGUgPSByZWFkZXIuUGVla0ludChiaXRzKTsKICAgICAgICAgICAgICAgICAgICBpZiAocmVzb2x1dGlvbiA8IDgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYml0cyA9IEhDQVRhYmxlcy5RdWFudGl6ZWRTcGVjdHJ1bUJpdHNbcmVzb2x1dGlvbl1bY29kZV07CiAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5uZWwuUXVhbnRpemVkU3BlY3RyYVtzZl1bc10gPSBIQ0FUYWJsZXMuUXVhbnRpemVkU3BlY3RydW1WYWx1ZVtyZXNvbHV0aW9uXVtjb2RlXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlYWQgdGhlIHNpZ24tbWFnbml0dWRlIHZhbHVlLiBUaGUgbG93IGJpdCBpcyB0aGUgc2lnbgogICAgICAgICAgICAgICAgICAgICAgICBsZXQgcXVhbnRpemVkQ29lZmZpY2llbnQgPSAoY29kZSA+PiAxKSAqICgxIC0gKGNvZGUgJSAyICogMikpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAocXVhbnRpemVkQ29lZmZpY2llbnQgPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYml0cy0tOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5uZWwuUXVhbnRpemVkU3BlY3RyYVtzZl1bc10gPSBxdWFudGl6ZWRDb2VmZmljaWVudDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmVhZGVyLlBvc2l0aW9uICs9IGJpdHM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjaGFubmVsLlNwZWN0cmFbc2ZdLmZpbGwoMCwgY2hhbm5lbC5Db2RlZFNjYWxlRmFjdG9yQ291bnQsIGNoYW5uZWwuQ29kZWRTY2FsZUZhY3RvckNvdW50ICsgMHg4MCAtIGNoYW5uZWwuQ29kZWRTY2FsZUZhY3RvckNvdW50KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBEZWx0YURlY29kZShyZWFkZXIsIGRlbHRhQml0cywgZGF0YUJpdHMsIGNvdW50LCBvdXRwdXQpIHsKICAgICAgICBvdXRwdXRbMF0gPSByZWFkZXIuUmVhZEludChkYXRhQml0cyk7CiAgICAgICAgbGV0IG1heERlbHRhID0gMSA8PCAoZGVsdGFCaXRzIC0gMSk7CiAgICAgICAgbGV0IG1heFZhbHVlID0gKDEgPDwgZGF0YUJpdHMpIC0gMTsKICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8IGNvdW50OyBpKyspIHsKICAgICAgICAgICAgbGV0IGRlbHRhID0gcmVhZGVyLlJlYWRPZmZzZXRCaW5hcnkoZGVsdGFCaXRzLCBIQ0FPZmZzZXRCaWFzLlBvc2l0aXZlKTsKICAgICAgICAgICAgaWYgKGRlbHRhIDwgbWF4RGVsdGEpIHsKICAgICAgICAgICAgICAgIGxldCB2YWx1ZSA9IG91dHB1dFtpIC0gMV0gKyBkZWx0YTsKICAgICAgICAgICAgICAgIGlmICh2YWx1ZSA8IDAgfHwgdmFsdWUgPiBtYXhWYWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS92Z21zdHJlYW0vdmdtc3RyZWFtL2Jsb2IvNGVlY2RhZGE5YTAzYTczYWYwYzdjMTdmNWNkNmUwODUxOGZkN2UzZi9zcmMvY29kaW5nL2hjYV9kZWNvZGVyX2NsaGNhLmMjTDEzMjcKICAgICAgICAgICAgICAgIC8vdmFsdWUgJj0gMHgzRjsgLy8gdjMuMCBsaWIKICAgICAgICAgICAgICAgIG91dHB1dFtpXSA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgb3V0cHV0W2ldID0gcmVhZGVyLlJlYWRJbnQoZGF0YUJpdHMpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgc3RhdGljIFVucGFja2luZ1dhc1N1Y2Nlc3NmdWwoZnJhbWUsIHJlYWRlcikgewogICAgICAgIC8vIDEyOCBsZWZ0b3ZlciBiaXRzIGFmdGVyIHVucGFja2luZyBzaG91bGQgYmUgaGlnaCBlbm91Z2ggdG8gZ2V0IHJpZCBvZiBmYWxzZSBuZWdhdGl2ZXMsCiAgICAgICAgLy8gYW5kIGxvdyBlbm91Z2ggdGhhdCBmYWxzZSBwb3NpdGl2ZXMgd2lsbCBiZSB1bmNvbW1vbi4KICAgICAgICByZXR1cm4gcmVhZGVyLlJlbWFpbmluZyA+PSAxNiAmJiByZWFkZXIuUmVtYWluaW5nIDw9IDEyOAogICAgICAgICAgICB8fCB0aGlzLkZyYW1lRW1wdHkoZnJhbWUpCiAgICAgICAgICAgIHx8IGZyYW1lLkFjY2VwdGFibGVOb2lzZUxldmVsID09IDAgJiYgcmVhZGVyLlJlbWFpbmluZyA+PSAxNjsKICAgIH0KICAgIHN0YXRpYyBGcmFtZUVtcHR5KGZyYW1lKSB7CiAgICAgICAgaWYgKGZyYW1lLkFjY2VwdGFibGVOb2lzZUxldmVsID4gMCkKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIC8vIElmIGFsbCB0aGUgc2NhbGUgZmFjdG9ycyBhcmUgMCwgdGhlIGZyYW1lIGlzIGVtcHR5CiAgICAgICAgZm9yIChsZXQgY2hhbm5lbCBvZiBmcmFtZS5DaGFubmVscykgewogICAgICAgICAgICBpZiAoY2hhbm5lbC5TY2FsZUZhY3RvckRlbHRhQml0cyA+IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHN0YXRpYyBXcml0ZUNoZWNrc3VtKHdyaXRlciwgaGNhQnVmZmVyKSB7CiAgICAgICAgd3JpdGVyLlBvc2l0aW9uID0gd3JpdGVyLkxlbmd0aEJpdHMgLSAxNjsKICAgICAgICBsZXQgY3JjMTYgPSBIQ0FDcmMxNi5jYWxjKGhjYUJ1ZmZlciwgaGNhQnVmZmVyLmxlbmd0aCAtIDIpOwogICAgICAgIHdyaXRlci5Xcml0ZShjcmMxNiwgMTYpOwogICAgfQogICAgc3RhdGljIFdyaXRlU3BlY3RyYSh3cml0ZXIsIGNoYW5uZWwsIHN1YkZyYW1lKSB7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGFubmVsLkNvZGVkU2NhbGVGYWN0b3JDb3VudDsgaSsrKSB7CiAgICAgICAgICAgIGxldCByZXNvbHV0aW9uID0gY2hhbm5lbC5SZXNvbHV0aW9uW2ldOwogICAgICAgICAgICBsZXQgcXVhbnRpemVkU3BlY3RyYSA9IGNoYW5uZWwuUXVhbnRpemVkU3BlY3RyYVtzdWJGcmFtZV1baV07CiAgICAgICAgICAgIGlmIChyZXNvbHV0aW9uID09IDApCiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgaWYgKHJlc29sdXRpb24gPCA4KSB7CiAgICAgICAgICAgICAgICBsZXQgYml0cyA9IEhDQVRhYmxlcy5RdWFudGl6ZVNwZWN0cnVtQml0c1tyZXNvbHV0aW9uXVtxdWFudGl6ZWRTcGVjdHJhICsgOF07CiAgICAgICAgICAgICAgICB3cml0ZXIuV3JpdGUoSENBVGFibGVzLlF1YW50aXplU3BlY3RydW1WYWx1ZVtyZXNvbHV0aW9uXVtxdWFudGl6ZWRTcGVjdHJhICsgOF0sIGJpdHMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKHJlc29sdXRpb24gPCAxNikgewogICAgICAgICAgICAgICAgbGV0IGJpdHMgPSBIQ0FUYWJsZXMuUXVhbnRpemVkU3BlY3RydW1NYXhCaXRzW3Jlc29sdXRpb25dIC0gMTsKICAgICAgICAgICAgICAgIHdyaXRlci5Xcml0ZShNYXRoLmFicyhxdWFudGl6ZWRTcGVjdHJhKSwgYml0cyk7CiAgICAgICAgICAgICAgICBpZiAocXVhbnRpemVkU3BlY3RyYSAhPSAwKSB7CiAgICAgICAgICAgICAgICAgICAgd3JpdGVyLldyaXRlKHF1YW50aXplZFNwZWN0cmEgPiAwID8gMCA6IDEsIDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIFdyaXRlU2NhbGVGYWN0b3JzKHdyaXRlciwgY2hhbm5lbCkgewogICAgICAgIGxldCBkZWx0YUJpdHMgPSBjaGFubmVsLlNjYWxlRmFjdG9yRGVsdGFCaXRzOwogICAgICAgIGxldCBzY2FsZXMgPSBjaGFubmVsLlNjYWxlRmFjdG9yczsKICAgICAgICB3cml0ZXIuV3JpdGUoZGVsdGFCaXRzLCAzKTsKICAgICAgICBpZiAoZGVsdGFCaXRzID09IDApCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICBpZiAoZGVsdGFCaXRzID09IDYpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGFubmVsLkNvZGVkU2NhbGVGYWN0b3JDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICB3cml0ZXIuV3JpdGUoc2NhbGVzW2ldLCA2KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHdyaXRlci5Xcml0ZShzY2FsZXNbMF0sIDYpOwogICAgICAgIGxldCBtYXhEZWx0YSA9ICgxIDw8IChkZWx0YUJpdHMgLSAxKSkgLSAxOwogICAgICAgIGxldCBlc2NhcGVWYWx1ZSA9ICgxIDw8IGRlbHRhQml0cykgLSAxOwogICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgY2hhbm5lbC5Db2RlZFNjYWxlRmFjdG9yQ291bnQ7IGkrKykgewogICAgICAgICAgICBsZXQgZGVsdGEgPSBzY2FsZXNbaV0gLSBzY2FsZXNbaSAtIDFdOwogICAgICAgICAgICBpZiAoTWF0aC5hYnMoZGVsdGEpID4gbWF4RGVsdGEpIHsKICAgICAgICAgICAgICAgIHdyaXRlci5Xcml0ZShlc2NhcGVWYWx1ZSwgZGVsdGFCaXRzKTsKICAgICAgICAgICAgICAgIHdyaXRlci5Xcml0ZShzY2FsZXNbaV0sIDYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgd3JpdGVyLldyaXRlKG1heERlbHRhICsgZGVsdGEsIGRlbHRhQml0cyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KY2xhc3MgSENBTWRjdCB7CiAgICBjb25zdHJ1Y3RvcihtZGN0Qml0cywgd2luZG93LCBzY2FsZSA9IDEpIHsKICAgICAgICBIQ0FNZGN0LlNldFRhYmxlcyhtZGN0Qml0cyk7CiAgICAgICAgdGhpcy5NZGN0Qml0cyA9IG1kY3RCaXRzOwogICAgICAgIHRoaXMuTWRjdFNpemUgPSAxIDw8IG1kY3RCaXRzOwogICAgICAgIHRoaXMuU2NhbGUgPSBzY2FsZTsKICAgICAgICBpZiAod2luZG93Lmxlbmd0aCA8IHRoaXMuTWRjdFNpemUpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJXaW5kb3cgbXVzdCBiZSBhcyBsb25nIGFzIHRoZSBNRENUIHNpemUuIik7CiAgICAgICAgfQogICAgICAgIHRoaXMuX21kY3RQcmV2aW91cyA9IG5ldyBGbG9hdDY0QXJyYXkodGhpcy5NZGN0U2l6ZSk7CiAgICAgICAgdGhpcy5faW1kY3RQcmV2aW91cyA9IG5ldyBGbG9hdDY0QXJyYXkodGhpcy5NZGN0U2l6ZSk7CiAgICAgICAgdGhpcy5fc2NyYXRjaE1kY3QgPSBuZXcgRmxvYXQ2NEFycmF5KHRoaXMuTWRjdFNpemUpOwogICAgICAgIHRoaXMuX3NjcmF0Y2hEY3QgPSBuZXcgRmxvYXQ2NEFycmF5KHRoaXMuTWRjdFNpemUpOwogICAgICAgIHRoaXMuX2ltZGN0V2luZG93ID0gd2luZG93OwogICAgfQogICAgc3RhdGljIFNldFRhYmxlcyhtYXhCaXRzKSB7CiAgICAgICAgaWYgKG1heEJpdHMgPiB0aGlzLl90YWJsZUJpdHMpIHsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMuX3RhYmxlQml0cyArIDE7IGkgPD0gbWF4Qml0czsgaSsrKSB7CiAgICAgICAgICAgICAgICBsZXQgb3V0ID0gdGhpcy5HZW5lcmF0ZVRyaWdUYWJsZXMoaSk7CiAgICAgICAgICAgICAgICB0aGlzLlNpblRhYmxlcy5wdXNoKG91dC5zaW4pOwogICAgICAgICAgICAgICAgdGhpcy5Db3NUYWJsZXMucHVzaChvdXQuY29zKTsKICAgICAgICAgICAgICAgIHRoaXMuU2h1ZmZsZVRhYmxlcy5wdXNoKHRoaXMuR2VuZXJhdGVTaHVmZmxlVGFibGUoaSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX3RhYmxlQml0cyA9IG1heEJpdHM7CiAgICAgICAgfQogICAgfQogICAgUnVuTWRjdChpbnB1dCwgb3V0cHV0KSB7CiAgICAgICAgaWYgKGlucHV0Lmxlbmd0aCA8IHRoaXMuTWRjdFNpemUpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnB1dCBtdXN0IGJlIGFzIGxvbmcgYXMgdGhlIE1EQ1Qgc2l6ZS4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKG91dHB1dC5sZW5ndGggPCB0aGlzLk1kY3RTaXplKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiT3V0cHV0IG11c3QgYmUgYXMgbG9uZyBhcyB0aGUgTURDVCBzaXplLiIpOwogICAgICAgIH0KICAgICAgICBsZXQgc2l6ZSA9IHRoaXMuTWRjdFNpemU7CiAgICAgICAgbGV0IGhhbGYgPSAoc2l6ZSA+PiAxKTsKICAgICAgICBsZXQgZGN0SW4gPSB0aGlzLl9zY3JhdGNoTWRjdDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGhhbGY7IGkrKykgewogICAgICAgICAgICBsZXQgYSA9IHRoaXMuX2ltZGN0V2luZG93W2hhbGYgLSBpIC0gMV0gKiAtaW5wdXRbaGFsZiArIGldOwogICAgICAgICAgICBsZXQgYiA9IHRoaXMuX2ltZGN0V2luZG93W2hhbGYgKyBpXSAqIGlucHV0W2hhbGYgLSBpIC0gMV07CiAgICAgICAgICAgIGxldCBjID0gdGhpcy5faW1kY3RXaW5kb3dbaV0gKiB0aGlzLl9tZGN0UHJldmlvdXNbaV07CiAgICAgICAgICAgIGxldCBkID0gdGhpcy5faW1kY3RXaW5kb3dbc2l6ZSAtIGkgLSAxXSAqIHRoaXMuX21kY3RQcmV2aW91c1tzaXplIC0gaSAtIDFdOwogICAgICAgICAgICBkY3RJbltpXSA9IGEgLSBiOwogICAgICAgICAgICBkY3RJbltoYWxmICsgaV0gPSBjIC0gZDsKICAgICAgICB9CiAgICAgICAgdGhpcy5EY3Q0KGRjdEluLCBvdXRwdXQpOwogICAgICAgIHRoaXMuX21kY3RQcmV2aW91cy5zZXQoaW5wdXQsIGlucHV0Lmxlbmd0aCk7CiAgICB9CiAgICBSdW5JbWRjdChpbnB1dCwgb3V0cHV0KSB7CiAgICAgICAgaWYgKGlucHV0Lmxlbmd0aCA8IHRoaXMuTWRjdFNpemUpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnB1dCBtdXN0IGJlIGFzIGxvbmcgYXMgdGhlIE1EQ1Qgc2l6ZS4iKTsKICAgICAgICB9CiAgICAgICAgaWYgKG91dHB1dC5sZW5ndGggPCB0aGlzLk1kY3RTaXplKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiT3V0cHV0IG11c3QgYmUgYXMgbG9uZyBhcyB0aGUgTURDVCBzaXplLiIpOwogICAgICAgIH0KICAgICAgICBsZXQgc2l6ZSA9IHRoaXMuTWRjdFNpemU7CiAgICAgICAgbGV0IGhhbGYgPSAoc2l6ZSA+PiAxKTsKICAgICAgICBsZXQgZGN0T3V0ID0gdGhpcy5fc2NyYXRjaE1kY3Q7CiAgICAgICAgdGhpcy5EY3Q0KGlucHV0LCBkY3RPdXQpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaGFsZjsgaSsrKSB7CiAgICAgICAgICAgIG91dHB1dFtpXSA9IHRoaXMuX2ltZGN0V2luZG93W2ldICogZGN0T3V0W2kgKyBoYWxmXSArIHRoaXMuX2ltZGN0UHJldmlvdXNbaV07CiAgICAgICAgICAgIG91dHB1dFtpICsgaGFsZl0gPSB0aGlzLl9pbWRjdFdpbmRvd1tpICsgaGFsZl0gKiAtZGN0T3V0W3NpemUgLSAxIC0gaV0gLSB0aGlzLl9pbWRjdFByZXZpb3VzW2kgKyBoYWxmXTsKICAgICAgICAgICAgdGhpcy5faW1kY3RQcmV2aW91c1tpXSA9IHRoaXMuX2ltZGN0V2luZG93W3NpemUgLSAxIC0gaV0gKiAtZGN0T3V0W2hhbGYgLSBpIC0gMV07CiAgICAgICAgICAgIHRoaXMuX2ltZGN0UHJldmlvdXNbaSArIGhhbGZdID0gdGhpcy5faW1kY3RXaW5kb3dbaGFsZiAtIGkgLSAxXSAqIGRjdE91dFtpXTsKICAgICAgICB9CiAgICB9CiAgICAvLy8gPHN1bW1hcnk+CiAgICAvLy8gRG9lcyBhIFR5cGUtNCBEQ1QuCiAgICAvLy8gPC9zdW1tYXJ5PgogICAgLy8vIDxwYXJhbSBuYW1lPSJpbnB1dCI+VGhlIGlucHV0IGFycmF5IGNvbnRhaW5pbmcgdGhlIHRpbWUgb3IgZnJlcXVlbmN5LWRvbWFpbiBzYW1wbGVzPC9wYXJhbT4KICAgIC8vLyA8cGFyYW0gbmFtZT0ib3V0cHV0Ij5UaGUgb3V0cHV0IGFycmF5IHRoYXQgd2lsbCBjb250YWluIHRoZSB0cmFuc2Zvcm1lZCB0aW1lIG9yIGZyZXF1ZW5jeS1kb21haW4gc2FtcGxlczwvcGFyYW0+CiAgICBEY3Q0KGlucHV0LCBvdXRwdXQpIHsKICAgICAgICBsZXQgc2h1ZmZsZVRhYmxlID0gSENBTWRjdC5TaHVmZmxlVGFibGVzW3RoaXMuTWRjdEJpdHNdOwogICAgICAgIGxldCBzaW5UYWJsZSA9IEhDQU1kY3QuU2luVGFibGVzW3RoaXMuTWRjdEJpdHNdOwogICAgICAgIGxldCBjb3NUYWJsZSA9IEhDQU1kY3QuQ29zVGFibGVzW3RoaXMuTWRjdEJpdHNdOwogICAgICAgIGxldCBkY3RUZW1wID0gdGhpcy5fc2NyYXRjaERjdDsKICAgICAgICBsZXQgc2l6ZSA9IHRoaXMuTWRjdFNpemU7CiAgICAgICAgbGV0IGxhc3RJbmRleCA9IHNpemUgLSAxOwogICAgICAgIGxldCBoYWxmU2l6ZSA9IChzaXplID4+IDEpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaGFsZlNpemU7IGkrKykgewogICAgICAgICAgICBsZXQgaTIgPSBpICogMjsKICAgICAgICAgICAgbGV0IGEgPSBpbnB1dFtpMl07CiAgICAgICAgICAgIGxldCBiID0gaW5wdXRbbGFzdEluZGV4IC0gaTJdOwogICAgICAgICAgICBsZXQgc2luID0gc2luVGFibGVbaV07CiAgICAgICAgICAgIGxldCBjb3MgPSBjb3NUYWJsZVtpXTsKICAgICAgICAgICAgZGN0VGVtcFtpMl0gPSBhICogY29zICsgYiAqIHNpbjsKICAgICAgICAgICAgZGN0VGVtcFtpMiArIDFdID0gYSAqIHNpbiAtIGIgKiBjb3M7CiAgICAgICAgfQogICAgICAgIGxldCBzdGFnZUNvdW50ID0gdGhpcy5NZGN0Qml0cyAtIDE7CiAgICAgICAgZm9yIChsZXQgc3RhZ2UgPSAwOyBzdGFnZSA8IHN0YWdlQ291bnQ7IHN0YWdlKyspIHsKICAgICAgICAgICAgbGV0IGJsb2NrQ291bnQgPSAxIDw8IHN0YWdlOwogICAgICAgICAgICBsZXQgYmxvY2tTaXplQml0cyA9IHN0YWdlQ291bnQgLSBzdGFnZTsKICAgICAgICAgICAgbGV0IGJsb2NrSGFsZlNpemVCaXRzID0gYmxvY2tTaXplQml0cyAtIDE7CiAgICAgICAgICAgIGxldCBibG9ja1NpemUgPSAxIDw8IGJsb2NrU2l6ZUJpdHM7CiAgICAgICAgICAgIGxldCBibG9ja0hhbGZTaXplID0gMSA8PCBibG9ja0hhbGZTaXplQml0czsKICAgICAgICAgICAgc2luVGFibGUgPSBIQ0FNZGN0LlNpblRhYmxlc1tibG9ja0hhbGZTaXplQml0c107CiAgICAgICAgICAgIGNvc1RhYmxlID0gSENBTWRjdC5Db3NUYWJsZXNbYmxvY2tIYWxmU2l6ZUJpdHNdOwogICAgICAgICAgICBmb3IgKGxldCBibG9jayA9IDA7IGJsb2NrIDwgYmxvY2tDb3VudDsgYmxvY2srKykgewogICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBibG9ja0hhbGZTaXplOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBsZXQgZnJvbnRQb3MgPSAoYmxvY2sgKiBibG9ja1NpemUgKyBpKSAqIDI7CiAgICAgICAgICAgICAgICAgICAgbGV0IGJhY2tQb3MgPSBmcm9udFBvcyArIGJsb2NrU2l6ZTsKICAgICAgICAgICAgICAgICAgICBsZXQgYSA9IGRjdFRlbXBbZnJvbnRQb3NdIC0gZGN0VGVtcFtiYWNrUG9zXTsKICAgICAgICAgICAgICAgICAgICBsZXQgYiA9IGRjdFRlbXBbZnJvbnRQb3MgKyAxXSAtIGRjdFRlbXBbYmFja1BvcyArIDFdOwogICAgICAgICAgICAgICAgICAgIGxldCBzaW4gPSBzaW5UYWJsZVtpXTsKICAgICAgICAgICAgICAgICAgICBsZXQgY29zID0gY29zVGFibGVbaV07CiAgICAgICAgICAgICAgICAgICAgZGN0VGVtcFtmcm9udFBvc10gKz0gZGN0VGVtcFtiYWNrUG9zXTsKICAgICAgICAgICAgICAgICAgICBkY3RUZW1wW2Zyb250UG9zICsgMV0gKz0gZGN0VGVtcFtiYWNrUG9zICsgMV07CiAgICAgICAgICAgICAgICAgICAgZGN0VGVtcFtiYWNrUG9zXSA9IGEgKiBjb3MgKyBiICogc2luOwogICAgICAgICAgICAgICAgICAgIGRjdFRlbXBbYmFja1BvcyArIDFdID0gYSAqIHNpbiAtIGIgKiBjb3M7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLk1kY3RTaXplOyBpKyspIHsKICAgICAgICAgICAgb3V0cHV0W2ldID0gZGN0VGVtcFtzaHVmZmxlVGFibGVbaV1dICogdGhpcy5TY2FsZTsKICAgICAgICB9CiAgICB9CiAgICBzdGF0aWMgR2VuZXJhdGVUcmlnVGFibGVzKHNpemVCaXRzKSB7CiAgICAgICAgbGV0IHNpemUgPSAxIDw8IHNpemVCaXRzOwogICAgICAgIGxldCBvdXQgPSB7CiAgICAgICAgICAgIHNpbjogbmV3IEZsb2F0NjRBcnJheShzaXplKSwKICAgICAgICAgICAgY29zOiBuZXcgRmxvYXQ2NEFycmF5KHNpemUpCiAgICAgICAgfTsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNpemU7IGkrKykgewogICAgICAgICAgICBsZXQgdmFsdWUgPSBNYXRoLlBJICogKDQgKiBpICsgMSkgLyAoNCAqIHNpemUpOwogICAgICAgICAgICBvdXQuc2luW2ldID0gTWF0aC5zaW4odmFsdWUpOwogICAgICAgICAgICBvdXQuY29zW2ldID0gTWF0aC5jb3ModmFsdWUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gb3V0OwogICAgfQogICAgc3RhdGljIEdlbmVyYXRlU2h1ZmZsZVRhYmxlKHNpemVCaXRzKSB7CiAgICAgICAgbGV0IHNpemUgPSAxIDw8IHNpemVCaXRzOwogICAgICAgIHZhciB0YWJsZSA9IG5ldyBJbnQzMkFycmF5KHNpemUpOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2l6ZTsgaSsrKSB7CiAgICAgICAgICAgIHRhYmxlW2ldID0gSENBVXRpbEZ1bmMuU2lnbmVkQml0UmV2ZXJzZTMyVHJ1bmMoaSBeIChpID4+IDEpLCBzaXplQml0cyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0YWJsZTsKICAgIH0KICAgIC8vIFJlU2hhcnBlciBkaXNhYmxlIG9uY2UgVW51c2VkTWVtYmVyLkxvY2FsCiAgICAvLy8gPHN1bW1hcnk+CiAgICAvLy8gRG9lcyBhIFR5cGUtNCBEQ1QuIEludGVuZGVkIGZvciByZWZlcmVuY2UuCiAgICAvLy8gPC9zdW1tYXJ5PgogICAgLy8vIDxwYXJhbSBuYW1lPSJpbnB1dCI+VGhlIGlucHV0IGFycmF5IGNvbnRhaW5pbmcgdGhlIHRpbWUgb3IgZnJlcXVlbmN5LWRvbWFpbiBzYW1wbGVzPC9wYXJhbT4KICAgIC8vLyA8cGFyYW0gbmFtZT0ib3V0cHV0Ij5UaGUgb3V0cHV0IGFycmF5IHRoYXQgd2lsbCBjb250YWluIHRoZSB0cmFuc2Zvcm1lZCB0aW1lIG9yIGZyZXF1ZW5jeS1kb21haW4gc2FtcGxlczwvcGFyYW0+CiAgICBEY3Q0U2xvdyhpbnB1dCwgb3V0cHV0KSB7CiAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCB0aGlzLk1kY3RTaXplOyBrKyspIHsKICAgICAgICAgICAgbGV0IHNhbXBsZSA9IDA7CiAgICAgICAgICAgIGZvciAobGV0IG4gPSAwOyBuIDwgdGhpcy5NZGN0U2l6ZTsgbisrKSB7CiAgICAgICAgICAgICAgICBsZXQgYW5nbGUgPSBNYXRoLlBJIC8gdGhpcy5NZGN0U2l6ZSAqIChrICsgMC41KSAqIChuICsgMC41KTsKICAgICAgICAgICAgICAgIHNhbXBsZSArPSBNYXRoLmNvcyhhbmdsZSkgKiBpbnB1dFtuXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBvdXRwdXRba10gPSBzYW1wbGUgKiB0aGlzLlNjYWxlOwogICAgICAgIH0KICAgIH0KfQpIQ0FNZGN0Ll90YWJsZUJpdHMgPSAtMTsKSENBTWRjdC5TaW5UYWJsZXMgPSBbXTsKSENBTWRjdC5Db3NUYWJsZXMgPSBbXTsKSENBTWRjdC5TaHVmZmxlVGFibGVzID0gW107CmNsYXNzIEhDQVRhYmxlcyB7CiAgICBzdGF0aWMgaXNMaXR0bGVFbmRpYW4oKSB7CiAgICAgICAgbGV0IHRlc3QgPSBuZXcgRmxvYXQ2NEFycmF5KFsxLjBdKTsKICAgICAgICBsZXQgZHYgPSBuZXcgRGF0YVZpZXcodGVzdC5idWZmZXIpOwogICAgICAgIGlmIChkdi5nZXRVaW50MzIoMCkgIT0gMCkKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgc3RhdGljIGFkYXB0RW5kaWFubmVzczY0MzIoYSkgewogICAgICAgIGlmIChhLmJ5dGVMZW5ndGggJSA4ICE9IDApCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgIGlmICghdGhpcy5pc0xpdHRsZUVuZGlhbigpKSB7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYS5sZW5ndGg7IGkgKz0gMikgewogICAgICAgICAgICAgICAgbGV0IHRlbXAgPSBhW2ldOwogICAgICAgICAgICAgICAgYVtpXSA9IGFbaSArIDFdOwogICAgICAgICAgICAgICAgYVtpICsgMV0gPSB0ZW1wOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBhOwogICAgfQp9Cl9iID0gSENBVGFibGVzOwpIQ0FUYWJsZXMuUXVhbnRpemVTcGVjdHJ1bUJpdHMgPSBbCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMiwgMHgwMSwgMHgwMiwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMywgMHgwMiwgMHgwMiwgMHgwMiwgMHgwMywgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMywgMHgwMywgMHgwMywgMHgwMiwgMHgwMywgMHgwMywgMHgwMywgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwNCwgMHgwMywgMHgwMywgMHgwMywgMHgwMywgMHgwMywgMHgwMywgMHgwMywgMHgwNCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwMywgMHgwMywgMHgwMywgMHgwMywgMHgwMywgMHgwNCwgMHgwNCwgMHgwNCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwMywgMHgwMywgMHgwMywgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwMywgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNAogICAgXSksCl07CkhDQVRhYmxlcy5RdWFudGl6ZVNwZWN0cnVtVmFsdWUgPSBbCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMywgMHgwMCwgMHgwMiwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwNywgMHgwMiwgMHgwMCwgMHgwMSwgMHgwNiwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwNywgMHgwNSwgMHgwMywgMHgwMCwgMHgwMiwgMHgwNCwgMHgwNiwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwRiwgMHgwNiwgMHgwNCwgMHgwMiwgMHgwMCwgMHgwMSwgMHgwMywgMHgwNSwgMHgwRSwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwRiwgMHgwRCwgMHgwQiwgMHgwNCwgMHgwMiwgMHgwMCwgMHgwMSwgMHgwMywgMHgwQSwgMHgwQywgMHgwRSwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwRiwgMHgwRCwgMHgwQiwgMHgwOSwgMHgwNywgMHgwMiwgMHgwMCwgMHgwMSwgMHgwNiwgMHgwOCwgMHgwQSwgMHgwQywgMHgwRSwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwRiwgMHgwRCwgMHgwQiwgMHgwOSwgMHgwNywgMHgwNSwgMHgwMywgMHgwMCwgMHgwMiwgMHgwNCwgMHgwNiwgMHgwOCwgMHgwQSwgMHgwQywgMHgwRQogICAgXSksCl07CkhDQVRhYmxlcy5RdWFudGl6ZWRTcGVjdHJ1bUJpdHMgPSBbCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMSwgMHgwMSwgMHgwMiwgMHgwMiwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMiwgMHgwMiwgMHgwMiwgMHgwMiwgMHgwMiwgMHgwMiwgMHgwMywgMHgwMywgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMiwgMHgwMiwgMHgwMywgMHgwMywgMHgwMywgMHgwMywgMHgwMywgMHgwMywgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMywgMHgwMywgMHgwMywgMHgwMywgMHgwMywgMHgwMywgMHgwMywgMHgwMywgMHgwMywgMHgwMywgMHgwMywgMHgwMywgMHgwMywgMHgwMywgMHgwNCwgMHgwNAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMywgMHgwMywgMHgwMywgMHgwMywgMHgwMywgMHgwMywgMHgwMywgMHgwMywgMHgwMywgMHgwMywgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMywgMHgwMywgMHgwMywgMHgwMywgMHgwMywgMHgwMywgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMywgMHgwMywgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNCwgMHgwNAogICAgXSksCl07CkhDQVRhYmxlcy5RdWFudGl6ZWRTcGVjdHJ1bU1heEJpdHMgPSBuZXcgVWludDhBcnJheShbCiAgICAweDAwLCAweDAyLCAweDAzLCAweDAzLCAweDA0LCAweDA0LCAweDA0LCAweDA0LCAweDA1LCAweDA2LCAweDA3LCAweDA4LCAweDA5LCAweDBBLCAweDBCLCAweDBDCl0pOwpIQ0FUYWJsZXMuUXVhbnRpemVkU3BlY3RydW1WYWx1ZSA9IFsKICAgIG5ldyBJbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IEludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMSwgMHhGRiwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgSW50OEFycmF5KFsKICAgICAgICAweDAwLCAweDAwLCAweDAxLCAweDAxLCAweEZGLCAweEZGLCAweDAyLCAweEZFLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwLCAweDAwCiAgICBdKSwKICAgIG5ldyBJbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDEsIDB4RkYsIDB4MDIsIDB4RkUsIDB4MDMsIDB4RkQsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAsIDB4MDAKICAgIF0pLAogICAgbmV3IEludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMSwgMHgwMSwgMHhGRiwgMHhGRiwgMHgwMiwgMHgwMiwgMHhGRSwgMHhGRSwgMHgwMywgMHgwMywgMHhGRCwgMHhGRCwgMHgwNCwgMHhGQwogICAgXSksCiAgICBuZXcgSW50OEFycmF5KFsKICAgICAgICAweDAwLCAweDAwLCAweDAxLCAweDAxLCAweEZGLCAweEZGLCAweDAyLCAweDAyLCAweEZFLCAweEZFLCAweDAzLCAweEZELCAweDA0LCAweEZDLCAweDA1LCAweEZCCiAgICBdKSwKICAgIG5ldyBJbnQ4QXJyYXkoWwogICAgICAgIDB4MDAsIDB4MDAsIDB4MDEsIDB4MDEsIDB4RkYsIDB4RkYsIDB4MDIsIDB4RkUsIDB4MDMsIDB4RkQsIDB4MDQsIDB4RkMsIDB4MDUsIDB4RkIsIDB4MDYsIDB4RkEKICAgIF0pLAogICAgbmV3IEludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMSwgMHhGRiwgMHgwMiwgMHhGRSwgMHgwMywgMHhGRCwgMHgwNCwgMHhGQywgMHgwNSwgMHhGQiwgMHgwNiwgMHhGQSwgMHgwNywgMHhGOQogICAgXSksCl07CkhDQVRhYmxlcy5TY2FsZVRvUmVzb2x1dGlvbkN1cnZlID0gbmV3IFVpbnQ4QXJyYXkoWwogICAgMHgwRiwgMHgwRSwgMHgwRSwgMHgwRSwgMHgwRSwgMHgwRSwgMHgwRSwgMHgwRCwgMHgwRCwgMHgwRCwgMHgwRCwgMHgwRCwgMHgwRCwgMHgwQywgMHgwQywgMHgwQywKICAgIDB4MEMsIDB4MEMsIDB4MEMsIDB4MEIsIDB4MEIsIDB4MEIsIDB4MEIsIDB4MEIsIDB4MEIsIDB4MEEsIDB4MEEsIDB4MEEsIDB4MEEsIDB4MEEsIDB4MEEsIDB4MEEsCiAgICAweDA5LCAweDA5LCAweDA5LCAweDA5LCAweDA5LCAweDA5LCAweDA4LCAweDA4LCAweDA4LCAweDA4LCAweDA4LCAweDA4LCAweDA3LCAweDA2LCAweDA2LCAweDA1LAogICAgMHgwNCwgMHgwNCwgMHgwNCwgMHgwMywgMHgwMywgMHgwMywgMHgwMiwgMHgwMiwgMHgwMiwgMHgwMiwgMHgwMSwgMHgwMSwgMHgwMSwgMHgwMSwgMHgwMSwgMHgwMSwKICAgIDB4MDEsIDB4MDEsIDB4MDEsIDB4MDAKXSk7CkhDQVRhYmxlcy5BdGhDdXJ2ZSA9IG5ldyBVaW50OEFycmF5KFsKICAgIDB4NzgsIDB4NUYsIDB4NTYsIDB4NTEsIDB4NEUsIDB4NEMsIDB4NEIsIDB4NDksIDB4NDgsIDB4NDgsIDB4NDcsIDB4NDYsIDB4NDYsIDB4NDUsIDB4NDUsIDB4NDUsCiAgICAweDQ0LCAweDQ0LCAweDQ0LCAweDQ0LCAweDQzLCAweDQzLCAweDQzLCAweDQzLCAweDQzLCAweDQzLCAweDQyLCAweDQyLCAweDQyLCAweDQyLCAweDQyLCAweDQyLAogICAgMHg0MiwgMHg0MiwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwKICAgIDB4NDAsIDB4NDAsIDB4NDAsIDB4NDAsIDB4NDAsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsCiAgICAweDNGLCAweDNGLCAweDNGLCAweDNFLCAweDNFLCAweDNFLCAweDNFLCAweDNFLCAweDNFLCAweDNELCAweDNELCAweDNELCAweDNELCAweDNELCAweDNELCAweDNELAogICAgMHgzQywgMHgzQywgMHgzQywgMHgzQywgMHgzQywgMHgzQywgMHgzQywgMHgzQywgMHgzQiwgMHgzQiwgMHgzQiwgMHgzQiwgMHgzQiwgMHgzQiwgMHgzQiwgMHgzQiwKICAgIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsIDB4M0IsCiAgICAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNCLCAweDNDLCAweDNDLCAweDNDLCAweDNDLCAweDNDLCAweDNDLCAweDNDLCAweDNDLAogICAgMHgzRCwgMHgzRCwgMHgzRCwgMHgzRCwgMHgzRCwgMHgzRCwgMHgzRCwgMHgzRCwgMHgzRSwgMHgzRSwgMHgzRSwgMHgzRSwgMHgzRSwgMHgzRSwgMHgzRSwgMHgzRiwKICAgIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsIDB4M0YsCiAgICAweDNGLCAweDNGLCAweDNGLCAweDNGLCAweDQwLCAweDQwLCAweDQwLCAweDQwLCAweDQwLCAweDQwLCAweDQwLCAweDQwLCAweDQwLCAweDQwLCAweDQwLCAweDQwLAogICAgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MCwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwgMHg0MSwKICAgIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsIDB4NDEsCiAgICAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQxLCAweDQyLCAweDQyLCAweDQyLCAweDQyLCAweDQyLCAweDQyLCAweDQyLCAweDQyLCAweDQyLAogICAgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MiwgMHg0MywgMHg0MywgMHg0MywKICAgIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDMsIDB4NDQsIDB4NDQsCiAgICAweDQ0LCAweDQ0LCAweDQ0LCAweDQ0LCAweDQ0LCAweDQ0LCAweDQ0LCAweDQ0LCAweDQ0LCAweDQ0LCAweDQ0LCAweDQ0LCAweDQ1LCAweDQ1LCAweDQ1LCAweDQ1LAogICAgMHg0NSwgMHg0NSwgMHg0NSwgMHg0NSwgMHg0NSwgMHg0NSwgMHg0NSwgMHg0NSwgMHg0NiwgMHg0NiwgMHg0NiwgMHg0NiwgMHg0NiwgMHg0NiwgMHg0NiwgMHg0NiwKICAgIDB4NDYsIDB4NDYsIDB4NDcsIDB4NDcsIDB4NDcsIDB4NDcsIDB4NDcsIDB4NDcsIDB4NDcsIDB4NDcsIDB4NDcsIDB4NDcsIDB4NDgsIDB4NDgsIDB4NDgsIDB4NDgsCiAgICAweDQ4LCAweDQ4LCAweDQ4LCAweDQ4LCAweDQ5LCAweDQ5LCAweDQ5LCAweDQ5LCAweDQ5LCAweDQ5LCAweDQ5LCAweDQ5LCAweDRBLCAweDRBLCAweDRBLCAweDRBLAogICAgMHg0QSwgMHg0QSwgMHg0QSwgMHg0QSwgMHg0QiwgMHg0QiwgMHg0QiwgMHg0QiwgMHg0QiwgMHg0QiwgMHg0QiwgMHg0QywgMHg0QywgMHg0QywgMHg0QywgMHg0QywKICAgIDB4NEMsIDB4NEQsIDB4NEQsIDB4NEQsIDB4NEQsIDB4NEQsIDB4NEQsIDB4NEUsIDB4NEUsIDB4NEUsIDB4NEUsIDB4NEUsIDB4NEUsIDB4NEYsIDB4NEYsIDB4NEYsCiAgICAweDRGLCAweDRGLCAweDRGLCAweDUwLCAweDUwLCAweDUwLCAweDUwLCAweDUwLCAweDUxLCAweDUxLCAweDUxLCAweDUxLCAweDUxLCAweDUyLCAweDUyLCAweDUyLAogICAgMHg1MiwgMHg1MiwgMHg1MywgMHg1MywgMHg1MywgMHg1MywgMHg1NCwgMHg1NCwgMHg1NCwgMHg1NCwgMHg1NCwgMHg1NSwgMHg1NSwgMHg1NSwgMHg1NSwgMHg1NiwKICAgIDB4NTYsIDB4NTYsIDB4NTYsIDB4NTcsIDB4NTcsIDB4NTcsIDB4NTcsIDB4NTcsIDB4NTgsIDB4NTgsIDB4NTgsIDB4NTksIDB4NTksIDB4NTksIDB4NTksIDB4NUEsCiAgICAweDVBLCAweDVBLCAweDVBLCAweDVCLCAweDVCLCAweDVCLCAweDVCLCAweDVDLCAweDVDLCAweDVDLCAweDVELCAweDVELCAweDVELCAweDVELCAweDVFLCAweDVFLAogICAgMHg1RSwgMHg1RiwgMHg1RiwgMHg1RiwgMHg2MCwgMHg2MCwgMHg2MCwgMHg2MSwgMHg2MSwgMHg2MSwgMHg2MSwgMHg2MiwgMHg2MiwgMHg2MiwgMHg2MywgMHg2MywKICAgIDB4NjMsIDB4NjQsIDB4NjQsIDB4NjQsIDB4NjUsIDB4NjUsIDB4NjYsIDB4NjYsIDB4NjYsIDB4NjcsIDB4NjcsIDB4NjcsIDB4NjgsIDB4NjgsIDB4NjgsIDB4NjksCiAgICAweDY5LCAweDZBLCAweDZBLCAweDZBLCAweDZCLCAweDZCLCAweDZCLCAweDZDLCAweDZDLCAweDZELCAweDZELCAweDZELCAweDZFLCAweDZFLCAweDZGLCAweDZGLAogICAgMHg3MCwgMHg3MCwgMHg3MCwgMHg3MSwgMHg3MSwgMHg3MiwgMHg3MiwgMHg3MywgMHg3MywgMHg3MywgMHg3NCwgMHg3NCwgMHg3NSwgMHg3NSwgMHg3NiwgMHg3NiwKICAgIDB4NzcsIDB4NzcsIDB4NzgsIDB4NzgsIDB4NzgsIDB4NzksIDB4NzksIDB4N0EsIDB4N0EsIDB4N0IsIDB4N0IsIDB4N0MsIDB4N0MsIDB4N0QsIDB4N0QsIDB4N0UsCiAgICAweDdFLCAweDdGLCAweDdGLCAweDgwLCAweDgwLCAweDgxLCAweDgxLCAweDgyLCAweDgzLCAweDgzLCAweDg0LCAweDg0LCAweDg1LCAweDg1LCAweDg2LCAweDg2LAogICAgMHg4NywgMHg4OCwgMHg4OCwgMHg4OSwgMHg4OSwgMHg4QSwgMHg4QSwgMHg4QiwgMHg4QywgMHg4QywgMHg4RCwgMHg4RCwgMHg4RSwgMHg4RiwgMHg4RiwgMHg5MCwKICAgIDB4OTAsIDB4OTEsIDB4OTIsIDB4OTIsIDB4OTMsIDB4OTQsIDB4OTQsIDB4OTUsIDB4OTUsIDB4OTYsIDB4OTcsIDB4OTcsIDB4OTgsIDB4OTksIDB4OTksIDB4OUEsCiAgICAweDlCLCAweDlCLCAweDlDLCAweDlELCAweDlELCAweDlFLCAweDlGLCAweEEwLCAweEEwLCAweEExLCAweEEyLCAweEEyLCAweEEzLCAweEE0LCAweEE1LCAweEE1LAogICAgMHhBNiwgMHhBNywgMHhBNywgMHhBOCwgMHhBOSwgMHhBQSwgMHhBQSwgMHhBQiwgMHhBQywgMHhBRCwgMHhBRSwgMHhBRSwgMHhBRiwgMHhCMCwgMHhCMSwgMHhCMSwKICAgIDB4QjIsIDB4QjMsIDB4QjQsIDB4QjUsIDB4QjYsIDB4QjYsIDB4QjcsIDB4QjgsIDB4QjksIDB4QkEsIDB4QkEsIDB4QkIsIDB4QkMsIDB4QkQsIDB4QkUsIDB4QkYsCiAgICAweEMwLCAweEMxLCAweEMxLCAweEMyLCAweEMzLCAweEM0LCAweEM1LCAweEM2LCAweEM3LCAweEM4LCAweEM5LCAweEM5LCAweENBLCAweENCLCAweENDLCAweENELAogICAgMHhDRSwgMHhDRiwgMHhEMCwgMHhEMSwgMHhEMiwgMHhEMywgMHhENCwgMHhENSwgMHhENiwgMHhENywgMHhEOCwgMHhEOSwgMHhEQSwgMHhEQiwgMHhEQywgMHhERCwKICAgIDB4REUsIDB4REYsIDB4RTAsIDB4RTEsIDB4RTIsIDB4RTMsIDB4RTQsIDB4RTUsIDB4RTYsIDB4RTcsIDB4RTgsIDB4RTksIDB4RUEsIDB4RUIsIDB4RUQsIDB4RUUsCiAgICAweEVGLCAweEYwLCAweEYxLCAweEYyLCAweEYzLCAweEY0LCAweEY1LCAweEY3LCAweEY4LCAweEY5LCAweEZBLCAweEZCLCAweEZDLCAweEZECl0pOwpIQ0FUYWJsZXMuTWRjdFdpbmRvdyA9IG5ldyBGbG9hdDY0QXJyYXkoX2IuYWRhcHRFbmRpYW5uZXNzNjQzMihuZXcgVWludDMyQXJyYXkoWwogICAgMHgwMDAwMDAwMCwgMHgzRjQ2QTA5RSwgMHgwMDAwMDAwMCwgMHgzRjYwMzA3NywgMHgwMDAwMDAwMCwgMHgzRjZFMThBNywgMHgwMDAwMDAwMCwgMHgzRjc3NzI0RCwKICAgIDB4MjAwMDAwMDAsIDB4M0Y4MDk1MDEsIDB4MDAwMDAwMDAsIDB4M0Y4NjEwNDAsIDB4ODAwMDAwMDAsIDB4M0Y4QzI1MDksIDB4RTAwMDAwMDAsIDB4M0Y5MTY3RTIsCiAgICAweDQwMDAwMDAwLCAweDNGOTUwNzMyLCAweEEwMDAwMDAwLCAweDNGOThFRkY3LCAweDAwMDAwMDAwLCAweDNGOUQyMjIyLCAweEEwMDAwMDAwLCAweDNGQTBDRUY5LAogICAgMHg4MDAwMDAwMCwgMHgzRkEzMzFGOCwgMHg4MDAwMDAwMCwgMHgzRkE1QkE2QiwgMHg2MDAwMDAwMCwgMHgzRkE4NjhDOCwgMHgyMDAwMDAwMCwgMHgzRkFCM0Q5OCwKICAgIDB4MDAwMDAwMDAsIDB4M0ZBRTM5NzUsIDB4QzAwMDAwMDAsIDB4M0ZCMEFFODMsIDB4NjAwMDAwMDAsIDB4M0ZCMjU0ODIsIDB4ODAwMDAwMDAsIDB4M0ZCNDBGMTYsCiAgICAweDQwMDAwMDAwLCAweDNGQjVERUE0LCAweEMwMDAwMDAwLCAweDNGQjdDMzkzLCAweDYwMDAwMDAwLCAweDNGQjlCRTRGLCAweEEwMDAwMDAwLCAweDNGQkJDRjQzLAogICAgMHhBMDAwMDAwMCwgMHgzRkJERjZERCwgMHg2MDAwMDAwMCwgMHgzRkMwMUFDNSwgMHg0MDAwMDAwMCwgMHgzRkMxNDVEQiwgMHg0MDAwMDAwMCwgMHgzRkMyN0NFNSwKICAgIDB4MjAwMDAwMDAsIDB4M0ZDM0MwMTYsIDB4NDAwMDAwMDAsIDB4M0ZDNTBGOUUsIDB4QTAwMDAwMDAsIDB4M0ZDNjZCQUEsIDB4MjAwMDAwMDAsIDB4M0ZDN0Q0NjQsCiAgICAweEEwMDAwMDAwLCAweDNGQzk0OUVFLCAweEUwMDAwMDAwLCAweDNGQ0FDQzY3LCAweEUwMDAwMDAwLCAweDNGQ0M1QkU2LCAweDIwMDAwMDAwLCAweDNGQ0RGODdBLAogICAgMHgwMDAwMDAwMCwgMHgzRkNGQTIyNywgMHg0MDAwMDAwMCwgMHgzRkQwQUM3NCwgMHhFMDAwMDAwMCwgMHgzRkQxOEU1NiwgMHgyMDAwMDAwMCwgMHgzRkQyNzZBQywKICAgIDB4RTAwMDAwMDAsIDB4M0ZEMzY1NUQsIDB4RTAwMDAwMDAsIDB4M0ZENDVBNEQsIDB4NjAwMDAwMDAsIDB4M0ZENTU1NTUsIDB4NDAwMDAwMDAsIDB4M0ZENjU2NDQsCiAgICAweEMwMDAwMDAwLCAweDNGRDc1Q0UwLCAweEUwMDAwMDAwLCAweDNGRDg2OEU2LCAweEEwMDAwMDAwLCAweDNGRDk3QTA3LCAweEMwMDAwMDAwLCAweDNGREE4RkU4LAogICAgMHgwMDAwMDAwMCwgMHgzRkRCQUEyNSwgMHg4MDAwMDAwMCwgMHgzRkRDQzg0QiwgMHhFMDAwMDAwMCwgMHgzRkRERTlERiwgMHhFMDAwMDAwMCwgMHgzRkRGMEU1QSwKICAgIDB4MjAwMDAwMDAsIDB4M0ZFMDFBOTUsIDB4NDAwMDAwMDAsIDB4M0ZFMEFFRDksIDB4NjAwMDAwMDAsIDB4M0ZFMTQzQTcsIDB4MDAwMDAwMDAsIDB4M0ZFMUQ4QTksCiAgICAweEEwMDAwMDAwLCAweDNGRTI2RDg0LCAweDQwMDAwMDAwLCAweDNGRTMwMURFLCAweDQwMDAwMDAwLCAweDNGRTM5NTU4LCAweDQwMDAwMDAwLCAweDNGRTQyNzk0LAogICAgMHhBMDAwMDAwMCwgMHgzRkU0QjgzNCwgMHhFMDAwMDAwMCwgMHgzRkU1NDZEQywgMHgwMDAwMDAwMCwgMHgzRkU1RDMzMywgMHhBMDAwMDAwMCwgMHgzRkU2NUNFMCwKICAgIDB4QzAwMDAwMDAsIDB4M0ZFNkUzOTMsIDB4QzAwMDAwMDAsIDB4M0ZFNzY2RkYsIDB4NDAwMDAwMDAsIDB4M0ZFN0U2REUsIDB4MDAwMDAwMDAsIDB4M0ZFODYyRjAsCiAgICAweEMwMDAwMDAwLCAweDNGRThEQUZDLCAweDgwMDAwMDAwLCAweDNGRTk0RUQ0LCAweDgwMDAwMDAwLCAweDNGRTlCRTRGLCAweEUwMDAwMDAwLCAweDNGRUEyOTRELAogICAgMHhBMDAwMDAwMCwgMHgzRkVBOEZCOCwgMHg2MDAwMDAwMCwgMHgzRkVBRjE4MCwgMHhDMDAwMDAwMCwgMHgzRkVCNEU5RCwgMHhFMDAwMDAwMCwgMHgzRkVCQTcxMCwKICAgIDB4RTAwMDAwMDAsIDB4M0ZFQkZBRTAsIDB4NDAwMDAwMDAsIDB4M0ZFQzRBMUIsIDB4MjAwMDAwMDAsIDB4M0ZFQzk0RDMsIDB4MDAwMDAwMDAsIDB4M0ZFQ0RCMjEsCiAgICAweEMwMDAwMDAwLCAweDNGRUQxRDIxLCAweDIwMDAwMDAwLCAweDNGRUQ1QUY2LCAweDIwMDAwMDAwLCAweDNGRUQ5NEMyLCAweDQwMDAwMDAwLCAweDNGRURDQUFDLAogICAgMHhFMDAwMDAwMCwgMHgzRkVERkNEQywgMHhFMDAwMDAwMCwgMHgzRkVFMkI3RCwgMHgyMDAwMDAwMCwgMHgzRkVFNTZCQSwgMHhDMDAwMDAwMCwgMHgzRkVFN0VCQywKICAgIDB4MjAwMDAwMDAsIDB4M0ZFRUEzQjEsIDB4NjAwMDAwMDAsIDB4M0ZFRUM1QzIsIDB4RTAwMDAwMDAsIDB4M0ZFRUU1MUEsIDB4MDAwMDAwMDAsIDB4M0ZFRjAxRTQsCiAgICAweDgwMDAwMDAwLCAweDNGRUYxQzQ2LCAweDgwMDAwMDAwLCAweDNGRUYzNDY5LCAweEUwMDAwMDAwLCAweDNGRUY0QTcyLCAweDIwMDAwMDAwLCAweDNGRUY1RTg3LAogICAgMHgwMDAwMDAwMCwgMHgzRkVGNzBDOSwgMHhDMDAwMDAwMCwgMHgzRkVGODE1OSwgMHgwMDAwMDAwMCwgMHgzRkVGOTA1OSwgMHhDMDAwMDAwMCwgMHgzRkVGOURFNCwKICAgIDB4NjAwMDAwMDAsIDB4M0ZFRkFBMTksIDB4QzAwMDAwMDAsIDB4M0ZFRkI1MTEsIDB4RTAwMDAwMDAsIDB4M0ZFRkJFRTYsIDB4QzAwMDAwMDAsIDB4M0ZFRkM3QjAsCiAgICAweDQwMDAwMDAwLCAweDNGRUZDRjg1LCAweDgwMDAwMDAwLCAweDNGRUZENjc5LCAweEUwMDAwMDAwLCAweDNGRUZEQ0EwLCAweDgwMDAwMDAwLCAweDNGRUZFMjBELAogICAgMHg2MDAwMDAwMCwgMHgzRkVGRTZEMCwgMHg0MDAwMDAwMCwgMHgzRkVGRUFGOSwgMHhDMDAwMDAwMCwgMHgzRkVGRUU5NiwgMHhDMDAwMDAwMCwgMHgzRkVGRjFCNiwKICAgIDB4QzAwMDAwMDAsIDB4M0ZFRkY0NjUsIDB4NjAwMDAwMDAsIDB4M0ZFRkY2QUYsIDB4QzAwMDAwMDAsIDB4M0ZFRkY4OUUsIDB4QTAwMDAwMDAsIDB4M0ZFRkZBM0QsCiAgICAweEEwMDAwMDAwLCAweDNGRUZGQjk1LCAweDIwMDAwMDAwLCAweDNGRUZGQ0FGLCAweDAwMDAwMDAwLCAweDNGRUZGRDkyLCAweEMwMDAwMDAwLCAweDNGRUZGRTQ1LAogICAgMHgwMDAwMDAwMCwgMHgzRkVGRkVEMSwgMHgwMDAwMDAwMCwgMHgzRkVGRkYzQSwgMHg0MDAwMDAwMCwgMHgzRkVGRkY4NiwgMHg0MDAwMDAwMCwgMHgzRkVGRkZCQiwKICAgIDB4QTAwMDAwMDAsIDB4M0ZFRkZGREQsIDB4RTAwMDAwMDAsIDB4M0ZFRkZGRjEsIDB4RTAwMDAwMDAsIDB4M0ZFRkZGRkIsIDB4ODAwMDAwMDAsIDB4M0ZFRkZGRkYKXSkpLmJ1ZmZlcik7CkhDQVRhYmxlcy5EZWZhdWx0Q2hhbm5lbE1hcHBpbmcgPSBuZXcgVWludDhBcnJheShbCiAgICAweDAwLCAweDAxLCAweDAwLCAweDA0LCAweDAwLCAweDAxLCAweDAzLCAweDA3LCAweDAzCl0pOwpIQ0FUYWJsZXMuVmFsaWRDaGFubmVsTWFwcGluZ3MgPSBbCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMSwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMSwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMSwgMHgwMSwgMHgwMCwgMHgwMSwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMSwgMHgwMCwgMHgwMCwgMHgwMSwgMHgwMCwgMHgwMSwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMSwgMHgwMSwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMQogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMSwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMQogICAgXSksCiAgICBuZXcgVWludDhBcnJheShbCiAgICAgICAgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMSwgMHgwMCwgMHgwMCwgMHgwMCwgMHgwMAogICAgXSksCl07CkhDQVRhYmxlcy5EZXF1YW50aXplclNjYWxpbmdUYWJsZSA9IG5ldyBGbG9hdDY0QXJyYXkoX2IuYWRhcHRFbmRpYW5uZXNzNjQzMihuZXcgVWludDMyQXJyYXkoWwogICAgMHhDQTVEOTIwMSwgMHgzRTg1NTFBNCwgMHgyRTU3RDEzOSwgMHgzRThDNjdGMSwgMHhBOTNFMkY0QSwgMHgzRTkyRUNBRiwgMHhCMENEQzVENSwgMHgzRTk5MzczNywKICAgIDB4MkI3MjQ3RUQsIDB4M0VBMENDOTIsIDB4ODI1NTIyMTcsIDB4M0VBNjYyMzgsIDB4RjMwMUI0NEYsIDB4M0VBREQzMjEsIDB4NEMxMjM0MTYsIDB4M0VCM0RFQTYsCiAgICAweDEzMzBCMzQ5LCAweDNFQkE3OTlFLCAweEVCNkZDQjZDLCAweDNFQzFBMzVCLCAweDRGREU1RDMzLCAweDNFQzc4MDY5LCAweDVCNkU0NTJGLCAweDNFQ0Y1MDc2LAogICAgMHg5OUZEREQwMywgMHgzRUQ0RENCMiwgMHg5MDRCQzFDMywgMHgzRURCQ0MxRSwgMHhFMUY1NjM3OCwgMHgzRUUyODRERiwgMHg0MjJBQTBDRiwgMHgzRUU4QUNFNSwKICAgIDB4MjlEREY2RDYsIDB4M0VGMDcwNkIsIDB4MTVBRDIxM0UsIDB4M0VGNUU3NkYsIDB4MDgwRDg5RTMsIDB4M0VGRDJGODcsIDB4MzczQUE5QzIsIDB4M0YwMzcxQTcsCiAgICAweDE5RTMyMzE4LCAweDNGMDlFODYzLCAweEFFQTkyREQ4LCAweDNGMTE0MjlBLCAweEY5NTE5NDdCLCAweDNGMTZGRjdELCAweEEyQTQ5MENELCAweDNGMUVBNEFGLAogICAgMHhFRDFEMDA1MCwgMHgzRjI0NkE0MSwgMHhCODRGMTVGMCwgMHgzRjJCMzNBMiwgMHg5MTdEREM5MCwgMHgzRjMyMUY0OSwgMHg5OTRDQ0UwQSwgMHgzRjM4MjU4OSwKICAgIDB4QTlGQjMzMkYsIDB4M0Y0MDE2M0QsIDB4MzZCNTI3RDMsIDB4M0Y0NTZGNDcsIDB4OTQwNkU3QUMsIDB4M0Y0QzhGNkQsIDB4MEEzMUI3MEYsIDB4M0Y1MzA2RkUsCiAgICAweENCQzg1MjA3LCAweDNGNTk1QTQ0LCAweDMyRDNEMTlELCAweDNGNjBFM0VDLCAweEQ0NENBOTZDLCAweDNGNjY4MTU1LCAweDMzN0I5QjU2LCAweDNGNkRGQzk3LAogICAgMHgwNEFDODAxNiwgMHgzRjczRkE0NSwgMHg1NTc5RkRCOCwgMHgzRjdBOUU2QiwgMHg4NDA0NUNDRiwgMHgzRjgxQkJFMCwgMHg3M0VCMDE4MSwgMHgzRjg3QTExNCwKICAgIDB4QUQ5Q0JFMEMsIDB4M0Y4RjdCRkQsIDB4NzY5RDJDQTIsIDB4M0Y5NEY5QjIsIDB4NUJENzFFMDMsIDB4M0Y5QkYyQzIsIDB4RjUxRkRFREUsIDB4M0ZBMjlFOUQsCiAgICAweDE2QjU0NDg3LCAweDNGQThDRjMyLCAweDE4NzU5QkM1LCAweDNGQjA4NzQ1LCAweEI5NzZEQzA1LCAweDNGQjYwNUUxLCAweERDRkJBNDgzLCAweDNGQkQ1ODE4LAogICAgMHg2RDA1RDg2MywgMHgzRkMzOENBRSwgMHg3QjVERTU2MSwgMHgzRkNBMEM2NiwgMHhDOEE1OEU0RiwgMHgzRkQxNUE5OCwgMHhFOEVDNUY3MSwgMHgzRkQ3MUY3NSwKICAgIDB4MkQ4RTY3RUQsIDB4M0ZERUNGNDgsIDB4QjVDMTNDQ0UsIDB4M0ZFNDg2QTIsIDB4OERFNTU5MzgsIDB4M0ZFQjU5NzIsIDB4NkU3NTYyMzcsIDB4M0ZGMjM4N0EsCiAgICAweDQ2MjNDN0FDLCAweDNGRjg0NzFBLCAweDNFNzc4MDYwLCAweDQwMDAyQzlBLCAweEQ0OTdDN0ZELCAweDQwMDU4RDEyLCAweERDRUY5MDY4LCAweDQwMENCNzIwLAogICAgMHhGQzRDRDgzMSwgMHg0MDEzMjE3MCwgMHg5RkRFNEU1MCwgMHg0MDE5N0Q4MiwgMHhBRkZFRDMxQiwgMHg0MDIwRkI2NiwgMHg2NjdGM0JDRCwgMHg0MDI2QTA5RQpdKSkuYnVmZmVyKTsKSENBVGFibGVzLlF1YW50aXplclN0ZXBTaXplID0gbmV3IEZsb2F0NjRBcnJheShfYi5hZGFwdEVuZGlhbm5lc3M2NDMyKG5ldyBVaW50MzJBcnJheShbCiAgICAweDAwMDAwMDAwLCAweDAwMDAwMDAwLCAweDU1NTU1NTU1LCAweDNGRTU1NTU1LCAweDk5OTk5OTlBLCAweDNGRDk5OTk5LCAweDkyNDkyNDkyLCAweDNGRDI0OTI0LAogICAgMHgxQzcxQzcxQywgMHgzRkNDNzFDNywgMHg3NDVEMTc0NiwgMHgzRkM3NDVEMSwgMHgxM0IxM0IxNCwgMHgzRkMzQjEzQiwgMHgxMTExMTExMSwgMHgzRkMxMTExMSwKICAgIDB4MDg0MjEwODQsIDB4M0ZCMDg0MjEsIDB4MTA0MTA0MTAsIDB4M0ZBMDQxMDQsIDB4ODEwMjA0MDgsIDB4M0Y5MDIwNDAsIDB4MTAxMDEwMTAsIDB4M0Y4MDEwMTAsCiAgICAweDAyMDEwMDgwLCAweDNGNzAwODA0LCAweDAwNDAxMDA0LCAweDNGNjAwNDAxLCAweDQwMDgwMTAwLCAweDNGNTAwMjAwLCAweDEwMDEwMDEwLCAweDNGNDAwMTAwCl0pKS5idWZmZXIpOwpIQ0FUYWJsZXMuUXVhbnRpemVyRGVhZFpvbmUgPSBuZXcgRmxvYXQ2NEFycmF5KF9iLmFkYXB0RW5kaWFubmVzczY0MzIobmV3IFVpbnQzMkFycmF5KFsKICAgIDB4RkZGRkZGRkYsIDB4RkZGRkZGRkYsIDB4NTU1NTU1NTMsIDB4M0ZENTU1NTUsIDB4OTk5OTk5OTcsIDB4M0ZDOTk5OTksIDB4OTI0OTI0OEUsIDB4M0ZDMjQ5MjQsCiAgICAweDFDNzFDNzE3LCAweDNGQkM3MUM3LCAweDc0NUQxNzQwLCAweDNGQjc0NUQxLCAweDEzQjEzQjBELCAweDNGQjNCMTNCLCAweDExMTExMTA5LCAweDNGQjExMTExLAogICAgMHgwODQyMTA3NCwgMHgzRkEwODQyMSwgMHgxMDQxMDNGMCwgMHgzRjkwNDEwNCwgMHg4MTAyMDNDOCwgMHgzRjgwMjA0MCwgMHgxMDEwMEY5MCwgMHgzRjcwMTAxMCwKICAgIDB4MDIwMEZGODAsIDB4M0Y2MDA4MDQsIDB4MDA0MDBFMDQsIDB4M0Y1MDA0MDEsIDB4NDAwN0ZEMDAsIDB4M0Y0MDAyMDAsIDB4MTAwMEY4MTAsIDB4M0YzMDAxMDAKXSkpLmJ1ZmZlcik7CkhDQVRhYmxlcy5RdWFudGl6ZXJTY2FsaW5nVGFibGUgPSBuZXcgRmxvYXQ2NEFycmF5KF9iLmFkYXB0RW5kaWFubmVzczY0MzIobmV3IFVpbnQzMkFycmF5KFsKICAgIDB4NTQzRTFBMjEsIDB4NDE1ODA0MjcsIDB4ODg2MjhDRTIsIDB4NDE1MjA2M0IsIDB4Mjk4REI2NzcsIDB4NDE0QjBFMDcsIDB4NjA2MTg5M0EsIDB4NDE0NDRFMDgsCiAgICAweEZCQzc0Qzk2LCAweDQxM0U3QTUxLCAweDNDNjUxQTNELCAweDQxMzZERkIyLCAweEMwNkMzMUQ2LCAweDQxMzEyQUJELCAweDgyQTNGMEEwLCAweDQxMjlDNDkxLAogICAgMHg1RjkyOUZGQywgMHg0MTIzNTZDNSwgMHg0QTA3ODk4QiwgMHg0MTFEMDcyRCwgMHg4QTU5NDZDMiwgMHg0MTE1QzkyNiwgMHhEMzE1ODU3RCwgMHg0MTEwNTlCMCwKICAgIDB4RDk4QTY2QTYsIDB4NDEwODhBQzcsIDB4NjVFMjdDRTcsIDB4NDEwMjZCNDUsIDB4MzBBMTA2NTYsIDB4NDBGQkE1QjAsIDB4RDUzNjJBMzIsIDB4NDBGNEJGREEsCiAgICAweDM3NkJCQUE2LCAweDQwRUYyNTJCLCAweDU2NDI2N0Q0LCAweDQwRTc1RkVCLCAweDM4OEM4REYyLCAweDQwRTE4QUY5LCAweEIyM0UyNTY4LCAweDQwREE1NTAzLAogICAgMHhDMzEzQThFRCwgMHg0MEQzQzMyRCwgMHgwM0RCMzI5MywgMHg0MENEQTlFNiwgMHgzNENDQzMyOCwgMHg0MEM2NDM0NiwgMHg2Q0Y5ODkxNiwgMHg0MEMwQjU1OCwKICAgIDB4MEI5MUZGQ0YsIDB4NDBCOTE0NUIsIDB4QTZFNDAzMTMsIDB4NDBCMkQyODUsIDB4NUZGRkQwODQsIDB4NDBBQzQwQUIsIDB4NTY5RDRGODksIDB4NDBBNTM0MkIsCiAgICAweDJCOEY3MUZFLCAweDQwOUZEM0MyLCAweDM2Q0Y0RTZBLCAweDQwOTdFMkYzLCAweDIyRkNEOTIyLCAweDQwOTFFRDUwLCAweDk5NUFEM0I2LCAweDQwOEFFODlGLAogICAgMHhEOTUwQTg5RCwgMHg0MDg0MzFGNSwgMHhFNzhCM0ZGRiwgMHg0MDdFNTAyRSwgMHg3NTBCREFDNiwgMHg0MDc2QzAxMiwgMHhEMDEyNUI1NiwgMHg0MDcxMTMwMSwKICAgIDB4NzBDQTA3QzEsIDB4NDA2OUEwRjEsIDB4QjI2NDE3MDUsIDB4NDA2MzNDMDgsIDB4NTU1REM0MDEsIDB4NDA1Q0RGMEIsIDB4REQ0ODU0MkYsIDB4NDA1NUFCMDcsCiAgICAweEU4NkU3Rjg5LCAweDQwNTA0MzE1LCAweDlCNDQ5MkYyLCAweDQwNDg2OEQ5LCAweDRGQjJBNjQzLCAweDQwNDI1MUNFLCAweEYyRkI1RTRDLCAweDQwM0I3Rjc2LAogICAgMHhGMEQ3RDNFMywgMHg0MDM0QTMyQSwgMHhFRTYxNUEyRCwgMHg0MDJFRkExQiwgMHg0OEE1ODE3OCwgMHg0MDI3M0Y5QSwgMHgzQzdENTE3RCwgMHg0MDIxNzJCOCwKICAgIDB4RUM0QTJEMzcsIDB4NDAxQTMwOUIsIDB4MzRFNTlGRkEsIDB4NDAxM0E3REIsIDB4MTZDOTgzOUIsIDB4NDAwRDgwRTMsIDB4QjAzQTU1ODcsIDB4NDAwNjI0N0UsCiAgICAweENBQzZGMzg1LCAweDQwMDA5RTNFLCAweDk5MTU3NzM5LCAweDNGRjhGMUFFLCAweEQwREFEOTkxLCAweDNGRjJCODdGLCAweEREODU1MjlFLCAweDNGRUMxOTlCLAogICAgMHhBMkNGNjY0MiwgMHgzRkU1MTZEQSwgMHg4MTlFOTBEQSwgMHgzRkRGQTdDMSwgMHgwMTMwQzEzMywgMHgzRkQ3QzFFRCwgMHgzMTY4QjlBQiwgMHgzRkQxRDQ4NywKICAgIDB4QkZEM0YzN0EsIDB4M0ZDQUMzNkIsIDB4MjFGNzJFMkEsIDB4M0ZDNDE2MEEsIDB4MTRGNUExMjksIDB4M0ZCRTI2NDYsIDB4NjY3RjNCQ0MsIDB4M0ZCNkEwOUUKXSkpLmJ1ZmZlcik7CkhDQVRhYmxlcy5RdWFudGl6ZXJJbnZlcnNlU3RlcFNpemUgPSBuZXcgRmxvYXQ2NEFycmF5KF9iLmFkYXB0RW5kaWFubmVzczY0MzIobmV3IFVpbnQzMkFycmF5KFsKICAgIDB4MDAwMDAwMDAsIDB4M0ZFMDAwMDAsIDB4MDAwMDAwMDAsIDB4M0ZGODAwMDAsIDB4MDAwMDAwMDAsIDB4NDAwNDAwMDAsIDB4MDAwMDAwMDAsIDB4NDAwQzAwMDAsCiAgICAweDAwMDAwMDAwLCAweDQwMTIwMDAwLCAweDAwMDAwMDAwLCAweDQwMTYwMDAwLCAweDAwMDAwMDAwLCAweDQwMUEwMDAwLCAweDAwMDAwMDAwLCAweDQwMUUwMDAwLAogICAgMHgwMDAwMDAwMCwgMHg0MDJGMDAwMCwgMHgwMDAwMDAwMCwgMHg0MDNGODAwMCwgMHgwMDAwMDAwMCwgMHg0MDRGQzAwMCwgMHgwMDAwMDAwMCwgMHg0MDVGRTAwMCwKICAgIDB4MDAwMDAwMDAsIDB4NDA2RkYwMDAsIDB4MDAwMDAwMDAsIDB4NDA3RkY4MDAsIDB4MDAwMDAwMDAsIDB4NDA4RkZDMDAsIDB4MDAwMDAwMDAsIDB4NDA5RkZFMDAKXSkpLmJ1ZmZlcik7CkhDQVRhYmxlcy5SZXNvbHV0aW9uTWF4VmFsdWVzID0gbmV3IEludDMyQXJyYXkoWwogICAgMHgwMDAwMDAwMCwgMHgwMDAwMDAwMSwgMHgwMDAwMDAwMiwgMHgwMDAwMDAwMywgMHgwMDAwMDAwNCwgMHgwMDAwMDAwNSwgMHgwMDAwMDAwNiwgMHgwMDAwMDAwNywKICAgIDB4MDAwMDAwMEYsIDB4MDAwMDAwMUYsIDB4MDAwMDAwM0YsIDB4MDAwMDAwN0YsIDB4MDAwMDAwRkYsIDB4MDAwMDAxRkYsIDB4MDAwMDAzRkYsIDB4MDAwMDA3RkYKXSk7CkhDQVRhYmxlcy5JbnRlbnNpdHlSYXRpb1RhYmxlID0gbmV3IEZsb2F0NjRBcnJheShfYi5hZGFwdEVuZGlhbm5lc3M2NDMyKG5ldyBVaW50MzJBcnJheShbCiAgICAweDAwMDAwMDAwLCAweDQwMDAwMDAwLCAweDZEQjZEQjZFLCAweDNGRkRCNkRCLCAweERCNkRCNkRCLCAweDNGRkI2REI2LCAweDQ5MjQ5MjQ5LCAweDNGRjkyNDkyLAogICAgMHhCNkRCNkRCNywgMHgzRkY2REI2RCwgMHgyNDkyNDkyNSwgMHgzRkY0OTI0OSwgMHg5MjQ5MjQ5MiwgMHgzRkYyNDkyNCwgMHgwMDAwMDAwMCwgMHgzRkYwMDAwMCwKICAgIDB4REI2REI2REIsIDB4M0ZFQjZEQjYsIDB4QjZEQjZEQjcsIDB4M0ZFNkRCNkQsIDB4OTI0OTI0OTIsIDB4M0ZFMjQ5MjQsIDB4REI2REI2REIsIDB4M0ZEQjZEQjYsCiAgICAweDkyNDkyNDkyLCAweDNGRDI0OTI0LCAweDkyNDkyNDkyLCAweDNGQzI0OTI0LCAweDAwMDAwMDAwLCAweDAwMDAwMDAwCl0pKS5idWZmZXIpOwpIQ0FUYWJsZXMuSW50ZW5zaXR5UmF0aW9Cb3VuZHNUYWJsZSA9IG5ldyBGbG9hdDY0QXJyYXkoX2IuYWRhcHRFbmRpYW5uZXNzNjQzMihuZXcgVWludDMyQXJyYXkoWwogICAgMHhCNkRCNkRCNywgMHgzRkZFREI2RCwgMHgyNDkyNDkyNSwgMHgzRkZDOTI0OSwgMHg5MjQ5MjQ5MiwgMHgzRkZBNDkyNCwgMHgwMDAwMDAwMCwgMHgzRkY4MDAwMCwKICAgIDB4NkRCNkRCNkUsIDB4M0ZGNUI2REIsIDB4REI2REI2REIsIDB4M0ZGMzZEQjYsIDB4NDkyNDkyNDksIDB4M0ZGMTI0OTIsIDB4NkRCNkRCNkUsIDB4M0ZFREI2REIsCiAgICAweDQ5MjQ5MjQ5LCAweDNGRTkyNDkyLCAweDI0OTI0OTI1LCAweDNGRTQ5MjQ5LCAweDAwMDAwMDAwLCAweDNGRTAwMDAwLCAweEI2REI2REI3LCAweDNGRDZEQjZELAogICAgMHhEQjZEQjZEQiwgMHgzRkNCNkRCNiwgMHg5MjQ5MjQ5MiwgMHgzRkIyNDkyNApdKSkuYnVmZmVyKTsKSENBVGFibGVzLlNjYWxlQ29udmVyc2lvblRhYmxlID0gbmV3IEZsb2F0NjRBcnJheShfYi5hZGFwdEVuZGlhbm5lc3M2NDMyKG5ldyBVaW50MzJBcnJheShbCiAgICAweDAwMDAwMDAwLCAweDAwMDAwMDAwLCAweDAwMDAwMDAwLCAweDAwMDAwMDAwLCAweDIxRjcyRTFELCAweDNFNTQxNjBBLCAweEJGRDNGMzY4LCAweDNFNUFDMzZCLAogICAgMHgzMTY4Qjk5RiwgMHgzRTYxRDQ4NywgMHgwMTMwQzEyMywgMHgzRTY3QzFFRCwgMHg4MTlFOTBDNCwgMHgzRTZGQTdDMSwgMHhBMkNGNjYzNSwgMHgzRTc1MTZEQSwKICAgIDB4REQ4NTUyOEIsIDB4M0U3QzE5OUIsIDB4RDBEQUQ5ODUsIDB4M0U4MkI4N0YsIDB4OTkxNTc3MjgsIDB4M0U4OEYxQUUsIDB4Q0FDNkYzN0EsIDB4M0U5MDlFM0UsCiAgICAweEIwM0E1NTc4LCAweDNFOTYyNDdFLCAweDE2Qzk4Mzg4LCAweDNFOUQ4MEUzLCAweDM0RTU5RkVDLCAweDNFQTNBN0RCLCAweEVDNEEyRDI2LCAweDNFQUEzMDlCLAogICAgMHgzQzdENTE3MiwgMHgzRUIxNzJCOCwgMHg0OEE1ODE2OCwgMHgzRUI3M0Y5QSwgMHhFRTYxNUExOCwgMHgzRUJFRkExQiwgMHhGMEQ3RDNENCwgMHgzRUM0QTMyQSwKICAgIDB4RjJGQjVFM0EsIDB4M0VDQjdGNzYsIDB4NEZCMkE2MzcsIDB4M0VEMjUxQ0UsIDB4OUI0NDkyRTEsIDB4M0VEODY4RDksIDB4RTg2RTdGN0UsIDB4M0VFMDQzMTUsCiAgICAweERENDg1NDIwLCAweDNFRTVBQjA3LCAweDU1NURDM0VFLCAweDNFRUNERjBCLCAweEIyNjQxNkY3LCAweDNFRjMzQzA4LCAweDcwQ0EwN0IwLCAweDNFRjlBMEYxLAogICAgMHhEMDEyNUI0QSwgMHgzRjAxMTMwMSwgMHg3NTBCREFCNiwgMHgzRjA2QzAxMiwgMHhFNzhCM0ZFQiwgMHgzRjBFNTAyRSwgMHhEOTUwQTg5MCwgMHgzRjE0MzFGNSwKICAgIDB4OTk1QUQzQTQsIDB4M0YxQUU4OUYsIDB4MjJGQ0Q5MTcsIDB4M0YyMUVENTAsIDB4MzZDRjRFNUEsIDB4M0YyN0UyRjMsIDB4MkI4RjcxRTcsIDB4M0YyRkQzQzIsCiAgICAweDU2OUQ0RjdCLCAweDNGMzUzNDJCLCAweDVGRkZEMDcyLCAweDNGM0M0MEFCLCAweEE2RTQwMzA2LCAweDNGNDJEMjg1LCAweDBCOTFGRkJGLCAweDNGNDkxNDVCLAogICAgMHg2Q0Y5ODkwQiwgMHgzRjUwQjU1OCwgMHgzNENDQzMxQSwgMHgzRjU2NDM0NiwgMHgwM0RCMzI3RSwgMHgzRjVEQTlFNiwgMHhDMzEzQThFMCwgMHgzRjYzQzMyRCwKICAgIDB4QjIzRTI1NTcsIDB4M0Y2QTU1MDMsIDB4Mzg4QzhERTYsIDB4M0Y3MThBRjksIDB4NTY0MjY3QzQsIDB4M0Y3NzVGRUIsIDB4Mzc2QkJBOTIsIDB4M0Y3RjI1MkIsCiAgICAweEQ1MzYyQTI0LCAweDNGODRCRkRBLCAweDMwQTEwNjQ1LCAweDNGOEJBNUIwLCAweDY1RTI3Q0RBLCAweDNGOTI2QjQ1LCAweEQ5OEE2Njk2LCAweDNGOTg4QUM3LAogICAgMHhEMzE1ODU3MiwgMHgzRkEwNTlCMCwgMHg4QTU5NDZCNCwgMHgzRkE1QzkyNiwgMHg0QTA3ODk3OCwgMHgzRkFEMDcyRCwgMHg1RjkyOUZFRiwgMHgzRkIzNTZDNSwKICAgIDB4ODJBM0YwOEUsIDB4M0ZCOUM0OTEsIDB4QzA2QzMxQ0IsIDB4M0ZDMTJBQkQsIDB4M0M2NTFBMkQsIDB4M0ZDNkRGQjIsIDB4RkJDNzRDODIsIDB4M0ZDRTdBNTEsCiAgICAweDYwNjE4OTJDLCAweDNGRDQ0RTA4LCAweDI5OERCNjY1LCAweDNGREIwRTA3LCAweDg4NjI4Q0Q2LCAweDNGRTIwNjNCLCAweDU0M0UxQTExLCAweDNGRTgwNDI3LAogICAgMHgwMDAwMDAwMCwgMHgzRkYwMDAwMCwgMHhDQTVEOTIwRiwgMHgzRkY1NTFBNCwgMHgyRTU3RDE0QywgMHgzRkZDNjdGMSwgMHhBOTNFMkY1NywgMHg0MDAyRUNBRiwKICAgIDB4QjBDREM1RTYsIDB4NDAwOTM3MzcsIDB4MkI3MjQ3RjgsIDB4NDAxMENDOTIsIDB4ODI1NTIyMjYsIDB4NDAxNjYyMzgsIDB4RjMwMUI0NjMsIDB4NDAxREQzMjEsCiAgICAweDRDMTIzNDI0LCAweDQwMjNERUE2LCAweDEzMzBCMzVCLCAweDQwMkE3OTlFLCAweEVCNkZDQjc3LCAweDQwMzFBMzVCLCAweDRGREU1RDQyLCAweDQwMzc4MDY5LAogICAgMHg1QjZFNDU0NCwgMHg0MDNGNTA3NiwgMHg5OUZEREQxMCwgMHg0MDQ0RENCMiwgMHg5MDRCQzFENiwgMHg0MDRCQ0MxRSwgMHhFMUY1NjM4NCwgMHg0MDUyODRERiwKICAgIDB4NDIyQUEwRTAsIDB4NDA1OEFDRTUsIDB4MjlEREY2RTEsIDB4NDA2MDcwNkIsIDB4MTVBRDIxNEQsIDB4NDA2NUU3NkYsIDB4MDgwRDg5RjgsIDB4NDA2RDJGODcsCiAgICAweDM3M0FBOUNGLCAweDQwNzM3MUE3LCAweDE5RTMyMzI5LCAweDQwNzlFODYzLCAweEFFQTkyREU0LCAweDQwODE0MjlBLCAweEY5NTE5NDhBLCAweDQwODZGRjdELAogICAgMHhBMkE0OTBFMSwgMHg0MDhFQTRBRiwgMHhFRDFEMDA1RCwgMHg0MDk0NkE0MSwgMHhCODRGMTYwMywgMHg0MDlCMzNBMiwgMHg5MTdEREM5QiwgMHg0MEEyMUY0OSwKICAgIDB4OTk0Q0NFMUEsIDB4NDBBODI1ODksIDB4QTlGQjMzM0EsIDB4NDBCMDE2M0QsIDB4MzZCNTI3RTEsIDB4NDBCNTZGNDcsIDB4OTQwNkU3QkYsIDB4NDBCQzhGNkQsCiAgICAweDBBMzFCNzFDLCAweDQwQzMwNkZFLCAweENCQzg1MjE4LCAweDQwQzk1QTQ0LCAweDMyRDNEMUE4LCAweDQwRDBFM0VDLCAweEQ0NENBOTdDLCAweDQwRDY4MTU1LAogICAgMHgzMzdCOUI2QSwgMHg0MERERkM5NywgMHgwNEFDODAyNCwgMHg0MEUzRkE0NSwgMHg1NTc5RkRDQSwgMHg0MEVBOUU2QiwgMHg4NDA0NUNEQiwgMHg0MEYxQkJFMCwKICAgIDB4NzNFQjAxOTEsIDB4NDBGN0ExMTQsIDB4QUQ5Q0JFMjEsIDB4NDBGRjdCRkQsIDB4NzY5RDJDQjAsIDB4NDEwNEY5QjIsIDB4NUJENzFFMTUsIDB4NDEwQkYyQzIsCiAgICAweEY1MUZERUVBLCAweDQxMTI5RTlELCAweDE2QjU0NDk4LCAweDQxMThDRjMyLCAweDE4NzU5QkQwLCAweDQxMjA4NzQ1LCAweEI5NzZEQzE0LCAweDQxMjYwNUUxLAogICAgMHhEQ0ZCQTQ5NiwgMHg0MTJENTgxOCwgMHg2RDA1RDg3MCwgMHg0MTMzOENBRSwgMHg3QjVERTU3MywgMHg0MTNBMEM2NiwgMHhDOEE1OEU1QiwgMHg0MTQxNUE5OCwKICAgIDB4RThFQzVGODEsIDB4NDE0NzFGNzUsIDB4MkQ4RTY4MDIsIDB4NDE0RUNGNDgsIDB4QjVDMTNDREMsIDB4NDE1NDg2QTIsIDB4OERFNTU5NEEsIDB4NDE1QjU5NzIsCiAgICAweDZFNzU2MjQzLCAweDQxNjIzODdBLCAweDQ2MjNDN0JDLCAweDQxNjg0NzFBLCAweDNFNzc4MDZCLCAweDQxNzAyQzlBLCAweEQ0OTdDODBCLCAweDQxNzU4RDEyLAogICAgMHhEQ0VGOTA3QywgMHg0MTdDQjcyMCwgMHhGQzRDRDgzRSwgMHg0MTgzMjE3MCwgMHg5RkRFNEU2MSwgMHg0MTg5N0Q4MiwgMHgwMDAwMDAwMCwgMHgwMDAwMDAwMApdKSkuYnVmZmVyKTsKY2xhc3MgSENBQ3JjMTYgewogICAgc3RhdGljIGNhbGMoZGF0YSwgc2l6ZSkgewogICAgICAgIGlmIChzaXplID4gZGF0YS5ieXRlTGVuZ3RoKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICBpZiAoc2l6ZSA8IDApCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgIGxldCBzdW0gPSAwOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2l6ZTsgaSsrKQogICAgICAgICAgICBzdW0gPSAoKHN1bSA8PCA4KSBeIHRoaXMuX3ZbKHN1bSA+PiA4KSBeIGRhdGFbaV1dKSAmIDB4MDAwMGZmZmY7CiAgICAgICAgcmV0dXJuIHN1bSAmIDB4MDAwMGZmZmY7CiAgICB9CiAgICBzdGF0aWMgdmVyaWZ5KGRhdGEsIHNpemUsIGV4cGVjdGVkLCBkb05vdFRocm93ID0gZmFsc2UpIHsKICAgICAgICBpZiAoZXhwZWN0ZWQgPT0gbnVsbCkgewogICAgICAgICAgICBleHBlY3RlZCA9IG5ldyBEYXRhVmlldyhkYXRhLmJ1ZmZlciwgZGF0YS5ieXRlT2Zmc2V0LCBkYXRhLmJ5dGVMZW5ndGgpLmdldFVpbnQxNihzaXplKTsKICAgICAgICB9CiAgICAgICAgbGV0IGFjdHVhbCA9IHRoaXMuY2FsYyhkYXRhLCBzaXplKTsKICAgICAgICBsZXQgcmVzdWx0ID0gZXhwZWN0ZWQgPT0gYWN0dWFsOwogICAgICAgIGlmICghcmVzdWx0KSB7CiAgICAgICAgICAgIGZ1bmN0aW9uIHRvSGV4KG51bSkgewogICAgICAgICAgICAgICAgY29uc3QgcGFkZGluZyA9ICIwMDAwIjsKICAgICAgICAgICAgICAgIGxldCBoZXggPSBwYWRkaW5nICsgbnVtLnRvU3RyaW5nKHBhZGRpbmcubGVuZ3RoICogNCkudG9VcHBlckNhc2UoKTsKICAgICAgICAgICAgICAgIHJldHVybiAiMHgiICsgaGV4LnN1YnN0cmluZyhoZXgubGVuZ3RoIC0gcGFkZGluZy5sZW5ndGgsIGhleC5sZW5ndGgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxldCBtc2cgPSBgY2hlY2tzdW0gbWlzbWF0Y2ggKGV4cGVjdGVkPSR7dG9IZXgoZXhwZWN0ZWQpfSBhY3R1YWw9JHt0b0hleChhY3R1YWwpfSlgOwogICAgICAgICAgICBpZiAoZG9Ob3RUaHJvdykKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IobXNnKTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKG1zZyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CiAgICBzdGF0aWMgZml4KGRhdGEsIHNpemUpIHsKICAgICAgICBsZXQgbmV3Q3JjMTYgPSB0aGlzLmNhbGMoZGF0YSwgc2l6ZSk7CiAgICAgICAgbmV3IERhdGFWaWV3KGRhdGEuYnVmZmVyLCBkYXRhLmJ5dGVPZmZzZXQsIGRhdGEuYnl0ZUxlbmd0aCkuc2V0VWludDE2KHNpemUsIG5ld0NyYzE2KTsKICAgICAgICByZXR1cm4gZGF0YTsKICAgIH0KfQpIQ0FDcmMxNi5fdiA9IG5ldyBVaW50MTZBcnJheShbCiAgICAweDAwMDAsIDB4ODAwNSwgMHg4MDBGLCAweDAwMEEsIDB4ODAxQiwgMHgwMDFFLCAweDAwMTQsIDB4ODAxMSwgMHg4MDMzLCAweDAwMzYsIDB4MDAzQywgMHg4MDM5LCAweDAwMjgsIDB4ODAyRCwgMHg4MDI3LCAweDAwMjIsCiAgICAweDgwNjMsIDB4MDA2NiwgMHgwMDZDLCAweDgwNjksIDB4MDA3OCwgMHg4MDdELCAweDgwNzcsIDB4MDA3MiwgMHgwMDUwLCAweDgwNTUsIDB4ODA1RiwgMHgwMDVBLCAweDgwNEIsIDB4MDA0RSwgMHgwMDQ0LCAweDgwNDEsCiAgICAweDgwQzMsIDB4MDBDNiwgMHgwMENDLCAweDgwQzksIDB4MDBEOCwgMHg4MERELCAweDgwRDcsIDB4MDBEMiwgMHgwMEYwLCAweDgwRjUsIDB4ODBGRiwgMHgwMEZBLCAweDgwRUIsIDB4MDBFRSwgMHgwMEU0LCAweDgwRTEsCiAgICAweDAwQTAsIDB4ODBBNSwgMHg4MEFGLCAweDAwQUEsIDB4ODBCQiwgMHgwMEJFLCAweDAwQjQsIDB4ODBCMSwgMHg4MDkzLCAweDAwOTYsIDB4MDA5QywgMHg4MDk5LCAweDAwODgsIDB4ODA4RCwgMHg4MDg3LCAweDAwODIsCiAgICAweDgxODMsIDB4MDE4NiwgMHgwMThDLCAweDgxODksIDB4MDE5OCwgMHg4MTlELCAweDgxOTcsIDB4MDE5MiwgMHgwMUIwLCAweDgxQjUsIDB4ODFCRiwgMHgwMUJBLCAweDgxQUIsIDB4MDFBRSwgMHgwMUE0LCAweDgxQTEsCiAgICAweDAxRTAsIDB4ODFFNSwgMHg4MUVGLCAweDAxRUEsIDB4ODFGQiwgMHgwMUZFLCAweDAxRjQsIDB4ODFGMSwgMHg4MUQzLCAweDAxRDYsIDB4MDFEQywgMHg4MUQ5LCAweDAxQzgsIDB4ODFDRCwgMHg4MUM3LCAweDAxQzIsCiAgICAweDAxNDAsIDB4ODE0NSwgMHg4MTRGLCAweDAxNEEsIDB4ODE1QiwgMHgwMTVFLCAweDAxNTQsIDB4ODE1MSwgMHg4MTczLCAweDAxNzYsIDB4MDE3QywgMHg4MTc5LCAweDAxNjgsIDB4ODE2RCwgMHg4MTY3LCAweDAxNjIsCiAgICAweDgxMjMsIDB4MDEyNiwgMHgwMTJDLCAweDgxMjksIDB4MDEzOCwgMHg4MTNELCAweDgxMzcsIDB4MDEzMiwgMHgwMTEwLCAweDgxMTUsIDB4ODExRiwgMHgwMTFBLCAweDgxMEIsIDB4MDEwRSwgMHgwMTA0LCAweDgxMDEsCiAgICAweDgzMDMsIDB4MDMwNiwgMHgwMzBDLCAweDgzMDksIDB4MDMxOCwgMHg4MzFELCAweDgzMTcsIDB4MDMxMiwgMHgwMzMwLCAweDgzMzUsIDB4ODMzRiwgMHgwMzNBLCAweDgzMkIsIDB4MDMyRSwgMHgwMzI0LCAweDgzMjEsCiAgICAweDAzNjAsIDB4ODM2NSwgMHg4MzZGLCAweDAzNkEsIDB4ODM3QiwgMHgwMzdFLCAweDAzNzQsIDB4ODM3MSwgMHg4MzUzLCAweDAzNTYsIDB4MDM1QywgMHg4MzU5LCAweDAzNDgsIDB4ODM0RCwgMHg4MzQ3LCAweDAzNDIsCiAgICAweDAzQzAsIDB4ODNDNSwgMHg4M0NGLCAweDAzQ0EsIDB4ODNEQiwgMHgwM0RFLCAweDAzRDQsIDB4ODNEMSwgMHg4M0YzLCAweDAzRjYsIDB4MDNGQywgMHg4M0Y5LCAweDAzRTgsIDB4ODNFRCwgMHg4M0U3LCAweDAzRTIsCiAgICAweDgzQTMsIDB4MDNBNiwgMHgwM0FDLCAweDgzQTksIDB4MDNCOCwgMHg4M0JELCAweDgzQjcsIDB4MDNCMiwgMHgwMzkwLCAweDgzOTUsIDB4ODM5RiwgMHgwMzlBLCAweDgzOEIsIDB4MDM4RSwgMHgwMzg0LCAweDgzODEsCiAgICAweDAyODAsIDB4ODI4NSwgMHg4MjhGLCAweDAyOEEsIDB4ODI5QiwgMHgwMjlFLCAweDAyOTQsIDB4ODI5MSwgMHg4MkIzLCAweDAyQjYsIDB4MDJCQywgMHg4MkI5LCAweDAyQTgsIDB4ODJBRCwgMHg4MkE3LCAweDAyQTIsCiAgICAweDgyRTMsIDB4MDJFNiwgMHgwMkVDLCAweDgyRTksIDB4MDJGOCwgMHg4MkZELCAweDgyRjcsIDB4MDJGMiwgMHgwMkQwLCAweDgyRDUsIDB4ODJERiwgMHgwMkRBLCAweDgyQ0IsIDB4MDJDRSwgMHgwMkM0LCAweDgyQzEsCiAgICAweDgyNDMsIDB4MDI0NiwgMHgwMjRDLCAweDgyNDksIDB4MDI1OCwgMHg4MjVELCAweDgyNTcsIDB4MDI1MiwgMHgwMjcwLCAweDgyNzUsIDB4ODI3RiwgMHgwMjdBLCAweDgyNkIsIDB4MDI2RSwgMHgwMjY0LCAweDgyNjEsCiAgICAweDAyMjAsIDB4ODIyNSwgMHg4MjJGLCAweDAyMkEsIDB4ODIzQiwgMHgwMjNFLCAweDAyMzQsIDB4ODIzMSwgMHg4MjEzLCAweDAyMTYsIDB4MDIxQywgMHg4MjE5LCAweDAyMDgsIDB4ODIwRCwgMHg4MjA3LCAweDAyMDIKXSk7CmNvbnN0IEhDQUtub3duS2V5cyA9IFsKICAgIC8vIFtsb3dlciAzMiBiaXRzLCBoaWdoZXIgMzIgYml0c10KICAgIC8vIGVnLiA2NjE1NTE4RThFQ0VENDQ3ID0+IFsweDhFQ0VENDQ3LCAweDY2MTU1MThFXQogICAgLy8gc291cmNlOiBodHRwczovL2dpdGh1Yi5jb20vVGhlYWxleGJhcm5leS9WR0F1ZGlvL2Jsb2IvbWFzdGVyL2RvY3MvYXVkaW8tZm9ybWF0cy9oY2EvZW5jcnlwdGlvbi1rZXlzLm1kCiAgICBbMHgwMDAwMDRDOCwgMHgwMDAwMDAwMF0sCiAgICBbMHgwMDAwMDk3OCwgMHgwMDAwMDAwMF0sCiAgICBbMHgwMDAwMjJDRSwgMHgwMDAwMDAwMF0sCiAgICBbMHgwMDAwMzAzOSwgMHgwMDAwMDAwMF0sCiAgICBbMHgwMDFEMTQ5QSwgMHgwMDAwMDAwMF0sCiAgICBbMHgwMDkxMzRGQywgMHgwMDAwMDAwMF0sCiAgICBbMHgwMTJDOUE1MywgMHgwMDAwMDAwMF0sCiAgICBbMHgwMTJFQkNDQSwgMHgwMDAwMDAwMF0sCiAgICBbMHgwMTJGQ0ZERiwgMHgwMDAwMDAwMF0sCiAgICBbMHgwMTM5NUM1MSwgMHgwMDAwMDAwMF0sCiAgICBbMHgwRTYyQkVGMCwgMHgwMDAwMDAwMF0sCiAgICBbMHgwRTg4NDczQywgMHgwMDAwMDAwMF0sCiAgICBbMHg0OTkxMzU1NiwgMHgwMDAwMDAwMF0sCiAgICBbMHg3N0VEQTEzQSwgMHgwMDAwMDAwMF0sCiAgICBbMHg3N0VERjIxQywgMHgwMDAwMDAwMF0sCiAgICBbMHg3MjM1Q0IyOSwgMHgwMDAwMDAwQl0sCiAgICBbMHgyMjJBQUE4NCwgMHgwMDAwMDQ5N10sCiAgICBbMHhBNkFENjEyNSwgMHgwMDAwMUI4NV0sCiAgICBbMHhGMjdFM0IyMiwgMHgwMDAwMzY1N10sCiAgICBbMHg5Nzk3OEE5NiwgMHgwMDAwOTY4QV0sCiAgICBbMHg5NTM1NkM3MiwgMHgwMDAyMzU0RV0sCiAgICBbMHhCQzczMUE4NSwgMHgwMDAyQjg3NV0sCiAgICBbMHgwREM1N0Y0OCwgMHgwMDExRENERF0sCiAgICBbMHgxMDI0QURFOSwgMHgwMDE4OURGQl0sCiAgICBbMHg2MzRCNUYwNywgMHgwMDIwNTVDOF0sCiAgICBbMHhBMTFDQ0ZCMCwgMHgwMDY4ODg4NF0sCiAgICBbMHg4RDBDMTBGRCwgMHgwMEEwNkEwQl0sCiAgICBbMHhDQzU1NDYzOSwgMHgwMERCRTFBQl0sCiAgICBbMHg1OTkwRkI1RSwgMHgwMjA1MUFGMl0sCiAgICBbMHhGNTgxNkEyQSwgMHgyOUFGRTkxMV0sCiAgICBbMHg4MzY1MzY5OSwgMHg0MzhCRjFGOF0sCiAgICBbMHhCOEU2QzZEMiwgMHg0M0U0RUE2Ml0sCiAgICBbMHhDMzA5MTM2NiwgMHg3Q0VDODFGN10sCiAgICBbMHg5MkVCRjQ2NCwgMHg3RTg5NjMxOF0sCiAgICBbMHgzMERCRTFBQiwgMHhDQzU1NDYzOV0sCiAgICBbMHhFMDc0ODk3OCwgMHhDRjIyMkYxRl0sCiAgICBbMHgzNDNEMDAwMCwgMHhEQjVCNjFCOF0sCiAgICBbMHhBQjQxNEJBMSwgMHhGREFFNTMxQV0sCiAgICBbMHhGRkZGRkZGRiwgMHhGRkZGRkZGRl0sCiAgICAvLyBzb3VyY2U6IGh0dHBzOi8vZ2l0aHViLmNvbS92Z21zdHJlYW0vdmdtc3RyZWFtL2Jsb2IvMzZmNGRmZWFiNDFhZGY4ZjhmZjA4NDc3ZGMwNjJmOGM3NmIwMDNkOC9zcmMvbWV0YS9oY2Ffa2V5cy5oI0wxMDU5CiAgICBbMHg4RUNFRDQ0NywgMHg2NjE1NTE4RV0sIC8vIEhlYXZlbiBCdXJucyBSZWQgKEFuZHJvaWQpCl07CmNsYXNzIEhDQUNpcGhlciB7CiAgICBpbml0MSgpIHsKICAgICAgICBmb3IgKGxldCBpID0gMSwgdiA9IDA7IGkgPCAweEZGOyBpKyspIHsKICAgICAgICAgICAgdiA9ICh2ICogMTMgKyAxMSkgJiAweEZGOwogICAgICAgICAgICBpZiAodiA9PSAwIHx8IHYgPT0gMHhGRikKICAgICAgICAgICAgICAgIHYgPSAodiAqIDEzICsgMTEpICYgMHhGRjsKICAgICAgICAgICAgdGhpcy5fdGFibGVbaV0gPSB2OwogICAgICAgIH0KICAgICAgICB0aGlzLl90YWJsZVswXSA9IDA7CiAgICAgICAgdGhpcy5fdGFibGVbMHhGRl0gPSAweEZGOwogICAgfQogICAgaW5pdDU2KCkgewogICAgICAgIGxldCBrZXkxID0gdGhpcy5kdjEuZ2V0VWludDMyKDAsIHRydWUpOwogICAgICAgIGxldCBrZXkyID0gdGhpcy5kdjIuZ2V0VWludDMyKDAsIHRydWUpOwogICAgICAgIGlmICgha2V5MSkKICAgICAgICAgICAga2V5Mi0tOwogICAgICAgIGtleTEtLTsKICAgICAgICB0aGlzLmR2MS5zZXRVaW50MzIoMCwga2V5MSwgdHJ1ZSk7CiAgICAgICAgdGhpcy5kdjIuc2V0VWludDMyKDAsIGtleTIsIHRydWUpOwogICAgICAgIGxldCB0MSA9IHRoaXMuZ2V0Qnl0ZXNPZlR3b0tleXMoKTsKICAgICAgICBsZXQgdDIgPSBuZXcgVWludDhBcnJheShbCiAgICAgICAgICAgIHQxWzFdLCB0MVsxXSBeIHQxWzZdLCB0MVsyXSBeIHQxWzNdLAogICAgICAgICAgICB0MVsyXSwgdDFbMl0gXiB0MVsxXSwgdDFbM10gXiB0MVs0XSwKICAgICAgICAgICAgdDFbM10sIHQxWzNdIF4gdDFbMl0sIHQxWzRdIF4gdDFbNV0sCiAgICAgICAgICAgIHQxWzRdLCB0MVs0XSBeIHQxWzNdLCB0MVs1XSBeIHQxWzZdLAogICAgICAgICAgICB0MVs1XSwgdDFbNV0gXiB0MVs0XSwgdDFbNl0gXiB0MVsxXSwKICAgICAgICAgICAgdDFbNl0KICAgICAgICBdKTsKICAgICAgICBsZXQgdDMgPSBuZXcgVWludDhBcnJheSgweDEwMCk7CiAgICAgICAgbGV0IHQzMSA9IG5ldyBVaW50OEFycmF5KDB4MTApOwogICAgICAgIGxldCB0MzIgPSBuZXcgVWludDhBcnJheSgweDEwKTsKICAgICAgICB0aGlzLmNyZWF0ZVRhYmxlKHQzMSwgdDFbMF0pOwogICAgICAgIGZvciAobGV0IGkgPSAwLCB0ID0gMDsgaSA8IDB4MTA7IGkrKykgewogICAgICAgICAgICB0aGlzLmNyZWF0ZVRhYmxlKHQzMiwgdDJbaV0pOwogICAgICAgICAgICBsZXQgdiA9IHQzMVtpXSA8PCA0OwogICAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IDB4MTA7IGorKykgewogICAgICAgICAgICAgICAgdDNbdCsrXSA9IHYgfCB0MzJbal07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaSA9IDAsIHYgPSAwLCB0ID0gMTsgaSA8IDB4MTAwOyBpKyspIHsKICAgICAgICAgICAgdiA9ICh2ICsgMHgxMSkgJiAweEZGOwogICAgICAgICAgICBsZXQgYSA9IHQzW3ZdOwogICAgICAgICAgICBpZiAoYSAhPSAwICYmIGEgIT0gMHhGRikKICAgICAgICAgICAgICAgIHRoaXMuX3RhYmxlW3QrK10gPSBhOwogICAgICAgIH0KICAgICAgICB0aGlzLl90YWJsZVswXSA9IDA7CiAgICAgICAgdGhpcy5fdGFibGVbMHhGRl0gPSAweEZGOwogICAgfQogICAgY3JlYXRlVGFibGUociwga2V5KSB7CiAgICAgICAgbGV0IG11bCA9ICgoa2V5ICYgMSkgPDwgMykgfCA1OwogICAgICAgIGxldCBhZGQgPSAoa2V5ICYgMHhFKSB8IDE7CiAgICAgICAgbGV0IHQgPSAwOwogICAgICAgIGtleSA+Pj0gNDsKICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDB4MTA7IGkrKykgewogICAgICAgICAgICBrZXkgPSAoa2V5ICogbXVsICsgYWRkKSAmIDB4RjsKICAgICAgICAgICAgclt0KytdID0ga2V5OwogICAgICAgIH0KICAgIH0KICAgIGludmVydFRhYmxlKCkgewogICAgICAgIC8vIGFjdHVhbGx5LCB0aGlzIG1ldGhvZCBzd2l0Y2ggdGhlIG1vZGUgYmV0d2VlbiBlbmNyeXB0L2RlY3J5cHQKICAgICAgICB0aGlzLmVuY3J5cHQgPSAhdGhpcy5lbmNyeXB0OwogICAgICAgIGxldCBfb2xkX3RhYmxlID0gdGhpcy5fdGFibGUuc2xpY2UoMCk7CiAgICAgICAgbGV0IGJpdE1hcCA9IG5ldyBVaW50MTZBcnJheSgxNik7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCAyNTY7IGkrKykgewogICAgICAgICAgICAvLyBpbnZlcnQga2V5IGFuZCB2YWx1ZQogICAgICAgICAgICBsZXQga2V5ID0gX29sZF90YWJsZVtpXTsKICAgICAgICAgICAgbGV0IHZhbCA9IGk7CiAgICAgICAgICAgIC8vIGNoZWNrIGZvciBpbmNvbnNpc3RlbmN5CiAgICAgICAgICAgIGxldCBoaWdoZXI0ID0ga2V5ID4+IDQgJiAweDBGOwogICAgICAgICAgICBsZXQgbG93ZXI0ID0ga2V5ICYgMHgwRjsKICAgICAgICAgICAgbGV0IGZsYWcgPSAweDAxIDw8IGxvd2VyNDsKICAgICAgICAgICAgaWYgKGJpdE1hcFtoaWdoZXI0XSAmIGZsYWcpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIl90YWJsZSBpcyBub3QgYmlqZWN0aXZlIik7CiAgICAgICAgICAgIC8vIHVwZGF0ZSB0YWJsZQogICAgICAgICAgICB0aGlzLl90YWJsZVtrZXldID0gdmFsOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIGdldFR5cGUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY2lwaGVyVHlwZTsKICAgIH0KICAgIGdldEVuY3J5cHQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZW5jcnlwdDsKICAgIH0KICAgIGdldEJ5dGVzT2ZUd29LZXlzKCkgewogICAgICAgIGxldCBidWYgPSBuZXcgVWludDhBcnJheSg4KTsKICAgICAgICBidWYuc2V0KG5ldyBVaW50OEFycmF5KHRoaXMua2V5MWJ1ZiksIDApOwogICAgICAgIGJ1Zi5zZXQobmV3IFVpbnQ4QXJyYXkodGhpcy5rZXkyYnVmKSwgNCk7CiAgICAgICAgcmV0dXJuIGJ1ZjsKICAgIH0KICAgIHN0YXRpYyBiaWdVaW50TXVsdGlwbHlMRShkdiwgZmFjdG9yKSB7CiAgICAgICAgY29uc3QgcmVzdWx0ID0gbmV3IERhdGFWaWV3KG5ldyBBcnJheUJ1ZmZlcihkdi5ieXRlTGVuZ3RoICsgNCkpOwogICAgICAgIGZhY3RvciA9IE1hdGgudHJ1bmMoZmFjdG9yKTsKICAgICAgICBBcnJheS5mcm9tKHsgbGVuZ3RoOiBkdi5ieXRlTGVuZ3RoIH0sIChfLCBpKSA9PiBmYWN0b3IgKiBkdi5nZXRVaW50OChpKSkKICAgICAgICAgICAgLmZvckVhY2goKHYsIGkpID0+IHsKICAgICAgICAgICAgdiArPSByZXN1bHQuZ2V0VWludDMyKGksIHRydWUpOwogICAgICAgICAgICByZXN1bHQuc2V0VWludDMyKGksIHYsIHRydWUpOwogICAgICAgICAgICB2IC09IHJlc3VsdC5nZXRVaW50MzIoaSwgdHJ1ZSk7CiAgICAgICAgICAgIGlmICh2ID4gMCkgewogICAgICAgICAgICAgICAgdiAvPSAweDEwMDAwMDAwMDsKICAgICAgICAgICAgICAgIGZvciAobGV0IGogPSBpICsgNDsgaiA8IHJlc3VsdC5ieXRlTGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICB2ICs9IHJlc3VsdC5nZXRVaW50OChqKTsKICAgICAgICAgICAgICAgICAgICByZXN1bHQuc2V0VWludDgoaiwgdik7CiAgICAgICAgICAgICAgICAgICAgdiAtPSByZXN1bHQuZ2V0VWludDgoaik7CiAgICAgICAgICAgICAgICAgICAgaWYgKHYgPiAwKQogICAgICAgICAgICAgICAgICAgICAgICB2IC89IDB4MTAwOwogICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgc3RhdGljIG1peFdpdGhTdWJrZXkoa2V5MSwga2V5Miwgc3Via2V5KSB7CiAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL3ZnbXN0cmVhbS92Z21zdHJlYW0vYmxvYi84NGNmZWFmOTkzOTgyYjQyNDVjZTc1OTNkY2JiNjgxNmM1YWVlOGJjL3NyYy9jb2RpbmcvaGNhX2RlY29kZXIuYyNMMzEzCiAgICAgICAgLyoKICAgICAgICAgICAgaWYgKHN1YmtleSkgewogICAgICAgICAgICAgICAga2V5Y29kZSA9IGtleWNvZGUgKiAoICgodWludDY0X3Qpc3Via2V5IDw8IDE2dSkgfCAoKHVpbnQxNl90KX5zdWJrZXkgKyAydSkgKTsKICAgICAgICAgICAgfQogICAgICAgICovCiAgICAgICAgaWYgKHN1YmtleSA9PSBudWxsKQogICAgICAgICAgICByZXR1cm4geyBrZXkxOiBrZXkxLCBrZXkyOiBrZXkyIH07CiAgICAgICAga2V5MSA9IEhDQUNpcGhlci5wYXJzZUtleShrZXkxKTsKICAgICAgICBrZXkyID0gSENBQ2lwaGVyLnBhcnNlS2V5KGtleTIpOwogICAgICAgIHN1YmtleSA9IEhDQUNpcGhlci5wYXJzZUtleShzdWJrZXkpOwogICAgICAgIGNvbnN0IGtleWR2ID0gbmV3IERhdGFWaWV3KG5ldyBBcnJheUJ1ZmZlcig4KSk7CiAgICAgICAga2V5ZHYuc2V0VWludDMyKDAsIGtleTEsIHRydWUpOwogICAgICAgIGtleWR2LnNldFVpbnQzMig0LCBrZXkyLCB0cnVlKTsKICAgICAgICBjb25zdCBzdWJrZXlkdiA9IG5ldyBEYXRhVmlldyhuZXcgQXJyYXlCdWZmZXIoNCkpOwogICAgICAgIHN1YmtleWR2LnNldFVpbnQxNigyLCBzdWJrZXksIHRydWUpOwogICAgICAgIGlmIChzdWJrZXlkdi5nZXRVaW50MTYoMikgPT0gMCkKICAgICAgICAgICAgcmV0dXJuIHsga2V5MToga2V5MSwga2V5Mjoga2V5MiB9OyAvL3VuY2hhbmdlZAogICAgICAgIHN1YmtleWR2LnNldFVpbnQxNigwLCB+c3Via2V5ZHYuZ2V0VWludDE2KDIsIHRydWUpICsgMiwgdHJ1ZSk7CiAgICAgICAgc3Via2V5ID0gc3Via2V5ZHYuZ2V0VWludDMyKDAsIHRydWUpOwogICAgICAgIGNvbnN0IG1peGVka2V5ZHYgPSB0aGlzLmJpZ1VpbnRNdWx0aXBseUxFKGtleWR2LCBzdWJrZXkpOwogICAgICAgIGtleTEgPSBtaXhlZGtleWR2LmdldFVpbnQzMigwLCB0cnVlKTsKICAgICAgICBrZXkyID0gbWl4ZWRrZXlkdi5nZXRVaW50MzIoNCwgdHJ1ZSk7CiAgICAgICAgcmV0dXJuIHsga2V5MToga2V5MSwga2V5Mjoga2V5MiB9OwogICAgfQogICAgc2V0S2V5cyhrZXkxLCBrZXkyKSB7CiAgICAgICAgdGhpcy5kdjEuc2V0VWludDMyKDAsIGtleTEsIHRydWUpOwogICAgICAgIHRoaXMuZHYyLnNldFVpbnQzMigwLCBrZXkyLCB0cnVlKTsKICAgICAgICB0aGlzLmluaXQ1NigpOwogICAgICAgIHRoaXMuY2lwaGVyVHlwZSA9IDB4Mzg7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBzZXRUb0RlZktleXMoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc2V0S2V5cyhIQ0FDaXBoZXIuZGVmS2V5MSwgSENBQ2lwaGVyLmRlZktleTIpOwogICAgfQogICAgc2V0VG9Ob0tleSgpIHsKICAgICAgICB0aGlzLmluaXQxKCk7CiAgICAgICAgdGhpcy5jaXBoZXJUeXBlID0gMHgwMTsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIG1hc2soYmxvY2ssIG9mZnNldCwgc2l6ZSkgewogICAgICAgIC8vIGVuY3J5cHQgb3IgZGVjcnlwdCBibG9jayBkYXRhCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaXplOyBpKyspCiAgICAgICAgICAgIGJsb2NrW29mZnNldCArIGldID0gdGhpcy5fdGFibGVbYmxvY2tbb2Zmc2V0ICsgaV1dOwogICAgfQogICAgc3RhdGljIGlzSENBSGVhZGVyTWFza2VkKGhjYSkgewogICAgICAgIC8vIGZhc3QgJiBkaXJ0eSB3YXkgdG8gZGV0ZXJtaW5lIHdoZXRoZXIgZW5jcnlwdGVkLCBub3QgcmVjb21tZW5kZWQKICAgICAgICBpZiAoaGNhWzBdICYgMHg4MCB8fCBoY2FbMV0gJiAweDgwIHx8IGhjYVsyXSAmIDB4ODApCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIGVsc2UKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgc3RhdGljIHBhcnNlS2V5KGtleSkgewogICAgICAgIHN3aXRjaCAodHlwZW9mIGtleSkgewogICAgICAgICAgICBjYXNlICJudW1iZXIiOgogICAgICAgICAgICAgICAgcmV0dXJuIGtleTsKICAgICAgICAgICAgY2FzZSAic3RyaW5nIjoKICAgICAgICAgICAgICAgIC8vIGF2b2lkIGFtYmlndWl0eTogYWx3YXlzIHRyZWF0IGFzIGhleAogICAgICAgICAgICAgICAgaWYgKCFrZXkubWF0Y2goL14weC8pKQogICAgICAgICAgICAgICAgICAgIGtleSA9ICIweCIgKyBrZXk7CiAgICAgICAgICAgICAgICBrZXkgPSBwYXJzZUludChrZXkpOwogICAgICAgICAgICAgICAgaWYgKGlzTmFOKGtleSkpCiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJjYW5ub3QgcGFyc2UgYXMgaW50ZWdlciIpOwogICAgICAgICAgICAgICAgcmV0dXJuIGtleTsKICAgICAgICAgICAgY2FzZSAib2JqZWN0IjoKICAgICAgICAgICAgICAgIC8vIGF2b2lkIGVuZGlhbm5lc3MgYW1iaWd1aXR5OiBvbmx5IGFjY2VwdGluZyBVaW50OEFycmF5LCB0aGVuIHJlYWQgYXMgbGl0dGxlIGVuZGlhbgogICAgICAgICAgICAgICAgaWYgKGtleSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkgJiYga2V5LmJ5dGVMZW5ndGggPT0gNCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgRGF0YVZpZXcoa2V5LmJ1ZmZlciwga2V5LmJ5dGVPZmZzZXQsIGtleS5ieXRlTGVuZ3RoKS5nZXRVaW50MzIoMCwgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImNhbiBvbmx5IGFjY2VwdCBudW1iZXIvaGV4IHN0cmluZy9VaW50OEFycmF5WzRdIik7CiAgICAgICAgfQogICAgfQogICAgY29uc3RydWN0b3Ioa2V5MSwga2V5MikgewogICAgICAgIHRoaXMuY2lwaGVyVHlwZSA9IDA7CiAgICAgICAgdGhpcy5lbmNyeXB0ID0gZmFsc2U7CiAgICAgICAgdGhpcy5rZXkxYnVmID0gbmV3IEFycmF5QnVmZmVyKDQpOwogICAgICAgIHRoaXMua2V5MmJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcig0KTsKICAgICAgICB0aGlzLl90YWJsZSA9IG5ldyBVaW50OEFycmF5KDI1Nik7CiAgICAgICAgdGhpcy5kdjEgPSBuZXcgRGF0YVZpZXcodGhpcy5rZXkxYnVmKTsKICAgICAgICB0aGlzLmR2MiA9IG5ldyBEYXRhVmlldyh0aGlzLmtleTJidWYpOwogICAgICAgIGlmIChrZXkxID09IG51bGwpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigibm8ga2V5cyBnaXZlbi4gdXNlIFwiZGVmYXVsdGtleVwiIGlmIHlvdSB3YW50IHRvIHVzZSB0aGUgZGVmYXVsdCBrZXkiKTsKICAgICAgICBzd2l0Y2ggKGtleTEpIHsKICAgICAgICAgICAgY2FzZSAibm9uZSI6CiAgICAgICAgICAgIGNhc2UgIm5va2V5IjoKICAgICAgICAgICAgY2FzZSAibm9LZXkiOgogICAgICAgICAgICBjYXNlICJubyBrZXkiOgogICAgICAgICAgICBjYXNlICJub19LZXkiOgogICAgICAgICAgICAgICAgdGhpcy5zZXRUb05vS2V5KCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAiZGVmYXVsdGtleSI6CiAgICAgICAgICAgIGNhc2UgImRlZmF1bHRLZXkiOgogICAgICAgICAgICBjYXNlICJkZWZhdWx0IGtleSI6CiAgICAgICAgICAgIGNhc2UgImRlZmF1bHRfa2V5IjoKICAgICAgICAgICAgICAgIHRoaXMuc2V0VG9EZWZLZXlzKCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIGtleTEgPSBIQ0FDaXBoZXIucGFyc2VLZXkoa2V5MSk7CiAgICAgICAgICAgICAgICBpZiAoa2V5MiA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAga2V5MiA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBrZXkyID0gSENBQ2lwaGVyLnBhcnNlS2V5KGtleTIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5zZXRLZXlzKGtleTEsIGtleTIpOwogICAgICAgIH0KICAgIH0KfQpIQ0FDaXBoZXIuZGVmS2V5MSA9IDB4MDEzOTVDNTE7CkhDQUNpcGhlci5kZWZLZXkyID0gMHgwMDAwMDAwMDsKLy8gaHR0cHM6Ly9naXRodWIuY29tL3ZnbXN0cmVhbS92Z21zdHJlYW0vYmxvYi80ZWVjZGFkYTlhMDNhNzNhZjBjN2MxN2Y1Y2Q2ZTA4NTE4ZmQ3ZTNmL3NyYy9tZXRhL2F3Yi5jI0wxMwpleHBvcnQgY2xhc3MgQVdCQXJjaGl2ZSB7CiAgICBzdGF0aWMgaXNBV0IoZmlsZSkgewogICAgICAgIGNvbnN0IGR2ID0gbmV3IERhdGFWaWV3KGZpbGUuYnVmZmVyLCBmaWxlLmJ5dGVPZmZzZXQsIGZpbGUuYnl0ZUxlbmd0aCk7CiAgICAgICAgY29uc3QgbWFnaWMgPSAweDQxNDY1MzMyOyAvLyAiQUZTMiIgaW4gVWludDMyQkUKICAgICAgICByZXR1cm4gZHYuZ2V0VWludDMyKDAsIGZhbHNlKSA9PSBtYWdpYzsKICAgIH0KICAgIGNvbnN0cnVjdG9yKGF3YikgewogICAgICAgIGlmICghQVdCQXJjaGl2ZS5pc0FXQihhd2IpKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYG5vdCBBV0IgYXJjaGl2ZWApOwogICAgICAgIGNvbnN0IGR2ID0gbmV3IERhdGFWaWV3KGF3Yi5idWZmZXIsIGF3Yi5ieXRlT2Zmc2V0LCBhd2IuYnl0ZUxlbmd0aCk7CiAgICAgICAgdGhpcy52ZXJzaW9uID0gZHYuZ2V0VWludDgoMHgwNCk7CiAgICAgICAgdGhpcy5vZmZzZXRTaXplID0gZHYuZ2V0VWludDgoMHgwNSk7CiAgICAgICAgdGhpcy53YXZlSWRBbGlnbm1lbnQgPSBkdi5nZXRVaW50MTYoMHgwNiwgdHJ1ZSk7CiAgICAgICAgdGhpcy50b3RhbFN1YnNvbmdzID0gZHYuZ2V0SW50MzIoMHgwOCwgdHJ1ZSk7CiAgICAgICAgdGhpcy5vZmZzZXRBbGlnbm1lbnQgPSBkdi5nZXRVaW50MTYoMHgwYywgdHJ1ZSk7CiAgICAgICAgdGhpcy5zdWJrZXkgPSBkdi5nZXRVaW50MTYoMHgwZSwgdHJ1ZSk7CiAgICAgICAgbGV0IGZ0ZWxsID0gMHgxMDsKICAgICAgICB0aGlzLmhjYUZpbGVzID0gQXJyYXkuZnJvbSh7IGxlbmd0aDogdGhpcy50b3RhbFN1YnNvbmdzIH0sICgpID0+IHsKICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gZnRlbGw7CiAgICAgICAgICAgIGZ0ZWxsICs9IHRoaXMud2F2ZUlkQWxpZ25tZW50OwogICAgICAgICAgICByZXR1cm4geyB3YXZlSUQ6IGR2LmdldFVpbnQxNihvZmZzZXQsIHRydWUpIH07CiAgICAgICAgfSkubWFwKChvKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IGZ0ZWxsOwogICAgICAgICAgICBmdGVsbCArPSB0aGlzLm9mZnNldFNpemUgKiAyOwogICAgICAgICAgICBzd2l0Y2ggKHRoaXMub2Zmc2V0U2l6ZSkgewogICAgICAgICAgICAgICAgY2FzZSAweDA0OgogICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdhdmVJRDogby53YXZlSUQsCiAgICAgICAgICAgICAgICAgICAgICAgIG9mZnNldDogZHYuZ2V0VWludDMyKG9mZnNldCwgdHJ1ZSksCiAgICAgICAgICAgICAgICAgICAgICAgIG5leHQ6IGR2LmdldFVpbnQzMihvZmZzZXQgKyB0aGlzLm9mZnNldFNpemUsIHRydWUpLAogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBjYXNlIDB4MDI6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgd2F2ZUlEOiBvLndhdmVJRCwKICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0OiBkdi5nZXRVaW50MTYob2Zmc2V0LCB0cnVlKSwKICAgICAgICAgICAgICAgICAgICAgICAgbmV4dDogZHYuZ2V0VWludDE2KG9mZnNldCArIHRoaXMub2Zmc2V0U2l6ZSwgdHJ1ZSksCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBBV0I6IHVua25vd24gb2Zmc2V0IHNpemVgKTsKICAgICAgICAgICAgfQogICAgICAgIH0pLm1hcCgobykgPT4gewogICAgICAgICAgICAvLyBvZmZzZXQgYXJlIGFic29sdXRlIGJ1dCBzb21ldGltZXMgbWlzYWxpZ25lZCAoc3BlY2lhbGx5IGZpcnN0IHRoYXQganVzdCBwb2ludHMgdG8gb2Zmc2V0IHRhYmxlIGVuZCkKICAgICAgICAgICAgby5vZmZzZXQgKz0gKG8ub2Zmc2V0ICUgdGhpcy5vZmZzZXRBbGlnbm1lbnQpID8KICAgICAgICAgICAgICAgIHRoaXMub2Zmc2V0QWxpZ25tZW50IC0gKG8ub2Zmc2V0ICUgdGhpcy5vZmZzZXRBbGlnbm1lbnQpIDogMDsKICAgICAgICAgICAgby5uZXh0ICs9IChvLm5leHQgJSB0aGlzLm9mZnNldEFsaWdubWVudCkgJiYgby5uZXh0IDwgYXdiLmJ5dGVMZW5ndGggPwogICAgICAgICAgICAgICAgdGhpcy5vZmZzZXRBbGlnbm1lbnQgLSAoby5uZXh0ICUgdGhpcy5vZmZzZXRBbGlnbm1lbnQpIDogMDsKICAgICAgICAgICAgcmV0dXJuIHsgd2F2ZUlEOiBvLndhdmVJRCwgZmlsZTogYXdiLnN1YmFycmF5KG8ub2Zmc2V0LCBvLm5leHQpIH07CiAgICAgICAgfSk7CiAgICB9Cn0KY29uc3Qgc3VzcGVuZEF1ZGlvQ3R4SWZVbmxvY2tlZCA9IChhdWRpb0N0eCkgPT4gX19hd2FpdGVyKHZvaWQgMCwgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAvLyBzdXNwZW5kIGF1ZGlvIGNvbnRleHQgZm9yIG5vdwogICAgLy8gaW4gYXBwbGUgd2Via2l0IGl0J3MgYWxyZWFkeSBzdXNwZW5kZWQgJiBjYWxsaW5nIHN1c3BlbmQgeWV0IGFnYWluIHdpbGwgYmxvY2sKICAgIHN3aXRjaCAoYXVkaW9DdHguc3RhdGUpIHsKICAgICAgICBjYXNlICJydW5uaW5nIjoKICAgICAgICAgICAgeWllbGQgYXVkaW9DdHguc3VzcGVuZCgpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICBjYXNlICJzdXNwZW5kZWQiOgogICAgICAgICAgICBjb25zb2xlLndhcm4oYGF1ZGlvIGNvbnRleHQgZm9yIHNhbXBsZVJhdGU9JHthdWRpb0N0eC5zYW1wbGVSYXRlfSBpcyBzdXNwZW5kZWQvbG9ja2VkLGAKICAgICAgICAgICAgICAgICsgYCB3aGljaCBjYW4gb25seSBiZSByZXN1bWVkL3VubG9ja2VkIGJ5IFVJIGV2ZW50LmApOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBhdWRpbyBjb250ZXh0IGlzIG5laXRoZXIgcnVubmluZyBub3Igc3VzcGVuZGVkYCk7CiAgICB9Cn0pOwovLyBXZWJBdWRpby1iYXNlZCBsb29wIHBsYXllcgpleHBvcnQgY2xhc3MgSENBV2ViQXVkaW9Mb29wUGxheWVyIHsKICAgIGdldCB1bmxvY2tlZCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fdW5sb2NrZWQ7CiAgICB9CiAgICBnZXQgdm9sdW1lKCkgewogICAgICAgIHJldHVybiB0aGlzLmdhaW5Ob2RlLmdhaW4udmFsdWU7CiAgICB9CiAgICBzZXQgdm9sdW1lKHZhbCkgewogICAgICAgIGlmIChpc05hTih2YWwpKQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgaWYgKHZhbCA+IDEuMCkKICAgICAgICAgICAgdmFsID0gMS4wOwogICAgICAgIGlmICh2YWwgPCAwKQogICAgICAgICAgICB2YWwgPSAwOwogICAgICAgIHRoaXMuZ2Fpbk5vZGUuZ2Fpbi52YWx1ZSA9IHZhbDsKICAgIH0KICAgIGNvbnN0cnVjdG9yKGluZm8sIGJ1ZlNyYywgYXVkaW9DdHgsIHVubG9ja2VkLCBnYWluTm9kZSwgdm9sdW1lKSB7CiAgICAgICAgdGhpcy5zdGFydGVkID0gZmFsc2U7CiAgICAgICAgdGhpcy5jbG9zZWQgPSBmYWxzZTsKICAgICAgICB0aGlzLmluZm8gPSBpbmZvOwogICAgICAgIHRoaXMuYnVmU3JjID0gYnVmU3JjOwogICAgICAgIHRoaXMuYXVkaW9DdHggPSBhdWRpb0N0eDsKICAgICAgICB0aGlzLl91bmxvY2tlZCA9IHVubG9ja2VkOwogICAgICAgIHRoaXMuZ2Fpbk5vZGUgPSBnYWluTm9kZTsKICAgICAgICB0aGlzLnZvbHVtZSA9IHZvbHVtZTsKICAgIH0KICAgIHN0YXRpYyBjcmVhdGUoZGVjcnlwdGVkLCB3b3JrZXIsIHZvbHVtZSA9IDEwMCkgewogICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAgIGNvbnN0IGluZm8gPSBuZXcgSENBSW5mbyhkZWNyeXB0ZWQpOwogICAgICAgICAgICBpZiAoaW5mby5jaXBoZXIgIT0gMCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigib25seSBkZWNyeXB0ZWQgaGNhIGlzIGFjY2VwdGVkIik7CiAgICAgICAgICAgIGNvbnN0IGF1ZGlvQ3R4ID0gbmV3IEF1ZGlvQ29udGV4dCh7CiAgICAgICAgICAgICAgICBzYW1wbGVSYXRlOiBpbmZvLmZvcm1hdC5zYW1wbGluZ1JhdGUsCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCB3YXYgPSB5aWVsZCB3b3JrZXIuZGVjb2RlKGRlY3J5cHRlZCwgMTYpOyAvLyBmaXJzdAogICAgICAgICAgICBjb25zdCB1bmxvY2tlZCA9IHlpZWxkIHN1c3BlbmRBdWRpb0N0eElmVW5sb2NrZWQoYXVkaW9DdHgpOwogICAgICAgICAgICBjb25zdCBidWZmZXIgPSB5aWVsZCBhdWRpb0N0eC5kZWNvZGVBdWRpb0RhdGEod2F2LmJ1ZmZlcik7CiAgICAgICAgICAgIGNvbnN0IGJ1ZlNyYyA9IGF1ZGlvQ3R4LmNyZWF0ZUJ1ZmZlclNvdXJjZSgpOwogICAgICAgICAgICBidWZTcmMuYnVmZmVyID0gYnVmZmVyOwogICAgICAgICAgICBpZiAoaW5mby5sb29wICE9IG51bGwgJiYgaW5mby5sb29wLmVuZCA+IGluZm8ubG9vcC5zdGFydCkgewogICAgICAgICAgICAgICAgYnVmU3JjLmxvb3BTdGFydCA9IGluZm8ubG9vcFN0YXJ0VGltZTsKICAgICAgICAgICAgICAgIGJ1ZlNyYy5sb29wRW5kID0gaW5mby5sb29wRW5kVGltZTsKICAgICAgICAgICAgICAgIGJ1ZlNyYy5sb29wID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCBnYWluTm9kZSA9IGF1ZGlvQ3R4LmNyZWF0ZUdhaW4oKTsKICAgICAgICAgICAgYnVmU3JjLmNvbm5lY3QoZ2Fpbk5vZGUpOwogICAgICAgICAgICBnYWluTm9kZS5jb25uZWN0KGF1ZGlvQ3R4LmRlc3RpbmF0aW9uKTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBIQ0FXZWJBdWRpb0xvb3BQbGF5ZXIoaW5mbywgYnVmU3JjLCBhdWRpb0N0eCwgdW5sb2NrZWQsIGdhaW5Ob2RlLCB2b2x1bWUpOwogICAgICAgIH0pOwogICAgfQogICAgcGxheSgpIHsKICAgICAgICB0aGlzLmF1ZGlvQ3R4LnJlc3VtZSgpOwogICAgICAgIGlmICghdGhpcy5zdGFydGVkKSB7CiAgICAgICAgICAgIHRoaXMuYnVmU3JjLnN0YXJ0KCk7CiAgICAgICAgICAgIHRoaXMuc3RhcnRlZCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIC8vIG1hcmsgYXMgdW5sb2NrZWQKICAgICAgICBpZiAoIXRoaXMuX3VubG9ja2VkKSB7CiAgICAgICAgICAgIHRoaXMuX3VubG9ja2VkID0gdHJ1ZTsKICAgICAgICAgICAgY29uc29sZS53YXJuKGBhdWRpbyBjb250ZXh0IGZvciBzYW1wbGVSYXRlPSR7dGhpcy5hdWRpb0N0eC5zYW1wbGVSYXRlfSBpcyBub3cgcmVzdW1lZC91bmxvY2tlZGApOwogICAgICAgIH0KICAgIH0KICAgIHBhdXNlKCkgewogICAgICAgIGlmICh0aGlzLmF1ZGlvQ3R4LnN0YXRlICE9PSAicnVubmluZyIpCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB0aGlzLmF1ZGlvQ3R4LnN1c3BlbmQoKTsKICAgIH0KICAgIHN0b3AoKSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLl91bmxvY2tlZCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiYXVkaW8gY29udGV4dCBpcyBub3QgdW5sb2NrZWQsIGNhbm5vdCBzdG9wIGFuZCBkZXN0cm95Iik7CiAgICAgICAgICAgIGlmICh0aGlzLmNsb3NlZCkKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgdGhpcy5idWZTcmMuZGlzY29ubmVjdCgpOwogICAgICAgICAgICB5aWVsZCB0aGlzLmF1ZGlvQ3R4LmNsb3NlKCk7CiAgICAgICAgICAgIHRoaXMuY2xvc2VkID0gdHJ1ZTsKICAgICAgICB9KTsKICAgIH0KfQovLyBjb252ZXJ0IG5vbi10cmFuc2ZlcmFibGUgdHlwZWQgYXJyYXkgdG8gdHJhbnNmZXJhYmxlIGFycmF5IGJ1ZmZlcgpjbGFzcyBIQ0FUcmFuc1R5cGVkQXJyYXkgewogICAgc3RhdGljIGNvbnZlcnQoYXJnLCB0cmFuc2Zlckxpc3QpIHsKICAgICAgICBpZiAodGhpcy5nZXRUeXBlKGFyZykgIT0gbnVsbCkKICAgICAgICAgICAgcmV0dXJuIG5ldyBIQ0FUcmFuc1R5cGVkQXJyYXkoYXJnLCB0cmFuc2Zlckxpc3QpOwogICAgICAgIGVsc2UKICAgICAgICAgICAgcmV0dXJuIGFyZzsKICAgIH0KICAgIHN0YXRpYyByZXN0b3JlKGFyZykgewogICAgICAgIGNvbnN0IHR5cGUgPSB0aGlzLmdldFR5cGUoYXJnKTsKICAgICAgICBpZiAodHlwZSAhPSBudWxsICYmIHR5cGUuY29udmVydGVkKQogICAgICAgICAgICByZXR1cm4gYXJnLmFycmF5OwogICAgICAgIGVsc2UKICAgICAgICAgICAgcmV0dXJuIGFyZzsKICAgIH0KICAgIHN0YXRpYyBnZXRUeXBlKGFyZykgewogICAgICAgIGlmIChhcmcgPT0gbnVsbCB8fCB0eXBlb2YgYXJnICE9PSAib2JqZWN0IikKICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICBlbHNlIGlmIChhcmcgaW5zdGFuY2VvZiBJbnQ4QXJyYXkpCiAgICAgICAgICAgIHJldHVybiB7IGNvbnZlcnRlZDogZmFsc2UsIHR5cGU6ICJJbnQ4IiB9OwogICAgICAgIGVsc2UgaWYgKGFyZyBpbnN0YW5jZW9mIEludDE2QXJyYXkpCiAgICAgICAgICAgIHJldHVybiB7IGNvbnZlcnRlZDogZmFsc2UsIHR5cGU6ICJJbnQxNiIgfTsKICAgICAgICBlbHNlIGlmIChhcmcgaW5zdGFuY2VvZiBJbnQzMkFycmF5KQogICAgICAgICAgICByZXR1cm4geyBjb252ZXJ0ZWQ6IGZhbHNlLCB0eXBlOiAiSW50MzIiIH07CiAgICAgICAgZWxzZSBpZiAoYXJnIGluc3RhbmNlb2YgVWludDhBcnJheSkKICAgICAgICAgICAgcmV0dXJuIHsgY29udmVydGVkOiBmYWxzZSwgdHlwZTogIlVpbnQ4IiB9OwogICAgICAgIGVsc2UgaWYgKGFyZyBpbnN0YW5jZW9mIFVpbnQxNkFycmF5KQogICAgICAgICAgICByZXR1cm4geyBjb252ZXJ0ZWQ6IGZhbHNlLCB0eXBlOiAiVWludDE2IiB9OwogICAgICAgIGVsc2UgaWYgKGFyZyBpbnN0YW5jZW9mIFVpbnQzMkFycmF5KQogICAgICAgICAgICByZXR1cm4geyBjb252ZXJ0ZWQ6IGZhbHNlLCB0eXBlOiAiVWludDMyIiB9OwogICAgICAgIGVsc2UgaWYgKGFyZyBpbnN0YW5jZW9mIEZsb2F0MzJBcnJheSkKICAgICAgICAgICAgcmV0dXJuIHsgY29udmVydGVkOiBmYWxzZSwgdHlwZTogIkZsb2F0MzIiIH07CiAgICAgICAgZWxzZSBpZiAoYXJnIGluc3RhbmNlb2YgRmxvYXQ2NEFycmF5KQogICAgICAgICAgICByZXR1cm4geyBjb252ZXJ0ZWQ6IGZhbHNlLCB0eXBlOiAiRmxvYXQ2NCIgfTsKICAgICAgICBlbHNlIGlmIChhcmcuYnVmZmVyIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIgJiYgdHlwZW9mIGFyZy50eXBlID09PSAic3RyaW5nIikKICAgICAgICAgICAgcmV0dXJuIHsgY29udmVydGVkOiB0cnVlLCB0eXBlOiBhcmcudHlwZSB9OwogICAgICAgIGVsc2UKICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH0KICAgIGNvbnN0cnVjdG9yKHRhLCB0cmFuc2Zlckxpc3QpIHsKICAgICAgICBjb25zdCB0eXBlID0gSENBVHJhbnNUeXBlZEFycmF5LmdldFR5cGUodGEpOwogICAgICAgIGlmICh0eXBlICE9IG51bGwpCiAgICAgICAgICAgIHRoaXMudHlwZSA9IHR5cGUudHlwZTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigidW5leHBlY3RlZCB0eXBlIik7CiAgICAgICAgdGhpcy5idWZmZXIgPSB0YS5idWZmZXI7CiAgICAgICAgdGhpcy5ieXRlT2Zmc2V0ID0gdGEuYnl0ZU9mZnNldDsKICAgICAgICB0aGlzLmxlbmd0aCA9IHRhLmxlbmd0aDsKICAgICAgICBpZiAoIXRyYW5zZmVyTGlzdC5maW5kKCh2YWwpID0+IHZhbCA9PT0gdGhpcy5idWZmZXIpKQogICAgICAgICAgICB0cmFuc2Zlckxpc3QucHVzaCh0aGlzLmJ1ZmZlcik7CiAgICB9CiAgICBnZXQgYXJyYXkoKSB7CiAgICAgICAgc3dpdGNoICh0aGlzLnR5cGUpIHsKICAgICAgICAgICAgY2FzZSAiSW50OCI6IHJldHVybiBuZXcgSW50OEFycmF5KHRoaXMuYnVmZmVyLCB0aGlzLmJ5dGVPZmZzZXQsIHRoaXMubGVuZ3RoKTsKICAgICAgICAgICAgY2FzZSAiSW50MTYiOiByZXR1cm4gbmV3IEludDE2QXJyYXkodGhpcy5idWZmZXIsIHRoaXMuYnl0ZU9mZnNldCwgdGhpcy5sZW5ndGgpOwogICAgICAgICAgICBjYXNlICJJbnQzMiI6IHJldHVybiBuZXcgSW50MzJBcnJheSh0aGlzLmJ1ZmZlciwgdGhpcy5ieXRlT2Zmc2V0LCB0aGlzLmxlbmd0aCk7CiAgICAgICAgICAgIGNhc2UgIlVpbnQ4IjogcmV0dXJuIG5ldyBVaW50OEFycmF5KHRoaXMuYnVmZmVyLCB0aGlzLmJ5dGVPZmZzZXQsIHRoaXMubGVuZ3RoKTsKICAgICAgICAgICAgY2FzZSAiVWludDE2IjogcmV0dXJuIG5ldyBVaW50MTZBcnJheSh0aGlzLmJ1ZmZlciwgdGhpcy5ieXRlT2Zmc2V0LCB0aGlzLmxlbmd0aCk7CiAgICAgICAgICAgIGNhc2UgIlVpbnQzMiI6IHJldHVybiBuZXcgVWludDMyQXJyYXkodGhpcy5idWZmZXIsIHRoaXMuYnl0ZU9mZnNldCwgdGhpcy5sZW5ndGgpOwogICAgICAgICAgICBjYXNlICJGbG9hdDMyIjogcmV0dXJuIG5ldyBGbG9hdDMyQXJyYXkodGhpcy5idWZmZXIsIHRoaXMuYnl0ZU9mZnNldCwgdGhpcy5sZW5ndGgpOwogICAgICAgICAgICBjYXNlICJGbG9hdDY0IjogcmV0dXJuIG5ldyBGbG9hdDY0QXJyYXkodGhpcy5idWZmZXIsIHRoaXMuYnl0ZU9mZnNldCwgdGhpcy5sZW5ndGgpOwogICAgICAgIH0KICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInVuZXhwZWN0ZWQgdHlwZSIpOwogICAgfQp9CmNsYXNzIEhDQVRhc2sgewogICAgZ2V0IGFyZ3MoKSB7CiAgICAgICAgdmFyIF9jOwogICAgICAgIHJldHVybiAoX2MgPSB0aGlzLl9hcmdzKSA9PT0gbnVsbCB8fCBfYyA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2MubWFwKChhcmcpID0+IEhDQVRyYW5zVHlwZWRBcnJheS5yZXN0b3JlKGFyZykpOwogICAgfQogICAgZ2V0IGhhc1Jlc3VsdCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5faGFzUmVzdWx0OwogICAgfQogICAgZ2V0IHJlc3VsdCgpIHsKICAgICAgICBpZiAoIXRoaXMuX2hhc1Jlc3VsdCkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJubyByZXN1bHQiKTsKICAgICAgICByZXR1cm4gSENBVHJhbnNUeXBlZEFycmF5LnJlc3RvcmUodGhpcy5fcmVzdWx0KTsKICAgIH0KICAgIHNldCByZXN1bHQocmVzdWx0KSB7CiAgICAgICAgaWYgKHRoaXMuaGFzRXJyKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImFscmVhZHkgaGFzIGVycm9yLCBjYW5ub3Qgc2V0IHJlc3VsdCIpOwogICAgICAgIGlmICh0aGlzLl9oYXNSZXN1bHQpCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiY2Fubm90IHNldCByZXN1bHQgYWdhaW4iKTsKICAgICAgICB0aGlzLl9yZXN1bHQgPSBIQ0FUcmFuc1R5cGVkQXJyYXkuY29udmVydChyZXN1bHQsIHRoaXMudHJhbnNmZXJMaXN0KTsKICAgICAgICB0aGlzLl9oYXNSZXN1bHQgPSB0cnVlOwogICAgICAgIGlmICghdGhpcy5fcmVwbHlBcmdzKQogICAgICAgICAgICBkZWxldGUgdGhpcy5fYXJnczsKICAgIH0KICAgIGdldCBoYXNFcnIoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2Vyck1zZyAhPSBudWxsOwogICAgfQogICAgZ2V0IGVyck1zZygpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZXJyTXNnOwogICAgfQogICAgc2V0IGVyck1zZyhtc2cpIHsKICAgICAgICAvLyBjaGFuZ2luZyBlcnJNc2cgaXMgYWxsb3dlZCwgYnV0IGNsZWFyaW5nIGVyck1zZyBpcyBkaXNhbGxvd2VkCiAgICAgICAgaWYgKHR5cGVvZiBtc2cgIT09ICJzdHJpbmciKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImVycm9yIG1lc3NhZ2UgbXVzdCBiZSBhIHN0cmluZyIpOwogICAgICAgIGRlbGV0ZSB0aGlzLl9hcmdzOwogICAgICAgIGlmICh0aGlzLl9oYXNSZXN1bHQpIHsKICAgICAgICAgICAgLy8gY2xlYXIgcmVzdWx0IG9uIGVycm9yCiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9yZXN1bHQ7CiAgICAgICAgICAgIHRoaXMuX2hhc1Jlc3VsdCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnRyYW5zZmVyTGlzdCA9IFtdOwogICAgICAgICAgICB0aGlzLmFyZ3MuZm9yRWFjaCgoYXJnKSA9PiBIQ0FUcmFuc1R5cGVkQXJyYXkuY29udmVydChhcmcsIHRoaXMudHJhbnNmZXJMaXN0KSk7CiAgICAgICAgfQogICAgICAgIHRoaXMuX2Vyck1zZyA9IG1zZzsKICAgIH0KICAgIGNvbnN0cnVjdG9yKG9yaWdpbiwgdGFza0lELCBjbWQsIGFyZ3MsIHJlcGx5QXJncywgaXNEdW1teSkgewogICAgICAgIHRoaXMudHJhbnNmZXJMaXN0ID0gW107CiAgICAgICAgdGhpcy5faGFzUmVzdWx0ID0gZmFsc2U7CiAgICAgICAgdGhpcy5vcmlnaW4gPSBvcmlnaW47CiAgICAgICAgdGhpcy50YXNrSUQgPSB0YXNrSUQ7CiAgICAgICAgdGhpcy5jbWQgPSBjbWQ7CiAgICAgICAgdGhpcy5fYXJncyA9IGFyZ3MgPT09IG51bGwgfHwgYXJncyA9PT0gdm9pZCAwID8gdm9pZCAwIDogYXJncy5tYXAoKGFyZykgPT4gSENBVHJhbnNUeXBlZEFycmF5LmNvbnZlcnQoYXJnLCB0aGlzLnRyYW5zZmVyTGlzdCkpOwogICAgICAgIHRoaXMuX3JlcGx5QXJncyA9IHJlcGx5QXJnczsKICAgICAgICBpZiAoaXNEdW1teSAhPSBudWxsICYmIGlzRHVtbXkpCiAgICAgICAgICAgIHRoaXMuaXNEdW1teSA9IHRydWU7CiAgICB9CiAgICBzdGF0aWMgcmVjcmVhdGUodGFzaykgewogICAgICAgIGNvbnN0IHJlY3JlYXRlZCA9IG5ldyBIQ0FUYXNrKHRhc2sub3JpZ2luLCB0YXNrLnRhc2tJRCwgdGFzay5jbWQsIHRhc2suX2FyZ3MsIHRhc2suX3JlcGx5QXJncyk7CiAgICAgICAgaWYgKHRhc2suX2Vyck1zZyAhPSBudWxsKQogICAgICAgICAgICByZWNyZWF0ZWQuZXJyTXNnID0gdGFzay5fZXJyTXNnOwogICAgICAgIGVsc2UgaWYgKHRhc2suX2hhc1Jlc3VsdCkKICAgICAgICAgICAgcmVjcmVhdGVkLnJlc3VsdCA9IHRhc2suX3Jlc3VsdDsKICAgICAgICByZXR1cm4gcmVjcmVhdGVkOwogICAgfQp9CmNsYXNzIEhDQVRhc2tRdWV1ZSB7CiAgICBnZXROZXh0VGFza0lEKCkgewogICAgICAgIGNvbnN0IG1heCA9IEhDQVRhc2tRdWV1ZS5tYXhUYXNrSUQgLSAxOwogICAgICAgIGlmICh0aGlzLl9sYXN0VGFza0lEIDwgMCB8fCB0aGlzLl9sYXN0VGFza0lEID4gbWF4KQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImxhc3RUYXNrSUQgb3V0IG9mIHJhbmdlIik7CiAgICAgICAgY29uc3Qgc3RhcnQgPSB0aGlzLl9sYXN0VGFza0lEICsgMTsKICAgICAgICBmb3IgKGxldCBpID0gc3RhcnQ7IGkgPD0gc3RhcnQgKyBtYXg7IGkrKykgewogICAgICAgICAgICBjb25zdCB0YXNrSUQgPSBpICUgKG1heCArIDEpOwogICAgICAgICAgICBpZiAodGhpcy5jYWxsYmFja3NbdGFza0lEXSA9PSBudWxsKQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2xhc3RUYXNrSUQgPSB0YXNrSUQ7CiAgICAgICAgfQogICAgICAgIHRocm93IG5ldyBFcnJvcigiY2Fubm90IGZpbmQgbmV4dCB0YXNrSUQiKTsKICAgIH0KICAgIHNlbmRUYXNrKHRhc2spIHsKICAgICAgICBpZiAodGFzay5vcmlnaW4gIT09IHRoaXMub3JpZ2luKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInRoZSB0YXNrIHRvIGJlIHNlbnQgbXVzdCBoYXZlIHRoZSBzYW1lIG9yaWdpbiBhcyB0aGUgdGFzayBxdWV1ZSIpOwogICAgICAgIHRoaXMucG9zdE1lc3NhZ2UodGFzaywgdGhpcy50cmFuc2ZlckFyZ3MgPyB0YXNrLnRyYW5zZmVyTGlzdCA6IFtdKTsKICAgIH0KICAgIHNlbmRSZXBseSh0YXNrKSB7CiAgICAgICAgaWYgKHRhc2sub3JpZ2luID09PSB0aGlzLm9yaWdpbikKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJ0aGUgcmVwbHkgdG8gYmUgc2VudCBtdXN0IG5vdCBoYXZlIHRoZSBzYW1lIG9yaWdpbiBhcyB0aGUgdGFzayBxdWV1ZSIpOwogICAgICAgIHRoaXMucG9zdE1lc3NhZ2UodGFzaywgdGFzay50cmFuc2Zlckxpc3QpOyAvLyBhbHdheXMgdXNlIHRyYW5zZmVycmluZyB0byBzZW5kIGJhY2sgYXJndW1lbnRzCiAgICB9CiAgICBzZW5kTmV4dFRhc2soKSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgbGV0IHRhc2sgPSB0aGlzLnF1ZXVlLnNoaWZ0KCk7CiAgICAgICAgICAgIGlmICh0YXNrID09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNJZGxlID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuaXNJZGxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAvLyBhcHBseSBob29rIGZpcnN0CiAgICAgICAgICAgICAgICBjb25zdCByZWdpc3RlcmVkID0gdGhpcy5jYWxsYmFja3NbdGFzay50YXNrSURdOwogICAgICAgICAgICAgICAgY29uc3QgdGFza0hvb2sgPSByZWdpc3RlcmVkICE9IG51bGwgJiYgcmVnaXN0ZXJlZC5ob29rICE9IG51bGwgJiYgcmVnaXN0ZXJlZC5ob29rLnRhc2sgIT0gbnVsbAogICAgICAgICAgICAgICAgICAgID8gcmVnaXN0ZXJlZC5ob29rLnRhc2sKICAgICAgICAgICAgICAgICAgICA6IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIGlmICh0YXNrSG9vayAhPSBudWxsKQogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhc2sgPSB5aWVsZCB0YXNrSG9vayh0YXNrKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFzay5lcnJNc2cgPSBgWyR7dGhpcy5vcmlnaW59XSBlcnJvciB3aGVuIGFwcGx5aW5nIGhvb2sgYAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKyBgYmVmb3JlIGV4ZWN1dGluZyBjbWQgJHt0YXNrLmNtZH0gZnJvbSAke3Rhc2sub3JpZ2lufWA7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZSA9PT0gInN0cmluZyIgfHwgZSBpbnN0YW5jZW9mIEVycm9yKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFzay5lcnJNc2cgKz0gIlxuIiArIGUudG9TdHJpbmcoKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGFzay5pc0R1bW15ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBzZW5kIHRhc2sKICAgICAgICAgICAgICAgIGlmICh0YXNrLmlzRHVtbXkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRhc2suaGFzRXJyICYmICF0YXNrLmhhc1Jlc3VsdCkKICAgICAgICAgICAgICAgICAgICAgICAgdGFzay5yZXN1bHQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGV2ID0gbmV3IE1lc3NhZ2VFdmVudCgibWVzc2FnZSIsIHsgZGF0YTogdGFzayB9KTsgLy8gbm90IGFjdHVhbGx5IHNlbmRpbmcsIHVzZSBhIGZha2UgcmVwbHkKICAgICAgICAgICAgICAgICAgICB0aGlzLm1zZ0hhbmRsZXIoZXYpOyAvLyB3b24ndCBhd2FpdAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZW5kVGFzayh0YXNrKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfQogICAgY29uc3RydWN0b3Iob3JpZ2luLCBwb3N0TWVzc2FnZSwgdGFza0hhbmRsZXIsIGRlc3Ryb3kpIHsKICAgICAgICB0aGlzLl9pc0FsaXZlID0gdHJ1ZTsKICAgICAgICB0aGlzLmlzSWRsZSA9IHRydWU7CiAgICAgICAgLy8gY29tcGFyaW5nIHRvIHN0cnVjdHVyZWQgY29weSAoYnkgZGVmYXVsdCksIGlmIGRhdGEgc2l6ZSBpcyBiaWcgKGJlY2F1c2Ugb2YgemVyby1jb3B5KSwKICAgICAgICAvLyB0cmFuc2ZlcnJpbmcgaXMgZ2VuZXJhbGx5IG11Y2ggZmFzdGVyLiBob3dldmVyIGl0IG9idmlvdXNseSBoYXMgYSBkcmF3YmFjaywKICAgICAgICAvLyB0aGF0IHRyYW5zZmVycmVkIGFyZ3VtZW50cyBhcmUgbm8gbG9uZ2VyIGFjY2Vzc2libGUgaW4gdGhlIHNlbmRlciB0aHJlYWQKICAgICAgICB0aGlzLnRyYW5zZmVyQXJncyA9IGZhbHNlOwogICAgICAgIC8vIHRoZSByZWNlaXZlci9jYWxsZWUgd2lsbCBhbHdheXMgdXNlIHRyYW5zZmVycmluZyB0byBzZW5kIGJhY2sgYXJndW1lbnRzLAogICAgICAgIC8vIG5vdCBzZW5kaW5nIHRoZSBhcmd1bWVudHMgYmFjayBpcyBzdXBwb3NlZCB0byBzYXZlIGEgbGl0dGxlIHRpbWUvb3ZlcmhlYWQKICAgICAgICB0aGlzLnJlcGx5QXJncyA9IGZhbHNlOwogICAgICAgIHRoaXMucXVldWUgPSBbXTsKICAgICAgICB0aGlzLl9sYXN0VGFza0lEID0gMDsKICAgICAgICB0aGlzLmNhbGxiYWNrcyA9IHt9OwogICAgICAgIHRoaXMub3JpZ2luID0gb3JpZ2luOwogICAgICAgIHRoaXMucG9zdE1lc3NhZ2UgPSBwb3N0TWVzc2FnZTsKICAgICAgICB0aGlzLnRhc2tIYW5kbGVyID0gdGFza0hhbmRsZXI7CiAgICAgICAgdGhpcy5kZXN0cm95ID0gZGVzdHJveTsKICAgIH0KICAgIGdldCBpc0FsaXZlKCkgewogICAgICAgIHJldHVybiB0aGlzLl9pc0FsaXZlOwogICAgfQogICAgLy8gdGhlc2UgZm9sbG93aW5nIHR3byBtZXRob2RzL2Z1bmN0aW9ucyBhcmUgc3VwcG9zZWQgdG8gYmUgY2FsbGJhY2tzCiAgICBtc2dIYW5kbGVyKGV2KSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbnN0IHRhc2sgPSBIQ0FUYXNrLnJlY3JlYXRlKGV2LmRhdGEpOwogICAgICAgICAgICAgICAgaWYgKHRhc2sub3JpZ2luICE9PSB0aGlzLm9yaWdpbikgewogICAgICAgICAgICAgICAgICAgIC8vIGluY29taW5nIGNtZCB0byBleGVjdXRlCiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFzay5yZXN1bHQgPSB5aWVsZCB0aGlzLnRhc2tIYW5kbGVyKHRhc2spOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBpdCdzIG9ic2VydmVkIHRoYXQgRmlyZWZveCByZWZ1c2VzIHRvIHBvc3RNZXNzYWdlIGFuIEVycm9yIG9iamVjdDoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gIkRhdGFDbG9uZUVycm9yOiBUaGUgb2JqZWN0IGNvdWxkIG5vdCBiZSBjbG9uZWQuIgogICAgICAgICAgICAgICAgICAgICAgICAvLyAob2JzZXJ2ZWQgaW4gRmlyZWZveCA5Nywgbm90IGNsZWFyIGFib3V0IG90aGVyIHZlcnNpb25zKQogICAgICAgICAgICAgICAgICAgICAgICAvLyBDaHJvbWUgZG9lc24ndCBzZWVtIHRvIGhhdmUgdGhpcyBwcm9ibGVtLAogICAgICAgICAgICAgICAgICAgICAgICAvLyBob3dldmVyLCBpbiBvcmRlciB0byBrZWVwIGNvbXBhdGlibGUgd2l0aCBGaXJlZm94LAogICAgICAgICAgICAgICAgICAgICAgICAvLyB3ZSBzdGlsbCBoYXZlIHRvIGF2b2lkIHBvc3RpbmcgYW4gRXJyb3Igb2JqZWN0CiAgICAgICAgICAgICAgICAgICAgICAgIHRhc2suZXJyTXNnID0gYFske3RoaXMub3JpZ2lufV0gZXJyb3Igd2hlbiBleGVjdXRpbmcgY21kICR7dGFzay5jbWR9IGZyb20gJHt0YXNrLm9yaWdpbn1gOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGUgPT09ICJzdHJpbmciIHx8IGUgaW5zdGFuY2VvZiBFcnJvcikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhc2suZXJyTXNnICs9ICJcbiIgKyBlLnRvU3RyaW5nKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICh0YXNrLnRhc2tJRCAhPSBIQ0FUYXNrUXVldWUuZGlzY2FyZFJlcGx5VGFza0lEKQogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZW5kUmVwbHkodGFzayk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RoaXMub3JpZ2lufV0gc2VuZFJlcGx5IGZhaWxlZC5gLCBlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhc2suZXJyTXNnID0gKHRhc2suZXJyTXNnID09IG51bGwgPyAiIiA6IHRhc2suZXJyTXNnICsgIlxuXG4iKSArICJwb3N0TWVzc2FnZSBmcm9tIFdvcmtlciBmYWlsZWQiOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBlID09PSAic3RyaW5nIiB8fCBlIGluc3RhbmNlb2YgRXJyb3IpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFzay5lcnJNc2cgKz0gIlxuIiArIGUudG9TdHJpbmcoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRyeSBhZ2FpbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZW5kUmVwbHkodGFzayk7IC8vIGlmIGl0IHRocm93cywganVzdCBsZXQgaXQgdGhyb3cKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gcmVjZWl2aW5nIGNtZCByZXN1bHQKICAgICAgICAgICAgICAgICAgICAvLyBmaW5kICYgdW5yZWdpc3RlciBjYWxsYmFjawogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlZ2lzdGVyZWQgPSB0aGlzLmNhbGxiYWNrc1t0YXNrLnRhc2tJRF07CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuY2FsbGJhY2tzW3Rhc2sudGFza0lEXTsKICAgICAgICAgICAgICAgICAgICAvLyBhcHBseSBob29rCiAgICAgICAgICAgICAgICAgICAgbGV0IHJlc3VsdCA9IHRhc2suaGFzUmVzdWx0ID8gdGFzay5yZXN1bHQgOiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaG9vayA9IHJlZ2lzdGVyZWQuaG9vazsKICAgICAgICAgICAgICAgICAgICBpZiAoaG9vayAhPSBudWxsKQogICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhc2suaGFzRXJyICYmIGhvb2suZXJyb3IgIT0gbnVsbCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB5aWVsZCBob29rLmVycm9yKHRhc2suZXJyTXNnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRhc2suaGFzUmVzdWx0ICYmIGhvb2sucmVzdWx0ICE9IG51bGwpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0ID0geWllbGQgaG9vay5yZXN1bHQodGFzay5yZXN1bHQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRhc2suaGFzRXJyKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhc2suZXJyTXNnID0gIiI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXNrLmVyck1zZyArPSBgWyR7dGhpcy5vcmlnaW59XSBlcnJvciB3aGVuIGFwcGx5aW5nIGhvb2sgYAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICsgYGFmdGVyIGV4ZWN1dGluZyBjbWQgJHt0YXNrLmNtZH0gZnJvbSAke3Rhc2sub3JpZ2lufWA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGUgPT09ICJzdHJpbmciIHx8IGUgaW5zdGFuY2VvZiBFcnJvcikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXNrLmVyck1zZyArPSAiXG4iICsgZS50b1N0cmluZygpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy8gc2V0dGxlIHByb21pc2UKICAgICAgICAgICAgICAgICAgICBpZiAodGFzay5oYXNFcnIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVnaXN0ZXJlZC5yZWplY3QodGFzay5lcnJNc2cpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0YXNrLmhhc1Jlc3VsdCkgewogICAgICAgICAgICAgICAgICAgICAgICByZWdpc3RlcmVkLnJlc29sdmUocmVzdWx0KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHRhc2sgKG9yaWdpbj0ke3Rhc2sub3JpZ2lufSB0YXNrSUQ9JHt0YXNrLnRhc2tJRH0gY21kPSR7dGFzay5jbWR9KSBgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICArIGBoYXMgbmVpdGhlciBlcnJvciBub3IgcmVzdWx0YCk7IC8vIHNob3VsZCBuZXZlciBoYXBwZW4KICAgICAgICAgICAgICAgICAgICAvLyBzdGFydCBuZXh0IHRhc2sKICAgICAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLnNlbmROZXh0VGFzaygpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAvLyBpcnJlY292ZXJhYmxlIGVycm9yCiAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLmVyckhhbmRsZXIoZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KICAgIGVyckhhbmRsZXIoZGF0YSkgewogICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAgIC8vIGlycmVjb3ZlcmFibGUgZXJyb3IKICAgICAgICAgICAgaWYgKHRoaXMuX2lzQWxpdmUpIHsKICAgICAgICAgICAgICAgIC8vIHByaW50IGVycm9yIG1lc3NhZ2UKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RoaXMub3JpZ2lufV0gZGVzdHJveWluZyBiYWNrZ3JvdW5kIHdvcmtlciBvbiBpcnJlY292ZXJhYmxlIGVycm9yYCwgZGF0YSk7CiAgICAgICAgICAgICAgICAvLyBkZXN0cm95IGJhY2tncm91bmQgd29ya2VyCiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHlpZWxkIHRoaXMuZGVzdHJveSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0aGlzLm9yaWdpbn1dIGVycm9yIHdoZW4gdHJ5aW5nIHRvIGRlc3Ryb3koKWAsIGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gYWZ0ZXIgZGVzdHJveSwgbWFyayBpc0FsaXZlIGFzIGZhbHNlIChvdGhlcndpc2Ugc2VuZENtZCB3aWxsIGZhaWwpCiAgICAgICAgICAgICAgICB0aGlzLl9pc0FsaXZlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAvLyByZWplY3QgYWxsIHBlbmRpbmcgcHJvbWlzZXMKICAgICAgICAgICAgICAgIGZvciAobGV0IHRhc2tJRCBpbiB0aGlzLmNhbGxiYWNrcykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlamVjdCA9IHRoaXMuY2FsbGJhY2tzW3Rhc2tJRF0ucmVqZWN0OwogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmNhbGxiYWNrc1t0YXNrSURdOwogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0aGlzLm9yaWdpbn1dIGVycm9yIHJlamVjdGluZyB0YXNrSUQ9JHt0YXNrSUR9YCwgZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CiAgICBnZXRUcmFuc2ZlckNvbmZpZygpIHsKICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuX2lzQWxpdmUpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImRlYWQiKTsKICAgICAgICAgICAgcmV0dXJuIHlpZWxkIHRoaXMuZXhlY0NtZCgibm9wIiwgW10sIHsKICAgICAgICAgICAgICAgIHJlc3VsdDogKCkgPT4gKHsKICAgICAgICAgICAgICAgICAgICB0cmFuc2ZlckFyZ3M6IHRoaXMudHJhbnNmZXJBcmdzLAogICAgICAgICAgICAgICAgICAgIHJlcGx5QXJnczogdGhpcy5yZXBseUFyZ3MKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgfQogICAgY29uZmlnVHJhbnNmZXIodHJhbnNmZXJBcmdzLCByZXBseUFyZ3MpIHsKICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuX2lzQWxpdmUpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImRlYWQiKTsKICAgICAgICAgICAgcmV0dXJuIHlpZWxkIHRoaXMuZXhlY0NtZCgibm9wIiwgW10sIHsKICAgICAgICAgICAgICAgIHJlc3VsdDogKCkgPT4gewogICAgICAgICAgICAgICAgICAgIHRoaXMudHJhbnNmZXJBcmdzID0gdHJhbnNmZXJBcmdzID8gdHJ1ZSA6IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMucmVwbHlBcmdzID0gcmVwbHlBcmdzID8gdHJ1ZSA6IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgIH0KICAgIGV4ZWNDbWQoY21kLCBhcmdzLCBob29rKSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgLy8gY2FuIGJlIG1vZGlmaWVkIHRvIHNpbXBseSB3cmFwIGV4ZWNNdWx0aUNtZCBidXQgSSBqdXN0IHdhbnQgdG8gbGV0IGl0IGFsb25lIGZvciBubyBzcGVjaWFsIHJlYXNvbgogICAgICAgICAgICBpZiAoIXRoaXMuX2lzQWxpdmUpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImRlYWQiKTsKICAgICAgICAgICAgLy8gYXNzaWduIG5ldyB0YXNrSUQKICAgICAgICAgICAgY29uc3QgdGFza0lEID0gdGhpcy5nZXROZXh0VGFza0lEKCk7CiAgICAgICAgICAgIGNvbnN0IHRhc2sgPSBuZXcgSENBVGFzayh0aGlzLm9yaWdpbiwgdGFza0lELCBjbWQsIGFyZ3MsIHRoaXMucmVwbHlBcmdzKTsKICAgICAgICAgICAgLy8gcmVnaXN0ZXIgY2FsbGJhY2sKICAgICAgICAgICAgaWYgKHRoaXMuY2FsbGJhY2tzW3Rhc2tJRF0gIT0gbnVsbCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgdGFza0lEPSR7dGFza0lEfSBpcyBhbHJlYWR5IG9jY3VwaWVkYCk7CiAgICAgICAgICAgIGNvbnN0IHJlc3VsdFByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB0aGlzLmNhbGxiYWNrc1t0YXNrSURdID0gewogICAgICAgICAgICAgICAgcmVzb2x2ZTogcmVzb2x2ZSwgcmVqZWN0OiByZWplY3QsCiAgICAgICAgICAgICAgICBob29rOiBob29rCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAvLyBhcHBlbmQgdG8gY29tbWFuZCBxdWV1ZQogICAgICAgICAgICB0aGlzLnF1ZXVlLnB1c2godGFzayk7CiAgICAgICAgICAgIC8vIHN0YXJ0IGV4ZWN1dGluZyB0YXNrcwogICAgICAgICAgICBpZiAodGhpcy5pc0lkbGUpCiAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLnNlbmROZXh0VGFzaygpOwogICAgICAgICAgICAvLyByZXR1cm4gcmVzdWx0CiAgICAgICAgICAgIHJldHVybiB5aWVsZCByZXN1bHRQcm9taXNlOwogICAgICAgIH0pOwogICAgfQogICAgZXhlY011bHRpQ21kKGNtZExpc3QpIHsKICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgICAvLyB0aGUgcG9pbnQgaXMgdG8gZW5zdXJlICJhdG9taWNpdHkiIGJldHdlZW4gY21kcwogICAgICAgICAgICBpZiAoIXRoaXMuX2lzQWxpdmUpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImRlYWQiKTsKICAgICAgICAgICAgbGV0IHJlc3VsdFByb21pc2VzID0gW107CiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY21kTGlzdC5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgLy8gYXNzaWduIG5ldyB0YXNrSUQKICAgICAgICAgICAgICAgIGNvbnN0IHRhc2tJRCA9IHRoaXMuZ2V0TmV4dFRhc2tJRCgpOwogICAgICAgICAgICAgICAgY29uc3QgbGlzdEl0ZW0gPSBjbWRMaXN0W2ldOwogICAgICAgICAgICAgICAgY29uc3QgdGFzayA9IG5ldyBIQ0FUYXNrKHRoaXMub3JpZ2luLCB0YXNrSUQsIGxpc3RJdGVtLmNtZCwgbGlzdEl0ZW0uYXJncywgdGhpcy5yZXBseUFyZ3MpOwogICAgICAgICAgICAgICAgLy8gcmVnaXN0ZXIgY2FsbGJhY2sKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNhbGxiYWNrc1t0YXNrSURdICE9IG51bGwpCiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGB0YXNrSUQ9JHt0YXNrSUR9IGlzIGFscmVhZHkgb2NjdXBpZWRgKTsKICAgICAgICAgICAgICAgIHJlc3VsdFByb21pc2VzLnB1c2gobmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gdGhpcy5jYWxsYmFja3NbdGFza0lEXSA9IHsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlOiByZXNvbHZlLCByZWplY3Q6IHJlamVjdCwKICAgICAgICAgICAgICAgICAgICBob29rOiBsaXN0SXRlbS5ob29rCiAgICAgICAgICAgICAgICB9KSk7CiAgICAgICAgICAgICAgICAvLyBhcHBlbmQgdG8gY29tbWFuZCBxdWV1ZQogICAgICAgICAgICAgICAgdGhpcy5xdWV1ZS5wdXNoKHRhc2spOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIHN0YXJ0IGV4ZWN1dGluZyB0YXNrcwogICAgICAgICAgICBpZiAodGhpcy5pc0lkbGUpCiAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLnNlbmROZXh0VGFzaygpOwogICAgICAgICAgICAvLyByZXR1cm4gcmVzdWx0cwogICAgICAgICAgICByZXR1cm4geWllbGQgUHJvbWlzZS5hbGwocmVzdWx0UHJvbWlzZXMpOwogICAgICAgIH0pOwogICAgfQogICAgc2VuZENtZChjbWQsIGFyZ3MpIHsKICAgICAgICAvLyBzZW5kIGNtZCB3aXRob3V0IHJlZ2lzdGVyaW5nIGNhbGxiYWNrCiAgICAgICAgLy8gZ2VuZXJhbGx5IG5vdCByZWNvbW1lbmRlZAogICAgICAgIGlmICghdGhpcy5faXNBbGl2ZSkKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJkZWFkIik7CiAgICAgICAgY29uc3QgdGFzayA9IG5ldyBIQ0FUYXNrKHRoaXMub3JpZ2luLCBIQ0FUYXNrUXVldWUuZGlzY2FyZFJlcGx5VGFza0lELCBjbWQsIGFyZ3MsIGZhbHNlKTsKICAgICAgICB0aGlzLnNlbmRUYXNrKHRhc2spOwogICAgfQogICAgc2h1dGRvd24oZm9yY2libHkgPSBmYWxzZSkgewogICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLl9pc0FsaXZlKSB7CiAgICAgICAgICAgICAgICBpZiAoZm9yY2libHkpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGhpcy5vcmlnaW59XSBlcnJvciB3aGVuIHRyeWluZyB0byBmb3JjaWJseSBzaHV0ZG93bi5gLCBlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faXNBbGl2ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIHlpZWxkIHRoaXMuZXhlY0NtZCgibm9wIiwgW10sIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0OiAoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2lzQWxpdmUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfQp9CkhDQVRhc2tRdWV1ZS5tYXhUYXNrSUQgPSAyNTY7IC8vIHRoZXJlJ3MgcmVjdXJzaW9uIGluIHNlbmROZXh0VGFzayB3aGVuIG1ha2luZyBmYWtlIHJlcGx5CkhDQVRhc2tRdWV1ZS5kaXNjYXJkUmVwbHlUYXNrSUQgPSAtMTsKaWYgKHR5cGVvZiBkb2N1bWVudCA9PT0gInVuZGVmaW5lZCIpIHsKICAgIGlmICh0eXBlb2Ygb25tZXNzYWdlID09PSAidW5kZWZpbmVkIikgewogICAgICAgIC8vIEF1ZGlvV29ya2xldAogICAgICAgIGNsYXNzIEhDQUZyYW1lUGxheWVyQ29udGV4dCB7CiAgICAgICAgICAgIGdldCBpc1N0YWxsaW5nKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2lzU3RhbGxpbmc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2V0IGlzU3RhbGxpbmcodmFsKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9pc1N0YWxsaW5nID0gdmFsOwogICAgICAgICAgICAgICAgaWYgKHZhbCkKICAgICAgICAgICAgICAgICAgICB0aGlzLm9uY2VTdGFsbGVkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdHJ1Y3Rvcihwcm9jT3B0cykgewogICAgICAgICAgICAgICAgdGhpcy5pc1BsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuZGVmYXVsdFB1bGxCbG9ja0NvdW50ID0gMTI4OwogICAgICAgICAgICAgICAgdGhpcy5mYWlsZWRCbG9ja3MgPSBbXTsKICAgICAgICAgICAgICAgIHRoaXMucHJpbnRFcnJvckNvdW50RG93bkZyb20gPSAyNTY7CiAgICAgICAgICAgICAgICB0aGlzLnByaW50RXJyb3JDb3VudERvd24gPSB0aGlzLnByaW50RXJyb3JDb3VudERvd25Gcm9tOwogICAgICAgICAgICAgICAgdGhpcy50b3RhbFB1bGxlZEJsb2NrQ291bnQgPSAwOwogICAgICAgICAgICAgICAgdGhpcy5pc1B1bGxpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuX2lzU3RhbGxpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMub25jZVN0YWxsZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuc2FtcGxlT2Zmc2V0ID0gMDsKICAgICAgICAgICAgICAgIHRoaXMubGFzdERlY29kZWRCbG9ja0luZGV4ID0gLTE7CiAgICAgICAgICAgICAgICB0aGlzLmZyYW1lID0gbmV3IEhDQUZyYW1lKG5ldyBIQ0FJbmZvKHByb2NPcHRzLnJhd0hlYWRlcikpOwogICAgICAgICAgICAgICAgY29uc3QgaW5mbyA9IHRoaXMuZnJhbWUuSGNhOwogICAgICAgICAgICAgICAgY29uc3QgaGFzTG9vcCA9IGluZm8uaGFzSGVhZGVyWyJsb29wIl0gPyB0cnVlIDogZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHByb2NPcHRzLnB1bGxCbG9ja0NvdW50ID09PSAibnVtYmVyIikgewogICAgICAgICAgICAgICAgICAgIGlmIChpc05hTihwcm9jT3B0cy5wdWxsQmxvY2tDb3VudCkpCiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgICAgICAgICAgICAgIGxldCBwdWxsQmxvY2tDb3VudCA9IE1hdGguZmxvb3IocHJvY09wdHMucHVsbEJsb2NrQ291bnQpOwogICAgICAgICAgICAgICAgICAgIGlmIChwdWxsQmxvY2tDb3VudCA8IDIpCiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgICAgICAgICAgICAgIHRoaXMucHVsbEJsb2NrQ291bnQgPSBwdWxsQmxvY2tDb3VudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICB0aGlzLnB1bGxCbG9ja0NvdW50ID0gdGhpcy5kZWZhdWx0UHVsbEJsb2NrQ291bnQ7CiAgICAgICAgICAgICAgICBjb25zdCBidWZmZXJlZEJsb2NrQ291bnQgPSBoYXNMb29wID8gKGluZm8ubG9vcC5lbmQgKyAxKSA6IHRoaXMucHVsbEJsb2NrQ291bnQgKiAyOwogICAgICAgICAgICAgICAgdGhpcy5lbmNvZGVkID0gbmV3IFVpbnQ4QXJyYXkoaW5mby5ibG9ja1NpemUgKiBidWZmZXJlZEJsb2NrQ291bnQpOwogICAgICAgICAgICAgICAgdGhpcy5kZWNvZGVkID0gQXJyYXkuZnJvbSh7IGxlbmd0aDogaW5mby5mb3JtYXQuY2hhbm5lbENvdW50IH0sICgpID0+IG5ldyBGbG9hdDMyQXJyYXkoSENBRnJhbWUuU2FtcGxlc1BlckZyYW1lICogMikpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNsYXNzIEhDQUZyYW1lUGxheWVyIGV4dGVuZHMgQXVkaW9Xb3JrbGV0UHJvY2Vzc29yIHsKICAgICAgICAgICAgY29uc3RydWN0b3Iob3B0aW9ucykgewogICAgICAgICAgICAgICAgc3VwZXIoKTsKICAgICAgICAgICAgICAgIHRoaXMudW5zZXR0bGVkID0gW107CiAgICAgICAgICAgICAgICB0aGlzLndhaXRDb3VudERvd25Gcm9tID0gMzI7CiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucyA9PSBudWxsIHx8IG9wdGlvbnMucHJvY2Vzc29yT3B0aW9ucyA9PSBudWxsKQogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgICAgICAgICAgdGhpcy5jdHggPSBuZXcgSENBRnJhbWVQbGF5ZXJDb250ZXh0KG9wdGlvbnMucHJvY2Vzc29yT3B0aW9ucyk7CiAgICAgICAgICAgICAgICB0aGlzLnRhc2tRdWV1ZSA9IG5ldyBIQ0FUYXNrUXVldWUoIkJhY2tncm91bmQtSENBRnJhbWVQbGF5ZXIiLCAobXNnLCB0cmFucykgPT4gdGhpcy5wb3J0LnBvc3RNZXNzYWdlKG1zZywgdHJhbnMpLCAodGFzaykgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgICAgICAgICAgIHN3aXRjaCAodGFzay5jbWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAibm9wIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiaW5pdGlhbGl6ZSI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmN0eCA9IG5ldyBIQ0FGcmFtZVBsYXllckNvbnRleHQodGFzay5hcmdzWzBdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJyZXNldCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB5aWVsZCBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmN0eDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVuc2V0dGxlZC5wdXNoKHsgcmVzb2x2ZTogcmVzb2x2ZSwgY291bnRlcjogdGhpcy53YWl0Q291bnREb3duRnJvbSB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgInBhdXNlIjoKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAicmVzdW1lIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmN0eCA9PSBudWxsKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgbm90IGluaXRpYWxpemVkYCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmN0eC5pc1BsYXlpbmcgPSB0YXNrLmNtZCA9PT0gInJlc3VtZSI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuY3R4LmlzUGxheWluZykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB5aWVsZCBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVuc2V0dGxlZC5wdXNoKHsgcmVzb2x2ZTogcmVzb2x2ZSwgY291bnRlcjogdGhpcy53YWl0Q291bnREb3duRnJvbSB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGB1bmtub3duIGNtZCAke3Rhc2suY21kfWApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pLCAoKSA9PiB7IHRoaXMudGFza1F1ZXVlLnNlbmRDbWQoInNlbGYtZGVzdHJ1Y3QiLCBbXSk7IH0pOwogICAgICAgICAgICAgICAgdGhpcy50YXNrUXVldWUuY29uZmlnVHJhbnNmZXIodHJ1ZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgdGhpcy5wb3J0Lm9ubWVzc2FnZSA9IChldikgPT4gdGhpcy50YXNrUXVldWUubXNnSGFuZGxlcihldik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaGFuZGxlTmV3QmxvY2tzKGN0eCwgbmV3QmxvY2tzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBpbmZvID0gY3R4LmZyYW1lLkhjYTsKICAgICAgICAgICAgICAgIGNvbnN0IGhhc0xvb3AgPSBpbmZvLmhhc0hlYWRlclsibG9vcCJdID8gdHJ1ZSA6IGZhbHNlOwogICAgICAgICAgICAgICAgY29uc3QgcHVsbEJsb2NrQ291bnQgPSBjdHgucHVsbEJsb2NrQ291bnQ7CiAgICAgICAgICAgICAgICBjb25zdCBlbmNvZGVkID0gY3R4LmVuY29kZWQ7CiAgICAgICAgICAgICAgICBpZiAobmV3QmxvY2tzLmxlbmd0aCAlIGluZm8uYmxvY2tTaXplICE9IDApIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYG5ld0Jsb2Nrcy5sZW5ndGg9JHtuZXdCbG9ja3MubGVuZ3RofSBzaG91bGQgYmUgbXVsdGlwbGUgb2YgYmxvY2tTaXplYCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zdCBuZXdCbG9ja0NvdW50ID0gbmV3QmxvY2tzLmxlbmd0aCAvIGluZm8uYmxvY2tTaXplOwogICAgICAgICAgICAgICAgY29uc3QgZXhwZWN0ZWQgPSBpbmZvLmJsb2NrU2l6ZSAqIHB1bGxCbG9ja0NvdW50OwogICAgICAgICAgICAgICAgaWYgKGhhc0xvb3ApIHsKICAgICAgICAgICAgICAgICAgICBsZXQgZW5jb2RlZE9mZnNldCA9IGluZm8uYmxvY2tTaXplICogY3R4LnRvdGFsUHVsbGVkQmxvY2tDb3VudDsKICAgICAgICAgICAgICAgICAgICBpZiAoZW5jb2RlZE9mZnNldCArIG5ld0Jsb2Nrcy5sZW5ndGggPiBlbmNvZGVkLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGhhcyBsb29wIGhlYWRlciwgYnVmZmVyIHdpbGwgb3ZlcmZsb3dgKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZW5jb2RlZC5zZXQobmV3QmxvY2tzLCBlbmNvZGVkT2Zmc2V0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmIChuZXdCbG9ja3MubGVuZ3RoICE9IGV4cGVjdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgbm8gbG9vcCBoZWFkZXIsIG5ld0Jsb2Nrcy5sZW5ndGggKCR7bmV3QmxvY2tzLmxlbmd0aH0pICE9IGV4cGVjdGVkICgke2V4cGVjdGVkfSlgKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChjdHgudG90YWxQdWxsZWRCbG9ja0NvdW50ICUgKHB1bGxCbG9ja0NvdW50ICogMikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5jb2RlZC5zZXQobmV3QmxvY2tzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICBjYXNlIHB1bGxCbG9ja0NvdW50OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZW5jb2RlZC5zZXQobmV3QmxvY2tzLCBleHBlY3RlZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN0eC50b3RhbFB1bGxlZEJsb2NrQ291bnQgKz0gbmV3QmxvY2tDb3VudDsKICAgICAgICAgICAgICAgIGN0eC5pc1B1bGxpbmcgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwdWxsTmV3QmxvY2tzKGN0eCkgewogICAgICAgICAgICAgICAgLy8gaWYgY3R4IHBhc3NlZCBpbiBoYWQgYmVlbiBhY3R1YWxseSBkZWxldGVkLCBpdCB3b24ndCBhZmZlY3QgdGhlIGN1cnJlbnQgdXNpbmcgY3R4CiAgICAgICAgICAgICAgICBpZiAoY3R4LmlzUHVsbGluZykKICAgICAgICAgICAgICAgICAgICByZXR1cm47IC8vIGFscmVhZHkgcHVsbGluZy4gd2lsbCBiZSBjYWxsZWQgYWdhaW4gaWYgc3RpbGwgbm90IGVub3VnaAogICAgICAgICAgICAgICAgY3R4LmlzUHVsbGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAvLyByZXF1ZXN0IHRvIHB1bGwgJiBjb250aW51ZSBkZWNvZGluZwogICAgICAgICAgICAgICAgdGhpcy50YXNrUXVldWUuZXhlY0NtZCgicHVsbCIsIFtdLCB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0OiAobmV3QmxvY2tzKSA9PiB0aGlzLmhhbmRsZU5ld0Jsb2NrcyhjdHgsIG5ld0Jsb2NrcyksCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICgpID0+IHsgY3R4LmlzUHVsbGluZyA9IGZhbHNlOyB9LAogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAuY2F0Y2goKGUpID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oYHB1bGxOZXdCbG9ja3MgZmFpbGVkLmAsIGUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd3JpdGVUb0RlY29kZWRCdWZmZXIoZnJhbWUsIGRlY29kZWQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGhhbGZTaXplID0gSENBRnJhbWUuU2FtcGxlc1BlckZyYW1lOwogICAgICAgICAgICAgICAgZm9yIChsZXQgYyA9IDA7IGMgPCBmcmFtZS5DaGFubmVscy5sZW5ndGg7IGMrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpcnN0SGFsZiA9IGRlY29kZWRbY10uc3ViYXJyYXkoMCwgaGFsZlNpemUpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGxhc3RIYWxmID0gZGVjb2RlZFtjXS5zdWJhcnJheShoYWxmU2l6ZSwgaGFsZlNpemUgKiAyKTsKICAgICAgICAgICAgICAgICAgICBmaXJzdEhhbGYuc2V0KGxhc3RIYWxmKTsKICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBzZiA9IDAsIG9mZnNldCA9IDA7IHNmIDwgSENBRnJhbWUuU3ViZnJhbWVzUGVyRnJhbWU7IHNmKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEhhbGYuc2V0KGZyYW1lLkNoYW5uZWxzW2NdLlBjbUZsb2F0W3NmXSwgb2Zmc2V0KTsKICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0ICs9IEhDQUZyYW1lLlNhbXBsZXNQZXJTdWJGcmFtZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsYXN0SGFsZi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobGFzdEhhbGZbaV0gPiAxKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEhhbGZbaV0gPSAxOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChsYXN0SGFsZltpXSA8IC0xKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdEhhbGZbaV0gPSAtMTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbWFwVG9Vbkxvb3BlZChpbmZvLCBzYW1wbGVPZmZzZXQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGhhc0xvb3AgPSBpbmZvLmhhc0hlYWRlclsibG9vcCJdID8gdHJ1ZSA6IGZhbHNlOwogICAgICAgICAgICAgICAgaWYgKHNhbXBsZU9mZnNldCA8PSBpbmZvLmVuZEF0U2FtcGxlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNhbXBsZU9mZnNldDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIGlmIChoYXNMb29wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBvZmZzZXQgPSAoc2FtcGxlT2Zmc2V0IC0gaW5mby5sb29wU3RhcnRBdFNhbXBsZSkgJSBpbmZvLmxvb3BTYW1wbGVDb3VudDsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGluZm8ubG9vcFN0YXJ0QXRTYW1wbGUgKyBvZmZzZXQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaW5mby5lbmRBdFNhbXBsZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcHJvY2VzcyhpbnB1dHMsIG91dHB1dHMsIHBhcmFtZXRlcnMpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmN0eCA9PSBudWxsIHx8ICF0aGlzLmN0eC5pc1BsYXlpbmcpIHsKICAgICAgICAgICAgICAgICAgICAvLyB3b3JrYXJvdW5kIHRoZSAicmVzaWR1ZSIgYnVyc3Qgbm9pc2UgaXNzdWUgaW4gQ2hyb21lCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdW5zZXR0bGVkID0gdGhpcy51bnNldHRsZWQuc2hpZnQoKTsKICAgICAgICAgICAgICAgICAgICBpZiAodW5zZXR0bGVkICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKC0tdW5zZXR0bGVkLmNvdW50ZXIgPiAwKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy51bnNldHRsZWQudW5zaGlmdCh1bnNldHRsZWQpOwogICAgICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVuc2V0dGxlZC5yZXNvbHZlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYGVycm9yIHdoZW4gc2V0dGxpbmcgcHJvbWlzZSBvZiAicmVzZXQiIG9yICJzZXRQbGF5aW5nIiBjbWRgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7IC8vIHdhaXQgZm9yIG5ldyBzb3VyY2Ugb3IgcmVzdW1lCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy5jdHguZmFpbGVkQmxvY2tzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jdHguZmFpbGVkQmxvY2tzLmxlbmd0aCA+PSA2NCB8fCAtLXRoaXMuY3R4LnByaW50RXJyb3JDb3VudERvd24gPD0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBlcnJvciBkZWNvZGluZyBmb2xsb3dpbmcgYmxvY2tzYCwgdGhpcy5jdHguZmFpbGVkQmxvY2tzLCB0aGlzLmN0eC5sYXN0RXJyb3IpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmN0eC5mYWlsZWRCbG9ja3MgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jdHgubGFzdEVycm9yID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmN0eC5wcmludEVycm9yQ291bnREb3duID0gdGhpcy5jdHgucHJpbnRFcnJvckNvdW50RG93bkZyb207CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc3Qgb3V0cHV0ID0gb3V0cHV0c1swXTsKICAgICAgICAgICAgICAgIGNvbnN0IHJlbmRlclF1YW50dW1TaXplID0gb3V0cHV0WzBdLmxlbmd0aDsKICAgICAgICAgICAgICAgIGNvbnN0IHNhbXBsZXNQZXJCbG9jayA9IEhDQUZyYW1lLlNhbXBsZXNQZXJGcmFtZTsKICAgICAgICAgICAgICAgIC8vIG5vIG1vcmUgdGhhbiBvbmUgYmxvY2sgd2lsbCBiZSBkZWNvZGVkIGVhY2ggdGltZSB0aGlzIGZ1bmN0aW9uIGJlaW5nIGNhbGxlZCwKICAgICAgICAgICAgICAgIC8vIHRoZXJlZm9yZSBvbmUgYmxvY2sgbXVzdCBjb3ZlciB0aGUgd2hvbGUgcmVuZGVyUXVhbnR1bVNpemUKICAgICAgICAgICAgICAgIGlmIChzYW1wbGVzUGVyQmxvY2sgPCByZW5kZXJRdWFudHVtU2l6ZSkKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInJlbmRlciBxdWFudHVtIHJlcXVpcmVzIG1vcmUgc2FtcGxlIHRoYW4gYSBmdWxsIGJsb2NrIik7CiAgICAgICAgICAgICAgICBjb25zdCBpbmZvID0gdGhpcy5jdHguZnJhbWUuSGNhOwogICAgICAgICAgICAgICAgY29uc3QgaGFzTG9vcCA9IGluZm8uaGFzSGVhZGVyWyJsb29wIl0gPyB0cnVlIDogZmFsc2U7CiAgICAgICAgICAgICAgICBjb25zdCBlbmNvZGVkID0gdGhpcy5jdHguZW5jb2RlZDsKICAgICAgICAgICAgICAgIGNvbnN0IGRlY29kZWQgPSB0aGlzLmN0eC5kZWNvZGVkOwogICAgICAgICAgICAgICAgLy8gc2tpcCBkcm9wcGVkSGVhZGVyCiAgICAgICAgICAgICAgICBpZiAodGhpcy5jdHguc2FtcGxlT2Zmc2V0IDwgaW5mby5mb3JtYXQuZHJvcHBlZEhlYWRlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY3R4LnNhbXBsZU9mZnNldCA9IGluZm8uZm9ybWF0LmRyb3BwZWRIZWFkZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy5jdHguc2FtcGxlT2Zmc2V0ID49IGluZm8uZW5kQXRTYW1wbGUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoaGFzTG9vcCkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyByZXdpbmQgYmFjayBpZiBiZXlvbmQgbG9vcCBlbmQKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jdHguc2FtcGxlT2Zmc2V0ID0gdGhpcy5tYXBUb1VuTG9vcGVkKGluZm8sIHRoaXMuY3R4LnNhbXBsZU9mZnNldCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBub3RoaW5nIG1vcmUgdG8gcGxheQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRhc2tRdWV1ZS5zZW5kQ21kKCJlbmQiLCBbXSk7IC8vIG5vdCB3YWl0aW5nIGZvciByZXN1bHQKICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuY3R4OyAvLyBhdm9pZCBzZW5kaW5nICJlbmQiIGNtZCBmb3IgbW9yZSB0aGFuIG9uZSB0aW1lCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIC8vIGRlY29kZSBibG9jayAmIHB1bGwgbmV3IGJsb2NrIChpZiBuZWVkZWQpCiAgICAgICAgICAgICAgICBjb25zdCBtYXBwZWRTdGFydE9mZnNldCA9IHRoaXMubWFwVG9Vbkxvb3BlZChpbmZvLCB0aGlzLmN0eC5zYW1wbGVPZmZzZXQpOwogICAgICAgICAgICAgICAgY29uc3QgbWFwcGVkRW5kT2Zmc2V0ID0gdGhpcy5tYXBUb1VuTG9vcGVkKGluZm8sIHRoaXMuY3R4LnNhbXBsZU9mZnNldCArIHJlbmRlclF1YW50dW1TaXplKTsKICAgICAgICAgICAgICAgIGNvbnN0IGluQmxvY2tTdGFydE9mZnNldCA9IG1hcHBlZFN0YXJ0T2Zmc2V0ICUgc2FtcGxlc1BlckJsb2NrOwogICAgICAgICAgICAgICAgY29uc3QgaW5CbG9ja0VuZE9mZnNldCA9IG1hcHBlZEVuZE9mZnNldCAlIHNhbXBsZXNQZXJCbG9jazsKICAgICAgICAgICAgICAgIGNvbnN0IHN0YXJ0QmxvY2tJbmRleCA9IChtYXBwZWRTdGFydE9mZnNldCAtIGluQmxvY2tTdGFydE9mZnNldCkgLyBzYW1wbGVzUGVyQmxvY2s7CiAgICAgICAgICAgICAgICBjb25zdCBlbmRCbG9ja0luZGV4ID0gKG1hcHBlZEVuZE9mZnNldCAtIGluQmxvY2tFbmRPZmZzZXQpIC8gc2FtcGxlc1BlckJsb2NrOwogICAgICAgICAgICAgICAgaWYgKGVuZEJsb2NrSW5kZXggIT0gdGhpcy5jdHgubGFzdERlY29kZWRCbG9ja0luZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVuZEJsb2NrSW5kZXggPCB0aGlzLmN0eC50b3RhbFB1bGxlZEJsb2NrQ291bnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYmxvY2sgaXMgYXZhaWxhYmxlIGZvciBkZWNvZGluZwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmN0eC5pc1N0YWxsaW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzdGFydCA9IGluZm8uYmxvY2tTaXplICogKGhhc0xvb3AKICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gZW5kQmxvY2tJbmRleAogICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBlbmRCbG9ja0luZGV4ICUgKHRoaXMuY3R4LnB1bGxCbG9ja0NvdW50ICogMikpOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgZW5kID0gc3RhcnQgKyBpbmZvLmJsb2NrU2l6ZTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVuZCA+IGVuY29kZWQubGVuZ3RoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJibG9jayBlbmQgb2Zmc2V0IGV4Y2VlZHMgYnVmZmVyIHNpemUiKTsKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEhDQS5kZWNvZGVCbG9jayh0aGlzLmN0eC5mcmFtZSwgZW5jb2RlZC5zdWJhcnJheShzdGFydCwgZW5kKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY3R4LmZhaWxlZEJsb2Nrcy5wdXNoKGVuZEJsb2NrSW5kZXgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jdHgubGFzdEVycm9yID0gZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY3R4LmZyYW1lLkNoYW5uZWxzLmZvckVhY2goKGMpID0+IHsgYy5QY21GbG9hdC5mb3JFYWNoKChzZikgPT4gc2YuZmlsbCgwKSk7IH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMud3JpdGVUb0RlY29kZWRCdWZmZXIodGhpcy5jdHguZnJhbWUsIHRoaXMuY3R4LmRlY29kZWQpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmN0eC5sYXN0RGVjb2RlZEJsb2NrSW5kZXggPSBlbmRCbG9ja0luZGV4OwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jdHgudG90YWxQdWxsZWRCbG9ja0NvdW50IDwgKGhhc0xvb3AgPyBpbmZvLmxvb3AuZW5kIDogaW5mby5mb3JtYXQuYmxvY2tDb3VudCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHB1bGwgYmxvY2tzIGluIGFkdmFuY2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhdmFpbGFibGVCbG9ja0NvdW50ID0gaGFzTG9vcCAmJiB0aGlzLmN0eC50b3RhbFB1bGxlZEJsb2NrQ291bnQgPj0gaW5mby5sb29wLmVuZCArIDEKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/ICJhbGxfcHVsbGVkIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogdGhpcy5jdHgudG90YWxQdWxsZWRCbG9ja0NvdW50IC0gKHRoaXMuY3R4Lmxhc3REZWNvZGVkQmxvY2tJbmRleCArIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBhdmFpbGFibGVCbG9ja0NvdW50ID09PSAnbnVtYmVyJyAmJiBhdmFpbGFibGVCbG9ja0NvdW50IDwgdGhpcy5jdHgucHVsbEJsb2NrQ291bnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnB1bGxOZXdCbG9ja3ModGhpcy5jdHgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBibG9jayBpcyB1bmF2YWlsYWJsZQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuY3R4LmlzU3RhbGxpbmcgJiYgdGhpcy5jdHgub25jZVN0YWxsZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHByaW50IGVycm9yIGFib3V0IHN0YWxsaW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oYFtIQ0FGcmFtZVBsYXllcl0gd2FpdGluZyB1bnRpbCBibG9jayAke2VuZEJsb2NrSW5kZXh9IGJlY29tZSBhdmFpbGFibGUuLi5gKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmN0eC5pc1N0YWxsaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wdWxsTmV3QmxvY2tzKHRoaXMuY3R4KTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gY29weSBkZWNvZGVkIGRhdGEKICAgICAgICAgICAgICAgIGlmIChvdXRwdXQubGVuZ3RoICE9IGluZm8uZm9ybWF0LmNoYW5uZWxDb3VudCkKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImNoYW5uZWwgY291bnQgbWlzbWF0Y2giKTsKICAgICAgICAgICAgICAgIGNvbnN0IGluQnVmZmVyU3RhcnRPZmZzZXQgPSAoZW5kQmxvY2tJbmRleCAhPSBzdGFydEJsb2NrSW5kZXggPyAwIDogc2FtcGxlc1BlckJsb2NrKSArIGluQmxvY2tTdGFydE9mZnNldDsKICAgICAgICAgICAgICAgIGNvbnN0IGluQnVmZmVyRW5kT2Zmc2V0ID0gc2FtcGxlc1BlckJsb2NrICsgaW5CbG9ja0VuZE9mZnNldDsKICAgICAgICAgICAgICAgIGNvbnN0IGluQnVmZmVyU3JjU2l6ZSA9IGluQnVmZmVyRW5kT2Zmc2V0IC0gaW5CdWZmZXJTdGFydE9mZnNldDsKICAgICAgICAgICAgICAgIGlmIChpbkJ1ZmZlclNyY1NpemUgPD0gMCkKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInNpemUgaW4gZGVjb2RlZCBidWZmZXIgc2hvdWxkIGJlIHBvc2l0aXZlIik7CiAgICAgICAgICAgICAgICBjb25zdCBjb3B5U2l6ZSA9IE1hdGgubWluKGluQnVmZmVyU3JjU2l6ZSwgcmVuZGVyUXVhbnR1bVNpemUpOwogICAgICAgICAgICAgICAgZm9yIChsZXQgY2hhbm5lbCA9IDA7IGNoYW5uZWwgPCBvdXRwdXQubGVuZ3RoOyBjaGFubmVsKyspIHsKICAgICAgICAgICAgICAgICAgICBsZXQgc3JjID0gZGVjb2RlZFtjaGFubmVsXS5zdWJhcnJheShpbkJ1ZmZlclN0YXJ0T2Zmc2V0LCBpbkJ1ZmZlclN0YXJ0T2Zmc2V0ICsgY29weVNpemUpOwogICAgICAgICAgICAgICAgICAgIG91dHB1dFtjaGFubmVsXS5zZXQoc3JjKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuY3R4LnNhbXBsZU9mZnNldCArPSBjb3B5U2l6ZTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJlZ2lzdGVyUHJvY2Vzc29yKCJoY2EtZnJhbWUtcGxheWVyIiwgSENBRnJhbWVQbGF5ZXIpOwogICAgfQogICAgZWxzZSB7CiAgICAgICAgLy8gV2ViIFdvcmtlcgogICAgICAgIGNvbnN0IHRhc2tRdWV1ZSA9IG5ldyBIQ0FUYXNrUXVldWUoIkJhY2tncm91bmQtSENBV29ya2VyIiwgKG1zZywgdHJhbnMpID0+IHBvc3RNZXNzYWdlKG1zZywgdHJhbnMpLCAodGFzaykgPT4gewogICAgICAgICAgICBzd2l0Y2ggKHRhc2suY21kKSB7CiAgICAgICAgICAgICAgICBjYXNlICJub3AiOgogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIGNhc2UgImZpeEhlYWRlckNoZWNrc3VtIjoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gSENBSW5mby5maXhIZWFkZXJDaGVja3N1bS5hcHBseShIQ0FJbmZvLCB0YXNrLmFyZ3MpOwogICAgICAgICAgICAgICAgY2FzZSAiZml4Q2hlY2tzdW0iOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBIQ0EuZml4Q2hlY2tzdW0uYXBwbHkoSENBLCB0YXNrLmFyZ3MpOwogICAgICAgICAgICAgICAgY2FzZSAiZmluZEtleSI6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEhDQS5maW5kS2V5LmFwcGx5KEhDQSwgdGFzay5hcmdzKTsKICAgICAgICAgICAgICAgIGNhc2UgImRlY3J5cHQiOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBIQ0EuZGVjcnlwdC5hcHBseShIQ0EsIHRhc2suYXJncyk7CiAgICAgICAgICAgICAgICBjYXNlICJlbmNyeXB0IjoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gSENBLmVuY3J5cHQuYXBwbHkoSENBLCB0YXNrLmFyZ3MpOwogICAgICAgICAgICAgICAgY2FzZSAiYWRkQ2lwaGVySGVhZGVyIjoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gSENBSW5mby5hZGRDaXBoZXJIZWFkZXIuYXBwbHkoSENBSW5mbywgdGFzay5hcmdzKTsKICAgICAgICAgICAgICAgIGNhc2UgImRlY29kZSI6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEhDQS5kZWNvZGUuYXBwbHkoSENBLCB0YXNrLmFyZ3MpOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHVua25vd24gY21kICR7dGFzay5jbWR9YCk7CiAgICAgICAgICAgIH0KICAgICAgICB9LCAoKSA9PiB7IHRhc2tRdWV1ZS5zZW5kQ21kKCJzZWxmLWRlc3RydWN0IiwgW10pOyB9KTsKICAgICAgICBvbm1lc3NhZ2UgPSAoZXYpID0+IHRhc2tRdWV1ZS5tc2dIYW5kbGVyKGV2KTsKICAgIH0KfQovLyBjcmVhdGUgJiBjb250cm9sIGF1ZGlvIHdvcmtsZXQKY2xhc3MgSENBQXVkaW9Xb3JrbGV0SENBUGxheWVyIHsKICAgIGdldCBpc0FsaXZlKCkgewogICAgICAgIHJldHVybiB0aGlzLnRhc2tRdWV1ZS5pc0FsaXZlOwogICAgfQogICAgZ2V0IGluaXRpYWxpemVkKCkgewogICAgICAgIHJldHVybiB0aGlzLl9pbml0aWFsaXplZDsKICAgIH0KICAgIGdldCB1bmxvY2tlZCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fdW5sb2NrZWQ7CiAgICB9CiAgICBnZXQgYmxvY2tDaGVja3N1bVZlcmlmaWNhdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy52ZXJpZnlDc3VtOwogICAgfQogICAgc2V0IGJsb2NrQ2hlY2tzdW1WZXJpZmljYXRpb24odmFsKSB7CiAgICAgICAgaWYgKHR5cGVvZiB2YWwgIT09ICJib29sZWFuIikKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgdGhpcy52ZXJpZnlDc3VtID0gdmFsOwogICAgfQogICAgZ2V0IGZlZWRTaXplKCkgewogICAgICAgIHJldHVybiB0aGlzLmluZm8uYmxvY2tTaXplICogdGhpcy5mZWVkQmxvY2tDb3VudDsKICAgIH0KICAgIGdldCByZW1haW5pbmdCbG9ja0NvdW50KCkgewogICAgICAgIGxldCB0b3RhbCA9IHRoaXMuaGFzTG9vcCA/IHRoaXMuaW5mby5sb29wLmVuZCArIDEgOiB0aGlzLmluZm8uZm9ybWF0LmJsb2NrQ291bnQ7CiAgICAgICAgbGV0IHJlbWFpbmluZyA9IHRvdGFsIC0gdGhpcy50b3RhbEZlZEJsb2NrQ291bnQ7CiAgICAgICAgaWYgKHJlbWFpbmluZyA8PSAwKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICByZXR1cm4gcmVtYWluaW5nOwogICAgfQogICAgZ2V0IGRvd25sb2FkQnVmZmVyU2l6ZSgpIHsKICAgICAgICBjb25zdCBieXRlc1BlclNlYyA9IHRoaXMuaW5mby5rYnBzICogMTAwMCAvIDg7CiAgICAgICAgcmV0dXJuIGJ5dGVzUGVyU2VjICogNDsKICAgIH0KICAgIHRhc2tIYW5kbGVyKHRhc2spIHsKICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgICBzd2l0Y2ggKHRhc2suY21kKSB7CiAgICAgICAgICAgICAgICBjYXNlICJub3AiOgogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIGNhc2UgInNlbGYtZGVzdHJ1Y3QiOiAvLyBkb2Vzbid0IHNlZW0gdG8gaGF2ZSBhIGNoYW5jZSB0byBiZSBjYWxsZWQKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBIQ0FGcmFtZVBsYXllciByZXF1ZXN0ZWQgdG8gc2VsZi1kZXN0cnVjdGApOwogICAgICAgICAgICAgICAgICAgIHlpZWxkIHRoaXMudGFza1F1ZXVlLnNodXRkb3duKHRydWUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIGNhc2UgImVuZCI6CiAgICAgICAgICAgICAgICAgICAgeWllbGQgdGhpcy5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOyAvLyBhY3R1YWxseSBub3Qgc2VuZGluZyBiYWNrIHJlcGx5CiAgICAgICAgICAgICAgICBjYXNlICJwdWxsIjoKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zb3VyY2UgPT0gbnVsbCkKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBub3RoaW5nIHRvIGZlZWRgKTsgLy8gc2hvdWxkIG5ldmVyIGhhcHBlbgogICAgICAgICAgICAgICAgICAgIGxldCBibG9ja0NvdW50ID0gTWF0aC5taW4odGhpcy5mZWVkQmxvY2tDb3VudCwgdGhpcy5yZW1haW5pbmdCbG9ja0NvdW50KTsKICAgICAgICAgICAgICAgICAgICBsZXQgc2l6ZSA9IHRoaXMuaW5mby5ibG9ja1NpemUgKiBibG9ja0NvdW50OwogICAgICAgICAgICAgICAgICAgIGxldCBuZXdCbG9ja3M7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc291cmNlIGluc3RhbmNlb2YgVWludDhBcnJheSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyB3aG9sZSBIQ0EgbW9kZQogICAgICAgICAgICAgICAgICAgICAgICBsZXQgc3RhcnQgPSB0aGlzLmluZm8uZGF0YU9mZnNldCArIHRoaXMuaW5mby5ibG9ja1NpemUgKiB0aGlzLnRvdGFsRmVkQmxvY2tDb3VudDsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGVuZCA9IHN0YXJ0ICsgc2l6ZTsKICAgICAgICAgICAgICAgICAgICAgICAgbmV3QmxvY2tzID0gdGhpcy5zb3VyY2Uuc3ViYXJyYXkoc3RhcnQsIGVuZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vfSBlbHNlIGlmICh0aGlzLnNvdXJjZSBpbnN0YW5jZW9mIFJlYWRhYmxlU3RyZWFtRGVmYXVsdFJlYWRlcikgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBjb21tZW50ZWQgb3V0IGJlY2F1c2UgRmlyZWZveCB0aHJvd3MgIlJlZmVyZW5jZUVycm9yOiBSZWFkYWJsZVN0cmVhbURlZmF1bHRSZWFkZXIgaXMgbm90IGRlZmluZWQiCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBVUkwgbW9kZQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zcmNCdWYgPT0gbnVsbCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigic3JjQnVmIGlzIHVuZGVmaW5lZCIpOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgbWF4RG93bmxhb2RTaXplID0gdGhpcy5pbmZvLmJsb2NrU2l6ZSAqIHRoaXMucmVtYWluaW5nQmxvY2tDb3VudDsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGRvd25sb2FkU2l6ZSA9IE1hdGgubWF4KHRoaXMuZG93bmxvYWRCdWZmZXJTaXplLCBzaXplKTsKICAgICAgICAgICAgICAgICAgICAgICAgZG93bmxvYWRTaXplID0gTWF0aC5taW4oZG93bmxvYWRTaXplLCBtYXhEb3dubGFvZFNpemUpOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgcmVtYWluaW5nID0gZG93bmxvYWRTaXplIC0gdGhpcy5zcmNCdWYubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVtYWluaW5nID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRklYTUUgY29ubmVjdGlvbiBsb3NzIGlzIG5vdCBoYW5kbGVkL3JlY292ZXJlZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zcmNCdWYgPSB5aWVsZCBIQ0FBdWRpb1dvcmtsZXRIQ0FQbGF5ZXIucmVhZEFuZEFwcGVuZCh0aGlzLnNvdXJjZSwgdGhpcy5zcmNCdWYsIHJlbWFpbmluZyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc3JjQnVmLmxlbmd0aCA8IHNpemUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInNyY0J1ZiBzdGlsbCBzbWFsbGVyIHRoYW4gZXhwZWN0ZWQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgbmV3QmxvY2tzID0gdGhpcy5zcmNCdWYuc3ViYXJyYXkoMCwgc2l6ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3JjQnVmID0gdGhpcy5zcmNCdWYuc2xpY2Uoc2l6ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwLCBzdGFydCA9IDA7IGkgPCBibG9ja0NvdW50OyBpKyssIHN0YXJ0ICs9IHRoaXMuaW5mby5ibG9ja1NpemUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGJsb2NrID0gbmV3QmxvY2tzLnN1YmFycmF5KHN0YXJ0LCBzdGFydCArIHRoaXMuaW5mby5ibG9ja1NpemUpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyB2ZXJpZnkgY2hlY2tzdW0gKGlmIGVuYWJsZWQpCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHdpbGwgdGhyb3cgJiBzdG9wIHBsYXlpbmcgb24gbWlzbWF0Y2ghCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnZlcmlmeUNzdW0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBIQ0FDcmMxNi52ZXJpZnkoYmxvY2ssIHRoaXMuaW5mby5ibG9ja1NpemUgLSAyKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gZGVjcnlwdCAoaWYgZW5jcnlwdGVkKQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jaXBoZXIgIT0gbnVsbCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2lwaGVyLm1hc2soYmxvY2ssIDAsIHRoaXMuaW5mby5ibG9ja1NpemUgLSAyKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gZml4IGNoZWNrc3VtCiAgICAgICAgICAgICAgICAgICAgICAgIEhDQUNyYzE2LmZpeChibG9jaywgdGhpcy5pbmZvLmJsb2NrU2l6ZSAtIDIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5oYXNMb29wKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGp1c3QgY29weSwgbm8gbmVlZCB0byBlbmxhcmdlCiAgICAgICAgICAgICAgICAgICAgICAgIG5ld0Jsb2NrcyA9IG5ld0Jsb2Nrcy5zbGljZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gZW5sYXJnZSAmIGNvcHkKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGRhdGEgPSBuZXdCbG9ja3M7CiAgICAgICAgICAgICAgICAgICAgICAgIG5ld0Jsb2NrcyA9IG5ldyBVaW50OEFycmF5KHRoaXMuZmVlZFNpemUpOwogICAgICAgICAgICAgICAgICAgICAgICBuZXdCbG9ja3Muc2V0KGRhdGEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLnRvdGFsRmVkQmxvY2tDb3VudCArPSBibG9ja0NvdW50OwogICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXdCbG9ja3M7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgdW5rbm93biBjbWQgIiR7dGFzay5jbWR9ImApOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CiAgICBzdGF0aWMgY3JlYXRlKHNlbGZVcmwsIHNvdXJjZSwga2V5MSwga2V5Miwgc3Via2V5KSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgaWYgKCEoc2VsZlVybCBpbnN0YW5jZW9mIFVSTCkpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICAgICAgaWYgKCEoc291cmNlIGluc3RhbmNlb2YgVWludDhBcnJheSB8fCBzb3VyY2UgaW5zdGFuY2VvZiBVUkwpKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgICAgIGxldCBhY3R1YWxTb3VyY2U7CiAgICAgICAgICAgIGxldCBpbmZvOwogICAgICAgICAgICBsZXQgc3JjQnVmID0gdW5kZWZpbmVkOwogICAgICAgICAgICBpZiAoc291cmNlIGluc3RhbmNlb2YgVWludDhBcnJheSkgewogICAgICAgICAgICAgICAgYWN0dWFsU291cmNlID0gc291cmNlLnNsaWNlKDApOwogICAgICAgICAgICAgICAgaW5mbyA9IG5ldyBIQ0FJbmZvKGFjdHVhbFNvdXJjZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoc291cmNlIGluc3RhbmNlb2YgVVJMKSB7CiAgICAgICAgICAgICAgICBjb25zdCBmZXRjaGVkID0geWllbGQgdGhpcy5nZXRIQ0FJbmZvRnJvbVVSTChzb3VyY2UpOwogICAgICAgICAgICAgICAgYWN0dWFsU291cmNlID0gZmV0Y2hlZC5yZWFkZXI7CiAgICAgICAgICAgICAgICBpbmZvID0gZmV0Y2hlZC5pbmZvOwogICAgICAgICAgICAgICAgc3JjQnVmID0gZmV0Y2hlZC5idWZmZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IoKTsKICAgICAgICAgICAgbGV0IGZlZWRCeXRlTWF4ID0gTWF0aC5mbG9vcih0aGlzLmZlZWRCeXRlTWF4KTsKICAgICAgICAgICAgaWYgKGZlZWRCeXRlTWF4IDwgaW5mby5ibG9ja1NpemUpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICAgICAgZmVlZEJ5dGVNYXggLT0gZmVlZEJ5dGVNYXggJSBpbmZvLmJsb2NrU2l6ZTsKICAgICAgICAgICAgY29uc3QgZmVlZEJsb2NrQ291bnQgPSBmZWVkQnl0ZU1heCAvIGluZm8uYmxvY2tTaXplOwogICAgICAgICAgICAvLyBpbml0aWFsaXplIGNpcGhlcgogICAgICAgICAgICBjb25zdCBjaXBoZXIgPSB0aGlzLmdldENpcGhlcihpbmZvLCBrZXkxLCBrZXkyLCBzdWJrZXkpOwogICAgICAgICAgICAvLyBjcmVhdGUgYXVkaW8gY29udGV4dAogICAgICAgICAgICBjb25zdCBhdWRpb0N0eCA9IG5ldyBBdWRpb0NvbnRleHQoewogICAgICAgICAgICAgICAgLy9sYXRlbmN5SGludDogInBsYXliYWNrIiwgLy8gRklYTUUgInBsYXliYWNrIiBzZWVtcyB0byBnbGl0Y2ggaWYgc3dpdGNoZWQgdG8gYmFja2dyb3VuZCBpbiBBbmRyb2lkCiAgICAgICAgICAgICAgICBzYW1wbGVSYXRlOiBpbmZvLmZvcm1hdC5zYW1wbGluZ1JhdGUsCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAvLyBjcmVhdGUgYXVkaW8gd29ya2xldCBub2RlIChub3QgeWV0IGNvbm5lY3RlZCkKICAgICAgICAgICAgeWllbGQgYXVkaW9DdHguYXVkaW9Xb3JrbGV0LmFkZE1vZHVsZShzZWxmVXJsKTsKICAgICAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHsKICAgICAgICAgICAgICAgIG51bWJlck9mSW5wdXRzOiAwLAogICAgICAgICAgICAgICAgbnVtYmVyT2ZPdXRwdXRzOiAxLAogICAgICAgICAgICAgICAgb3V0cHV0Q2hhbm5lbENvdW50OiBbaW5mby5mb3JtYXQuY2hhbm5lbENvdW50XSwKICAgICAgICAgICAgICAgIHByb2Nlc3Nvck9wdGlvbnM6IHsKICAgICAgICAgICAgICAgICAgICByYXdIZWFkZXI6IGluZm8uZ2V0UmF3SGVhZGVyKCksCiAgICAgICAgICAgICAgICAgICAgcHVsbEJsb2NrQ291bnQ6IGZlZWRCbG9ja0NvdW50LAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgY29uc3QgaGNhUGxheWVyTm9kZSA9IG5ldyBBdWRpb1dvcmtsZXROb2RlKGF1ZGlvQ3R4LCAiaGNhLWZyYW1lLXBsYXllciIsIG9wdGlvbnMpOwogICAgICAgICAgICAvLyBjcmVhdGUgZ2FpbiBub2RlCiAgICAgICAgICAgIGNvbnN0IGdhaW5Ob2RlID0gYXVkaW9DdHguY3JlYXRlR2FpbigpOwogICAgICAgICAgICBjb25zdCB1bmxvY2tlZCA9IHlpZWxkIHN1c3BlbmRBdWRpb0N0eElmVW5sb2NrZWQoYXVkaW9DdHgpOwogICAgICAgICAgICAvLyBjcmVhdGUgY29udHJvbGxlciBvYmplY3QKICAgICAgICAgICAgcmV0dXJuIG5ldyBIQ0FBdWRpb1dvcmtsZXRIQ0FQbGF5ZXIoc2VsZlVybCwgYXVkaW9DdHgsIHVubG9ja2VkLCBoY2FQbGF5ZXJOb2RlLCBnYWluTm9kZSwgZmVlZEJsb2NrQ291bnQsIGluZm8sIGFjdHVhbFNvdXJjZSwgc3JjQnVmLCBjaXBoZXIpOwogICAgICAgIH0pOwogICAgfQogICAgX3Rlcm1pbmF0ZSgpIHsKICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgICAvLyBJIGRpZG4ndCBmaW5kIHRlcm1pbmF0ZSgpIGZvciBBdWRpb1dvcmtsZXQgc28gSSBtYWRlIG9uZQogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdGhpcy5oY2FQbGF5ZXJOb2RlLnBvcnQuY2xvc2UoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgZXJyb3IgdHJ5aW5nIHRvIGNsb3NlIG1lc3NhZ2UgcG9ydGAsIGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB0aGlzLmhjYVBsYXllck5vZGUuZGlzY29ubmVjdCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBlcnJvciB0cnlpbmcgdG8gZGlzY29ubmVjdCBoY2FQbGF5ZXJOb2RlYCwgZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHRoaXMuZ2Fpbk5vZGUuZGlzY29ubmVjdCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBlcnJvciB0cnlpbmcgdG8gZGlzY29ubmVjdCBnYWluTm9kZWAsIGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLmF1ZGlvQ3R4LmNsb3NlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYGVycm9yIHRyeWluZyB0byBjbG9zZSBhdWRpbyBjb250ZXh0YCwgZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KICAgIGNvbnN0cnVjdG9yKHNlbGZVcmwsIGF1ZGlvQ3R4LCB1bmxvY2tlZCwgaGNhUGxheWVyTm9kZSwgZ2Fpbk5vZGUsIGZlZWRCbG9ja0NvdW50LCBpbmZvLCBzb3VyY2UsIHNyY0J1ZiwgY2lwaGVyKSB7CiAgICAgICAgdGhpcy5faW5pdGlhbGl6ZWQgPSB0cnVlOyAvLyBpbml0aWFsbHkgdGhlcmUgbXVzdCBiZSBzb21ldGhpbmcgdG8gcGxheQogICAgICAgIHRoaXMuaXNQbGF5aW5nID0gZmFsc2U7CiAgICAgICAgdGhpcy52ZXJpZnlDc3VtID0gZmFsc2U7CiAgICAgICAgdGhpcy50b3RhbEZlZEJsb2NrQ291bnQgPSAwOwogICAgICAgIHRoaXMuc3RvcENtZEl0ZW0gPSB7CiAgICAgICAgICAgIC8vIGV4ZWMgInJlc2V0IiBjbWQgZmlyc3QsIGluIG9yZGVyIHRvIGF2b2lkICJyZXNpZHVlIiBidXJzdCBub2lzZSB0byBiZSBwbGF5ZWQgaW4gdGhlIGZ1dHVyZSAob2JzZXJ2ZWQgaW4gQ2hyb21lKQogICAgICAgICAgICBjbWQ6ICJyZXNldCIsIGFyZ3M6IFtdLCBob29rOiB7CiAgICAgICAgICAgICAgICB0YXNrOiAodGFzaykgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc0FsaXZlKQogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImRlYWQiKTsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNQbGF5aW5nKQogICAgICAgICAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLl9yZXN1bWUoKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGFzazsKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgcmVzdWx0OiAoKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAgICAgICAgICAgeWllbGQgdGhpcy5fc3VzcGVuZCgpOyAvLyBjYW4gbm93IHN1c3BlbmQKICAgICAgICAgICAgICAgICAgICB0aGlzLl9pbml0aWFsaXplZCA9IGZhbHNlOyAvLyBub3cgd2UgaGF2ZSBub3RoaW5nIHRvIHBsYXkgdW50aWwgbmV4dCBzZXRTb3VyY2UKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5zb3VyY2UgIT0gbnVsbCAmJiAhKHRoaXMuc291cmNlIGluc3RhbmNlb2YgVWludDhBcnJheSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgeWllbGQgdGhpcy5zb3VyY2UuY2FuY2VsKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLnNvdXJjZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdGhpcy5zZWxmVXJsID0gc2VsZlVybDsKICAgICAgICB0aGlzLmF1ZGlvQ3R4ID0gYXVkaW9DdHg7CiAgICAgICAgdGhpcy5fdW5sb2NrZWQgPSB1bmxvY2tlZDsKICAgICAgICB0aGlzLnRhc2tRdWV1ZSA9IG5ldyBIQ0FUYXNrUXVldWUoIk1haW4tSENBQXVkaW9Xb3JrbGV0SENBUGxheWVyIiwgKG1zZywgdHJhbnMpID0+IGhjYVBsYXllck5vZGUucG9ydC5wb3N0TWVzc2FnZShtc2csIHRyYW5zKSwgKHRhc2spID0+IHRoaXMudGFza0hhbmRsZXIodGFzayksICgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsgcmV0dXJuIHlpZWxkIHRoaXMuX3Rlcm1pbmF0ZSgpOyB9KSk7CiAgICAgICAgaGNhUGxheWVyTm9kZS5wb3J0Lm9ubWVzc2FnZSA9IChldikgPT4gdGhpcy50YXNrUXVldWUubXNnSGFuZGxlcihldik7CiAgICAgICAgaGNhUGxheWVyTm9kZS5wb3J0Lm9ubWVzc2FnZWVycm9yID0gKGV2KSA9PiB0aGlzLnRhc2tRdWV1ZS5lcnJIYW5kbGVyKGV2KTsKICAgICAgICBoY2FQbGF5ZXJOb2RlLm9ucHJvY2Vzc29yZXJyb3IgPSAoZXYpID0+IHRoaXMudGFza1F1ZXVlLmVyckhhbmRsZXIoZXYpOwogICAgICAgIHRoaXMuaGNhUGxheWVyTm9kZSA9IGhjYVBsYXllck5vZGU7CiAgICAgICAgdGhpcy5nYWluTm9kZSA9IGdhaW5Ob2RlOwogICAgICAgIHRoaXMuZmVlZEJsb2NrQ291bnQgPSBmZWVkQmxvY2tDb3VudDsKICAgICAgICB0aGlzLmluZm8gPSBpbmZvOwogICAgICAgIHRoaXMuc291cmNlID0gc291cmNlOwogICAgICAgIHRoaXMuY2lwaGVyID0gY2lwaGVyOwogICAgICAgIHRoaXMuc3JjQnVmID0gc3JjQnVmOwogICAgICAgIHRoaXMuc2FtcGxlUmF0ZSA9IGluZm8uZm9ybWF0LnNhbXBsaW5nUmF0ZTsKICAgICAgICB0aGlzLmNoYW5uZWxDb3VudCA9IGluZm8uZm9ybWF0LmNoYW5uZWxDb3VudDsKICAgICAgICB0aGlzLmhhc0xvb3AgPSBpbmZvLmhhc0hlYWRlclsibG9vcCJdID8gdHJ1ZSA6IGZhbHNlOwogICAgfQogICAgc3RhdGljIGdldENpcGhlcihpbmZvLCBrZXkxLCBrZXkyLCBzdWJrZXkpIHsKICAgICAgICAvLyBoYW5kbGUgc3Via2V5CiAgICAgICAgbGV0IG1peGVkID0gSENBQ2lwaGVyLm1peFdpdGhTdWJrZXkoa2V5MSwga2V5Miwgc3Via2V5KTsKICAgICAgICBrZXkxID0gbWl4ZWQua2V5MTsKICAgICAgICBrZXkyID0gbWl4ZWQua2V5MjsKICAgICAgICBzd2l0Y2ggKGluZm8uY2lwaGVyKSB7CiAgICAgICAgICAgIGNhc2UgMDoKICAgICAgICAgICAgICAgIC8vIG5vdCBlbmNyeXB0ZWQKICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICAgIC8vIGVuY3J5cHRlZCB3aXRoICJubyBrZXkiCiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEhDQUNpcGhlcigibm9uZSIpOyAvLyBpZ25vcmUgZ2l2ZW4ga2V5cwogICAgICAgICAgICBjYXNlIDB4Mzg6CiAgICAgICAgICAgICAgICAvLyBlbmNyeXB0ZWQgd2l0aCBrZXlzIC0gd2lsbCB5aWVsZCBpbmNvcnJlY3Qgd2F2ZWZvcm0gaWYgaW5jb3JyZWN0IGtleXMgYXJlIGdpdmVuIQogICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBIQ0FDaXBoZXIoa2V5MSwga2V5Mik7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInVua25vd24gY2lwaC50eXBlIik7CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIHJlYWRBbmRBcHBlbmQocmVhZGVyLCBkYXRhLCBtaW5Db3VudCkgewogICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAgIGlmIChtaW5Db3VudCA8IDApCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICAgICAgY29uc3QgZGVzaXJlZCA9IGRhdGEubGVuZ3RoICsgbWluQ291bnQ7CiAgICAgICAgICAgIGxldCBuZXdEYXRhID0gbmV3IFVpbnQ4QXJyYXkoZGVzaXJlZCk7CiAgICAgICAgICAgIG5ld0RhdGEuc2V0KGRhdGEpOwogICAgICAgICAgICBmb3IgKGxldCBvZmZzZXQgPSBkYXRhLmxlbmd0aDsgb2Zmc2V0IDwgZGVzaXJlZDspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHJlcyA9IHlpZWxkIHJlYWRlci5yZWFkKCk7CiAgICAgICAgICAgICAgICBpZiAocmVzLmRvbmUpCiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGB1bmV4cGVjdGVkIHN0cmVhbSBlbmQuIGAKICAgICAgICAgICAgICAgICAgICAgICAgKyBgaXQgaXMgcG9zc2libGUgdGhhdCB0aGUgZG93bmxvYWQgaGFzIGJlZW4gY2FuY2VsZWQgKGJ5IGxhdGVyIHNldFNvdXJjZSksIG9yIHRoZSBmaWxlIGRhdGEgaXMgaW5jb21wbGV0ZWApOwogICAgICAgICAgICAgICAgY29uc3QgYnl0ZXMgPSByZXMudmFsdWU7CiAgICAgICAgICAgICAgICBpZiAoYnl0ZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlcXVpcmVkID0gb2Zmc2V0ICsgYnl0ZXMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIGlmIChyZXF1aXJlZCA+IG5ld0RhdGEubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGV4aXN0aW5nID0gbmV3RGF0YTsKICAgICAgICAgICAgICAgICAgICAgICAgbmV3RGF0YSA9IG5ldyBVaW50OEFycmF5KHJlcXVpcmVkKTsKICAgICAgICAgICAgICAgICAgICAgICAgbmV3RGF0YS5zZXQoZXhpc3RpbmcpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBuZXdEYXRhLnNldChieXRlcywgb2Zmc2V0KTsKICAgICAgICAgICAgICAgICAgICBvZmZzZXQgKz0gYnl0ZXMubGVuZ3RoOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBuZXdEYXRhOwogICAgICAgIH0pOwogICAgfQogICAgc3RhdGljIGdldEhDQUluZm9Gcm9tVVJMKHVybCkgewogICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAgIC8vIEZJWE1FIHNlbmQgSFRUUCBSYW5nZSByZXF1ZXN0IHRvIGF2b2lkIGJsb2NraW5nIGxhdGVyIHJlcXVlc3RzIChlc3BlY2lhbGx5IGluIEZpcmVmb3gpCiAgICAgICAgICAgIGNvbnN0IHJlc3AgPSB5aWVsZCBmZXRjaCh1cmwuaHJlZik7CiAgICAgICAgICAgIGlmIChyZXNwLnN0YXR1cyAhPSAyMDApCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYHN0YXR1cyAke3Jlc3Auc3RhdHVzfWApOwogICAgICAgICAgICBpZiAocmVzcC5ib2R5ID09IG51bGwpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInJlc3BvbnNlIGhhcyBubyBib2R5Iik7CiAgICAgICAgICAgIGNvbnN0IHJlYWRlciA9IHJlc3AuYm9keS5nZXRSZWFkZXIoKTsKICAgICAgICAgICAgbGV0IGJ1ZmZlciA9IHlpZWxkIHRoaXMucmVhZEFuZEFwcGVuZChyZWFkZXIsIG5ldyBVaW50OEFycmF5KDApLCA4KTsKICAgICAgICAgICAgY29uc3QgZGF0YU9mZnNldCA9IG5ldyBEYXRhVmlldyhidWZmZXIuYnVmZmVyLCBidWZmZXIuYnl0ZU9mZnNldCwgYnVmZmVyLmJ5dGVMZW5ndGgpLmdldFVpbnQxNig2KTsKICAgICAgICAgICAgY29uc3QgcmVtYWluaW5nID0gZGF0YU9mZnNldCAtIGJ1ZmZlci5sZW5ndGg7CiAgICAgICAgICAgIGlmIChyZW1haW5pbmcgPiAwKSB7CiAgICAgICAgICAgICAgICBidWZmZXIgPSB5aWVsZCB0aGlzLnJlYWRBbmRBcHBlbmQocmVhZGVyLCBidWZmZXIsIHJlbWFpbmluZyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIHJlYWRlcjogcmVhZGVyLAogICAgICAgICAgICAgICAgaW5mbzogbmV3IEhDQUluZm8oYnVmZmVyKSwKICAgICAgICAgICAgICAgIGJ1ZmZlcjogYnVmZmVyLnNsaWNlKGRhdGFPZmZzZXQpLAogICAgICAgICAgICB9OwogICAgICAgIH0pOwogICAgfQogICAgc2V0U291cmNlKHNvdXJjZSwga2V5MSwga2V5Miwgc3Via2V5KSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgbGV0IG5ld0luZm87CiAgICAgICAgICAgIGxldCBuZXdTb3VyY2U7CiAgICAgICAgICAgIGxldCBuZXdCdWZmZXIgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIGNvbnN0IGluaXRpYWxpemVDbWRJdGVtID0gewogICAgICAgICAgICAgICAgY21kOiAiaW5pdGlhbGl6ZSIsIGFyZ3M6IFtudWxsXSwgaG9vazogewogICAgICAgICAgICAgICAgICAgIHRhc2s6ICh0YXNrKSA9PiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc0FsaXZlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJkZWFkIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG9sZFNvdXJjZSA9IHRoaXMuc291cmNlOwogICAgICAgICAgICAgICAgICAgICAgICAvL2lmIChvbGRTb3VyY2UgaW5zdGFuY2VvZiBSZWFkYWJsZVN0cmVhbURlZmF1bHRSZWFkZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9sZFNvdXJjZSAhPSBudWxsICYmICEob2xkU291cmNlIGluc3RhbmNlb2YgVWludDhBcnJheSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeWllbGQgb2xkU291cmNlLmNhbmNlbCgpOyAvLyBzdG9wIGRvd25sb2FkaW5nIGZyb20gcHJldmlvdXMgVVJMCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRklYTUUgRmlyZWZveCBkb2Vzbid0IHNlZW0gdG8gYWJvcnQgcHJldmlvdXMgZG93bmxvYWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgZXJyb3Igd2hlbiBjYW5jZWxsaW5nIHByZXZpb3VzIGRvd25sb2FkLmAsIGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzb3VyY2UgaW5zdGFuY2VvZiBVaW50OEFycmF5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdTb3VyY2UgPSBzb3VyY2Uuc2xpY2UoMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdJbmZvID0gbmV3IEhDQUluZm8obmV3U291cmNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChzb3VyY2UgaW5zdGFuY2VvZiBVUkwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHlpZWxkIEhDQUF1ZGlvV29ya2xldEhDQVBsYXllci5nZXRIQ0FJbmZvRnJvbVVSTChzb3VyY2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3U291cmNlID0gcmVzdWx0LnJlYWRlcjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0luZm8gPSByZXN1bHQuaW5mbzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0J1ZmZlciA9IHJlc3VsdC5idWZmZXI7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJpbnZhbGlkIHNvdXJjZSIpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyBzYW1wbGUgcmF0ZSBhbmQgY2hhbm5lbCBjb3VudCBpcyBpbW11dGFibGUsCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZXJlZm9yZSwgdGhlIG9ubHkgd2F5IHRvIGNoYW5nZSB0aGVtIGlzIHRvIHJlY3JlYXRlIGEgbmV3IGluc3RhbmNlLgogICAgICAgICAgICAgICAgICAgICAgICAvLyBob3dldmVyLCB0aGVyZSBpcyBhIG1lbWxlYWsgYnVnIGluIENocm9taXVtLCB0aGF0OgogICAgICAgICAgICAgICAgICAgICAgICAvLyAobm8tbG9uZ2VyLXVzZWQpIGF1ZGlvIHdvcmtsZXQgbm9kZShzKSB3b24ndCBiZSByZWN5Y2xlZDoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaHR0cHM6Ly9idWdzLmNocm9taXVtLm9yZy9wL2Nocm9taXVtL2lzc3Vlcy9kZXRhaWw/aWQ9MTI5ODk1NQogICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV3SW5mby5mb3JtYXQuc2FtcGxpbmdSYXRlICE9IHRoaXMuc2FtcGxlUmF0ZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigic2FtcGxlIHJhdGUgbWlzbWF0Y2giKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5ld0luZm8uZm9ybWF0LmNoYW5uZWxDb3VudCAhPSB0aGlzLmNoYW5uZWxDb3VudCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiY2hhbm5lbCBjb3VudCBtaXNtYXRjaCIpOwogICAgICAgICAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLl9yZXN1bWUoKTsgLy8gcmVzdW1lIGl0LCBzbyB0aGF0IGNtZCBjYW4gdGhlbiBiZSBleGVjdXRlZAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXdQcm9jT3B0cyA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhd0hlYWRlcjogbmV3SW5mby5nZXRSYXdIZWFkZXIoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB1bGxCbG9ja0NvdW50OiB0aGlzLmZlZWRCbG9ja0NvdW50LAogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEhDQVRhc2sodGFzay5vcmlnaW4sIHRhc2sudGFza0lELCB0YXNrLmNtZCwgW25ld1Byb2NPcHRzXSwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgIH0pLCByZXN1bHQ6ICgpID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgeWllbGQgdGhpcy5fc3VzcGVuZCgpOyAvLyBpbml0aWFsaXplZCwgYnV0IGl0J3MgcGF1c2VkLCB1bnRpbCBiZWluZyByZXF1ZXN0ZWQgdG8gc3RhcnQvcGxheSAocmVzdW1lKQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRvdGFsRmVkQmxvY2tDb3VudCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2lwaGVyID0gSENBQXVkaW9Xb3JrbGV0SENBUGxheWVyLmdldENpcGhlcihuZXdJbmZvLCBrZXkxLCBrZXkyLCBzdWJrZXkpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmluZm8gPSBuZXdJbmZvOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNvdXJjZSA9IG5ld1NvdXJjZTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zcmNCdWYgPSBuZXdCdWZmZXI7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaGFzTG9vcCA9IG5ld0luZm8uaGFzSGVhZGVyWyJsb29wIl0gPyB0cnVlIDogZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2luaXRpYWxpemVkID0gdHJ1ZTsgLy8gYWdhaW4gd2Ugbm93IGhhdmUgc29tZXRoaW5nIHRvIHBsYXkKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICB5aWVsZCB0aGlzLnRhc2tRdWV1ZS5leGVjTXVsdGlDbWQoW3RoaXMuc3RvcENtZEl0ZW0sIGluaXRpYWxpemVDbWRJdGVtXSk7IC8vIGVuc3VyZSBhdG9taWNpdHkKICAgICAgICB9KTsKICAgIH0KICAgIC8vIG5vdCBzdXBwb3NlZCB0byBiZSB1c2VkIGRpcmVjdGx5CiAgICBfcmVzdW1lKCkgewogICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5pc0FsaXZlKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJkZWFkIik7CiAgICAgICAgICAgIGlmICh0aGlzLmlzUGxheWluZykKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgeWllbGQgdGhpcy5hdWRpb0N0eC5yZXN1bWUoKTsKICAgICAgICAgICAgdGhpcy5oY2FQbGF5ZXJOb2RlLmNvbm5lY3QodGhpcy5nYWluTm9kZSk7CiAgICAgICAgICAgIHRoaXMuZ2Fpbk5vZGUuY29ubmVjdCh0aGlzLmF1ZGlvQ3R4LmRlc3RpbmF0aW9uKTsKICAgICAgICAgICAgdGhpcy5pc1BsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICAvLyBtYXJrIGFzIHVubG9ja2VkCiAgICAgICAgICAgIGlmICghdGhpcy5fdW5sb2NrZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3VubG9ja2VkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihgYXVkaW8gY29udGV4dCBmb3Igc2FtcGxlUmF0ZT0ke3RoaXMuYXVkaW9DdHguc2FtcGxlUmF0ZX0gaXMgbm93IHJlc3VtZWQvdW5sb2NrZWRgKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfQogICAgX3N1c3BlbmQoKSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLmlzQWxpdmUpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImRlYWQiKTsKICAgICAgICAgICAgaWYgKCF0aGlzLmlzUGxheWluZykKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgdGhpcy5oY2FQbGF5ZXJOb2RlLmRpc2Nvbm5lY3QoKTsKICAgICAgICAgICAgdGhpcy5nYWluTm9kZS5kaXNjb25uZWN0KCk7CiAgICAgICAgICAgIHlpZWxkIHRoaXMuYXVkaW9DdHguc3VzcGVuZCgpOwogICAgICAgICAgICB0aGlzLmlzUGxheWluZyA9IGZhbHNlOwogICAgICAgIH0pOwogICAgfQogICAgLy8gd3JhcGVkIHRvIGVuc3VyZSBhdG9taWNpdHkKICAgIHNldFBsYXlpbmcodG9QbGF5KSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgLy8gc2ltbGlsYXIgdG8gc3RvcENtZEl0ZW0gYWJvdmUsIHNlbmQgInBhdXNlIiBjbWQgdG8gYXZvaWQgInJlc2lkdWUiIGJ1cnN0IG5vaXNlCiAgICAgICAgICAgIHlpZWxkIHRoaXMudGFza1F1ZXVlLmV4ZWNDbWQodG9QbGF5ID8gInJlc3VtZSIgOiAicGF1c2UiLCBbXSwgewogICAgICAgICAgICAgICAgdGFzazogKHRhc2spID0+IF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNBbGl2ZSkKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJkZWFkIik7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNQbGF5aW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0b1BsYXkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXNrLmlzRHVtbXkgPSB0cnVlOyAvLyBhbHJlYWR5IHJlc3VtZWQsIG5vdCBzZW5kaW5nIGNtZAogICAgICAgICAgICAgICAgICAgICAgICAvLyBlbHNlIHNob3VsZCBzdGlsbCBrZWVwIHBsYXlpbmcgdW50aWwgInBhdXNlIiBjbWQgcmV0dXJucwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRvUGxheSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9pbml0aWFsaXplZCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYG5vdCBpbml0aWFsaXplZCBidXQgc3RpbGwgYXR0ZW1wdCB0byByZXN1bWVgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHlpZWxkIHRoaXMuX3Jlc3VtZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhc2suaXNEdW1teSA9IHRydWU7IC8vIGFscmVhZHkgcGF1c2VkLCBub3Qgc2VuZGluZyBjbWQKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRhc2s7CiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIHJlc3VsdDogKCkgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgICAgICAgICAgIGlmICh0b1BsYXkpCiAgICAgICAgICAgICAgICAgICAgICAgIHlpZWxkIHRoaXMuX3Jlc3VtZSgpOwogICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgeWllbGQgdGhpcy5fc3VzcGVuZCgpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfSk7CiAgICAgICAgfSk7CiAgICB9CiAgICBwYXVzZSgpIHsKICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgICB5aWVsZCB0aGlzLnNldFBsYXlpbmcoZmFsc2UpOwogICAgICAgIH0pOwogICAgfQogICAgcGxheSgpIHsKICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgICAvLyBpbiBhcHBsZSB3ZWJraXQsIGF1ZGlvIGNvbnRleHQgaXMgc3VzcGVuZGVkL2xvY2tlZCBpbml0aWFsbHksCiAgICAgICAgICAgIC8vIChvdGhlciBicm93c2VycyBsaWtlIEZpcmVmb3ggbWF5IGhhdmUgc2ltaWxhciBidXQgbGVzcyBzdHJpY3QgcmVzdHJpY3Rpb25zKQogICAgICAgICAgICAvLyB0byByZXN1bWUvdW5sb2NrIGl0LCBmaXJzdCByZXN1bWUoKSBjYWxsIG11c3QgYmUgdHJpZ2dlcmVkIGJ5IGZyb20gVUkgZXZlbnQsCiAgICAgICAgICAgIC8vIHdoaWNoIG11c3Qgbm90IGJlIGFmdGVyIGF3YWl0CiAgICAgICAgICAgIHlpZWxkIHRoaXMuc2V0UGxheWluZyh0cnVlKTsKICAgICAgICB9KTsKICAgIH0KICAgIHN0b3AoKSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgLy8gY2FuIHVubG9jayB0aGUgbG9ja2VkIGF1ZGlvIGNvbnRleHQgYXMgd2VsbCBiZWNhdXNlIGl0J3MgcmVzdW1lZCBmaXJzdGx5IGJlZm9yZSBmaW5hbGx5IHN1c3BlbmRlZAogICAgICAgICAgICBjb25zdCBpdGVtID0gdGhpcy5zdG9wQ21kSXRlbTsKICAgICAgICAgICAgeWllbGQgdGhpcy50YXNrUXVldWUuZXhlY0NtZChpdGVtLmNtZCwgaXRlbS5hcmdzLCBpdGVtLmhvb2spOwogICAgICAgIH0pOwogICAgfQogICAgc2h1dGRvd24oZm9yY2libHkgPSBmYWxzZSkgewogICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5pc0FsaXZlKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBhbHJlYWR5IHNodXRkb3duYCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgeWllbGQgdGhpcy50YXNrUXVldWUuc2h1dGRvd24oZm9yY2libHkpOwogICAgICAgIH0pOwogICAgfQp9CkhDQUF1ZGlvV29ya2xldEhDQVBsYXllci5mZWVkQnl0ZU1heCA9IDMyNzY4OwovLyBjcmVhdGUgJiBjb250cm9sIHdvcmtlcgpleHBvcnQgY2xhc3MgSENBV29ya2VyIHsKICAgIGdldCBpc0FsaXZlKCkgewogICAgICAgIHJldHVybiB0aGlzLnRhc2tRdWV1ZS5pc0FsaXZlOwogICAgfQogICAgc2h1dGRvd24oZm9yY2libHkgPSBmYWxzZSkgewogICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnRhc2tRdWV1ZS5pc0FsaXZlKQogICAgICAgICAgICAgICAgeWllbGQgdGhpcy50YXNrUXVldWUuc2h1dGRvd24oZm9yY2libHkpOwogICAgICAgICAgICBpZiAodGhpcy5hd0hjYVBsYXllciAhPSBudWxsICYmIHRoaXMuYXdIY2FQbGF5ZXIuaXNBbGl2ZSkKICAgICAgICAgICAgICAgIHlpZWxkIHRoaXMuYXdIY2FQbGF5ZXIuc2h1dGRvd24oZm9yY2libHkpOwogICAgICAgIH0pOwogICAgfQogICAgdGljaygpIHsKICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgICB5aWVsZCB0aGlzLnRhc2tRdWV1ZS5leGVjQ21kKCJub3AiLCBbXSk7CiAgICAgICAgICAgIHRoaXMubGFzdFRpY2sgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgICAgICB9KTsKICAgIH0KICAgIHRvY2sodGV4dCA9ICIiKSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgeWllbGQgdGhpcy50YXNrUXVldWUuZXhlY0NtZCgibm9wIiwgW10pOwogICAgICAgICAgICBjb25zdCBkdXJhdGlvbiA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdGhpcy5sYXN0VGljazsKICAgICAgICAgICAgY29uc29sZS5sb2coYCR7dGV4dH0gdG9vayAke2R1cmF0aW9ufSBtc2ApOwogICAgICAgICAgICByZXR1cm4gZHVyYXRpb247CiAgICAgICAgfSk7CiAgICB9CiAgICBzdGF0aWMgY3JlYXRlKHNlbGZVcmwpIHsKICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgICBpZiAodHlwZW9mIHNlbGZVcmwgPT09ICJzdHJpbmciKQogICAgICAgICAgICAgICAgc2VsZlVybCA9IG5ldyBVUkwoc2VsZlVybCwgZG9jdW1lbnQuYmFzZVVSSSk7CiAgICAgICAgICAgIGVsc2UgaWYgKCEoc2VsZlVybCBpbnN0YW5jZW9mIFVSTCkpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInNlbGZVcmwgbXVzdCBiZSBlaXRoZXIgc3RyaW5nIG9yIFVSTCIpOwogICAgICAgICAgICAvLyBmZXRjaCAmIHNhdmUgaGNhLmpzIGFzIGJsb2IgaW4gYWR2YW5jZSwgdG8gYXZvaWQgY3JlYXRpbmcgd29ya2VyIGJlaW5nIGJsb2NrZWQgbGF0ZXIsIGxpa2U6CiAgICAgICAgICAgIC8vIChJIG9ic2VydmVkIHRoaXMgcHJvYmxlbSBpbiBGaXJlZm94KQogICAgICAgICAgICAvLyBjcmVhdGluZyBIQ0FBdWRpb1dvcmtsZXRIQ0FQbGF5ZXIgcmVxdWlyZXMgaW5mb3JtYXRpb24gZnJvbSBIQ0EsIHdoaWNoIGlzIHNhbXBsZSByYXRlIGFuZCBjaGFubmVsIGNvdW50OwogICAgICAgICAgICAvLyBob3dldmVyLCBmZXRjaGluZyBIQ0EgKG9yaWdpbmFsbHkgc3VwcG9zZWQgdG8gYmUgcHJvZ3Jlc3NpdmUvc3RyZWFtZWQpIGJsb2NrcyBsYXRlciByZXF1ZXN0IHRvIGZldGNoIGhjYS5qcywKICAgICAgICAgICAgLy8gc28gdGhhdCBIQ0FBdWRpb1dvcmtsZXRIQ0FQbGF5ZXIgY2FuIG9ubHkgYmUgY3JlYXRlZCBhZnRlciBmaW5pc2hpbmcgZG93bmxvYWRpbmcgdGhlIHdob2xlIEhDQSwKICAgICAgICAgICAgLy8gd2hpY2ggb2J2aW91c2x5IGRlZmVhdHMgdGhlIHB1cnBvc2Ugb2Ygc3RyZWFtaW5nIEhDQQogICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IHlpZWxkIGZldGNoKHNlbGZVcmwuaHJlZik7CiAgICAgICAgICAgIC8vIEZpcmVmb3ggY3VycmVudGx5IGRvZXMgbm90IHN1cHBvcnQgRUNNQVNjcmlwdCBtb2R1bGVzIGluIFdvcmtlciwKICAgICAgICAgICAgLy8gdGhlcmVmb3JlIHdlIG11c3Qgc3RyaXAgYWxsIGV4cG9ydCBkZWNsYXJhdGlvbnMKICAgICAgICAgICAgY29uc3Qgb3JpZ1RleHQgPSB5aWVsZCByZXNwb25zZS50ZXh0KCk7CiAgICAgICAgICAgIGNvbnN0IGNvbnZlcnRlZFRleHQgPSAoIlxuIiArIG9yaWdUZXh0KS5yZXBsYWNlKC8oKFxufDspWyBcdF0qKSgoZXhwb3J0WyBcdF0rXHsuKj9cfVsgXHRdKjt7MCwxfSkrfChleHBvcnRbIFx0XSspKS9nLCAiJDEiKS5zbGljZSgxKTsKICAgICAgICAgICAgY29uc3QgYmxvYiA9IG5ldyBCbG9iKFtjb252ZXJ0ZWRUZXh0XSwgeyB0eXBlOiAidGV4dC9qYXZhc2NyaXB0IiB9KTsKICAgICAgICAgICAgY29uc3QgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKTsKICAgICAgICAgICAgcmVhZGVyLnJlYWRBc0RhdGFVUkwoYmxvYik7CiAgICAgICAgICAgIGNvbnN0IGRhdGFVUkkgPSB5aWVsZCBuZXcgUHJvbWlzZSgocmVzKSA9PiB7CiAgICAgICAgICAgICAgICByZWFkZXIub25sb2FkZW5kID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJlcyhyZWFkZXIucmVzdWx0KTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBzZWxmVXJsID0gbmV3IFVSTChkYXRhVVJJLCBkb2N1bWVudC5iYXNlVVJJKTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBIQ0FXb3JrZXIoc2VsZlVybCwgYmxvYik7CiAgICAgICAgfSk7CiAgICB9CiAgICBjb25zdHJ1Y3RvcihzZWxmVXJsLCBzZWxmQmxvYikgewogICAgICAgIHRoaXMubGFzdFRpY2sgPSAwOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHRoaXMuaGNhV29ya2VyID0gbmV3IFdvcmtlcihzZWxmVXJsLCB7IHR5cGU6ICJtb2R1bGUiIH0pOyAvLyBzZXR0aW5nIHR5cGUgdG8gIm1vZHVsZSIgaXMgY3VycmVudGx5IGJvZ3VzIGluIEZpcmVmb3gKICAgICAgICB9CiAgICAgICAgY2F0Y2ggKGUpIHsKICAgICAgICAgICAgLy8gd29ya2Fyb3VuZCBmb3IgbGVnYWN5IGlPUyBTYWZhcmkKICAgICAgICAgICAgaWYgKHNlbGZCbG9iID09IG51bGwgfHwgIShzZWxmQmxvYiBpbnN0YW5jZW9mIEJsb2IpKQogICAgICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICAgICAgY29uc3Qgb2JqVXJsID0gVVJMLmNyZWF0ZU9iamVjdFVSTChzZWxmQmxvYik7CiAgICAgICAgICAgIHRoaXMuaGNhV29ya2VyID0gbmV3IFdvcmtlcihvYmpVcmwsIHsgdHlwZTogIm1vZHVsZSIgfSk7CiAgICAgICAgICAgIFVSTC5yZXZva2VPYmplY3RVUkwob2JqVXJsKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5zZWxmVXJsID0gc2VsZlVybDsKICAgICAgICB0aGlzLnRhc2tRdWV1ZSA9IG5ldyBIQ0FUYXNrUXVldWUoIk1haW4tSENBV29ya2VyIiwgKG1zZywgdHJhbnMpID0+IHRoaXMuaGNhV29ya2VyLnBvc3RNZXNzYWdlKG1zZywgdHJhbnMpLCAodGFzaykgPT4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgICBzd2l0Y2ggKHRhc2suY21kKSB7CiAgICAgICAgICAgICAgICBjYXNlICJzZWxmLWRlc3RydWN0IjogLy8gZG9lc24ndCBzZWVtIHRvIGhhdmUgYSBjaGFuY2UgdG8gYmUgY2FsbGVkCiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgaGNhV29ya2VyIHJlcXVlc3RlZCB0byBzZWxmLWRlc3RydWN0YCk7CiAgICAgICAgICAgICAgICAgICAgeWllbGQgdGhpcy50YXNrUXVldWUuc2h1dGRvd24odHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9KSwgKCkgPT4gdGhpcy5oY2FXb3JrZXIudGVybWluYXRlKCkpOwogICAgICAgIHRoaXMuaGNhV29ya2VyLm9ubWVzc2FnZSA9IChtc2cpID0+IHRoaXMudGFza1F1ZXVlLm1zZ0hhbmRsZXIobXNnKTsKICAgICAgICB0aGlzLmhjYVdvcmtlci5vbmVycm9yID0gKG1zZykgPT4gdGhpcy50YXNrUXVldWUuZXJySGFuZGxlcihtc2cpOwogICAgICAgIHRoaXMuaGNhV29ya2VyLm9ubWVzc2FnZWVycm9yID0gKG1zZykgPT4gdGhpcy50YXNrUXVldWUuZXJySGFuZGxlcihtc2cpOwogICAgfQogICAgLy8gY29tbWFuZHMKICAgIGdldFRyYW5zZmVyQ29uZmlnKCkgewogICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAgIHJldHVybiB5aWVsZCB0aGlzLnRhc2tRdWV1ZS5nZXRUcmFuc2ZlckNvbmZpZygpOwogICAgICAgIH0pOwogICAgfQogICAgY29uZmlnVHJhbnNmZXIodHJhbnNmZXJBcmdzLCByZXBseUFyZ3MpIHsKICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgICByZXR1cm4geWllbGQgdGhpcy50YXNrUXVldWUuY29uZmlnVHJhbnNmZXIodHJhbnNmZXJBcmdzLCByZXBseUFyZ3MpOwogICAgICAgIH0pOwogICAgfQogICAgZml4SGVhZGVyQ2hlY2tzdW0oaGNhKSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgcmV0dXJuIHlpZWxkIHRoaXMudGFza1F1ZXVlLmV4ZWNDbWQoImZpeEhlYWRlckNoZWNrc3VtIiwgW2hjYV0pOwogICAgICAgIH0pOwogICAgfQogICAgZml4Q2hlY2tzdW0oaGNhKSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgcmV0dXJuIHlpZWxkIHRoaXMudGFza1F1ZXVlLmV4ZWNDbWQoImZpeENoZWNrc3VtIiwgW2hjYV0pOwogICAgICAgIH0pOwogICAgfQogICAgZmluZEtleShoY2EsIGdpdmVuS2V5TGlzdCwgc3Via2V5LCB0aHJlc2hvbGQgPSAwLjUsIGRlcHRoID0gMTAyNCkgewogICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAgIHJldHVybiB5aWVsZCB0aGlzLnRhc2tRdWV1ZS5leGVjQ21kKCJmaW5kS2V5IiwgW2hjYSwgZ2l2ZW5LZXlMaXN0LCBzdWJrZXksIHRocmVzaG9sZCwgZGVwdGhdKTsKICAgICAgICB9KTsKICAgIH0KICAgIGRlY3J5cHQoaGNhLCBrZXkxLCBrZXkyLCBzdWJrZXkpIHsKICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgICByZXR1cm4geWllbGQgdGhpcy50YXNrUXVldWUuZXhlY0NtZCgiZGVjcnlwdCIsIFtoY2EsIGtleTEsIGtleTIsIHN1YmtleV0pOwogICAgICAgIH0pOwogICAgfQogICAgZW5jcnlwdChoY2EsIGtleTEsIGtleTIsIHN1YmtleSkgewogICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAgIHJldHVybiB5aWVsZCB0aGlzLnRhc2tRdWV1ZS5leGVjQ21kKCJlbmNyeXB0IiwgW2hjYSwga2V5MSwga2V5Miwgc3Via2V5XSk7CiAgICAgICAgfSk7CiAgICB9CiAgICBhZGRIZWFkZXIoaGNhLCBzaWcsIG5ld0RhdGEpIHsKICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgICByZXR1cm4geWllbGQgdGhpcy50YXNrUXVldWUuZXhlY0NtZCgiYWRkSGVhZGVyIiwgW2hjYSwgc2lnLCBuZXdEYXRhXSk7CiAgICAgICAgfSk7CiAgICB9CiAgICBhZGRDaXBoZXJIZWFkZXIoaGNhLCBjaXBoZXJUeXBlKSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgcmV0dXJuIHlpZWxkIHRoaXMudGFza1F1ZXVlLmV4ZWNDbWQoImFkZENpcGhlckhlYWRlciIsIFtoY2EsIGNpcGhlclR5cGVdKTsKICAgICAgICB9KTsKICAgIH0KICAgIGRlY29kZShoY2EsIG1vZGUgPSAzMiwgbG9vcCA9IDAsIHZvbHVtZSA9IDEuMCkgewogICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAgIHJldHVybiB5aWVsZCB0aGlzLnRhc2tRdWV1ZS5leGVjQ21kKCJkZWNvZGUiLCBbaGNhLCBtb2RlLCBsb29wLCB2b2x1bWVdKTsKICAgICAgICB9KTsKICAgIH0KICAgIGxvYWRIQ0FGb3JQbGF5aW5nKGhjYSwga2V5MSwga2V5Miwgc3Via2V5KSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBoY2EgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICBpZiAoaGNhID09PSAiIikKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoImVtcHR5IFVSTCIpOwogICAgICAgICAgICAgICAgaGNhID0gbmV3IFVSTChoY2EsIGRvY3VtZW50LmJhc2VVUkkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKCEoaGNhIGluc3RhbmNlb2YgVVJMKSAmJiAhKGhjYSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkpKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJoY2EgbXVzdCBiZSBlaXRoZXIgVVJMIG9yIFVpbnQ4QXJyYXkiKTsKICAgICAgICAgICAgaWYgKHRoaXMuYXdIY2FQbGF5ZXIgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhpcy5hd0hjYVBsYXllciA9IHlpZWxkIEhDQUF1ZGlvV29ya2xldEhDQVBsYXllci5jcmVhdGUodGhpcy5zZWxmVXJsLCBoY2EsIGtleTEsIGtleTIsIHN1YmtleSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLmF3SGNhUGxheWVyLnNldFNvdXJjZShoY2EsIGtleTEsIGtleTIsIHN1YmtleSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KICAgIHBhdXNlUGxheWluZygpIHsKICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkgewogICAgICAgICAgICBpZiAodGhpcy5hd0hjYVBsYXllciA9PSBudWxsKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgICAgIHlpZWxkIHRoaXMuYXdIY2FQbGF5ZXIucGF1c2UoKTsKICAgICAgICB9KTsKICAgIH0KICAgIHJlc3VtZVBsYXlpbmcoKSB7CiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuYXdIY2FQbGF5ZXIgPT0gbnVsbCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgICAgICB5aWVsZCB0aGlzLmF3SGNhUGxheWVyLnBsYXkoKTsKICAgICAgICB9KTsKICAgIH0KICAgIHN0b3BQbGF5aW5nKCkgewogICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmF3SGNhUGxheWVyID09IG51bGwpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICAgICAgeWllbGQgdGhpcy5hd0hjYVBsYXllci5zdG9wKCk7CiAgICAgICAgfSk7CiAgICB9Cn0K", document.baseURI);
        var hcaJsModule, hcaJsObjUrl, AWBArchive, HCAInfo, HCAWorker, HCAWebAudioLoopPlayer;

        // mime types
        const defMimeType = "application/octet-stream";
        const mimeTypeMap = {
            wav: "audio/x-wav",
            hca: defMimeType,
        }

        // HCAWorker instance
        var worker = null;

        // HCAWebAudioLoopPlayer instance
        var webAudioLoopPlayer = null;

        // dragged file
        var draggedFile = null;

        // parsed AWB
        var parsedAWB = null;

        // local file picker
        const localfile = document.getElementById("localfile");
        const localfileform = document.getElementById("localfileform");
        // onchange does not work on iOS Safari
        localfile.addEventListener("change", function (ev) { buttons.loadfilebtn = this.files.length > 0; });
        // reset state on refresh
        // https://bugzilla.mozilla.org/show_bug.cgi?id=685657
        localfileform.reset();
        // workaround for iOS Safari file picker
        document.getElementById("hcaonly").addEventListener("change", function (ev) {
            localfile.accept = ev.target.checked ? ".hca,application/octet-stream" : "";
        });
        // AWB subsong switcher
        const awbsubsongswitcher = document.getElementById("awbsubsongswitcher");
        AWBSubsongSelect = function (selected) {
            let waveID = selected.id.replace(/^awb_subsong_id_/, "");
            fileName = `${AWBFileName}_0.hca`;
            hcaFileData.original.data = parsedAWB.hcaFiles[0].file;
        }
        function setAWBSubSongSwitcher(enable) {
            if (!enable) {
                awbsubsongswitcher.innerHTML = "";
                keys.subkey = "0x0";
                return;
            }

            const waveIDs = parsedAWB.hcaFiles.map((e) => e.waveID);
            const subkey = `0x${parsedAWB.subkey.toString(16)}`;

            console.log(`AWB archive version=[${parsedAWB.version}]`
                + `, subsong count=[${parsedAWB.hcaFiles.length}], subkey=[${subkey}]`);

            keys.subkey = subkey;
            awbsubsongswitcher.innerHTML = `<fieldset><legend>AWB archive subsongs</legend>\n`
                + `${waveIDs.map(
                    (id) =>
                        `<div><input type=\"radio\" name=\"awb_subsong_id\" id=\"awb_subsong_id_${id}\"`
                        + ` onclick=\"AWBSubsongSelect(this);\">`
                        + `<label for=\"awb_subsong_id_${id}\">${id}</label>`
                        + `</div>`
                ).join("\n")}\n`
                + `</fieldset>`;
        }

        // input HCA URL
        const urlinput = document.getElementById("urlinput");

        // file name
        var AWBFileName = null;
        var fileName = null;

        // HCA info table
        const hcaInfoTable = {
            el: document.getElementById("hcaInfoTable"),
            body: {
                el: document.getElementById("hcaInfoTable")
                    .getElementsByTagName('tbody')[0],
                defText: document.getElementById("hcaInfoTable")
                    .getElementsByTagName('tbody')[0]
                    .getElementsByTagName("td")[0]
                    .textContent,
                data: {},
            },
        }
        Object.defineProperty(hcaInfoTable.body, "data", {
            get: function () { return this.value },
            set: function (val) {
                // clear existing content
                for (let i = hcaInfoTable.body.el.getElementsByTagName("tr").length - 1; i >= 0; i--) {
                    hcaInfoTable.body.el.deleteRow(i);
                }
                function appendRow(cells, rowspan) {
                    let newRow = hcaInfoTable.body.el.insertRow(-1);
                    cells.forEach((val, idx) => {
                        let newCell = newRow.insertCell(idx);
                        if (rowspan != null && idx == 0)
                            newCell.setAttribute("rowspan", rowspan);
                        if (cells.length < 3 && idx == cells.length - 1)
                            newCell.setAttribute("colspan", cells.length - idx + 1);
                        let newText = val != null
                            ? document.createTextNode("" + val)
                            : (() => {
                                let italic = document.createElement("i");
                                italic.innerHTML = "(not defined)";
                                return italic;
                            })();
                        newCell.appendChild(newText);
                    });
                }
                function toHex(num) {
                    const padding = "0000";
                    let hex = padding + num.toString(padding.length * 4).toUpperCase();
                    return "0x" + hex.substring(hex.length - padding.length, hex.length)
                }
                if (val == null || !val instanceof HCAInfo) {
                    appendRow([hcaInfoTable.body.defText]);
                    return; // nothing to add
                }
                // add given content
                let info = val;
                const hcaInfoTextArray = [
                    ["Version", info.version],
                    ["Header size", info.dataOffset],
                    ["Format", !info.hasHeader["fmt"] ? null : [
                        ["Channels", info.format.channelCount],
                        ["Sampling Rate", info.format.samplingRate],
                        ["Blocks", info.format.blockCount],
                        ["Dropped smpl. (head)", info.format.droppedHeader],
                        ["Dropped smpl. (tail)", info.format.droppedFooter],
                        ["Duration (calc)", `${info.duration.toFixed(3)}s`],
                    ]],
                    ["Block size", !info.hasHeader["comp"] && !info.hasHeader["dec"] ? null : info.blockSize],
                    ["Bitrate (kbps)", !info.hasHeader["comp"] && !info.hasHeader["dec"] ? null : info.kbps],
                    ["VBR", info.hasHeader["vbr"] ? "yes" : "no"],
                    ["ATH", !info.hasHeader["ath"] ? null : toHex(info.ath)],
                    ["Loop", !info.hasHeader["loop"] ? null : [
                        ["Start", info.loop.start],
                        ["End", info.loop.end],
                        ["Dropped smpl. (head)", info.loop.droppedHeader],
                        ["Dropped smpl. (tail)", info.loop.droppedFooter],
                        ["StartTime (calc)", `${info.loopStartTime.toFixed(3)}s`],
                        ["EndTime (calc)", `${info.loopEndTime.toFixed(3)}s`],
                        ["Duration (calc)", `${info.loopDuration.toFixed(3)}s`],
                    ]],
                    ["Cipher", !info.hasHeader["ciph"] ? null : toHex(info.cipher)],
                    ["RVA (volume)", !info.hasHeader["rva"] ? null : info.rva],
                    ["Comment", !info.hasHeader["comm"] ? null : info.comment],
                ];
                for (let item of hcaInfoTextArray) {
                    let key = item[0];
                    let val = item[1];
                    if (Array.isArray(val)) {
                        let textList = val[0].slice(0);
                        textList.unshift(key);
                        appendRow(textList, val.length);
                        val.shift();
                        val.forEach((item) => appendRow(item))
                    } else {
                        appendRow([key, val]);
                    }
                }
                // update value
                this.value = val;
            },
        });

        // keys
        const keys = { key1: undefined, key2: undefined, subkey: undefined };
        for (let key in keys) {
            Object.defineProperty(keys, key, {
                get: function () { return document.getElementById(key + "input").value },
                set: function (val) { document.getElementById(key + "input").value = val },
            });
        }
        async function testAndFindValidKeyAsync() {
            worker.tick();
            let resultPromise = worker.findKey(hcaFileData.original.data, [[keys.key1, keys.key2]], keys.subkey);
            worker.tock(`findKey`);
            let result = await resultPromise;
            if (result != null) {
                result = result.map((k) => `0x${k.toString(16)}`);
                console.log(`found valid key`, result);
                keys.key1 = result[0];
                keys.key2 = result[1];
            } else {
                console.warn(`no valid key found!`);
            }
        }

        // mode/loop/volume
        const decodingParam = {
            mode: {
                el: document.getElementById("decodingmodeinput"),
                defVal: 16,
            },
            loop: {
                el: document.getElementById("loopcountinput"),
                defVal: 0,
            },
            volumePerCent: {
                el: document.getElementById("volumeinput"),
                defVal: 100,
            },
        }

        function setVolume(val) {
            val = Number(val) / 100;
            if (webAudioLoopPlayer != null) {
                webAudioLoopPlayer.volume = val;
            }
        }
        document.getElementById("volumeslider").addEventListener("input", (ev) => {
            const val = ev.target.value;
            document.getElementById("volumeinput").value = val;
            setVolume(val);
        });
        document.getElementById("volumeinput").addEventListener("input", (ev) => {
            const val = ev.target.value;
            const slider = document.getElementById("volumeslider");
            if (slider.value != val) {
                slider.value = val;
            }
            setVolume(val);
        });

        for (let paramName in decodingParam) {
            let el = decodingParam[paramName].el;
            let defVal = decodingParam[paramName].defVal;
            let attr = {};
            ["min", "max", "step"].forEach((attrName) => attr[attrName] = el.getAttribute(attrName));
            let clampVal = function (val) {
                if (val == null || val === "")
                    return defVal;
                val = parseInt(val);
                if (isNaN(val))
                    return defVal;
                if (val % attr.step != 0)
                    val = Math.floor(val / attr.step);
                else if (val < attr.min)
                    val = attr.min;
                else if (val > attr.max)
                    val = attr.max;
                return val;
            }
            Object.defineProperty(decodingParam, paramName, {
                get: function () {
                    let clamped = clampVal(el.value);
                    el.value = "" + clamped;
                    return clamped;
                },
                set: function (val) {
                    el.value = "" + clampVal(val);
                }
            });
        }

        // HCA file data
        const hcaFileData = {
            // original HCA file content
            original: {
                btnID: "downloadbtn",
                data: {},
            },
            // after fixing checksum
            fixed_checksum: {
                btnID: "fixcsumbtn",
                data: {},
            },
            // after decryption
            decrypted: {
                btnID: "decryptbtn",
                data: {},
            },
            // after encryption
            encrypted: {
                btnID: "encryptbtn",
                data: {},
            },
            // after decoding
            decoded: {
                btnID: "decodetoh5btn",
                data: {},
            },
        }
        for (let suffix in hcaFileData) {
            Object.defineProperty(hcaFileData[suffix], "data", {
                get: function () { return this.value },
                set: function (val) {
                    this.value = null; // clear existing data
                    const fileExtRegEx = /\.([^\.]+)$/;
                    let newFileName = fileName.replace(fileExtRegEx, "_" + suffix + ".$1");
                    if (suffix === "decoded")
                        newFileName = newFileName.replace(fileExtRegEx, ".wav");
                    let id = suffix + "-download-link";
                    let el = document.getElementById(id);
                    if (el != null) {
                        // remove existing download link
                        URL.revokeObjectURL(el.getAttribute("href"));
                        el.nextSibling.remove();
                        el.remove();
                    }
                    if (val == null) {
                        console.log(`hcaFileData ${suffix} cleared`);
                        return; // nothing to create
                    }
                    console.log(`hcaFileData ${suffix} byteLength=${val.byteLength}`);
                    // create new download link
                    el = document.createElement("a");
                    el.setAttribute("id", id);
                    el.setAttribute("download", newFileName);
                    let extName = newFileName.match(fileExtRegEx)[0];
                    let mimeType = mimeTypeMap[extName];
                    if (mimeType == null) mimeType = defMimeType;
                    el.setAttribute("href", URL.createObjectURL(new Blob([val], { type: mimeType })));
                    el.innerHTML = newFileName;
                    let refNode = document.getElementById(hcaFileData[suffix].btnID).nextSibling;
                    refNode.parentElement.insertBefore(document.createElement("br"), refNode);
                    refNode.parentElement.insertBefore(el, refNode);
                    // update value
                    this.value = val;
                },
            });
        }
        function clearAllData() {
            localfileform.reset();
            for (let suffix in hcaFileData) {
                hcaFileData[suffix].data = null;
            }
            setAWBSubSongSwitcher(null);
            hcaInfoTable.body.data = null;
            audioElement.src = null;
            console.log(`cleared all data`);
        }

        // Audio element
        const audioElement = {
            el: document.getElementById("audioElement"),
            src: ""
        };
        Object.defineProperty(audioElement, "src", {
            get: function () { return this.value },
            set: function (val) {
                if (this.value != null && this.value != "")
                    URL.revokeObjectURL(this.value);
                if (val == null || val === "") {
                    this.value = audioElement.el.src = "";
                    return;
                }
                let newUrl;
                if (val instanceof ArrayBuffer || val.buffer instanceof ArrayBuffer) {
                    newUrl = URL.createObjectURL(new Blob([val], { type: mimeTypeMap.wav }));
                } else {
                    newUrl = val;
                }
                this.value = audioElement.el.src = newUrl;
            }
        });

        // buttons
        const buttons = {
            startworkerbtn: async (self) => {
                if (worker == null) {
                    if (hcaJsObjUrl == null) {
                        const response = await fetch(hcaJsUrl.href);
                        const blob = new Blob([await response.arrayBuffer()], { type: "text/javascript" });
                        hcaJsObjUrl = URL.createObjectURL(blob);
                    }
                    if (hcaJsModule == null) {
                        hcaJsModule = await import(hcaJsObjUrl);
                    }
                    if (AWBArchive == null) AWBArchive = hcaJsModule.AWBArchive;
                    if (HCAInfo == null) HCAInfo = hcaJsModule.HCAInfo;
                    if (HCAWorker == null) HCAWorker = hcaJsModule.HCAWorker;
                    if (HCAWebAudioLoopPlayer == null) HCAWebAudioLoopPlayer = hcaJsModule.HCAWebAudioLoopPlayer;
                    worker = await HCAWorker.create(hcaJsObjUrl);
                    console.log("started background worker");
                }
                self.disabled = true; // added because button won't grey out if there's any await above
                buttons.shutdownbtn = true;
            },
            shutdownbtn: async (self) => {
                if (worker != null) {
                    await worker.shutdown();
                    worker = null;
                    console.log("background worker is now shut down");
                }
                self.disabled = true; // added together with above startworkerbtn
                buttons.startworkerbtn = true;
            },
            loadfilebtn: async (self) => {
                let file = null;
                if (draggedFile != null) {
                    self.textContent = "loading dragged file...";
                    file = draggedFile;
                    draggedFile = null;
                } else {
                    self.textContent = "loading picked file...";
                    file = localfile.files[0];
                }
                let newFileName = file.name;
                // update fileName
                fileName = newFileName;
                // clear all existing data
                clearAllData();
                resetButtonsExcept(self.id);
                // update data
                let ab;
                if (file.arrayBuffer == null) {
                    let objUrl = URL.createObjectURL(file);
                    let resp = await fetch(objUrl);
                    URL.revokeObjectURL(objUrl);
                    ab = await resp.arrayBuffer();
                } else {
                    ab = await file.arrayBuffer();
                }
                // parse AWB
                AWBFileName = null;
                parsedAWB = null;
                if (AWBArchive.isAWB(new Uint8Array(ab))) {
                    try {
                        parsedAWB = new AWBArchive(new Uint8Array(ab));
                    } catch (e) {
                        console.error(`error parsing AWB archive`, e);
                    }
                }
                if (parsedAWB != null && parsedAWB.hcaFiles.length > 0) {
                    AWBFileName = fileName;
                    setAWBSubSongSwitcher(true);
                    AWBSubsongSelect({ id: "awb_subsong_id_0" });
                } else {
                    setAWBSubSongSwitcher(null);
                    hcaFileData.original.data = new Uint8Array(ab);
                }
                // find valid key
                await testAndFindValidKeyAsync();
                self.textContent = "load picked file (successful)";
                // no need to let the button bounce
                // next step
                buttons.awloadwholehcabtn = true;
                buttons.infobtn = true;
                buttons.fixcsumbtn = true;
            },
            downloadbtn: async (self) => {
                self.textContent = "downloading...";
                let requestUrl = urlinput.value;
                if (requestUrl === "") {
                    self.textContent = "download (empty URL)";
                    self.disabled = false;
                    return;
                }
                let response = null;
                try {
                    response = await fetch(requestUrl);
                } catch (e) {
                    console.error(e);
                    self.textContent = "download (network error)";
                    self.disabled = false;
                    return;
                }
                if (response.status != 200) {
                    console.error("download failed,", response);
                    self.textContent = `download (failed, ${response.status} ${response.statusText})`;
                    self.disabled = false;
                    return;
                }
                // get filename from Content-Disposition
                let cd = response.headers.get("Content-Disposition");
                let newFileName = null;
                if (cd != null) {
                    let splitted = cd.split(";");
                    let cdFileName = splitted.find((substr) => substr.startsWith("filename="));
                    if (cdFileName != null) {
                        newFileName = cdFileName.substring("filename=".length)
                            .replaceAll(" ", "")
                            .replaceAll("\"", "");
                    }
                }
                // failed to get filename from Content-Disposition, try URL
                const fileNameRegEx = /[^\/^\\]+$/;
                if (newFileName == null || newFileName === "") {
                    let urlFilename = [response.url, requestUrl].find((url) => url != null && url.match(fileNameRegEx));
                    if (urlFilename != null)
                        newFileName = urlFilename.match(fileNameRegEx)[0];
                }
                // failed to get filename, use default filename
                if (newFileName == null || newFileName === "") {
                    newFileName = "downloaded.hca";
                }
                // strip query string
                let stripped = newFileName.match(/^[^\?]+/);
                if (stripped != null)
                    newFileName = stripped[0];
                // update fileName
                fileName = newFileName;
                // clear all existing data
                clearAllData();
                resetButtonsExcept(self.id);
                // update data
                let ab = await response.arrayBuffer();
                hcaFileData.original.data = new Uint8Array(ab);
                self.textContent = "download (successful)";
                // find valid key
                await testAndFindValidKeyAsync();
                // let the button bounce
                self.disabled = false;
                // next step
                buttons.awloadwholehcabtn = true;
                buttons.infobtn = true;
                buttons.fixcsumbtn = true;
            },
            awloadwholehcabtn: async (self) => {
                try {
                    await worker.loadHCAForPlaying(hcaFileData.original.data, keys.key1, keys.key2, keys.subkey);
                    self.textContent = "Load (successful)";
                } catch (e) {
                    self.textContent = "Load (failed)";
                    console.error(e);
                }
                // let the button bounce
                self.disabled = false;
                // next step
                buttons.awpausebtn = false;
                buttons.awresumebtn = true;
                buttons.awstopbtn = true;
                // TODO pause/rewind/fast-forward etc
            },
            awloadfromurlbtn: async (self) => {
                try {
                    await worker.loadHCAForPlaying(urlinput.value, keys.key1, keys.key2, keys.subkey);
                    self.textContent = "Load (successful)";
                } catch (e) {
                    self.textContent = "Load (failed)";
                    console.error(e);
                }
                // let the button bounce
                self.disabled = false;
                // next step
                buttons.awpausebtn = false;
                buttons.awresumebtn = true;
                buttons.awstopbtn = true;
                // TODO rewind/fast-forward etc
            },
            awpausebtn: async (self) => {
                try {
                    await worker.pausePlaying();
                    self.textContent = "Paused";
                } catch (e) {
                    self.textContent = "Pause (Error)";
                    console.log(e);
                    // let the button bounce
                    self.disabled = false;
                }
                // next step
                buttons.awresumebtn = true;
            },
            awresumebtn: async (self) => {
                try {
                    await worker.resumePlaying();
                    self.textContent = "Playing/Resumed";
                } catch (e) {
                    self.textContent = "Play/Resume (Error)";
                    console.log(e);
                    // let the button bounce
                    self.disabled = false;
                }
                // next step
                buttons.awpausebtn = true;
            },
            awstopbtn: async (self) => {
                try {
                    await worker.stopPlaying();
                    self.textContent = "Stopped";
                } catch (e) {
                    self.textContent = "Stop (Error)";
                    console.log(e);
                    // let the button bounce
                    self.disabled = false;
                }
                // next step
                buttons.awpausebtn = false;
                buttons.awresumebtn = false;
            },
            infobtn: async (self) => {
                let hca = hcaFileData[
                    ["fixed_checksum", "original"].find((suffix) => {
                        if (hcaFileData[suffix].data != null) {
                            console.log(`get HCA info from ${suffix} file data`);
                            return true;
                        }
                    })
                ].data;
                try {
                    let info = new HCAInfo(hca);
                    self.textContent = "get HCA info (successful)";
                    // update table content
                    hcaInfoTable.body.data = info;
                    // next step
                    let isEncrypted = info.hasHeader["ciph"] && info.cipher != 0;
                    buttons.encryptbtn = !isEncrypted;
                    buttons.decryptbtn = isEncrypted;
                    buttons.decodetoh5btn = !isEncrypted;
                    buttons.decodetowabtn = !isEncrypted;
                } catch (e) {
                    console.error(e);
                    self.textContent = "get HCA info (failed)";
                }
                // let the button bounce
                self.disabled = false;
            },
            fixcsumbtn: async (self) => {
                try {
                    worker.tick();
                    let newHcaPromise = worker.fixChecksum(hcaFileData.original.data);
                    worker.tock("fix checksum");
                    let newHca = await newHcaPromise;
                    // update data
                    hcaFileData.fixed_checksum.data = newHca;
                    self.textContent = "fix checksum (successful)";
                } catch (e) {
                    console.error(e);
                    self.textContent = "fix checksum (failed)";
                }
                // let the button bounce
                self.disabled = false;
            },
            encryptbtn: async (self) => {
                await encryptOrDecrypt(self, true);
                // let the button bounce
                self.disabled = false;
            },
            decryptbtn: async (self) => {
                await encryptOrDecrypt(self, false);
                // let the button bounce
                self.disabled = false;
            },
            decodetoh5btn: async (self) => {
                // prepare data
                let hca = hcaFileData[
                    ["decrypted", "fixed_checksum", "original"].find((suffix) => {
                        if (hcaFileData[suffix].data != null) {
                            console.log(`decoding ${suffix} data...`);
                            return true;
                        }
                    })
                ].data;
                // start decoding
                try {
                    worker.tick();
                    let decodedPromise = worker.decode(hca,
                        decodingParam.mode, decodingParam.loop, decodingParam.volumePerCent / 100);
                    worker.tock("decoding");
                    let decoded = await decodedPromise;
                    // update data
                    hcaFileData.decoded.data = decoded;
                    self.textContent = "decode (done)";
                    // next step (play)
                    audioElement.src = decoded;
                } catch (e) {
                    console.error(e);
                    self.textContent = "decode (failed)";
                }
                // let the button bounce
                self.disabled = false;
            },
            decodetowabtn: async (self) => {
                // prepare data
                let hca = hcaFileData[
                    ["decrypted", "fixed_checksum", "original"].find((suffix) => {
                        if (hcaFileData[suffix].data != null) {
                            console.log(`decoding ${suffix} data...`);
                            return true;
                        }
                    })
                ].data;
                // start decoding
                try {
                    worker.tick();
                    let decodedPromise = HCAWebAudioLoopPlayer.create(hca, worker, decodingParam.volumePerCent / 100);
                    worker.tock("decoding");
                    let newPlayer = await decodedPromise;
                    // update player instance
                    if (webAudioLoopPlayer != null) await webAudioLoopPlayer.stop();
                    webAudioLoopPlayer = newPlayer;
                    self.textContent = "decode (done)";
                    // next step (play)
                    buttons.webaudioplaybtn = true;
                } catch (e) {
                    console.error(e);
                    self.textContent = "decode (failed)";
                }
                // let the button bounce
                self.disabled = false;
            },
            webaudioplaybtn: async (self) => {
                try {
                    webAudioLoopPlayer.play();
                    self.textContent = "Playing/Resumed";
                } catch (e) {
                    self.textContent = "Play/Resume (Error)";
                    console.log(e);
                    // let the button bounce
                    self.disabled = false;
                }
                // next step
                buttons.webaudiopausebtn = true;
                buttons.webaudiostopbtn = true;
            },
            webaudiopausebtn: async (self) => {
                try {
                    webAudioLoopPlayer.pause();
                    self.textContent = "Paused";
                } catch (e) {
                    self.textContent = "Pause (Error)";
                    console.log(e);
                    // let the button bounce
                    self.disabled = false;
                }
                // next step
                buttons.webaudioplaybtn = true;
            },
            webaudiostopbtn: async (self) => {
                try {
                    await webAudioLoopPlayer.stop();
                    self.textContent = "Stopped";
                } catch (e) {
                    self.textContent = "Stop (Error)";
                    console.log(e);
                    // let the button bounce
                    self.disabled = false;
                }
                // next step
                buttons.webaudiopausebtn = false;
                buttons.webaudioplaybtn = false;
            },
        };
        const _buttons = {};
        for (let id in buttons) {
            let el = document.getElementById(id);
            let onclick = buttons[id];
            el.onclick = (ev) => {
                let self = ev.srcElement;
                self.disabled = true;
                onclick(self);
            }
            const initialText = el.textContent;
            Object.defineProperty(buttons, id, {
                get: function () { return !el.disabled },
                set: function (val) {
                    if (val === "click") {
                        el.disabled = true;
                        onclick(el);
                        return;
                    }
                    el.textContent = initialText;
                    el.disabled = !val;
                },
            });
            Object.defineProperty(_buttons, id, {
                get: function () { return onclick; },
            });
        }
        buttons.startworkerbtn = "click"; // start background worker
        function resetButtonsExcept(exceptBtnID) {
            for (let btnID in buttons) {
                if (btnID !== exceptBtnID) switch (btnID) {
                    case "startworkerbtn":
                        buttons[btnID] = worker == null || !worker.isAlive;
                        break;
                    case "shutdownbtn":
                        buttons[btnID] = worker != null && worker.isAlive;
                        break;
                    case "loadfilebtn":
                        buttons[btnID] = false;
                        break;
                    case "downloadbtn":
                        buttons[btnID] = true;
                        break;
                    case "awloadwholehcabtn":
                        buttons[btnID] = false;
                        break;
                    case "awloadfromurlbtn":
                        buttons[btnID] = true;
                        break;
                    case "awresumebtn":
                    case "awpausebtn":
                    case "awstopbtn":
                        // do not reset except on refresh
                        if (exceptBtnID == null) buttons[btnID] = false;
                        break;
                    default:
                        buttons[btnID] = false;
                }
            }
        }
        resetButtonsExcept(); // same to above, reset state on refresh
        async function encryptOrDecrypt(self, isEncrypting) {
            const action = isEncrypting ? "encrypt" : "decrypt";
            const opposite = isEncrypting ? "decrypt" : "encrypt";
            // disable both buttons
            self.disabled = true;
            buttons[opposite + "btn"] = false;
            self.textContent = action + "ing...";
            // disable decodetoh5btn and decodetowabtn if necessary
            if (!isEncrypting) {
                buttons.decodetoh5btn = false;
                buttons.decodetowabtn = false;
            }
            // prepare data
            let hca = hcaFileData[
                [opposite + "ed", "fixed_checksum", "original"].find((suffix) => {
                    if (hcaFileData[suffix].data != null) {
                        console.log(`${action}ing ${suffix} data...`);
                        return true;
                    }
                })
            ].data;
            if (isEncrypting && !hcaInfoTable.body.data.hasHeader["ciph"]) {
                // check for ciph header section
                console.log("input HCA lacks ciph header section, adding it");
                hca = await worker.addCipherHeader(hca);
            } else {
                hca = hca.slice(0); // just copy to new buffer
            }
            // start to encrypt/decrypt
            try {
                worker.tick();
                // although decryption/encryption is done in-place,
                // however since we are not using SharedArrayBuffer,
                // the background worker is still actually overwritting a newly allocated buffer
                let resultPromise = worker[action](hca, keys.key1, keys.key2, keys.subkey);
                worker.tock(isEncrypting ? "encryption" : "decryption");
                let result = await resultPromise;
                self.textContent = action + " (done)";
                // update data
                hcaFileData[action + "ed"].data = result;
                // next steps
                buttons[opposite + "btn"] = true;
                if (!isEncrypting) {
                    buttons.decodetoh5btn = true;
                    buttons.decodetowabtn = true;
                }
            } catch (e) {
                console.error(e);
                self.textContent = "Error during " + (isEncrypting ? "encryption" : "decryption");
            }
        }
        window.addEventListener("dragover", function (ev) {
            // https://stackoverflow.com/questions/46668079/addeventlistener-drop-not-firing
            ev.preventDefault();
        });
        var tryingUnlock = false;
        function tryUnlock() {
            if (worker.awHcaPlayer && !worker.awHcaPlayer.unlocked) {
                // FIXME temporary workaround
                if (!tryingUnlock) {
                    tryingUnlock = true;
                    const id = "awresumebtn";
                    const el = document.getElementById(id);
                    el.disabled = true;
                    _buttons[id](el).then(() => { tryingUnlock = false; });
                }
            }
        }
        window.addEventListener("click", function (ev) {
            tryUnlock();
        });
        window.addEventListener("drop", function (ev) {
            ev.preventDefault();
            let file = null;
            const dtItems = ev.dataTransfer.items;
            const dtFiles = ev.dataTransfer.files;
            if (dtItems != null && dtItems.length == 1) {
                // Use DataTransferItemList interface to access the file(s)
                const item = dtItems[0];
                if (item.kind === "file") {
                    file = item.getAsFile();
                }
            } else if (dtFiles != null && dtFiles.length == 1) {
                // Use DataTransfer interface to access the file(s)
                file = dtFiles[0];
            }
            if (file != null) {
                draggedFile = file;
                let btnToClick = ["loadfilebtn", "infobtn"];
                const autoPlay = document.getElementById("awautoplayondrop").checked;
                if (autoPlay) {
                    btnToClick.push("awloadwholehcabtn", "awresumebtn");
                    //tryUnlock(); // did not seem to work
                }
                const iter = btnToClick.values();
                const clickNextBtn = function () {
                    let id = iter.next();
                    if (id.done) return;
                    id = id.value;
                    if (typeof id !== "string") throw new Error();
                    if (id === "awloadwholehcabtn" || id === "awresumebtn") {
                        if (worker.awHcaPlayer && !worker.awHcaPlayer.unlocked) {
                            // FIXME temporary workaround
                            console.warn("awHcaPlayer is still locked, give up before clicking " + id);
                            return;
                        }
                    }
                    const el = document.getElementById(id);
                    el.disabled = true;
                    _buttons[id](el).then(() => { clickNextBtn(); });
                }
                clickNextBtn();
            }
        });
    </script>
</body>

</html>