<!DOCTYPE html>
<html>
<head></head>
<body>
    <h1>HCA decoder demo</h1>
    <a href="./">Full version</a>
    <hr>
    <input type="text" spellcheck="false" id="urlinput" value="bgm03_story02_hca.hca"><br>
    <button id="downloadbtn">Download</button><br>
    Loop count: <input type="number" step="1" min="0" max="99" placeholder="0-99" id="loopcountinput" value="0"><br>
    <script type="module">
        const hcaJsUrl = new URL("hca.js", document.baseURI);
        var hcaJsModule, hcaJsObjUrl, HCAInfo, HCAWorker;

        // HCAWorker instance
        var worker = null;

        if (worker == null) {
            if (hcaJsObjUrl == null) {
                const response = await fetch(hcaJsUrl.href);
                const blob = new Blob([await response.arrayBuffer()], {type: "text/javascript"});
                hcaJsObjUrl = URL.createObjectURL(blob);
            }
            if (hcaJsModule == null) {
                hcaJsModule = await import(hcaJsObjUrl);
            }
            if (HCAInfo == null) HCAInfo = hcaJsModule.HCAInfo;
            if (HCAWorker == null) HCAWorker = hcaJsModule.HCAWorker;
            worker = await HCAWorker.create(hcaJsObjUrl);
            console.log("started background worker");
        }

        const convert = async (file) => {
            try {
                let hca;
                let filename;
                if (file != null) {
                    filename = file.name;
                    let ab;
                    if (file.arrayBuffer == null) {
                        let objUrl = URL.createObjectURL(file);
                        let resp = await fetch(objUrl);
                        URL.revokeObjectURL(objUrl);
                        ab = await resp.arrayBuffer();
                    } else {
                        ab = await file.arrayBuffer();
                    }
                    hca = new Uint8Array(ab);
                } else {
                    let urlinput = document.getElementById("urlinput");
                    let url = new URL(urlinput.value, document.baseURI);
                    let matched = url.pathname.match(/[^\/]+$/);
                    filename = matched ? matched[0] : "default_filename";
                    let response = await fetch(url);
                    hca = new Uint8Array(await response.arrayBuffer());
                }

                let decrypted = await worker.decrypt(hca, 0x01395C51, 0x00000000);
    
                let loopcountinput = document.getElementById("loopcountinput");
                let loopcount = Number(loopcountinput.value);
                if (isNaN(loopcount) || loopcount < 0) loopcount = 0;
                let decoded = await worker.decode(decrypted, 16, loopcount, 1);
    
                let id = "download-link";
                let newFileName = filename.replace(/\.hca$/i, ".wav");
                let el = document.getElementById(id);
                if (el != null) {
                    // remove existing download link
                    URL.revokeObjectURL(el.getAttribute("href"));
                    el.nextSibling.remove();
                    el.remove();
                }
                // create new download link
                el = document.createElement("a");
                el.setAttribute("id", id);
                el.setAttribute("download", newFileName);
                el.setAttribute("href", URL.createObjectURL(new Blob([decoded], { type: "audio/x-wav" })));
                el.innerHTML = newFileName;
                let refNode = document.getElementById("downloadbtn").nextSibling;
                refNode.parentElement.insertBefore(document.createElement("br"), refNode);
                refNode.parentElement.insertBefore(el, refNode);
    
                downloadbtn.disabled = false;
            } catch (e) {
                console.error(e);
                alert(e, e.stack);
            }
        }

        window.addEventListener("dragover", function (ev) {
            // https://stackoverflow.com/questions/46668079/addeventlistener-drop-not-firing
            ev.preventDefault();
        });
        window.addEventListener("drop", function (ev) {
            ev.preventDefault();
            let file = null;
            const dtItems = ev.dataTransfer.items;
            const dtFiles = ev.dataTransfer.files;
            if (dtItems != null && dtItems.length == 1) {
                // Use DataTransferItemList interface to access the file(s)
                const item = dtItems[0];
                if (item.kind === "file") {
                    file = item.getAsFile();
                }
            } else if (dtFiles != null && dtFiles.length == 1) {
                // Use DataTransfer interface to access the file(s)
                file = dtFiles[0];
            }
            if (file != null) {
                if (!downloadbtn.disabled) {
                    downloadbtn.disabled = true;
                    convert(file);
                }
            }
        });

        downloadbtn.addEventListener("click", (ev) => {
            downloadbtn.disabled = true;
            convert();
        });
    </script>
</body>
</html>